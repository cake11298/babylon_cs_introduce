const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pbrMaterialLoadingAdapter-saCZzkCt.js","assets/babylon-DKNSOLis.js","assets/flowGraphGLTFDataProvider-BfFqG1mI.js"])))=>i.map(i=>d[i]);
import{S as Fs,A as ge,V as K,M as it,T as Ve,Q as at,B as Rn,R as zn,a as Un,O as wt,L as Me,D as Wn,b as Yo,c as Mr,E as Sr,d as Br,e as Tn,f as qe,g as wn,h as Xo,C as Xt,i as Qo,j as Bt,k as q,l as Rt,m as cn,H as Js,n as Ls,P as Zs,o as Ht,F as qs,p as Jo,q as ot,r as Qn,s as Ir,G as Jn,t as Pr,u as Be,_ as xn,v as Pn,w as Nr,x as Or,y as Rr,z as Zo,I as Fr,J as Fn,K as Lr,N as kr,U as Vr,W as Gr,X as Nt,Y as Dr,Z as $r,$ as Hr,a0 as zr,a1 as Ur,a2 as eo,a3 as So,a4 as Bo,a5 as Ne,a6 as Wr,a7 as qr,a8 as Kr,a9 as jr,aa as Yr,ab as Ds,ac as Xr,ad as Qr,ae as Jr,af as Ln,ag as qn,ah as Zr,ai as ei,aj as Sn,ak as ti,al as Bn,am as xe,an as Io,ao as Po,ap as ni,aq as er,ar as si,as as oi,at as ri}from"./babylon-DKNSOLis.js";function ii(a,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const r in n)if(r!=="default"&&!(r in a)){const o=Object.getOwnPropertyDescriptor(n,r);o&&Object.defineProperty(a,r,o.get?o:{enumerable:!0,get:()=>n[r]})}}}return Object.freeze(Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const tr="Xposition",nr="Yposition",sr="Zposition",or="Xrotation",rr="Yrotation",ir="Zrotation",ai="HIERARCHY",li="MOTION";class ci{constructor(e){this.loopMode=ge.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=ar(),this.numFrames=0,this.frameRate=0,this.skeleton=e}}function ar(){return{name:"",type:"",offset:new K,channels:[],children:[],frames:[],parent:null}}function ui(){return{frame:0,position:new K,rotation:new at}}function hi(a){const e=a.offset.x,t=a.offset.y,n=a.offset.z;return it.Translation(e,t,n)}function di(a,e){if(a.frames.length===0)return[];const t=[],n=a.channels.some(h=>h===tr||h===nr||h===sr),r=a.channels.some(h=>h===or||h===rr||h===ir),o=new ge(`${a.name}_pos`,"position",e.frameRate,ge.ANIMATIONTYPE_VECTOR3,e.loopMode),s=new ge(`${a.name}_rot`,"rotationQuaternion",e.frameRate,ge.ANIMATIONTYPE_QUATERNION,e.loopMode),i=[],l=[];for(let h=0;h<a.frames.length;h++){const u=a.frames[h];n&&u.position&&i.push({frame:u.frame,value:u.position.clone()}),r&&l.push({frame:u.frame,value:u.rotation.clone()})}return i.length>0&&(o.setKeys(i),t.push(o)),l.length>0&&(s.setKeys(l),t.push(s)),t}function lr(a,e,t){const n=hi(a),r=new Rn(a.name,t.skeleton,e,n),o=di(a,t);for(const s of o)s.getKeys()&&s.getKeys().length>0&&r.animations.push(s);for(const s of a.children)lr(s,r,t)}function cr(a,e,t,n){if(t.type==="ENDSITE")return;const r=ui();r.frame=e,r.position=new K,r.rotation=new at,t.frames.push(r);let o=it.Identity();for(let s=0;s<t.channels.length;++s){const i=t.channels[s],l=a[n.i++];if(!l)continue;const h=parseFloat(l.trim());if(i.endsWith("position"))switch(i){case tr:r.position.x=h;break;case nr:r.position.y=h;break;case sr:r.position.z=h;break}else if(i.endsWith("rotation")){const u=Ve.ToRadians(h);let c;switch(i){case or:c=it.RotationX(u);break;case rr:c=it.RotationY(u);break;case ir:c=it.RotationZ(u);break}o=c.multiply(o)}}at.FromRotationMatrixToRef(o,r.rotation);for(const s of t.children)cr(a,e,s,n)}function ur(a,e,t,n){const r=ar();r.parent=t,n.list.push(r);let o=e.trim().split(/\s+/);if(o[0].toUpperCase()==="END"&&o[1].toUpperCase()==="SITE"?(r.type="ENDSITE",r.name="ENDSITE"):(r.name=o[1],r.type=o[0].toUpperCase()),a.shift()?.trim()!="{")throw new Error("Expected opening { after type & name");const s=a.shift()?.trim().split(/\s+/);if(!s)throw new Error("Unexpected end of file: missing OFFSET");if(o=s,o[0].toUpperCase()!="OFFSET")throw new Error("Expected OFFSET, but got: "+o[0]);if(o.length!=4)throw new Error("OFFSET: Invalid number of values");const i=new K(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]));if(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))throw new Error("OFFSET: Invalid values");if(r.offset=i,r.type!="ENDSITE"){if(o=a.shift()?.trim().split(/\s+/),!o)throw new Error("Unexpected end of file: missing CHANNELS");if(o[0].toUpperCase()!="CHANNELS")throw new Error("Expected CHANNELS definition");const l=parseInt(o[1]);r.channels=o.splice(2,l),r.children=[]}for(;a.length>0;){const l=a.shift()?.trim();if(l==="}")return r;l&&r.children.push(ur(a,l,r,n))}throw new Error("Unexpected end of file: missing closing brace")}function No(a,e,t,n){const r=a.split(`
`),{loopMode:o}=n;e._blockEntityCollection=!!t;const s=new Fs("","",e);s._parentContainer=t,e._blockEntityCollection=!1;const i=new ci(s);i.loopMode=o;const l=r.shift();if(!l||l.trim().toUpperCase()!==ai)throw new Error("HIERARCHY expected");const h=r.shift();if(!h)throw new Error("Unexpected end of file after HIERARCHY");const u=ur(r,h.trim(),null,i),c=r.shift();if(!c||c.trim().toUpperCase()!==li)throw new Error("MOTION expected");const d=r.shift();if(!d)throw new Error("Unexpected end of file before frame count");const p=d.trim().split(/[\s]+/);if(p.length<2)throw new Error("Invalid frame count line");const f=parseInt(p[1]);if(isNaN(f))throw new Error("Failed to read number of frames.");i.numFrames=f;const g=r.shift();if(!g)throw new Error("Unexpected end of file before frame time");const y=g.trim().split(/[\s]+/);if(y.length<3)throw new Error("Invalid frame time line");const m=parseFloat(y[2]);if(isNaN(m))throw new Error("Failed to read frame time.");if(m<=0)throw new Error("Failed to read frame time. Invalid value "+m);i.frameRate=1/m;for(let _=0;_<f;++_){const b=r.shift();if(!b)continue;const v=b.trim().split(/[\s]+/)||[];cr(v,_,u,{i:0})}return i.root=u,lr(i.root,null,i),i.skeleton.returnToRest(),i.skeleton}const $s={name:"bvh",extensions:{".bvh":{isBinary:!1}}};class Zn{constructor(e){this.name=$s.name,this.extensions=$s.extensions,this._loadingOptions={...Zn._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{loopMode:ge.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new Zn(e[$s.name])}canDirectLoad(e){return this.isBvhHeader(e)}isBvhHeader(e){return e.split(`
`)[0]=="HIERARCHY"}isNotBvhHeader(e){return!this.isBvhHeader(e)}importMeshAsync(e,t,n){if(typeof n!="string")return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(n))return Promise.reject("BVH loader expects HIERARCHY header.");try{const r=No(n,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[r],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(r){return Promise.reject(r)}}loadAsync(e,t){return typeof t!="string"?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then(()=>{})}loadAssetContainerAsync(e,t){if(typeof t!="string")return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");const n=new Un(e);try{const r=No(t,e,n,this._loadingOptions);return n.skeletons.push(r),Promise.resolve(n)}catch(r){return Promise.reject(r)}}}zn(new Zn);function Ks(a,e,t,n){const r={externalResourceFunction:n};return t&&(r.uri=e==="file:"?t:e+t),ArrayBuffer.isView(a)?GLTFValidator.validateBytes(a,r):GLTFValidator.validateString(a,r)}function pi(){const a=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{Ks(t.data,t.rootUrl,t.fileName,n=>new Promise((r,o)=>{const s=a.length;a.push({resolve:r,reject:o}),postMessage({id:"getExternalResource",index:s,uri:n})})).then(n=>{postMessage({id:"validate.resolve",value:n})},n=>{postMessage({id:"validate.reject",reason:n})});break}case"getExternalResource.resolve":{a[t.index].resolve(t.value);break}case"getExternalResource.reject":{a[t.index].reject(t.reason);break}}}}class hr{static ValidateAsync(e,t,n,r){return typeof Worker=="function"?new Promise((o,s)=>{const i=`${Ks}(${pi})()`,l=URL.createObjectURL(new Blob([i],{type:"application/javascript"})),h=new Worker(l),u=d=>{h.removeEventListener("error",u),h.removeEventListener("message",c),s(d)},c=d=>{const p=d.data;switch(p.id){case"getExternalResource":{r(p.uri).then(f=>{h.postMessage({id:"getExternalResource.resolve",index:p.index,value:f},[f.buffer])},f=>{h.postMessage({id:"getExternalResource.reject",index:p.index,reason:f})});break}case"validate.resolve":{h.removeEventListener("error",u),h.removeEventListener("message",c),o(p.value),h.terminate();break}case"validate.reject":h.removeEventListener("error",u),h.removeEventListener("message",c),s(p.reason),h.terminate()}};if(h.addEventListener("error",u),h.addEventListener("message",c),h.postMessage({id:"init",url:Ve.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const d=e.slice();h.postMessage({id:"validate",data:d,rootUrl:t,fileName:n},[d.buffer])}else h.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})}):(this._LoadScriptPromise||(this._LoadScriptPromise=Ve.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>Ks(e,t,n,r)))}}hr.Configuration={url:`${Ve._DefaultCdnUrl}/gltf_validator.js`};const dn="Z2xURg",Kn={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(a){return a.indexOf("asset")!==-1&&a.indexOf("version")!==-1||a.startsWith("data:base64,"+dn)||a.startsWith("data:;base64,"+dn)||a.startsWith("data:application/octet-stream;base64,"+dn)||a.startsWith("data:model/gltf-binary;base64,"+dn)}};function Oo(a,e,t){try{return Promise.resolve(new Uint8Array(a,e,t))}catch(n){return Promise.reject(n)}}function fi(a,e,t){try{if(e<0||e>=a.byteLength)throw new RangeError("Offset is out of range.");if(e+t>a.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(a.buffer,a.byteOffset+e,t))}catch(n){return Promise.reject(n)}}var Gn;(function(a){a[a.AUTO=0]="AUTO",a[a.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(Gn||(Gn={}));var In;(function(a){a[a.NONE=0]="NONE",a[a.FIRST=1]="FIRST",a[a.ALL=2]="ALL"})(In||(In={}));var St;(function(a){a[a.LOADING=0]="LOADING",a[a.READY=1]="READY",a[a.COMPLETE=2]="COMPLETE"})(St||(St={}));class dr{constructor(){this.alwaysComputeBoundingBox=!1,this.alwaysComputeSkeletonRootNode=!1,this.animationStartMode=In.FIRST,this.compileMaterials=!1,this.compileShadowGenerators=!1,this.coordinateSystemMode=Gn.AUTO,this.createInstances=!0,this.loadAllMaterials=!1,this.loadMorphTargets=!0,this.loadNodeAnimations=!0,this.loadOnlyMaterials=!1,this.loadSkins=!0,this.skipMaterials=!1,this.targetFps=60,this.transparencyAsCoverage=!1,this.useClipPlane=!1,this.useGltfTextureNames=!1,this.useRangeRequests=!1,this.useSRGBBuffers=!0,this.validate=!1,this.useOpenPBR=!1}}const mi=new dr;class yi extends dr{constructor(){super(...arguments),this.extensionOptions={},this.preprocessUrlAsync=e=>Promise.resolve(e)}copyFrom(e){e&&(this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.capturePerformanceCounters=e.capturePerformanceCounters??this.capturePerformanceCounters,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.createInstances=e.createInstances??this.createInstances,this.customRootNode=e.customRootNode,this.extensionOptions=e.extensionOptions??this.extensionOptions,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.loadSkins=e.loadSkins??this.loadSkins,this.loggingEnabled=e.loggingEnabled??this.loggingEnabled,this.onCameraLoaded=e.onCameraLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onMeshLoaded=e.onMeshLoaded,this.onParsed=e.onParsed,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onValidated=e.onValidated,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.targetFps=e.targetFps??this.targetFps,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.useOpenPBR=e.useOpenPBR??this.useOpenPBR,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.validate=e.validate??this.validate)}}class pt extends yi{constructor(e){super(),this.onParsedObservable=new wt,this.onMeshLoadedObservable=new wt,this.onSkinLoadedObservable=new wt,this.onTextureLoadedObservable=new wt,this.onMaterialLoadedObservable=new wt,this.onCameraLoadedObservable=new wt,this.onCompleteObservable=new wt,this.onErrorObservable=new wt,this.onDisposeObservable=new wt,this.onExtensionLoadedObservable=new wt,this.onValidatedObservable=new wt,this._loader=null,this._state=null,this._requests=new Array,this.name=Kn.name,this.extensions=Kn.extensions,this.onLoaderStateChangedObservable=new wt,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(Object.assign({...mi},e))}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,n,r,o,s,i,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,n,r,i,l),null;this._progressCallback=o;const h=t.name||Ve.GetFilename(t);if(s){if(this.useRangeRequests){this.validate&&Me.Warn("glTF validation is not supported when range requests are enabled");const u={abort:()=>{},onCompleteObservable:new wt},c={readAsync:(d,p)=>new Promise((f,g)=>{this._loadFile(e,t,y=>{f(new Uint8Array(y))},!0,y=>{g(y)},y=>{y.setRequestHeader("Range",`bytes=${d}-${d+p-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Wn(c)).then(d=>{u.onCompleteObservable.notifyObservers(u),r(d)},i?d=>i(void 0,d):void 0),u}return this._loadFile(e,t,u=>{this._validate(e,new Uint8Array(u,0,u.byteLength),n,h),this._unpackBinaryAsync(new Wn({readAsync:(c,d)=>Oo(u,c,d),byteLength:u.byteLength})).then(c=>{r(c)},i?c=>i(void 0,c):void 0)},!0,i)}else return this._loadFile(e,t,u=>{try{this._validate(e,u,n,h),r({json:this._parseJson(u)})}catch{i&&i()}},!1,i)}_loadBinary(e,t,n,r,o,s){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n,s),this._unpackBinaryAsync(new Wn({readAsync:(i,l)=>fi(t,i,l),byteLength:t.byteLength})).then(i=>{r(i)},o?i=>o(void 0,i):void 0)}importMeshAsync(e,t,n,r,o,s){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${s||""}`),this._loader=this._getLoader(n),this._loader.importMeshAsync(e,t,null,n,r,o,s)))}loadAsync(e,t,n,r,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,n,r,o)))}loadAssetContainerAsync(e,t,n,r,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t);const s=new Un(e),i=[];this.onMaterialLoadedObservable.add(c=>{i.push(c)});const l=[];this.onTextureLoadedObservable.add(c=>{l.push(c)});const h=[];this.onCameraLoadedObservable.add(c=>{h.push(c)});const u=[];return this.onMeshLoadedObservable.add(c=>{c.morphTargetManager&&u.push(c.morphTargetManager)}),this._loader.importMeshAsync(null,e,s,t,n,r,o).then(c=>(Array.prototype.push.apply(s.geometries,c.geometries),Array.prototype.push.apply(s.meshes,c.meshes),Array.prototype.push.apply(s.particleSystems,c.particleSystems),Array.prototype.push.apply(s.skeletons,c.skeletons),Array.prototype.push.apply(s.animationGroups,c.animationGroups),Array.prototype.push.apply(s.materials,i),Array.prototype.push.apply(s.textures,l),Array.prototype.push.apply(s.lights,c.lights),Array.prototype.push.apply(s.transformNodes,c.transformNodes),Array.prototype.push.apply(s.cameras,h),Array.prototype.push.apply(s.morphTargetManagers,u),s))})}canDirectLoad(e){return Kn.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+dn)||t.startsWith(";base64,"+dn)||t.startsWith("application/octet-stream;base64,"+dn)||t.startsWith("model/gltf-binary;base64,"+dn)){const n=Yo(t);return this._validate(e,new Uint8Array(n,0,n.byteLength)),this._unpackBinaryAsync(new Wn({readAsync:(r,o)=>Oo(n,r,o),byteLength:n.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new pt(e[Kn.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(n=>{t(n)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(St[this._state]))}_loadFile(e,t,n,r,o,s){const i=e._loadFile(t,n,l=>{this._onProgress(l,i)},!0,r,o,s);return i.onCompleteObservable.add(()=>{i._lengthComputable=!0,i._total=i._loaded}),this._requests.push(i),i}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let n=!0,r=0,o=0;for(const s of this._requests){if(s._lengthComputable===void 0||s._loaded===void 0||s._total===void 0)return;n=n&&s._lengthComputable,r+=s._loaded,o+=s._total}this._progressCallback({lengthComputable:n,loaded:r,total:n?o:0})}_validate(e,t,n="",r=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),hr.ValidateAsync(t,n,r,o=>this.preprocessUrlAsync(n+o).then(s=>e._loadFileAsync(s,void 0,!0,!0).then(i=>new Uint8Array(i,0,i.byteLength)))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),Ve.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const n=pt._parseVersion(t.version);if(!n)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const s=pt._parseVersion(t.minVersion);if(!s)throw new Error("Invalid minimum version: "+t.minVersion);if(pt._compareVersion(s,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const o={1:pt._CreateGLTF1Loader,2:pt._CreateGLTF2Loader}[n.major];if(!o)throw new Error("Unsupported version: "+t.version);return o(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},n=e.readUint32();if(n!==t.Magic)throw new Mr("Unexpected magic: "+n,Sr.GLTFLoaderUnexpectedMagicError);const r=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${r}`);const o=e.readUint32();!this.useRangeRequests&&o!==e.buffer.byteLength&&Me.Warn(`Length in header does not match actual data length: ${o} != ${e.buffer.byteLength}`);let s;switch(r){case 1:{s=this._unpackBinaryV1Async(e,o);break}case 2:{s=this._unpackBinaryV2Async(e,o);break}default:throw new Error("Unsupported version: "+r)}return this._endPerformanceCounter("Unpack Binary"),s})}_unpackBinaryV1Async(e,t){const n={JSON:0},r=e.readUint32(),o=e.readUint32();if(o!==n.JSON)throw new Error(`Unexpected content format: ${o}`);const s=t-e.byteOffset,i={json:this._parseJson(e.readString(r)),bin:null};if(s!==0){const l=e.byteOffset;i.bin={readAsync:(h,u)=>e.buffer.readAsync(l+h,u),byteLength:s}}return Promise.resolve(i)}_unpackBinaryV2Async(e,t){const n={JSON:1313821514,BIN:5130562},r=e.readUint32();if(e.readUint32()!==n.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+r===t?e.loadAsync(r).then(()=>({json:this._parseJson(e.readString(r)),bin:null})):e.loadAsync(r+8).then(()=>{const s={json:this._parseJson(e.readString(r)),bin:null},i=()=>{const l=e.readUint32();switch(e.readUint32()){case n.JSON:throw new Error("Unexpected JSON chunk");case n.BIN:{const u=e.byteOffset;s.bin={readAsync:(c,d)=>e.buffer.readAsync(u+c,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(i):Promise.resolve(s)};return i()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=pt._logSpaces.substring(0,this._logIndentLevel*2);Me.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){Ve.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){Ve.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}pt.IncrementalLoading=!0;pt.HomogeneousCoordinates=!1;pt._logSpaces="                                ";zn(new pt);var pn;(function(a){a[a.BYTE=5120]="BYTE",a[a.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",a[a.SHORT=5122]="SHORT",a[a.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",a[a.FLOAT=5126]="FLOAT"})(pn||(pn={}));var js;(function(a){a[a.FRAGMENT=35632]="FRAGMENT",a[a.VERTEX=35633]="VERTEX"})(js||(js={}));var At;(function(a){a[a.BYTE=5120]="BYTE",a[a.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",a[a.SHORT=5122]="SHORT",a[a.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",a[a.INT=5124]="INT",a[a.UNSIGNED_INT=5125]="UNSIGNED_INT",a[a.FLOAT=5126]="FLOAT",a[a.FLOAT_VEC2=35664]="FLOAT_VEC2",a[a.FLOAT_VEC3=35665]="FLOAT_VEC3",a[a.FLOAT_VEC4=35666]="FLOAT_VEC4",a[a.INT_VEC2=35667]="INT_VEC2",a[a.INT_VEC3=35668]="INT_VEC3",a[a.INT_VEC4=35669]="INT_VEC4",a[a.BOOL=35670]="BOOL",a[a.BOOL_VEC2=35671]="BOOL_VEC2",a[a.BOOL_VEC3=35672]="BOOL_VEC3",a[a.BOOL_VEC4=35673]="BOOL_VEC4",a[a.FLOAT_MAT2=35674]="FLOAT_MAT2",a[a.FLOAT_MAT3=35675]="FLOAT_MAT3",a[a.FLOAT_MAT4=35676]="FLOAT_MAT4",a[a.SAMPLER_2D=35678]="SAMPLER_2D"})(At||(At={}));var kn;(function(a){a[a.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",a[a.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",a[a.REPEAT=10497]="REPEAT"})(kn||(kn={}));var Wt;(function(a){a[a.NEAREST=9728]="NEAREST",a[a.LINEAR=9728]="LINEAR",a[a.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",a[a.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",a[a.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",a[a.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Wt||(Wt={}));var Ro;(function(a){a[a.ALPHA=6406]="ALPHA",a[a.RGB=6407]="RGB",a[a.RGBA=6408]="RGBA",a[a.LUMINANCE=6409]="LUMINANCE",a[a.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Ro||(Ro={}));var Ys;(function(a){a[a.FRONT=1028]="FRONT",a[a.BACK=1029]="BACK",a[a.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Ys||(Ys={}));var et;(function(a){a[a.ZERO=0]="ZERO",a[a.ONE=1]="ONE",a[a.SRC_COLOR=768]="SRC_COLOR",a[a.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",a[a.DST_COLOR=774]="DST_COLOR",a[a.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",a[a.SRC_ALPHA=770]="SRC_ALPHA",a[a.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",a[a.DST_ALPHA=772]="DST_ALPHA",a[a.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",a[a.CONSTANT_COLOR=32769]="CONSTANT_COLOR",a[a.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",a[a.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",a[a.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",a[a.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(et||(et={}));class ct{static SetMatrix(e,t,n,r,o){let s=null;if(n.semantic==="MODEL"?s=t.getWorldMatrix():n.semantic==="PROJECTION"?s=e.getProjectionMatrix():n.semantic==="VIEW"?s=e.getViewMatrix():n.semantic==="MODELVIEWINVERSETRANSPOSE"?s=it.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):n.semantic==="MODELVIEW"?s=t.getWorldMatrix().multiply(e.getViewMatrix()):n.semantic==="MODELVIEWPROJECTION"?s=t.getWorldMatrix().multiply(e.getTransformMatrix()):n.semantic==="MODELINVERSE"?s=t.getWorldMatrix().invert():n.semantic==="VIEWINVERSE"?s=e.getViewMatrix().invert():n.semantic==="PROJECTIONINVERSE"?s=e.getProjectionMatrix().invert():n.semantic==="MODELVIEWINVERSE"?s=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():n.semantic==="MODELVIEWPROJECTIONINVERSE"?s=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():n.semantic==="MODELINVERSETRANSPOSE"&&(s=it.Transpose(t.getWorldMatrix().invert())),s)switch(n.type){case At.FLOAT_MAT2:o.setMatrix2x2(r,it.GetAsMatrix2x2(s));break;case At.FLOAT_MAT3:o.setMatrix3x3(r,it.GetAsMatrix3x3(s));break;case At.FLOAT_MAT4:o.setMatrix(r,s);break}}static SetUniform(e,t,n,r){switch(r){case At.FLOAT:return e.setFloat(t,n),!0;case At.FLOAT_VEC2:return e.setVector2(t,Tn.FromArray(n)),!0;case At.FLOAT_VEC3:return e.setVector3(t,K.FromArray(n)),!0;case At.FLOAT_VEC4:return e.setVector4(t,Br.FromArray(n)),!0;default:return!1}}static GetWrapMode(e){switch(e){case kn.CLAMP_TO_EDGE:return qe.CLAMP_ADDRESSMODE;case kn.MIRRORED_REPEAT:return qe.MIRROR_ADDRESSMODE;case kn.REPEAT:return qe.WRAP_ADDRESSMODE;default:return qe.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case Wt.LINEAR:case Wt.LINEAR_MIPMAP_NEAREST:case Wt.LINEAR_MIPMAP_LINEAR:return qe.TRILINEAR_SAMPLINGMODE;case Wt.NEAREST:case Wt.NEAREST_MIPMAP_NEAREST:return qe.NEAREST_SAMPLINGMODE;default:return qe.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,n,r,o){n=t.byteOffset+n;const s=e.loadedBufferViews[t.buffer];if(n+r>s.byteLength)throw new Error("Buffer access is out of range");const i=s.buffer;switch(n+=s.byteOffset,o){case pn.BYTE:return new Int8Array(i,n,r);case pn.UNSIGNED_BYTE:return new Uint8Array(i,n,r);case pn.SHORT:return new Int16Array(i,n,r);case pn.UNSIGNED_SHORT:return new Uint16Array(i,n,r);default:return new Float32Array(i,n,r)}}static GetBufferFromAccessor(e,t){const n=e.bufferViews[t.bufferView],r=t.count*ct.GetByteStrideFromType(t);return ct.GetBufferFromBufferView(e,n,t.byteOffset,r,t.componentType)}static DecodeBufferToText(e){let t="";const n=e.byteLength;for(let r=0;r<n;++r)t+=String.fromCharCode(e[r]);return t}static GetDefaultMaterial(e){if(!ct._DefaultMaterial){wn.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),wn.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};ct._DefaultMaterial=new Xo("GLTFDefaultMaterial",e,t,n),ct._DefaultMaterial.setColor4("u_emission",new Xt(.5,.5,.5,1))}return ct._DefaultMaterial}}ct._DefaultMaterial=null;var fn;(function(a){a[a.IDENTIFIER=1]="IDENTIFIER",a[a.UNKNOWN=2]="UNKNOWN",a[a.END_OF_INPUT=3]="END_OF_INPUT"})(fn||(fn={}));class Fo{constructor(e){this._pos=0,this.currentToken=fn.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return fn.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=fn.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=fn.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const pr=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],fr=["world","view","projection","worldView","worldViewProjection","mBones"],gi=["translation","rotation","scale"],vi=["position","rotationQuaternion","scaling"],_i=(a,e)=>{for(const t in a){const n=a[t];e.buffers[t]=n,e.buffersCount++}},bi=(a,e)=>{for(const t in a){const n=a[t];e.shaders[t]=n,e.shaderscount++}},bt=(a,e,t)=>{for(const n in a){const r=a[n];t[e][n]=r}},wi=a=>{if(a)for(let e=0;e<a.length/2;e++)a[e*2+1]=1-a[e*2+1]},Lo=a=>{if(a.semantic==="NORMAL")return"normal";if(a.semantic==="POSITION")return"position";if(a.semantic==="JOINT")return"matricesIndices";if(a.semantic==="WEIGHT")return"matricesWeights";if(a.semantic==="COLOR")return"color";if(a.semantic&&a.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(a.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},xi=a=>{for(const e in a.animations){const t=a.animations[e];if(!t.channels||!t.samplers)continue;let n=null;for(let r=0;r<t.channels.length;r++){const o=t.channels[r],s=t.samplers[o.sampler];if(!s)continue;let i=null,l=null;t.parameters?(i=t.parameters[s.input],l=t.parameters[s.output]):(i=s.input,l=s.output);const h=ct.GetBufferFromAccessor(a,a.accessors[i]),u=ct.GetBufferFromAccessor(a,a.accessors[l]),c=o.target.id;let d=a.scene.getNodeById(c);if(d===null&&(d=a.scene.getNodeByName(c)),d===null){Ve.Warn("Creating animation named "+e+". But cannot find node named "+c+" to attach to");continue}const p=d instanceof Rn;let f=o.target.path;const g=gi.indexOf(f);g!==-1&&(f=vi[g]);let y=ge.ANIMATIONTYPE_MATRIX;p||(f==="rotationQuaternion"?(y=ge.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new at):y=ge.ANIMATIONTYPE_VECTOR3);let m=null;const _=[];let b=0,v=!1;p&&n&&n.getKeys().length===h.length&&(m=n,v=!0),v||(a.scene._blockEntityCollection=!!a.assetContainer,m=new ge(e,p?"_matrix":f,1,y,ge.ANIMATIONLOOPMODE_CYCLE),a.scene._blockEntityCollection=!1);for(let w=0;w<h.length;w++){let I=null;if(f==="rotationQuaternion"?(I=at.FromArray([u[b],u[b+1],u[b+2],u[b+3]]),b+=4):(I=K.FromArray([u[b],u[b+1],u[b+2]]),b+=3),p){const F=d;let M=K.Zero(),B=new at,C=K.Zero(),A=F.getBaseMatrix();v&&n&&(A=n.getKeys()[w].value),A.decompose(C,B,M),f==="position"?M=I:f==="rotationQuaternion"?B=I:C=I,I=it.Compose(C,B,M)}v?n&&(n.getKeys()[w].value=I):_.push({frame:h[w],value:I})}!v&&m&&(m.setKeys(_),d.animations.push(m)),n=m,a.scene.stopAnimation(d),a.scene.beginAnimation(d,0,h[h.length-1],!0,1)}}},to=a=>{let e=null;if(a.translation||a.rotation||a.scale){const t=K.FromArray(a.scale||[1,1,1]),n=at.FromArray(a.rotation||[0,0,0,1]),r=K.FromArray(a.translation||[0,0,0]);e=it.Compose(t,n,r)}else e=it.FromArray(a.matrix);return e},mr=(a,e,t,n)=>{for(let o=0;o<n.bones.length;o++)if(n.bones[o].name===t)return n.bones[o];const r=a.nodes;for(const o in r){const s=r[o];if(!s.jointName)continue;const i=s.children;for(let l=0;l<i.length;l++){const h=a.nodes[i[l]];if(h.jointName&&h.jointName===t){const u=to(s),c=new Rn(s.name||"",n,mr(a,e,s.jointName,n),u);return c.id=o,c}}}return null},Ai=(a,e)=>{for(let t=0;t<a.length;t++){const n=a[t];for(let r=0;r<n.node.children.length;r++)if(n.node.children[r]===e)return n.bone}return null},Hs=(a,e)=>{const t=a.nodes;let n=t[e];if(n)return{node:n,id:e};for(const r in t)if(n=t[r],n.jointName===e)return{node:n,id:r};return null},Ti=(a,e)=>{for(let t=0;t<a.jointNames.length;t++)if(a.jointNames[t]===e)return!0;return!1},Ci=(a,e,t,n)=>{for(const r in a.nodes){const o=a.nodes[r],s=r;if(!o.jointName||Ti(t,o.jointName))continue;const i=to(o),l=new Rn(o.name||"",e,null,i);l.id=s,n.push({bone:l,node:o,id:s})}for(let r=0;r<n.length;r++){const o=n[r],s=o.node.children;for(let i=0;i<s.length;i++){let l=null;for(let h=0;h<n.length;h++)if(n[h].id===s[i]){l=n[h];break}l&&(l.bone._parent=o.bone,o.bone.children.push(l.bone))}}},Ei=(a,e,t,n)=>{if(n||(n=new Fs(e.name||"","",a.scene)),!e.babylonSkeleton)return n;const r=[],o=[];Ci(a,n,e,r),n.bones=[];for(let i=0;i<e.jointNames.length;i++){const l=Hs(a,e.jointNames[i]);if(!l)continue;const h=l.node;if(!h){Ve.Warn("Joint named "+e.jointNames[i]+" does not exist");continue}const u=l.id,c=a.scene.getBoneById(u);if(c){n.bones.push(c);continue}let d=!1,p=null;for(let y=0;y<i;y++){const m=Hs(a,e.jointNames[y]);if(!m)continue;const _=m.node;if(!_){Ve.Warn("Joint named "+e.jointNames[y]+" does not exist when looking for parent");continue}const b=_.children;if(b){d=!1;for(let v=0;v<b.length;v++)if(b[v]===u){p=mr(a,e,e.jointNames[y],n),d=!0;break}if(d)break}}const f=to(h);!p&&r.length>0&&(p=Ai(r,u),p&&o.indexOf(p)===-1&&o.push(p));const g=new Rn(h.jointName||"",n,p,f);g.id=u}const s=n.bones;n.bones=[];for(let i=0;i<e.jointNames.length;i++){const l=Hs(a,e.jointNames[i]);if(l){for(let h=0;h<s.length;h++)if(s[h].id===l.id){n.bones.push(s[h]);break}}}n.prepare();for(let i=0;i<o.length;i++)n.bones.push(o[i]);return n},ko=(a,e,t,n,r)=>{if(r||(a.scene._blockEntityCollection=!!a.assetContainer,r=new ot(e.name||"",a.scene),r._parentContainer=a.assetContainer,a.scene._blockEntityCollection=!1,r.id=n),!e.babylonNode)return r;const o=[];let s=null;const i=[],l=[],h=[],u=[];for(let p=0;p<t.length;p++){const f=t[p],g=a.meshes[f];if(g)for(let y=0;y<g.primitives.length;y++){const m=new Qn,_=g.primitives[y];_.mode;const b=_.attributes;let v=null,w=null;for(const F in b)if(v=a.accessors[b[F]],w=ct.GetBufferFromAccessor(a,v),F==="NORMAL")m.normals=new Float32Array(w.length),m.normals.set(w);else if(F==="POSITION"){if(pt.HomogeneousCoordinates){m.positions=new Float32Array(w.length-w.length/4);for(let M=0;M<w.length;M+=4)m.positions[M]=w[M],m.positions[M+1]=w[M+1],m.positions[M+2]=w[M+2]}else m.positions=new Float32Array(w.length),m.positions.set(w);l.push(m.positions.length)}else if(F.indexOf("TEXCOORD_")!==-1){const M=Number(F.split("_")[1]),B=Be.UVKind+(M===0?"":M+1),C=new Float32Array(w.length);C.set(w),wi(C),m.set(C,B)}else F==="JOINT"?(m.matricesIndices=new Float32Array(w.length),m.matricesIndices.set(w)):F==="WEIGHT"?(m.matricesWeights=new Float32Array(w.length),m.matricesWeights.set(w)):F==="COLOR"&&(m.colors=new Float32Array(w.length),m.colors.set(w));if(v=a.accessors[_.indices],v)w=ct.GetBufferFromAccessor(a,v),m.indices=new Int32Array(w.length),m.indices.set(w),u.push(m.indices.length);else{const F=[];for(let M=0;M<m.positions.length/3;M++)F.push(M);m.indices=new Int32Array(F),u.push(m.indices.length)}s?s.merge(m):s=m;const I=a.scene.getMaterialById(_.material);o.push(I===null?ct.GetDefaultMaterial(a.scene):I),i.push(i.length===0?0:i[i.length-1]+l[l.length-2]),h.push(h.length===0?0:h[h.length-1]+u[u.length-2])}}let c;a.scene._blockEntityCollection=!!a.assetContainer,o.length>1?(c=new Ir("multimat"+n,a.scene),c.subMaterials=o):c=new Bt("multimat"+n,a.scene),o.length===1&&(c=o[0]),c._parentContainer=a.assetContainer,r.material||(r.material=c),new Jn(n,a.scene,s,!1,r),r.computeWorldMatrix(!0),a.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let p=0;p<t.length;p++){const f=t[p],g=a.meshes[f];if(g)for(let y=0;y<g.primitives.length;y++)g.primitives[y].mode,Pr.AddToMesh(d,i[d],l[d],h[d],u[d],r,r,!0),d++}return r},Xs=(a,e,t,n)=>{a.position&&(a.position=e),(a.rotationQuaternion||a.rotation)&&(a.rotationQuaternion=t),a.scaling&&(a.scaling=n)},Mi=(a,e)=>{if(e.matrix){const t=new K(0,0,0),n=new at,r=new K(0,0,0);it.FromArray(e.matrix).decompose(r,n,t),Xs(a,t,n,r)}else e.translation&&e.rotation&&e.scale&&Xs(a,K.FromArray(e.translation),at.FromArray(e.rotation),K.FromArray(e.scale));a.computeWorldMatrix(!0)},Si=(a,e,t)=>{let n=null;if(a.importOnlyMeshes&&(e.skin||e.meshes)&&a.importMeshesNames&&a.importMeshesNames.length>0&&a.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const r=a.skins[e.skin],o=ko(a,e,e.meshes,t,e.babylonNode);o.skeleton=a.scene.getLastSkeletonById(e.skin),o.skeleton===null&&(o.skeleton=Ei(a,r,o,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=o.skeleton)),n=o}}else if(e.meshes)n=ko(a,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!a.importOnlyMeshes){const r=a.lights[e.light];if(r){if(r.type==="ambient"){const o=r[r.type],s=new Js(e.light,K.Zero(),a.scene);s.name=e.name||"",o.color&&(s.diffuse=q.FromArray(o.color)),n=s}else if(r.type==="directional"){const o=r[r.type],s=new Ls(e.light,K.Zero(),a.scene);s.name=e.name||"",o.color&&(s.diffuse=q.FromArray(o.color)),n=s}else if(r.type==="point"){const o=r[r.type],s=new Zs(e.light,K.Zero(),a.scene);s.name=e.name||"",o.color&&(s.diffuse=q.FromArray(o.color)),n=s}else if(r.type==="spot"){const o=r[r.type],s=new Ht(e.light,K.Zero(),K.Zero(),0,0,a.scene);s.name=e.name||"",o.color&&(s.diffuse=q.FromArray(o.color)),o.fallOfAngle&&(s.angle=o.fallOfAngle),o.fallOffExponent&&(s.exponent=o.fallOffExponent),n=s}}}else if(e.camera&&!e.babylonNode&&!a.importOnlyMeshes){const r=a.cameras[e.camera];if(r){if(a.scene._blockEntityCollection=!!a.assetContainer,r.type==="orthographic"){const o=new qs(e.camera,K.Zero(),a.scene,!1);o.name=e.name||"",o.mode=Jo.ORTHOGRAPHIC_CAMERA,o.attachControl(),n=o,o._parentContainer=a.assetContainer}else if(r.type==="perspective"){const o=r[r.type],s=new qs(e.camera,K.Zero(),a.scene,!1);s.name=e.name||"",s.attachControl(),o.aspectRatio||(o.aspectRatio=a.scene.getEngine().getRenderWidth()/a.scene.getEngine().getRenderHeight()),o.znear&&o.zfar&&(s.maxZ=o.zfar,s.minZ=o.znear),n=s,s._parentContainer=a.assetContainer}a.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(n===null){a.scene._blockEntityCollection=!!a.assetContainer;const r=new ot(e.name||"",a.scene);r._parentContainer=a.assetContainer,a.scene._blockEntityCollection=!1,e.babylonNode=r,n=r}}if(n!==null){if(e.matrix&&n instanceof ot)Mi(n,e);else{const r=e.translation||[0,0,0],o=e.rotation||[0,0,0,1],s=e.scale||[1,1,1];Xs(n,K.FromArray(r),at.FromArray(o),K.FromArray(s))}n.updateCache(!0),e.babylonNode=n}return n},Dn=(a,e,t,n=!1)=>{const r=a.nodes[e];let o=null;if(a.importOnlyMeshes&&!n&&a.importMeshesNames?a.importMeshesNames.indexOf(r.name||"")!==-1||a.importMeshesNames.length===0?n=!0:n=!1:n=!0,!r.jointName&&n&&(o=Si(a,r,e),o!==null&&(o.id=e,o.parent=t)),r.children)for(let s=0;s<r.children.length;s++)Dn(a,r.children[s],o,n)},Vo=a=>{let e=a.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)Dn(a,e.nodes[t],null);else for(const t in a.scenes){e=a.scenes[t];for(let n=0;n<e.nodes.length;n++)Dn(a,e.nodes[n],null)}xi(a);for(let t=0;t<a.scene.skeletons.length;t++){const n=a.scene.skeletons[t];a.scene.beginAnimation(n,0,Number.MAX_VALUE,!0,1)}},Bi=(a,e,t,n,r,o,s)=>{const i=o.values||r.parameters;for(const l in t){const h=t[l],u=h.type;if(u===At.FLOAT_MAT2||u===At.FLOAT_MAT3||u===At.FLOAT_MAT4){if(h.semantic&&!h.source&&!h.node)ct.SetMatrix(e.scene,a,h,l,n.getEffect());else if(h.semantic&&(h.source||h.node)){let c=e.scene.getNodeByName(h.source||h.node||"");if(c===null&&(c=e.scene.getNodeById(h.source||h.node||"")),c===null)continue;ct.SetMatrix(e.scene,c,h,l,n.getEffect())}}else{const c=i[r.uniforms[l]];if(!c)continue;if(u===At.SAMPLER_2D){const d=e.textures[o.values?c:h.value].babylonTexture;if(d==null)continue;n.getEffect().setTexture(l,d)}else ct.SetUniform(n.getEffect(),l,c,u)}}s(n)},Ii=(a,e,t,n,r)=>{const o=n.values||t.parameters,s=t.uniforms;for(const i in r){const l=r[i],h=l.type;let u=o[s[i]];if(u===void 0&&(u=l.value),!u)continue;const c=d=>p=>{l.value&&d&&(e.setTexture(d,p),delete r[d])};h===At.SAMPLER_2D?dt.LoadTextureAsync(a,n.values?u:l.value,c(i),()=>c(null)):l.value&&ct.SetUniform(e,i,n.values?u:l.value,h)&&delete r[i]}},Pi=(a,e,t)=>(n,r)=>{e.dispose(!0),t("Cannot compile program named "+a.name+". Error: "+r+". Default material will be applied")},Ni=(a,e,t,n,r,o)=>s=>{Ii(a,e,t,n,r),e.onBind=i=>{Bi(i,a,r,e,t,n,o)}},Go=(a,e,t)=>{for(const n in e.uniforms){const r=e.uniforms[n],o=e.parameters[r];if(a.currentIdentifier===n&&o.semantic&&!o.source&&!o.node){const s=pr.indexOf(o.semantic);if(s!==-1)return delete t[n],fr[s]}}return a.currentIdentifier},Do=a=>{for(const e in a.materials)dt.LoadMaterialAsync(a,e,()=>{},()=>{})};class sn{static CreateRuntime(e,t,n){const r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&bt(e.extensions,"extensions",r),e.extensionsUsed&&bt(e.extensionsUsed,"extensionsUsed",r),e.buffers&&_i(e.buffers,r),e.bufferViews&&bt(e.bufferViews,"bufferViews",r),e.accessors&&bt(e.accessors,"accessors",r),e.meshes&&bt(e.meshes,"meshes",r),e.lights&&bt(e.lights,"lights",r),e.cameras&&bt(e.cameras,"cameras",r),e.nodes&&bt(e.nodes,"nodes",r),e.images&&bt(e.images,"images",r),e.textures&&bt(e.textures,"textures",r),e.shaders&&bi(e.shaders,r),e.programs&&bt(e.programs,"programs",r),e.samplers&&bt(e.samplers,"samplers",r),e.techniques&&bt(e.techniques,"techniques",r),e.materials&&bt(e.materials,"materials",r),e.animations&&bt(e.animations,"animations",r),e.skins&&bt(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,n,r,o){const s=e.buffers[t];Ve.IsBase64(s.uri)?setTimeout(()=>n(new Uint8Array(Ve.DecodeBase64(s.uri)))):Ve.LoadFile(e.rootUrl+s.uri,i=>n(new Uint8Array(i)),o,void 0,!0,i=>{i&&r(i.status+" "+i.statusText)})}static LoadTextureBufferAsync(e,t,n,r){const o=e.textures[t];if(!o||!o.source){r("");return}if(o.babylonTexture){n(null);return}const s=e.images[o.source];Ve.IsBase64(s.uri)?setTimeout(()=>n(new Uint8Array(Ve.DecodeBase64(s.uri)))):Ve.LoadFile(e.rootUrl+s.uri,i=>n(new Uint8Array(i)),void 0,void 0,!0,i=>{i&&r(i.status+" "+i.statusText)})}static CreateTextureAsync(e,t,n,r){const o=e.textures[t];if(o.babylonTexture){r(o.babylonTexture);return}const s=e.samplers[o.sampler],i=s.minFilter===Wt.NEAREST_MIPMAP_NEAREST||s.minFilter===Wt.NEAREST_MIPMAP_LINEAR||s.minFilter===Wt.LINEAR_MIPMAP_NEAREST||s.minFilter===Wt.LINEAR_MIPMAP_LINEAR,l=qe.BILINEAR_SAMPLINGMODE,h=n==null?new Blob:new Blob([n]),u=URL.createObjectURL(h),c=()=>URL.revokeObjectURL(u),d=new qe(u,e.scene,!i,!0,l,c,c);s.wrapS!==void 0&&(d.wrapU=ct.GetWrapMode(s.wrapS)),s.wrapT!==void 0&&(d.wrapV=ct.GetWrapMode(s.wrapT)),d.name=t,o.babylonTexture=d,r(d)}static LoadShaderStringAsync(e,t,n,r){const o=e.shaders[t];if(Ve.IsBase64(o.uri)){const s=atob(o.uri.split(",")[1]);n&&n(s)}else Ve.LoadFile(e.rootUrl+o.uri,n,void 0,void 0,!1,s=>{s&&r&&r(s.status+" "+s.statusText)})}static LoadMaterialAsync(e,t,n,r){const o=e.materials[t];if(!o.technique){r&&r("No technique found.");return}const s=e.techniques[o.technique];if(!s){e.scene._blockEntityCollection=!!e.assetContainer;const I=new Bt(t,e.scene);I._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,I.diffuseColor=new q(.5,.5,.5),I.sideOrientation=Rt.CounterClockWiseSideOrientation,n(I);return}const i=e.programs[s.program],l=s.states,h=wn.ShadersStore[i.vertexShader+"VertexShader"],u=wn.ShadersStore[i.fragmentShader+"PixelShader"];let c="",d="";const p=new Fo(h),f=new Fo(u),g={},y=[],m=[],_=[];for(const I in s.uniforms){const F=s.uniforms[I],M=s.parameters[F];if(g[I]=M,M.semantic&&!M.node&&!M.source){const B=pr.indexOf(M.semantic);B!==-1?(y.push(fr[B]),delete g[I]):y.push(I)}else M.type===At.SAMPLER_2D?_.push(I):y.push(I)}for(const I in s.attributes){const F=s.attributes[I],M=s.parameters[F];if(M.semantic){const B=Lo(M);B&&m.push(B)}}for(;!p.isEnd()&&p.getNextToken();){if(p.currentToken!==fn.IDENTIFIER){c+=p.currentString;continue}let F=!1;for(const M in s.attributes){const B=s.attributes[M],C=s.parameters[B];if(p.currentIdentifier===M&&C.semantic){c+=Lo(C),F=!0;break}}F||(c+=Go(p,s,g))}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==fn.IDENTIFIER){d+=f.currentString;continue}d+=Go(f,s,g)}const b={vertex:i.vertexShader+t,fragment:i.fragmentShader+t},v={attributes:m,uniforms:y,samplers:_,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};wn.ShadersStore[i.vertexShader+t+"VertexShader"]=c,wn.ShadersStore[i.fragmentShader+t+"PixelShader"]=d;const w=new Xo(t,e.scene,b,v);if(w.onError=Pi(i,w,r),w.onCompiled=Ni(e,w,s,o,g,n),w.sideOrientation=Rt.CounterClockWiseSideOrientation,l&&l.functions){const I=l.functions;I.cullFace&&I.cullFace[0]!==Ys.BACK&&(w.backFaceCulling=!1);const F=I.blendFuncSeparate;F&&(F[0]===et.SRC_ALPHA&&F[1]===et.ONE_MINUS_SRC_ALPHA&&F[2]===et.ONE&&F[3]===et.ONE?w.alphaMode=cn.ALPHA_COMBINE:F[0]===et.ONE&&F[1]===et.ONE&&F[2]===et.ZERO&&F[3]===et.ONE?w.alphaMode=cn.ALPHA_ONEONE:F[0]===et.SRC_ALPHA&&F[1]===et.ONE&&F[2]===et.ZERO&&F[3]===et.ONE?w.alphaMode=cn.ALPHA_ADD:F[0]===et.ZERO&&F[1]===et.ONE_MINUS_SRC_COLOR&&F[2]===et.ONE&&F[3]===et.ONE?w.alphaMode=cn.ALPHA_SUBTRACT:F[0]===et.DST_COLOR&&F[1]===et.ZERO&&F[2]===et.ONE&&F[3]===et.ONE?w.alphaMode=cn.ALPHA_MULTIPLY:F[0]===et.SRC_ALPHA&&F[1]===et.ONE_MINUS_SRC_COLOR&&F[2]===et.ONE&&F[3]===et.ONE&&(w.alphaMode=cn.ALPHA_MAXIMIZED))}}}let Nn=class Qs{static RegisterExtension(e){if(Qs.Extensions[e.name]){Ve.Error('Tool with the same name "'+e.name+'" already exists');return}Qs.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,n,r,o,s,i,l){return t.useRightHandedSystem=!0,dt.LoadRuntimeAsync(t,n,r,h=>{h.assetContainer=o,h.importOnlyMeshes=!0,e===""?h.importMeshesNames=[]:typeof e=="string"?h.importMeshesNames=[e]:e&&!(e instanceof Array)?h.importMeshesNames=[e]:(h.importMeshesNames=[],Ve.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(h);const u=[],c=[];for(const d in h.nodes){const p=h.nodes[d];p.babylonNode instanceof Qo&&u.push(p.babylonNode)}for(const d in h.skins){const p=h.skins[d];p.babylonSkeleton instanceof Fs&&c.push(p.babylonSkeleton)}this._loadBuffersAsync(h,()=>{this._loadShadersAsync(h,()=>{Do(h),Vo(h),!pt.IncrementalLoading&&s&&s(u,c)})}),pt.IncrementalLoading&&s&&s(u,c)},l),!0}importMeshAsync(e,t,n,r,o,s){return new Promise((i,l)=>{this._importMeshAsync(e,t,r,o,n,(h,u)=>{i({meshes:h,particleSystems:[],skeletons:u,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},s,h=>{l(new Error(h))})})}_loadAsync(e,t,n,r,o,s){e.useRightHandedSystem=!0,dt.LoadRuntimeAsync(e,t,n,i=>{dt.LoadRuntimeExtensionsAsync(i,()=>{this._createNodes(i),this._loadBuffersAsync(i,()=>{this._loadShadersAsync(i,()=>{Do(i),Vo(i),pt.IncrementalLoading||r()})}),pt.IncrementalLoading&&r()},s)},s)}async loadAsync(e,t,n,r){return await new Promise((o,s)=>{this._loadAsync(e,t,n,()=>{o()},r,i=>{s(new Error(i))})})}_loadShadersAsync(e,t){let n=!1;const r=(o,s)=>{dt.LoadShaderStringAsync(e,o,i=>{i instanceof ArrayBuffer||(e.loadedShaderCount++,i&&(wn.ShadersStore[o+(s.type===js.VERTEX?"VertexShader":"PixelShader")]=i),e.loadedShaderCount===e.shaderscount&&t())},()=>{Ve.Error("Error when loading shader program named "+o+" located at "+s.uri)})};for(const o in e.shaders){n=!0;const s=e.shaders[o];s?r.bind(this,o,s)():Ve.Error("No shader named: "+o)}n||t()}_loadBuffersAsync(e,t){let n=!1;const r=(o,s)=>{dt.LoadBufferAsync(e,o,i=>{e.loadedBufferCount++,i&&(i.byteLength!=e.buffers[o].byteLength&&Ve.Error("Buffer named "+o+" is length "+i.byteLength+". Expected: "+s.byteLength),e.loadedBufferViews[o]=i),e.loadedBufferCount===e.buffersCount&&t()},()=>{Ve.Error("Error when loading buffer named "+o+" located at "+s.uri)})};for(const o in e.buffers){n=!0;const s=e.buffers[o];s?r.bind(this,o,s)():Ve.Error("No buffer named: "+o)}n||t()}_createNodes(e){let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)Dn(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let r=0;r<t.nodes.length;r++)Dn(e,t.nodes[r],null)}}};Nn.Extensions={};class dt{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,n,r,o){return!1}loadRuntimeExtensionsAsync(e,t,n){return!1}loadBufferAsync(e,t,n,r,o){return!1}loadTextureBufferAsync(e,t,n,r){return!1}createTextureAsync(e,t,n,r,o){return!1}loadShaderStringAsync(e,t,n,r){return!1}loadMaterialAsync(e,t,n,r){return!1}static LoadRuntimeAsync(e,t,n,r,o){dt._ApplyExtensions(s=>s.loadRuntimeAsync(e,t,n,r,o),()=>{setTimeout(()=>{r&&r(sn.CreateRuntime(t.json,e,n))})})}static LoadRuntimeExtensionsAsync(e,t,n){dt._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,n),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,n,r,o){dt._ApplyExtensions(s=>s.loadBufferAsync(e,t,n,r,o),()=>{sn.LoadBufferAsync(e,t,n,r,o)})}static LoadTextureAsync(e,t,n,r){dt._LoadTextureBufferAsync(e,t,o=>{o&&dt._CreateTextureAsync(e,t,o,n,r)},r)}static LoadShaderStringAsync(e,t,n,r){dt._ApplyExtensions(o=>o.loadShaderStringAsync(e,t,n,r),()=>{sn.LoadShaderStringAsync(e,t,n,r)})}static LoadMaterialAsync(e,t,n,r){dt._ApplyExtensions(o=>o.loadMaterialAsync(e,t,n,r),()=>{sn.LoadMaterialAsync(e,t,n,r)})}static _LoadTextureBufferAsync(e,t,n,r){dt._ApplyExtensions(o=>o.loadTextureBufferAsync(e,t,n,r),()=>{sn.LoadTextureBufferAsync(e,t,n,r)})}static _CreateTextureAsync(e,t,n,r,o){dt._ApplyExtensions(s=>s.createTextureAsync(e,t,n,r,o),()=>{sn.CreateTextureAsync(e,t,n,r)})}static _ApplyExtensions(e,t){for(const n in Nn.Extensions){const r=Nn.Extensions[n];if(e(r))return}t()}}pt._CreateGLTF1Loader=()=>new Nn;const Oi="binary_glTF";class Ri extends dt{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,n,r){const o=t.json.extensionsUsed;return!o||o.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,r(sn.CreateRuntime(t.json,e,n)),!0)}loadBufferAsync(e,t,n,r){return e.extensionsUsed.indexOf(this.name)===-1||t!==Oi?!1:(this._bin.readAsync(0,this._bin.byteLength).then(n,o=>r(o.message)),!0)}loadTextureBufferAsync(e,t,n){const r=e.textures[t],o=e.images[r.source];if(!o.extensions||!(this.name in o.extensions))return!1;const s=o.extensions[this.name],i=e.bufferViews[s.bufferView],l=ct.GetBufferFromBufferView(e,i,0,i.byteLength,pn.UNSIGNED_BYTE);return n(l),!0}loadShaderStringAsync(e,t,n){const r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;const o=r.extensions[this.name],s=e.bufferViews[o.bufferView],i=ct.GetBufferFromBufferView(e,s,0,s.byteLength,pn.UNSIGNED_BYTE);return setTimeout(()=>{const l=ct.DecodeBufferToText(i);n(l)}),!0}}Nn.RegisterExtension(new Ri);class Fi extends dt{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const n=t.lights;if(n)for(const r in n){const o=n[r];switch(o.type){case"ambient":{const s=new Js(o.name,new K(0,1,0),e.scene),i=o.ambient;i&&(s.diffuse=q.FromArray(i.color||[1,1,1]));break}case"point":{const s=new Zs(o.name,new K(10,10,10),e.scene),i=o.point;i&&(s.diffuse=q.FromArray(i.color||[1,1,1]));break}case"directional":{const s=new Ls(o.name,new K(0,-1,0),e.scene),i=o.directional;i&&(s.diffuse=q.FromArray(i.color||[1,1,1]));break}case"spot":{const s=o.spot;if(s){const i=new Ht(o.name,new K(0,10,0),new K(0,-1,0),s.fallOffAngle||Math.PI,s.fallOffExponent||0,e.scene);i.diffuse=q.FromArray(s.color||[1,1,1])}break}default:Ve.Warn('GLTF Material Common extension: light type "'+o.type+" not supported");break}}return!1}loadMaterialAsync(e,t,n,r){const o=e.materials[t];if(!o||!o.extensions)return!1;const s=o.extensions[this.name];if(!s)return!1;const i=new Bt(t,e.scene);return i.sideOrientation=Rt.CounterClockWiseSideOrientation,s.technique==="CONSTANT"&&(i.disableLighting=!0),i.backFaceCulling=s.doubleSided===void 0?!1:!s.doubleSided,i.alpha=s.values.transparency===void 0?1:s.values.transparency,i.specularPower=s.values.shininess===void 0?0:s.values.shininess,typeof s.values.ambient=="string"?this._loadTexture(e,s.values.ambient,i,"ambientTexture",r):i.ambientColor=q.FromArray(s.values.ambient||[0,0,0]),typeof s.values.diffuse=="string"?this._loadTexture(e,s.values.diffuse,i,"diffuseTexture",r):i.diffuseColor=q.FromArray(s.values.diffuse||[0,0,0]),typeof s.values.emission=="string"?this._loadTexture(e,s.values.emission,i,"emissiveTexture",r):i.emissiveColor=q.FromArray(s.values.emission||[0,0,0]),typeof s.values.specular=="string"?this._loadTexture(e,s.values.specular,i,"specularTexture",r):i.specularColor=q.FromArray(s.values.specular||[0,0,0]),!0}_loadTexture(e,t,n,r,o){sn.LoadTextureBufferAsync(e,t,s=>{sn.CreateTextureAsync(e,t,s,i=>n[r]=i)},o)}}Nn.RegisterExtension(new Fi);const no=new Map,Li=no;function Fe(a,e,t){Oe(a)&&Me.Warn(`Extension with the name '${a}' already exists`),no.set(a,{isGLTFExtension:e,factory:t})}function Oe(a){return no.delete(a)}const ki=[{regex:new RegExp("^/nodes/\\d+/extensions/")}];class Vi{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t=this._gltf,n=this._infoTree,r;if(!e.startsWith("/"))throw new Error("Path must start with a /");const o=e.split("/");if(o.shift(),o[o.length-1].includes(".length")){const l=o[o.length-1].split(".");o.pop(),o.push(...l)}let s=!1;for(const i of o){const l=i==="length";if(l&&!n.__array__)throw new Error(`Path ${e} is invalid`);if(n.__ignoreObjectTree__&&(s=!0),n.__array__&&!l)n=n.__array__;else if(n=n[i],!n)throw new Error(`Path ${e} is invalid`);if(!s)if(t===void 0){if(!ki.find(u=>u.regex.test(e)))throw new Error(`Path ${e} is invalid`)}else l||(t=t?.[i]);(n.__target__||l)&&(r=t)}return{object:r,info:n}}}const Gi={length:{type:"number",get:a=>a.length,getTarget:a=>a.map(e=>e._babylonTransformNode),getPropertyName:[()=>"length"]},__array__:{__target__:!0,translation:{type:"Vector3",get:a=>a._babylonTransformNode?.position,set:(a,e)=>e._babylonTransformNode?.position.copyFrom(a),getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"position"]},rotation:{type:"Quaternion",get:a=>a._babylonTransformNode?.rotationQuaternion,set:(a,e)=>e._babylonTransformNode?.rotationQuaternion?.copyFrom(a),getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"rotationQuaternion"]},scale:{type:"Vector3",get:a=>a._babylonTransformNode?.scaling,set:(a,e)=>e._babylonTransformNode?.scaling.copyFrom(a),getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"scaling"]},weights:{length:{type:"number",get:a=>a._numMorphTargets,getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"influence"]},__array__:{__target__:!0,type:"number",get:(a,e)=>e!==void 0?a._primitiveBabylonMeshes?.[0].morphTargetManager?.getTarget(e).influence:void 0,getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"influence"]},type:"number[]",get:(a,e)=>[0],getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"influence"]},matrix:{type:"Matrix",get:a=>it.Compose(a._babylonTransformNode?.scaling,a._babylonTransformNode?.rotationQuaternion,a._babylonTransformNode?.position),getTarget:a=>a._babylonTransformNode,isReadOnly:!0},globalMatrix:{type:"Matrix",get:a=>{const e=it.Identity();let t=a.parent;for(;t&&t.parent;)t=t.parent;const n=a._babylonTransformNode?.position._isDirty||a._babylonTransformNode?.rotationQuaternion?._isDirty||a._babylonTransformNode?.scaling._isDirty;if(t){const r=t._babylonTransformNode?.computeWorldMatrix(!0).invert();r&&a._babylonTransformNode?.computeWorldMatrix(n)?.multiplyToRef(r,e)}else a._babylonTransformNode&&e.copyFrom(a._babylonTransformNode.computeWorldMatrix(n));return e},getTarget:a=>a._babylonTransformNode,isReadOnly:!0},extensions:{EXT_lights_ies:{multiplier:{type:"number",get:a=>a._babylonTransformNode?.getChildren(e=>e instanceof Ht,!0)[0]?.intensity,getTarget:a=>a._babylonTransformNode?.getChildren(e=>e instanceof Ht,!0)[0],set:(a,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof Ht,!0)[0];t&&(t.intensity=a)}}},color:{type:"Color3",get:a=>a._babylonTransformNode?.getChildren(e=>e instanceof Ht,!0)[0]?.diffuse,getTarget:a=>a._babylonTransformNode?.getChildren(e=>e instanceof Ht,!0)[0],set:(a,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof Ht,!0)[0];t&&(t.diffuse=a)}}}},KHR_node_visibility:{visible:{type:"boolean",get:a=>a._primitiveBabylonMeshes?a._primitiveBabylonMeshes[0].isVisible:!1,getTarget:()=>{},set:(a,e)=>{e._primitiveBabylonMeshes&&e._primitiveBabylonMeshes.forEach(t=>t.isVisible=a)}}}}}},Di={length:{type:"number",get:a=>a.length,getTarget:a=>a.map(e=>e._babylonAnimationGroup),getPropertyName:[()=>"length"]},__array__:{}},$i={length:{type:"number",get:a=>a.length,getTarget:a=>a.map(e=>e.primitives[0]._instanceData?.babylonSourceMesh),getPropertyName:[()=>"length"]},__array__:{}},Hi={__array__:{__target__:!0,orthographic:{xmag:{componentsCount:2,type:"Vector2",get:a=>new Tn(a._babylonCamera?.orthoLeft??0,a._babylonCamera?.orthoRight??0),set:(a,e)=>{e._babylonCamera&&(e._babylonCamera.orthoLeft=a.x,e._babylonCamera.orthoRight=a.y)},getTarget:a=>a,getPropertyName:[()=>"orthoLeft",()=>"orthoRight"]},ymag:{componentsCount:2,type:"Vector2",get:a=>new Tn(a._babylonCamera?.orthoBottom??0,a._babylonCamera?.orthoTop??0),set:(a,e)=>{e._babylonCamera&&(e._babylonCamera.orthoBottom=a.x,e._babylonCamera.orthoTop=a.y)},getTarget:a=>a,getPropertyName:[()=>"orthoBottom",()=>"orthoTop"]},zfar:{type:"number",get:a=>a._babylonCamera?.maxZ,set:(a,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=a)},getTarget:a=>a,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:a=>a._babylonCamera?.minZ,set:(a,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=a)},getTarget:a=>a,getPropertyName:[()=>"minZ"]}},perspective:{aspectRatio:{type:"number",get:a=>a._babylonCamera?.getEngine().getAspectRatio(a._babylonCamera),getTarget:a=>a,getPropertyName:[()=>"aspectRatio"],isReadOnly:!0},yfov:{type:"number",get:a=>a._babylonCamera?.fov,set:(a,e)=>{e._babylonCamera&&(e._babylonCamera.fov=a)},getTarget:a=>a,getPropertyName:[()=>"fov"]},zfar:{type:"number",get:a=>a._babylonCamera?.maxZ,set:(a,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=a)},getTarget:a=>a,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:a=>a._babylonCamera?.minZ,set:(a,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=a)},getTarget:a=>a,getPropertyName:[()=>"minZ"]}}}},zi={__array__:{__target__:!0,emissiveFactor:{type:"Color3",get:(a,e,t)=>ie(a,e,t).emissiveColor,set:(a,e,t,n)=>ie(e,t,n).emissiveColor.copyFrom(a),getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"emissiveColor"]},emissiveTexture:{extensions:{KHR_texture_transform:ht("emissiveTexture")}},normalTexture:{scale:{type:"number",get:(a,e,t)=>un(a,t,"bumpTexture")?.level,set:(a,e,t,n)=>{const r=un(e,n,"bumpTexture");r&&(r.level=a)},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"level"]},extensions:{KHR_texture_transform:ht("bumpTexture")}},occlusionTexture:{strength:{type:"number",get:(a,e,t)=>ie(a,e,t).ambientTextureStrength,set:(a,e,t,n)=>{const r=ie(e,t,n);r&&(r.ambientTextureStrength=a)},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"ambientTextureStrength"]},extensions:{KHR_texture_transform:ht("ambientTexture")}},pbrMetallicRoughness:{baseColorFactor:{type:"Color4",get:(a,e,t)=>{const n=ie(a,e,t);return Xt.FromColor3(n.albedoColor,n.alpha)},set:(a,e,t,n)=>{const r=ie(e,t,n);r.albedoColor.set(a.r,a.g,a.b),r.alpha=a.a},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"albedoColor",()=>"alpha"]},baseColorTexture:{extensions:{KHR_texture_transform:ht("albedoTexture")}},metallicFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).metallic,set:(a,e,t,n)=>{const r=ie(e,t,n);r&&(r.metallic=a)},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"metallic"]},roughnessFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).roughness,set:(a,e,t,n)=>{const r=ie(e,t,n);r&&(r.roughness=a)},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"roughness"]},metallicRoughnessTexture:{extensions:{KHR_texture_transform:ht("metallicTexture")}}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:{type:"number",get:(a,e,t)=>ie(a,e,t).anisotropy.intensity,set:(a,e,t,n)=>{ie(e,t,n).anisotropy.intensity=a},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"anisotropy.intensity"]},anisotropyRotation:{type:"number",get:(a,e,t)=>ie(a,e,t).anisotropy.angle,set:(a,e,t,n)=>{ie(e,t,n).anisotropy.angle=a},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"anisotropy.angle"]},anisotropyTexture:{extensions:{KHR_texture_transform:ht("anisotropy","texture")}}},KHR_materials_clearcoat:{clearcoatFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).clearCoat.intensity,set:(a,e,t,n)=>{ie(e,t,n).clearCoat.intensity=a},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"clearCoat.intensity"]},clearcoatRoughnessFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).clearCoat.roughness,set:(a,e,t,n)=>{ie(e,t,n).clearCoat.roughness=a},getTarget:(a,e,t)=>ie(a,e,t),getPropertyName:[()=>"clearCoat.roughness"]},clearcoatTexture:{extensions:{KHR_texture_transform:ht("clearCoat","texture")}},clearcoatNormalTexture:{scale:{type:"number",get:(a,e,t)=>ie(a,e,t).clearCoat.bumpTexture?.level,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).clearCoat.bumpTexture.level=a},extensions:{KHR_texture_transform:ht("clearCoat","bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:ht("clearCoat","textureRoughness")}}},KHR_materials_dispersion:{dispersion:{type:"number",get:(a,e,t)=>ie(a,e,t).subSurface.dispersion,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).subSurface.dispersion=a}},KHR_materials_emissive_strength:{emissiveStrength:{type:"number",get:(a,e,t)=>ie(a,e,t).emissiveIntensity,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).emissiveIntensity=a}},KHR_materials_ior:{ior:{type:"number",get:(a,e,t)=>ie(a,e,t).indexOfRefraction,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).indexOfRefraction=a}},KHR_materials_iridescence:{iridescenceFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).iridescence.intensity,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).iridescence.intensity=a},iridescenceIor:{type:"number",get:(a,e,t)=>ie(a,e,t).iridescence.indexOfRefraction,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).iridescence.indexOfRefraction=a},iridescenceTexture:{extensions:{KHR_texture_transform:ht("iridescence","texture")}},iridescenceThicknessMaximum:{type:"number",get:(a,e,t)=>ie(a,e,t).iridescence.maximumThickness,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).iridescence.maximumThickness=a},iridescenceThicknessMinimum:{type:"number",get:(a,e,t)=>ie(a,e,t).iridescence.minimumThickness,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).iridescence.minimumThickness=a},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:ht("iridescence","thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:{type:"Color3",get:(a,e,t)=>ie(a,e,t).sheen.color,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).sheen.color.copyFrom(a)},sheenColorTexture:{extensions:{KHR_texture_transform:ht("sheen","texture")}},sheenRoughnessFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).sheen.intensity,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).sheen.intensity=a},sheenRoughnessTexture:{extensions:{KHR_texture_transform:ht("sheen","thicknessTexture")}}},KHR_materials_specular:{specularFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).metallicF0Factor,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).metallicF0Factor=a,getPropertyName:[()=>"metallicF0Factor"]},specularColorFactor:{type:"Color3",get:(a,e,t)=>ie(a,e,t).metallicReflectanceColor,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).metallicReflectanceColor.copyFrom(a),getPropertyName:[()=>"metallicReflectanceColor"]},specularTexture:{extensions:{KHR_texture_transform:ht("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:ht("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).subSurface.refractionIntensity,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).subSurface.refractionIntensity=a,getPropertyName:[()=>"subSurface.refractionIntensity"]},transmissionTexture:{extensions:{KHR_texture_transform:ht("subSurface","refractionIntensityTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).subSurface.translucencyIntensity,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).subSurface.translucencyIntensity=a},diffuseTransmissionTexture:{extensions:{KHR_texture_transform:ht("subSurface","translucencyIntensityTexture")}},diffuseTransmissionColorFactor:{type:"Color3",get:(a,e,t)=>ie(a,e,t).subSurface.translucencyColor,getTarget:ie,set:(a,e,t,n)=>a&&ie(e,t,n).subSurface.translucencyColor?.copyFrom(a)},diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:ht("subSurface","translucencyColorTexture")}}},KHR_materials_volume:{attenuationColor:{type:"Color3",get:(a,e,t)=>ie(a,e,t).subSurface.tintColor,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).subSurface.tintColor.copyFrom(a)},attenuationDistance:{type:"number",get:(a,e,t)=>ie(a,e,t).subSurface.tintColorAtDistance,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).subSurface.tintColorAtDistance=a},thicknessFactor:{type:"number",get:(a,e,t)=>ie(a,e,t).subSurface.maximumThickness,getTarget:ie,set:(a,e,t,n)=>ie(e,t,n).subSurface.maximumThickness=a},thicknessTexture:{extensions:{KHR_texture_transform:ht("subSurface","thicknessTexture")}}}}}},Ui={KHR_lights_punctual:{lights:{length:{type:"number",get:a=>a.length,getTarget:a=>a.map(e=>e._babylonLight),getPropertyName:[a=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:a=>a._babylonLight?.diffuse,set:(a,e)=>e._babylonLight?.diffuse.copyFrom(a),getTarget:a=>a._babylonLight,getPropertyName:[a=>"diffuse"]},intensity:{type:"number",get:a=>a._babylonLight?.intensity,set:(a,e)=>e._babylonLight?e._babylonLight.intensity=a:void 0,getTarget:a=>a._babylonLight,getPropertyName:[a=>"intensity"]},range:{type:"number",get:a=>a._babylonLight?.range,set:(a,e)=>e._babylonLight?e._babylonLight.range=a:void 0,getTarget:a=>a._babylonLight,getPropertyName:[a=>"range"]},spot:{innerConeAngle:{type:"number",get:a=>a._babylonLight?.innerAngle,set:(a,e)=>e._babylonLight?e._babylonLight.innerAngle=a:void 0,getTarget:a=>a._babylonLight,getPropertyName:[a=>"innerConeAngle"]},outerConeAngle:{type:"number",get:a=>a._babylonLight?.angle,set:(a,e)=>e._babylonLight?e._babylonLight.angle=a:void 0,getTarget:a=>a._babylonLight,getPropertyName:[a=>"outerConeAngle"]}}}}},EXT_lights_area:{lights:{length:{type:"number",get:a=>a.length,getTarget:a=>a.map(e=>e._babylonLight),getPropertyName:[a=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:a=>a._babylonLight?.diffuse,set:(a,e)=>e._babylonLight?.diffuse.copyFrom(a),getTarget:a=>a._babylonLight,getPropertyName:[a=>"diffuse"]},intensity:{type:"number",get:a=>a._babylonLight?.intensity,set:(a,e)=>e._babylonLight?e._babylonLight.intensity=a:void 0,getTarget:a=>a._babylonLight,getPropertyName:[a=>"intensity"]},size:{type:"number",get:a=>a._babylonLight?.height,set:(a,e)=>e._babylonLight?e._babylonLight.height=a:void 0,getTarget:a=>a._babylonLight,getPropertyName:[a=>"size"]},rect:{aspect:{type:"number",get:a=>a._babylonLight?.width/a._babylonLight?.height,set:(a,e)=>e._babylonLight?e._babylonLight.width=a*e._babylonLight.height:void 0,getTarget:a=>a._babylonLight,getPropertyName:[a=>"aspect"]}}}}},EXT_lights_ies:{lights:{length:{type:"number",get:a=>a.length,getTarget:a=>a.map(e=>e._babylonLight),getPropertyName:[a=>"length"]}}},EXT_lights_image_based:{lights:{length:{type:"number",get:a=>a.length,getTarget:a=>a.map(e=>e._babylonTexture),getPropertyName:[a=>"length"]},__array__:{__target__:!0,intensity:{type:"number",get:a=>a._babylonTexture?.level,set:(a,e)=>{e._babylonTexture&&(e._babylonTexture.level=a)},getTarget:a=>a._babylonTexture},rotation:{type:"Quaternion",get:a=>a._babylonTexture&&at.FromRotationMatrix(a._babylonTexture?.getReflectionTextureMatrix()),set:(a,e)=>{e._babylonTexture&&(e._babylonTexture.getScene()?.useRightHandedSystem||(a=at.Inverse(a)),it.FromQuaternionToRef(a,e._babylonTexture.getReflectionTextureMatrix()))},getTarget:a=>a._babylonTexture}}}}};function un(a,e,t,n){const r=ie(a);return n?r[t][n]:r[t]}function ie(a,e,t){return a._data?.[t?.fillMode??cn.MATERIAL_TriangleFillMode]?.babylonMaterial}function ht(a,e){return{offset:{componentsCount:2,type:"Vector2",get:(t,n,r)=>{const o=un(t,r,a,e);return new Tn(o?.uOffset,o?.vOffset)},getTarget:ie,set:(t,n,r,o)=>{const s=un(n,o,a,e);s.uOffset=t.x,s.vOffset=t.y},getPropertyName:[()=>`${a}${e?"."+e:""}.uOffset`,()=>`${a}${e?"."+e:""}.vOffset`]},rotation:{type:"number",get:(t,n,r)=>un(t,r,a,e)?.wAng,getTarget:ie,set:(t,n,r,o)=>un(n,o,a,e).wAng=t,getPropertyName:[()=>`${a}${e?"."+e:""}.wAng`]},scale:{componentsCount:2,type:"Vector2",get:(t,n,r)=>{const o=un(t,r,a,e);return new Tn(o?.uScale,o?.vScale)},getTarget:ie,set:(t,n,r,o)=>{const s=un(n,o,a,e);s.uScale=t.x,s.vScale=t.y},getPropertyName:[()=>`${a}${e?"."+e:""}.uScale`,()=>`${a}${e?"."+e:""}.vScale`]}}}const ks={cameras:Hi,nodes:Gi,materials:zi,extensions:Ui,animations:Di,meshes:$i};function yr(a){return new Vi(a,ks)}function jn(a){const e=a.split("/").map(n=>n.replace(/{}/g,"__array__"));let t=ks;for(const n of e)n&&(t=t[n]);if(t&&t.type&&t.get)return t}function Y(a,e){const t=a.split("/").map(r=>r.replace(/{}/g,"__array__"));let n=ks;for(const r of t)r&&(n=n[r]);n&&n.type&&n.get&&(n.interpolation=e)}function Yt(a,e){const t=a.split("/").map(r=>r.replace(/{}/g,"__array__"));let n=ks;for(const r of t)if(r){if(!n[r]){if(r==="?"){n.__ignoreObjectTree__=!0;continue}n[r]={},r==="__array__"&&(n[r].__target__=!0)}n=n[r]}Object.assign(n,e)}const Wi=new Zo(()=>xn(()=>import("./babylon-DKNSOLis.js").then(a=>a.ax),[])),qi=new Zo(()=>xn(()=>Promise.resolve().then(()=>Ki),void 0));class pe{static Get(e,t,n){if(!t||n==null||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function gr(a){if(a.min&&a.max){const e=a.min,t=a.max,n=Nt.Vector3[0].copyFromFloats(e[0],e[1],e[2]),r=Nt.Vector3[1].copyFromFloats(t[0],t[1],t[2]);if(a.normalized&&a.componentType!==5126){let o=1;switch(a.componentType){case 5120:o=127;break;case 5121:o=255;break;case 5122:o=32767;break;case 5123:o=65535;break}const s=1/o;n.scaleInPlace(s),r.scaleInPlace(s)}return new Dr(n,r)}return null}class be{static RegisterExtension(e,t){Fe(e,!1,t)}static UnregisterExtension(e){return Oe(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._materialAdapterCache=new WeakMap,this._pbrMaterialImpl=null,this._parent=e}_getOrCreateMaterialAdapter(e){let t=this._materialAdapterCache.get(e);if(!t){if(this._pbrMaterialImpl)t=new this._pbrMaterialImpl.adapterClass(e);else throw new Error("Appropriate material adapter class not found");this._materialAdapterCache.set(e,t)}return t}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}async importMeshAsync(e,t,n,r,o,s,i=""){return await Promise.resolve().then(async()=>{this._babylonScene=t,this._assetContainer=n,this._loadData(r);let l=null;if(e){const h={};if(this._gltf.nodes)for(const c of this._gltf.nodes)c.name&&(h[c.name]=c.index);l=(e instanceof Array?e:[e]).map(c=>{const d=h[c];if(d===void 0)throw new Error(`Failed to find node '${c}'`);return d})}return await this._loadAsync(o,i,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}async loadAsync(e,t,n,r,o=""){return this._babylonScene=e,this._loadData(t),await this._loadAsync(n,o,null,()=>{})}async _loadAsync(e,t,n,r){return await Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync(),!this.parent.skipMaterials&&this._pbrMaterialImpl==null&&(this.parent.useOpenPBR||this.isExtensionUsed("KHR_materials_openpbr")?this._pbrMaterialImpl={materialClass:(await xn(async()=>{const{OpenPBRMaterial:u}=await import("./babylon-DKNSOLis.js").then(c=>c.az);return{OpenPBRMaterial:u}},[])).OpenPBRMaterial,adapterClass:(await xn(async()=>{const{OpenPBRMaterialLoadingAdapter:u}=await import("./openpbrMaterialLoadingAdapter-DUmKUa7I.js");return{OpenPBRMaterialLoadingAdapter:u}},[])).OpenPBRMaterialLoadingAdapter}:this._pbrMaterialImpl={materialClass:(await xn(async()=>{const{PBRMaterial:u}=await import("./babylon-DKNSOLis.js").then(c=>c.ay);return{PBRMaterial:u}},[])).PBRMaterial,adapterClass:(await xn(async()=>{const{PBRMaterialLoadingAdapter:u}=await import("./pbrMaterialLoadingAdapter-saCZzkCt.js");return{PBRMaterialLoadingAdapter:u}},__vite__mapDeps([0,1]))).PBRMaterialLoadingAdapter});const o=`${St[St.LOADING]} => ${St[St.READY]}`,s=`${St[St.LOADING]} => ${St[St.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(s),this._parent._setState(St.LOADING),this._extensionsOnLoading();const i=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(n)i.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const u=pe.Get("/scene",this._gltf.scenes,this._gltf.scene||0);i.push(this.loadSceneAsync(`/scenes/${u.index}`,u))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let u=0;u<this._gltf.materials.length;++u){const c=this._gltf.materials[u],d="/materials/"+u,p=Rt.TriangleFillMode;i.push(this._loadMaterialAsync(d,c,null,p,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&i.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&i.push(this._compileShadowGeneratorsAsync()),await Promise.all(i).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(const u of this._babylonScene.materials){const c=u;c.maxSimultaneousLights!==void 0&&(c.maxSimultaneousLights=Math.max(c.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(St.READY),this._skipStartAnimationStep||this._startAnimations(),r()}).then(u=>(this._parent._endPerformanceCounter(o),Ve.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(s),this._parent._setState(St.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},c=>{this._parent.onErrorObservable.notifyObservers(c),this._parent.onErrorObservable.clear(),this.dispose()})}),u))}).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&Me.Warn(`Binary buffer length (${n.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else Me.Warn("Unexpected BIN chunk")}}_setupData(){if(pe.Assign(this._gltf.accessors),pe.Assign(this._gltf.animations),pe.Assign(this._gltf.buffers),pe.Assign(this._gltf.bufferViews),pe.Assign(this._gltf.cameras),pe.Assign(this._gltf.images),pe.Assign(this._gltf.materials),pe.Assign(this._gltf.meshes),pe.Assign(this._gltf.nodes),pe.Assign(this._gltf.samplers),pe.Assign(this._gltf.scenes),pe.Assign(this._gltf.skins),pe.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const n of this._gltf.nodes)if(n.children)for(const r of n.children)e[r]=n.index;const t=this._createRootNode();for(const n of this._gltf.nodes){const r=e[n.index];n.parent=r===void 0?t:this._gltf.nodes[r]}}}async _loadExtensionsAsync(){const e=[];if(Li.forEach((t,n)=>{this.parent.extensionOptions[n]?.enabled===!1?t.isGLTFExtension&&this.isExtensionUsed(n)&&Me.Warn(`Extension ${n} is used but has been explicitly disabled.`):(!t.isGLTFExtension||this.isExtensionUsed(n))&&e.push((async()=>{const r=await t.factory(this);return r.name!==n&&Me.Warn(`The name of the glTF loader extension instance does not match the registered name: ${r.name} !== ${n}`),this._parent.onExtensionLoadedObservable.notifyObservers(r),r})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((t,n)=>(t.order||Number.MAX_VALUE)-(n.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(const t of this._gltf.extensionsRequired)if(!this._extensions.some(r=>r.name===t&&r.enabled))throw this.parent.extensionOptions[t]?.enabled===!1?new Error(`Required extension ${t} is disabled`):new Error(`Required extension ${t} is not available`)}}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new ot("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Gn.AUTO:{this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],be._LoadTransform(t,this._rootBabylonMesh));break}case Gn.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const n=this._extensionsLoadSceneAsync(e,t);if(n)return n;const r=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const o of t.nodes){const s=pe.Get(`${e}/nodes/${o}`,this._gltf.nodes,o);r.push(this.loadNodeAsync(`/nodes/${s.index}`,s,i=>{i.parent=this._rootBabylonMesh}))}for(const o of this._postSceneLoadActions)o();return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const n of e._primitiveBabylonMeshes)t(n)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,r=>{const o=r.geometry;o&&e.indexOf(o)===-1&&e.push(o)});return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof Qo&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,r=>{e.push(r)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)n._babylonTransformNode&&n._babylonTransformNode.getClassName()==="TransformNode"&&e.push(n._babylonTransformNode),n._babylonTransformNodeForSkin&&e.push(n._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const n of t)n._data&&e.push(n._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const n of t)n._babylonAnimationGroup&&e.push(n._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case In.NONE:break;case In.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case In.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{Me.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,n=()=>{}){const r=this._extensionsLoadNodeAsync(e,t,n);if(r)return r;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const o=new Array;this.logOpen(`${e} ${t.name||""}`);const s=h=>{if(be.AddPointerMetadata(h,e),be._LoadTransform(t,h),t.camera!=null){const u=pe.Get(`${e}/camera`,this._gltf.cameras,t.camera);o.push(this.loadCameraAsync(`/cameras/${u.index}`,u,c=>{c.parent=h,this._babylonScene.useRightHandedSystem||(h.scaling.x=-1)}))}if(t.children)for(const u of t.children){const c=pe.Get(`${e}/children/${u}`,this._gltf.nodes,u);o.push(this.loadNodeAsync(`/nodes/${c.index}`,c,d=>{d.parent=h}))}n(h)},i=t.mesh!=null,l=this._parent.loadSkins&&t.skin!=null;if(!i||l){const h=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u=new Pn(h,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=u:t._babylonTransformNodeForSkin=u,s(u)}if(i)if(l){const h=pe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${h.index}`,t,h,u=>{const c=t._babylonTransformNodeForSkin;u.metadata=Nr(c.metadata,u.metadata||{});const d=pe.Get(`${e}/skin`,this._gltf.skins,t.skin);o.push(this._loadSkinAsync(`/skins/${d.index}`,t,d,p=>{this._forEachPrimitive(t,f=>{f.skeleton=p}),this._postSceneLoadActions.push(()=>{if(d.skeleton!=null){const f=pe.Get(`/skins/${d.index}/skeleton`,this._gltf.nodes,d.skeleton).parent;t.index===f.index?u.parent=c.parent:u.parent=f._babylonTransformNode}else u.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:c,skinnedNode:u})})}))}))}else{const h=pe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${h.index}`,t,h,s))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(t,h=>{const u=h;!u.isAnInstance&&u.geometry&&u.geometry.useBoundingInfoFromGeometry?h._updateBoundingInfo():h.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,n,r){const o=n.primitives;if(!o||!o.length)throw new Error(`${e}: Primitives are missing`);o[0].index==null&&pe.Assign(o);const s=new Array;this.logOpen(`${e} ${n.name||""}`);const i=t.name||`node${t.index}`;if(o.length===1){const l=n.primitives[0];s.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,i,t,n,l,h=>{t._babylonTransformNode=h,t._primitiveBabylonMeshes=[h]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new Pn(i,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of o)s.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${i}_primitive${l.index}`,t,n,l,h=>{h.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(h)}))}return r(t._babylonTransformNode),this.logClose(),Promise.all(s).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,n,r,o,s){const i=this._extensionsLoadMeshPrimitiveAsync(e,t,n,r,o,s);if(i)return i;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&n.skin==null&&!r.primitives[0].targets;let h,u;if(l&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,h=o._instanceData.babylonSourceMesh.createInstance(t),h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u=o._instanceData.promise;else{const c=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new ot(t,this._babylonScene);if(d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.sideOrientation=this._babylonScene.useRightHandedSystem?Rt.CounterClockWiseSideOrientation:Rt.ClockWiseSideOrientation,this._createMorphTargets(e,n,r,o,d),c.push(this._loadVertexDataAsync(e,o,d).then(async p=>await this._loadMorphTargetsAsync(e,o,d,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(d),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)}))),!this.parent.skipMaterials){const p=be._GetDrawMode(e,o.mode);if(o.material==null){let f=this._defaultBabylonMaterialData[p];f||(f=this._createDefaultMaterial("__GLTFLoader._default",p),this._parent.onMaterialLoadedObservable.notifyObservers(f),this._defaultBabylonMaterialData[p]=f),d.material=f}else{const f=pe.Get(`${e}/material`,this._gltf.materials,o.material);c.push(this._loadMaterialAsync(`/materials/${f.index}`,f,d,p,g=>{d.material=g}))}}u=Promise.all(c),l&&(o._instanceData={babylonSourceMesh:d,promise:u}),h=d}return be.AddPointerMetadata(h,e),this._parent.onMeshLoadedObservable.notifyObservers(h),s(h),this.logClose(),u.then(()=>h)}_loadVertexDataAsync(e,t,n){const r=this._extensionsLoadVertexDataAsync(e,t,n);if(r)return r;const o=t.attributes;if(!o)throw new Error(`${e}: Attributes are missing`);const s=new Array,i=new Jn(n.name,this._babylonScene);if(t.indices==null)n.isUnIndexed=!0;else{const h=pe.Get(`${e}/indices`,this._gltf.accessors,t.indices);s.push(this._loadIndicesAccessorAsync(`/accessors/${h.index}`,h).then(u=>{i.setIndices(u)}))}const l=(h,u,c)=>{if(o[h]==null)return;n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(u)===-1&&n._delayInfo.push(u);const d=pe.Get(`${e}/attributes/${h}`,this._gltf.accessors,o[h]);s.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,u).then(p=>{if(p.getKind()===Be.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!n.skeleton){const f=gr(d);f&&(i._boundingInfo=f,i.useBoundingInfoFromGeometry=!0)}i.setVerticesBuffer(p,d.count)})),u==Be.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),c&&c(d)};return l("POSITION",Be.PositionKind),l("NORMAL",Be.NormalKind),l("TANGENT",Be.TangentKind),l("TEXCOORD_0",Be.UVKind),l("TEXCOORD_1",Be.UV2Kind),l("TEXCOORD_2",Be.UV3Kind),l("TEXCOORD_3",Be.UV4Kind),l("TEXCOORD_4",Be.UV5Kind),l("TEXCOORD_5",Be.UV6Kind),l("JOINTS_0",Be.MatricesIndicesKind),l("WEIGHTS_0",Be.MatricesWeightsKind),l("JOINTS_1",Be.MatricesIndicesExtraKind),l("WEIGHTS_1",Be.MatricesWeightsExtraKind),l("COLOR_0",Be.ColorKind,h=>{h.type==="VEC4"&&(n.hasVertexAlpha=!0)}),Promise.all(s).then(()=>i)}_createMorphTargets(e,t,n,r,o){if(!r.targets||!this._parent.loadMorphTargets)return;if(t._numMorphTargets==null)t._numMorphTargets=r.targets.length;else if(r.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const s=n.extras?n.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new Or(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let i=0;i<r.targets.length;i++){const l=t.weights?t.weights[i]:n.weights?n.weights[i]:0,h=s?s[i]:`morphTarget${i}`;o.morphTargetManager.addTarget(new Rr(h,l,o.getScene()))}}_loadMorphTargetsAsync(e,t,n,r){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const o=new Array,s=n.morphTargetManager;for(let i=0;i<s.numTargets;i++){const l=s.getTarget(i);o.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${i}`,r,t.targets[i],l))}return Promise.all(o).then(()=>{s.areUpdatesFrozen=!1})}async _loadMorphTargetVertexDataAsync(e,t,n,r){const o=new Array,s=(i,l,h)=>{if(n[i]==null)return;const u=t.getVertexBuffer(l);if(!u)return;const c=pe.Get(`${e}/${i}`,this._gltf.accessors,n[i]);o.push(this._loadFloatAccessorAsync(`/accessors/${c.index}`,c).then(d=>{h(u,d)}))};return s("POSITION",Be.PositionKind,(i,l)=>{const h=new Float32Array(l.length);i.forEach(l.length,(u,c)=>{h[c]=l[c]+u}),r.setPositions(h)}),s("NORMAL",Be.NormalKind,(i,l)=>{const h=new Float32Array(l.length);i.forEach(h.length,(u,c)=>{h[c]=l[c]+u}),r.setNormals(h)}),s("TANGENT",Be.TangentKind,(i,l)=>{const h=new Float32Array(l.length/3*4);let u=0;i.forEach(l.length/3*4,(c,d)=>{(d+1)%4!==0&&(h[u]=l[u]+c,u++)}),r.setTangents(h)}),s("TEXCOORD_0",Be.UVKind,(i,l)=>{const h=new Float32Array(l.length);i.forEach(l.length,(u,c)=>{h[c]=l[c]+u}),r.setUVs(h)}),s("TEXCOORD_1",Be.UV2Kind,(i,l)=>{const h=new Float32Array(l.length);i.forEach(l.length,(u,c)=>{h[c]=l[c]+u}),r.setUV2s(h)}),s("COLOR_0",Be.ColorKind,(i,l)=>{let h=null;const u=i.getSize();if(u===3){h=new Float32Array(l.length/3*4),i.forEach(l.length,(c,d)=>{const p=Math.floor(d/3),f=d%3;h[4*p+f]=l[3*p+f]+c});for(let c=0;c<l.length/3;++c)h[4*c+3]=1}else if(u===4)h=new Float32Array(l.length),i.forEach(l.length,(c,d)=>{h[d]=l[d]+c});else throw new Error(`${e}: Invalid number of components (${u}) for COLOR_0 attribute`);r.setColors(h)}),await Promise.all(o).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let n=K.Zero(),r=at.Identity(),o=K.One();e.matrix?it.FromArray(e.matrix).decompose(o,r,n):(e.translation&&(n=K.FromArray(e.translation)),e.rotation&&(r=at.FromArray(e.rotation)),e.scale&&(o=K.FromArray(e.scale))),t.position=n,t.rotationQuaternion=r,t.scaling=o}_loadSkinAsync(e,t,n,r){if(!this._parent.loadSkins)return Promise.resolve();const o=this._extensionsLoadSkinAsync(e,t,n);if(o)return o;if(n._data)return r(n._data.babylonSkeleton),n._data.promise;const s=`skeleton${n.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new Fs(n.name||s,s,this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,n,i);const l=this._loadSkinInverseBindMatricesDataAsync(e,n).then(h=>{this._updateBoneMatrices(i,h)});return n._data={babylonSkeleton:i,promise:l},r(i),l}_loadBones(e,t,n){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const o=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(o)if(t.skeleton===void 0)t.skeleton=o.index;else{const s=(l,h)=>{for(;h.parent;h=h.parent)if(h.parent===l)return!0;return!1},i=pe.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);i!==o&&!s(i,o)&&(Me.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=o.index)}else Me.Warn(`${e}: Failed to find common root`)}const r={};for(const o of t.joints){const s=pe.Get(`${e}/joints/${o}`,this._gltf.nodes,o);this._loadBone(s,t,n,r)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const n={};for(const o of t){const s=[];let i=pe.Get(`${e}/${o}`,this._gltf.nodes,o);for(;i.index!==-1;)s.unshift(i),i=i.parent;n[o]=s}let r=null;for(let o=0;;++o){let s=n[t[0]];if(o>=s.length)return r;const i=s[o];for(let l=1;l<t.length;++l)if(s=n[t[l]],o>=s.length||i!==s[o])return r;r=i}}_loadBone(e,t,n,r){e._isJoint=!0;let o=r[e.index];if(o)return o;let s=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?s=this._loadBone(e.parent,t,n,r):t.skeleton!==void 0&&Me.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const i=t.joints.indexOf(e.index);return o=new Rn(e.name||`joint${e.index}`,n,s,this._getNodeMatrix(e),null,null,i),r[e.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(e._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const n=pe.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)}_updateBoneMatrices(e,t){for(const n of e.bones){const r=it.Identity(),o=n._index;t&&o!==-1&&(it.FromArrayToRef(t,o*16,r),r.invertToRef(r));const s=n.getParent();s&&r.multiplyToRef(s.getAbsoluteInverseBindMatrix(),r),n.updateMatrix(r,!1,!1),n._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?it.FromArray(e.matrix):it.Compose(e.scale?K.FromArray(e.scale):K.One(),e.rotation?at.FromArray(e.rotation):at.Identity(),e.translation?K.FromArray(e.translation):K.Zero())}loadCameraAsync(e,t,n=()=>{}){const r=this._extensionsLoadCameraAsync(e,t,n);if(r)return r;const o=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new qs(t.name||`camera${t.index}`,K.Zero(),this._babylonScene,!1);switch(s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonCamera=s,s.setTarget(new K(0,0,-1)),t.type){case"perspective":{const i=t.perspective;if(!i)throw new Error(`${e}: Camera perspective properties are missing`);s.fov=i.yfov,s.minZ=i.znear,s.maxZ=i.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);s.mode=Jo.ORTHOGRAPHIC_CAMERA,s.orthoLeft=-t.orthographic.xmag,s.orthoRight=t.orthographic.xmag,s.orthoBottom=-t.orthographic.ymag,s.orthoTop=t.orthographic.ymag,s.minZ=t.orthographic.znear,s.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return be.AddPointerMetadata(s,e),this._parent.onCameraLoadedObservable.notifyObservers(s),n(s),this.logClose(),Promise.all(o).then(()=>s)}_loadAnimationsAsync(){this._parent._startPerformanceCounter("Load animations");const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let n=0;n<e.length;n++){const r=e[n];t.push(this.loadAnimationAsync(`/animations/${r.index}`,r).then(o=>{o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Load animations")})}loadAnimationAsync(e,t){this._parent._startPerformanceCounter("Load animation");const n=this._extensionsLoadAnimationAsync(e,t);return n||Wi.value.then(({AnimationGroup:r})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new r(t.name||`animation${t.index}`,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=o;const s=new Array;pe.Assign(t.channels),pe.Assign(t.samplers);for(const i of t.channels)s.push(this._loadAnimationChannelAsync(`${e}/channels/${i.index}`,e,t,i,(l,h)=>{l.animations=l.animations||[],l.animations.push(h),o.addTargetedAnimation(h,l)}));return this._parent._endPerformanceCounter("Load animation"),Promise.all(s).then(()=>(o.normalize(0),o))})}_loadAnimationChannelAsync(e,t,n,r,o){const s=this._extensionsLoadAnimationChannelAsync(e,t,n,r,o);if(s)return s;if(r.target.node==null)return Promise.resolve();const i=pe.Get(`${e}/target/node`,this._gltf.nodes,r.target.node),l=r.target.path,h=l==="weights";return h&&!i._numMorphTargets||!h&&!i._babylonTransformNode||!this._parent.loadNodeAnimations&&!h&&!i._isJoint?Promise.resolve():qi.value.then(()=>{let u;switch(l){case"translation":{u=jn("/nodes/{}/translation")?.interpolation;break}case"rotation":{u=jn("/nodes/{}/rotation")?.interpolation;break}case"scale":{u=jn("/nodes/{}/scale")?.interpolation;break}case"weights":{u=jn("/nodes/{}/weights")?.interpolation;break}default:throw new Error(`${e}/target/path: Invalid value (${r.target.path})`)}if(!u)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${r.target.path})`);const c={object:i,info:u};return this._loadAnimationChannelFromTargetInfoAsync(e,t,n,r,c,o)})}_loadAnimationChannelFromTargetInfoAsync(e,t,n,r,o,s){const i=this.parent.targetFps,l=1/i,h=pe.Get(`${e}/sampler`,n.samplers,r.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${r.sampler}`,h).then(u=>{let c=0;const d=o.object,p=o.info;for(const f of p){const g=f.getStride(d),y=u.input,m=u.output,_=new Array(y.length);let b=0;switch(u.interpolation){case"STEP":{for(let v=0;v<y.length;v++){const w=f.getValue(d,m,b,1);b+=g,_[v]={frame:y[v]*i,value:w,interpolation:1}}break}case"CUBICSPLINE":{for(let v=0;v<y.length;v++){const w=f.getValue(d,m,b,l);b+=g;const I=f.getValue(d,m,b,1);b+=g;const F=f.getValue(d,m,b,l);b+=g,_[v]={frame:y[v]*i,inTangent:w,value:I,outTangent:F}}break}case"LINEAR":{for(let v=0;v<y.length;v++){const w=f.getValue(d,m,b,1);b+=g,_[v]={frame:y[v]*i,value:w}}break}}if(b>0){const v=`${n.name||`animation${n.index}`}_channel${r.index}_${c}`,w=f.buildAnimations(d,v,i,_);for(const I of w)c++,s(I.babylonAnimatable,I.babylonAnimation)}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const r=pe.Get(`${e}/input`,this._gltf.accessors,t.input),o=pe.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${r.index}`,r),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([s,i])=>({input:s,interpolation:n,output:i})),t._data}loadBufferAsync(e,t,n,r){const o=this._extensionsLoadBufferAsync(e,t,n,r);if(o)return o;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(s=>{try{return new Uint8Array(s.buffer,s.byteOffset+n,r)}catch(i){throw new Error(`${e}: ${i.message}`)}})}loadBufferViewAsync(e,t){const n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;const r=pe.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${r.index}`,r,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,n){if(t._data)return t._data;const r=be._GetNumComponents(e,t.type),o=r*Be.GetTypeByteLength(t.componentType),s=r*t.count;if(t.bufferView==null)t._data=Promise.resolve(new n(s));else{const i=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(l=>{if(t.componentType===5126&&!t.normalized&&(!i.byteStride||i.byteStride===o))return be._GetTypedArray(e,t.componentType,l,t.byteOffset,s);{const h=new n(s);return Be.ForEach(l,t.byteOffset||0,i.byteStride||o,r,t.componentType,h.length,t.normalized||!1,(u,c)=>{h[c]=u}),h}})}if(t.sparse){const i=t.sparse;t._data=t._data.then(l=>{const h=l,u=pe.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,i.indices.bufferView),c=pe.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,i.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${u.index}`,u),this.loadBufferViewAsync(`/bufferViews/${c.index}`,c)]).then(([d,p])=>{const f=be._GetTypedArray(`${e}/sparse/indices`,i.indices.componentType,d,i.indices.byteOffset,i.count),g=r*i.count;let y;if(t.componentType===5126&&!t.normalized)y=be._GetTypedArray(`${e}/sparse/values`,t.componentType,p,i.values.byteOffset,g);else{const _=be._GetTypedArray(`${e}/sparse/values`,t.componentType,p,i.values.byteOffset,g);y=new n(g),Be.ForEach(_,0,o,r,t.componentType,y.length,t.normalized||!1,(b,v)=>{y[v]=b})}let m=0;for(let _=0;_<f.length;_++){let b=f[_]*r;for(let v=0;v<r;v++)h[b++]=y[m++]}return h})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const n=be._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,n)}else{const n=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n).then(r=>be._GetTypedArray(e,t.componentType,r,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(n=>new Fr(t,n,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,n){if(t._babylonVertexBuffer?.[n])return t._babylonVertexBuffer[n];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse||t.bufferView==null)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then(o=>new Be(r,o,n,!1));else{const o=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(o).then(s=>{const i=be._GetNumComponents(e,t.type);return new Be(r,s,n,!1,void 0,o.byteStride,void 0,t.byteOffset,i,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[n]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,n){const r=new Array,o=this._getOrCreateMaterialAdapter(n);return t&&(t.baseColorFactor?(o.baseColor=q.FromArray(t.baseColorFactor),o.geometryOpacity=t.baseColorFactor[3]):o.baseColor=q.White(),o.baseMetalness=t.metallicFactor==null?1:t.metallicFactor,o.specularRoughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&r.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,s=>{s.name=`${n.name} (Base Color)`,o.baseColorTexture=s})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,s=>{s.name=`${n.name} (Metallic Roughness)`,o.baseMetalnessTexture=s,o.specularRoughnessTexture=s})),o.useRoughnessFromMetallicTextureGreen=!0,o.useMetallicFromMetallicTextureBlue=!0)),Promise.all(r).then(()=>{})}_loadMaterialAsync(e,t,n,r,o=()=>{}){const s=this._extensionsLoadMaterialAsync(e,t,n,r,o);if(s)return s;t._data=t._data||{};let i=t._data[r];if(!i){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,r);i={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[r]=i,be.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return n&&(i.babylonMeshes.push(n),n.onDisposeObservable.addOnce(()=>{const l=i.babylonMeshes.indexOf(n);l!==-1&&i.babylonMeshes.splice(l,1)})),o(i.babylonMaterial),i.promise.then(()=>i.babylonMaterial)}_createDefaultMaterial(e,t){if(!this._pbrMaterialImpl)throw new Error("PBR Material class not loaded");this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new this._pbrMaterialImpl.materialClass(e,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE;const r=this._getOrCreateMaterialAdapter(n);return r.transparencyAsAlphaCoverage=this._parent.transparencyAsCoverage,r.baseMetalness=1,r.specularRoughness=1,n}createMaterial(e,t,n){const r=this._extensionsCreateMaterial(e,t,n);if(r)return r;const o=t.name||`material${t.index}`;return this._createDefaultMaterial(o,n)}loadMaterialPropertiesAsync(e,t,n){const r=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(r)return r;const o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,n){const r=new Array,o=this._getOrCreateMaterialAdapter(n);o.emissionColor=t.emissiveFactor?q.FromArray(t.emissiveFactor):new q(0,0,0),t.doubleSided&&(o.backFaceCulling=!1,o.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,h=>{h.name=`${n.name} (Normal)`,o.geometryNormalTexture=h,t.normalTexture?.scale!=null&&(h.level=t.normalTexture.scale)})),o.setNormalMapInversions(!this._babylonScene.useRightHandedSystem,this._babylonScene.useRightHandedSystem));let s,i=1,l;return t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,h=>{h.name=`${n.name} (Occlusion)`,s=h})),t.occlusionTexture.strength!=null&&(i=t.occlusionTexture.strength)),t.emissiveTexture&&r.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,h=>{h.name=`${n.name} (Emissive)`,l=h})),Promise.all(r).then(()=>{s&&(o.ambientOcclusionTexture=s,o.ambientOcclusionTextureStrength=i),l&&(o.emissionColorTexture=l)})}loadMaterialAlphaProperties(e,t,n){if(!this._pbrMaterialImpl)throw new Error(`${e}: Material type not supported`);const r=this._getOrCreateMaterialAdapter(n),o=r.baseColorTexture;switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE,n.alpha=1;break}case"MASK":{n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHATEST,r.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,o&&(o.hasAlpha=!0);break}case"BLEND":{n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHABLEND,o&&(o.hasAlpha=!0,r.useAlphaFromBaseColorTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,n=()=>{}){const r=this._extensionsLoadTextureInfoAsync(e,t,n);if(r)return r;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const o=pe.Get(`${e}/index`,this._gltf.textures,t.index);o._textureInfo=t;const s=this._loadTextureAsync(`/textures/${t.index}`,o,i=>{i.coordinatesIndex=t.texCoord||0,be.AddPointerMetadata(i,e),this._parent.onTextureLoadedObservable.notifyObservers(i),n(i)});return this.logClose(),s}_loadTextureAsync(e,t,n=()=>{}){const r=this._extensionsLoadTextureAsync(e,t,n);if(r)return r;this.logOpen(`${e} ${t.name||""}`);const o=t.sampler==null?be.DefaultSampler:pe.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),s=pe.Get(`${e}/source`,this._gltf.images,t.source),i=this._createTextureAsync(e,o,s,n,void 0,!t._textureInfo.nonColorData);return this.logClose(),i}_createTextureAsync(e,t,n,r=()=>{},o,s){const i=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,h=new Fn;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u={noMipmap:i.noMipMaps,invertY:!1,samplingMode:i.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(d,p)=>{this._disposed||h.reject(new Error(`${e}: ${p&&p.message?p.message:d||"Failed to load texture"}`))},mimeType:n.mimeType??Lr(n.uri??""),loaderOptions:o,useSRGBBuffer:!!s&&this._parent.useSRGBBuffers},c=new qe(null,this._babylonScene,u);return c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(h.promise),l.push(this.loadImageAsync(`/images/${n.index}`,n).then(d=>{const p=n.uri||`${this._fileName}#image${n.index}`,f=`data:${this._uniqueRootUrl}${p}`;c.updateURL(f,d);const g=c.getInternalTexture();g&&(g.label=n.name)})),c.wrapU=i.wrapU,c.wrapV=i.wrapV,r(c),this._parent.useGltfTextureNames&&(c.name=n.name||n.uri||`image${n.index}`),Promise.all(l).then(()=>c)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:be._GetTextureSamplingMode(e,t),wrapU:be._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:be._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const n=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}this.logClose()}return t._data}loadUriAsync(e,t,n){const r=this._extensionsLoadUriAsync(e,t,n);if(r)return r;if(!be._ValidateUri(n))throw new Error(`${e}: '${n}' is invalid`);if(kr(n)){const o=new Uint8Array(Yo(n));return this.log(`${e}: Decoded ${n.substring(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${e}: Loading ${n}`),this._parent.preprocessUrlAsync(this._rootUrl+n).then(o=>new Promise((s,i)=>{this._parent._loadFile(this._babylonScene,o,l=>{this._disposed||(this.log(`${e}: Loaded ${n} (${l.byteLength} bytes)`),s(new Uint8Array(l)))},!0,l=>{i(new Vr(`${e}: Failed to load '${n}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const n=e._internalMetadata=e._internalMetadata||{},r=n.gltf=n.gltf||{};(r.pointers=r.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return qe.CLAMP_ADDRESSMODE;case 33648:return qe.MIRROR_ADDRESSMODE;case 10497:return qe.WRAP_ADDRESSMODE;default:return Me.Warn(`${e}: Invalid value (${t})`),qe.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const n=t.magFilter==null?9729:t.magFilter,r=t.minFilter==null?9987:t.minFilter;if(n===9729)switch(r){case 9728:return qe.LINEAR_NEAREST;case 9729:return qe.LINEAR_LINEAR;case 9984:return qe.LINEAR_NEAREST_MIPNEAREST;case 9985:return qe.LINEAR_LINEAR_MIPNEAREST;case 9986:return qe.LINEAR_NEAREST_MIPLINEAR;case 9987:return qe.LINEAR_LINEAR_MIPLINEAR;default:return Me.Warn(`${e}/minFilter: Invalid value (${r})`),qe.LINEAR_LINEAR_MIPLINEAR}else switch(n!==9728&&Me.Warn(`${e}/magFilter: Invalid value (${n})`),r){case 9728:return qe.NEAREST_NEAREST;case 9729:return qe.NEAREST_LINEAR;case 9984:return qe.NEAREST_NEAREST_MIPNEAREST;case 9985:return qe.NEAREST_LINEAR_MIPNEAREST;case 9986:return qe.NEAREST_NEAREST_MIPLINEAR;case 9987:return qe.NEAREST_LINEAR_MIPLINEAR;default:return Me.Warn(`${e}/minFilter: Invalid value (${r})`),qe.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return Gr(t)}catch(n){throw new Error(`${e}: ${n.message}`)}}static _GetTypedArray(e,t,n,r,o){const s=n.buffer;r=n.byteOffset+(r||0);const i=be._GetTypedArrayConstructor(`${e}/componentType`,t),l=Be.GetTypeByteLength(t);return r%l!==0?(Me.Warn(`${e}: Copying buffer as byte offset (${r}) is not a multiple of component type byte length (${l})`),new i(s.slice(r,r+o*l),0)):new i(s,r,o)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return Ve.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return Rt.PointListDrawMode;case 1:return Rt.LineListDrawMode;case 2:return Rt.LineLoopDrawMode;case 3:return Rt.LineStripDrawMode;case 4:return Rt.TriangleFillMode;case 5:return Rt.TriangleStripDrawMode;case 6:return Rt.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const n in t._data){const r=t._data[n];for(const o of r.babylonMeshes){o.computeWorldMatrix(!0);const s=r.babylonMaterial;e.push(s.forceCompilationAsync(o)),e.push(s.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(e.push(s.forceCompilationAsync(o,{clipPlane:!0})),e.push(s.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const n of t){const r=n.getShadowGenerator();r&&e.push(r.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,n){for(const r of this._extensions)if(r.enabled){const o=`${r.name}.${t}`,s=e;s._activeLoaderExtensionFunctions=s._activeLoaderExtensionFunctions||{};const i=s._activeLoaderExtensionFunctions;if(!i[o]){i[o]=!0;try{const l=n(r);if(l)return l}finally{delete i[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",n=>n.loadSceneAsync&&n.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,n){return this._applyExtensions(t,"loadNode",r=>r.loadNodeAsync&&r.loadNodeAsync(e,t,n))}_extensionsLoadCameraAsync(e,t,n){return this._applyExtensions(t,"loadCamera",r=>r.loadCameraAsync&&r.loadCameraAsync(e,t,n))}_extensionsLoadVertexDataAsync(e,t,n){return this._applyExtensions(t,"loadVertexData",r=>r._loadVertexDataAsync&&r._loadVertexDataAsync(e,t,n))}_extensionsLoadMeshPrimitiveAsync(e,t,n,r,o,s){return this._applyExtensions(o,"loadMeshPrimitive",i=>i._loadMeshPrimitiveAsync&&i._loadMeshPrimitiveAsync(e,t,n,r,o,s))}_extensionsLoadMaterialAsync(e,t,n,r,o){return this._applyExtensions(t,"loadMaterial",s=>s._loadMaterialAsync&&s._loadMaterialAsync(e,t,n,r,o))}_extensionsCreateMaterial(e,t,n){return this._applyExtensions(t,"createMaterial",r=>r.createMaterial&&r.createMaterial(e,t,n))}_extensionsLoadMaterialPropertiesAsync(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",r=>r.loadMaterialPropertiesAsync&&r.loadMaterialPropertiesAsync(e,t,n))}_extensionsLoadTextureInfoAsync(e,t,n){return this._applyExtensions(t,"loadTextureInfo",r=>r.loadTextureInfoAsync&&r.loadTextureInfoAsync(e,t,n))}_extensionsLoadTextureAsync(e,t,n){return this._applyExtensions(t,"loadTexture",r=>r._loadTextureAsync&&r._loadTextureAsync(e,t,n))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",n=>n.loadAnimationAsync&&n.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,n,r,o){return this._applyExtensions(n,"loadAnimationChannel",s=>s._loadAnimationChannelAsync&&s._loadAnimationChannelAsync(e,t,n,r,o))}_extensionsLoadSkinAsync(e,t,n){return this._applyExtensions(n,"loadSkin",r=>r._loadSkinAsync&&r._loadSkinAsync(e,t,n))}_extensionsLoadUriAsync(e,t,n){return this._applyExtensions(t,"loadUri",r=>r._loadUriAsync&&r._loadUriAsync(e,t,n))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",n=>n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,n,r){return this._applyExtensions(t,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(e,t,n,r))}static LoadExtensionAsync(e,t,n,r){if(!t.extensions)return null;const s=t.extensions[n];return s?r(`${e}/extensions/${n}`,s):null}static LoadExtraAsync(e,t,n,r){if(!t.extras)return null;const s=t.extras[n];return s?r(`${e}/extras/${n}`,s):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}be.DefaultSampler={index:-1};pt._CreateGLTF2Loader=a=>new be(a);function so(a,e,t,n){return K.FromArray(e,t).scaleInPlace(n)}function vr(a,e,t,n){return at.FromArray(e,t).scaleInPlace(n)}function _r(a,e,t,n){const r=new Array(a._numMorphTargets);for(let o=0;o<r.length;o++)r[o]=e[t++]*n;return r}class Cn{constructor(e,t,n,r){this.type=e,this.name=t,this.getValue=n,this.getStride=r}_buildAnimation(e,t,n){const r=new ge(e,this.name,t,this.type);return r.setKeys(n,!0),r}}class Vs extends Cn{buildAnimations(e,t,n,r){const o=[];return o.push({babylonAnimatable:e._babylonTransformNode,babylonAnimation:this._buildAnimation(t,n,r)}),o}}class br extends Cn{buildAnimations(e,t,n,r){const o=[];if(e._numMorphTargets)for(let s=0;s<e._numMorphTargets;s++){const i=new ge(`${t}_${s}`,this.name,n,this.type);if(i.setKeys(r.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[s]:void 0,value:l.value[s],outTangent:l.outTangent?l.outTangent[s]:void 0,interpolation:l.interpolation})),!0),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const h=l.morphTargetManager.getTarget(s),u=i.clone();h.animations.push(u),o.push({babylonAnimatable:h,babylonAnimation:u})}}}return o}}Y("/nodes/{}/translation",[new Vs(ge.ANIMATIONTYPE_VECTOR3,"position",so,()=>3)]);Y("/nodes/{}/rotation",[new Vs(ge.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",vr,()=>4)]);Y("/nodes/{}/scale",[new Vs(ge.ANIMATIONTYPE_VECTOR3,"scaling",so,()=>3)]);Y("/nodes/{}/weights",[new br(ge.ANIMATIONTYPE_FLOAT,"influence",_r,a=>a._numMorphTargets)]);const Ki=Object.freeze(Object.defineProperty({__proto__:null,AnimationPropertyInfo:Cn,TransformNodeAnimationPropertyInfo:Vs,WeightAnimationPropertyInfo:br,getQuaternion:vr,getVector3:so,getWeights:_r},Symbol.toStringTag,{value:"Module"})),es="EXT_lights_image_based";class ji{constructor(e){this.name=es,this._loader=e,this.enabled=this._loader.isExtensionUsed(es)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return be.LoadExtensionAsync(e,t,this.name,async(n,r)=>{this._loader._allMaterialsDirtyRequired=!0;const o=new Array;o.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${n}`);const s=pe.Get(`${n}/light`,this._lights,r.light);return o.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,s).then(i=>{this._loader.babylonScene.environmentTexture=i})),this._loader.logClose(),await Promise.all(o).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const n=new Array;this._loader.logOpen(`${e}`);const r=new Array(t.specularImages.length);for(let o=0;o<t.specularImages.length;o++){const s=t.specularImages[o];r[o]=new Array(s.length);for(let i=0;i<s.length;i++){const l=`${e}/specularImages/${o}/${i}`;this._loader.logOpen(`${l}`);const h=s[i],u=pe.Get(l,this._loader.gltf.images,h);n.push(this._loader.loadImageAsync(`/images/${h}`,u).then(c=>{r[o][i]=c})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then(async()=>{const o=new $r(this._loader.babylonScene,null,t.specularImageSize);if(o.name=t.name||"environment",t._babylonTexture=o,t.intensity!=null&&(o.level=t.intensity),t.rotation){let h=at.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(h=at.Inverse(h)),it.FromQuaternionToRef(h,o.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const s=Hr.FromArray(t.irradianceCoefficients);s.scaleInPlace(t.intensity),s.convertIrradianceToLambertianRadiance();const i=zr.FromHarmonics(s),l=(r.length-1)/Math.log2(t.specularImageSize);return await o.updateRGBDAsync(r,i,l)})}return t._loaded.then(()=>t._babylonTexture)}}Oe(es);Fe(es,!0,a=>new ji(a));const ts="EXT_mesh_gpu_instancing";class Yi{constructor(e){this.name=ts,this._loader=e,this.enabled=this._loader.isExtensionUsed(ts)}dispose(){this._loader=null}loadNodeAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{this._loader._disableInstancedMesh++;const s=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,n);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return await s;const i=new Array;let l=0;const h=u=>{if(o.attributes[u]==null){i.push(Promise.resolve(null));return}const c=pe.Get(`${r}/attributes/${u}`,this._loader.gltf.accessors,o.attributes[u]);if(i.push(this._loader._loadFloatAccessorAsync(`/accessors/${c.bufferView}`,c)),l===0)l=c.count;else if(l!==c.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return h("TRANSLATION"),h("ROTATION"),h("SCALE"),h("_COLOR_0"),await s.then(async u=>{const[c,d,p,f]=await Promise.all(i),g=new Float32Array(l*16);Nt.Vector3[0].copyFromFloats(0,0,0),Nt.Quaternion[0].copyFromFloats(0,0,0,1),Nt.Vector3[1].copyFromFloats(1,1,1);for(let y=0;y<l;++y)c&&K.FromArrayToRef(c,y*3,Nt.Vector3[0]),d&&at.FromArrayToRef(d,y*4,Nt.Quaternion[0]),p&&K.FromArrayToRef(p,y*3,Nt.Vector3[1]),it.ComposeToRef(Nt.Vector3[1],Nt.Quaternion[0],Nt.Vector3[0],Nt.Matrix[0]),Nt.Matrix[0].copyToArray(g,y*16);for(const y of t._primitiveBabylonMeshes)y.thinInstanceSetBuffer("matrix",g,16,!0),f&&(f.length===l*3?y.thinInstanceSetBuffer("color",f,3,!0):f.length===l*4?y.thinInstanceSetBuffer("color",f,4,!0):Me.Warn("Unexpected size of _COLOR_0 attribute for mesh "+y.name));return u})})}}Oe(ts);Fe(ts,!0,a=>new Yi(a));const ns="EXT_meshopt_compression";class Xi{constructor(e){this.name=ns,this.enabled=e.isExtensionUsed(ns),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return be.LoadExtensionAsync(e,t,this.name,async(n,r)=>{const o=t;if(o._meshOptData)return await o._meshOptData;const s=pe.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return o._meshOptData=this._loader.loadBufferAsync(`/buffers/${s.index}`,s,r.byteOffset||0,r.byteLength).then(async i=>await Ur.Default.decodeGltfBufferAsync(i,r.count,r.byteStride,r.mode,r.filter)),await o._meshOptData})}}Oe(ns);Fe(ns,!0,a=>new Xi(a));const ss="EXT_texture_webp";class Qi{constructor(e){this.name=ss,this._loader=e,this.enabled=e.isExtensionUsed(ss)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=t.sampler==null?be.DefaultSampler:pe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=pe.Get(`${r}/source`,this._loader.gltf.images,o.source);return await this._loader._createTextureAsync(e,s,i,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}Oe(ss);Fe(ss,!0,a=>new Qi(a));const os="EXT_texture_avif";class Ji{constructor(e){this.name=os,this._loader=e,this.enabled=e.isExtensionUsed(os)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=t.sampler==null?be.DefaultSampler:pe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=pe.Get(`${r}/source`,this._loader.gltf.images,o.source);return await this._loader._createTextureAsync(e,s,i,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}Oe(os);Fe(os,!0,a=>new Ji(a));const rs="EXT_lights_ies";class Zi{constructor(e){this.name=rs,this._loader=e,this.enabled=this._loader.isExtensionUsed(rs)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,pe.Assign(this._lights)}}loadNodeAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{this._loader._allMaterialsDirtyRequired=!0;let s,i;const l=await this._loader.loadNodeAsync(e,t,u=>{i=pe.Get(r,this._lights,o.light);const c=i.name||u.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,s=new Ht(c,K.Zero(),K.Backward(),0,1,this._loader.babylonScene),s.angle=Math.PI/2,s.innerAngle=0,s._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,i._babylonLight=s,s.falloffType=eo.FALLOFF_GLTF,s.diffuse=o.color?q.FromArray(o.color):q.White(),s.intensity=o.multiplier||1,s.range=Number.MAX_VALUE,s.parent=u,this._loader._babylonLights.push(s),be.AddPointerMetadata(s,r),n(u)});let h;if(i.uri)h=await this._loader.loadUriAsync(e,i,i.uri);else{const u=pe.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,i.bufferView);h=await this._loader.loadBufferViewAsync(`/bufferViews/${u.index}`,u)}return s.iesProfileTexture=new qe(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,h,!0,void 0,void 0,void 0,void 0,".ies"),l})}}Oe(rs);Fe(rs,!0,a=>new Zi(a));const is="KHR_draco_mesh_compression";class ea{constructor(e){this.name=is,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=So.DefaultAvailable&&this._loader.isExtensionUsed(is)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);const s={},i={},l=(u,c)=>{const d=o.attributes[u];if(d!=null&&(n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(c)===-1&&n._delayInfo.push(c),s[c]=d,this.useNormalizedFlagFromAccessor)){const p=pe.TryGet(this._loader.gltf.accessors,t.attributes[u]);p&&(i[c]=p.normalized||!1)}};l("POSITION",Be.PositionKind),l("NORMAL",Be.NormalKind),l("TANGENT",Be.TangentKind),l("TEXCOORD_0",Be.UVKind),l("TEXCOORD_1",Be.UV2Kind),l("TEXCOORD_2",Be.UV3Kind),l("TEXCOORD_3",Be.UV4Kind),l("TEXCOORD_4",Be.UV5Kind),l("TEXCOORD_5",Be.UV6Kind),l("JOINTS_0",Be.MatricesIndicesKind),l("WEIGHTS_0",Be.MatricesWeightsKind),l("COLOR_0",Be.ColorKind);const h=pe.Get(r,this._loader.gltf.bufferViews,o.bufferView);return h._dracoBabylonGeometry||(h._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${h.index}`,h).then(async u=>{const c=this.dracoDecoder||So.Default,d=pe.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),p=!this._loader.parent.alwaysComputeBoundingBox&&!n.skeleton&&d?gr(d):null;return await c._decodeMeshToGeometryForGltfAsync(n.name,this._loader.babylonScene,u,s,i,p).catch(f=>{throw new Error(`${e}: ${f.message}`)})})),await h._dracoBabylonGeometry})}}Oe(is);Fe(is,!0,a=>new ea(a));const as="KHR_lights_punctual";class ta{constructor(e){this.name=as,this._loader=e,this.enabled=this._loader.isExtensionUsed(as)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,pe.Assign(this._lights)}}loadNodeAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(e,t,s=>{let i;const l=pe.Get(r,this._lights,o.light),h=l.name||s.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const u=new Ls(h,K.Backward(),this._loader.babylonScene);u.position.setAll(0),i=u;break}case"point":{i=new Zs(h,K.Zero(),this._loader.babylonScene);break}case"spot":{const u=new Ht(h,K.Zero(),K.Backward(),0,1,this._loader.babylonScene);u.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,u.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,i=u;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}i._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=i,i.falloffType=eo.FALLOFF_GLTF,i.diffuse=l.color?q.FromArray(l.color):q.White(),i.intensity=l.intensity==null?1:l.intensity,i.range=l.range==null?Number.MAX_VALUE:l.range,i.parent=s,this._loader._babylonLights.push(i),be.AddPointerMetadata(i,r),n(s)})))}}Oe(as);Fe(as,!0,a=>new ta(a));const ls="EXT_lights_area";class na{constructor(e){this.name=ls,this._loader=e,this.enabled=this._loader.isExtensionUsed(ls)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,pe.Assign(this._lights)}}loadNodeAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(e,t,s=>{let i;const l=pe.Get(r,this._lights,o.light),h=l.name||s.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer;const u=l.size!==void 0?l.size:1;switch(l.type){case"rect":{const d=l.rect?.aspect!==void 0?l.rect.aspect*u:u,p=u;i=new Bo(h,K.Zero(),d,p,this._loader.babylonScene);break}case"disk":{const d=Math.sqrt(u*u*.25*Math.PI);i=new Bo(h,K.Zero(),d,d,this._loader.babylonScene);break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid area light type (${l.type})`)}i._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=i,i.falloffType=eo.FALLOFF_GLTF,i.diffuse=l.color?q.FromArray(l.color):q.White(),i.intensity=l.intensity==null?1:l.intensity;const c=new Pn(`${h}_orientation`,this._loader.babylonScene);c.rotationQuaternion=at.RotationAxis(K.Up(),Math.PI),c.parent=s,i.parent=c,this._loader._babylonLights.push(i),be.AddPointerMetadata(i,r),n(s)})))}}Oe(ls);Fe(ls,!0,a=>new na(a));const cs="KHR_materials_pbrSpecularGlossiness";class sa{constructor(e){this.name=cs,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(cs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),s.push(this._loadSpecularGlossinessPropertiesAsync(r,o,n)),this._loader.loadMaterialAlphaProperties(e,t,n),await Promise.all(s).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,n){if(!(n instanceof Ne))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.metallic=null,n.roughness=null,t.diffuseFactor?(n.albedoColor=q.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=q.White(),n.reflectivityColor=t.specularFactor?q.FromArray(t.specularFactor):q.White(),n.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,o=>{o.name=`${n.name} (Diffuse)`,n.albedoTexture=o})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,o=>{o.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=o,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}}Oe(cs);Fe(cs,!0,a=>new sa(a));const us="KHR_materials_unlit";class oa{constructor(e){this.name=us,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(us)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async()=>await this._loadUnlitPropertiesAsync(e,t,n))}_loadUnlitPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array,s=t.pbrMetallicRoughness;return s&&(s.baseColorFactor&&(r.baseColor=q.FromArray(s.baseColorFactor),r.geometryOpacity=s.baseColorFactor[3]),s.baseColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,s.baseColorTexture,i=>{i.name=`${n.name} (Base Color)`,r.baseColorTexture=i}))),r.isUnlit=!0,t.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then(()=>{})}}Oe(us);Fe(us,!0,a=>new oa(a));const hs="KHR_materials_clearcoat";class ra{constructor(e){this.name=hs,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(hs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadClearCoatPropertiesAsync(r,o,n)),await Promise.all(s)})}_loadClearCoatPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.configureCoat(),r.coatWeight=t.clearcoatFactor!==void 0?t.clearcoatFactor:0,r.coatRoughness=t.clearcoatRoughnessFactor!==void 0?t.clearcoatRoughnessFactor:0,t.clearcoatTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,s=>{s.name=`${n.name} (ClearCoat)`,r.coatWeightTexture=s})),t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,s=>{s.name=`${n.name} (ClearCoat Roughness)`,r.coatRoughnessTexture=s}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,s=>{s.name=`${n.name} (ClearCoat Normal)`,r.geometryCoatNormalTexture=s,t.clearcoatNormalTexture?.scale!=null&&(r.geometryCoatNormalTextureScale=t.clearcoatNormalTexture.scale)})),r.setNormalMapInversions(!n.getScene().useRightHandedSystem,n.getScene().useRightHandedSystem)),Promise.all(o).then(()=>{})}}Oe(hs);Fe(hs,!0,a=>new ra(a));const ds="KHR_materials_coat";class ia{constructor(e){this.name=ds,this.order=191,this.useOpenPBR=!1,this._loader=e,this.enabled=this._loader.isExtensionUsed(ds)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),t.extensions&&t.extensions.KHR_materials_openpbr&&(this.useOpenPBR=!0),s.push(this._loadCoatPropertiesAsync(r,o,n)),await Promise.all(s)})}_loadCoatPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;r.configureCoat(),r.coatWeight=t.coatFactor!==void 0?t.coatFactor:0,r.coatRoughness=t.coatRoughnessFactor!==void 0?t.coatRoughnessFactor:0,t.coatTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/coatTexture`,t.coatTexture,h=>{h.name=`${n.name} (Coat)`,r.coatWeightTexture=h})),t.coatRoughnessTexture&&(t.coatRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/coatRoughnessTexture`,t.coatRoughnessTexture,h=>{h.name=`${n.name} (Coat Roughness)`,r.coatRoughnessTexture=h}))),t.coatNormalTexture&&(t.coatNormalTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/coatNormalTexture`,t.coatNormalTexture,h=>{h.name=`${n.name} (Coat Normal)`,r.geometryCoatNormalTexture=h,t.coatNormalTexture?.scale!=null&&(r.geometryCoatNormalTextureScale=t.coatNormalTexture.scale)})),r.setNormalMapInversions(!n.getScene().useRightHandedSystem,n.getScene().useRightHandedSystem)),r.coatDarkening=t.coatDarkeningFactor!==void 0?t.coatDarkeningFactor:1,r.coatIor=t.coatIor!==void 0?t.coatIor:1.5;const s=q.White();t.coatColorFactor!==void 0&&s.fromArray(t.coatColorFactor),r.coatColor=s,t.coatColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/coatColorTexture`,t.coatColorTexture,h=>{h.name=`${n.name} (Coat Color)`,r.coatColorTexture=h}));const i=t.coatAnisotropyStrength??0,l=t.coatAnisotropyRotation??0;return r.coatRoughnessAnisotropy=i,r.geometryCoatTangentAngle=l,this.useOpenPBR||r.configureGltfStyleAnisotropy(!0),t.coatAnisotropyTexture&&(t.coatAnisotropyTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/coatAnisotropyTexture`,t.coatAnisotropyTexture,h=>{h.name=`${n.name} (Coat Anisotropy)`,r.geometryCoatTangentTexture=h}))),Promise.all(o).then(()=>{})}}Oe(ds);Fe(ds,!0,a=>new ia(a));const ps="KHR_materials_iridescence";class aa{constructor(e){this.name=ps,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(ps)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadIridescencePropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.thinFilmWeight=t.iridescenceFactor??0,r.thinFilmIor=t.iridescenceIor??t.iridescenceIOR??1.3,r.thinFilmThicknessMinimum=t.iridescenceThicknessMinimum??100,r.thinFilmThicknessMaximum=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,s=>{s.name=`${n.name} (Iridescence)`,r.thinFilmWeightTexture=s})),t.iridescenceThicknessTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,s=>{s.name=`${n.name} (Iridescence Thickness)`,r.thinFilmThicknessTexture=s})),Promise.all(o).then(()=>{})}}Oe(ps);Fe(ps,!0,a=>new aa(a));const fs="KHR_materials_anisotropy";class la{constructor(e){this.name=fs,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(fs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadAnisotropyPropertiesAsync(r,o,n)),await Promise.all(s)})}async _loadAnisotropyPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array,s=t.anisotropyStrength??0,i=t.anisotropyRotation??0;r.specularRoughnessAnisotropy=s,r.geometryTangentAngle=i;const l=t.extensions??{};(!l.EXT_materials_anisotropy_openpbr||!l.EXT_materials_anisotropy_openpbr.openPbrAnisotropyEnabled)&&r.configureGltfStyleAnisotropy(!0),t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,h=>{h.name=`${n.name} (Anisotropy Intensity)`,r.geometryTangentTexture=h}))),await Promise.all(o)}}Oe(fs);Fe(fs,!0,a=>new la(a));const ms="KHR_materials_emissive_strength";class ca{constructor(e){this.name=ms,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(ms)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>(await this._loader.loadMaterialPropertiesAsync(e,t,n),this._loadEmissiveProperties(r,o,n),await Promise.resolve()))}_loadEmissiveProperties(e,t,n){if(t.emissiveStrength!==void 0){const r=this._loader._getOrCreateMaterialAdapter(n);r.emissionLuminance=t.emissiveStrength}}}Oe(ms);Fe(ms,!0,a=>new ca(a));const ys="KHR_materials_sheen";class ua{constructor(e){this.name=ys,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ys)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadSheenPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadSheenPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;r.configureFuzz();const s=t.sheenColorFactor!==void 0?q.FromArray(t.sheenColorFactor):q.Black(),i=t.sheenRoughnessFactor!==void 0?t.sheenRoughnessFactor:0;return r.fuzzWeight=1,r.fuzzColor=s,r.fuzzRoughness=i,t.sheenColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,l=>{l.name=`${n.name} (Sheen Color)`,r.fuzzColorTexture=l})),t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,l=>{l.name=`${n.name} (Sheen Roughness)`,r.fuzzRoughnessTexture=l}))),Promise.all(o).then(()=>{})}}Oe(ys);Fe(ys,!0,a=>new ua(a));const gs="KHR_materials_fuzz";class ha{constructor(e){this.name=gs,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(gs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadFuzzPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadFuzzPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.configureFuzz(),r.fuzzWeight=t.fuzzFactor!==void 0?t.fuzzFactor:0,r.fuzzColor=t.fuzzColorFactor!==void 0?q.FromArray(t.fuzzColorFactor):q.White(),r.fuzzRoughness=t.fuzzRoughnessFactor!==void 0?t.fuzzRoughnessFactor:.5,t.fuzzTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/fuzzTexture`,t.fuzzTexture,s=>{s.name=`${n.name} (Fuzz)`,r.fuzzWeightTexture=s})),t.fuzzColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/fuzzColorTexture`,t.fuzzColorTexture,s=>{s.name=`${n.name} (Fuzz Color)`,r.fuzzColorTexture=s})),t.fuzzRoughnessTexture&&(t.fuzzRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/fuzzRoughnessTexture`,t.fuzzRoughnessTexture,s=>{s.name=`${n.name} (Fuzz Roughness)`,r.fuzzRoughnessTexture=s}))),Promise.all(o).then(()=>{})}}Oe(gs);Fe(gs,!0,a=>new ha(a));const vs="KHR_materials_specular";class da{constructor(e){this.name=vs,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(vs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadSpecularPropertiesAsync(r,o,n));const i=this._loader._getOrCreateMaterialAdapter(n);return o.extensions&&o.extensions.EXT_materials_specular_edge_color&&o.extensions.EXT_materials_specular_edge_color.specularEdgeColorEnabled&&i.enableSpecularEdgeColor(!0),await Promise.all(s).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.specularWeight=t.specularFactor??1,r.specularColor=t.specularColorFactor!==void 0?q.FromArray(t.specularColorFactor):new q(1,1,1),t.specularTexture&&(t.specularTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,s=>{s.name=`${n.name} (Specular)`,r.specularWeightTexture=s}))),t.specularColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,s=>{s.name=`${n.name} (Specular Color)`,r.specularColorTexture=s})),Promise.all(o).then(()=>{})}}Oe(vs);Fe(vs,!0,a=>new da(a));const _s="KHR_materials_ior";class Gs{constructor(e){this.name=_s,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(_s)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadIorPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadIorPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=t.ior!==void 0?t.ior:Gs._DEFAULT_IOR;return r.specularIor=o,Promise.resolve()}}Gs._DEFAULT_IOR=1.5;Oe(_s);Fe(_s,!0,a=>new Gs(a));const vt="KHR_materials_variants";class Ot{constructor(e){this.name=vt,this._loader=e,this.enabled=this._loader.isExtensionUsed(vt)&&!this._loader.parent.skipMaterials}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return Ot.GetAvailableVariants(e)}static SelectVariant(e,t){const n=this._GetExtensionMetadata(e);if(!n)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${vt} extension`);const r=o=>{const s=n.variants[o];if(s)for(const i of s)i.mesh.material=i.material};if(t instanceof Array)for(const o of t)r(o);else r(t);n.lastSelected=t}selectVariant(e,t){Ot.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${vt} extension`);for(const n of t.original)n.mesh.material=n.material;t.lastSelected=null}reset(e){Ot.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${vt} extension`);return t.lastSelected}getLastSelectedVariant(e){return Ot.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){return e?._internalMetadata?.gltf?.[vt]||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}onReady(){const e=this._loader.rootBabylonMesh;if(e){const t=this._loader.parent.extensionOptions[vt];t?.defaultVariant&&Ot.SelectVariant(e,t.defaultVariant),t?.onLoaded?.({get variants(){return Ot.GetAvailableVariants(e)},get selectedVariant(){const n=Ot.GetLastSelectedVariant(e);return n?Array.isArray(n)?n[0]:n:Ot.GetAvailableVariants(e)[0]},set selectedVariant(n){Ot.SelectVariant(e,n)}})}}_loadMeshPrimitiveAsync(e,t,n,r,o,s){return be.LoadExtensionAsync(e,o,this.name,async(i,l)=>{const h=new Array;return h.push(this._loader._loadMeshPrimitiveAsync(e,t,n,r,o,u=>{if(s(u),u instanceof ot){const c=be._GetDrawMode(e,o.mode),d=this._loader.rootBabylonMesh,p=d?d._internalMetadata=d._internalMetadata||{}:{},f=p.gltf=p.gltf||{},g=f[vt]=f[vt]||{lastSelected:null,original:[],variants:{}};g.original.push({mesh:u,material:u.material});for(let y=0;y<l.mappings.length;++y){const m=l.mappings[y],_=pe.Get(`${i}/mappings/${y}/material`,this._loader.gltf.materials,m.material);h.push(this._loader._loadMaterialAsync(`#/materials/${m.material}`,_,u,c,b=>{for(let v=0;v<m.variants.length;++v){const w=m.variants[v],I=pe.Get(`/extensions/${vt}/variants/${w}`,this._variants,w);g.variants[I.name]=g.variants[I.name]||[],g.variants[I.name].push({mesh:u,material:b}),u.onClonedObservable.add(F=>{const M=F;let B=null,C=M;do{if(C=C.parent,!C)return;B=Ot._GetExtensionMetadata(C)}while(B===null);if(d&&B===Ot._GetExtensionMetadata(d)){C._internalMetadata={};for(const A in d._internalMetadata)C._internalMetadata[A]=d._internalMetadata[A];C._internalMetadata.gltf=[];for(const A in d._internalMetadata.gltf)C._internalMetadata.gltf[A]=d._internalMetadata.gltf[A];C._internalMetadata.gltf[vt]={lastSelected:null,original:[],variants:{}};for(const A of B.original)C._internalMetadata.gltf[vt].original.push({mesh:A.mesh,material:A.material});for(const A in B.variants)if(Object.prototype.hasOwnProperty.call(B.variants,A)){C._internalMetadata.gltf[vt].variants[A]=[];for(const N of B.variants[A])C._internalMetadata.gltf[vt].variants[A].push({mesh:N.mesh,material:N.material})}B=C._internalMetadata.gltf[vt]}for(const A of B.original)A.mesh===u&&(A.mesh=M);for(const A of B.variants[I.name])A.mesh===u&&(A.mesh=M)})}}))}}})),await Promise.all(h).then(([u])=>u)})}}Oe(vt);Fe(vt,!0,a=>new Ot(a));class oo{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:cn.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...oo._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new wt,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(o=>this._options[o]!==e[o]).length)return;const n={...this._options,...e},r=this._options;this._options=n,n.renderSize!==r.renderSize||n.renderTargetTextureType!==r.renderTargetTextureType||n.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=n.samples,this._opaqueRenderTarget.lodGenerationScale=n.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=n.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e?.subSurface?.isRefractionEnabled}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),Ve.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e);if(this._shouldRenderAsTransmission(e.material)){if(e.material){const o=e.material.subSurface;o&&(o.refractionTexture=this._opaqueRenderTarget)}n!==-1?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)}else t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):n===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){return this._opaqueRenderTarget?.getInternalTexture()!==null}_setupRenderTargets(){this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Wr("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=this._options.clearColor?.clone()??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.disableImageProcessing=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(t=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?t.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(t.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e});for(const t of this._transparentMeshesCache)this._shouldRenderAsTransmission(t.material)&&(t.material.refractionTexture=this._opaqueRenderTarget)}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const bs="KHR_materials_transmission";class pa{constructor(e){this.name=bs,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(bs),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadTransparentPropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,n,r){const o=this._loader._getOrCreateMaterialAdapter(n),s=r.transmissionFactor!==void 0?r.transmissionFactor:0;if(s===0)return Promise.resolve();if(o.configureTransmission(),o.transmissionWeight=s,s>0){const l=n.getScene();l._transmissionHelper?l._transmissionHelper?._isRenderTargetValid()||l._transmissionHelper?._setupRenderTargets():new oo({},n.getScene())}let i=Promise.resolve(null);return r.transmissionTexture&&(r.transmissionTexture.nonColorData=!0,i=this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,l=>{l.name=`${n.name} (Transmission)`,o.transmissionWeightTexture=l})),i.then(()=>{})}}Oe(bs);Fe(bs,!0,a=>new pa(a));const ws="KHR_materials_diffuse_transmission";class fa{constructor(e){this.name=ws,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(ws),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadTranslucentPropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,n,r){const o=this._loader._getOrCreateMaterialAdapter(n);o.configureSubsurface(),o.subsurfaceWeight=r.diffuseTransmissionFactor??0,o.subsurfaceColor=r.diffuseTransmissionColorFactor!==void 0?q.FromArray(r.diffuseTransmissionColorFactor):q.White();const s=new Array;return r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(i=>{i.name=`${n.name} (Diffuse Transmission)`,o.subsurfaceWeightTexture=i}))),r.diffuseTransmissionColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(i=>{i.name=`${n.name} (Diffuse Transmission Color)`,o.subsurfaceColorTexture=i})),Promise.all(s).then(()=>{})}}Oe(ws);Fe(ws,!0,a=>new fa(a));const xs="KHR_materials_volume";class ma{constructor(e){this.name=xs,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(xs),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadVolumePropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadVolumePropertiesAsync(e,t,n,r){const o=this._loader._getOrCreateMaterialAdapter(n);if(o.transmissionWeight===0&&o.subsurfaceWeight===0||!r.thicknessFactor)return Promise.resolve();o.transmissionDepth=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE,o.transmissionColor=r.attenuationColor!==void 0&&r.attenuationColor.length==3?q.FromArray(r.attenuationColor):q.White(),o.volumeThickness=r.thicknessFactor??0;const s=new Array;return r.thicknessTexture&&(r.thicknessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture,i=>{i.name=`${n.name} (Thickness)`,o.volumeThicknessTexture=i}))),Promise.all(s).then(()=>{})}}Oe(xs);Fe(xs,!0,a=>new ma(a));const As="KHR_materials_dispersion";class ya{constructor(e){this.name=As,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(As)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadDispersionPropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,n,r){const o=this._loader._getOrCreateMaterialAdapter(n);return o.transmissionWeight>0||!r.dispersion||(o.transmissionDispersionAbbeNumber=20/r.dispersion),Promise.resolve()}}Oe(As);Fe(As,!0,a=>new ya(a));const Ts="KHR_materials_diffuse_roughness";class ga{constructor(e){this.name=Ts,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ts)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadDiffuseRoughnessPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadDiffuseRoughnessPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.baseDiffuseRoughness=t.diffuseRoughnessFactor??0,t.diffuseRoughnessTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseRoughnessTexture`,t.diffuseRoughnessTexture,s=>{s.name=`${n.name} (Diffuse Roughness)`,r.baseDiffuseRoughnessTexture=s})),Promise.all(o).then(()=>{})}}Oe(Ts);Fe(Ts,!0,a=>new ga(a));const Cs="KHR_mesh_quantization";class va{constructor(e){this.name=Cs,this.enabled=e.isExtensionUsed(Cs)}dispose(){}}Oe(Cs);Fe(Cs,!0,a=>new va(a));const Es="KHR_texture_basisu";class _a{constructor(e){this.name=Es,this._loader=e,this.enabled=e.isExtensionUsed(Es)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=t.sampler==null?be.DefaultSampler:pe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=pe.Get(`${r}/source`,this._loader.gltf.images,o.source);return await this._loader._createTextureAsync(e,s,i,l=>{n(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}Oe(Es);Fe(Es,!0,a=>new _a(a));const Ms="KHR_texture_transform";class ba{constructor(e){this.name=Ms,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ms)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>await this._loader.loadTextureInfoAsync(e,t,s=>{if(!(s instanceof qe))throw new Error(`${r}: Texture type not supported`);o.offset&&(s.uOffset=o.offset[0],s.vOffset=o.offset[1]),s.uRotationCenter=0,s.vRotationCenter=0,o.rotation&&(s.wAng=-o.rotation),o.scale&&(s.uScale=o.scale[0],s.vScale=o.scale[1]),o.texCoord!=null&&(s.coordinatesIndex=o.texCoord),n(s)}))}}Oe(Ms);Fe(Ms,!0,a=>new ba(a));const Ss="KHR_xmp_json_ld";class wa{constructor(e){this.name=Ss,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ss)}dispose(){this._loader=null}onLoading(){if(this._loader.rootBabylonMesh===null)return;const e=this._loader.gltf.extensions?.KHR_xmp_json_ld,t=this._loader.gltf.asset?.extensions?.KHR_xmp_json_ld;if(e&&t){const n=+t.packet;e.packets&&n<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[n])}}}Oe(Ss);Fe(Ss,!0,a=>new wa(a));function rn(a,e,t,n){return q.FromArray(e,t).scale(n)}function xa(a,e,t,n){return e[t+3]*n}function De(a,e,t,n){return e[t]*n}function ro(a,e,t,n){return-e[t]*n}function Bs(a,e,t,n){return e[t+1]*n}function wr(a,e,t,n){return e[t]*n*2}function ft(a){return{scale:[new We(ge.ANIMATIONTYPE_FLOAT,`${a}.uScale`,De,()=>2),new We(ge.ANIMATIONTYPE_FLOAT,`${a}.vScale`,Bs,()=>2)],offset:[new We(ge.ANIMATIONTYPE_FLOAT,`${a}.uOffset`,De,()=>2),new We(ge.ANIMATIONTYPE_FLOAT,`${a}.vOffset`,Bs,()=>2)],rotation:[new We(ge.ANIMATIONTYPE_FLOAT,`${a}.wAng`,ro,()=>1)]}}class on extends Cn{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,n,r)}]}}class We extends Cn{buildAnimations(e,t,n,r){const o=[];for(const s in e._data)o.push({babylonAnimatable:e._data[s].babylonMaterial,babylonAnimation:this._buildAnimation(t,n,r)});return o}}class qt extends Cn{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,n,r)}]}}class Aa extends Cn{buildAnimations(e,t,n,r){return e._primitiveBabylonMeshes?e._primitiveBabylonMeshes.map(o=>({babylonAnimatable:o,babylonAnimation:this._buildAnimation(t,n,r)})):[]}}Y("/cameras/{}/orthographic/xmag",[new on(ge.ANIMATIONTYPE_FLOAT,"orthoLeft",ro,()=>1),new on(ge.ANIMATIONTYPE_FLOAT,"orthoRight",Bs,()=>1)]);Y("/cameras/{}/orthographic/ymag",[new on(ge.ANIMATIONTYPE_FLOAT,"orthoBottom",ro,()=>1),new on(ge.ANIMATIONTYPE_FLOAT,"orthoTop",Bs,()=>1)]);Y("/cameras/{}/orthographic/zfar",[new on(ge.ANIMATIONTYPE_FLOAT,"maxZ",De,()=>1)]);Y("/cameras/{}/orthographic/znear",[new on(ge.ANIMATIONTYPE_FLOAT,"minZ",De,()=>1)]);Y("/cameras/{}/perspective/yfov",[new on(ge.ANIMATIONTYPE_FLOAT,"fov",De,()=>1)]);Y("/cameras/{}/perspective/zfar",[new on(ge.ANIMATIONTYPE_FLOAT,"maxZ",De,()=>1)]);Y("/cameras/{}/perspective/znear",[new on(ge.ANIMATIONTYPE_FLOAT,"minZ",De,()=>1)]);Y("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new We(ge.ANIMATIONTYPE_COLOR3,"albedoColor",rn,()=>4),new We(ge.ANIMATIONTYPE_FLOAT,"alpha",xa,()=>4)]);Y("/materials/{}/pbrMetallicRoughness/metallicFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"metallic",De,()=>1)]);Y("/materials/{}/pbrMetallicRoughness/metallicFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"roughness",De,()=>1)]);const io=ft("albedoTexture");Y("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",io.scale);Y("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",io.offset);Y("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",io.rotation);const ao=ft("metallicTexture");Y("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",ao.scale);Y("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",ao.offset);Y("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",ao.rotation);Y("/materials/{}/emissiveFactor",[new We(ge.ANIMATIONTYPE_COLOR3,"emissiveColor",rn,()=>3)]);const lo=ft("bumpTexture");Y("/materials/{}/normalTexture/scale",[new We(ge.ANIMATIONTYPE_FLOAT,"bumpTexture.level",De,()=>1)]);Y("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",lo.scale);Y("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",lo.offset);Y("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",lo.rotation);Y("/materials/{}/occlusionTexture/strength",[new We(ge.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",De,()=>1)]);const co=ft("ambientTexture");Y("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",co.scale);Y("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",co.offset);Y("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",co.rotation);const uo=ft("emissiveTexture");Y("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",uo.scale);Y("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",uo.offset);Y("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",uo.rotation);Y("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new We(ge.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new We(ge.ANIMATIONTYPE_FLOAT,"anisotropy.angle",De,()=>1)]);const ho=ft("anisotropy.texture");Y("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",ho.scale);Y("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",ho.offset);Y("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",ho.rotation);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",De,()=>1)]);const po=ft("clearCoat.texture");Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",po.scale);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",po.offset);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",po.rotation);const fo=ft("clearCoat.bumpTexture");Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new We(ge.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",fo.scale);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",fo.offset);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",fo.rotation);const mo=ft("clearCoat.textureRoughness");Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",mo.scale);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",mo.offset);Y("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",mo.rotation);Y("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new We(ge.ANIMATIONTYPE_FLOAT,"emissiveIntensity",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_ior/ior",[new We(ge.ANIMATIONTYPE_FLOAT,"indexOfRefraction",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"iridescence.intensity",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new We(ge.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new We(ge.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new We(ge.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",De,()=>1)]);const yo=ft("iridescence.texture");Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",yo.scale);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",yo.offset);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",yo.rotation);const go=ft("iridescence.thicknessTexture");Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",go.scale);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",go.offset);Y("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",go.rotation);Y("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new We(ge.ANIMATIONTYPE_COLOR3,"sheen.color",rn,()=>3)]);Y("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"sheen.roughness",De,()=>1)]);const vo=ft("sheen.texture");Y("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",vo.scale);Y("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",vo.offset);Y("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",vo.rotation);const _o=ft("sheen.textureRoughness");Y("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",_o.scale);Y("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",_o.offset);Y("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",_o.rotation);Y("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"metallicF0Factor",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new We(ge.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",rn,()=>3)]);const bo=ft("metallicReflectanceTexture");Y("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",bo.scale);Y("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",bo.offset);Y("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",bo.rotation);const wo=ft("reflectanceTexture");Y("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",wo.scale);Y("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",wo.offset);Y("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",wo.rotation);Y("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",De,()=>1)]);const xo=ft("subSurface.refractionIntensityTexture");Y("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",xo.scale);Y("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",xo.offset);Y("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",xo.rotation);Y("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new We(ge.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",rn,()=>3)]);Y("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new We(ge.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",De,()=>1)]);Y("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",De,()=>1)]);const Ao=ft("subSurface.thicknessTexture");Y("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",Ao.scale);Y("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",Ao.offset);Y("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",Ao.rotation);Y("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new We(ge.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",De,()=>1)]);const To=ft("subSurface.translucencyIntensityTexture");Y("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",To.scale);Y("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",To.offset);Y("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",To.rotation);Y("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new We(ge.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",rn,()=>3)]);const Co=ft("subSurface.translucencyColorTexture");Y("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",Co.scale);Y("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",Co.offset);Y("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",Co.rotation);Y("/extensions/KHR_lights_punctual/lights/{}/color",[new qt(ge.ANIMATIONTYPE_COLOR3,"diffuse",rn,()=>3)]);Y("/extensions/KHR_lights_punctual/lights/{}/intensity",[new qt(ge.ANIMATIONTYPE_FLOAT,"intensity",De,()=>1)]);Y("/extensions/KHR_lights_punctual/lights/{}/range",[new qt(ge.ANIMATIONTYPE_FLOAT,"range",De,()=>1)]);Y("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new qt(ge.ANIMATIONTYPE_FLOAT,"innerAngle",wr,()=>1)]);Y("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new qt(ge.ANIMATIONTYPE_FLOAT,"angle",wr,()=>1)]);Y("/extensions/EXT_lights_area/lights/{}/color",[new qt(ge.ANIMATIONTYPE_COLOR3,"diffuse",rn,()=>3)]);Y("/extensions/EXT_lights_area/lights/{}/intensity",[new qt(ge.ANIMATIONTYPE_FLOAT,"intensity",De,()=>1)]);Y("/extensions/EXT_lights_area/lights/{}/size",[new qt(ge.ANIMATIONTYPE_FLOAT,"radius",De,()=>1)]);Y("/extensions/EXT_lights_area/lights/{}/rect/aspect",[new qt(ge.ANIMATIONTYPE_FLOAT,"radius",De,()=>1)]);Y("/nodes/{}/extensions/EXT_lights_ies/color",[new qt(ge.ANIMATIONTYPE_COLOR3,"diffuse",rn,()=>3)]);Y("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new qt(ge.ANIMATIONTYPE_FLOAT,"intensity",De,()=>1)]);Y("/nodes/{}/extensions/KHR_node_visibility/visible",[new Aa(ge.ANIMATIONTYPE_FLOAT,"isVisible",De,()=>1)]);const Is="KHR_animation_pointer";class Ta{constructor(e){this.name=Is,this._loader=e,this._pathToObjectConverter=yr(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(Is)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,n,r,o){const s=r.target.extensions?.KHR_animation_pointer;if(!s||!this._pathToObjectConverter)return null;r.target.path!=="pointer"&&Me.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&Me.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);const i=`${e}/extensions/${this.name}`,l=s.pointer;if(!l)throw new Error(`${i}: Pointer is missing`);try{const h=this._pathToObjectConverter.convert(l);if(!h.info.interpolation)throw new Error(`${i}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,r,{object:h.object,info:h.info.interpolation},o)}catch{return Me.Warn(`${i}/pointer: Invalid pointer (${l}) skipped`),null}}}Oe(Is);Fe(Is,!0,a=>new Ta(a));const Ps="MSFT_audio_emitter";class Ca{constructor(e){this.name=Ps,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ps)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,pe.Assign(this._clips),pe.Assign(this._emitters)}}loadSceneAsync(e,t){return be.LoadExtensionAsync(e,t,this.name,async(n,r)=>{const o=new Array;o.push(this._loader.loadSceneAsync(e,t));for(const s of r.emitters){const i=pe.Get(`${n}/emitters`,this._emitters,s);if(i.refDistance!=null||i.maxDistance!=null||i.rolloffFactor!=null||i.distanceModel!=null||i.innerAngle!=null||i.outerAngle!=null)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);o.push(this._loadEmitterAsync(`${n}/emitters/${i.index}`,i))}await Promise.all(o)})}loadNodeAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array,i=await this._loader.loadNodeAsync(r,t,l=>{for(const h of o.emitters){const u=pe.Get(`${r}/emitters`,this._emitters,h);s.push(this._loadEmitterAsync(`${r}/emitters/${u.index}`,u).then(()=>{for(const c of u._babylonSounds)c.attachToMesh(l),(u.innerAngle!=null||u.outerAngle!=null)&&(c.setLocalDirectionToMesh(K.Forward()),c.setDirectionalCone(2*Ve.ToDegrees(u.innerAngle==null?Math.PI:u.innerAngle),2*Ve.ToDegrees(u.outerAngle==null?Math.PI:u.outerAngle),0))}))}n(l)});return await Promise.all(s),i})}loadAnimationAsync(e,t){return be.LoadExtensionAsync(e,t,this.name,async(n,r)=>{const o=await this._loader.loadAnimationAsync(e,t),s=new Array;pe.Assign(r.events);for(const i of r.events)s.push(this._loadAnimationEventAsync(`${n}/events/${i.index}`,e,t,i,o));return await Promise.all(s),o})}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{const r=pe.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=n.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const n=new Array,r=t.name||`emitter${t.index}`,o={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let i=0;i<t.clips.length;i++){const l=`/extensions/${this.name}/clips`,h=pe.Get(l,this._clips,t.clips[i].clip);n.push(this._loadClipAsync(`${l}/${t.clips[i].clip}`,h).then(u=>{const c=t._babylonSounds[i]=new qr(r,u,this._loader.babylonScene,null,o);c.refDistance=t.refDistance||1,c.maxDistance=t.maxDistance||256,c.rolloffFactor=t.rolloffFactor||1,c.distanceModel=t.distanceModel||"exponential"}))}const s=Promise.all(n).then(()=>{const i=t.clips.map(h=>h.weight||1),l=new Kr(t.loop||!1,t._babylonSounds,i);t.innerAngle&&(l.directionalConeInnerAngle=2*Ve.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*Ve.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:s}}return t._babylonData.loaded}_getEventAction(e,t,n,r,o){switch(n){case"play":return s=>{const i=(o||0)+(s-r);t.play(i)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,r,o){if(o.targetedAnimations.length==0)return Promise.resolve();const s=o.targetedAnimations[0],i=r.emitter,l=pe.Get(`/extensions/${this.name}/emitters`,this._emitters,i);return this._loadEmitterAsync(e,l).then(()=>{const h=l._babylonData.sound;if(h){const u=new jr(r.time,this._getEventAction(e,h,r.action,r.time,r.startOffset));s.animation.addEvent(u),o.onAnimationGroupEndObservable.add(()=>{h.stop()}),o.onAnimationGroupPauseObservable.add(()=>{h.pause()})}})}}Oe(Ps);Fe(Ps,!0,a=>new Ca(a));const Vn="MSFT_lod";class Ea{constructor(e){this.name=Vn,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new wt,this.onMaterialLODsLoadedObservable=new wt,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=this._loader.parent.extensionOptions[Vn]?.maxLODsToLoad??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(Vn)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const n=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),n}loadNodeAsync(e,t,n){return be.LoadExtensionAsync(e,t,this.name,async(r,o)=>{let s;const i=this._getLODs(r,t,this._loader.gltf.nodes,o.ids);this._loader.logOpen(`${r}`);for(let l=0;l<i.length;l++){const h=i[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Fn);const u=d=>{n(d),d.setEnabled(!1)},c=this._loader.loadNodeAsync(`/nodes/${h.index}`,h,u).then(d=>{if(l!==0){const p=i[l-1];p._babylonTransformNode&&(this._disposeTransformNode(p._babylonTransformNode),delete p._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?s=c:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(c))}return this._loader.logClose(),await s})}_loadMaterialAsync(e,t,n,r,o){return this._nodeIndexLOD?null:be.LoadExtensionAsync(e,t,this.name,async(s,i)=>{let l;const h=this._getLODs(s,t,this._loader.gltf.materials,i.ids);this._loader.logOpen(`${s}`);for(let u=0;u<h.length;u++){const c=h[u];u!==0&&(this._materialIndexLOD=u);const d=this._loader._loadMaterialAsync(`/materials/${c.index}`,c,n,r,p=>{u===0&&o(p)}).then(p=>{if(u!==0){o(p);const f=h[u-1]._data;f[r]&&(this._disposeMaterials([f[r].babylonMaterial]),delete f[r])}return p});this._materialPromiseLODs[u]=this._materialPromiseLODs[u]||[],u===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[u].push(d))}return this._loader.logClose(),await l})}_loadUriAsync(e,t,n){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new Fn,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(async()=>await this._loader.loadUriAsync(e,t,n))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new Fn,this._materialSignalLODs[r].promise.then(async()=>await this._loader.loadUriAsync(e,t,n))}return null}loadBufferAsync(e,t,n,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const o=async(s,i)=>{const l=n,h=l+r-1;let u=s[i];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,h)):(u={start:l,end:h,loaded:new Fn},s[i]=u),await u.loaded.promise.then(c=>new Uint8Array(c.buffer,c.byteOffset+n-u.start,r))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?o(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?o(this._materialBufferLODs,this._materialIndexLOD):o(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const n=e[t];n&&(this._loader.log(`Loading buffer range [${n.start}-${n.end}]`),this._loader.bin.readAsync(n.start,n.end-n.start+1).then(r=>{n.loaded.resolve(r)},r=>{n.loaded.reject(r)}))}_getLODs(e,t,n,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const o=[];for(let s=r.length-1;s>=0;s--)if(o.push(pe.Get(`${e}/ids/${r[s]}`,n,r[s])),o.length===this.maxLODsToLoad)return o;return o.push(t),o}_disposeTransformNode(e){const t=[],n=e.material;n&&t.push(n);for(const o of e.getChildMeshes())o.material&&t.push(o.material);e.dispose();const r=t.filter(o=>this._loader.babylonScene.meshes.every(s=>s.material!=o));this._disposeMaterials(r)}_disposeMaterials(e){const t={};for(const n of e){for(const r of n.getActiveTextures())t[r.uniqueId]=r;n.dispose()}for(const n in t)for(const r of this._loader.babylonScene.materials)r.hasTexture(t[n])&&delete t[n];for(const n in t)t[n].dispose()}}Oe(Vn);Fe(Vn,!0,a=>new Ea(a));const Ns="MSFT_minecraftMesh";class Ma{constructor(e){this.name=Ns,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ns)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtraAsync(e,t,this.name,async(r,o)=>{if(o){if(!this._loader._pbrMaterialImpl)throw new Error(`${r}: Material type not supported`);const s=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,await s}})}}Oe(Ns);Fe(Ns,!0,a=>new Ma(a));const Os="MSFT_sRGBFactors";class Sa{constructor(e){this.name=Os,this._loader=e,this.enabled=this._loader.isExtensionUsed(Os)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return be.LoadExtraAsync(e,t,this.name,async(r,o)=>{if(o){const s=this._loader._getOrCreateMaterialAdapter(n),i=this._loader.loadMaterialPropertiesAsync(e,t,n),l=n.getScene().getEngine().useExactSrgbConversions;return s.baseColorTexture||s.baseColor.toLinearSpaceToRef(s.baseColor,l),s.specularColorTexture||s.specularColor.toLinearSpaceToRef(s.specularColor,l),await i}})}}Oe(Os);Fe(Os,!0,a=>new Sa(a));function $o(a){const[e,t]=a.split(":");return xr({op:e,extension:t})}function xr(a,e=!0){const t=a.extension?Xn[a.extension]?.[a.op]:Ba[a.op];if(!t&&(Me.Warn(`No mapping found for operation ${a.op} and extension ${a.extension||"KHR_interactivity"}`),e)){const n={},r={flows:{}};if(a.inputValueSockets){n.values={};for(const o in a.inputValueSockets)n.values[o]={name:o}}return a.outputValueSockets&&(r.values={},Object.keys(a.outputValueSockets).forEach(o=>{r.values[o]={name:o}})),{blocks:[],inputs:n,outputs:r}}return t}function Eo(a,e,t){Xn[e]||(Xn[e]={}),Xn[e][a]=t}const Xn={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},Ba={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],extraProcessor(a,e,t,n,r){if(e.op!=="event/send"||!a.configuration||Object.keys(a.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const s=a.configuration.event.value[0];if(typeof s!="number")throw new Error("Event id should be a number");const i=n.arrays.events[s],l=r[0];return l.config||(l.config={}),l.config.eventId=i.eventId,l.config.eventData=i.eventData,r}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(a,e){if(!a.configuration)return Me.Error("Receive event should have a configuration object"),{valid:!1,error:"Receive event should have a configuration object"};const t=a.configuration.event;if(!t)return Me.Error("Receive event should have a single configuration object, the event itself"),{valid:!1,error:"Receive event should have a single configuration object, the event itself"};const n=t.value[0];return typeof n!="number"?(Me.Error("Event id should be a number"),{valid:!1,error:"Event id should be a number"}):e.events?.[n]?{valid:!0}:(Me.Error(`Event with id ${n} not found`),{valid:!1,error:`Event with id ${n} not found`})},extraProcessor(a,e,t,n,r){if(e.op!=="event/receive"||!a.configuration||Object.keys(a.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const s=a.configuration.event.value[0];if(typeof s!="number")throw new Error("Event id should be a number");const i=n.arrays.events[s],l=r[0];return l.config||(l.config={}),l.config.eventId=i.eventId,l.config.eventData=i.eventData,r}},"math/E":ye("FlowGraphEBlock"),"math/Pi":ye("FlowGraphPIBlock"),"math/Inf":ye("FlowGraphInfBlock"),"math/NaN":ye("FlowGraphNaNBlock"),"math/abs":ye("FlowGraphAbsBlock"),"math/sign":ye("FlowGraphSignBlock"),"math/trunc":ye("FlowGraphTruncBlock"),"math/floor":ye("FlowGraphFloorBlock"),"math/ceil":ye("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.roundHalfAwayFromZero=!0,r}},"math/fract":ye("FlowGraphFractBlock"),"math/neg":ye("FlowGraphNegationBlock"),"math/add":ye("FlowGraphAddBlock",["a","b"],!0),"math/sub":ye("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(a,e,t,n,r){var o;(o=r[0]).config||(o.config={}),r[0].config.useMatrixPerComponent=!0,r[0].config.preventIntegerFloatArithmetic=!0;let s=-1;return Object.keys(a.values||{}).find(i=>a.values?.[i].type!==void 0?(s=a.values[i].type,!0):!1),s!==-1&&(r[0].config.type=n.arrays.types[s].flowGraphType),r},validation(a){return a.values?Ar(a):{valid:!0}}},"math/div":ye("FlowGraphDivideBlock",["a","b"],!0),"math/rem":ye("FlowGraphModuloBlock",["a","b"]),"math/min":ye("FlowGraphMinBlock",["a","b"]),"math/max":ye("FlowGraphMaxBlock",["a","b"]),"math/clamp":ye("FlowGraphClampBlock",["a","b","c"]),"math/saturate":ye("FlowGraphSaturateBlock"),"math/mix":ye("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":ye("FlowGraphEqualityBlock",["a","b"]),"math/lt":ye("FlowGraphLessThanBlock",["a","b"]),"math/le":ye("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":ye("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":ye("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isNaN":ye("FlowGraphIsNaNBlock"),"math/isInf":ye("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":ye("FlowGraphSinBlock"),"math/cos":ye("FlowGraphCosBlock"),"math/tan":ye("FlowGraphTanBlock"),"math/asin":ye("FlowGraphASinBlock"),"math/acos":ye("FlowGraphACosBlock"),"math/atan":ye("FlowGraphATanBlock"),"math/atan2":ye("FlowGraphATan2Block",["a","b"]),"math/sinh":ye("FlowGraphSinhBlock"),"math/cosh":ye("FlowGraphCoshBlock"),"math/tanh":ye("FlowGraphTanhBlock"),"math/asinh":ye("FlowGraphASinhBlock"),"math/acosh":ye("FlowGraphACoshBlock"),"math/atanh":ye("FlowGraphATanhBlock"),"math/exp":ye("FlowGraphExponentialBlock"),"math/log":ye("FlowGraphLogBlock"),"math/log2":ye("FlowGraphLog2Block"),"math/log10":ye("FlowGraphLog10Block"),"math/sqrt":ye("FlowGraphSquareRootBlock"),"math/cbrt":ye("FlowGraphCubeRootBlock"),"math/pow":ye("FlowGraphPowerBlock",["a","b"]),"math/length":ye("FlowGraphLengthBlock"),"math/normalize":ye("FlowGraphNormalizeBlock"),"math/dot":ye("FlowGraphDotBlock",["a","b"]),"math/cross":ye("FlowGraphCrossBlock",["a","b"]),"math/rotate2D":{blocks:["FlowGraphRotate2DBlock"],inputs:{values:{a:{name:"a"},angle:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/rotate3D":{blocks:["FlowGraphRotate3DBlock"],inputs:{values:{a:{name:"a"},rotation:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":ye("FlowGraphTransposeBlock"),"math/determinant":ye("FlowGraphDeterminantBlock"),"math/inverse":ye("FlowGraphInvertMatrixBlock"),"math/matMul":ye("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r,o){const s=r[0].dataInputs.find(i=>i.name==="rotationQuaternion");if(!s)throw new Error("Rotation quaternion input not found");return o._connectionValues[s.uniqueId]&&(o._connectionValues[s.uniqueId].type="Quaternion"),r}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/quatConjugate":ye("FlowGraphConjugateBlock",["a"]),"math/quatMul":{blocks:["FlowGraphMultiplyBlock"],inputs:{values:{a:{name:"a",gltfType:"vector4"},b:{name:"b",gltfType:"vector4"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.type="Quaternion",r}},"math/quatAngleBetween":ye("FlowGraphAngleBetweenBlock",["a","b"]),"math/quatFromAxisAngle":{blocks:["FlowGraphQuaternionFromAxisAngleBlock"],inputs:{values:{axis:{name:"a",gltfType:"float3"},angle:{name:"b",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/quatToAxisAngle":ye("FlowGraphAxisAngleFromQuaternionBlock",["a"]),"math/quatFromDirections":ye("FlowGraphQuaternionFromDirectionsBlock",["a","b"]),"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r,o){var s;(s=r[0]).config||(s.config={});const i=r[0].dataInputs[0];return r[0].config.valueType=o._connectionValues[i.uniqueId]?.type??"FlowGraphInteger",r}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r,o){var s;(s=r[0]).config||(s.config={});const i=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=o._connectionValues[i.uniqueId]?.type??o._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r,o){var s;(s=r[0]).config||(s.config={});const i=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=o._connectionValues[i.uniqueId]?.type??o._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(a,e,t,n,r,o){var s;(s=r[0]).config||(s.config={});const i=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=o._connectionValues[i.uniqueId]?.type??o._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/asr":ye("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":ye("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":ye("FlowGraphLeadingZerosBlock"),"math/ctz":ye("FlowGraphTrailingZerosBlock"),"math/popcnt":ye("FlowGraphOneBitsCounterBlock"),"math/rad":ye("FlowGraphDegToRadBlock"),"math/deg":ye("FlowGraphRadToDegBlock"),"type/boolToInt":ye("FlowGraphBooleanToInt"),"type/boolToFloat":ye("FlowGraphBooleanToFloat"),"type/intToBool":ye("FlowGraphIntToBoolean"),"type/intToFloat":ye("FlowGraphIntToFloat"),"type/floatToInt":ye("FlowGraphFloatToInt"),"type/floatToBool":ye("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(a,e,t,n,r){const o=r[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(a.flows||[]).length,o.signalOutputs.forEach((s,i)=>{s.name="out_"+i}),r}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"},default:{name:"default"}}},validation(a){if(a.configuration&&a.configuration.cases){const e=a.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return Me.Warn("Switch cases should be integers. Using empty array instead."),a.configuration.cases.value=[],{valid:!0};const n=new Set(e);a.configuration.cases.value=Array.from(n)}return{valid:!0}},extraProcessor(a,e,t,n,r){if(e.op!=="flow/switch"||!a.flows||Object.keys(a.flows).length===0)throw new Error("Switch should have a single configuration object, the cases array");return r[0].signalOutputs.forEach(s=>{s.name!=="default"&&(s.name="out_"+s.name)}),r}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}},extraProcessor(a,e,t,n,r){const o=r[0];return o.config||(o.config={}),o.config.incrementIndexWhenLoopDone=!0,r}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(a,e,t,n,r){if(e.op!=="flow/multiGate"||!a.flows||Object.keys(a.flows).length===0)throw new Error("MultiGate should have a single configuration object, the number of output flows");const o=r[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(a.flows).length,o.signalOutputs.forEach((s,i)=>{s.name="out_"+i}),r}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{reset:{name:"reset"},"[segment]":{name:"in_$1"}}},validation(a){return typeof a.configuration?.inputFlows?.value[0]!="number"&&(a.configuration=a.configuration||{inputFlows:{value:[0]}},a.configuration.inputFlows.value=[0]),{valid:!0}}},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation(a){return a.configuration?.variable?.value?{valid:!0}:(Me.Error("Variable get block should have a variable configuration"),{valid:!1,error:"Variable get block should have a variable configuration"})},configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(a,e){return[e.getVariableName(a[0])]}}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(a,e){return[e.getVariableName(a[0])]}}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer(a,e){return[a[0].map(t=>e.getVariableName(t))]}}},extraProcessor(a,e,t,n,r){return r[0].dataInputs.forEach(s=>{s.name=n.getVariableName(+s.name)}),r}},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer(a,e){return[e.getVariableName(a[0])]}},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:a=>a[0]===!0?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(a,e,t,n,r){var o,s;const i=r[0],l=a.configuration?.variable.value[0];if(typeof l!="number")throw Me.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");const h=n.arrays.staticVariables[l];typeof i.config.animationType.value>"u"&&(n.arrays.staticVariables,i.config.animationType.value=Yr(h.type));const u=r[4];return u.config||(u.config={}),(o=u.config).variable||(o.variable={}),u.config.variable.value=n.getVariableName(l),(s=r[3]).config||(s.config={}),r}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(a,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),r}},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(a,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),r}},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(a,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"?(o.config||(o.config={}),o.config.outputValue=!0):o.className==="FlowGraphInterpolationBlock"&&(o.config||(o.config={}),Object.keys(a.values||[]).forEach(s=>{const i=a.values?.[s];if(s==="value"&&i){const l=i.type;l!==void 0&&(o.config.animationType=n.arrays.types[l].flowGraphType)}}))}),r}},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(a,e)=>[a[0]*e._animationTargetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(a,e)=>[a[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(a,e,t,n,r,o,s){const i=r[r.length-1];return i.config||(i.config={}),i.config.glTF=s,r}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(a,e,t,n,r,o,s){const i=r[r.length-1];return i.config||(i.config={}),i.config.glTF=s,r}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(a,e)=>[a[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(a,e,t,n,r,o,s){const i=r[r.length-1];return i.config||(i.config={}),i.config.glTF=s,r}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(a){if(a.configuration&&a.configuration.cases){const e=a.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return Me.Warn("Switch cases should be integers. Using empty array instead."),a.configuration.cases.value=[],{valid:!0};const n=new Set(e);a.configuration.cases.value=Array.from(n)}return{valid:!0}},extraProcessor(a,e,t,n,r){const o=r[0];return o.dataInputs.forEach(s=>{s.name!=="default"&&s.name!=="case"&&(s.name="in_"+s.name)}),o.config||(o.config={}),o.config.treatCasesAsIntegers=!0,r}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}};function ye(a,e=["a"],t){return{blocks:[a],inputs:{values:e.reduce((n,r)=>(n[r]={name:r},n),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(n,r,o,s,i){var l;if(t){(l=i[0]).config||(l.config={}),i[0].config.preventIntegerFloatArithmetic=!0;let h=-1;Object.keys(n.values||{}).find(u=>n.values?.[u].type!==void 0?(h=n.values[u].type,!0):!1),h!==-1&&(i[0].config.type=s.arrays.types[h].flowGraphType)}return i},validation(n){return t?Ar(n):{valid:!0}}}}function Ar(a){if(a.values){const e=Object.keys(a.values).map(n=>a.values[n].type).filter(n=>n!==void 0);if(!e.every(n=>n===e[0]))return{valid:!1,error:"All inputs must be of the same type"}}return{valid:!0}}const Ia={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}};class Pa{constructor(e,t,n=60){this._interactivityGraph=e,this._gltf=t,this._animationTargetFps=n,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(const e of this._interactivityGraph.types)this._types.push(Ia[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(const e of this._interactivityGraph.declarations){const t=xr(e);if(!t)throw Me.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(const e of this._interactivityGraph.variables){const t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){const n=this._types[e.type];if(!n)throw Me.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==n.length)throw Me.Error(["Invalid value length for variable",e,n]),new Error("Error parsing variables");const r=e.value||[];if(!r.length)switch(n.flowGraphType){case"boolean":r.push(!1);break;case"FlowGraphInteger":r.push(0);break;case"number":r.push(NaN);break;case"Vector2":r.push(NaN,NaN);break;case"Vector3":r.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":r.fill(NaN,0,4);break;case"Matrix":r.fill(NaN,0,16);break;case"Matrix3D":r.fill(NaN,0,9);break}return n.elementType==="number"&&typeof r[0]=="string"&&(r[0]=parseFloat(r[0])),{type:n.flowGraphType,value:t?t(r,this):r}}_parseEvents(){if(this._interactivityGraph.events)for(const e of this._interactivityGraph.events){const t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(n=>{const r=e.values?.[n];if(!r)throw Me.Error(["No value found for event key",n]),new Error("Error parsing events");const o=this._types[r.type];if(!o)throw Me.Error(["No type found for event value",r]),new Error("Error parsing events");const s=typeof r.value<"u"?this._parseVariable(r):void 0;return{id:n,type:o.flowGraphType,eventData:!0,value:s}})),this._events.push(t)}}_parseNodes(){if(this._interactivityGraph.nodes)for(const e of this._interactivityGraph.nodes){if(typeof e.declaration!="number")throw Me.Error(["No declaration found for node",e]),new Error("Error parsing nodes");const t=this._mappings[e.declaration];if(!t)throw Me.Error(["No mapping found for node",e]),new Error("Error parsing nodes");if(t.flowGraphMapping.validation){const r=t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf);if(!r.valid)throw new Error(`Error validating interactivity node ${this._interactivityGraph.declarations?.[e.declaration].op} - ${r.error}`)}const n=[];for(const r of t.flowGraphMapping.blocks){const o=this._getEmptyBlock(r,t.fullOperationName);this._parseNodeConfiguration(e,o,t.flowGraphMapping,r),n.push(o)}this._nodes.push({blocks:n,fullOperationName:t.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:Ds(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,n,r){const o=t.config;if(e.configuration){const s=Object.keys(e.configuration);for(const i of s){const l=e.configuration?.[i];if(!l)throw Me.Error(["No value found for node configuration",i]),new Error("Error parsing node configuration");const h=n.configuration?.[i];if(h&&h.toBlock?h.toBlock===r:n.blocks.indexOf(r)===0){const c=h?.name||i;(!l||typeof l.value>"u")&&typeof h?.defaultValue<"u"?o[c]={value:h.defaultValue}:l.value.length>=0?o[c]={value:l.value.length===1?l.value[0]:l.value}:Me.Warn(["Invalid value for node configuration",l]),h&&h.dataTransformer&&(o[c].value=h.dataTransformer([o[c].value],this)[0])}}}}_parseNodeConnections(e){for(let t=0;t<this._nodes.length;t++){const n=this._interactivityGraph.nodes?.[t];if(!n)throw Me.Error(["No node found for interactivity node",this._nodes[t]]),new Error("Error parsing node connections");const r=this._nodes[t],o=this._mappings[n.declaration];if(!o)throw Me.Error(["No mapping found for node",n]),new Error("Error parsing node connections");const s=n.flows||{},i=Object.keys(s).sort();for(const u of i){const c=s[u],d=o.flowGraphMapping.outputs?.flows?.[u],p=d?.name||u,f=this._createNewSocketConnection(p,!0);(d&&d.toBlock&&r.blocks.find(M=>M.className===d.toBlock)||r.blocks[0]).signalOutputs.push(f);const y=c.node,m=this._nodes[y];if(!m)throw Me.Error(["No node found for input node id",y]),new Error("Error parsing node connections");const _=$o(m.fullOperationName);if(!_)throw Me.Error(["No mapping found for input node",m]),new Error("Error parsing node connections");let b=_.inputs?.flows?.[c.socket||"in"],v=!1;if(!b)for(const M in _.inputs?.flows)M.startsWith("[")&&M.endsWith("]")&&(v=!0,b=_.inputs?.flows?.[M]);const w=b?v?b.name.replace("$1",c.socket||""):b.name:c.socket||"in",I=b&&b.toBlock&&m.blocks.find(M=>M.className===b.toBlock)||m.blocks[0];let F=I.signalInputs.find(M=>M.name===w);F||(F=this._createNewSocketConnection(w),I.signalInputs.push(F)),F.connectedPointIds.push(f.uniqueId),f.connectedPointIds.push(F.uniqueId)}const l=n.values||{},h=Object.keys(l);for(const u of h){const c=l[u];let d=o.flowGraphMapping.inputs?.values?.[u],p=!1;if(!d)for(const m in o.flowGraphMapping.inputs?.values)m.startsWith("[")&&m.endsWith("]")&&(p=!0,d=o.flowGraphMapping.inputs?.values?.[m]);const f=d?p?d.name.replace("$1",u):d.name:u,g=this._createNewSocketConnection(f);if((d&&d.toBlock&&r.blocks.find(m=>m.className===d.toBlock)||r.blocks[0]).dataInputs.push(g),c.value!==void 0){const m=this._parseVariable(c,d&&d.dataTransformer);e._connectionValues[g.uniqueId]=m}else if(typeof c.node<"u"){const m=c.node,_=c.socket||"value",b=this._nodes[m];if(!b)throw Me.Error(["No node found for output socket reference",c]),new Error("Error parsing node connections");const v=$o(b.fullOperationName);if(!v)throw Me.Error(["No mapping found for output socket reference",c]),new Error("Error parsing node connections");let w=v.outputs?.values?.[_],I=!1;if(!w)for(const C in v.outputs?.values)C.startsWith("[")&&C.endsWith("]")&&(I=!0,w=v.outputs?.values?.[C]);const F=w?I?w.name.replace("$1",_):w?.name:_,M=w&&w.toBlock&&b.blocks.find(C=>C.className===w.toBlock)||b.blocks[0];let B=M.dataOutputs.find(C=>C.name===F);B||(B=this._createNewSocketConnection(F,!0),M.dataOutputs.push(B)),g.connectedPointIds.push(B.uniqueId),B.connectedPointIds.push(g.uniqueId)}else throw Me.Error(["Invalid value for value connection",c]),new Error("Error parsing node connections")}if(o.flowGraphMapping.interBlockConnectors)for(const u of o.flowGraphMapping.interBlockConnectors){const c=u.input,d=u.output,p=u.isVariable;this._connectFlowGraphNodes(c,d,r.blocks[u.inputBlockIndex],r.blocks[u.outputBlockIndex],p)}if(o.flowGraphMapping.extraProcessor){const u=this._interactivityGraph.declarations?.[n.declaration];if(!u)throw Me.Error(["No declaration found for extra processor",n]),new Error("Error parsing node connections");r.blocks=o.flowGraphMapping.extraProcessor(n,u,o.flowGraphMapping,this,r.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:Ds(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,n,r,o){const s=o?n.dataInputs:n.signalInputs,i=o?r.dataOutputs:r.signalOutputs,l=s.find(u=>u.name===e)||this._createNewSocketConnection(e),h=i.find(u=>u.name===t)||this._createNewSocketConnection(t,!0);s.find(u=>u.name===e)||s.push(l),i.find(u=>u.name===t)||i.push(h),l.connectedPointIds.push(h.uniqueId),h.connectedPointIds.push(l.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){const e={uniqueId:Ds(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let n=0;n<this._staticVariables.length;n++){const r=this._staticVariables[n];e._userVariables[this.getVariableName(n)]=r}return{rightHanded:!0,allBlocks:this._nodes.reduce((n,r)=>n.concat(r.blocks),[]),executionContexts:[e]}}}const $n="KHR_interactivity";class Na{constructor(e){this._loader=e,this.name=$n,this.enabled=this._loader.isExtensionUsed($n),this._pathConverter=yr(this._loader.gltf),e._skipStartAnimationStep=!0;const t=e.babylonScene;t&&Oa(t)}dispose(){this._loader=null,delete this._pathConverter}async onReady(){if(!this._loader.babylonScene||!this._pathConverter)return;const e=this._loader.babylonScene,t=this._loader.gltf.extensions?.KHR_interactivity;if(!t)return;const n=new Xr({scene:e});n.dispatchEventsSynchronously=!1;const r=t.graphs.map(o=>new Pa(o,this._loader.gltf,this._loader.parent.targetFps).serializeToFlowGraph());await Promise.all(r.map(async o=>await Qr(o,{coordinator:n,pathConverter:this._pathConverter}))),n.start()}}function Oa(a){Yt("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>{if(!a.activeCamera)return new at(NaN,NaN,NaN,NaN);const e=at.FromRotationMatrix(a.activeCamera.getWorldMatrix()).normalize();return a.useRightHandedSystem||(e.w*=-1,e.x*=-1),e},type:"Quaternion",getTarget:()=>a.activeCamera}),Yt("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>{if(!a.activeCamera)return new K(NaN,NaN,NaN);const e=a.activeCamera.getWorldMatrix().getTranslation();return a.useRightHandedSystem||(e.x*=-1),e},type:"Vector3",getTarget:()=>a.activeCamera}),Yt("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>e._babylonAnimationGroup?.isPlaying??!1,type:"boolean",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>(e._babylonAnimationGroup?.from??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>(e._babylonAnimationGroup?.to??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup})}Jr($n,"FlowGraphGLTFDataProvider",async()=>(await xn(async()=>{const{FlowGraphGLTFDataProvider:a}=await import("./flowGraphGLTFDataProvider-BfFqG1mI.js");return{FlowGraphGLTFDataProvider:a}},__vite__mapDeps([2,1]))).FlowGraphGLTFDataProvider);Oe($n);Fe($n,!0,a=>new Na(a));const Rs="KHR_node_visibility";Yt("/nodes/{}/extensions/KHR_node_visibility/visible",{get:a=>{const e=a._babylonTransformNode;return e&&e.isVisible!==void 0?e.isVisible:!0},set:(a,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.inheritVisibility=!0}),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=a),e._primitiveBabylonMeshes?.forEach(t=>{t.isVisible=a})},getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});class Ra{constructor(e){this.name=Rs,this._loader=e,this.enabled=e.isExtensionUsed(Rs)}onReady(){if(!this._loader)return;const e=this._loader.gltf.nodes;if(e)for(const t of e){const n=t._babylonTransformNode;n&&(n.inheritVisibility=!0,t.extensions&&t.extensions.KHR_node_visibility&&t.extensions.KHR_node_visibility.visible===!1&&(n.isVisible=!1))}}dispose(){delete this._loader}}Oe(Rs);Fe(Rs,!0,a=>new Ra(a));const Hn="KHR_node_selectability";Eo("event/onSelect",Hn,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(a){return["pickedMesh_"+a[0]]}}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(a,e,t,n,r,o,s){const i=r[r.length-1];i.config=i.config||{},i.config.glTF=s;const l=a.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const h="pickedMesh_"+l;return r[1].config.variable=h,o._userVariables[h]={className:"Mesh",id:s?.nodes?.[l]._babylonTransformNode?.id,uniqueId:s?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});Yt("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:a=>{const e=a._babylonTransformNode;return e&&e.isPickable!==void 0?e.isPickable:!0},set:(a,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.isPickable=a})},getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});class Fa{constructor(e){this.name=Hn,this._loader=e,this.enabled=e.isExtensionUsed(Hn)}async onReady(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_selectability&&e.extensions?.KHR_node_selectability.selectable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.isPickable=!1})})}dispose(){this._loader=null}}Oe(Hn);Fe(Hn,!0,a=>new Fa(a));const On="KHR_node_hoverability",Ho="targetMeshPointerOver_";Eo("event/onHoverIn",On,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(a){return[Ho+a[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(a,e,t,n,r,o,s){const i=r[r.length-1];i.config=i.config||{},i.config.glTF=s;const l=a.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const h=Ho+l;return r[1].config.variable=h,o._userVariables[h]={className:"Mesh",id:s?.nodes?.[l]._babylonTransformNode?.id,uniqueId:s?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});const zo="targetMeshPointerOut_";Eo("event/onHoverOut",On,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(a){return[zo+a[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(a,e,t,n,r,o,s){const i=r[r.length-1];i.config=i.config||{},i.config.glTF=s;const l=a.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const h=zo+l;return r[1].config.variable=h,o._userVariables[h]={className:"Mesh",id:s?.nodes?.[l]._babylonTransformNode?.id,uniqueId:s?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});Yt("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:a=>{const e=a._babylonTransformNode;return e&&e.pointerOverDisableMeshTesting!==void 0?e.pointerOverDisableMeshTesting:!0},set:(a,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.pointerOverDisableMeshTesting=!a})},getTarget:a=>a._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});class La{constructor(e){this.name=On,this._loader=e,this.enabled=e.isExtensionUsed(On)}async onReady(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_hoverability&&e.extensions?.KHR_node_hoverability.hoverable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.pointerOverDisableMeshTesting=!0})})}dispose(){this._loader=null}}Oe(On);Fe(On,!0,a=>new La(a));const Mo="ExtrasAsMetadata";class ka{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const n=e.metadata=e.metadata||{},r=n.gltf=n.gltf||{};r.extras=t.extras}}constructor(e){this.name=Mo,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,n){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}loadCameraAsync(e,t,n){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}createMaterial(e,t,n){const r=this._loader.createMaterial(e,t,n);return this._assignExtras(r,t),r}}Oe(Mo);Fe(Mo,!1,a=>new ka(a));class zt{constructor(){this.materials=[]}parseMTL(e,t,n,r){if(t instanceof ArrayBuffer)return;const o=t.split(`
`),s=/\s+/;let i,l=null;for(let h=0;h<o.length;h++){const u=o[h].trim();if(u.length===0||u.charAt(0)==="#")continue;const c=u.indexOf(" ");let d=c>=0?u.substring(0,c):u;d=d.toLowerCase();const p=c>=0?u.substring(c+1).trim():"";if(d==="newmtl")l&&this.materials.push(l),e._blockEntityCollection=!!r,l=new Bt(p,e),l._parentContainer=r,e._blockEntityCollection=!1;else if(d==="kd"&&l)i=p.split(s,3).map(parseFloat),l.diffuseColor=q.FromArray(i);else if(d==="ka"&&l)i=p.split(s,3).map(parseFloat),l.ambientColor=q.FromArray(i);else if(d==="ks"&&l)i=p.split(s,3).map(parseFloat),l.specularColor=q.FromArray(i);else if(d==="ke"&&l)i=p.split(s,3).map(parseFloat),l.emissiveColor=q.FromArray(i);else if(d==="ns"&&l)l.specularPower=parseFloat(p);else if(d==="d"&&l)l.alpha=parseFloat(p);else if(d==="map_ka"&&l)l.ambientTexture=zt._GetTexture(n,p,e);else if(d==="map_kd"&&l)l.diffuseTexture=zt._GetTexture(n,p,e);else if(d==="map_ks"&&l)l.specularTexture=zt._GetTexture(n,p,e);else if(d!=="map_ns")if(d==="map_bump"&&l){const f=p.split(s),g=f.indexOf("-bm");let y=null;g>=0&&(y=f[g+1],f.splice(g,2)),l.bumpTexture=zt._GetTexture(n,f.join(" "),e),l.bumpTexture&&y!==null&&(l.bumpTexture.level=parseFloat(y))}else d==="map_d"&&l&&(l.opacityTexture=zt._GetTexture(n,p,e))}l&&this.materials.push(l)}static _GetTexture(e,t,n){if(!t)return null;let r=e;if(e==="file:"){let o=t.lastIndexOf("\\");o===-1&&(o=t.lastIndexOf("/")),o>-1?r+=t.substring(o+1):r+=t}else r+=t;return new qe(r,n,!1,zt.INVERT_TEXTURE_Y)}}zt.INVERT_TEXTURE_Y=!0;class ke{constructor(e,t,n){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._extColors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new Xt(.5,.5,.5,1),this._hasLineData=!1,this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=n}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});const n=e[t[0]].normals.indexOf(t[1]);return n===-1?-1:e[t[0]].idx[n]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});const n=e[t[0]].normals.indexOf(t[1]);return n!=1&&t[2]===e[t[0]].uv[n]?e[t[0]].idx[n]:-1}_setData(e){e.indiceUvsFromObj??(e.indiceUvsFromObj=-1),e.indiceNormalFromObj??(e.indiceNormalFromObj=-1);let t;this._loadingOptions.optimizeWithUV?t=this._isInArrayUV(this._tuplePosNorm,[e.indicePositionFromObj,e.indiceNormalFromObj,e.indiceUvsFromObj]):t=this._isInArray(this._tuplePosNorm,[e.indicePositionFromObj,e.indiceNormalFromObj]),t===-1?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(e.positionVectorFromOBJ),e.textureVectorFromOBJ!==void 0&&this._wrappedUvsForBabylon.push(e.textureVectorFromOBJ),e.normalsVectorFromOBJ!==void 0&&this._wrappedNormalsForBabylon.push(e.normalsVectorFromOBJ),e.positionColorsFromOBJ!==void 0&&this._wrappedColorsForBabylon.push(e.positionColorsFromOBJ),this._tuplePosNorm[e.indicePositionFromObj].normals.push(e.indiceNormalFromObj),this._tuplePosNorm[e.indicePositionFromObj].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e.indicePositionFromObj].uv.push(e.indiceUvsFromObj)):this._indicesForBabylon.push(t)}_unwrapData(){try{for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x*this._handednessSign,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._wrappedNormalsForBabylon.length&&this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x*this._handednessSign,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._wrappedUvsForBabylon.length&&this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._unwrappedColorsForBabylon.length&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}catch{throw new Error("Unable to unwrap data while parsing OBJ data.")}}_getTriangles(e,t){for(let n=t;n<e.length-1;n++)this._pushTriangle(e,n)}_getColor(e){if(this._loadingOptions.importVertexColors)return this._extColors[e]??this._colors[e]}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=parseInt(this._triangles[n])-1;this._setData({indicePositionFromObj:r,positionVectorFromOBJ:this._positions[r],positionColorsFromOBJ:this._getColor(r)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("/"),o=parseInt(r[0])-1,s=parseInt(r[1])-1;this._setData({indicePositionFromObj:o,indiceUvsFromObj:s,positionVectorFromOBJ:this._positions[o],textureVectorFromOBJ:this._uvs[s],positionColorsFromOBJ:this._getColor(o)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("/"),o=parseInt(r[0])-1,s=parseInt(r[1])-1,i=parseInt(r[2])-1;this._setData({indicePositionFromObj:o,indiceUvsFromObj:s,indiceNormalFromObj:i,positionVectorFromOBJ:this._positions[o],textureVectorFromOBJ:this._uvs[s],normalsVectorFromOBJ:this._normals[i]})}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("//"),o=parseInt(r[0])-1,s=parseInt(r[1])-1;this._setData({indicePositionFromObj:o,indiceNormalFromObj:s,positionVectorFromOBJ:this._positions[o],normalsVectorFromOBJ:this._normals[s],positionColorsFromOBJ:this._getColor(o)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("/"),o=this._positions.length+parseInt(r[0]),s=this._uvs.length+parseInt(r[1]),i=this._normals.length+parseInt(r[2]);this._setData({indicePositionFromObj:o,indiceUvsFromObj:s,indiceNormalFromObj:i,positionVectorFromOBJ:this._positions[o],textureVectorFromOBJ:this._uvs[s],normalsVectorFromOBJ:this._normals[i],positionColorsFromOBJ:this._getColor(o)})}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice()),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon.slice()),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._handledMesh.hasLines=this._hasLineData,this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0,this._hasLineData=!1)}_optimizeNormals(e){const t=e.getVerticesData(Be.PositionKind),n=e.getVerticesData(Be.NormalKind),r={};if(!t||!n)return;for(let s=0;s<t.length/3;s++){const i=t[s*3+0],l=t[s*3+1],h=t[s*3+2],u=i+"_"+l+"_"+h;let c=r[u];c||(c=[],r[u]=c),c.push(s)}const o=new K;for(const s in r){const i=r[s];if(i.length<2)continue;const l=i[0];for(let h=1;h<i.length;++h){const u=i[h];n[l*3+0]+=n[u*3+0],n[l*3+1]+=n[u*3+1],n[l*3+2]+=n[u*3+2]}o.copyFromFloats(n[l*3+0],n[l*3+1],n[l*3+2]),o.normalize();for(let h=0;h<i.length;++h){const u=i[h];n[u*3+0]=o.x,n[u*3+1]=o.y,n[u*3+2]=o.z}}e.setVerticesData(Be.NormalKind,n)}static _IsLineElement(e){return e.startsWith("l")}static _IsObjectElement(e){return e.startsWith("o")}static _IsGroupElement(e){return e.startsWith("g")}static _GetZbrushMRGB(e,t){if(!e.startsWith("mrgb"))return null;if(e=e.replace("mrgb","").trim(),t)return[];const n=/[a-z0-9]/g,r=e.match(n);if(!r||r.length%8!==0)return[];const o=[];for(let s=0;s<r.length/8;s++){const i=r[s*8+2]+r[s*8+3],l=r[s*8+4]+r[s*8+5],h=r[s*8+6]+r[s*8+7];o.push(new Xt(parseInt(i,16)/255,parseInt(l,16)/255,parseInt(h,16)/255,1))}return o}parse(e,t,n,r,o){t=t.replace(/#MRGB/g,"mrgb"),t=t.replace(/#.*$/gm,"").trim(),this._loadingOptions.useLegacyBehavior?(this._pushTriangle=(u,c)=>this._triangles.push(u[0],u[c],u[c+1]),this._handednessSign=1):n.useRightHandedSystem?(this._pushTriangle=(u,c)=>this._triangles.push(u[0],u[c+1],u[c]),this._handednessSign=1):(this._pushTriangle=(u,c)=>this._triangles.push(u[0],u[c],u[c+1]),this._handednessSign=-1);const s=t.split(`
`),i=[];let l=[];i.push(l);for(let u=0;u<s.length;u++){const c=s[u].trim().replace(/\s\s/g," ");if(!(c.length===0||c.charAt(0)==="#"))if((ke._IsGroupElement(c)||ke._IsObjectElement(c))&&(l=[],i.push(l)),ke._IsLineElement(c)){const d=c.split(" ");for(let p=1;p<d.length-1;p++)l.push(`l ${d[p]} ${d[p+1]}`)}else l.push(c)}const h=i.flat();for(let u=0;u<h.length;u++){const c=h[u].trim().replace(/\s\s/g," ");let d;if(!(c.length===0||c.charAt(0)==="#"))if(ke.VertexPattern.test(c)){if(d=c.match(/[^ ]+/g),this._positions.push(new K(parseFloat(d[1]),parseFloat(d[2]),parseFloat(d[3]))),this._loadingOptions.importVertexColors)if(d.length>=7){const p=parseFloat(d[4]),f=parseFloat(d[5]),g=parseFloat(d[6]);this._colors.push(new Xt(p>1?p/255:p,f>1?f/255:f,g>1?g/255:g,d.length===7||d[7]===void 0?1:parseFloat(d[7])))}else this._colors.push(this._grayColor)}else if((d=ke.NormalPattern.exec(c))!==null)this._normals.push(new K(parseFloat(d[1]),parseFloat(d[2]),parseFloat(d[3])));else if((d=ke.UVPattern.exec(c))!==null)this._uvs.push(new Tn(parseFloat(d[1])*this._loadingOptions.UVScaling.x,parseFloat(d[2])*this._loadingOptions.UVScaling.y));else if((d=ke.FacePattern3.exec(c))!==null)this._setDataForCurrentFaceWithPattern3(d[1].trim().split(" "),1);else if((d=ke.FacePattern4.exec(c))!==null)this._setDataForCurrentFaceWithPattern4(d[1].trim().split(" "),1);else if((d=ke.FacePattern5.exec(c))!==null)this._setDataForCurrentFaceWithPattern5(d[1].trim().split(" "),1);else if((d=ke.FacePattern2.exec(c))!==null)this._setDataForCurrentFaceWithPattern2(d[1].trim().split(" "),1);else if((d=ke.FacePattern1.exec(c))!==null)this._setDataForCurrentFaceWithPattern1(d[1].trim().split(" "),1);else if((d=ke.LinePattern1.exec(c))!==null)this._setDataForCurrentFaceWithPattern1(d[1].trim().split(" "),0),this._hasLineData=!0;else if((d=ke.LinePattern2.exec(c))!==null)this._setDataForCurrentFaceWithPattern2(d[1].trim().split(" "),0),this._hasLineData=!0;else if(d=ke._GetZbrushMRGB(c,!this._loadingOptions.importVertexColors))for(const p of d)this._extColors.push(p);else if((d=ke.LinePattern3.exec(c))!==null)this._setDataForCurrentFaceWithPattern3(d[1].trim().split(" "),0),this._hasLineData=!0;else if(ke.GroupDescriptor.test(c)||ke.ObjectDescriptor.test(c)){const p={name:c.substring(2).trim(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:ke.ObjectDescriptor.test(c)};this._addPreviousObjMesh(),this._meshesFromObj.push(p),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(ke.UseMtlDescriptor.test(c)){if(this._materialNameFromObj=c.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const p={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:!1};this._increment++,this._meshesFromObj.push(p),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else ke.MtlLibGroupDescriptor.test(c)?o(c.substring(7).trim()):ke.SmoothDescriptor.test(c)||Me.Log("Unhandled expression at line : "+c)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon),this._handledMesh.hasLines=this._hasLineData),!this._hasMeshes){let u=null;if(this._indicesForBabylon.length)this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData();else{for(const c of this._positions)this._unwrappedPositionsForBabylon.push(c.x,c.y,c.z);if(this._normals.length)for(const c of this._normals)this._unwrappedNormalsForBabylon.push(c.x,c.y,c.z);if(this._uvs.length)for(const c of this._uvs)this._unwrappedUVForBabylon.push(c.x,c.y);if(this._extColors.length)for(const c of this._extColors)this._unwrappedColorsForBabylon.push(c.r,c.g,c.b,c.a);else if(this._colors.length)for(const c of this._colors)this._unwrappedColorsForBabylon.push(c.r,c.g,c.b,c.a);this._materialNameFromObj||(u=new Bt(Jn.RandomId(),n),u.pointsCloud=!0,this._materialNameFromObj=u.name,this._normals.length||(u.disableLighting=!0,u.emissiveColor=q.White()))}this._meshesFromObj.push({name:Jn.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:u,isObject:!0,hasLines:this._hasLineData})}for(let u=0;u<this._meshesFromObj.length;u++){if(e&&this._meshesFromObj[u].name){if(e instanceof Array){if(e.indexOf(this._meshesFromObj[u].name)===-1)continue}else if(this._meshesFromObj[u].name!==e)continue}this._handledMesh=this._meshesFromObj[u],n._blockEntityCollection=!!r;const c=new ot(this._meshesFromObj[u].name,n);if(c._parentContainer=r,n._blockEntityCollection=!1,this._handledMesh._babylonMesh=c,!this._handledMesh.isObject){for(let p=u-1;p>=0;--p)if(this._meshesFromObj[p].isObject&&this._meshesFromObj[p]._babylonMesh){c.parent=this._meshesFromObj[p]._babylonMesh;break}}if(this._materialToUse.push(this._meshesFromObj[u].materialName),this._handledMesh.hasLines&&(c._internalMetadata??(c._internalMetadata={}),c._internalMetadata._isLine=!0),this._handledMesh.positions?.length===0){this._babylonMeshesArray.push(c);continue}const d=new Qn;if(d.indices=this._handledMesh.indices,d.positions=this._handledMesh.positions,this._loadingOptions.computeNormals||!this._handledMesh.normals){const p=new Array;Qn.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,p),d.normals=p}else d.normals=this._handledMesh.normals;this._handledMesh.uvs&&(d.uvs=this._handledMesh.uvs),this._handledMesh.colors&&(d.colors=this._handledMesh.colors),d.applyToMesh(c),this._loadingOptions.invertY&&(c.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(c),this._babylonMeshesArray.push(c),this._handledMesh.directMaterial&&(c.material=this._handledMesh.directMaterial)}}}ke.ObjectDescriptor=/^o/;ke.GroupDescriptor=/^g/;ke.MtlLibGroupDescriptor=/^mtllib /;ke.UseMtlDescriptor=/^usemtl /;ke.SmoothDescriptor=/^s /;ke.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/;ke.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;ke.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;ke.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/;ke.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;ke.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;ke.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/;ke.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/;ke.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/;ke.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;ke.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;const zs={name:"obj",extensions:".obj"};class rt{static get INVERT_TEXTURE_Y(){return zt.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){zt.INVERT_TEXTURE_Y=e}constructor(e){this.name=zs.name,this.extensions=zs.extensions,this._assetContainer=null,this._loadingOptions={...rt._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{computeNormals:rt.COMPUTE_NORMALS,optimizeNormals:rt.OPTIMIZE_NORMALS,importVertexColors:rt.IMPORT_VERTEX_COLORS,invertY:rt.INVERT_Y,invertTextureY:rt.INVERT_TEXTURE_Y,UVScaling:rt.UV_SCALING,materialLoadingFailsSilently:rt.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:rt.OPTIMIZE_WITH_UV,skipMaterials:rt.SKIP_MATERIALS,useLegacyBehavior:rt.USE_LEGACY_BEHAVIOR}}_loadMTL(e,t,n,r){const o=t+e;Ve.LoadFile(o,n,void 0,void 0,!1,(s,i)=>{r(o,i)})}createPlugin(e){return new rt(e[zs.name])}canDirectLoad(){return!1}importMeshAsync(e,t,n,r){return this._parseSolidAsync(e,t,n,r).then(o=>({meshes:o,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}loadAsync(e,t,n){return this.importMeshAsync(null,e,t,n).then(()=>{})}loadAssetContainerAsync(e,t,n){const r=new Un(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,n).then(o=>(o.meshes.forEach(s=>r.meshes.push(s)),o.meshes.forEach(s=>{const i=s.material;i&&r.materials.indexOf(i)==-1&&(r.materials.push(i),i.getActiveTextures().forEach(h=>{r.textures.indexOf(h)==-1&&r.textures.push(h)}))}),this._assetContainer=null,r)).catch(o=>{throw this._assetContainer=null,o})}_parseSolidAsync(e,t,n,r){let o="";const s=new zt,i=[],l=[];n=n.replace(/#.*$/gm,"").trim(),new ke(i,l,this._loadingOptions).parse(e,n,t,this._assetContainer,c=>{o=c});const u=[];return o!==""&&!this._loadingOptions.skipMaterials&&u.push(new Promise((c,d)=>{this._loadMTL(o,r,p=>{try{s.parseMTL(t,p,r,this._assetContainer);for(let f=0;f<s.materials.length;f++){let g=0;const y=[];let m;for(;(m=i.indexOf(s.materials[f].name,g))>-1;)y.push(m),g=m+1;if(m===-1&&y.length===0)s.materials[f].dispose();else for(let _=0;_<y.length;_++){const b=l[y[_]],v=s.materials[f];b.material=v,b.getTotalIndices()||(v.pointsCloud=!0)}}c()}catch(f){Ve.Warn(`Error processing MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?c():d(f)}},(p,f)=>{Ve.Warn(`Error downloading MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?c():d(f)})})),Promise.all(u).then(()=>{const c=d=>!!(d._internalMetadata?._isLine??!1);return l.forEach(d=>{if(c(d)){let p=d.material??new Bt(d.name+"_line",t);p.getBindedMeshes().filter(g=>!c(g)).length>0&&(p=p.clone(p.name+"_line")??p),p.wireframe=!0,d.material=p,d._internalMetadata&&(d._internalMetadata._isLine=void 0)}}),l})}}rt.OPTIMIZE_WITH_UV=!0;rt.INVERT_Y=!1;rt.IMPORT_VERTEX_COLORS=!1;rt.COMPUTE_NORMALS=!1;rt.OPTIMIZE_NORMALS=!1;rt.UV_SCALING=new Tn(1,1);rt.SKIP_MATERIALS=!1;rt.MATERIAL_LOADING_FAILS_SILENTLY=!0;rt.USE_LEGACY_BEHAVIOR=!1;zn(new rt);const Uo={name:"stl",extensions:{".stl":{isBinary:!0}}};class An{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name=Uo.name,this.extensions=Uo.extensions}importMesh(e,t,n,r,o){let s;if(typeof n!="string"){if(this._isBinary(n)){const i=new ot("stlmesh",t);return this._parseBinary(i,n),o&&o.push(i),!0}n=new TextDecoder().decode(new Uint8Array(n))}for(;s=this.solidPattern.exec(n);){let i=s[1];const l=s[3];if(l&&i!=l)return Ve.Error("Error in STL, solid name != endsolid name"),!1;if(e&&i){if(e instanceof Array){if(!e.indexOf(i))continue}else if(i!==e)continue}i=i||"stlmesh";const h=new ot(i,t);this._parseASCII(h,s[2]),o&&o.push(h)}return!0}load(e,t,n){return this.importMesh(null,e,t,n,null)}loadAssetContainer(e,t,n){const r=new Un(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,n,r.meshes),e._blockEntityCollection=!1,r}_isBinary(e){const t=new DataView(e);if(t.byteLength<=80)return!1;const n=32/8*3+32/8*3*3+16/8,r=t.getUint32(80,!0);if(80+32/8+r*n===t.byteLength)return!0;const o=[115,111,108,105,100];for(let s=0;s<5;s++)if(t.getUint8(s)!==o[s])return!0;return!1}_parseBinary(e,t){const n=new DataView(t),r=n.getUint32(80,!0),o=84,s=50;let i=0;const l=new Float32Array(r*3*3),h=new Float32Array(r*3*3),u=new Uint32Array(r*3);let c=0;for(let d=0;d<r;d++){const p=o+d*s,f=n.getFloat32(p,!0),g=n.getFloat32(p+4,!0),y=n.getFloat32(p+8,!0);for(let m=1;m<=3;m++){const _=p+m*12;l[i]=n.getFloat32(_,!0),h[i]=f,An.DO_NOT_ALTER_FILE_COORDINATES?(l[i+1]=n.getFloat32(_+4,!0),l[i+2]=n.getFloat32(_+8,!0),h[i+1]=g,h[i+2]=y):(l[i+2]=n.getFloat32(_+4,!0),l[i+1]=n.getFloat32(_+8,!0),h[i+2]=g,h[i+1]=y),i+=3}An.DO_NOT_ALTER_FILE_COORDINATES?(u[c]=c,u[c+1]=c+2,u[c+2]=c+1,c+=3):(u[c]=c++,u[c]=c++,u[c]=c++)}e.setVerticesData(Be.PositionKind,l),e.setVerticesData(Be.NormalKind,h),e.setIndices(u),e.computeWorldMatrix(!0)}_parseASCII(e,t){const n=[],r=[],o=[];let s=0,i;for(;i=this.facetsPattern.exec(t);){const l=i[1],h=this.normalPattern.exec(l);if(this.normalPattern.lastIndex=0,!h)continue;const u=[Number(h[1]),Number(h[5]),Number(h[3])];let c;for(;c=this.vertexPattern.exec(l);)An.DO_NOT_ALTER_FILE_COORDINATES?(n.push(Number(c[1]),Number(c[3]),Number(c[5])),r.push(u[0],u[2],u[1])):(n.push(Number(c[1]),Number(c[5]),Number(c[3])),r.push(u[0],u[1],u[2]));An.DO_NOT_ALTER_FILE_COORDINATES?(o.push(s,s+2,s+1),s+=3):o.push(s++,s++,s++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(Be.PositionKind,n),e.setVerticesData(Be.NormalKind,r),e.setIndices(o),e.computeWorldMatrix(!0)}}An.DO_NOT_ALTER_FILE_COORDINATES=!1;zn(new An);const Us={name:"splat",extensions:{".splat":{isBinary:!0},".ply":{isBinary:!0},".spz":{isBinary:!0},".json":{isBinary:!1},".sog":{isBinary:!0}}};function Va(a,e,t){const n=new Uint8Array(a),r=new Uint32Array(a.slice(0,12)),o=r[2],s=n[12],i=n[13],l=n[14],h=n[15],u=r[1];if(h||r[0]!=1347635022||u!=2&&u!=3)return new Promise(B=>{B({mode:3,data:d,hasVertexColors:!1})});const c=32,d=new ArrayBuffer(c*o),p=1/(1<<i),f=new Int32Array(1),g=new Uint8Array(f.buffer),y=function(B,C){return g[0]=B[C+0],g[1]=B[C+1],g[2]=B[C+2],g[3]=B[C+2]&128?255:0,f[0]*p};let m=16;const _=new Float32Array(d),b=new Float32Array(d),v=new Uint8ClampedArray(d),w=new Uint8ClampedArray(d);let I=1,F=0;t.flipY||(I=-1,F=255);for(let B=0;B<o;B++)_[B*8+0]=y(n,m+0),_[B*8+1]=I*y(n,m+3),_[B*8+2]=I*y(n,m+6),m+=9;const M=.282;for(let B=0;B<o;B++){for(let C=0;C<3;C++){const N=(n[m+o+B*3+C]-127.5)/(.15*255);v[B*32+24+C]=Ln.Clamp((.5+M*N)*255,0,255)}v[B*32+24+3]=n[m+B]}m+=o*4;for(let B=0;B<o;B++)b[B*8+3+0]=Math.exp(n[m+0]/16-10),b[B*8+3+1]=Math.exp(n[m+1]/16-10),b[B*8+3+2]=Math.exp(n[m+2]/16-10),m+=3;if(u>=3){const B=Math.SQRT1_2;for(let C=0;C<o;C++){const A=[n[m+0],n[m+1],n[m+2],n[m+3]],N=A[0]+(A[1]<<8)+(A[2]<<16)+(A[3]<<24),V=511,U=[],X=N>>>30;let ue=N,R=0;for(let D=3;D>=0;--D)if(D!==X){const S=ue&V,G=ue>>>9&1;ue=ue>>>10,U[D]=B*(S/V),G===1&&(U[D]=-U[D]),R+=U[D]*U[D]}const P=1-R;U[X]=Math.sqrt(Math.max(P,0)),U[1]*=I,U[2]*=I;const Q=[3,0,1,2];for(let D=0;D<4;D++)w[C*32+28+D]=Math.round(127.5+U[Q[D]]*127.5);m+=4}}else for(let B=0;B<o;B++){const C=n[m+0],A=n[m+1]*I+F,N=n[m+2]*I+F,V=C/127.5-1,U=A/127.5-1,X=N/127.5-1;w[B*32+28+1]=C,w[B*32+28+2]=A,w[B*32+28+3]=N;const ue=1-(V*V+U*U+X*X);w[B*32+28+0]=127.5+Math.sqrt(ue<0?0:ue)*127.5,m+=3}if(s){const C=((s+1)*(s+1)-1)*3,A=Math.ceil(C/16);let N=m;const V=[],X=e.getEngine().getCaps().maxTextureSize,ue=Math.ceil(o/X);for(let R=0;R<A;R++){const P=new Uint8Array(ue*X*4*4);V.push(P)}for(let R=0;R<o;R++)for(let P=0;P<C;P++){const Q=n[N++],D=Math.floor(P/16),S=V[D],G=P%16,E=R*16;S[G+E]=Q}return new Promise(R=>{R({mode:0,data:d,hasVertexColors:!1,sh:V,trainedWithAntialiasing:!!l})})}return new Promise(B=>{B({mode:0,data:d,hasVertexColors:!1,trainedWithAntialiasing:!!l})})}const Wo=.28209479177387814;async function qo(a,e,t){return await new Promise((r,o)=>{const s=t.createCanvasImage();if(!s)throw new Error("Failed to create ImageBitmap");s.onload=()=>{try{const l=t.createCanvas(s.width,s.height);if(!l)throw new Error("Failed to create canvas");const h=l.getContext("2d");if(!h)throw new Error("Failed to get 2D context");h.drawImage(s,0,0);const u=h.getImageData(0,0,l.width,l.height);r({bits:new Uint8Array(u.data.buffer),width:u.width})}catch(l){o(`Error loading image ${s.src} with exception: ${l}`)}},s.onerror=l=>{o(`Error loading image ${s.src} with exception: ${l}`)},s.crossOrigin="anonymous";let i;if(typeof a=="string"){if(!e)throw new Error("filename is required when using a URL");s.src=a+e}else{const l=new Blob([a],{type:"image/webp"});i=URL.createObjectURL(l),s.src=i}})}async function Ga(a,e,t){const n=a.count?a.count:a.means.shape[0],r=32,o=new ArrayBuffer(r*n),s=new Float32Array(o),i=new Float32Array(o),l=new Uint8ClampedArray(o),h=new Uint8ClampedArray(o),u=m=>Math.sign(m)*(Math.exp(Math.abs(m))-1),c=e[0].bits,d=e[1].bits;if(!Array.isArray(a.means.mins)||!Array.isArray(a.means.maxs))throw new Error("Missing arrays in SOG data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=a.means.mins[b],w=a.means.maxs[b],I=d[_+b],F=c[_+b],M=I<<8|F,B=Ln.Lerp(v,w,M/65535);s[m*8+b]=u(B)}}const p=e[2].bits;if(a.version===2){if(!a.scales.codebook)throw new Error("Missing codebook in SOG version 2 scales data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=a.scales.codebook[p[_+b]],w=Math.exp(v);i[m*8+3+b]=w}}}else{if(!Array.isArray(a.scales.mins)||!Array.isArray(a.scales.maxs))throw new Error("Missing arrays in SOG scales data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=p[_+b],w=Ln.Lerp(a.scales.mins[b],a.scales.maxs[b],v/255),I=Math.exp(w);i[m*8+3+b]=I}}}const f=e[4].bits;if(a.version===2){if(!a.sh0.codebook)throw new Error("Missing codebook in SOG version 2 sh0 data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=.5+a.sh0.codebook[f[_+b]]*Wo;l[m*32+24+b]=Math.max(0,Math.min(255,Math.round(255*v)))}l[m*32+24+3]=f[_+3]}}else{if(!Array.isArray(a.sh0.mins)||!Array.isArray(a.sh0.maxs))throw new Error("Missing arrays in SOG sh0 data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<4;b++){const v=a.sh0.mins[b],w=a.sh0.maxs[b],I=f[_+b],F=Ln.Lerp(v,w,I/255);let M;b<3?M=.5+F*Wo:M=1/(1+Math.exp(-F)),l[m*32+24+b]=Math.max(0,Math.min(255,Math.round(255*M)))}}}const g=m=>(m/255-.5)*2/Math.SQRT2,y=e[3].bits;for(let m=0;m<n;m++){const _=y[m*4+0],b=y[m*4+1],v=y[m*4+2],w=y[m*4+3],I=g(_),F=g(b),M=g(v),B=w-252,C=I*I+F*F+M*M,A=Math.sqrt(Math.max(0,1-C));let N;switch(B){case 0:N=[A,I,F,M];break;case 1:N=[I,A,F,M];break;case 2:N=[I,F,A,M];break;case 3:N=[I,F,M,A];break;default:throw new Error("Invalid quaternion mode")}h[m*32+28+0]=N[0]*127.5+127.5,h[m*32+28+1]=N[1]*127.5+127.5,h[m*32+28+2]=N[2]*127.5+127.5,h[m*32+28+3]=N[3]*127.5+127.5}if(a.shN){const m=[0,3,8,15],_=a.shN.bands?m[a.shN.bands]:a.shN.shape[1]/3,b=e[5].bits,v=e[6].bits,w=e[5].width,I=_*3,F=Math.ceil(I/16),M=[],C=t.getEngine().getCaps().maxTextureSize,A=Math.ceil(n/C);for(let N=0;N<F;N++){const V=new Uint8Array(A*C*4*4);M.push(V)}if(a.version===2){if(!a.shN.codebook)throw new Error("Missing codebook in SOG version 2 shN data.");for(let N=0;N<n;N++){const V=v[N*4+0]+(v[N*4+1]<<8),U=V%64*_,X=Math.floor(V/64);for(let ue=0;ue<_;ue++)for(let R=0;R<3;R++){const P=ue*3+R,Q=Math.floor(P/16),D=M[Q],S=P%16,G=N*16,E=a.shN.codebook[b[(U+ue)*4+R+X*w*4]]*127.5+127.5;D[S+G]=Math.max(0,Math.min(255,E))}}}else for(let N=0;N<n;N++){const V=v[N*4+0]+(v[N*4+1]<<8),U=V%64*_,X=Math.floor(V/64),ue=a.shN.mins,R=a.shN.maxs;for(let P=0;P<3;P++)for(let Q=0;Q<_/3;Q++){const D=Q*3+P,S=Math.floor(D/16),G=M[S],E=D%16,T=N*16,x=Ln.Lerp(ue,R,b[(U+Q)*4+P+X*w*4]/255)*127.5+127.5;G[E+T]=Math.max(0,Math.min(255,x))}}return await new Promise(N=>{N({mode:0,data:o,hasVertexColors:!1,sh:M})})}return await new Promise(m=>{m({mode:0,data:o,hasVertexColors:!1})})}async function Ko(a,e,t){let n,r;if(a instanceof Map){r=a;const i=r.get("meta.json");if(!i)throw new Error("meta.json not found in files Map");n=JSON.parse(new TextDecoder().decode(i))}else n=a;const o=[...n.means.files,...n.scales.files,...n.quats.files,...n.sh0.files];n.shN&&o.push(...n.shN.files);const s=await Promise.all(o.map(async i=>{if(r&&r.has(i)){const l=r.get(i);return await qo(l,i,t.getEngine())}else return await qo(e,i,t.getEngine())}));return await Ga(n,s,t)}class hn{constructor(e=hn._DefaultLoadingOptions){this.name=Us.name,this._assetContainer=null,this.extensions=Us.extensions,this._loadingOptions=e}createPlugin(e){return new hn(e[Us.name])}async importMeshAsync(e,t,n,r,o,s){return await this._parseAsync(e,t,n,r).then(i=>({meshes:i,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}static _BuildPointCloud(e,t){if(!t.byteLength)return!1;const n=new Uint8Array(t),r=new Float32Array(t),o=32,s=n.length/o,i=function(l,h){const u=r[8*h+0],c=r[8*h+1],d=r[8*h+2];l.position=new K(u,c,d);const p=n[o*h+24+0]/255,f=n[o*h+24+1]/255,g=n[o*h+24+2]/255;l.color=new Xt(p,f,g,1)};return e.addPoints(s,i),!0}static _BuildMesh(e,t){const n=new ot("PLYMesh",e),r=new Uint8Array(t.data),o=new Float32Array(t.data),s=32,i=r.length/s,l=[],h=new Qn;for(let u=0;u<i;u++){const c=o[8*u+0],d=o[8*u+1],p=o[8*u+2];l.push(c,d,p)}if(t.hasVertexColors){const u=new Float32Array(i*4);for(let c=0;c<i;c++){const d=r[s*c+24+0]/255,p=r[s*c+24+1]/255,f=r[s*c+24+2]/255;u[c*4+0]=d,u[c*4+1]=p,u[c*4+2]=f,u[c*4+3]=1}h.colors=u}return h.positions=l,h.indices=t.faces,h.applyToMesh(n),n}async _unzipWithFFlateAsync(e){let t=this._loadingOptions.fflate;t||(typeof window.fflate>"u"&&await Ve.LoadScriptAsync(this._loadingOptions.deflateURL??"https://unpkg.com/fflate/umd/index.js"),t=window.fflate);const{unzipSync:n}=t,r=n(e),o=new Map;for(const[s,i]of Object.entries(r))o.set(s,i);return o}_parseAsync(e,t,n,r){const o=[],s=c=>{t._blockEntityCollection=!!this._assetContainer;const d=new qn("GaussianSplatting",null,t,this._loadingOptions.keepInRam);d._parentContainer=this._assetContainer,d.viewDirectionFactor.set(1,-1,1),o.push(d),d.updateData(c.data,c.sh),t._blockEntityCollection=!1};if(typeof n=="string"){const c=JSON.parse(n);if(c&&c.means&&c.scales&&c.quats&&c.sh0)return new Promise(d=>{Ko(c,r,t).then(p=>{s(p),d(o)}).catch(()=>{throw new Error("Failed to parse SOG data.")})})}const i=n instanceof ArrayBuffer?new Uint8Array(n):n;if(i[0]===80&&i[1]===75)return new Promise(c=>{this._unzipWithFFlateAsync(i).then(d=>{Ko(d,r,t).then(p=>{s(p),c(o)}).catch(()=>{throw new Error("Failed to parse SOG zip data.")})})});const l=new ReadableStream({start(c){c.enqueue(new Uint8Array(n)),c.close()}}),h=new DecompressionStream("gzip"),u=l.pipeThrough(h);return new Promise(c=>{new Response(u).arrayBuffer().then(d=>{Va(d,t,this._loadingOptions).then(p=>{t._blockEntityCollection=!!this._assetContainer;const f=new qn("GaussianSplatting",null,t,this._loadingOptions.keepInRam);if(p.trainedWithAntialiasing){const g=f.material;g.kernelSize=.1,g.compensation=!0}f._parentContainer=this._assetContainer,o.push(f),f.updateData(p.data,p.sh),t._blockEntityCollection=!1,c(o)})}).catch(()=>{hn._ConvertPLYToSplat(n).then(async d=>{switch(t._blockEntityCollection=!!this._assetContainer,d.mode){case 0:{const p=new qn("GaussianSplatting",null,t,this._loadingOptions.keepInRam);p._parentContainer=this._assetContainer,o.push(p),p.updateData(d.data,d.sh),(d.compressed||!d.rawSplat)&&p.viewDirectionFactor.set(-1,-1,1)}break;case 1:{const p=new Zr("PointCloud",1,t);hn._BuildPointCloud(p,d.data)?await p.buildMeshAsync().then(f=>{o.push(f)}):p.dispose()}break;case 2:if(d.faces)o.push(hn._BuildMesh(t,d));else throw new Error("PLY mesh doesn't contain face informations.");break;default:throw new Error("Unsupported Splat mode")}t._blockEntityCollection=!1,c(o)})})})}loadAssetContainerAsync(e,t,n){const r=new Un(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,n).then(o=>{for(const s of o.meshes)r.meshes.push(s);return this._assetContainer=null,r}).catch(o=>{throw this._assetContainer=null,o})}loadAsync(e,t,n){return this.importMeshAsync(null,e,t,n).then(()=>{})}static _ConvertPLYToSplat(e){const t=new Uint8Array(e),n=new TextDecoder().decode(t.slice(0,1024*10)),r=`end_header
`,o=n.indexOf(r);if(o<0||!n)return new Promise(v=>{v({mode:0,data:e,rawSplat:!0})});const s=parseInt(/element vertex (\d+)\n/.exec(n)[1]),i=/element face (\d+)\n/.exec(n);let l=0;i&&(l=parseInt(i[1]));const h=/element chunk (\d+)\n/.exec(n);let u=0;h&&(u=parseInt(h[1]));let c=0,d=0;const p={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let f;(function(v){v[v.Vertex=0]="Vertex",v[v.Chunk=1]="Chunk",v[v.SH=2]="SH"})(f||(f={}));let g=1;const y=[],m=n.slice(0,o).split(`
`);for(const v of m)if(v.startsWith("property ")){const[,w,I]=v.split(" ");g==1?d+=p[w]:g==0?(y.push({name:I,type:w,offset:c}),c+=p[w]):g==2&&y.push({name:I,type:w,offset:c}),p[w]||Me.Warn(`Unsupported property type: ${w}.`)}else if(v.startsWith("element ")){const[,w]=v.split(" ");w=="chunk"?g=1:w=="vertex"?g=0:w=="sh"&&(g=2)}const _=c,b=d;return qn.ConvertPLYWithSHToSplatAsync(e).then(async v=>{const w=new DataView(e,o+r.length);let I=b*u+_*s;const F=[];if(l)for(let U=0;U<l;U++){const X=w.getUint8(I);if(X==3){I+=1;for(let ue=0;ue<X;ue++){const R=w.getUint32(I+(2-ue)*4,!0);F.push(R)}I+=12}}if(u)return await new Promise(U=>{U({mode:0,data:v.buffer,sh:v.sh,faces:F,hasVertexColors:!1,compressed:!0,rawSplat:!1})});let M=0,B=0;const C=["x","y","z","scale_0","scale_1","scale_2","opacity","rot_0","rot_1","rot_2","rot_3"],A=["red","green","blue","f_dc_0","f_dc_1","f_dc_2"];for(let U=0;U<y.length;U++){const X=y[U];C.includes(X.name)&&M++,A.includes(X.name)&&B++}const N=M==C.length&&B==3,V=l?2:N?0:1;return await new Promise(U=>{U({mode:V,data:v.buffer,sh:v.sh,faces:F,hasVertexColors:!!B,compressed:!1,rawSplat:!1})})})}}hn._DefaultLoadingOptions={keepInRam:!1,flipY:!1};zn(new hn);function Da(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Yn(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ws={exports:{}},jo;function $a(){return jo||(jo=1,(function(a,e){(function(t){a.exports=t()})(function(){return(function t(n,r,o){function s(h,u){if(!r[h]){if(!n[h]){var c=typeof Yn=="function"&&Yn;if(!u&&c)return c(h,!0);if(i)return i(h,!0);throw new Error("Cannot find module '"+h+"'")}var d=r[h]={exports:{}};n[h][0].call(d.exports,function(p){var f=n[h][1][p];return s(f||p)},d,d.exports,t,n,r,o)}return r[h].exports}for(var i=typeof Yn=="function"&&Yn,l=0;l<o.length;l++)s(o[l]);return s})({1:[function(t,n,r){n.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,n,r){n.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,n,r){var o=t("../math/Vec3");t("../utils/Utils"),n.exports=s;function s(h){h=h||{},this.lowerBound=new o,h.lowerBound&&this.lowerBound.copy(h.lowerBound),this.upperBound=new o,h.upperBound&&this.upperBound.copy(h.upperBound)}var i=new o;s.prototype.setFromPoints=function(h,u,c,d){var p=this.lowerBound,f=this.upperBound,g=c;p.copy(h[0]),g&&g.vmult(p,p),f.copy(p);for(var y=1;y<h.length;y++){var m=h[y];g&&(g.vmult(m,i),m=i),m.x>f.x&&(f.x=m.x),m.x<p.x&&(p.x=m.x),m.y>f.y&&(f.y=m.y),m.y<p.y&&(p.y=m.y),m.z>f.z&&(f.z=m.z),m.z<p.z&&(p.z=m.z)}return u&&(u.vadd(p,p),u.vadd(f,f)),d&&(p.x-=d,p.y-=d,p.z-=d,f.x+=d,f.y+=d,f.z+=d),this},s.prototype.copy=function(h){return this.lowerBound.copy(h.lowerBound),this.upperBound.copy(h.upperBound),this},s.prototype.clone=function(){return new s().copy(this)},s.prototype.extend=function(h){var u=h.lowerBound.x;this.lowerBound.x>u&&(this.lowerBound.x=u);var c=h.upperBound.x;this.upperBound.x<c&&(this.upperBound.x=c);var u=h.lowerBound.y;this.lowerBound.y>u&&(this.lowerBound.y=u);var c=h.upperBound.y;this.upperBound.y<c&&(this.upperBound.y=c);var u=h.lowerBound.z;this.lowerBound.z>u&&(this.lowerBound.z=u);var c=h.upperBound.z;this.upperBound.z<c&&(this.upperBound.z=c)},s.prototype.overlaps=function(h){var u=this.lowerBound,c=this.upperBound,d=h.lowerBound,p=h.upperBound;return(d.x<=c.x&&c.x<=p.x||u.x<=p.x&&p.x<=c.x)&&(d.y<=c.y&&c.y<=p.y||u.y<=p.y&&p.y<=c.y)&&(d.z<=c.z&&c.z<=p.z||u.z<=p.z&&p.z<=c.z)},s.prototype.contains=function(h){var u=this.lowerBound,c=this.upperBound,d=h.lowerBound,p=h.upperBound;return u.x<=d.x&&c.x>=p.x&&u.y<=d.y&&c.y>=p.y&&u.z<=d.z&&c.z>=p.z},s.prototype.getCorners=function(h,u,c,d,p,f,g,y){var m=this.lowerBound,_=this.upperBound;h.copy(m),u.set(_.x,m.y,m.z),c.set(_.x,_.y,m.z),d.set(m.x,_.y,_.z),p.set(_.x,m.y,m.z),f.set(m.x,_.y,m.z),g.set(m.x,m.y,_.z),y.copy(_)};var l=[new o,new o,new o,new o,new o,new o,new o,new o];s.prototype.toLocalFrame=function(h,u){var c=l,d=c[0],p=c[1],f=c[2],g=c[3],y=c[4],m=c[5],_=c[6],b=c[7];this.getCorners(d,p,f,g,y,m,_,b);for(var v=0;v!==8;v++){var w=c[v];h.pointToLocal(w,w)}return u.setFromPoints(c)},s.prototype.toWorldFrame=function(h,u){var c=l,d=c[0],p=c[1],f=c[2],g=c[3],y=c[4],m=c[5],_=c[6],b=c[7];this.getCorners(d,p,f,g,y,m,_,b);for(var v=0;v!==8;v++){var w=c[v];h.pointToWorld(w,w)}return u.setFromPoints(c)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,n,r){n.exports=o;function o(){this.matrix=[]}o.prototype.get=function(s,i){if(s=s.index,i=i.index,i>s){var l=i;i=s,s=l}return this.matrix[(s*(s+1)>>1)+i-1]},o.prototype.set=function(s,i,l){if(s=s.index,i=i.index,i>s){var h=i;i=s,s=h}this.matrix[(s*(s+1)>>1)+i-1]=l?1:0},o.prototype.reset=function(){for(var s=0,i=this.matrix.length;s!==i;s++)this.matrix[s]=0},o.prototype.setNumObjects=function(s){this.matrix.length=s*(s-1)>>1}},{}],5:[function(t,n,r){var o=t("../objects/Body"),s=t("../math/Vec3"),i=t("../math/Quaternion");t("../shapes/Shape"),t("../shapes/Plane"),n.exports=l;function l(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}l.prototype.collisionPairs=function(g,y,m){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var h=o.STATIC|o.KINEMATIC;l.prototype.needBroadphaseCollision=function(g,y){return!((g.collisionFilterGroup&y.collisionFilterMask)===0||(y.collisionFilterGroup&g.collisionFilterMask)===0||((g.type&h)!==0||g.sleepState===o.SLEEPING)&&((y.type&h)!==0||y.sleepState===o.SLEEPING))},l.prototype.intersectionTest=function(g,y,m,_){this.useBoundingBoxes?this.doBoundingBoxBroadphase(g,y,m,_):this.doBoundingSphereBroadphase(g,y,m,_)};var u=new s;new s,new i,new s,l.prototype.doBoundingSphereBroadphase=function(g,y,m,_){var b=u;y.position.vsub(g.position,b);var v=Math.pow(g.boundingRadius+y.boundingRadius,2),w=b.norm2();w<v&&(m.push(g),_.push(y))},l.prototype.doBoundingBoxBroadphase=function(g,y,m,_){g.aabbNeedsUpdate&&g.computeAABB(),y.aabbNeedsUpdate&&y.computeAABB(),g.aabb.overlaps(y.aabb)&&(m.push(g),_.push(y))};var c={keys:[]},d=[],p=[];l.prototype.makePairsUnique=function(g,y){for(var m=c,_=d,b=p,v=g.length,w=0;w!==v;w++)_[w]=g[w],b[w]=y[w];g.length=0,y.length=0;for(var w=0;w!==v;w++){var I=_[w].id,F=b[w].id,M=I<F?I+","+F:F+","+I;m[M]=w,m.keys.push(M)}for(var w=0;w!==m.keys.length;w++){var M=m.keys.pop(),B=m[M];g.push(_[B]),y.push(b[B]),delete m[M]}},l.prototype.setWorld=function(g){};var f=new s;l.boundingSphereCheck=function(g,y){var m=f;return g.position.vsub(y.position,m),Math.pow(g.shape.boundingSphereRadius+y.shape.boundingSphereRadius,2)>m.norm2()},l.prototype.aabbQuery=function(g,y,m){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,n,r){n.exports=l;var o=t("./Broadphase"),s=t("../math/Vec3"),i=t("../shapes/Shape");function l(u,c,d,p,f){o.apply(this),this.nx=d||10,this.ny=p||10,this.nz=f||10,this.aabbMin=u||new s(100,100,100),this.aabbMax=c||new s(-100,-100,-100);var g=this.nx*this.ny*this.nz;if(g<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=g,this.binLengths.length=g;for(var y=0;y<g;y++)this.bins[y]=[],this.binLengths[y]=0}l.prototype=new o,l.prototype.constructor=l;var h=new s;new s,l.prototype.collisionPairs=function(u,c,d){var p=u.numObjects(),f=u.bodies,J=this.aabbMax,L=this.aabbMin,g=this.nx,y=this.ny,m=this.nz,_=y*m,b=m,v=1,w=J.x,I=J.y,F=J.z,M=L.x,B=L.y,C=L.z,A=g/(w-M),N=y/(I-B),V=m/(F-C),U=(w-M)/g,X=(I-B)/y,ue=(F-C)/m,R=Math.sqrt(U*U+X*X+ue*ue)*.5,P=i.types,Q=P.SPHERE,D=P.PLANE;P.BOX,P.COMPOUND,P.CONVEXPOLYHEDRON;for(var S=this.bins,G=this.binLengths,E=this.bins.length,T=0;T!==E;T++)G[T]=0;var x=Math.ceil,L=Math.min,J=Math.max;function z(Qt,an,Jt,Ft,Lt,mn,ln){var Kt=(Qt-M)*A|0,Dt=(an-B)*N|0,It=(Jt-C)*V|0,jt=x((Ft-M)*A),$t=x((Lt-B)*N),xt=x((mn-C)*V);Kt<0?Kt=0:Kt>=g&&(Kt=g-1),Dt<0?Dt=0:Dt>=y&&(Dt=y-1),It<0?It=0:It>=m&&(It=m-1),jt<0?jt=0:jt>=g&&(jt=g-1),$t<0?$t=0:$t>=y&&($t=y-1),xt<0?xt=0:xt>=m&&(xt=m-1),Kt*=_,Dt*=b,It*=v,jt*=_,$t*=b,xt*=v;for(var yn=Kt;yn<=jt;yn+=_)for(var gn=Dt;gn<=$t;gn+=b)for(var vn=It;vn<=xt;vn+=v){var En=yn+gn+vn;S[En][G[En]++]=ln}}for(var T=0;T!==p;T++){var O=f[T],W=O.shape;switch(W.type){case Q:var te=O.position.x,Ae=O.position.y,ve=O.position.z,me=W.radius;z(te-me,Ae-me,ve-me,te+me,Ae+me,ve+me,O);break;case D:W.worldNormalNeedsUpdate&&W.computeWorldNormal(O.quaternion);var j=W.worldNormal,se=M+U*.5-O.position.x,$e=B+X*.5-O.position.y,Ee=C+ue*.5-O.position.z,Qe=h;Qe.set(se,$e,Ee);for(var we=0,Ke=0;we!==g;we++,Ke+=_,Qe.y=$e,Qe.x+=U)for(var Xe=0,je=0;Xe!==y;Xe++,je+=b,Qe.z=Ee,Qe.y+=X)for(var Ze=0,He=0;Ze!==m;Ze++,He+=v,Qe.z+=ue)if(Qe.dot(j)<R){var tt=Ke+je+He;S[tt][G[tt]++]=O}break;default:O.aabbNeedsUpdate&&O.computeAABB(),z(O.aabb.lowerBound.x,O.aabb.lowerBound.y,O.aabb.lowerBound.z,O.aabb.upperBound.x,O.aabb.upperBound.y,O.aabb.upperBound.z,O);break}}for(var T=0;T!==E;T++){var ze=G[T];if(ze>1)for(var ut=S[T],we=0;we!==ze;we++)for(var O=ut[we],Xe=0;Xe!==we;Xe++){var Tt=ut[Xe];this.needBroadphaseCollision(O,Tt)&&this.intersectionTest(O,Tt,c,d)}}this.makePairsUnique(c,d)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,n,r){n.exports=i;var o=t("./Broadphase"),s=t("./AABB");function i(){o.apply(this)}i.prototype=new o,i.prototype.constructor=i,i.prototype.collisionPairs=function(l,h,u){var c=l.bodies,d=c.length,p,f,g,y;for(p=0;p!==d;p++)for(f=0;f!==p;f++)g=c[p],y=c[f],this.needBroadphaseCollision(g,y)&&this.intersectionTest(g,y,h,u)},new s,i.prototype.aabbQuery=function(l,h,u){u=u||[];for(var c=0;c<l.bodies.length;c++){var d=l.bodies[c];d.aabbNeedsUpdate&&d.computeAABB(),d.aabb.overlaps(h)&&u.push(d)}return u}},{"./AABB":3,"./Broadphase":5}],8:[function(t,n,r){n.exports=o;function o(){this.matrix={}}o.prototype.get=function(s,i){if(s=s.id,i=i.id,i>s){var l=i;i=s,s=l}return s+"-"+i in this.matrix},o.prototype.set=function(s,i,l){if(s=s.id,i=i.id,i>s){var h=i;i=s,s=h}l?this.matrix[s+"-"+i]=!0:delete this.matrix[s+"-"+i]},o.prototype.reset=function(){this.matrix={}},o.prototype.setNumObjects=function(s){}},{}],9:[function(t,n,r){n.exports=c;var o=t("../math/Vec3"),s=t("../math/Quaternion"),i=t("../math/Transform");t("../shapes/ConvexPolyhedron"),t("../shapes/Box");var l=t("../collision/RaycastResult"),h=t("../shapes/Shape"),u=t("../collision/AABB");function c(E,T){this.from=E?E.clone():new o,this.to=T?T.clone():new o,this._direction=new o,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new l,this.hasHit=!1,this.callback=function(x){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var d=new u,p=[];c.prototype.intersectWorld=function(E,T){return this.mode=T.mode||c.ANY,this.result=T.result||new l,this.skipBackfaces=!!T.skipBackfaces,this.collisionFilterMask=typeof T.collisionFilterMask<"u"?T.collisionFilterMask:-1,this.collisionFilterGroup=typeof T.collisionFilterGroup<"u"?T.collisionFilterGroup:-1,T.from&&this.from.copy(T.from),T.to&&this.to.copy(T.to),this.callback=T.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(d),p.length=0,E.broadphase.aabbQuery(E,d,p),this.intersectBodies(p),this.hasHit};var f=new o,g=new o;c.pointInTriangle=y;function y(E,T,x,L){L.vsub(T,D),x.vsub(T,f),E.vsub(T,g);var J=D.dot(D),z=D.dot(f),O=D.dot(g),W=f.dot(f),te=f.dot(g),Ae,ve;return(Ae=W*O-z*te)>=0&&(ve=J*te-z*O)>=0&&Ae+ve<J*W-z*z}var m=new o,_=new s;c.prototype.intersectBody=function(E,T){T&&(this.result=T,this._updateDirection());var x=this.checkCollisionResponse;if(!(x&&!E.collisionResponse)&&!((this.collisionFilterGroup&E.collisionFilterMask)===0||(E.collisionFilterGroup&this.collisionFilterMask)===0))for(var L=m,J=_,z=0,O=E.shapes.length;z<O;z++){var W=E.shapes[z];if(!(x&&!W.collisionResponse)&&(E.quaternion.mult(E.shapeOrientations[z],J),E.quaternion.vmult(E.shapeOffsets[z],L),L.vadd(E.position,L),this.intersectShape(W,J,L,E),this.result._shouldStop))break}},c.prototype.intersectBodies=function(E,T){T&&(this.result=T,this._updateDirection());for(var x=0,L=E.length;!this.result._shouldStop&&x<L;x++)this.intersectBody(E[x])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(E,T,x,L){var J=this.from,z=G(J,this._direction,x);if(!(z>E.boundingSphereRadius)){var O=this[E.type];O&&O.call(this,E,T,x,L)}},new o,new o;var b=new o,v=new o,w=new o,I=new o;new o,new l,c.prototype.intersectBox=function(E,T,x,L){return this.intersectConvex(E.convexPolyhedronRepresentation,T,x,L)},c.prototype[h.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(E,T,x,L){var J=this.from,z=this.to,O=this._direction,W=new o(0,0,1);T.vmult(W,W);var te=new o;J.vsub(x,te);var Ae=te.dot(W);z.vsub(x,te);var ve=te.dot(W);if(!(Ae*ve>0)&&!(J.distanceTo(z)<Ae)){var me=W.dot(O);if(!(Math.abs(me)<this.precision)){var j=new o,se=new o,$e=new o;J.vsub(x,j);var Ee=-W.dot(j)/me;O.scale(Ee,se),J.vadd(se,$e),this.reportIntersection(W,$e,E,L,-1)}}},c.prototype[h.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(E){var T=this.to,x=this.from;E.lowerBound.x=Math.min(T.x,x.x),E.lowerBound.y=Math.min(T.y,x.y),E.lowerBound.z=Math.min(T.z,x.z),E.upperBound.x=Math.max(T.x,x.x),E.upperBound.y=Math.max(T.y,x.y),E.upperBound.z=Math.max(T.z,x.z)};var F={faceList:[0]};c.prototype.intersectHeightfield=function(E,T,x,L){E.data,E.elementSize;var J=new o,z=new c(this.from,this.to);i.pointToLocalFrame(x,T,z.from,z.from),i.pointToLocalFrame(x,T,z.to,z.to);var O=[],W=null,te=null,Ae=null,ve=null,me=E.getIndexOfPosition(z.from.x,z.from.y,O,!1);if(me&&(W=O[0],te=O[1],Ae=O[0],ve=O[1]),me=E.getIndexOfPosition(z.to.x,z.to.y,O,!1),me&&((W===null||O[0]<W)&&(W=O[0]),(Ae===null||O[0]>Ae)&&(Ae=O[0]),(te===null||O[1]<te)&&(te=O[1]),(ve===null||O[1]>ve)&&(ve=O[1])),W!==null){var j=[];E.getRectMinMax(W,te,Ae,ve,j),j[0],j[1];for(var se=W;se<=Ae;se++)for(var $e=te;$e<=ve;$e++){if(this.result._shouldStop||(E.getConvexTrianglePillar(se,$e,!1),i.pointToWorldFrame(x,T,E.pillarOffset,J),this.intersectConvex(E.pillarConvex,T,J,L,F),this.result._shouldStop))return;E.getConvexTrianglePillar(se,$e,!0),i.pointToWorldFrame(x,T,E.pillarOffset,J),this.intersectConvex(E.pillarConvex,T,J,L,F)}}},c.prototype[h.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var M=new o,B=new o;c.prototype.intersectSphere=function(E,T,x,L){var J=this.from,z=this.to,O=E.radius,W=Math.pow(z.x-J.x,2)+Math.pow(z.y-J.y,2)+Math.pow(z.z-J.z,2),te=2*((z.x-J.x)*(J.x-x.x)+(z.y-J.y)*(J.y-x.y)+(z.z-J.z)*(J.z-x.z)),Ae=Math.pow(J.x-x.x,2)+Math.pow(J.y-x.y,2)+Math.pow(J.z-x.z,2)-Math.pow(O,2),ve=Math.pow(te,2)-4*W*Ae,me=M,j=B;if(!(ve<0))if(ve===0)J.lerp(z,ve,me),me.vsub(x,j),j.normalize(),this.reportIntersection(j,me,E,L,-1);else{var se=(-te-Math.sqrt(ve))/(2*W),$e=(-te+Math.sqrt(ve))/(2*W);if(se>=0&&se<=1&&(J.lerp(z,se,me),me.vsub(x,j),j.normalize(),this.reportIntersection(j,me,E,L,-1)),this.result._shouldStop)return;$e>=0&&$e<=1&&(J.lerp(z,$e,me),me.vsub(x,j),j.normalize(),this.reportIntersection(j,me,E,L,-1))}},c.prototype[h.types.SPHERE]=c.prototype.intersectSphere;var C=new o;new o,new o;var A=new o;c.prototype.intersectConvex=function(T,x,L,J,z){for(var O=C,W=A,te=z&&z.faceList||null,Ae=T.faces,ve=T.vertices,me=T.faceNormals,j=this._direction,se=this.from,$e=this.to,Ee=se.distanceTo($e),Qe=te?te.length:Ae.length,we=this.result,Ke=0;!we._shouldStop&&Ke<Qe;Ke++){var Xe=te?te[Ke]:Ke,je=Ae[Xe],Ze=me[Xe],He=x,tt=L;W.copy(ve[je[0]]),He.vmult(W,W),W.vadd(tt,W),W.vsub(se,W),He.vmult(Ze,O);var ze=j.dot(O);if(!(Math.abs(ze)<this.precision)){var ut=O.dot(W)/ze;if(!(ut<0)){j.mult(ut,b),b.vadd(se,b),v.copy(ve[je[0]]),He.vmult(v,v),tt.vadd(v,v);for(var Tt=1;!we._shouldStop&&Tt<je.length-1;Tt++){w.copy(ve[je[Tt]]),I.copy(ve[je[Tt+1]]),He.vmult(w,w),He.vmult(I,I),tt.vadd(w,w),tt.vadd(I,I);var Qt=b.distanceTo(se);!(y(b,v,w,I)||y(b,w,v,I))||Qt>Ee||this.reportIntersection(O,b,T,J,Xe)}}}}},c.prototype[h.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var N=new o,V=new o,U=new o,X=new o,ue=new o,R=new o;new u;var P=[],Q=new i;c.prototype.intersectTrimesh=function(T,x,L,J,z){var O=N,W=P,te=Q,Ae=A,ve=V,me=U,j=X,se=R,$e=ue;z&&z.faceList;var Ee=T.indices;T.vertices,T.faceNormals;var Qe=this.from,we=this.to,Ke=this._direction;te.position.copy(L),te.quaternion.copy(x),i.vectorToLocalFrame(L,x,Ke,ve),i.pointToLocalFrame(L,x,Qe,me),i.pointToLocalFrame(L,x,we,j);var Xe=me.distanceSquared(j);T.tree.rayQuery(this,te,W);for(var je=0,Ze=W.length;!this.result._shouldStop&&je!==Ze;je++){var He=W[je];T.getNormal(He,O),T.getVertex(Ee[He*3],v),v.vsub(me,Ae);var tt=ve.dot(O),ze=O.dot(Ae)/tt;if(!(ze<0)){ve.scale(ze,b),b.vadd(me,b),T.getVertex(Ee[He*3+1],w),T.getVertex(Ee[He*3+2],I);var ut=b.distanceSquared(me);!(y(b,w,v,I)||y(b,v,w,I))||ut>Xe||(i.vectorToWorldFrame(x,O,$e),i.pointToWorldFrame(L,x,b,se),this.reportIntersection($e,se,T,J,He))}}W.length=0},c.prototype[h.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(E,T,x,L,J){var z=this.from,O=this.to,W=z.distanceTo(T),te=this.result;if(!(this.skipBackfaces&&E.dot(this._direction)>0))switch(te.hitFaceIndex=typeof J<"u"?J:-1,this.mode){case c.ALL:this.hasHit=!0,te.set(z,O,E,T,x,L,W),te.hasHit=!0,this.callback(te);break;case c.CLOSEST:(W<te.distance||!te.hasHit)&&(this.hasHit=!0,te.hasHit=!0,te.set(z,O,E,T,x,L,W));break;case c.ANY:this.hasHit=!0,te.hasHit=!0,te.set(z,O,E,T,x,L,W),te._shouldStop=!0;break}};var D=new o,S=new o;function G(E,T,x){x.vsub(E,D);var L=D.dot(T);T.mult(L,S),S.vadd(E,S);var J=x.distanceTo(S);return J}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,n,r){var o=t("../math/Vec3");n.exports=s;function s(){this.rayFromWorld=new o,this.rayToWorld=new o,this.hitNormalWorld=new o,this.hitPointWorld=new o,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}s.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},s.prototype.abort=function(){this._shouldStop=!0},s.prototype.set=function(i,l,h,u,c,d,p){this.rayFromWorld.copy(i),this.rayToWorld.copy(l),this.hitNormalWorld.copy(h),this.hitPointWorld.copy(u),this.shape=c,this.body=d,this.distance=p}},{"../math/Vec3":30}],11:[function(t,n,r){t("../shapes/Shape");var o=t("../collision/Broadphase");n.exports=s;function s(i){o.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var l=this.axisList;this._addBodyHandler=function(h){l.push(h.body)},this._removeBodyHandler=function(h){var u=l.indexOf(h.body);u!==-1&&l.splice(u,1)},i&&this.setWorld(i)}s.prototype=new o,s.prototype.setWorld=function(i){this.axisList.length=0;for(var l=0;l<i.bodies.length;l++)this.axisList.push(i.bodies[l]);i.removeEventListener("addBody",this._addBodyHandler),i.removeEventListener("removeBody",this._removeBodyHandler),i.addEventListener("addBody",this._addBodyHandler),i.addEventListener("removeBody",this._removeBodyHandler),this.world=i,this.dirty=!0},s.insertionSortX=function(i){for(var l=1,h=i.length;l<h;l++){for(var u=i[l],c=l-1;c>=0&&!(i[c].aabb.lowerBound.x<=u.aabb.lowerBound.x);c--)i[c+1]=i[c];i[c+1]=u}return i},s.insertionSortY=function(i){for(var l=1,h=i.length;l<h;l++){for(var u=i[l],c=l-1;c>=0&&!(i[c].aabb.lowerBound.y<=u.aabb.lowerBound.y);c--)i[c+1]=i[c];i[c+1]=u}return i},s.insertionSortZ=function(i){for(var l=1,h=i.length;l<h;l++){for(var u=i[l],c=l-1;c>=0&&!(i[c].aabb.lowerBound.z<=u.aabb.lowerBound.z);c--)i[c+1]=i[c];i[c+1]=u}return i},s.prototype.collisionPairs=function(i,l,h){var u=this.axisList,c=u.length,d=this.axisIndex,p,f;for(this.dirty&&(this.sortList(),this.dirty=!1),p=0;p!==c;p++){var g=u[p];for(f=p+1;f<c;f++){var y=u[f];if(this.needBroadphaseCollision(g,y)){if(!s.checkBounds(g,y,d))break;this.intersectionTest(g,y,l,h)}}}},s.prototype.sortList=function(){for(var i=this.axisList,l=this.axisIndex,h=i.length,u=0;u!==h;u++){var c=i[u];c.aabbNeedsUpdate&&c.computeAABB()}l===0?s.insertionSortX(i):l===1?s.insertionSortY(i):l===2&&s.insertionSortZ(i)},s.checkBounds=function(i,l,h){var u,c;h===0?(u=i.position.x,c=l.position.x):h===1?(u=i.position.y,c=l.position.y):h===2&&(u=i.position.z,c=l.position.z);var d=i.boundingRadius,p=l.boundingRadius,f=u+d,g=c-p;return g<f},s.prototype.autoDetectAxis=function(){for(var i=0,l=0,h=0,u=0,c=0,d=0,p=this.axisList,f=p.length,g=1/f,y=0;y!==f;y++){var m=p[y],_=m.position.x;i+=_,l+=_*_;var b=m.position.y;h+=b,u+=b*b;var v=m.position.z;c+=v,d+=v*v}var w=l-i*i*g,I=u-h*h*g,F=d-c*c*g;w>I?w>F?this.axisIndex=0:this.axisIndex=2:I>F?this.axisIndex=1:this.axisIndex=2},s.prototype.aabbQuery=function(i,l,h){h=h||[],this.dirty&&(this.sortList(),this.dirty=!1);var u=this.axisIndex,c="x";u===1&&(c="y"),u===2&&(c="z");var d=this.axisList;l.lowerBound[c],l.upperBound[c];for(var p=0;p<d.length;p++){var f=d[p];f.aabbNeedsUpdate&&f.computeAABB(),f.aabb.overlaps(l)&&h.push(f)}return h}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,n,r){n.exports=h,t("./Constraint");var o=t("./PointToPointConstraint"),s=t("../equations/ConeEquation"),i=t("../equations/RotationalEquation");t("../equations/ContactEquation");var l=t("../math/Vec3");function h(u,c,d){d=d||{};var p=typeof d.maxForce<"u"?d.maxForce:1e6,f=d.pivotA?d.pivotA.clone():new l,g=d.pivotB?d.pivotB.clone():new l;this.axisA=d.axisA?d.axisA.clone():new l,this.axisB=d.axisB?d.axisB.clone():new l,o.call(this,u,f,c,g,p),this.collideConnected=!!d.collideConnected,this.angle=typeof d.angle<"u"?d.angle:0;var y=this.coneEquation=new s(u,c,d),m=this.twistEquation=new i(u,c,d);this.twistAngle=typeof d.twistAngle<"u"?d.twistAngle:0,y.maxForce=0,y.minForce=-p,m.maxForce=0,m.minForce=-p,this.equations.push(y,m)}h.prototype=new o,h.constructor=h,new l,new l,h.prototype.update=function(){var u=this.bodyA,c=this.bodyB,d=this.coneEquation,p=this.twistEquation;o.prototype.update.call(this),u.vectorToWorldFrame(this.axisA,d.axisA),c.vectorToWorldFrame(this.axisB,d.axisB),this.axisA.tangents(p.axisA,p.axisA),u.vectorToWorldFrame(p.axisA,p.axisA),this.axisB.tangents(p.axisB,p.axisB),c.vectorToWorldFrame(p.axisB,p.axisB),d.angle=this.angle,p.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,n,r){n.exports=s;var o=t("../utils/Utils");function s(i,l,h){h=o.defaults(h,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=i,this.bodyB=l,this.id=s.idCounter++,this.collideConnected=h.collideConnected,h.wakeUpBodies&&(i&&i.wakeUp(),l&&l.wakeUp())}s.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},s.prototype.enable=function(){for(var i=this.equations,l=0;l<i.length;l++)i[l].enabled=!0},s.prototype.disable=function(){for(var i=this.equations,l=0;l<i.length;l++)i[l].enabled=!1},s.idCounter=0},{"../utils/Utils":53}],14:[function(t,n,r){n.exports=i;var o=t("./Constraint"),s=t("../equations/ContactEquation");function i(l,h,u,c){o.call(this,l,h),typeof u>"u"&&(u=l.position.distanceTo(h.position)),typeof c>"u"&&(c=1e6),this.distance=u;var d=this.distanceEquation=new s(l,h);this.equations.push(d),d.minForce=-c,d.maxForce=c}i.prototype=new o,i.prototype.update=function(){var l=this.bodyA,h=this.bodyB,u=this.distanceEquation,c=this.distance*.5,d=u.ni;h.position.vsub(l.position,d),d.normalize(),d.mult(c,u.ri),d.mult(-c,u.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,n,r){n.exports=h,t("./Constraint");var o=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation"),i=t("../equations/RotationalMotorEquation");t("../equations/ContactEquation");var l=t("../math/Vec3");function h(d,p,f){f=f||{};var g=typeof f.maxForce<"u"?f.maxForce:1e6,y=f.pivotA?f.pivotA.clone():new l,m=f.pivotB?f.pivotB.clone():new l;o.call(this,d,y,p,m,g);var _=this.axisA=f.axisA?f.axisA.clone():new l(1,0,0);_.normalize();var b=this.axisB=f.axisB?f.axisB.clone():new l(1,0,0);b.normalize();var v=this.rotationalEquation1=new s(d,p,f),w=this.rotationalEquation2=new s(d,p,f),I=this.motorEquation=new i(d,p,g);I.enabled=!1,this.equations.push(v,w,I)}h.prototype=new o,h.constructor=h,h.prototype.enableMotor=function(){this.motorEquation.enabled=!0},h.prototype.disableMotor=function(){this.motorEquation.enabled=!1},h.prototype.setMotorSpeed=function(d){this.motorEquation.targetVelocity=d},h.prototype.setMotorMaxForce=function(d){this.motorEquation.maxForce=d,this.motorEquation.minForce=-d};var u=new l,c=new l;h.prototype.update=function(){var d=this.bodyA,p=this.bodyB,f=this.motorEquation,g=this.rotationalEquation1,y=this.rotationalEquation2,m=u,_=c,b=this.axisA,v=this.axisB;o.prototype.update.call(this),d.quaternion.vmult(b,m),p.quaternion.vmult(v,_),m.tangents(g.axisA,y.axisA),g.axisB.copy(_),y.axisB.copy(_),this.motorEquation.enabled&&(d.quaternion.vmult(this.axisA,f.axisA),p.quaternion.vmult(this.axisB,f.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,n,r){n.exports=l,t("./Constraint");var o=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation");t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation");var i=t("../math/Vec3");function l(h,u,c){c=c||{};var d=typeof c.maxForce<"u"?c.maxForce:1e6,p=new i,f=new i,g=new i;h.position.vadd(u.position,g),g.scale(.5,g),u.pointToLocalFrame(g,f),h.pointToLocalFrame(g,p),o.call(this,h,p,u,f,d);var y=this.rotationalEquation1=new s(h,u,c),m=this.rotationalEquation2=new s(h,u,c),_=this.rotationalEquation3=new s(h,u,c);this.equations.push(y,m,_)}l.prototype=new o,l.constructor=l,new i,new i,l.prototype.update=function(){var h=this.bodyA,u=this.bodyB;this.motorEquation;var c=this.rotationalEquation1,d=this.rotationalEquation2,p=this.rotationalEquation3;o.prototype.update.call(this),h.vectorToWorldFrame(i.UNIT_X,c.axisA),u.vectorToWorldFrame(i.UNIT_Y,c.axisB),h.vectorToWorldFrame(i.UNIT_Y,d.axisA),u.vectorToWorldFrame(i.UNIT_Z,d.axisB),h.vectorToWorldFrame(i.UNIT_Z,p.axisA),u.vectorToWorldFrame(i.UNIT_X,p.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,n,r){n.exports=l;var o=t("./Constraint"),s=t("../equations/ContactEquation"),i=t("../math/Vec3");function l(h,u,c,d,p){o.call(this,h,c),p=typeof p<"u"?p:1e6,this.pivotA=u?u.clone():new i,this.pivotB=d?d.clone():new i;var f=this.equationX=new s(h,c),g=this.equationY=new s(h,c),y=this.equationZ=new s(h,c);this.equations.push(f,g,y),f.minForce=g.minForce=y.minForce=-p,f.maxForce=g.maxForce=y.maxForce=p,f.ni.set(1,0,0),g.ni.set(0,1,0),y.ni.set(0,0,1)}l.prototype=new o,l.prototype.update=function(){var h=this.bodyA,u=this.bodyB,c=this.equationX,d=this.equationY,p=this.equationZ;h.quaternion.vmult(this.pivotA,c.ri),u.quaternion.vmult(this.pivotB,c.rj),d.ri.copy(c.ri),d.rj.copy(c.rj),p.ri.copy(c.ri),p.rj.copy(c.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,n,r){n.exports=i;var o=t("../math/Vec3");t("../math/Mat3");var s=t("./Equation");function i(u,c,d){d=d||{};var p=typeof d.maxForce<"u"?d.maxForce:1e6;s.call(this,u,c,-p,p),this.axisA=d.axisA?d.axisA.clone():new o(1,0,0),this.axisB=d.axisB?d.axisB.clone():new o(0,1,0),this.angle=typeof d.angle<"u"?d.angle:0}i.prototype=new s,i.prototype.constructor=i;var l=new o,h=new o;i.prototype.computeB=function(u){var c=this.a,d=this.b,p=this.axisA,f=this.axisB,g=l,y=h,m=this.jacobianElementA,_=this.jacobianElementB;p.cross(f,g),f.cross(p,y),m.rotational.copy(y),_.rotational.copy(g);var b=Math.cos(this.angle)-p.dot(f),v=this.computeGW(),w=this.computeGiMf(),I=-b*c-v*d-u*w;return I}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,n,r){n.exports=i;var o=t("./Equation"),s=t("../math/Vec3");t("../math/Mat3");function i(y,m,_){_=typeof _<"u"?_:1e6,o.call(this,y,m,0,_),this.restitution=0,this.ri=new s,this.rj=new s,this.ni=new s}i.prototype=new o,i.prototype.constructor=i;var l=new s,h=new s,u=new s;i.prototype.computeB=function(y){var m=this.a,_=this.b,b=this.bi,v=this.bj,w=this.ri,I=this.rj,F=l,M=h,B=b.velocity,C=b.angularVelocity;b.force,b.torque;var A=v.velocity,N=v.angularVelocity;v.force,v.torque;var V=u,U=this.jacobianElementA,X=this.jacobianElementB,ue=this.ni;w.cross(ue,F),I.cross(ue,M),ue.negate(U.spatial),F.negate(U.rotational),X.spatial.copy(ue),X.rotational.copy(M),V.copy(v.position),V.vadd(I,V),V.vsub(b.position,V),V.vsub(w,V);var R=ue.dot(V),P=this.restitution+1,Q=P*A.dot(ue)-P*B.dot(ue)+N.dot(M)-C.dot(F),D=this.computeGiMf(),S=-R*m-Q*_-y*D;return S};var c=new s,d=new s,p=new s,f=new s,g=new s;i.prototype.getImpactVelocityAlongNormal=function(){var y=c,m=d,_=p,b=f,v=g;return this.bi.position.vadd(this.ri,_),this.bj.position.vadd(this.rj,b),this.bi.getVelocityAtWorldPoint(_,y),this.bj.getVelocityAtWorldPoint(b,m),y.vsub(m,v),this.ni.dot(v)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,n,r){n.exports=i;var o=t("../math/JacobianElement"),s=t("../math/Vec3");function i(g,y,m,_){this.id=i.id++,this.minForce=typeof m>"u"?-1e6:m,this.maxForce=typeof _>"u"?1e6:_,this.bi=g,this.bj=y,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new o,this.jacobianElementB=new o,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}i.prototype.constructor=i,i.id=0,i.prototype.setSpookParams=function(g,y,m){var _=y,b=g,v=m;this.a=4/(v*(1+4*_)),this.b=4*_/(1+4*_),this.eps=4/(v*v*b*(1+4*_))},i.prototype.computeB=function(g,y,m){var _=this.computeGW(),b=this.computeGq(),v=this.computeGiMf();return-b*g-_*y-v*m},i.prototype.computeGq=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.position,v=_.position;return g.spatial.dot(b)+y.spatial.dot(v)};var l=new s;i.prototype.computeGW=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.velocity,v=_.velocity,w=m.angularVelocity||l,I=_.angularVelocity||l;return g.multiplyVectors(b,w)+y.multiplyVectors(v,I)},i.prototype.computeGWlambda=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.vlambda,v=_.vlambda,w=m.wlambda||l,I=_.wlambda||l;return g.multiplyVectors(b,w)+y.multiplyVectors(v,I)};var h=new s,u=new s,c=new s,d=new s;i.prototype.computeGiMf=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.force,v=m.torque,w=_.force,I=_.torque,F=m.invMassSolve,M=_.invMassSolve;return m.invInertiaWorldSolve?m.invInertiaWorldSolve.vmult(v,c):c.set(0,0,0),_.invInertiaWorldSolve?_.invInertiaWorldSolve.vmult(I,d):d.set(0,0,0),b.mult(F,h),w.mult(M,u),g.multiplyVectors(h,c)+y.multiplyVectors(u,d)};var p=new s;i.prototype.computeGiMGt=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.invMassSolve,v=_.invMassSolve,w=m.invInertiaWorldSolve,I=_.invInertiaWorldSolve,F=b+v;return w&&(w.vmult(g.rotational,p),F+=p.dot(g.rotational)),I&&(I.vmult(y.rotational,p),F+=p.dot(y.rotational)),F};var f=new s;new s,new s,new s,new s,new s,i.prototype.addToWlambda=function(g){var y=this.jacobianElementA,m=this.jacobianElementB,_=this.bi,b=this.bj,v=f;y.spatial.mult(_.invMassSolve*g,v),_.vlambda.vadd(v,_.vlambda),m.spatial.mult(b.invMassSolve*g,v),b.vlambda.vadd(v,b.vlambda),_.invInertiaWorldSolve&&(_.invInertiaWorldSolve.vmult(y.rotational,v),v.mult(g,v),_.wlambda.vadd(v,_.wlambda)),b.invInertiaWorldSolve&&(b.invInertiaWorldSolve.vmult(m.rotational,v),v.mult(g,v),b.wlambda.vadd(v,b.wlambda))},i.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,n,r){n.exports=i;var o=t("./Equation"),s=t("../math/Vec3");t("../math/Mat3");function i(u,c,d){o.call(this,u,c,-d,d),this.ri=new s,this.rj=new s,this.t=new s}i.prototype=new o,i.prototype.constructor=i;var l=new s,h=new s;i.prototype.computeB=function(u){this.a;var c=this.b;this.bi,this.bj;var d=this.ri,p=this.rj,f=l,g=h,y=this.t;d.cross(y,f),p.cross(y,g);var m=this.jacobianElementA,_=this.jacobianElementB;y.negate(m.spatial),f.negate(m.rotational),_.spatial.copy(y),_.rotational.copy(g);var b=this.computeGW(),v=this.computeGiMf(),w=-b*c-u*v;return w}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,n,r){n.exports=i;var o=t("../math/Vec3");t("../math/Mat3");var s=t("./Equation");function i(u,c,d){d=d||{};var p=typeof d.maxForce<"u"?d.maxForce:1e6;s.call(this,u,c,-p,p),this.axisA=d.axisA?d.axisA.clone():new o(1,0,0),this.axisB=d.axisB?d.axisB.clone():new o(0,1,0),this.maxAngle=Math.PI/2}i.prototype=new s,i.prototype.constructor=i;var l=new o,h=new o;i.prototype.computeB=function(u){var c=this.a,d=this.b,p=this.axisA,f=this.axisB,g=l,y=h,m=this.jacobianElementA,_=this.jacobianElementB;p.cross(f,g),f.cross(p,y),m.rotational.copy(y),_.rotational.copy(g);var b=Math.cos(this.maxAngle)-p.dot(f),v=this.computeGW(),w=this.computeGiMf(),I=-b*c-v*d-u*w;return I}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,n,r){n.exports=i;var o=t("../math/Vec3");t("../math/Mat3");var s=t("./Equation");function i(l,h,u){u=typeof u<"u"?u:1e6,s.call(this,l,h,-u,u),this.axisA=new o,this.axisB=new o,this.targetVelocity=0}i.prototype=new s,i.prototype.constructor=i,i.prototype.computeB=function(l){this.a;var h=this.b;this.bi,this.bj;var u=this.axisA,c=this.axisB,d=this.jacobianElementA,p=this.jacobianElementB;d.rotational.copy(u),c.negate(p.rotational);var f=this.computeGW()-this.targetVelocity,g=this.computeGiMf(),y=-f*h-l*g;return y}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,n,r){var o=t("../utils/Utils");n.exports=s;function s(i,l,h){h=o.defaults(h,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=s.idCounter++,this.materials=[i,l],this.friction=h.friction,this.restitution=h.restitution,this.contactEquationStiffness=h.contactEquationStiffness,this.contactEquationRelaxation=h.contactEquationRelaxation,this.frictionEquationStiffness=h.frictionEquationStiffness,this.frictionEquationRelaxation=h.frictionEquationRelaxation}s.idCounter=0},{"../utils/Utils":53}],25:[function(t,n,r){n.exports=o;function o(s){var i="";s=s||{},typeof s=="string"?(i=s,s={}):typeof s=="object"&&(i=""),this.name=i,this.id=o.idCounter++,this.friction=typeof s.friction<"u"?s.friction:-1,this.restitution=typeof s.restitution<"u"?s.restitution:-1}o.idCounter=0},{}],26:[function(t,n,r){n.exports=s;var o=t("./Vec3");function s(){this.spatial=new o,this.rotational=new o}s.prototype.multiplyElement=function(i){return i.spatial.dot(this.spatial)+i.rotational.dot(this.rotational)},s.prototype.multiplyVectors=function(i,l){return i.dot(this.spatial)+l.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,n,r){n.exports=s;var o=t("./Vec3");function s(i){i?this.elements=i:this.elements=[0,0,0,0,0,0,0,0,0]}s.prototype.identity=function(){var i=this.elements;i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=0,i[7]=0,i[8]=1},s.prototype.setZero=function(){var i=this.elements;i[0]=0,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=0,i[6]=0,i[7]=0,i[8]=0},s.prototype.setTrace=function(i){var l=this.elements;l[0]=i.x,l[4]=i.y,l[8]=i.z},s.prototype.getTrace=function(l){var l=l||new o,h=this.elements;l.x=h[0],l.y=h[4],l.z=h[8]},s.prototype.vmult=function(i,l){l=l||new o;var h=this.elements,u=i.x,c=i.y,d=i.z;return l.x=h[0]*u+h[1]*c+h[2]*d,l.y=h[3]*u+h[4]*c+h[5]*d,l.z=h[6]*u+h[7]*c+h[8]*d,l},s.prototype.smult=function(i){for(var l=0;l<this.elements.length;l++)this.elements[l]*=i},s.prototype.mmult=function(i,l){for(var h=l||new s,u=0;u<3;u++)for(var c=0;c<3;c++){for(var d=0,p=0;p<3;p++)d+=i.elements[u+p*3]*this.elements[p+c*3];h.elements[u+c*3]=d}return h},s.prototype.scale=function(i,l){l=l||new s;for(var h=this.elements,u=l.elements,c=0;c!==3;c++)u[3*c+0]=i.x*h[3*c+0],u[3*c+1]=i.y*h[3*c+1],u[3*c+2]=i.z*h[3*c+2];return l},s.prototype.solve=function(i,l){l=l||new o;for(var h=3,u=4,c=[],d=0;d<h*u;d++)c.push(0);var d,p;for(d=0;d<3;d++)for(p=0;p<3;p++)c[d+u*p]=this.elements[d+3*p];c[3]=i.x,c[7]=i.y,c[11]=i.z;var f=3,g=f,y,m=4,_;do{if(d=g-f,c[d+u*d]===0){for(p=d+1;p<g;p++)if(c[d+u*p]!==0){y=m;do _=m-y,c[_+u*d]+=c[_+u*p];while(--y);break}}if(c[d+u*d]!==0)for(p=d+1;p<g;p++){var b=c[d+u*p]/c[d+u*d];y=m;do _=m-y,c[_+u*p]=_<=d?0:c[_+u*p]-c[_+u*d]*b;while(--y)}}while(--f);if(l.z=c[2*u+3]/c[2*u+2],l.y=(c[1*u+3]-c[1*u+2]*l.z)/c[1*u+1],l.x=(c[0*u+3]-c[0*u+2]*l.z-c[0*u+1]*l.y)/c[0*u+0],isNaN(l.x)||isNaN(l.y)||isNaN(l.z)||l.x===1/0||l.y===1/0||l.z===1/0)throw"Could not solve equation! Got x=["+l.toString()+"], b=["+i.toString()+"], A=["+this.toString()+"]";return l},s.prototype.e=function(i,l,h){if(h===void 0)return this.elements[l+3*i];this.elements[l+3*i]=h},s.prototype.copy=function(i){for(var l=0;l<i.elements.length;l++)this.elements[l]=i.elements[l];return this},s.prototype.toString=function(){for(var i="",l=",",h=0;h<9;h++)i+=this.elements[h]+l;return i},s.prototype.reverse=function(i){i=i||new s;for(var l=3,h=6,u=[],c=0;c<l*h;c++)u.push(0);var c,d;for(c=0;c<3;c++)for(d=0;d<3;d++)u[c+h*d]=this.elements[c+3*d];u[3]=1,u[9]=0,u[15]=0,u[4]=0,u[10]=1,u[16]=0,u[5]=0,u[11]=0,u[17]=1;var p=3,f=p,g,y=h,m;do{if(c=f-p,u[c+h*c]===0){for(d=c+1;d<f;d++)if(u[c+h*d]!==0){g=y;do m=y-g,u[m+h*c]+=u[m+h*d];while(--g);break}}if(u[c+h*c]!==0)for(d=c+1;d<f;d++){var _=u[c+h*d]/u[c+h*c];g=y;do m=y-g,u[m+h*d]=m<=c?0:u[m+h*d]-u[m+h*c]*_;while(--g)}}while(--p);c=2;do{d=c-1;do{var _=u[c+h*d]/u[c+h*c];g=h;do m=h-g,u[m+h*d]=u[m+h*d]-u[m+h*c]*_;while(--g)}while(d--)}while(--c);c=2;do{var _=1/u[c+h*c];g=h;do m=h-g,u[m+h*c]=u[m+h*c]*_;while(--g)}while(c--);c=2;do{d=2;do{if(m=u[l+d+h*c],isNaN(m)||m===1/0)throw"Could not reverse! A=["+this.toString()+"]";i.e(c,d,m)}while(d--)}while(c--);return i},s.prototype.setRotationFromQuaternion=function(i){var l=i.x,h=i.y,u=i.z,c=i.w,d=l+l,p=h+h,f=u+u,g=l*d,y=l*p,m=l*f,_=h*p,b=h*f,v=u*f,w=c*d,I=c*p,F=c*f,M=this.elements;return M[0]=1-(_+v),M[1]=y-F,M[2]=m+I,M[3]=y+F,M[4]=1-(g+v),M[5]=b-w,M[6]=m-I,M[7]=b+w,M[8]=1-(g+_),this},s.prototype.transpose=function(i){i=i||new s;for(var l=i.elements,h=this.elements,u=0;u!==3;u++)for(var c=0;c!==3;c++)l[3*u+c]=h[3*c+u];return i}},{"./Vec3":30}],28:[function(t,n,r){n.exports=s;var o=t("./Vec3");function s(d,p,f,g){this.x=d!==void 0?d:0,this.y=p!==void 0?p:0,this.z=f!==void 0?f:0,this.w=g!==void 0?g:1}s.prototype.set=function(d,p,f,g){this.x=d,this.y=p,this.z=f,this.w=g},s.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},s.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},s.prototype.setFromAxisAngle=function(d,p){var f=Math.sin(p*.5);this.x=d.x*f,this.y=d.y*f,this.z=d.z*f,this.w=Math.cos(p*.5)},s.prototype.toAxisAngle=function(d){d=d||new o,this.normalize();var p=2*Math.acos(this.w),f=Math.sqrt(1-this.w*this.w);return f<.001?(d.x=this.x,d.y=this.y,d.z=this.z):(d.x=this.x/f,d.y=this.y/f,d.z=this.z/f),[d,p]};var i=new o,l=new o;s.prototype.setFromVectors=function(d,p){if(d.isAntiparallelTo(p)){var f=i,g=l;d.tangents(f,g),this.setFromAxisAngle(f,Math.PI)}else{var y=d.cross(p);this.x=y.x,this.y=y.y,this.z=y.z,this.w=Math.sqrt(Math.pow(d.norm(),2)*Math.pow(p.norm(),2))+d.dot(p),this.normalize()}};var h=new o,u=new o,c=new o;s.prototype.mult=function(d,p){p=p||new s;var f=this.w,g=h,y=u,m=c;return g.set(this.x,this.y,this.z),y.set(d.x,d.y,d.z),p.w=f*d.w-g.dot(y),g.cross(y,m),p.x=f*y.x+d.w*g.x+m.x,p.y=f*y.y+d.w*g.y+m.y,p.z=f*y.z+d.w*g.z+m.z,p},s.prototype.inverse=function(d){var p=this.x,f=this.y,g=this.z,y=this.w;d=d||new s,this.conjugate(d);var m=1/(p*p+f*f+g*g+y*y);return d.x*=m,d.y*=m,d.z*=m,d.w*=m,d},s.prototype.conjugate=function(d){return d=d||new s,d.x=-this.x,d.y=-this.y,d.z=-this.z,d.w=this.w,d},s.prototype.normalize=function(){var d=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);d===0?(this.x=0,this.y=0,this.z=0,this.w=0):(d=1/d,this.x*=d,this.y*=d,this.z*=d,this.w*=d)},s.prototype.normalizeFast=function(){var d=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;d===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=d,this.y*=d,this.z*=d,this.w*=d)},s.prototype.vmult=function(d,p){p=p||new o;var f=d.x,g=d.y,y=d.z,m=this.x,_=this.y,b=this.z,v=this.w,w=v*f+_*y-b*g,I=v*g+b*f-m*y,F=v*y+m*g-_*f,M=-m*f-_*g-b*y;return p.x=w*v+M*-m+I*-b-F*-_,p.y=I*v+M*-_+F*-m-w*-b,p.z=F*v+M*-b+w*-_-I*-m,p},s.prototype.copy=function(d){return this.x=d.x,this.y=d.y,this.z=d.z,this.w=d.w,this},s.prototype.toEuler=function(d,p){p=p||"YZX";var f,g,y,m=this.x,_=this.y,b=this.z,v=this.w;switch(p){case"YZX":var w=m*_+b*v;if(w>.499&&(f=2*Math.atan2(m,v),g=Math.PI/2,y=0),w<-.499&&(f=-2*Math.atan2(m,v),g=-Math.PI/2,y=0),isNaN(f)){var I=m*m,F=_*_,M=b*b;f=Math.atan2(2*_*v-2*m*b,1-2*F-2*M),g=Math.asin(2*w),y=Math.atan2(2*m*v-2*_*b,1-2*I-2*M)}break;default:throw new Error("Euler order "+p+" not supported yet.")}d.y=f,d.z=g,d.x=y},s.prototype.setFromEuler=function(d,p,f,g){g=g||"XYZ";var y=Math.cos(d/2),m=Math.cos(p/2),_=Math.cos(f/2),b=Math.sin(d/2),v=Math.sin(p/2),w=Math.sin(f/2);return g==="XYZ"?(this.x=b*m*_+y*v*w,this.y=y*v*_-b*m*w,this.z=y*m*w+b*v*_,this.w=y*m*_-b*v*w):g==="YXZ"?(this.x=b*m*_+y*v*w,this.y=y*v*_-b*m*w,this.z=y*m*w-b*v*_,this.w=y*m*_+b*v*w):g==="ZXY"?(this.x=b*m*_-y*v*w,this.y=y*v*_+b*m*w,this.z=y*m*w+b*v*_,this.w=y*m*_-b*v*w):g==="ZYX"?(this.x=b*m*_-y*v*w,this.y=y*v*_+b*m*w,this.z=y*m*w-b*v*_,this.w=y*m*_+b*v*w):g==="YZX"?(this.x=b*m*_+y*v*w,this.y=y*v*_+b*m*w,this.z=y*m*w-b*v*_,this.w=y*m*_-b*v*w):g==="XZY"&&(this.x=b*m*_-y*v*w,this.y=y*v*_-b*m*w,this.z=y*m*w+b*v*_,this.w=y*m*_+b*v*w),this},s.prototype.clone=function(){return new s(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,n,r){var o=t("./Vec3"),s=t("./Quaternion");n.exports=i;function i(h){h=h||{},this.position=new o,h.position&&this.position.copy(h.position),this.quaternion=new s,h.quaternion&&this.quaternion.copy(h.quaternion)}var l=new s;i.pointToLocalFrame=function(h,u,c,p){var p=p||new o;return c.vsub(h,p),u.conjugate(l),l.vmult(p,p),p},i.prototype.pointToLocal=function(h,u){return i.pointToLocalFrame(this.position,this.quaternion,h,u)},i.pointToWorldFrame=function(h,u,c,p){var p=p||new o;return u.vmult(c,p),p.vadd(h,p),p},i.prototype.pointToWorld=function(h,u){return i.pointToWorldFrame(this.position,this.quaternion,h,u)},i.prototype.vectorToWorldFrame=function(h,c){var c=c||new o;return this.quaternion.vmult(h,c),c},i.vectorToWorldFrame=function(h,u,c){return h.vmult(u,c),c},i.vectorToLocalFrame=function(h,u,c,p){var p=p||new o;return u.w*=-1,u.vmult(c,p),u.w*=-1,p}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,n,r){n.exports=s;var o=t("./Mat3");function s(u,c,d){this.x=u||0,this.y=c||0,this.z=d||0}s.ZERO=new s(0,0,0),s.UNIT_X=new s(1,0,0),s.UNIT_Y=new s(0,1,0),s.UNIT_Z=new s(0,0,1),s.prototype.cross=function(u,c){var d=u.x,p=u.y,f=u.z,g=this.x,y=this.y,m=this.z;return c=c||new s,c.x=y*f-m*p,c.y=m*d-g*f,c.z=g*p-y*d,c},s.prototype.set=function(u,c,d){return this.x=u,this.y=c,this.z=d,this},s.prototype.setZero=function(){this.x=this.y=this.z=0},s.prototype.vadd=function(u,c){if(c)c.x=u.x+this.x,c.y=u.y+this.y,c.z=u.z+this.z;else return new s(this.x+u.x,this.y+u.y,this.z+u.z)},s.prototype.vsub=function(u,c){if(c)c.x=this.x-u.x,c.y=this.y-u.y,c.z=this.z-u.z;else return new s(this.x-u.x,this.y-u.y,this.z-u.z)},s.prototype.crossmat=function(){return new o([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},s.prototype.normalize=function(){var u=this.x,c=this.y,d=this.z,p=Math.sqrt(u*u+c*c+d*d);if(p>0){var f=1/p;this.x*=f,this.y*=f,this.z*=f}else this.x=0,this.y=0,this.z=0;return p},s.prototype.unit=function(u){u=u||new s;var c=this.x,d=this.y,p=this.z,f=Math.sqrt(c*c+d*d+p*p);return f>0?(f=1/f,u.x=c*f,u.y=d*f,u.z=p*f):(u.x=1,u.y=0,u.z=0),u},s.prototype.norm=function(){var u=this.x,c=this.y,d=this.z;return Math.sqrt(u*u+c*c+d*d)},s.prototype.length=s.prototype.norm,s.prototype.norm2=function(){return this.dot(this)},s.prototype.lengthSquared=s.prototype.norm2,s.prototype.distanceTo=function(u){var c=this.x,d=this.y,p=this.z,f=u.x,g=u.y,y=u.z;return Math.sqrt((f-c)*(f-c)+(g-d)*(g-d)+(y-p)*(y-p))},s.prototype.distanceSquared=function(u){var c=this.x,d=this.y,p=this.z,f=u.x,g=u.y,y=u.z;return(f-c)*(f-c)+(g-d)*(g-d)+(y-p)*(y-p)},s.prototype.mult=function(u,c){c=c||new s;var d=this.x,p=this.y,f=this.z;return c.x=u*d,c.y=u*p,c.z=u*f,c},s.prototype.scale=s.prototype.mult,s.prototype.dot=function(u){return this.x*u.x+this.y*u.y+this.z*u.z},s.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},s.prototype.negate=function(u){return u=u||new s,u.x=-this.x,u.y=-this.y,u.z=-this.z,u};var i=new s,l=new s;s.prototype.tangents=function(u,c){var d=this.norm();if(d>0){var p=i,f=1/d;p.set(this.x*f,this.y*f,this.z*f);var g=l;Math.abs(p.x)<.9?(g.set(1,0,0),p.cross(g,u)):(g.set(0,1,0),p.cross(g,u)),p.cross(u,c)}else u.set(1,0,0),c.set(0,1,0)},s.prototype.toString=function(){return this.x+","+this.y+","+this.z},s.prototype.toArray=function(){return[this.x,this.y,this.z]},s.prototype.copy=function(u){return this.x=u.x,this.y=u.y,this.z=u.z,this},s.prototype.lerp=function(u,c,d){var p=this.x,f=this.y,g=this.z;d.x=p+(u.x-p)*c,d.y=f+(u.y-f)*c,d.z=g+(u.z-g)*c},s.prototype.almostEquals=function(u,c){return c===void 0&&(c=1e-6),!(Math.abs(this.x-u.x)>c||Math.abs(this.y-u.y)>c||Math.abs(this.z-u.z)>c)},s.prototype.almostZero=function(u){return u===void 0&&(u=1e-6),!(Math.abs(this.x)>u||Math.abs(this.y)>u||Math.abs(this.z)>u)};var h=new s;s.prototype.isAntiparallelTo=function(u,c){return this.negate(h),h.almostEquals(u,c)},s.prototype.clone=function(){return new s(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,n,r){n.exports=c;var o=t("../utils/EventTarget");t("../shapes/Shape");var s=t("../math/Vec3"),i=t("../math/Mat3"),l=t("../math/Quaternion");t("../material/Material");var h=t("../collision/AABB"),u=t("../shapes/Box");function c(A){A=A||{},o.apply(this),this.id=c.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup=typeof A.collisionFilterGroup=="number"?A.collisionFilterGroup:1,this.collisionFilterMask=typeof A.collisionFilterMask=="number"?A.collisionFilterMask:1,this.collisionResponse=!0,this.position=new s,A.position&&this.position.copy(A.position),this.previousPosition=new s,this.initPosition=new s,this.velocity=new s,A.velocity&&this.velocity.copy(A.velocity),this.initVelocity=new s,this.force=new s;var N=typeof A.mass=="number"?A.mass:0;this.mass=N,this.invMass=N>0?1/N:0,this.material=A.material||null,this.linearDamping=typeof A.linearDamping=="number"?A.linearDamping:.01,this.type=N<=0?c.STATIC:c.DYNAMIC,typeof A.type==typeof c.STATIC&&(this.type=A.type),this.allowSleep=typeof A.allowSleep<"u"?A.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof A.sleepSpeedLimit<"u"?A.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof A.sleepTimeLimit<"u"?A.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new l,A.quaternion&&this.quaternion.copy(A.quaternion),this.initQuaternion=new l,this.angularVelocity=new s,A.angularVelocity&&this.angularVelocity.copy(A.angularVelocity),this.initAngularVelocity=new s,this.interpolatedPosition=new s,this.interpolatedQuaternion=new l,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new i,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new i,this.fixedRotation=typeof A.fixedRotation<"u"?A.fixedRotation:!1,this.angularDamping=typeof A.angularDamping<"u"?A.angularDamping:.01,this.aabb=new h,this.aabbNeedsUpdate=!0,this.wlambda=new s,A.shape&&this.addShape(A.shape),this.updateMassProperties()}c.prototype=new o,c.prototype.constructor=c,c.DYNAMIC=1,c.STATIC=2,c.KINEMATIC=4,c.AWAKE=0,c.SLEEPY=1,c.SLEEPING=2,c.idCounter=0,c.prototype.wakeUp=function(){var A=this.sleepState;this.sleepState=0,A===c.SLEEPING&&this.dispatchEvent({type:"wakeup"})},c.prototype.sleep=function(){this.sleepState=c.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},c.sleepyEvent={type:"sleepy"},c.sleepEvent={type:"sleep"},c.prototype.sleepTick=function(A){if(this.allowSleep){var N=this.sleepState,V=this.velocity.norm2()+this.angularVelocity.norm2(),U=Math.pow(this.sleepSpeedLimit,2);N===c.AWAKE&&V<U?(this.sleepState=c.SLEEPY,this.timeLastSleepy=A,this.dispatchEvent(c.sleepyEvent)):N===c.SLEEPY&&V>U?this.wakeUp():N===c.SLEEPY&&A-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(c.sleepEvent))}},c.prototype.updateSolveMassProperties=function(){this.sleepState===c.SLEEPING||this.type===c.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},c.prototype.pointToLocalFrame=function(A,V){var V=V||new s;return A.vsub(this.position,V),this.quaternion.conjugate().vmult(V,V),V},c.prototype.vectorToLocalFrame=function(A,V){var V=V||new s;return this.quaternion.conjugate().vmult(A,V),V},c.prototype.pointToWorldFrame=function(A,V){var V=V||new s;return this.quaternion.vmult(A,V),V.vadd(this.position,V),V},c.prototype.vectorToWorldFrame=function(A,V){var V=V||new s;return this.quaternion.vmult(A,V),V};var d=new s,p=new l;c.prototype.addShape=function(A,N,V){var U=new s,X=new l;return N&&U.copy(N),V&&X.copy(V),this.shapes.push(A),this.shapeOffsets.push(U),this.shapeOrientations.push(X),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},c.prototype.updateBoundingRadius=function(){for(var A=this.shapes,N=this.shapeOffsets,V=A.length,U=0,X=0;X!==V;X++){var ue=A[X];ue.updateBoundingSphereRadius();var R=N[X].norm(),P=ue.boundingSphereRadius;R+P>U&&(U=R+P)}this.boundingRadius=U};var f=new h;c.prototype.computeAABB=function(){for(var A=this.shapes,N=this.shapeOffsets,V=this.shapeOrientations,U=A.length,X=d,ue=p,R=this.quaternion,P=this.aabb,Q=f,D=0;D!==U;D++){var S=A[D];V[D].mult(R,ue),ue.vmult(N[D],X),X.vadd(this.position,X),S.calculateWorldAABB(X,ue,Q.lowerBound,Q.upperBound),D===0?P.copy(Q):P.extend(Q)}this.aabbNeedsUpdate=!1};var g=new i,y=new i;new i,c.prototype.updateInertiaWorld=function(A){var N=this.invInertia;if(!(N.x===N.y&&N.y===N.z&&!A)){var V=g,U=y;V.setRotationFromQuaternion(this.quaternion),V.transpose(U),V.scale(N,V),V.mmult(U,this.invInertiaWorld)}};var m=new s,_=new s;c.prototype.applyForce=function(A,N){if(this.type===c.DYNAMIC){var V=m;N.vsub(this.position,V);var U=_;V.cross(A,U),this.force.vadd(A,this.force),this.torque.vadd(U,this.torque)}};var b=new s,v=new s;c.prototype.applyLocalForce=function(A,N){if(this.type===c.DYNAMIC){var V=b,U=v;this.vectorToWorldFrame(A,V),this.pointToWorldFrame(N,U),this.applyForce(V,U)}};var w=new s,I=new s,F=new s;c.prototype.applyImpulse=function(A,N){if(this.type===c.DYNAMIC){var V=w;N.vsub(this.position,V);var U=I;U.copy(A),U.mult(this.invMass,U),this.velocity.vadd(U,this.velocity);var X=F;V.cross(A,X),this.invInertiaWorld.vmult(X,X),this.angularVelocity.vadd(X,this.angularVelocity)}};var M=new s,B=new s;c.prototype.applyLocalImpulse=function(A,N){if(this.type===c.DYNAMIC){var V=M,U=B;this.vectorToWorldFrame(A,V),this.pointToWorldFrame(N,U),this.applyImpulse(V,U)}};var C=new s;c.prototype.updateMassProperties=function(){var A=C;this.invMass=this.mass>0?1/this.mass:0;var N=this.inertia,V=this.fixedRotation;this.computeAABB(),A.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),u.calculateInertia(A,this.mass,N),this.invInertia.set(N.x>0&&!V?1/N.x:0,N.y>0&&!V?1/N.y:0,N.z>0&&!V?1/N.z:0),this.updateInertiaWorld(!0)},c.prototype.getVelocityAtWorldPoint=function(A,N){var V=new s;return A.vsub(this.position,V),this.angularVelocity.cross(V,N),this.velocity.vadd(N,N),N}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,n,r){t("./Body");var o=t("../math/Vec3"),s=t("../math/Quaternion");t("../collision/RaycastResult");var i=t("../collision/Ray"),l=t("../objects/WheelInfo");n.exports=h;function h(R){this.chassisBody=R.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof R.indexRightAxis<"u"?R.indexRightAxis:1,this.indexForwardAxis=typeof R.indexForwardAxis<"u"?R.indexForwardAxis:0,this.indexUpAxis=typeof R.indexUpAxis<"u"?R.indexUpAxis:2}new o,new o,new o;var u=new o,c=new o,d=new o;new i,h.prototype.addWheel=function(R){R=R||{};var P=new l(R),Q=this.wheelInfos.length;return this.wheelInfos.push(P),Q},h.prototype.setSteeringValue=function(R,P){var Q=this.wheelInfos[P];Q.steering=R},new o,h.prototype.applyEngineForce=function(R,P){this.wheelInfos[P].engineForce=R},h.prototype.setBrake=function(R,P){this.wheelInfos[P].brake=R},h.prototype.addToWorld=function(R){this.constraints,R.add(this.chassisBody);var P=this;this.preStepCallback=function(){P.updateVehicle(R.dt)},R.addEventListener("preStep",this.preStepCallback),this.world=R},h.prototype.getVehicleAxisWorld=function(R,P){P.set(R===0?1:0,R===1?1:0,R===2?1:0),this.chassisBody.vectorToWorldFrame(P,P)},h.prototype.updateVehicle=function(R){for(var P=this.wheelInfos,Q=P.length,D=this.chassisBody,S=0;S<Q;S++)this.updateWheelTransform(S);this.currentVehicleSpeedKmHour=3.6*D.velocity.norm();var G=new o;this.getVehicleAxisWorld(this.indexForwardAxis,G),G.dot(D.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var S=0;S<Q;S++)this.castRay(P[S]);this.updateSuspension(R);for(var E=new o,T=new o,S=0;S<Q;S++){var x=P[S],L=x.suspensionForce;L>x.maxSuspensionForce&&(L=x.maxSuspensionForce),x.raycastResult.hitNormalWorld.scale(L*R,E),x.raycastResult.hitPointWorld.vsub(D.position,T),D.applyImpulse(E,x.raycastResult.hitPointWorld)}this.updateFriction(R);var J=new o,z=new o,O=new o;for(S=0;S<Q;S++){var x=P[S];D.getVelocityAtWorldPoint(x.chassisConnectionPointWorld,O);var W=1;switch(this.indexUpAxis){case 1:W=-1;break}if(x.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,z);var te=z.dot(x.raycastResult.hitNormalWorld);x.raycastResult.hitNormalWorld.scale(te,J),z.vsub(J,z);var Ae=z.dot(O);x.deltaRotation=W*Ae*R/x.radius}(x.sliding||!x.isInContact)&&x.engineForce!==0&&x.useCustomSlidingRotationalSpeed&&(x.deltaRotation=(x.engineForce>0?1:-1)*x.customSlidingRotationalSpeed*R),Math.abs(x.brake)>Math.abs(x.engineForce)&&(x.deltaRotation=0),x.rotation+=x.deltaRotation,x.deltaRotation*=.99}},h.prototype.updateSuspension=function(R){for(var P=this.chassisBody,Q=P.mass,D=this.wheelInfos,S=D.length,G=0;G<S;G++){var E=D[G];if(E.isInContact){var T,x=E.suspensionRestLength,L=E.suspensionLength,J=x-L;T=E.suspensionStiffness*J*E.clippedInvContactDotSuspension;var z=E.suspensionRelativeVelocity,O;z<0?O=E.dampingCompression:O=E.dampingRelaxation,T-=O*z,E.suspensionForce=T*Q,E.suspensionForce<0&&(E.suspensionForce=0)}else E.suspensionForce=0}},h.prototype.removeFromWorld=function(R){this.constraints,R.remove(this.chassisBody),R.removeEventListener("preStep",this.preStepCallback),this.world=null};var p=new o,f=new o;h.prototype.castRay=function(R){var P=p,Q=f;this.updateWheelTransformWorld(R);var D=this.chassisBody,S=-1,G=R.suspensionRestLength+R.radius;R.directionWorld.scale(G,P);var E=R.chassisConnectionPointWorld;E.vadd(P,Q);var T=R.raycastResult;T.reset();var x=D.collisionResponse;D.collisionResponse=!1,this.world.rayTest(E,Q,T),D.collisionResponse=x;var L=T.body;if(R.raycastResult.groundObject=0,L){S=T.distance,R.raycastResult.hitNormalWorld=T.hitNormalWorld,R.isInContact=!0;var J=T.distance;R.suspensionLength=J-R.radius;var z=R.suspensionRestLength-R.maxSuspensionTravel,O=R.suspensionRestLength+R.maxSuspensionTravel;R.suspensionLength<z&&(R.suspensionLength=z),R.suspensionLength>O&&(R.suspensionLength=O,R.raycastResult.reset());var W=R.raycastResult.hitNormalWorld.dot(R.directionWorld),te=new o;D.getVelocityAtWorldPoint(R.raycastResult.hitPointWorld,te);var Ae=R.raycastResult.hitNormalWorld.dot(te);if(W>=-.1)R.suspensionRelativeVelocity=0,R.clippedInvContactDotSuspension=1/.1;else{var ve=-1/W;R.suspensionRelativeVelocity=Ae*ve,R.clippedInvContactDotSuspension=ve}}else R.suspensionLength=R.suspensionRestLength+0*R.maxSuspensionTravel,R.suspensionRelativeVelocity=0,R.directionWorld.scale(-1,R.raycastResult.hitNormalWorld),R.clippedInvContactDotSuspension=1;return S},h.prototype.updateWheelTransformWorld=function(R){R.isInContact=!1;var P=this.chassisBody;P.pointToWorldFrame(R.chassisConnectionPointLocal,R.chassisConnectionPointWorld),P.vectorToWorldFrame(R.directionLocal,R.directionWorld),P.vectorToWorldFrame(R.axleLocal,R.axleWorld)},h.prototype.updateWheelTransform=function(R){var P=u,Q=c,D=d,S=this.wheelInfos[R];this.updateWheelTransformWorld(S),S.directionLocal.scale(-1,P),Q.copy(S.axleLocal),P.cross(Q,D),D.normalize(),Q.normalize();var G=S.steering,E=new s;E.setFromAxisAngle(P,G);var T=new s;T.setFromAxisAngle(Q,S.rotation);var x=S.worldTransform.quaternion;this.chassisBody.quaternion.mult(E,x),x.mult(T,x),x.normalize();var L=S.worldTransform.position;L.copy(S.directionWorld),L.scale(S.suspensionLength,L),L.vadd(S.chassisConnectionPointWorld,L)};var g=[new o(1,0,0),new o(0,1,0),new o(0,0,1)];h.prototype.getWheelTransformWorld=function(R){return this.wheelInfos[R].worldTransform};var y=new o,m=[],_=[],b=1;h.prototype.updateFriction=function(R){for(var P=y,Q=this.wheelInfos,D=Q.length,S=this.chassisBody,G=_,E=m,T=0;T<D;T++){var x=Q[T],L=x.raycastResult.body;x.sideImpulse=0,x.forwardImpulse=0,G[T]||(G[T]=new o),E[T]||(E[T]=new o)}for(var T=0;T<D;T++){var x=Q[T],L=x.raycastResult.body;if(L){var J=E[T],z=this.getWheelTransformWorld(T);z.vectorToWorldFrame(g[this.indexRightAxis],J);var O=x.raycastResult.hitNormalWorld,W=J.dot(O);O.scale(W,P),J.vsub(P,J),J.normalize(),O.cross(J,G[T]),G[T].normalize(),x.sideImpulse=ue(S,x.raycastResult.hitPointWorld,L,x.raycastResult.hitPointWorld,J),x.sideImpulse*=b}}var te=1,Ae=.5;this.sliding=!1;for(var T=0;T<D;T++){var x=Q[T],L=x.raycastResult.body,ve=0;if(x.slipInfo=1,L){var me=0,j=x.brake?x.brake:me;ve=F(S,L,x.raycastResult.hitPointWorld,G[T],j),ve+=x.engineForce*R;var se=j/ve;x.slipInfo*=se}if(x.forwardImpulse=0,x.skidInfo=1,L){x.skidInfo=1;var $e=x.suspensionForce*R*x.frictionSlip,Ee=$e,Qe=$e*Ee;x.forwardImpulse=ve;var we=x.forwardImpulse*Ae,Ke=x.sideImpulse*te,Xe=we*we+Ke*Ke;if(x.sliding=!1,Xe>Qe){this.sliding=!0,x.sliding=!0;var se=$e/Math.sqrt(Xe);x.skidInfo*=se}}}if(this.sliding)for(var T=0;T<D;T++){var x=Q[T];x.sideImpulse!==0&&x.skidInfo<1&&(x.forwardImpulse*=x.skidInfo,x.sideImpulse*=x.skidInfo)}for(var T=0;T<D;T++){var x=Q[T],je=new o;if(je.copy(x.raycastResult.hitPointWorld),x.forwardImpulse!==0){var Ze=new o;G[T].scale(x.forwardImpulse,Ze),S.applyImpulse(Ze,je)}if(x.sideImpulse!==0){var L=x.raycastResult.body,He=new o;He.copy(x.raycastResult.hitPointWorld);var tt=new o;E[T].scale(x.sideImpulse,tt),S.pointToLocalFrame(je,je),je["xyz"[this.indexUpAxis]]*=x.rollInfluence,S.pointToWorldFrame(je,je),S.applyImpulse(tt,je),tt.scale(-1,tt),L.applyImpulse(tt,He)}}};var v=new o,w=new o,I=new o;function F(R,P,Q,D,S){var G=0,E=Q,T=v,x=w,L=I;R.getVelocityAtWorldPoint(E,T),P.getVelocityAtWorldPoint(E,x),T.vsub(x,L);var J=D.dot(L),z=N(R,Q,D),O=N(P,Q,D),W=1,te=W/(z+O);return G=-J*te,S<G&&(G=S),G<-S&&(G=-S),G}var M=new o,B=new o,C=new o,A=new o;function N(R,P,Q){var D=M,S=B,G=C,E=A;return P.vsub(R.position,D),D.cross(Q,S),R.invInertiaWorld.vmult(S,E),E.cross(D,G),R.invMass+Q.dot(G)}var V=new o,U=new o,X=new o;function ue(R,P,Q,D,S,O){var E=S.norm2();if(E>1.1)return 0;var T=V,x=U,L=X;R.getVelocityAtWorldPoint(P,T),Q.getVelocityAtWorldPoint(D,x),T.vsub(x,L);var J=S.dot(L),z=1/(R.invMass+Q.invMass),O=-.2*J*z;return O}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,n,r){var o=t("./Body"),s=t("../shapes/Sphere"),i=t("../shapes/Box"),l=t("../math/Vec3"),h=t("../constraints/HingeConstraint");n.exports=u;function u(p){if(this.wheelBodies=[],this.coordinateSystem=typeof p.coordinateSystem>"u"?new l(1,2,3):p.coordinateSystem.clone(),this.chassisBody=p.chassisBody,!this.chassisBody){var f=new i(new l(5,2,.5));this.chassisBody=new o(1,f)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}u.prototype.addWheel=function(p){p=p||{};var f=p.body;f||(f=new o(1,new s(1.2))),this.wheelBodies.push(f),this.wheelForces.push(0),new l;var g=typeof p.position<"u"?p.position.clone():new l,y=new l;this.chassisBody.pointToWorldFrame(g,y),f.position.set(y.x,y.y,y.z);var m=typeof p.axis<"u"?p.axis.clone():new l(0,1,0);this.wheelAxes.push(m);var _=new h(this.chassisBody,f,{pivotA:g,axisA:m,pivotB:l.ZERO,axisB:m,collideConnected:!1});return this.constraints.push(_),this.wheelBodies.length-1},u.prototype.setSteeringValue=function(p,f){var g=this.wheelAxes[f],y=Math.cos(p),m=Math.sin(p),_=g.x,b=g.y;this.constraints[f].axisA.set(y*_-m*b,m*_+y*b,0)},u.prototype.setMotorSpeed=function(p,f){var g=this.constraints[f];g.enableMotor(),g.motorTargetVelocity=p},u.prototype.disableMotor=function(p){var f=this.constraints[p];f.disableMotor()};var c=new l;u.prototype.setWheelForce=function(p,f){this.wheelForces[f]=p},u.prototype.applyWheelForce=function(p,f){var g=this.wheelAxes[f],y=this.wheelBodies[f],m=y.torque;g.scale(p,c),y.vectorToWorldFrame(c,c),m.vadd(c,m)},u.prototype.addToWorld=function(p){for(var f=this.constraints,g=this.wheelBodies.concat([this.chassisBody]),y=0;y<g.length;y++)p.add(g[y]);for(var y=0;y<f.length;y++)p.addConstraint(f[y]);p.addEventListener("preStep",this._update.bind(this))},u.prototype._update=function(){for(var p=this.wheelForces,f=0;f<p.length;f++)this.applyWheelForce(p[f],f)},u.prototype.removeFromWorld=function(p){for(var f=this.constraints,g=this.wheelBodies.concat([this.chassisBody]),y=0;y<g.length;y++)p.remove(g[y]);for(var y=0;y<f.length;y++)p.removeConstraint(f[y])};var d=new l;u.prototype.getWheelSpeed=function(p){var f=this.wheelAxes[p],g=this.wheelBodies[p],y=g.angularVelocity;return this.chassisBody.vectorToWorldFrame(f,d),y.dot(d)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,n,r){n.exports=s,t("../shapes/Shape");var o=t("../math/Vec3");t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material");function s(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}s.prototype.add=function(f){this.particles.push(f),this.neighbors.length<this.particles.length&&this.neighbors.push([])},s.prototype.remove=function(f){var g=this.particles.indexOf(f);g!==-1&&(this.particles.splice(g,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var i=new o;s.prototype.getNeighbors=function(f,g){for(var y=this.particles.length,m=f.id,_=this.smoothingRadius*this.smoothingRadius,b=i,v=0;v!==y;v++){var w=this.particles[v];w.position.vsub(f.position,b),m!==w.id&&b.norm2()<_&&g.push(w)}};var l=new o,h=new o,u=new o,c=new o,d=new o,p=new o;s.prototype.update=function(){for(var f=this.particles.length,g=l,y=this.speedOfSound,m=this.eps,_=0;_!==f;_++){var b=this.particles[_],v=this.neighbors[_];v.length=0,this.getNeighbors(b,v),v.push(this.particles[_]);for(var w=v.length,I=0,F=0;F!==w;F++){b.position.vsub(v[F].position,g);var M=g.norm(),B=this.w(M);I+=v[F].mass*B}this.densities[_]=I,this.pressures[_]=y*y*(this.densities[_]-this.density)}for(var C=h,A=u,N=c,V=d,U=p,_=0;_!==f;_++){var X=this.particles[_];C.set(0,0,0),A.set(0,0,0);for(var ue,R,v=this.neighbors[_],w=v.length,F=0;F!==w;F++){var P=v[F];X.position.vsub(P.position,V);var Q=V.norm();ue=-P.mass*(this.pressures[_]/(this.densities[_]*this.densities[_]+m)+this.pressures[F]/(this.densities[F]*this.densities[F]+m)),this.gradw(V,N),N.mult(ue,N),C.vadd(N,C),P.velocity.vsub(X.velocity,U),U.mult(1/(1e-4+this.densities[_]*this.densities[F])*this.viscosity*P.mass,U),R=this.nablaw(Q),U.mult(R,U),A.vadd(U,A)}A.mult(X.mass,A),C.mult(X.mass,C),X.force.vadd(A,X.force),X.force.vadd(C,X.force)}},s.prototype.w=function(f){var g=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(g,9))*Math.pow(g*g-f*f,3)},s.prototype.gradw=function(f,g){var y=f.norm(),m=this.smoothingRadius;f.mult(945/(32*Math.PI*Math.pow(m,9))*Math.pow(m*m-y*y,2),g)},s.prototype.nablaw=function(f){var g=this.smoothingRadius,y=945/(32*Math.PI*Math.pow(g,9))*(g*g-f*f)*(7*f*f-3*g*g);return y}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,n,r){var o=t("../math/Vec3");n.exports=s;function s(_,b,v){v=v||{},this.restLength=typeof v.restLength=="number"?v.restLength:1,this.stiffness=v.stiffness||100,this.damping=v.damping||1,this.bodyA=_,this.bodyB=b,this.localAnchorA=new o,this.localAnchorB=new o,v.localAnchorA&&this.localAnchorA.copy(v.localAnchorA),v.localAnchorB&&this.localAnchorB.copy(v.localAnchorB),v.worldAnchorA&&this.setWorldAnchorA(v.worldAnchorA),v.worldAnchorB&&this.setWorldAnchorB(v.worldAnchorB)}s.prototype.setWorldAnchorA=function(_){this.bodyA.pointToLocalFrame(_,this.localAnchorA)},s.prototype.setWorldAnchorB=function(_){this.bodyB.pointToLocalFrame(_,this.localAnchorB)},s.prototype.getWorldAnchorA=function(_){this.bodyA.pointToWorldFrame(this.localAnchorA,_)},s.prototype.getWorldAnchorB=function(_){this.bodyB.pointToWorldFrame(this.localAnchorB,_)};var i=new o,l=new o,h=new o,u=new o,c=new o,d=new o,p=new o,f=new o,g=new o,y=new o,m=new o;s.prototype.applyForce=function(){var _=this.stiffness,b=this.damping,v=this.restLength,w=this.bodyA,I=this.bodyB,F=i,M=l,B=h,C=u,A=m,N=c,V=d,U=p,X=f,ue=g,R=y;this.getWorldAnchorA(N),this.getWorldAnchorB(V),N.vsub(w.position,U),V.vsub(I.position,X),V.vsub(N,F);var P=F.norm();M.copy(F),M.normalize(),I.velocity.vsub(w.velocity,B),I.angularVelocity.cross(X,A),B.vadd(A,B),w.angularVelocity.cross(U,A),B.vsub(A,B),M.mult(-_*(P-v)-b*B.dot(M),C),w.force.vsub(C,w.force),I.force.vadd(C,I.force),U.cross(C,ue),X.cross(C,R),w.torque.vsub(ue,w.torque),I.torque.vadd(R,I.torque)}},{"../math/Vec3":30}],36:[function(t,n,r){var o=t("../math/Vec3"),s=t("../math/Transform"),i=t("../collision/RaycastResult"),l=t("../utils/Utils");n.exports=h;function h(d){d=l.defaults(d,{chassisConnectionPointLocal:new o,chassisConnectionPointWorld:new o,directionLocal:new o,directionWorld:new o,axleLocal:new o,axleWorld:new o,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=d.maxSuspensionTravel,this.customSlidingRotationalSpeed=d.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=d.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=d.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=d.chassisConnectionPointWorld.clone(),this.directionLocal=d.directionLocal.clone(),this.directionWorld=d.directionWorld.clone(),this.axleLocal=d.axleLocal.clone(),this.axleWorld=d.axleWorld.clone(),this.suspensionRestLength=d.suspensionRestLength,this.suspensionMaxLength=d.suspensionMaxLength,this.radius=d.radius,this.suspensionStiffness=d.suspensionStiffness,this.dampingCompression=d.dampingCompression,this.dampingRelaxation=d.dampingRelaxation,this.frictionSlip=d.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=d.rollInfluence,this.maxSuspensionForce=d.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=d.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new i,this.worldTransform=new s,this.isInContact=!1}var c=new o,u=new o,c=new o;h.prototype.updateWheel=function(d){var p=this.raycastResult;if(this.isInContact){var f=p.hitNormalWorld.dot(p.directionWorld);p.hitPointWorld.vsub(d.position,u),d.getVelocityAtWorldPoint(u,c);var g=p.hitNormalWorld.dot(c);if(f>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var y=-1/f;this.suspensionRelativeVelocity=g*y,this.clippedInvContactDotSuspension=y}}else p.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,p.directionWorld.scale(-1,p.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,n,r){n.exports=l;var o=t("./Shape"),s=t("../math/Vec3"),i=t("./ConvexPolyhedron");function l(c){o.call(this),this.type=o.types.BOX,this.halfExtents=c,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}l.prototype=new o,l.prototype.constructor=l,l.prototype.updateConvexPolyhedronRepresentation=function(){var c=this.halfExtents.x,d=this.halfExtents.y,p=this.halfExtents.z,f=s,g=[new f(-c,-d,-p),new f(c,-d,-p),new f(c,d,-p),new f(-c,d,-p),new f(-c,-d,p),new f(c,-d,p),new f(c,d,p),new f(-c,d,p)],y=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new f(0,0,1),new f(0,1,0),new f(1,0,0);var m=new i(g,y);this.convexPolyhedronRepresentation=m,m.material=this.material},l.prototype.calculateLocalInertia=function(c,d){return d=d||new s,l.calculateInertia(this.halfExtents,c,d),d},l.calculateInertia=function(c,d,p){var f=c;p.x=1/12*d*(2*f.y*2*f.y+2*f.z*2*f.z),p.y=1/12*d*(2*f.x*2*f.x+2*f.z*2*f.z),p.z=1/12*d*(2*f.y*2*f.y+2*f.x*2*f.x)},l.prototype.getSideNormals=function(c,d){var p=c,f=this.halfExtents;if(p[0].set(f.x,0,0),p[1].set(0,f.y,0),p[2].set(0,0,f.z),p[3].set(-f.x,0,0),p[4].set(0,-f.y,0),p[5].set(0,0,-f.z),d!==void 0)for(var g=0;g!==p.length;g++)d.vmult(p[g],p[g]);return p},l.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},l.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var h=new s;new s,l.prototype.forEachWorldCorner=function(c,d,p){for(var f=this.halfExtents,g=[[f.x,f.y,f.z],[-f.x,f.y,f.z],[-f.x,-f.y,f.z],[-f.x,-f.y,-f.z],[f.x,-f.y,-f.z],[f.x,f.y,-f.z],[-f.x,f.y,-f.z],[f.x,-f.y,f.z]],y=0;y<g.length;y++)h.set(g[y][0],g[y][1],g[y][2]),d.vmult(h,h),c.vadd(h,h),p(h.x,h.y,h.z)};var u=[new s,new s,new s,new s,new s,new s,new s,new s];l.prototype.calculateWorldAABB=function(c,d,p,f){var g=this.halfExtents;u[0].set(g.x,g.y,g.z),u[1].set(-g.x,g.y,g.z),u[2].set(-g.x,-g.y,g.z),u[3].set(-g.x,-g.y,-g.z),u[4].set(g.x,-g.y,-g.z),u[5].set(g.x,g.y,-g.z),u[6].set(-g.x,g.y,-g.z),u[7].set(g.x,-g.y,g.z);var y=u[0];d.vmult(y,y),c.vadd(y,y),f.copy(y),p.copy(y);for(var m=1;m<8;m++){var y=u[m];d.vmult(y,y),c.vadd(y,y);var _=y.x,b=y.y,v=y.z;_>f.x&&(f.x=_),b>f.y&&(f.y=b),v>f.z&&(f.z=v),_<p.x&&(p.x=_),b<p.y&&(p.y=b),v<p.z&&(p.z=v)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,n,r){n.exports=l;var o=t("./Shape"),s=t("../math/Vec3");t("../math/Quaternion");var i=t("../math/Transform");function l(S,G,E){o.call(this),this.type=o.types.CONVEXPOLYHEDRON,this.vertices=S||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=G||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=E?E.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}l.prototype=new o,l.prototype.constructor=l;var h=new s;l.prototype.computeEdges=function(){var S=this.faces,G=this.vertices;G.length;var E=this.uniqueEdges;E.length=0;for(var T=h,x=0;x!==S.length;x++)for(var L=S[x],J=L.length,z=0;z!==J;z++){var O=(z+1)%J;G[L[z]].vsub(G[L[O]],T),T.normalize();for(var W=!1,te=0;te!==E.length;te++)if(E[te].almostEquals(T)||E[te].almostEquals(T)){W=!0;break}W||E.push(T.clone())}},l.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var S=0;S<this.faces.length;S++){for(var G=0;G<this.faces[S].length;G++)if(!this.vertices[this.faces[S][G]])throw new Error("Vertex "+this.faces[S][G]+" not found!");var E=this.faceNormals[S]||new s;this.getFaceNormal(S,E),E.negate(E),this.faceNormals[S]=E;var T=this.vertices[this.faces[S][0]];if(E.dot(T)<0){console.error(".faceNormals["+S+"] = Vec3("+E.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var G=0;G<this.faces[S].length;G++)console.warn(".vertices["+this.faces[S][G]+"] = Vec3("+this.vertices[this.faces[S][G]].toString()+")")}}};var u=new s,c=new s;l.computeNormal=function(S,G,E,T){G.vsub(S,c),E.vsub(G,u),u.cross(c,T),T.isZero()||T.normalize()},l.prototype.getFaceNormal=function(S,G){var E=this.faces[S],T=this.vertices[E[0]],x=this.vertices[E[1]],L=this.vertices[E[2]];return l.computeNormal(T,x,L,G)};var d=new s;l.prototype.clipAgainstHull=function(S,G,E,T,x,L,J,z,O){for(var W=d,te=-1,Ae=-Number.MAX_VALUE,ve=0;ve<E.faces.length;ve++){W.copy(E.faceNormals[ve]),x.vmult(W,W);var me=W.dot(L);me>Ae&&(Ae=me,te=ve)}for(var j=[],se=E.faces[te],$e=se.length,Ee=0;Ee<$e;Ee++){var Qe=E.vertices[se[Ee]],we=new s;we.copy(Qe),x.vmult(we,we),T.vadd(we,we),j.push(we)}te>=0&&this.clipFaceAgainstHull(L,S,G,j,J,z,O)};var p=new s,f=new s,g=new s,y=new s,m=new s,_=new s;l.prototype.findSeparatingAxis=function(S,G,E,T,x,L,J,z){var O=p,W=f,te=g,Ae=y,ve=m,me=_,j=Number.MAX_VALUE,se=this;if(se.uniqueAxes)for(var Ee=0;Ee!==se.uniqueAxes.length;Ee++){E.vmult(se.uniqueAxes[Ee],O);var we=se.testSepAxis(O,S,G,E,T,x);if(we===!1)return!1;we<j&&(j=we,L.copy(O))}else for(var $e=J?J.length:se.faces.length,Ee=0;Ee<$e;Ee++){var Qe=J?J[Ee]:Ee;O.copy(se.faceNormals[Qe]),E.vmult(O,O);var we=se.testSepAxis(O,S,G,E,T,x);if(we===!1)return!1;we<j&&(j=we,L.copy(O))}if(S.uniqueAxes)for(var Ee=0;Ee!==S.uniqueAxes.length;Ee++){x.vmult(S.uniqueAxes[Ee],W);var we=se.testSepAxis(W,S,G,E,T,x);if(we===!1)return!1;we<j&&(j=we,L.copy(W))}else for(var Ke=z?z.length:S.faces.length,Ee=0;Ee<Ke;Ee++){var Qe=z?z[Ee]:Ee;W.copy(S.faceNormals[Qe]),x.vmult(W,W);var we=se.testSepAxis(W,S,G,E,T,x);if(we===!1)return!1;we<j&&(j=we,L.copy(W))}for(var Xe=0;Xe!==se.uniqueEdges.length;Xe++){E.vmult(se.uniqueEdges[Xe],Ae);for(var je=0;je!==S.uniqueEdges.length;je++)if(x.vmult(S.uniqueEdges[je],ve),Ae.cross(ve,me),!me.almostZero()){me.normalize();var Ze=se.testSepAxis(me,S,G,E,T,x);if(Ze===!1)return!1;Ze<j&&(j=Ze,L.copy(me))}}return T.vsub(G,te),te.dot(L)>0&&L.negate(L),!0};var b=[],v=[];l.prototype.testSepAxis=function(S,G,E,T,x,L){var J=this;l.project(J,S,E,T,b),l.project(G,S,x,L,v);var z=b[0],O=b[1],W=v[0],te=v[1];if(z<te||W<O)return!1;var Ae=z-te,ve=W-O,me=Ae<ve?Ae:ve;return me};var w=new s,I=new s;l.prototype.calculateLocalInertia=function(S,G){this.computeLocalAABB(w,I);var E=I.x-w.x,T=I.y-w.y,x=I.z-w.z;G.x=1/12*S*(2*T*2*T+2*x*2*x),G.y=1/12*S*(2*E*2*E+2*x*2*x),G.z=1/12*S*(2*T*2*T+2*E*2*E)},l.prototype.getPlaneConstantOfFace=function(S){var G=this.faces[S],E=this.faceNormals[S],T=this.vertices[G[0]],x=-E.dot(T);return x};var F=new s,M=new s,B=new s,C=new s,A=new s,N=new s,V=new s,U=new s;l.prototype.clipFaceAgainstHull=function(S,G,E,T,x,L,J){for(var z=F,O=M,W=B,te=C,Ae=A,ve=N,me=V,j=U,se=this,$e=[],Ee=T,Qe=$e,we=-1,Ke=Number.MAX_VALUE,Xe=0;Xe<se.faces.length;Xe++){z.copy(se.faceNormals[Xe]),E.vmult(z,z);var je=z.dot(S);je<Ke&&(Ke=je,we=Xe)}if(!(we<0)){var Ze=se.faces[we];Ze.connectedFaces=[];for(var He=0;He<se.faces.length;He++)for(var tt=0;tt<se.faces[He].length;tt++)Ze.indexOf(se.faces[He][tt])!==-1&&He!==we&&Ze.connectedFaces.indexOf(He)===-1&&Ze.connectedFaces.push(He);Ee.length;for(var ze=Ze.length,ut=0;ut<ze;ut++){var Tt=se.vertices[Ze[ut]],Qt=se.vertices[Ze[(ut+1)%ze]];Tt.vsub(Qt,O),W.copy(O),E.vmult(W,W),G.vadd(W,W),te.copy(this.faceNormals[we]),E.vmult(te,te),G.vadd(te,te),W.cross(te,Ae),Ae.negate(Ae),ve.copy(Tt),E.vmult(ve,ve),G.vadd(ve,ve),-ve.dot(Ae);var Ft;{var an=Ze.connectedFaces[ut];me.copy(this.faceNormals[an]);var Jt=this.getPlaneConstantOfFace(an);j.copy(me),E.vmult(j,j);var Ft=Jt-j.dot(G)}for(this.clipFaceAgainstPlane(Ee,Qe,j,Ft);Ee.length;)Ee.shift();for(;Qe.length;)Ee.push(Qe.shift())}me.copy(this.faceNormals[we]);var Jt=this.getPlaneConstantOfFace(we);j.copy(me),E.vmult(j,j);for(var Ft=Jt-j.dot(G),He=0;He<Ee.length;He++){var Lt=j.dot(Ee[He])+Ft;if(Lt<=x&&(console.log("clamped: depth="+Lt+" to minDist="+(x+"")),Lt=x),Lt<=L){var mn=Ee[He];if(Lt<=0){var ln={point:mn,normal:j,depth:Lt};J.push(ln)}}}}},l.prototype.clipFaceAgainstPlane=function(S,G,E,T){var x,L,J=S.length;if(J<2)return G;var z=S[S.length-1],O=S[0];x=E.dot(z)+T;for(var W=0;W<J;W++){if(O=S[W],L=E.dot(O)+T,x<0)if(L<0){var te=new s;te.copy(O),G.push(te)}else{var te=new s;z.lerp(O,x/(x-L),te),G.push(te)}else if(L<0){var te=new s;z.lerp(O,x/(x-L),te),G.push(te),G.push(O)}z=O,x=L}return G},l.prototype.computeWorldVertices=function(S,G){for(var E=this.vertices.length;this.worldVertices.length<E;)this.worldVertices.push(new s);for(var T=this.vertices,x=this.worldVertices,L=0;L!==E;L++)G.vmult(T[L],x[L]),S.vadd(x[L],x[L]);this.worldVerticesNeedsUpdate=!1},new s,l.prototype.computeLocalAABB=function(S,G){var E=this.vertices.length,T=this.vertices;S.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),G.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var x=0;x<E;x++){var L=T[x];L.x<S.x?S.x=L.x:L.x>G.x&&(G.x=L.x),L.y<S.y?S.y=L.y:L.y>G.y&&(G.y=L.y),L.z<S.z?S.z=L.z:L.z>G.z&&(G.z=L.z)}},l.prototype.computeWorldFaceNormals=function(S){for(var G=this.faceNormals.length;this.worldFaceNormals.length<G;)this.worldFaceNormals.push(new s);for(var E=this.faceNormals,T=this.worldFaceNormals,x=0;x!==G;x++)S.vmult(E[x],T[x]);this.worldFaceNormalsNeedsUpdate=!1},l.prototype.updateBoundingSphereRadius=function(){for(var S=0,G=this.vertices,E=0,T=G.length;E!==T;E++){var x=G[E].norm2();x>S&&(S=x)}this.boundingSphereRadius=Math.sqrt(S)};var X=new s;l.prototype.calculateWorldAABB=function(S,G,E,T){for(var x=this.vertices.length,L=this.vertices,J,z,O,W,te,Ae,ve=0;ve<x;ve++){X.copy(L[ve]),G.vmult(X,X),S.vadd(X,X);var me=X;me.x<J||J===void 0?J=me.x:(me.x>W||W===void 0)&&(W=me.x),me.y<z||z===void 0?z=me.y:(me.y>te||te===void 0)&&(te=me.y),me.z<O||O===void 0?O=me.z:(me.z>Ae||Ae===void 0)&&(Ae=me.z)}E.set(J,z,O),T.set(W,te,Ae)},l.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},l.prototype.getAveragePointLocal=function(S){S=S||new s;for(var G=this.vertices.length,E=this.vertices,T=0;T<G;T++)S.vadd(E[T],S);return S.mult(1/G,S),S},l.prototype.transformAllPoints=function(S,G){var E=this.vertices.length,T=this.vertices;if(G){for(var x=0;x<E;x++){var L=T[x];G.vmult(L,L)}for(var x=0;x<this.faceNormals.length;x++){var L=this.faceNormals[x];G.vmult(L,L)}}if(S)for(var x=0;x<E;x++){var L=T[x];L.vadd(S,L)}};var ue=new s,R=new s,P=new s;l.prototype.pointIsInside=function(S){var G=this.vertices.length,E=this.vertices,T=this.faces,x=this.faceNormals,L=null,J=this.faces.length,z=ue;this.getAveragePointLocal(z);for(var O=0;O<J;O++){this.faces[O].length;var G=x[O],W=E[T[O][0]],te=R;S.vsub(W,te);var Ae=G.dot(te),ve=P;z.vsub(W,ve);var me=G.dot(ve);if(Ae<0&&me>0||Ae>0&&me<0)return!1}return L?1:-1},new s;var Q=new s,D=new s;l.project=function(S,G,E,T,x){var L=S.vertices.length,J=Q,z=0,O=0,W=D,te=S.vertices;W.setZero(),i.vectorToLocalFrame(E,T,G,J),i.pointToLocalFrame(E,T,W,W);var Ae=W.dot(J);O=z=te[0].dot(J);for(var ve=1;ve<L;ve++){var me=te[ve].dot(J);me>z&&(z=me),me<O&&(O=me)}if(O-=Ae,z-=Ae,O>z){var j=O;O=z,z=j}x[0]=z,x[1]=O}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,n,r){n.exports=l;var o=t("./Shape"),s=t("../math/Vec3");t("../math/Quaternion");var i=t("./ConvexPolyhedron");function l(h,u,c,d){var p=d,f=[],g=[],y=[],m=[],_=[],b=Math.cos,v=Math.sin;f.push(new s(u*b(0),u*v(0),-c*.5)),m.push(0),f.push(new s(h*b(0),h*v(0),c*.5)),_.push(1);for(var w=0;w<p;w++){var I=2*Math.PI/p*(w+1),F=2*Math.PI/p*(w+.5);w<p-1?(f.push(new s(u*b(I),u*v(I),-c*.5)),m.push(2*w+2),f.push(new s(h*b(I),h*v(I),c*.5)),_.push(2*w+3),y.push([2*w+2,2*w+3,2*w+1,2*w])):y.push([0,1,2*w+1,2*w]),(p%2===1||w<p/2)&&g.push(new s(b(F),v(F),0))}y.push(_),g.push(new s(0,0,1));for(var M=[],w=0;w<m.length;w++)M.push(m[m.length-w-1]);y.push(M),this.type=o.types.CONVEXPOLYHEDRON,i.call(this,f,y,g)}l.prototype=new i},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,n,r){var o=t("./Shape"),s=t("./ConvexPolyhedron"),i=t("../math/Vec3"),l=t("../utils/Utils");n.exports=h;function h(u,c){c=l.defaults(c,{maxValue:null,minValue:null,elementSize:1}),this.data=u,this.maxValue=c.maxValue,this.minValue=c.minValue,this.elementSize=c.elementSize,c.minValue===null&&this.updateMinValue(),c.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,o.call(this),this.pillarConvex=new s,this.pillarOffset=new i,this.type=o.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}h.prototype=new o,h.prototype.update=function(){this._cachedPillars={}},h.prototype.updateMinValue=function(){for(var u=this.data,c=u[0][0],d=0;d!==u.length;d++)for(var p=0;p!==u[d].length;p++){var f=u[d][p];f<c&&(c=f)}this.minValue=c},h.prototype.updateMaxValue=function(){for(var u=this.data,c=u[0][0],d=0;d!==u.length;d++)for(var p=0;p!==u[d].length;p++){var f=u[d][p];f>c&&(c=f)}this.maxValue=c},h.prototype.setHeightValueAtIndex=function(u,c,d){var p=this.data;p[u][c]=d,this.clearCachedConvexTrianglePillar(u,c,!1),u>0&&(this.clearCachedConvexTrianglePillar(u-1,c,!0),this.clearCachedConvexTrianglePillar(u-1,c,!1)),c>0&&(this.clearCachedConvexTrianglePillar(u,c-1,!0),this.clearCachedConvexTrianglePillar(u,c-1,!1)),c>0&&u>0&&this.clearCachedConvexTrianglePillar(u-1,c-1,!0)},h.prototype.getRectMinMax=function(u,c,d,p,f){f=f||[];for(var g=this.data,y=this.minValue,m=u;m<=d;m++)for(var _=c;_<=p;_++){var b=g[m][_];b>y&&(y=b)}f[0]=this.minValue,f[1]=y},h.prototype.getIndexOfPosition=function(u,c,d,p){var f=this.elementSize,g=this.data,y=Math.floor(u/f),m=Math.floor(c/f);return d[0]=y,d[1]=m,p&&(y<0&&(y=0),m<0&&(m=0),y>=g.length-1&&(y=g.length-1),m>=g[0].length-1&&(m=g[0].length-1)),!(y<0||m<0||y>=g.length-1||m>=g[0].length-1)},h.prototype.getHeightAt=function(u,c,d){var p=[];this.getIndexOfPosition(u,c,p,d);var f=[];return this.getRectMinMax(p[0],p[1]+1,p[0],p[1]+1,f),(f[0]+f[1])/2},h.prototype.getCacheConvexTrianglePillarKey=function(u,c,d){return u+"_"+c+"_"+(d?1:0)},h.prototype.getCachedConvexTrianglePillar=function(u,c,d){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(u,c,d)]},h.prototype.setCachedConvexTrianglePillar=function(u,c,d,p,f){this._cachedPillars[this.getCacheConvexTrianglePillarKey(u,c,d)]={convex:p,offset:f}},h.prototype.clearCachedConvexTrianglePillar=function(u,c,d){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(u,c,d)]},h.prototype.getConvexTrianglePillar=function(u,c,d){var p=this.pillarConvex,f=this.pillarOffset;if(this.cacheEnabled){var g=this.getCachedConvexTrianglePillar(u,c,d);if(g){this.pillarConvex=g.convex,this.pillarOffset=g.offset;return}p=new s,f=new i,this.pillarConvex=p,this.pillarOffset=f}var g=this.data,y=this.elementSize,m=p.faces;p.vertices.length=6;for(var _=0;_<6;_++)p.vertices[_]||(p.vertices[_]=new i);m.length=5;for(var _=0;_<5;_++)m[_]||(m[_]=[]);var b=p.vertices,v=(Math.min(g[u][c],g[u+1][c],g[u][c+1],g[u+1][c+1])-this.minValue)/2+this.minValue;d?(f.set((u+.75)*y,(c+.75)*y,v),b[0].set(.25*y,.25*y,g[u+1][c+1]-v),b[1].set(-.75*y,.25*y,g[u][c+1]-v),b[2].set(.25*y,-.75*y,g[u+1][c]-v),b[3].set(.25*y,.25*y,-v-1),b[4].set(-.75*y,.25*y,-v-1),b[5].set(.25*y,-.75*y,-v-1),m[0][0]=0,m[0][1]=1,m[0][2]=2,m[1][0]=5,m[1][1]=4,m[1][2]=3,m[2][0]=2,m[2][1]=5,m[2][2]=3,m[2][3]=0,m[3][0]=3,m[3][1]=4,m[3][2]=1,m[3][3]=0,m[4][0]=1,m[4][1]=4,m[4][2]=5,m[4][3]=2):(f.set((u+.25)*y,(c+.25)*y,v),b[0].set(-.25*y,-.25*y,g[u][c]-v),b[1].set(.75*y,-.25*y,g[u+1][c]-v),b[2].set(-.25*y,.75*y,g[u][c+1]-v),b[3].set(-.25*y,-.25*y,-v-1),b[4].set(.75*y,-.25*y,-v-1),b[5].set(-.25*y,.75*y,-v-1),m[0][0]=0,m[0][1]=1,m[0][2]=2,m[1][0]=5,m[1][1]=4,m[1][2]=3,m[2][0]=0,m[2][1]=2,m[2][2]=5,m[2][3]=3,m[3][0]=1,m[3][1]=0,m[3][2]=3,m[3][3]=4,m[4][0]=4,m[4][1]=5,m[4][2]=2,m[4][3]=1),p.computeNormals(),p.computeEdges(),p.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(u,c,d,p,f)},h.prototype.calculateLocalInertia=function(u,c){return c=c||new i,c.set(0,0,0),c},h.prototype.volume=function(){return Number.MAX_VALUE},h.prototype.calculateWorldAABB=function(u,c,d,p){d.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),p.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},h.prototype.updateBoundingSphereRadius=function(){var u=this.data,c=this.elementSize;this.boundingSphereRadius=new i(u.length*c,u[0].length*c,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,n,r){n.exports=i;var o=t("./Shape"),s=t("../math/Vec3");function i(){o.call(this),this.type=o.types.PARTICLE}i.prototype=new o,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(l,h){return h=h||new s,h.set(0,0,0),h},i.prototype.volume=function(){return 0},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},i.prototype.calculateWorldAABB=function(l,h,u,c){u.copy(l),c.copy(l)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,n,r){n.exports=i;var o=t("./Shape"),s=t("../math/Vec3");function i(){o.call(this),this.type=o.types.PLANE,this.worldNormal=new s,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}i.prototype=new o,i.prototype.constructor=i,i.prototype.computeWorldNormal=function(h){var u=this.worldNormal;u.set(0,0,1),h.vmult(u,u),this.worldNormalNeedsUpdate=!1},i.prototype.calculateLocalInertia=function(h,u){return u=u||new s,u},i.prototype.volume=function(){return Number.MAX_VALUE};var l=new s;i.prototype.calculateWorldAABB=function(h,u,c,d){l.set(0,0,1),u.vmult(l,l);var p=Number.MAX_VALUE;c.set(-p,-p,-p),d.set(p,p,p),l.x===1&&(d.x=h.x),l.y===1&&(d.y=h.y),l.z===1&&(d.z=h.z),l.x===-1&&(c.x=h.x),l.y===-1&&(c.y=h.y),l.z===-1&&(c.z=h.z)},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,n,r){n.exports=o;var o=t("./Shape");t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material");function o(){this.id=o.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}o.prototype.constructor=o,o.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},o.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},o.prototype.calculateLocalInertia=function(s,i){throw"calculateLocalInertia() not implemented for shape type "+this.type},o.idCounter=0,o.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,n,r){n.exports=i;var o=t("./Shape"),s=t("../math/Vec3");function i(l){if(o.call(this),this.radius=l!==void 0?Number(l):1,this.type=o.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}i.prototype=new o,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(l,h){h=h||new s;var u=2*l*this.radius*this.radius/5;return h.x=u,h.y=u,h.z=u,h},i.prototype.volume=function(){return 4*Math.PI*this.radius/3},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},i.prototype.calculateWorldAABB=function(l,h,u,c){for(var d=this.radius,p=["x","y","z"],f=0;f<p.length;f++){var g=p[f];u[g]=l[g]-d,c[g]=l[g]+d}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,n,r){n.exports=u;var o=t("./Shape"),s=t("../math/Vec3");t("../math/Quaternion");var i=t("../math/Transform"),l=t("../collision/AABB"),h=t("../utils/Octree");function u(M,B){o.call(this),this.type=o.types.TRIMESH,this.vertices=new Float32Array(M),this.indices=new Int16Array(B),this.normals=new Float32Array(B.length),this.aabb=new l,this.edges=null,this.scale=new s(1,1,1),this.tree=new h,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}u.prototype=new o,u.prototype.constructor=u;var c=new s;u.prototype.updateTree=function(){var M=this.tree;M.reset(),M.aabb.copy(this.aabb);var B=this.scale;M.aabb.lowerBound.x*=1/B.x,M.aabb.lowerBound.y*=1/B.y,M.aabb.lowerBound.z*=1/B.z,M.aabb.upperBound.x*=1/B.x,M.aabb.upperBound.y*=1/B.y,M.aabb.upperBound.z*=1/B.z;for(var C=new l,A=new s,N=new s,V=new s,U=[A,N,V],X=0;X<this.indices.length/3;X++){var ue=X*3;this._getUnscaledVertex(this.indices[ue],A),this._getUnscaledVertex(this.indices[ue+1],N),this._getUnscaledVertex(this.indices[ue+2],V),C.setFromPoints(U),M.insert(C,X)}M.removeEmptyNodes()};var d=new l;u.prototype.getTrianglesInAABB=function(M,B){d.copy(M);var C=this.scale,A=C.x,N=C.y,V=C.z,U=d.lowerBound,X=d.upperBound;return U.x/=A,U.y/=N,U.z/=V,X.x/=A,X.y/=N,X.z/=V,this.tree.aabbQuery(d,B)},u.prototype.setScale=function(M){var B=this.scale.x===this.scale.y===this.scale.z,C=M.x===M.y===M.z;B&&C||this.updateNormals(),this.scale.copy(M),this.updateAABB(),this.updateBoundingSphereRadius()},u.prototype.updateNormals=function(){for(var M=c,B=this.normals,C=0;C<this.indices.length/3;C++){var A=C*3,N=this.indices[A],V=this.indices[A+1],U=this.indices[A+2];this.getVertex(N,m),this.getVertex(V,_),this.getVertex(U,b),u.computeNormal(_,m,b,M),B[A]=M.x,B[A+1]=M.y,B[A+2]=M.z}},u.prototype.updateEdges=function(){for(var M={},B=function(ue,R){var P=N<V?N+"_"+V:V+"_"+N;M[P]=!0},C=0;C<this.indices.length/3;C++){var A=C*3,N=this.indices[A],V=this.indices[A+1];this.indices[A+2],B(),B(),B()}var U=Object.keys(M);this.edges=new Int16Array(U.length*2);for(var C=0;C<U.length;C++){var X=U[C].split("_");this.edges[2*C]=parseInt(X[0],10),this.edges[2*C+1]=parseInt(X[1],10)}},u.prototype.getEdgeVertex=function(M,B,C){var A=this.edges[M*2+(B?1:0)];this.getVertex(A,C)};var p=new s,f=new s;u.prototype.getEdgeVector=function(M,B){var C=p,A=f;this.getEdgeVertex(M,0,C),this.getEdgeVertex(M,1,A),A.vsub(C,B)};var g=new s,y=new s;u.computeNormal=function(M,B,C,A){B.vsub(M,y),C.vsub(B,g),g.cross(y,A),A.isZero()||A.normalize()};var m=new s,_=new s,b=new s;u.prototype.getVertex=function(M,B){var C=this.scale;return this._getUnscaledVertex(M,B),B.x*=C.x,B.y*=C.y,B.z*=C.z,B},u.prototype._getUnscaledVertex=function(M,B){var C=M*3,A=this.vertices;return B.set(A[C],A[C+1],A[C+2])},u.prototype.getWorldVertex=function(M,B,C,A){return this.getVertex(M,A),i.pointToWorldFrame(B,C,A,A),A},u.prototype.getTriangleVertices=function(M,B,C,A){var N=M*3;this.getVertex(this.indices[N],B),this.getVertex(this.indices[N+1],C),this.getVertex(this.indices[N+2],A)},u.prototype.getNormal=function(M,B){var C=M*3;return B.set(this.normals[C],this.normals[C+1],this.normals[C+2])};var v=new l;u.prototype.calculateLocalInertia=function(M,B){this.computeLocalAABB(v);var C=v.upperBound.x-v.lowerBound.x,A=v.upperBound.y-v.lowerBound.y,N=v.upperBound.z-v.lowerBound.z;return B.set(1/12*M*(2*A*2*A+2*N*2*N),1/12*M*(2*C*2*C+2*N*2*N),1/12*M*(2*A*2*A+2*C*2*C))};var w=new s;u.prototype.computeLocalAABB=function(M){var B=M.lowerBound,C=M.upperBound,A=this.vertices.length;this.vertices;var N=w;this.getVertex(0,N),B.copy(N),C.copy(N);for(var V=0;V!==A;V++)this.getVertex(V,N),N.x<B.x?B.x=N.x:N.x>C.x&&(C.x=N.x),N.y<B.y?B.y=N.y:N.y>C.y&&(C.y=N.y),N.z<B.z?B.z=N.z:N.z>C.z&&(C.z=N.z)},u.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},u.prototype.updateBoundingSphereRadius=function(){for(var M=0,B=this.vertices,C=new s,A=0,N=B.length/3;A!==N;A++){this.getVertex(A,C);var V=C.norm2();V>M&&(M=V)}this.boundingSphereRadius=Math.sqrt(M)},new s;var I=new i,F=new l;u.prototype.calculateWorldAABB=function(M,B,C,A){var N=I,V=F;N.position=M,N.quaternion=B,this.aabb.toWorldFrame(N,V),C.copy(V.lowerBound),A.copy(V.upperBound)},u.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},u.createTorus=function(M,B,C,A,N){M=M||1,B=B||.5,C=C||8,A=A||6,N=N||Math.PI*2;for(var V=[],U=[],X=0;X<=C;X++)for(var ue=0;ue<=A;ue++){var R=ue/A*N,P=X/C*Math.PI*2,Q=(M+B*Math.cos(P))*Math.cos(R),D=(M+B*Math.cos(P))*Math.sin(R),S=B*Math.sin(P);V.push(Q,D,S)}for(var X=1;X<=C;X++)for(var ue=1;ue<=A;ue++){var G=(A+1)*X+ue-1,E=(A+1)*(X-1)+ue-1,T=(A+1)*(X-1)+ue,x=(A+1)*X+ue;U.push(G,E,x),U.push(E,T,x)}return new u(V,U)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,n,r){n.exports=s,t("../math/Vec3"),t("../math/Quaternion");var o=t("./Solver");function s(){o.call(this),this.iterations=10,this.tolerance=1e-7}s.prototype=new o;var i=[],l=[],h=[];s.prototype.solve=function(u,c){var d=0,p=this.iterations,f=this.tolerance*this.tolerance,g=this.equations,y=g.length,m=c.bodies,_=m.length,b=u,v,w,I,F,M,B;if(y!==0)for(var C=0;C!==_;C++)m[C].updateSolveMassProperties();var A=l,N=h,V=i;A.length=y,N.length=y,V.length=y;for(var C=0;C!==y;C++){var U=g[C];V[C]=0,N[C]=U.computeB(b),A[C]=1/U.computeC()}if(y!==0){for(var C=0;C!==_;C++){var X=m[C],ue=X.vlambda,R=X.wlambda;ue.set(0,0,0),R&&R.set(0,0,0)}for(d=0;d!==p;d++){F=0;for(var P=0;P!==y;P++){var U=g[P];v=N[P],w=A[P],B=V[P],M=U.computeGWlambda(),I=w*(v-M-U.eps*B),B+I<U.minForce?I=U.minForce-B:B+I>U.maxForce&&(I=U.maxForce-B),V[P]+=I,F+=I>0?I:-I,U.addToWlambda(I)}if(F*F<f)break}for(var C=0;C!==_;C++){var X=m[C],Q=X.velocity,D=X.angularVelocity;Q.vadd(X.vlambda,Q),D&&D.vadd(X.wlambda,D)}}return d}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,n,r){n.exports=o;function o(){this.equations=[]}o.prototype.solve=function(s,i){return 0},o.prototype.addEquation=function(s){s.enabled&&this.equations.push(s)},o.prototype.removeEquation=function(s){var i=this.equations,l=i.indexOf(s);l!==-1&&i.splice(l,1)},o.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,n,r){n.exports=i,t("../math/Vec3"),t("../math/Quaternion");var o=t("./Solver"),s=t("../objects/Body");function i(m){for(o.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=m,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}i.prototype=new o;var l=[],h=[],u={bodies:[]},c=s.STATIC;function d(m){for(var _=m.length,b=0;b!==_;b++){var v=m[b];if(!v.visited&&!(v.body.type&c))return v}return!1}var p=[];function f(m,_,b,v){for(p.push(m),m.visited=!0,_(m,b,v);p.length;)for(var w=p.pop(),I;I=d(w.children);)I.visited=!0,_(I,b,v),p.push(I)}function g(m,_,b){_.push(m.body);for(var v=m.eqs.length,w=0;w!==v;w++){var I=m.eqs[w];b.indexOf(I)===-1&&b.push(I)}}i.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},i.prototype.solve=function(m,_){for(var b=l,v=this.nodePool,w=_.bodies,I=this.equations,F=I.length,M=w.length,B=this.subsolver;v.length<M;)v.push(this.createNode());b.length=M;for(var C=0;C<M;C++)b[C]=v[C];for(var C=0;C!==M;C++){var A=b[C];A.body=w[C],A.children.length=0,A.eqs.length=0,A.visited=!1}for(var N=0;N!==F;N++){var V=I[N],C=w.indexOf(V.bi),U=w.indexOf(V.bj),X=b[C],ue=b[U];X.children.push(ue),X.eqs.push(V),ue.children.push(X),ue.eqs.push(V)}var R,P=0,Q=h;B.tolerance=this.tolerance,B.iterations=this.iterations;for(var D=u;R=d(b);){Q.length=0,D.bodies.length=0,f(R,g,D.bodies,Q);var S=Q.length;Q=Q.sort(y);for(var C=0;C!==S;C++)B.addEquation(Q[C]);B.solve(m,D),B.removeAllEquations(),P++}return P};function y(m,_){return _.id-m.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,n,r){var o=function(){};n.exports=o,o.prototype={constructor:o,addEventListener:function(s,i){this._listeners===void 0&&(this._listeners={});var l=this._listeners;return l[s]===void 0&&(l[s]=[]),l[s].indexOf(i)===-1&&l[s].push(i),this},hasEventListener:function(s,i){if(this._listeners===void 0)return!1;var l=this._listeners;return l[s]!==void 0&&l[s].indexOf(i)!==-1},removeEventListener:function(s,i){if(this._listeners===void 0)return this;var l=this._listeners;if(l[s]===void 0)return this;var h=l[s].indexOf(i);return h!==-1&&l[s].splice(h,1),this},dispatchEvent:function(s){if(this._listeners===void 0)return this;var i=this._listeners,l=i[s.type];if(l!==void 0){s.target=this;for(var h=0,u=l.length;h<u;h++)l[h].call(this,s)}return this}}},{}],50:[function(t,n,r){var o=t("../collision/AABB"),s=t("../math/Vec3");n.exports=l;function i(c){c=c||{},this.root=c.root||null,this.aabb=c.aabb?c.aabb.clone():new o,this.data=[],this.children=[]}function l(c,d){d=d||{},d.root=null,d.aabb=c,i.call(this,d),this.maxDepth=typeof d.maxDepth<"u"?d.maxDepth:8}l.prototype=new i,i.prototype.reset=function(c,d){this.children.length=this.data.length=0},i.prototype.insert=function(c,d,p){var f=this.data;if(p=p||0,!this.aabb.contains(c))return!1;var g=this.children;if(p<(this.maxDepth||this.root.maxDepth)){var y=!1;g.length||(this.subdivide(),y=!0);for(var m=0;m!==8;m++)if(g[m].insert(c,d,p+1))return!0;y&&(g.length=0)}return f.push(d),!0};var h=new s;i.prototype.subdivide=function(){var c=this.aabb,d=c.lowerBound,p=c.upperBound,f=this.children;f.push(new i({aabb:new o({lowerBound:new s(0,0,0)})}),new i({aabb:new o({lowerBound:new s(1,0,0)})}),new i({aabb:new o({lowerBound:new s(1,1,0)})}),new i({aabb:new o({lowerBound:new s(1,1,1)})}),new i({aabb:new o({lowerBound:new s(0,1,1)})}),new i({aabb:new o({lowerBound:new s(0,0,1)})}),new i({aabb:new o({lowerBound:new s(1,0,1)})}),new i({aabb:new o({lowerBound:new s(0,1,0)})})),p.vsub(d,h),h.scale(.5,h);for(var g=this.root||this,y=0;y!==8;y++){var m=f[y];m.root=g;var _=m.aabb.lowerBound;_.x*=h.x,_.y*=h.y,_.z*=h.z,_.vadd(d,_),_.vadd(h,m.aabb.upperBound)}},i.prototype.aabbQuery=function(c,d){this.data,this.children;for(var p=[this];p.length;){var f=p.pop();f.aabb.overlaps(c)&&Array.prototype.push.apply(d,f.data),Array.prototype.push.apply(p,f.children)}return d};var u=new o;i.prototype.rayQuery=function(c,d,p){return c.getAABB(u),u.toLocalFrame(d,u),this.aabbQuery(u,p),p},i.prototype.removeEmptyNodes=function(){for(var c=[this];c.length;){for(var d=c.pop(),p=d.children.length-1;p>=0;p--)d.children[p].data.length||d.children.splice(p,1);Array.prototype.push.apply(c,d.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,n,r){n.exports=o;function o(){this.objects=[],this.type=Object}o.prototype.release=function(){for(var s=arguments.length,i=0;i!==s;i++)this.objects.push(arguments[i])},o.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},o.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,n,r){n.exports=o;function o(){this.data={keys:[]}}o.prototype.get=function(s,i){if(s>i){var l=i;i=s,s=l}return this.data[s+"-"+i]},o.prototype.set=function(s,i,l){if(s>i){var h=i;i=s,s=h}var u=s+"-"+i;this.get(s,i)||this.data.keys.push(u),this.data[u]=l},o.prototype.reset=function(){for(var s=this.data,i=s.keys;i.length>0;){var l=i.pop();delete s[l]}}},{}],53:[function(t,n,r){function o(){}n.exports=o,o.defaults=function(s,i){s=s||{};for(var l in i)l in s||(s[l]=i[l]);return s}},{}],54:[function(t,n,r){n.exports=i;var o=t("../math/Vec3"),s=t("./Pool");function i(){s.call(this),this.type=o}i.prototype=new s,i.prototype.constructObject=function(){return new o}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,n,r){n.exports=f;var o=t("../collision/AABB"),s=t("../shapes/Shape"),i=t("../collision/Ray"),l=t("../math/Vec3"),h=t("../math/Transform");t("../shapes/ConvexPolyhedron");var u=t("../math/Quaternion");t("../solver/Solver");var c=t("../utils/Vec3Pool"),d=t("../equations/ContactEquation"),p=t("../equations/FrictionEquation");function f($){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=$,this.currentContactMaterial=null,this.enableFrictionReduction=!1}f.prototype.createContactEquation=function($,H,Z,ee,Se,fe){var re;this.contactPointPool.length?(re=this.contactPointPool.pop(),re.bi=$,re.bj=H):re=new d($,H),re.enabled=$.collisionResponse&&H.collisionResponse&&Z.collisionResponse&&ee.collisionResponse;var he=this.currentContactMaterial;re.restitution=he.restitution,re.setSpookParams(he.contactEquationStiffness,he.contactEquationRelaxation,this.world.dt);var k=Z.material||$.material,ae=ee.material||H.material;return k&&ae&&k.restitution>=0&&ae.restitution>=0&&(re.restitution=k.restitution*ae.restitution),re.si=Se||Z,re.sj=fe||ee,re},f.prototype.createFrictionEquationsFromContact=function($,H){var Z=$.bi,ee=$.bj,Se=$.si,fe=$.sj,re=this.world,he=this.currentContactMaterial,k=he.friction,ae=Se.material||Z.material,de=fe.material||ee.material;if(ae&&de&&ae.friction>=0&&de.friction>=0&&(k=ae.friction*de.friction),k>0){var _e=k*re.gravity.length(),le=Z.invMass+ee.invMass;le>0&&(le=1/le);var oe=this.frictionEquationPool,ce=oe.length?oe.pop():new p(Z,ee,_e*le),Te=oe.length?oe.pop():new p(Z,ee,_e*le);return ce.bi=Te.bi=Z,ce.bj=Te.bj=ee,ce.minForce=Te.minForce=-_e*le,ce.maxForce=Te.maxForce=_e*le,ce.ri.copy($.ri),ce.rj.copy($.rj),Te.ri.copy($.ri),Te.rj.copy($.rj),$.ni.tangents(ce.t,Te.t),ce.setSpookParams(he.frictionEquationStiffness,he.frictionEquationRelaxation,re.dt),Te.setSpookParams(he.frictionEquationStiffness,he.frictionEquationRelaxation,re.dt),ce.enabled=Te.enabled=$.enabled,H.push(ce,Te),!0}return!1};var g=new l,y=new l,m=new l;f.prototype.createFrictionFromAverage=function($){var H=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(H,this.frictionResult)||$===1)){var Z=this.frictionResult[this.frictionResult.length-2],ee=this.frictionResult[this.frictionResult.length-1];g.setZero(),y.setZero(),m.setZero();var Se=H.bi;H.bj;for(var fe=0;fe!==$;fe++)H=this.result[this.result.length-1-fe],H.bodyA!==Se?(g.vadd(H.ni,g),y.vadd(H.ri,y),m.vadd(H.rj,m)):(g.vsub(H.ni,g),y.vadd(H.rj,y),m.vadd(H.ri,m));var re=1/$;y.scale(re,Z.ri),m.scale(re,Z.rj),ee.ri.copy(Z.ri),ee.rj.copy(Z.rj),g.normalize(),g.tangents(Z.t,ee.t)}};var _=new l,b=new l,v=new u,w=new u;f.prototype.getContacts=function($,H,Z,ee,Se,fe,re){this.contactPointPool=Se,this.frictionEquationPool=re,this.result=ee,this.frictionResult=fe;for(var he=v,k=w,ae=_,de=b,_e=0,le=$.length;_e!==le;_e++){var oe=$[_e],ce=H[_e],Te=null;oe.material&&ce.material&&(Te=Z.getContactMaterial(oe.material,ce.material)||null);for(var Pe=0;Pe<oe.shapes.length;Pe++){oe.quaternion.mult(oe.shapeOrientations[Pe],he),oe.quaternion.vmult(oe.shapeOffsets[Pe],ae),ae.vadd(oe.position,ae);for(var ne=oe.shapes[Pe],Re=0;Re<ce.shapes.length;Re++){ce.quaternion.mult(ce.shapeOrientations[Re],k),ce.quaternion.vmult(ce.shapeOffsets[Re],de),de.vadd(ce.position,de);var Le=ce.shapes[Re];if(!(ae.distanceTo(de)>ne.boundingSphereRadius+Le.boundingSphereRadius)){var lt=null;ne.material&&Le.material&&(lt=Z.getContactMaterial(ne.material,Le.material)||null),this.currentContactMaterial=lt||Te||Z.defaultContactMaterial;var Ge=this[ne.type|Le.type];Ge&&(ne.type<Le.type?Ge.call(this,ne,Le,ae,de,he,k,oe,ce,ne,Le):Ge.call(this,Le,ne,de,ae,k,he,ce,oe,ne,Le))}}}}},f.prototype[s.types.BOX|s.types.BOX]=f.prototype.boxBox=function($,H,Z,ee,Se,fe,re,he){$.convexPolyhedronRepresentation.material=$.material,H.convexPolyhedronRepresentation.material=H.material,$.convexPolyhedronRepresentation.collisionResponse=$.collisionResponse,H.convexPolyhedronRepresentation.collisionResponse=H.collisionResponse,this.convexConvex($.convexPolyhedronRepresentation,H.convexPolyhedronRepresentation,Z,ee,Se,fe,re,he,$,H)},f.prototype[s.types.BOX|s.types.CONVEXPOLYHEDRON]=f.prototype.boxConvex=function($,H,Z,ee,Se,fe,re,he){$.convexPolyhedronRepresentation.material=$.material,$.convexPolyhedronRepresentation.collisionResponse=$.collisionResponse,this.convexConvex($.convexPolyhedronRepresentation,H,Z,ee,Se,fe,re,he,$,H)},f.prototype[s.types.BOX|s.types.PARTICLE]=f.prototype.boxParticle=function($,H,Z,ee,Se,fe,re,he){$.convexPolyhedronRepresentation.material=$.material,$.convexPolyhedronRepresentation.collisionResponse=$.collisionResponse,this.convexParticle($.convexPolyhedronRepresentation,H,Z,ee,Se,fe,re,he,$,H)},f.prototype[s.types.SPHERE]=f.prototype.sphereSphere=function($,H,Z,ee,Se,fe,re,he){var k=this.createContactEquation(re,he,$,H);ee.vsub(Z,k.ni),k.ni.normalize(),k.ri.copy(k.ni),k.rj.copy(k.ni),k.ri.mult($.radius,k.ri),k.rj.mult(-H.radius,k.rj),k.ri.vadd(Z,k.ri),k.ri.vsub(re.position,k.ri),k.rj.vadd(ee,k.rj),k.rj.vsub(he.position,k.rj),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)};var I=new l,F=new l,M=new l;f.prototype[s.types.PLANE|s.types.TRIMESH]=f.prototype.planeTrimesh=function($,H,Z,ee,Se,fe,re,he){var k=new l,ae=I;ae.set(0,0,1),Se.vmult(ae,ae);for(var de=0;de<H.vertices.length/3;de++){H.getVertex(de,k);var _e=new l;_e.copy(k),h.pointToWorldFrame(ee,fe,_e,k);var le=F;k.vsub(Z,le);var oe=ae.dot(le);if(oe<=0){var ce=this.createContactEquation(re,he,$,H);ce.ni.copy(ae);var Te=M;ae.scale(le.dot(ae),Te),k.vsub(Te,Te),ce.ri.copy(Te),ce.ri.vsub(re.position,ce.ri),ce.rj.copy(k),ce.rj.vsub(he.position,ce.rj),this.result.push(ce),this.createFrictionEquationsFromContact(ce,this.frictionResult)}}};var B=new l,C=new l;new l;var A=new l,N=new l,V=new l,U=new l,X=new l,ue=new l,R=new l,P=new l,Q=new l,D=new l,S=new l,G=new o,E=[];f.prototype[s.types.SPHERE|s.types.TRIMESH]=f.prototype.sphereTrimesh=function($,H,Z,ee,Se,fe,re,he){var k=V,ae=U,de=X,_e=ue,le=R,oe=P,ce=G,Te=N,Pe=C,ne=E;h.pointToLocalFrame(ee,fe,Z,le);var Re=$.radius;ce.lowerBound.set(le.x-Re,le.y-Re,le.z-Re),ce.upperBound.set(le.x+Re,le.y+Re,le.z+Re),H.getTrianglesInAABB(ce,ne);for(var Le=A,lt=$.radius*$.radius,Ge=0;Ge<ne.length;Ge++)for(var Ue=0;Ue<3;Ue++)if(H.getVertex(H.indices[ne[Ge]*3+Ue],Le),Le.vsub(le,Pe),Pe.norm2()<=lt){Te.copy(Le),h.pointToWorldFrame(ee,fe,Te,Le),Le.vsub(Z,Pe);var Ce=this.createContactEquation(re,he,$,H);Ce.ni.copy(Pe),Ce.ni.normalize(),Ce.ri.copy(Ce.ni),Ce.ri.scale($.radius,Ce.ri),Ce.ri.vadd(Z,Ce.ri),Ce.ri.vsub(re.position,Ce.ri),Ce.rj.copy(Le),Ce.rj.vsub(he.position,Ce.rj),this.result.push(Ce),this.createFrictionEquationsFromContact(Ce,this.frictionResult)}for(var Ge=0;Ge<ne.length;Ge++)for(var Ue=0;Ue<3;Ue++){H.getVertex(H.indices[ne[Ge]*3+Ue],k),H.getVertex(H.indices[ne[Ge]*3+(Ue+1)%3],ae),ae.vsub(k,de),le.vsub(ae,oe);var kt=oe.dot(de);le.vsub(k,oe);var Vt=oe.dot(de);if(Vt>0&&kt<0){le.vsub(k,oe),_e.copy(de),_e.normalize(),Vt=oe.dot(_e),_e.scale(Vt,oe),oe.vadd(k,oe);var Ct=oe.distanceTo(le);if(Ct<$.radius){var Ce=this.createContactEquation(re,he,$,H);oe.vsub(le,Ce.ni),Ce.ni.normalize(),Ce.ni.scale($.radius,Ce.ri),h.pointToWorldFrame(ee,fe,oe,oe),oe.vsub(he.position,Ce.rj),h.vectorToWorldFrame(fe,Ce.ni,Ce.ni),h.vectorToWorldFrame(fe,Ce.ri,Ce.ri),this.result.push(Ce),this.createFrictionEquationsFromContact(Ce,this.frictionResult)}}}for(var Zt=Q,Et=D,Je=S,en=B,Ge=0,nt=ne.length;Ge!==nt;Ge++){H.getTriangleVertices(ne[Ge],Zt,Et,Je),H.getNormal(ne[Ge],en),le.vsub(Zt,oe);var Ct=oe.dot(en);if(en.scale(Ct,oe),le.vsub(oe,oe),Ct=oe.distanceTo(le),i.pointInTriangle(oe,Zt,Et,Je)&&Ct<$.radius){var Ce=this.createContactEquation(re,he,$,H);oe.vsub(le,Ce.ni),Ce.ni.normalize(),Ce.ni.scale($.radius,Ce.ri),h.pointToWorldFrame(ee,fe,oe,oe),oe.vsub(he.position,Ce.rj),h.vectorToWorldFrame(fe,Ce.ni,Ce.ni),h.vectorToWorldFrame(fe,Ce.ri,Ce.ri),this.result.push(Ce),this.createFrictionEquationsFromContact(Ce,this.frictionResult)}}ne.length=0};var T=new l,x=new l;f.prototype[s.types.SPHERE|s.types.PLANE]=f.prototype.spherePlane=function($,H,Z,ee,Se,fe,re,he){var k=this.createContactEquation(re,he,$,H);if(k.ni.set(0,0,1),fe.vmult(k.ni,k.ni),k.ni.negate(k.ni),k.ni.normalize(),k.ni.mult($.radius,k.ri),Z.vsub(ee,T),k.ni.mult(k.ni.dot(T),x),T.vsub(x,k.rj),-T.dot(k.ni)<=$.radius){var ae=k.ri,de=k.rj;ae.vadd(Z,ae),ae.vsub(re.position,ae),de.vadd(ee,de),de.vsub(he.position,de),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}};var L=new l,J=new l,z=new l;function O($,H,Z){for(var ee=null,Se=$.length,fe=0;fe!==Se;fe++){var re=$[fe],he=L;$[(fe+1)%Se].vsub(re,he);var k=J;he.cross(H,k);var ae=z;Z.vsub(re,ae);var de=k.dot(ae);if(ee===null||de>0&&ee===!0||de<=0&&ee===!1){ee===null&&(ee=de>0);continue}else return!1}return!0}var W=new l,te=new l,Ae=new l,ve=new l,me=[new l,new l,new l,new l,new l,new l],j=new l,se=new l,$e=new l,Ee=new l;f.prototype[s.types.SPHERE|s.types.BOX]=f.prototype.sphereBox=function($,H,Z,ee,Se,fe,re,he){var k=this.v3pool,ae=me;Z.vsub(ee,W),H.getSideNormals(ae,fe);for(var de=$.radius,_e=!1,le=se,oe=$e,ce=Ee,Te=null,Pe=0,ne=0,Re=0,Le=null,lt=0,Ge=ae.length;lt!==Ge&&_e===!1;lt++){var Ue=te;Ue.copy(ae[lt]);var Ce=Ue.norm();Ue.normalize();var kt=W.dot(Ue);if(kt<Ce+de&&kt>0){var Vt=Ae,Ct=ve;Vt.copy(ae[(lt+1)%3]),Ct.copy(ae[(lt+2)%3]);var Zt=Vt.norm(),Et=Ct.norm();Vt.normalize(),Ct.normalize();var Je=W.dot(Vt),en=W.dot(Ct);if(Je<Zt&&Je>-Zt&&en<Et&&en>-Et){var yt=Math.abs(kt-Ce-de);(Le===null||yt<Le)&&(Le=yt,ne=Je,Re=en,Te=Ce,le.copy(Ue),oe.copy(Vt),ce.copy(Ct),Pe++)}}}if(Pe){_e=!0;var Ie=this.createContactEquation(re,he,$,H);le.mult(-de,Ie.ri),Ie.ni.copy(le),Ie.ni.negate(Ie.ni),le.mult(Te,le),oe.mult(ne,oe),le.vadd(oe,le),ce.mult(Re,ce),le.vadd(ce,Ie.rj),Ie.ri.vadd(Z,Ie.ri),Ie.ri.vsub(re.position,Ie.ri),Ie.rj.vadd(ee,Ie.rj),Ie.rj.vsub(he.position,Ie.rj),this.result.push(Ie),this.createFrictionEquationsFromContact(Ie,this.frictionResult)}for(var nt=k.get(),tn=j,Mt=0;Mt!==2&&!_e;Mt++)for(var _t=0;_t!==2&&!_e;_t++)for(var gt=0;gt!==2&&!_e;gt++)if(nt.set(0,0,0),Mt?nt.vadd(ae[0],nt):nt.vsub(ae[0],nt),_t?nt.vadd(ae[1],nt):nt.vsub(ae[1],nt),gt?nt.vadd(ae[2],nt):nt.vsub(ae[2],nt),ee.vadd(nt,tn),tn.vsub(Z,tn),tn.norm2()<de*de){_e=!0;var Ie=this.createContactEquation(re,he,$,H);Ie.ri.copy(tn),Ie.ri.normalize(),Ie.ni.copy(Ie.ri),Ie.ri.mult(de,Ie.ri),Ie.rj.copy(nt),Ie.ri.vadd(Z,Ie.ri),Ie.ri.vsub(re.position,Ie.ri),Ie.rj.vadd(ee,Ie.rj),Ie.rj.vsub(he.position,Ie.rj),this.result.push(Ie),this.createFrictionEquationsFromContact(Ie,this.frictionResult)}k.release(nt),nt=null;for(var Gt=k.get(),nn=k.get(),Ie=k.get(),Pt=k.get(),yt=k.get(),_n=ae.length,Mt=0;Mt!==_n&&!_e;Mt++)for(var _t=0;_t!==_n&&!_e;_t++)if(Mt%3!==_t%3){ae[_t].cross(ae[Mt],Gt),Gt.normalize(),ae[Mt].vadd(ae[_t],nn),Ie.copy(Z),Ie.vsub(nn,Ie),Ie.vsub(ee,Ie);var bn=Ie.dot(Gt);Gt.mult(bn,Pt);for(var gt=0;gt===Mt%3||gt===_t%3;)gt++;yt.copy(Z),yt.vsub(Pt,yt),yt.vsub(nn,yt),yt.vsub(ee,yt);var Cr=Math.abs(bn),Er=yt.norm();if(Cr<ae[gt].norm()&&Er<de){_e=!0;var st=this.createContactEquation(re,he,$,H);nn.vadd(Pt,st.rj),st.rj.copy(st.rj),yt.negate(st.ni),st.ni.normalize(),st.ri.copy(st.rj),st.ri.vadd(ee,st.ri),st.ri.vsub(Z,st.ri),st.ri.normalize(),st.ri.mult(de,st.ri),st.ri.vadd(Z,st.ri),st.ri.vsub(re.position,st.ri),st.rj.vadd(ee,st.rj),st.rj.vsub(he.position,st.rj),this.result.push(st),this.createFrictionEquationsFromContact(st,this.frictionResult)}}k.release(Gt,nn,Ie,Pt,yt)};var Qe=new l,we=new l,Ke=new l,Xe=new l,je=new l,Ze=new l,He=new l,tt=new l,ze=new l,ut=new l;f.prototype[s.types.SPHERE|s.types.CONVEXPOLYHEDRON]=f.prototype.sphereConvex=function($,H,Z,ee,Se,fe,re,he){var k=this.v3pool;Z.vsub(ee,Qe);for(var ae=H.faceNormals,de=H.faces,_e=H.vertices,le=$.radius,oe=0;oe!==_e.length;oe++){var ce=_e[oe],Te=je;fe.vmult(ce,Te),ee.vadd(Te,Te);var Pe=Xe;if(Te.vsub(Z,Pe),Pe.norm2()<le*le){Re=!0;var ne=this.createContactEquation(re,he,$,H);ne.ri.copy(Pe),ne.ri.normalize(),ne.ni.copy(ne.ri),ne.ri.mult(le,ne.ri),Te.vsub(ee,ne.rj),ne.ri.vadd(Z,ne.ri),ne.ri.vsub(re.position,ne.ri),ne.rj.vadd(ee,ne.rj),ne.rj.vsub(he.position,ne.rj),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult);return}}for(var Re=!1,oe=0,Le=de.length;oe!==Le&&Re===!1;oe++){var lt=ae[oe],Ge=de[oe],Ue=Ze;fe.vmult(lt,Ue);var Ce=He;fe.vmult(_e[Ge[0]],Ce),Ce.vadd(ee,Ce);var kt=tt;Ue.mult(-le,kt),Z.vadd(kt,kt);var Vt=ze;kt.vsub(Ce,Vt);var Ct=Vt.dot(Ue),Zt=ut;if(Z.vsub(Ce,Zt),Ct<0&&Zt.dot(Ue)>0){for(var Et=[],Je=0,en=Ge.length;Je!==en;Je++){var nt=k.get();fe.vmult(_e[Ge[Je]],nt),ee.vadd(nt,nt),Et.push(nt)}if(O(Et,Ue,Z)){Re=!0;var ne=this.createContactEquation(re,he,$,H);Ue.mult(-le,ne.ri),Ue.negate(ne.ni);var tn=k.get();Ue.mult(-Ct,tn);var Mt=k.get();Ue.mult(-le,Mt),Z.vsub(ee,ne.rj),ne.rj.vadd(Mt,ne.rj),ne.rj.vadd(tn,ne.rj),ne.rj.vadd(ee,ne.rj),ne.rj.vsub(he.position,ne.rj),ne.ri.vadd(Z,ne.ri),ne.ri.vsub(re.position,ne.ri),k.release(tn),k.release(Mt),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult);for(var Je=0,_t=Et.length;Je!==_t;Je++)k.release(Et[Je]);return}else for(var Je=0;Je!==Ge.length;Je++){var gt=k.get(),Gt=k.get();fe.vmult(_e[Ge[(Je+1)%Ge.length]],gt),fe.vmult(_e[Ge[(Je+2)%Ge.length]],Gt),ee.vadd(gt,gt),ee.vadd(Gt,Gt);var nn=we;Gt.vsub(gt,nn);var Ie=Ke;nn.unit(Ie);var Pt=k.get(),yt=k.get();Z.vsub(gt,yt);var _n=yt.dot(Ie);Ie.mult(_n,Pt),Pt.vadd(gt,Pt);var bn=k.get();if(Pt.vsub(Z,bn),_n>0&&_n*_n<nn.norm2()&&bn.norm2()<le*le){var ne=this.createContactEquation(re,he,$,H);Pt.vsub(ee,ne.rj),Pt.vsub(Z,ne.ni),ne.ni.normalize(),ne.ni.mult(le,ne.ri),ne.rj.vadd(ee,ne.rj),ne.rj.vsub(he.position,ne.rj),ne.ri.vadd(Z,ne.ri),ne.ri.vsub(re.position,ne.ri),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult);for(var Je=0,_t=Et.length;Je!==_t;Je++)k.release(Et[Je]);k.release(gt),k.release(Gt),k.release(Pt),k.release(bn),k.release(yt);return}k.release(gt),k.release(Gt),k.release(Pt),k.release(bn),k.release(yt)}for(var Je=0,_t=Et.length;Je!==_t;Je++)k.release(Et[Je])}}},new l,new l,f.prototype[s.types.PLANE|s.types.BOX]=f.prototype.planeBox=function($,H,Z,ee,Se,fe,re,he){H.convexPolyhedronRepresentation.material=H.material,H.convexPolyhedronRepresentation.collisionResponse=H.collisionResponse,this.planeConvex($,H.convexPolyhedronRepresentation,Z,ee,Se,fe,re,he)};var Tt=new l,Qt=new l,an=new l,Jt=new l;f.prototype[s.types.PLANE|s.types.CONVEXPOLYHEDRON]=f.prototype.planeConvex=function($,H,Z,ee,Se,fe,re,he){var k=Tt,ae=Qt;ae.set(0,0,1),Se.vmult(ae,ae);for(var de=0,_e=an,le=0;le!==H.vertices.length;le++){k.copy(H.vertices[le]),fe.vmult(k,k),ee.vadd(k,k),k.vsub(Z,_e);var oe=ae.dot(_e);if(oe<=0){var ce=this.createContactEquation(re,he,$,H),Te=Jt;ae.mult(ae.dot(_e),Te),k.vsub(Te,Te),Te.vsub(Z,ce.ri),ce.ni.copy(ae),k.vsub(ee,ce.rj),ce.ri.vadd(Z,ce.ri),ce.ri.vsub(re.position,ce.ri),ce.rj.vadd(ee,ce.rj),ce.rj.vsub(he.position,ce.rj),this.result.push(ce),de++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(ce,this.frictionResult)}}this.enableFrictionReduction&&de&&this.createFrictionFromAverage(de)};var Ft=new l,Lt=new l;f.prototype[s.types.CONVEXPOLYHEDRON]=f.prototype.convexConvex=function($,H,Z,ee,Se,fe,re,he,k,ae,de,_e){var le=Ft;if(!(Z.distanceTo(ee)>$.boundingSphereRadius+H.boundingSphereRadius)&&$.findSeparatingAxis(H,Z,Se,ee,fe,le,de,_e)){var oe=[],ce=Lt;$.clipAgainstHull(Z,Se,H,ee,fe,le,-100,100,oe);for(var Te=0,Pe=0;Pe!==oe.length;Pe++){var ne=this.createContactEquation(re,he,$,H,k,ae),Re=ne.ri,Le=ne.rj;le.negate(ne.ni),oe[Pe].normal.negate(ce),ce.mult(oe[Pe].depth,ce),oe[Pe].point.vadd(ce,Re),Le.copy(oe[Pe].point),Re.vsub(Z,Re),Le.vsub(ee,Le),Re.vadd(Z,Re),Re.vsub(re.position,Re),Le.vadd(ee,Le),Le.vsub(he.position,Le),this.result.push(ne),Te++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(ne,this.frictionResult)}this.enableFrictionReduction&&Te&&this.createFrictionFromAverage(Te)}};var mn=new l,ln=new l,Kt=new l;f.prototype[s.types.PLANE|s.types.PARTICLE]=f.prototype.planeParticle=function($,H,Z,ee,Se,fe,re,he){var k=mn;k.set(0,0,1),re.quaternion.vmult(k,k);var ae=ln;ee.vsub(re.position,ae);var de=k.dot(ae);if(de<=0){var _e=this.createContactEquation(he,re,H,$);_e.ni.copy(k),_e.ni.negate(_e.ni),_e.ri.set(0,0,0);var le=Kt;k.mult(k.dot(ee),le),ee.vsub(le,le),_e.rj.copy(le),this.result.push(_e),this.createFrictionEquationsFromContact(_e,this.frictionResult)}};var Dt=new l;f.prototype[s.types.PARTICLE|s.types.SPHERE]=f.prototype.sphereParticle=function($,H,Z,ee,Se,fe,re,he){var k=Dt;k.set(0,0,1),ee.vsub(Z,k);var ae=k.norm2();if(ae<=$.radius*$.radius){var de=this.createContactEquation(he,re,H,$);k.normalize(),de.rj.copy(k),de.rj.mult($.radius,de.rj),de.ni.copy(k),de.ni.negate(de.ni),de.ri.set(0,0,0),this.result.push(de),this.createFrictionEquationsFromContact(de,this.frictionResult)}};var It=new u,jt=new l;new l;var $t=new l,xt=new l,yn=new l;f.prototype[s.types.PARTICLE|s.types.CONVEXPOLYHEDRON]=f.prototype.convexParticle=function($,H,Z,ee,Se,fe,re,he){var k=-1,ae=$t,de=yn,_e=null,le=jt;if(le.copy(ee),le.vsub(Z,le),Se.conjugate(It),It.vmult(le,le),$.pointIsInside(le)){$.worldVerticesNeedsUpdate&&$.computeWorldVertices(Z,Se),$.worldFaceNormalsNeedsUpdate&&$.computeWorldFaceNormals(Se);for(var oe=0,ce=$.faces.length;oe!==ce;oe++){var Te=[$.worldVertices[$.faces[oe][0]]],Pe=$.worldFaceNormals[oe];ee.vsub(Te[0],xt);var ne=-Pe.dot(xt);(_e===null||Math.abs(ne)<Math.abs(_e))&&(_e=ne,k=oe,ae.copy(Pe))}if(k!==-1){var Re=this.createContactEquation(he,re,H,$);ae.mult(_e,de),de.vadd(ee,de),de.vsub(Z,de),Re.rj.copy(de),ae.negate(Re.ni),Re.ri.set(0,0,0);var Le=Re.ri,lt=Re.rj;Le.vadd(ee,Le),Le.vsub(he.position,Le),lt.vadd(Z,lt),lt.vsub(re.position,lt),this.result.push(Re),this.createFrictionEquationsFromContact(Re,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},f.prototype[s.types.BOX|s.types.HEIGHTFIELD]=f.prototype.boxHeightfield=function($,H,Z,ee,Se,fe,re,he){$.convexPolyhedronRepresentation.material=$.material,$.convexPolyhedronRepresentation.collisionResponse=$.collisionResponse,this.convexHeightfield($.convexPolyhedronRepresentation,H,Z,ee,Se,fe,re,he)};var gn=new l,vn=new l,En=[0];f.prototype[s.types.CONVEXPOLYHEDRON|s.types.HEIGHTFIELD]=f.prototype.convexHeightfield=function($,H,Z,ee,Se,fe,re,he){var k=H.data,ae=H.elementSize,de=$.boundingSphereRadius,_e=vn,le=En,oe=gn;h.pointToLocalFrame(ee,fe,Z,oe);var ce=Math.floor((oe.x-de)/ae)-1,Te=Math.ceil((oe.x+de)/ae)+1,Pe=Math.floor((oe.y-de)/ae)-1,ne=Math.ceil((oe.y+de)/ae)+1;if(!(Te<0||ne<0||ce>k.length||Pe>k[0].length)){ce<0&&(ce=0),Te<0&&(Te=0),Pe<0&&(Pe=0),ne<0&&(ne=0),ce>=k.length&&(ce=k.length-1),Te>=k.length&&(Te=k.length-1),ne>=k[0].length&&(ne=k[0].length-1),Pe>=k[0].length&&(Pe=k[0].length-1);var Re=[];H.getRectMinMax(ce,Pe,Te,ne,Re);var Le=Re[0],lt=Re[1];if(!(oe.z-de>lt||oe.z+de<Le))for(var Ge=ce;Ge<Te;Ge++)for(var Ue=Pe;Ue<ne;Ue++)H.getConvexTrianglePillar(Ge,Ue,!1),h.pointToWorldFrame(ee,fe,H.pillarOffset,_e),Z.distanceTo(_e)<H.pillarConvex.boundingSphereRadius+$.boundingSphereRadius&&this.convexConvex($,H.pillarConvex,Z,_e,Se,fe,re,he,null,null,le,null),H.getConvexTrianglePillar(Ge,Ue,!0),h.pointToWorldFrame(ee,fe,H.pillarOffset,_e),Z.distanceTo(_e)<H.pillarConvex.boundingSphereRadius+$.boundingSphereRadius&&this.convexConvex($,H.pillarConvex,Z,_e,Se,fe,re,he,null,null,le,null)}};var Mn=new l,mt=new l;f.prototype[s.types.SPHERE|s.types.HEIGHTFIELD]=f.prototype.sphereHeightfield=function($,H,Z,ee,Se,fe,re,he){var k=H.data,ae=$.radius,de=H.elementSize,_e=mt,le=Mn;h.pointToLocalFrame(ee,fe,Z,le);var oe=Math.floor((le.x-ae)/de)-1,ce=Math.ceil((le.x+ae)/de)+1,Te=Math.floor((le.y-ae)/de)-1,Pe=Math.ceil((le.y+ae)/de)+1;if(!(ce<0||Pe<0||oe>k.length||Pe>k[0].length)){oe<0&&(oe=0),ce<0&&(ce=0),Te<0&&(Te=0),Pe<0&&(Pe=0),oe>=k.length&&(oe=k.length-1),ce>=k.length&&(ce=k.length-1),Pe>=k[0].length&&(Pe=k[0].length-1),Te>=k[0].length&&(Te=k[0].length-1);var ne=[];H.getRectMinMax(oe,Te,ce,Pe,ne);var Re=ne[0],Le=ne[1];if(!(le.z-ae>Le||le.z+ae<Re))for(var lt=this.result,Ge=oe;Ge<ce;Ge++)for(var Ue=Te;Ue<Pe;Ue++){var Ce=lt.length;H.getConvexTrianglePillar(Ge,Ue,!1),h.pointToWorldFrame(ee,fe,H.pillarOffset,_e),Z.distanceTo(_e)<H.pillarConvex.boundingSphereRadius+$.boundingSphereRadius&&this.sphereConvex($,H.pillarConvex,Z,_e,Se,fe,re,he),H.getConvexTrianglePillar(Ge,Ue,!0),h.pointToWorldFrame(ee,fe,H.pillarOffset,_e),Z.distanceTo(_e)<H.pillarConvex.boundingSphereRadius+$.boundingSphereRadius&&this.sphereConvex($,H.pillarConvex,Z,_e,Se,fe,re,he);var kt=lt.length-Ce;if(kt>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,n,r){n.exports=v;var o=t("../shapes/Shape"),s=t("../math/Vec3"),i=t("../math/Quaternion"),l=t("../solver/GSSolver");t("../utils/Vec3Pool"),t("../equations/ContactEquation"),t("../equations/FrictionEquation");var h=t("./Narrowphase"),u=t("../utils/EventTarget"),c=t("../collision/ArrayCollisionMatrix"),d=t("../material/Material"),p=t("../material/ContactMaterial"),f=t("../objects/Body"),g=t("../utils/TupleDictionary"),y=t("../collision/RaycastResult"),m=t("../collision/AABB"),_=t("../collision/Ray"),b=t("../collision/NaiveBroadphase");function v(){u.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new s,this.broadphase=new b,this.bodies=[],this.solver=new l,this.constraints=[],this.narrowphase=new h(this),this.collisionMatrix=new c,this.collisionMatrixPrevious=new c,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new g,this.defaultMaterial=new d("default"),this.defaultContactMaterial=new p(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}v.prototype=new u,new m;var w=new _;if(v.prototype.getContactMaterial=function(P,Q){return this.contactMaterialTable.get(P.id,Q.id)},v.prototype.numObjects=function(){return this.bodies.length},v.prototype.collisionMatrixTick=function(){var P=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=P,this.collisionMatrix.reset()},v.prototype.add=v.prototype.addBody=function(P){this.bodies.indexOf(P)===-1&&(P.index=this.bodies.length,this.bodies.push(P),P.world=this,P.initPosition.copy(P.position),P.initVelocity.copy(P.velocity),P.timeLastSleepy=this.time,P instanceof f&&(P.initAngularVelocity.copy(P.angularVelocity),P.initQuaternion.copy(P.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=P,this.dispatchEvent(this.addBodyEvent))},v.prototype.addConstraint=function(P){this.constraints.push(P)},v.prototype.removeConstraint=function(P){var Q=this.constraints.indexOf(P);Q!==-1&&this.constraints.splice(Q,1)},v.prototype.rayTest=function(P,Q,D){D instanceof y?this.raycastClosest(P,Q,{skipBackfaces:!0},D):this.raycastAll(P,Q,{skipBackfaces:!0},D)},v.prototype.raycastAll=function(P,Q,D,S){return D.mode=_.ALL,D.from=P,D.to=Q,D.callback=S,w.intersectWorld(this,D)},v.prototype.raycastAny=function(P,Q,D,S){return D.mode=_.ANY,D.from=P,D.to=Q,D.result=S,w.intersectWorld(this,D)},v.prototype.raycastClosest=function(P,Q,D,S){return D.mode=_.CLOSEST,D.from=P,D.to=Q,D.result=S,w.intersectWorld(this,D)},v.prototype.remove=function(P){P.world=null;var Q=this.bodies.length-1,D=this.bodies,S=D.indexOf(P);if(S!==-1){D.splice(S,1);for(var G=0;G!==D.length;G++)D[G].index=G;this.collisionMatrix.setNumObjects(Q),this.removeBodyEvent.body=P,this.dispatchEvent(this.removeBodyEvent)}},v.prototype.removeBody=v.prototype.remove,v.prototype.addMaterial=function(P){this.materials.push(P)},v.prototype.addContactMaterial=function(P){this.contactmaterials.push(P),this.contactMaterialTable.set(P.materials[0].id,P.materials[1].id,P)},typeof performance>"u"&&(performance={}),!performance.now){var I=Date.now();performance.timing&&performance.timing.navigationStart&&(I=performance.timing.navigationStart),performance.now=function(){return Date.now()-I}}var F=new s;v.prototype.step=function(P,Q,D){if(D=D||10,Q=Q||0,Q===0)this.internalStep(P),this.time+=P;else{var S=Math.floor((this.time+Q)/P)-Math.floor(this.time/P);S=Math.min(S,D);for(var G=performance.now(),E=0;E!==S&&(this.internalStep(P),!(performance.now()-G>P*1e3));E++);this.time+=Q;for(var T=this.time%P,x=T/P,L=F,J=this.bodies,z=0;z!==J.length;z++){var O=J[z];O.type!==f.STATIC&&O.sleepState!==f.SLEEPING?(O.position.vsub(O.previousPosition,L),L.scale(x,L),O.position.vadd(L,O.interpolatedPosition)):(O.interpolatedPosition.copy(O.position),O.interpolatedQuaternion.copy(O.quaternion))}}};var M={type:"postStep"},B={type:"preStep"},C={type:"collide",body:null,contact:null},A=[],N=[],V=[],U=[];new s,new s,new s,new s,new s,new s,new s,new s,new s,new i;var X=new i,ue=new i,R=new s;v.prototype.internalStep=function(P){this.dt=P;var Q=this.contacts,D=V,S=U,G=this.numObjects(),E=this.bodies,T=this.solver,x=this.gravity,L=this.doProfiling,J=this.profile,z=f.DYNAMIC,O,W=this.constraints,te=N;x.norm();var Ae=x.x,ve=x.y,me=x.z,j=0;for(L&&(O=performance.now()),j=0;j!==G;j++){var se=E[j];if(se.type&z){var $e=se.force,Ee=se.mass;$e.x+=Ee*Ae,$e.y+=Ee*ve,$e.z+=Ee*me}}for(var j=0,Qe=this.subsystems.length;j!==Qe;j++)this.subsystems[j].update();L&&(O=performance.now()),D.length=0,S.length=0,this.broadphase.collisionPairs(this,D,S),L&&(J.broadphase=performance.now()-O);var Ft=W.length;for(j=0;j!==Ft;j++){var we=W[j];if(!we.collideConnected)for(var Ke=D.length-1;Ke>=0;Ke-=1)(we.bodyA===D[Ke]&&we.bodyB===S[Ke]||we.bodyB===D[Ke]&&we.bodyA===S[Ke])&&(D.splice(Ke,1),S.splice(Ke,1))}this.collisionMatrixTick(),L&&(O=performance.now());var Xe=A,je=Q.length;for(j=0;j!==je;j++)Xe.push(Q[j]);Q.length=0;var Ze=this.frictionEquations.length;for(j=0;j!==Ze;j++)te.push(this.frictionEquations[j]);this.frictionEquations.length=0,this.narrowphase.getContacts(D,S,this,Q,Xe,this.frictionEquations,te),L&&(J.narrowphase=performance.now()-O),L&&(O=performance.now());for(var j=0;j<this.frictionEquations.length;j++)T.addEquation(this.frictionEquations[j]);for(var He=Q.length,tt=0;tt!==He;tt++){var we=Q[tt],se=we.bi,ze=we.bj;we.si,we.sj;var ut;if(se.material&&ze.material?ut=this.getContactMaterial(se.material,ze.material)||this.defaultContactMaterial:ut=this.defaultContactMaterial,ut.friction,se.material&&ze.material&&(se.material.friction>=0&&ze.material.friction>=0&&se.material.friction*ze.material.friction,se.material.restitution>=0&&ze.material.restitution>=0&&(we.restitution=se.material.restitution*ze.material.restitution)),T.addEquation(we),se.allowSleep&&se.type===f.DYNAMIC&&se.sleepState===f.SLEEPING&&ze.sleepState===f.AWAKE&&ze.type!==f.STATIC){var Tt=ze.velocity.norm2()+ze.angularVelocity.norm2(),Qt=Math.pow(ze.sleepSpeedLimit,2);Tt>=Qt*2&&(se._wakeUpAfterNarrowphase=!0)}if(ze.allowSleep&&ze.type===f.DYNAMIC&&ze.sleepState===f.SLEEPING&&se.sleepState===f.AWAKE&&se.type!==f.STATIC){var an=se.velocity.norm2()+se.angularVelocity.norm2(),Jt=Math.pow(se.sleepSpeedLimit,2);an>=Jt*2&&(ze._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(se,ze,!0),this.collisionMatrixPrevious.get(se,ze)||(C.body=ze,C.contact=we,se.dispatchEvent(C),C.body=se,ze.dispatchEvent(C))}for(L&&(J.makeContactConstraints=performance.now()-O,O=performance.now()),j=0;j!==G;j++){var se=E[j];se._wakeUpAfterNarrowphase&&(se.wakeUp(),se._wakeUpAfterNarrowphase=!1)}var Ft=W.length;for(j=0;j!==Ft;j++){var we=W[j];we.update();for(var Ke=0,Lt=we.equations.length;Ke!==Lt;Ke++){var mn=we.equations[Ke];T.addEquation(mn)}}T.solve(P,this),L&&(J.solve=performance.now()-O),T.removeAllEquations();var ln=Math.pow;for(j=0;j!==G;j++){var se=E[j];if(se.type&z){var Kt=ln(1-se.linearDamping,P),Dt=se.velocity;Dt.mult(Kt,Dt);var It=se.angularVelocity;if(It){var jt=ln(1-se.angularDamping,P);It.mult(jt,It)}}}for(this.dispatchEvent(B),j=0;j!==G;j++){var se=E[j];se.preStep&&se.preStep.call(se)}L&&(O=performance.now());var $t=X,xt=ue,yn=this.stepnumber,gn=f.DYNAMIC|f.KINEMATIC,vn=yn%(this.quatNormalizeSkip+1)===0,En=this.quatNormalizeFast,Mn=P*.5;for(o.types.PLANE,o.types.CONVEXPOLYHEDRON,j=0;j!==G;j++){var mt=E[j],$=mt.force,H=mt.torque;if(mt.type&gn&&mt.sleepState!==f.SLEEPING){var Z=mt.velocity,ee=mt.angularVelocity,Se=mt.position,fe=mt.quaternion,re=mt.invMass,he=mt.invInertiaWorld;Z.x+=$.x*re*P,Z.y+=$.y*re*P,Z.z+=$.z*re*P,mt.angularVelocity&&(he.vmult(H,R),R.mult(P,R),R.vadd(ee,ee)),Se.x+=Z.x*P,Se.y+=Z.y*P,Se.z+=Z.z*P,mt.angularVelocity&&($t.set(ee.x,ee.y,ee.z,0),$t.mult(fe,xt),fe.x+=Mn*xt.x,fe.y+=Mn*xt.y,fe.z+=Mn*xt.z,fe.w+=Mn*xt.w,vn&&(En?fe.normalizeFast():fe.normalize())),mt.aabb&&(mt.aabbNeedsUpdate=!0),mt.updateInertiaWorld&&mt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,L&&(J.integrate=performance.now()-O),this.time+=P,this.stepnumber+=1,this.dispatchEvent(M),j=0;j!==G;j++){var se=E[j],k=se.postStep;k&&k.call(se)}if(this.allowSleep)for(j=0;j!==G;j++)E[j].sleepTick(this.time)},v.prototype.clearForces=function(){for(var P=this.bodies,Q=P.length,D=0;D!==Q;D++){var S=P[D];S.force,S.torque,S.force.set(0,0,0),S.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(Ws)),Ws.exports}var Tr=$a();const Ha=Da(Tr),za=ii({__proto__:null,default:Ha},[Tr]);class Ua{scene;gravity;physicsImpostors;constructor(e){this.scene=e,this.gravity=new K(0,-9.81,0),this.physicsImpostors=new Map}initialize(){try{console.log(" Cannon.js ...");const e=new ei(!0,10,za);this.scene.enablePhysics(this.gravity,e),console.log(" Physics system initialized with Cannon.js (instant load)")}catch(e){throw console.error("Failed to initialize Cannon.js physics engine:",e),new Error("No physics engine available")}}addBoxBody(e,t){const n=new Sn(e,Sn.BoxImpostor,{mass:t.mass,restitution:t.restitution??.3,friction:t.friction??.5},this.scene);return this.physicsImpostors.set(e,n),n}addCylinderBody(e,t){const n=new Sn(e,Sn.CylinderImpostor,{mass:t.mass,restitution:t.restitution??.3,friction:t.friction??.5},this.scene);return this.physicsImpostors.set(e,n),n}addSphereBody(e,t){const n=new Sn(e,Sn.SphereImpostor,{mass:t.mass,restitution:t.restitution??.3,friction:t.friction??.5},this.scene);return this.physicsImpostors.set(e,n),n}addStaticBoxCollider(e){return this.addBoxBody(e,{mass:0})}removeBody(e){const t=this.physicsImpostors.get(e);t&&(t.dispose(),this.physicsImpostors.delete(e))}setVelocity(e,t){const n=this.physicsImpostors.get(e);n&&n.setLinearVelocity(t)}getVelocity(e){const t=this.physicsImpostors.get(e);return t?t.getLinearVelocity():null}setPhysicsEnabled(e,t){const n=this.physicsImpostors.get(e);n&&n.physicsBody&&(t?n.physicsBody.mass=n.getParam("mass")||1:n.physicsBody.mass=0,n.physicsBody.updateMassProperties())}dispose(){this.physicsImpostors.forEach(e=>e.dispose()),this.physicsImpostors.clear()}}var Ut=(a=>(a.BOTTLE="bottle",a.GLASS="glass",a.SHAKER="shaker",a.JIGGER="jigger",a.MIXING_GLASS="mixing_glass",a.NPC="npc",a.GUITAR="guitar",a))(Ut||{}),Ye=(a=>(a.BASE_SPIRIT="base_spirit",a.LIQUEUR="liqueur",a.JUICE="juice",a.MIXER="mixer",a.SYRUP="syrup",a.BITTERS="bitters",a))(Ye||{});class Wa{camera;scene;physics;cocktailSystem=null;interactableObjects=[];targetedObject=null;heldObject=null;holdOffset;holdParent;highlightLayer;INTERACTION_DISTANCE=3;frameCounter=0;RAYCAST_THROTTLE_FRAMES=10;constructor(e,t,n){this.camera=e,this.scene=t,this.physics=n,this.holdParent=new Pn("holdParent",t),this.holdParent.parent=e,this.holdOffset=new K(.45,-.65,.85),this.highlightLayer=new ti("highlight",t),this.highlightLayer.blurHorizontalSize=1,this.highlightLayer.blurVerticalSize=1}setCocktailSystem(e){this.cocktailSystem=e}registerInteractable(e,t,n,r){const o=e;o.userData={interactable:!0,type:t,liquorType:n,capacity:r,originalPosition:e.position.clone()},this.interactableObjects.push(o)}update(){this.updateTargeting(),this.updateHeldObject()}updateTargeting(){if(this.heldObject||(this.frameCounter++,this.frameCounter<this.RAYCAST_THROTTLE_FRAMES))return;this.frameCounter=0,this.targetedObject&&this.targetedObject!==this.heldObject&&this.highlightLayer.removeMesh(this.targetedObject),this.targetedObject=null;const e=this.camera.getForwardRay(this.INTERACTION_DISTANCE),t=this.scene.pickWithRay(e,n=>this.interactableObjects.includes(n));t&&t.hit&&t.pickedMesh?(this.targetedObject=t.pickedMesh,this.highlightLayer.addMesh(this.targetedObject,q.Yellow()),this.updateInteractionHint()):this.hideInteractionHint()}updateHeldObject(){if(!this.heldObject)return;const e=this.camera.getDirection(Bn.Z),t=this.camera.getDirection(Bn.X),n=this.camera.getDirection(Bn.Y);this.heldObject.position=this.camera.position.add(e.scale(this.holdOffset.z)).add(t.scale(this.holdOffset.x)).add(n.scale(this.holdOffset.y)),this.heldObject.rotationQuaternion=this.camera.absoluteRotation.clone(),this.heldObject.metadata?.originalScaling||(this.heldObject.metadata=this.heldObject.metadata||{},this.heldObject.metadata.originalScaling=this.heldObject.scaling.clone())}pickupItem(){return!this.targetedObject||this.heldObject?!1:(this.heldObject=this.targetedObject,this.highlightLayer.removeMesh(this.heldObject),this.physics.setPhysicsEnabled(this.heldObject,!1),console.log(`Picked up: ${this.heldObject.userData.type}`),!0)}dropItem(){if(!this.heldObject)return!1;const e=this.heldObject;e.metadata?.originalScaling&&(e.scaling=e.metadata.originalScaling);const t=this.camera.position.add(this.camera.getDirection(Bn.Z).scale(1.5)).add(this.camera.getDirection(Bn.Y).scale(-.5));e.position=t,this.physics.setPhysicsEnabled(e,!0);const n=this.camera.getDirection(Bn.Z).scale(2);return this.physics.setVelocity(e,n),this.heldObject=null,console.log(`Dropped: ${e.userData.type}`),!0}returnItem(){if(!this.heldObject)return!1;const e=this.heldObject,t=e.userData.originalPosition;return e.metadata?.originalScaling&&(e.scaling=e.metadata.originalScaling),t&&(e.position=t.clone()),this.physics.setPhysicsEnabled(e,!0),this.physics.setVelocity(e,K.Zero()),this.heldObject=null,console.log(`Returned: ${e.userData.type}`),!0}getHeldObject(){return this.heldObject}getTargetedObject(){return this.targetedObject}updateInteractionHint(){if(!this.targetedObject)return;const e=document.getElementById("interaction-hint");if(e){const t=this.targetedObject.userData.type;let n=" E ";if(t===Ut.NPC)n=" E ";else if(t===Ut.GUITAR)n=" E ";else if(this.cocktailSystem&&this.targetedObject.userData.liquorType){const r=this.cocktailSystem.getLiquorData(this.targetedObject.userData.liquorType);r&&(n=`${r.displayName} (${r.name}) -  E `)}else t===Ut.GLASS?n=" (Glass) -  E ":t===Ut.SHAKER?n="Shaker () -  E ":t===Ut.JIGGER?n="Jigger () -  E ":t===Ut.MIXING_GLASS?n="Mixing Glass () -  E ":n=`${t} -  E `;e.textContent=n,e.style.display="block"}}hideInteractionHint(){const e=document.getElementById("interaction-hint");e&&(e.style.display="none")}dispose(){this.highlightLayer.dispose(),this.holdParent.dispose()}}class qa{scene;containerContents;isPouringActive;pouringStartTime;currentPouringBottle;originalBottleRotation;currentPouringAmount;pourProgressHideTimer;isDrinking;drinkingStartTime;currentDrinkingGlass;originalGlassPosition;lastDrinkInfo;isShakingActive;shakeIntensity;shakeTime;particleSystems;liquorDatabase;pourProgressUI;pourRate;constructor(e){this.scene=e,this.containerContents=new Map,this.isPouringActive=!1,this.pouringStartTime=0,this.currentPouringBottle=null,this.originalBottleRotation=null,this.currentPouringAmount=0,this.pourProgressHideTimer=null,this.isDrinking=!1,this.drinkingStartTime=0,this.currentDrinkingGlass=null,this.originalGlassPosition=null,this.lastDrinkInfo=null,this.isShakingActive=!1,this.shakeIntensity=0,this.shakeTime=0,this.particleSystems=new Map,this.liquorDatabase=this.initLiquorDatabase(),this.pourProgressUI={panel:document.getElementById("pour-progress-panel"),containerVolumeBar:document.getElementById("container-volume-bar"),containerVolumeText:document.getElementById("container-volume-text"),pourRateBar:document.getElementById("pour-rate-bar"),pourRateText:document.getElementById("pour-rate-text")},this.pourRate=30}initLiquorDatabase(){const e=new Map;return e.set("vodka",{name:"",displayName:"Vodka",color:15790320,alcoholContent:40,category:Ye.BASE_SPIRIT}),e.set("gin",{name:"",displayName:"Gin",color:15267064,alcoholContent:40,category:Ye.BASE_SPIRIT}),e.set("rum",{name:"",displayName:"Rum",color:13935988,alcoholContent:40,category:Ye.BASE_SPIRIT}),e.set("whiskey",{name:"",displayName:"Whiskey",color:12088115,alcoholContent:40,category:Ye.BASE_SPIRIT}),e.set("tequila",{name:"",displayName:"Tequila",color:16113331,alcoholContent:40,category:Ye.BASE_SPIRIT}),e.set("brandy",{name:"",displayName:"Brandy",color:9127187,alcoholContent:40,category:Ye.BASE_SPIRIT}),e.set("lemon_juice",{name:"",displayName:"Lemon Juice",color:16774223,alcoholContent:0,category:Ye.MIXER}),e.set("lime_juice",{name:"",displayName:"Lime Juice",color:3329330,alcoholContent:0,category:Ye.MIXER}),e.set("simple_syrup",{name:"",displayName:"Simple Syrup",color:16770229,alcoholContent:0,category:Ye.SYRUP}),e.set("grenadine",{name:"",displayName:"Grenadine",color:16711680,alcoholContent:0,category:Ye.SYRUP}),e.set("angostura_bitters",{name:"",displayName:"Angostura Bitters",color:9109504,alcoholContent:44.7,category:Ye.BITTERS}),e.set("orange_juice",{name:"",displayName:"Orange Juice",color:16753920,alcoholContent:0,category:Ye.JUICE}),e.set("pineapple_juice",{name:"",displayName:"Pineapple Juice",color:16771899,alcoholContent:0,category:Ye.JUICE}),e.set("cranberry_juice",{name:"",displayName:"Cranberry Juice",color:14423100,alcoholContent:0,category:Ye.JUICE}),e.set("tomato_juice",{name:"",displayName:"Tomato Juice",color:16737095,alcoholContent:0,category:Ye.JUICE}),e.set("grapefruit_juice",{name:"",displayName:"Grapefruit Juice",color:16738740,alcoholContent:0,category:Ye.JUICE}),e.set("soda_water",{name:"",displayName:"Soda Water",color:14745599,alcoholContent:0,category:Ye.MIXER}),e.set("tonic_water",{name:"",displayName:"Tonic Water",color:15794175,alcoholContent:0,category:Ye.MIXER}),e.set("cola",{name:"",displayName:"Cola",color:4073251,alcoholContent:0,category:Ye.MIXER}),e.set("liqueur",{name:"",displayName:"Liqueur",color:16739229,alcoholContent:20,category:Ye.LIQUEUR}),e.set("vermouth_dry",{name:"",displayName:"Dry Vermouth",color:15263952,alcoholContent:18,category:Ye.LIQUEUR}),e.set("vermouth_sweet",{name:"",displayName:"Sweet Vermouth",color:9127187,alcoholContent:18,category:Ye.LIQUEUR}),e.set("campari",{name:"",displayName:"Campari",color:14423100,alcoholContent:25,category:Ye.LIQUEUR}),e.set("triple_sec",{name:"",displayName:"Triple Sec",color:16753920,alcoholContent:40,category:Ye.LIQUEUR}),e.set("coconut_cream",{name:"",displayName:"Coconut Cream",color:16775920,alcoholContent:0,category:Ye.MIXER}),e.set("coffee_liqueur",{name:"",displayName:"Coffee Liqueur",color:4073251,alcoholContent:20,category:Ye.LIQUEUR}),e.set("amaretto",{name:"",displayName:"Amaretto",color:13789470,alcoholContent:28,category:Ye.LIQUEUR}),e.set("baileys",{name:"",displayName:"Baileys",color:13808780,alcoholContent:17,category:Ye.LIQUEUR}),e.set("blue_curacao",{name:"",displayName:"Blue Curaao",color:255,alcoholContent:21,category:Ye.LIQUEUR}),e.set("peach_schnapps",{name:"",displayName:"Peach Schnapps",color:16767673,alcoholContent:20,category:Ye.LIQUEUR}),e}initContainer(e,t=300){this.containerContents.set(e,{ingredients:[],color:16777215,volume:0,maxVolume:t,liquidMesh:null}),this.createLiquidVisual(e)}createLiquidVisual(e){const t=this.containerContents.get(e);if(!t)return;const n=xe.CreateCylinder(`liquid_${e.name}`,{diameterTop:.3,diameterBottom:.28,height:.01,tessellation:32},this.scene),r=new Ne(`liquidMat_${e.name}`,this.scene);r.albedoColor=q.FromHexString("#ffffff"),r.metallic=.1,r.roughness=.3,r.alpha=.8,r.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,n.material=r,n.parent=e,n.position=new K(0,.08,0),n.isVisible=!1,t.liquidMesh=n}updateLiquidVisual(e){const t=this.containerContents.get(e);if(!t||!t.liquidMesh)return;const n=t.volume/t.maxVolume;if(n>0){t.liquidMesh.isVisible=!0;const r=.55,o=Math.max(.01,Math.min(r*n,r)),s=.14,i=.12+n*.02,l=xe.CreateCylinder(`liquid_${e.name}`,{diameterTop:i*2,diameterBottom:s*2,height:o,tessellation:32},this.scene);l.material=t.liquidMesh.material,l.parent=e,l.position=new K(0,.08+o/2,0),t.liquidMesh.dispose(),t.liquidMesh=l;const h=t.liquidMesh.material;h&&(h.albedoColor=q.FromHexString("#"+t.color.toString(16).padStart(6,"0")))}else t.liquidMesh.isVisible=!1}pour(e,t,n,r,o){const s=this.containerContents.get(t);if(!s)return;if(s.volume>=s.maxVolume){console.log("");return}if(o){if(K.Distance(e.getAbsolutePosition(),t.getAbsolutePosition())>1.5)return;const u=o.getForwardRay().direction,c=t.getAbsolutePosition().subtract(o.globalPosition).normalize();if(K.Dot(u,c)<.85)return}const i=this.pourRate*r,l=this.liquorDatabase.get(n);if(l){const h=s.ingredients.find(u=>u.type===n);if(h?h.amount+=i:s.ingredients.push({type:n,name:l.name,displayName:l.displayName||l.name,amount:i,color:l.color}),s.volume+=i,this.updateMixedColor(t),this.updateLiquidVisual(t),this.updatePourProgressUI(t,i),this.isPouringActive||(this.createPourParticles(e,t),this.isPouringActive=!0,this.currentPouringBottle=e,this.originalBottleRotation=e.rotation.clone(),this.currentPouringAmount=0,this.pourProgressHideTimer&&(clearTimeout(this.pourProgressHideTimer),this.pourProgressHideTimer=null)),this.currentPouringAmount+=i,this.currentPouringBottle){const u=Math.PI/3,c=this.currentPouringBottle.rotation.z,d=3*r;this.currentPouringBottle.rotation.z+=(u-c)*d}}}stopPouring(){this.currentPouringBottle&&this.originalBottleRotation&&this.currentPouringBottle.rotation.copyFrom(this.originalBottleRotation),this.isPouringActive=!1,this.currentPouringBottle=null,this.originalBottleRotation=null,this.removePourParticles(),this.pourProgressUI.panel&&(this.pourProgressHideTimer&&clearTimeout(this.pourProgressHideTimer),this.pourProgressHideTimer=setTimeout(()=>{this.pourProgressUI.panel&&(this.pourProgressUI.panel.style.display="none"),this.currentPouringAmount=0},5e3))}pourFromShaker(e,t,n){const r=this.containerContents.get(e),o=this.containerContents.get(t);if(!r||!o||r.volume<=0||o.volume>=o.maxVolume)return;const s=Math.min(this.pourRate*n,r.volume,o.maxVolume-o.volume);if(r.ingredients.forEach(i=>{const l=s/r.volume,h=i.amount*l;i.amount-=h;const u=o.ingredients.find(c=>c.type===i.type);u?u.amount+=h:o.ingredients.push({type:i.type,name:i.name,displayName:i.displayName,amount:h,color:i.color})}),r.volume-=s,o.volume+=s,r.ingredients=r.ingredients.filter(i=>i.amount>.01),this.updateMixedColor(e),this.updateMixedColor(t),this.updateLiquidVisual(e),this.updateLiquidVisual(t),this.updatePourProgressUI(t,s),this.isPouringActive||(this.createPourParticles(e,t),this.isPouringActive=!0,this.currentPouringBottle=e,this.originalBottleRotation=e.rotation.clone(),this.currentPouringAmount=0,this.pourProgressHideTimer&&(clearTimeout(this.pourProgressHideTimer),this.pourProgressHideTimer=null)),this.currentPouringAmount+=s,this.currentPouringBottle){const i=Math.PI/3,l=this.currentPouringBottle.rotation.z,h=3*n;this.currentPouringBottle.rotation.z+=(i-l)*h}}updatePourProgressUI(e,t){if(!this.pourProgressUI.panel)return;const n=this.containerContents.get(e);if(!n)return;this.pourProgressUI.panel.style.display="block";const r=n.volume/n.maxVolume*100;this.pourProgressUI.containerVolumeBar&&(this.pourProgressUI.containerVolumeBar.style.width=`${Math.min(r,100)}%`),this.pourProgressUI.containerVolumeText&&(this.pourProgressUI.containerVolumeText.textContent=`${Math.round(n.volume)}/${n.maxVolume}ml`);const o=this.currentPouringAmount/n.maxVolume*100;this.pourProgressUI.pourRateBar&&(this.pourProgressUI.pourRateBar.style.width=`${Math.min(o,100)}%`),this.pourProgressUI.pourRateText&&(this.pourProgressUI.pourRateText.textContent=`${Math.round(this.currentPouringAmount)}ml`)}createPourParticles(e,t){const n=new Io("pourParticles",2e3,this.scene);n.particleTexture=new qe("https://www.babylonjs.com/assets/Flare.png",this.scene);const r=e.getAbsolutePosition().clone();r.y-=.3,n.emitter=r,n.minEmitBox=new K(-.05,0,-.05),n.maxEmitBox=new K(.05,0,.05),n.color1=new Xt(.7,.8,1,.8),n.color2=new Xt(.5,.6,.9,.6),n.colorDead=new Xt(.3,.4,.7,0),n.minSize=.03,n.maxSize=.06,n.minLifeTime=.3,n.maxLifeTime=.6,n.emitRate=500;const s=t.getAbsolutePosition().subtract(r).normalize();n.direction1=s.add(new K(-.1,-.2,-.1)),n.direction2=s.add(new K(.1,-.2,.1)),n.minEmitPower=2,n.maxEmitPower=3,n.updateSpeed=.01,n.gravity=new K(0,-9.8,0),n.blendMode=Io.BLENDMODE_STANDARD,n.start(),this.particleSystems.set("pour",n)}removePourParticles(){const e=this.particleSystems.get("pour");e&&(e.stop(),e.dispose(),this.particleSystems.delete("pour"))}shake(e,t){const n=this.containerContents.get(e);if(!n||n.volume===0){console.log("Shaker ");return}this.isShakingActive=!0,this.shakeTime+=t,this.shakeIntensity=Math.sin(this.shakeTime*20)*.05,e.rotation.z=this.shakeIntensity,e.rotation.x=Math.sin(this.shakeTime*15)*.03,this.shakeTime>2&&this.enhanceMixing(e)}stopShaking(e){this.isShakingActive=!1,this.shakeTime=0,e.rotation.z=0,e.rotation.x=0}enhanceMixing(e){this.containerContents.get(e)&&(this.updateMixedColor(e),this.updateLiquidVisual(e))}updateMixedColor(e){const t=this.containerContents.get(e);if(!t||t.ingredients.length===0)return;let n=0,r=0,o=0,s=0;if(t.ingredients.forEach(i=>{const l=q.FromHexString("#"+i.color.toString(16).padStart(6,"0")),h=i.amount;n+=l.r*h,r+=l.g*h,o+=l.b*h,s+=h}),s>0){n/=s,r/=s,o/=s;const i=new q(n,r,o);t.color=parseInt(i.toHexString().substring(1),16)}}drink(e,t=!0){const n=this.containerContents.get(e);if(!n||n.volume===0)return console.log(""),null;if(t&&!this.isDrinking)return this.isDrinking=!0,this.drinkingStartTime=Date.now(),this.currentDrinkingGlass=e,this.originalGlassPosition=e.position.clone(),null;const r={volume:n.volume,ingredients:[...n.ingredients],color:n.color,name:this.identifyCocktail(n)};return n.ingredients=[],n.volume=0,n.color=16777215,this.updateLiquidVisual(e),console.log(` ${r.name}`),r}getLastDrinkInfo(){const e=this.lastDrinkInfo;return this.lastDrinkInfo=null,e}updateDrinkingAnimation(){if(!this.isDrinking||!this.currentDrinkingGlass)return;const e=(Date.now()-this.drinkingStartTime)/1e3;if(e<1){const t=e;this.originalGlassPosition&&(this.currentDrinkingGlass.position.y=this.originalGlassPosition.y+.2*t,this.currentDrinkingGlass.rotation.x=-Math.PI/6*t)}else{this.originalGlassPosition&&this.currentDrinkingGlass.position.copyFrom(this.originalGlassPosition),this.currentDrinkingGlass.rotation.x=0;const t=this.containerContents.get(this.currentDrinkingGlass);if(t&&t.volume>0){const n={volume:t.volume,ingredients:[...t.ingredients],color:t.color,name:this.identifyCocktail(t)};t.ingredients=[],t.volume=0,t.color=16777215,this.updateLiquidVisual(this.currentDrinkingGlass),this.lastDrinkInfo=n}this.isDrinking=!1,this.currentDrinkingGlass=null}}identifyCocktail(e){const t=e.ingredients,n=t.map(o=>o.type),r=o=>{const s=t.find(i=>i.type===o);return s?s.amount:0};if(n.includes("gin")&&n.includes("vermouth_dry")){const o=r("gin"),s=r("vermouth_dry"),i=o/s,l=n.some(d=>["vodka","rum","whiskey","tequila","brandy","campari"].includes(d)),h=n.some(d=>["orange_juice","cranberry_juice","pineapple_juice","tomato_juice","grapefruit_juice"].includes(d)),u=["lemon_juice","lime_juice","simple_syrup"],c=n.filter(d=>d!=="gin"&&d!=="vermouth_dry").every(d=>u.includes(d));if(!l&&!h&&c&&i>=2&&i<=3)return" (Martini)"}if(n.includes("vodka")&&n.includes("vermouth_dry")){const o=r("vodka"),s=r("vermouth_dry"),i=o/s;if(!n.some(h=>["gin","rum","whiskey","tequila","brandy","campari"].includes(h))&&i>=2&&i<=3)return" (Vodka Martini)"}if(n.includes("gin")&&n.includes("campari")&&n.includes("vermouth_sweet")){const o=r("gin"),s=r("campari"),i=r("vermouth_sweet"),l=(o+s+i)/3;if(Math.abs(o-l)/l<.3&&Math.abs(s-l)/l<.3&&Math.abs(i-l)/l<.3)return" (Negroni)"}return n.includes("tequila")&&n.includes("triple_sec")&&n.includes("lime_juice")?" (Margarita)":n.includes("rum")&&n.includes("lime_juice")&&n.includes("simple_syrup")?" (Daiquiri)":n.includes("rum")&&n.includes("pineapple_juice")&&n.includes("coconut_cream")?" (Pia Colada)":n.includes("vodka")&&n.includes("triple_sec")&&n.includes("cranberry_juice")&&n.includes("lime_juice")?" (Cosmopolitan)":n.includes("rum")&&n.includes("lime_juice")&&n.includes("simple_syrup")?" (Mojito)":n.includes("whiskey")&&n.includes("vermouth_sweet")?" (Manhattan)":n.includes("whiskey")&&n.includes("lemon_juice")&&n.includes("simple_syrup")?" (Whiskey Sour)":n.includes("vodka")&&n.includes("tomato_juice")?" (Bloody Mary)":n.includes("vodka")&&n.includes("orange_juice")&&n.length===2?" (Screwdriver)":n.includes("tequila")&&n.includes("orange_juice")&&n.includes("grenadine")?" (Tequila Sunrise)":n.includes("rum")&&n.includes("triple_sec")&&n.includes("lime_juice")?" (Mai Tai)":n.includes("vodka")&&n.includes("rum")&&n.includes("gin")&&n.includes("tequila")&&n.includes("triple_sec")?" (Long Island Iced Tea)":n.includes("vodka")&&n.length===1?"":n.includes("gin")&&n.length===1?"":n.includes("rum")&&n.includes("liqueur")?"":n.includes("vodka")&&n.includes("liqueur")?"":n.length>2?"":n.length===2?"":""}emptyContainer(e){const t=this.containerContents.get(e);t&&(t.ingredients=[],t.volume=0,t.color=16777215,this.updateLiquidVisual(e))}getContainerInfo(e){return this.containerContents.get(e)||null}isEmpty(e){const t=this.containerContents.get(e);return!t||t.volume===0}isFull(e){const t=this.containerContents.get(e);return t!==void 0&&t.volume>=t.maxVolume}calculateAlcoholContent(e){if(!e||e.volume===0)return 0;let t=0;return e.ingredients.forEach(r=>{const o=this.liquorDatabase.get(r.type);o&&o.alcoholContent&&(t+=r.amount*(o.alcoholContent/100))}),t/e.volume*100}showContainerInfo(e){const t=this.containerContents.get(e),n=document.getElementById("container-info");if(!(!t||!n))if(t.volume>0){const r=t.ingredients.map(i=>{const l=this.liquorDatabase.get(i.type);return`
                    <div class="ingredient-item">
                        <span class="ingredient-name">${l?l.name:i.name}</span>
                        <span class="ingredient-amount">${Math.round(i.amount)} ml</span>
                    </div>
                `}).join(""),o=this.calculateAlcoholContent(t),s=this.identifyCocktail(t);n.innerHTML=`
                <h3>${s}</h3>
                <div class="ingredient-list">
                    ${r}
                </div>
                <div class="volume-info">
                    : ${Math.round(t.volume)} / ${t.maxVolume} ml<br>
                    : ${o.toFixed(1)}%
                </div>
            `,n.classList.add("visible")}else n.classList.remove("visible")}hideContainerInfo(){const e=document.getElementById("container-info");e&&e.classList.remove("visible")}update(e){this.updateDrinkingAnimation()}getLiquorDatabase(){return this.liquorDatabase}getLiquorData(e){return this.liquorDatabase.get(e)}getCocktailRecipes(){return[{name:"Martini ",ingredients:[{amount:"60ml",name:" Gin"},{amount:"10ml",name:" Dry Vermouth"}],method:"Stir"},{name:"Vodka Martini ",ingredients:[{amount:"60ml",name:" Vodka"},{amount:"10ml",name:" Dry Vermouth"}],method:"Stir"},{name:"Negroni ",ingredients:[{amount:"30ml",name:" Gin"},{amount:"30ml",name:" Campari"},{amount:"30ml",name:" Sweet Vermouth"}],method:"Build"},{name:"Margarita ",ingredients:[{amount:"50ml",name:" Tequila"},{amount:"20ml",name:" Triple Sec"},{amount:"15ml",name:" Lime Juice"}],method:"Shake"},{name:"Daiquiri ",ingredients:[{amount:"60ml",name:" Rum"},{amount:"20ml",name:" Lime Juice"},{amount:"10ml",name:" Simple Syrup"}],method:"Shake"},{name:"Cosmopolitan ",ingredients:[{amount:"40ml",name:" Vodka"},{amount:"15ml",name:" Triple Sec"},{amount:"15ml",name:" Lime Juice"},{amount:"30ml",name:" Cranberry Juice"}],method:"Shake"},{name:"Mojito ",ingredients:[{amount:"45ml",name:" Rum"},{amount:"20ml",name:" Lime Juice"},{amount:"20ml",name:" Simple Syrup"},{amount:"",name:" Soda Water"}],method:"Muddle"},{name:"Pia Colada ",ingredients:[{amount:"50ml",name:" Rum"},{amount:"30ml",name:" Coconut Cream"},{amount:"50ml",name:" Pineapple Juice"}],method:"Blend"},{name:"Whiskey Sour ",ingredients:[{amount:"50ml",name:" Whiskey"},{amount:"25ml",name:" Lemon Juice"},{amount:"15ml",name:" Simple Syrup"}],method:"Shake"},{name:"Manhattan ",ingredients:[{amount:"50ml",name:" Whiskey"},{amount:"20ml",name:" Sweet Vermouth"},{amount:"2",name:" Angostura Bitters"}],method:"Stir"},{name:"Long Island Iced Tea ",ingredients:[{amount:"15ml",name:" Vodka"},{amount:"15ml",name:" Rum"},{amount:"15ml",name:" Gin"},{amount:"15ml",name:" Tequila"},{amount:"15ml",name:" Triple Sec"},{amount:"25ml",name:" Lemon Juice"},{amount:"30ml",name:" Simple Syrup"},{amount:"",name:" Cola"}],method:"Shake"},{name:"Bloody Mary ",ingredients:[{amount:"45ml",name:" Vodka"},{amount:"90ml",name:" Tomato Juice"},{amount:"15ml",name:" Lemon Juice"},{amount:"",name:" Angostura Bitters"}],method:"Roll"},{name:"Tequila Sunrise ",ingredients:[{amount:"45ml",name:" Tequila"},{amount:"90ml",name:" Orange Juice"},{amount:"15ml",name:" Grenadine"}],method:"Build"},{name:"Screwdriver ",ingredients:[{amount:"50ml",name:" Vodka"},{amount:"100ml",name:" Orange Juice"}],method:"Build"},{name:"Mai Tai ",ingredients:[{amount:"40ml",name:" Rum"},{amount:"20ml",name:" Triple Sec"},{amount:"15ml",name:" Lime Juice"},{amount:"10ml",name:" Simple Syrup"}],method:"Shake"}]}}class Ka{camera;scene;canvas;MOVE_SPEED=.165;SPRINT_SPEED=.33;MOUSE_SENSITIVITY=.08;keys;isPointerLocked=!1;constructor(e,t,n){this.camera=e,this.scene=t,this.canvas=n,this.keys=new Map,this.setupControls(),this.setupPointerLock()}setupControls(){window.addEventListener("keydown",e=>{this.keys.set(e.code,!0)}),window.addEventListener("keyup",e=>{this.keys.set(e.code,!1)}),this.camera.keysUp=[87],this.camera.keysDown=[83],this.camera.keysLeft=[65],this.camera.keysRight=[68],this.camera.speed=this.MOVE_SPEED,this.camera.angularSensibility=1e3/this.MOUSE_SENSITIVITY,this.camera.checkCollisions=!0,this.camera.applyGravity=!0,this.camera.ellipsoid=new K(.6,.9,.6),this.camera.ellipsoidOffset=new K(0,0,0),this.camera.upperBetaLimit=Math.PI/2+.1,this.camera.lowerBetaLimit=-Math.PI/2-.1}setupPointerLock(){this.canvas.addEventListener("click",()=>{this.isPointerLocked||this.canvas.requestPointerLock()}),document.addEventListener("pointerlockchange",()=>{this.isPointerLocked=document.pointerLockElement===this.canvas,this.isPointerLocked?this.camera.attachControl(this.canvas,!0):this.camera.detachControl()})}update(e){const t=this.keys.get("ShiftLeft")||this.keys.get("ShiftRight");this.camera.speed=t?this.SPRINT_SPEED:this.MOVE_SPEED,this.keys.get("Space")}getCamera(){return this.camera}setPosition(e){this.camera.position=e}isKeyPressed(e){return this.keys.get(e)===!0}dispose(){this.camera.detachControl()}}class ja{scene;shadowGenerator=null;constructor(e){this.scene=e,this.setupLights(),this.setupPostProcessing()}setupLights(){const e=new Ls("mainLight",new K(-1,-2,-1),this.scene);e.position=new K(20,40,20),e.intensity=.8,e.diffuse=new q(1,.98,.95),e.specular=new q(1,1,1),this.shadowGenerator=new Po(1024,e),this.shadowGenerator.usePercentageCloserFiltering=!0,this.shadowGenerator.filteringQuality=Po.QUALITY_HIGH,this.shadowGenerator.bias=.001;const t=new Js("hemiLight",new K(0,1,0),this.scene);t.intensity=.5,t.diffuse=new q(.95,.95,1),t.groundColor=new q(.4,.38,.35),t.specular=new q(.9,.9,.9);const n=new Ht("barSpotlight",new K(0,4,-3),new K(0,-1,0),Math.PI/3,2,this.scene);n.intensity=1.5,n.diffuse=new q(1,1,.98),n.specular=new q(1,1,1),this.scene.environmentTexture=ni.CreateFromPrefilteredData("https://assets.babylonjs.com/environments/environmentSpecular.env",this.scene),this.scene.environmentIntensity=1,console.log("  PBR ")}setupPostProcessing(){this.scene.fogMode=er.FOGMODE_NONE,console.log(" FXAA")}addShadowCaster(e){this.shadowGenerator&&this.shadowGenerator.addShadowCaster(e)}getShadowGenerator(){return this.shadowGenerator}dispose(){this.shadowGenerator&&this.shadowGenerator.dispose()}}class Ya{scene;physics;interaction;cocktail;bottles=[];glasses=[];barTools={};constructor(e,t,n,r){this.scene=e,this.physics=t,this.interaction=n,this.cocktail=r}async createEnvironment(){this.createFloorAndWalls(),this.createBarCounter(),this.createLiquorShelf(),this.createBarBottles(),this.createGlasses(),await this.createBarTools(),this.createFurniture()}createFloorAndWalls(){const e=xe.CreateGround("floor",{width:30,height:30},this.scene),t=new Ne("floorMat",this.scene);t.albedoColor=new q(.12,.1,.08),t.metallic=0,t.roughness=.85,t.environmentIntensity=.3,t.reflectivityColor=new q(.05,.05,.05),t.microSurface=.4,t.clearCoat.isEnabled=!1,e.material=t,e.receiveShadows=!0,e.checkCollisions=!0,this.physics.addStaticBoxCollider(e);const n=new Ne("wallMat",this.scene);n.albedoColor=new q(.18,.18,.19),n.metallic=0,n.roughness=.15,n.environmentIntensity=1.2,n.reflectivityColor=new q(.3,.3,.32),n.microSurface=.92,n.clearCoat.isEnabled=!0,n.clearCoat.intensity=.5,n.clearCoat.roughness=.1;const r=xe.CreateBox("backWall",{width:30,height:5,depth:.5},this.scene);r.position=new K(0,2.5,-15),r.material=n,r.receiveShadows=!0,r.checkCollisions=!0,this.physics.addStaticBoxCollider(r);const o=xe.CreateBox("leftWall",{width:.5,height:5,depth:30},this.scene);o.position=new K(-15,2.5,0),o.material=n,o.receiveShadows=!0,o.checkCollisions=!0,this.physics.addStaticBoxCollider(o);const s=xe.CreateBox("rightWall",{width:.5,height:5,depth:30},this.scene);s.position=new K(15,2.5,0),s.material=n,s.receiveShadows=!0,s.checkCollisions=!0,this.physics.addStaticBoxCollider(s);const i=xe.CreateBox("frontWall",{width:30,height:5,depth:.5},this.scene);i.position=new K(0,2.5,15),i.material=n,i.receiveShadows=!0,i.checkCollisions=!0,this.physics.addStaticBoxCollider(i);const l=xe.CreateBox("ceiling",{width:30,height:.4,depth:30},this.scene);l.position=new K(0,5,0);const h=new Ne("ceilingMat",this.scene);h.albedoColor=new q(.12,.1,.08),h.metallic=0,h.roughness=.9,h.environmentIntensity=.2,l.material=h,l.receiveShadows=!0,l.checkCollisions=!0,this.physics.addStaticBoxCollider(l)}createBarCounter(){const e=xe.CreateBox("barCounter",{width:12,height:.2,depth:2},this.scene);e.position=new K(0,1.05,-3);const t=new Ne("counterMat",this.scene);t.albedoColor=new q(.95,.95,.95),t.metallic=0,t.roughness=.45,t.environmentIntensity=.6,t.reflectivityColor=new q(.3,.3,.3),t.microSurface=.65,t.clearCoat.isEnabled=!1,e.material=t,e.receiveShadows=!0,e.checkCollisions=!0,this.physics.addStaticBoxCollider(e);const n=xe.CreateBox("barBase",{width:12,height:1,depth:2},this.scene);n.position=new K(0,.5,-3);const r=new Ne("baseMat",this.scene);r.albedoColor=new q(.15,.15,.15),r.metallic=0,r.roughness=.15,r.environmentIntensity=.9,r.reflectivityColor=new q(.2,.2,.2),r.microSurface=.9,n.material=r,n.receiveShadows=!0,n.checkCollisions=!0,this.physics.addStaticBoxCollider(n)}createLiquorShelf(){const e=[1.5,2.5,3.5],t=new Ne("shelfMat",this.scene);t.albedoColor=new q(.25,.2,.15),t.metallic=.2,t.roughness=.6,e.forEach((o,s)=>{const i=xe.CreateBox(`shelf_${s}`,{width:10,height:.1,depth:.8},this.scene);i.position=new K(0,o,-8),i.material=t,i.receiveShadows=!0,i.checkCollisions=!0,this.physics.addStaticBoxCollider(i)});const n=xe.CreateBox("shelfBack",{width:10,height:3,depth:.1},this.scene);n.position=new K(0,2.5,-8.5);const r=new Ne("panelMat",this.scene);r.albedoColor=new q(.3,.25,.2),r.metallic=.1,r.roughness=.8,n.material=r,n.receiveShadows=!0}createBarBottles(){[{name:"bottle_whiskey_1",position:new K(-4,1.9,-8),liquorType:"whiskey",shape:"square",liquidColor:new q(.6,.35,.1)},{name:"bottle_gin",position:new K(-2,1.9,-8),liquorType:"gin",shape:"tall",liquidColor:new q(.95,.97,.95)},{name:"bottle_vodka",position:new K(0,1.9,-8),liquorType:"vodka",shape:"round",liquidColor:new q(.98,.98,1)},{name:"bottle_rum",position:new K(2,1.9,-8),liquorType:"rum",shape:"wide",liquidColor:new q(.5,.25,.08)},{name:"bottle_tequila",position:new K(4,1.9,-8),liquorType:"tequila",shape:"square",liquidColor:new q(.95,.92,.8)}].forEach(t=>{let n;switch(t.shape){case"square":n=this.createSquareBottle(t.name,t.position,t.liquidColor);break;case"tall":n=this.createTallBottle(t.name,t.position,t.liquidColor);break;case"round":n=this.createRoundBottle(t.name,t.position,t.liquidColor);break;case"wide":n=this.createWideBottle(t.name,t.position,t.liquidColor);break;default:n=this.createRoundBottle(t.name,t.position,t.liquidColor)}this.bottles.push(n),this.interaction.registerInteractable(n,Ut.BOTTLE,t.liquorType),this.physics.addCylinderBody(n,{mass:.5,restitution:.3,friction:.6}),console.log(` Created procedural bottle: ${t.name}`)})}createSquareBottle(e,t,n){const r=xe.CreateBox(`${e}_body`,{width:.3,height:.7,depth:.3},this.scene),o=xe.CreateCylinder(`${e}_neck`,{height:.18,diameterTop:.08,diameterBottom:.12,tessellation:8},this.scene);o.position.y=.44;const s=xe.CreateCylinder(`${e}_cap`,{height:.06,diameter:.1,tessellation:8},this.scene);s.position.y=.56;const i=xe.CreateBox(`${e}_liquid`,{width:.28,height:.5,depth:.28},this.scene);i.position.y=-.1;const l=new Ne(`${e}_glass`,this.scene);l.albedoColor=new q(1,1,1),l.metallic=0,l.roughness=.05,l.alpha=.15,l.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,l.indexOfRefraction=1.5,l.reflectivityColor=new q(1,1,1),l.microSurface=.98;const h=new Ne(`${e}_liquid`,this.scene);h.albedoColor=n,h.metallic=0,h.roughness=.1,h.alpha=.7,h.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,h.subSurface.isTranslucencyEnabled=!0,h.subSurface.translucencyIntensity=.8;const u=new Ne(`${e}_cap_mat`,this.scene);u.albedoColor=new q(.15,.12,.08),u.metallic=.6,u.roughness=.4,r.material=l,o.material=l,s.material=u,i.material=h;const c=ot.MergeMeshes([r,o,s,i],!0,!0,void 0,!1,!0);return c.name=e,c.position=t,c.castShadow=!0,c}createTallBottle(e,t,n){const r=xe.CreateCylinder(`${e}_body`,{height:.85,diameter:.22,tessellation:8},this.scene);r.forceSharedVertices();const o=xe.CreateCylinder(`${e}_neck`,{height:.15,diameterTop:.06,diameterBottom:.11,tessellation:8},this.scene);o.position.y=.5,o.forceSharedVertices();const s=xe.CreateCylinder(`${e}_cap`,{height:.05,diameter:.08,tessellation:8},this.scene);s.position.y=.6,s.forceSharedVertices();const i=xe.CreateCylinder(`${e}_liquid`,{height:.72,diameter:.2,tessellation:8},this.scene);i.position.y=-.065,i.forceSharedVertices();const l=new Ne(`${e}_glass`,this.scene);l.albedoColor=new q(1,1,1),l.metallic=0,l.roughness=.02,l.alpha=.12,l.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,l.indexOfRefraction=1.52,l.reflectivityColor=new q(1,1,1),l.microSurface=.99;const h=new Ne(`${e}_liquid`,this.scene);h.albedoColor=n,h.metallic=0,h.roughness=.08,h.alpha=.75,h.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,h.subSurface.isTranslucencyEnabled=!0,h.subSurface.translucencyIntensity=.9;const u=new Ne(`${e}_cap_mat`,this.scene);u.albedoColor=new q(.9,.9,.92),u.metallic=.95,u.roughness=.2,r.material=l,o.material=l,s.material=u,i.material=h;const c=ot.MergeMeshes([r,o,s,i],!0,!0,void 0,!1,!0);return c.name=e,c.position=t,c.castShadow=!0,c}createRoundBottle(e,t,n){const r=xe.CreateCylinder(`${e}_body`,{height:.75,diameter:.28,tessellation:8},this.scene);r.forceSharedVertices();const o=xe.CreateCylinder(`${e}_shoulder`,{height:.12,diameterTop:.14,diameterBottom:.28,tessellation:8},this.scene);o.position.y=.435,o.forceSharedVertices();const s=xe.CreateCylinder(`${e}_neck`,{height:.14,diameterTop:.07,diameterBottom:.14,tessellation:8},this.scene);s.position.y=.565,s.forceSharedVertices();const i=xe.CreateCylinder(`${e}_cap`,{height:.06,diameter:.09,tessellation:8},this.scene);i.position.y=.67,i.forceSharedVertices();const l=xe.CreateCylinder(`${e}_liquid`,{height:.65,diameter:.26,tessellation:8},this.scene);l.position.y=-.05,l.forceSharedVertices();const h=new Ne(`${e}_glass`,this.scene);h.albedoColor=new q(1,1,1),h.metallic=0,h.roughness=.03,h.alpha=.1,h.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,h.indexOfRefraction=1.5,h.reflectivityColor=new q(1,1,1),h.microSurface=.98;const u=new Ne(`${e}_liquid`,this.scene);u.albedoColor=n,u.metallic=0,u.roughness=.05,u.alpha=.8,u.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,u.subSurface.isTranslucencyEnabled=!0,u.subSurface.translucencyIntensity=.85;const c=new Ne(`${e}_cap_mat`,this.scene);c.albedoColor=new q(.88,.88,.9),c.metallic=.9,c.roughness=.25,r.material=h,o.material=h,s.material=h,i.material=c,l.material=u;const d=ot.MergeMeshes([r,o,s,i,l],!0,!0,void 0,!1,!0);return d.name=e,d.position=t,d.castShadow=!0,d}createWideBottle(e,t,n){const r=xe.CreateCylinder(`${e}_body`,{height:.6,diameter:.35,tessellation:8},this.scene);r.forceSharedVertices();const o=xe.CreateCylinder(`${e}_shoulder`,{height:.15,diameterTop:.15,diameterBottom:.35,tessellation:8},this.scene);o.position.y=.375,o.forceSharedVertices();const s=xe.CreateCylinder(`${e}_neck`,{height:.12,diameterTop:.08,diameterBottom:.15,tessellation:8},this.scene);s.position.y=.51,s.forceSharedVertices();const i=xe.CreateCylinder(`${e}_cap`,{height:.05,diameter:.1,tessellation:8},this.scene);i.position.y=.6,i.forceSharedVertices();const l=xe.CreateCylinder(`${e}_liquid`,{height:.52,diameter:.33,tessellation:8},this.scene);l.position.y=-.04,l.forceSharedVertices();const h=new Ne(`${e}_glass`,this.scene);h.albedoColor=new q(.98,.96,.92),h.metallic=0,h.roughness=.04,h.alpha=.14,h.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,h.indexOfRefraction=1.5,h.reflectivityColor=new q(1,1,1),h.microSurface=.97;const u=new Ne(`${e}_liquid`,this.scene);u.albedoColor=n,u.metallic=0,u.roughness=.1,u.alpha=.8,u.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,u.subSurface.isTranslucencyEnabled=!0,u.subSurface.translucencyIntensity=.75;const c=new Ne(`${e}_cap_mat`,this.scene);c.albedoColor=new q(.3,.2,.1),c.metallic=0,c.roughness=.9,r.material=h,o.material=h,s.material=h,i.material=c,l.material=u;const d=ot.MergeMeshes([r,o,s,i,l],!0,!0,void 0,!1,!0);return d.name=e,d.position=t,d.castShadow=!0,d}createGlasses(){[{position:new K(-3,1.2,-3),style:"highball"},{position:new K(0,1.2,-3),style:"rocks"},{position:new K(3,1.2,-3),style:"coupe"}].forEach((t,n)=>{let r;switch(t.style){case"highball":r=this.createHighballGlass(`glass_${n}`,t.position);break;case"rocks":r=this.createRocksGlass(`glass_${n}`,t.position);break;case"coupe":r=this.createCoupeGlass(`glass_${n}`,t.position);break;default:r=this.createHighballGlass(`glass_${n}`,t.position)}this.glasses.push(r),this.interaction.registerInteractable(r,Ut.GLASS),this.physics.addCylinderBody(r,{mass:.3,restitution:.2,friction:.5}),this.cocktail.initContainer(r,300)})}createHighballGlass(e,t){const n=xe.CreateCylinder(`${e}_body`,{height:.55,diameterTop:.28,diameterBottom:.27,tessellation:8},this.scene),r=xe.CreateCylinder(`${e}_bottom`,{height:.05,diameter:.27,tessellation:8},this.scene);r.position.y=-.3;const o=new Ne(`${e}_glass`,this.scene);o.albedoColor=new q(1,1,1),o.metallic=0,o.roughness=.02,o.alpha=.08,o.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,o.indexOfRefraction=1.52,o.reflectivityColor=new q(1,1,1),o.microSurface=.99,n.material=o,r.material=o;const s=ot.MergeMeshes([n,r],!0,!0,void 0,!1,!0);return s.name=e,s.position=t,s.castShadow=!0,s}createRocksGlass(e,t){const n=xe.CreateCylinder(`${e}_body`,{height:.4,diameterTop:.32,diameterBottom:.28,tessellation:8},this.scene),r=xe.CreateCylinder(`${e}_bottom`,{height:.08,diameter:.28,tessellation:8},this.scene);r.position.y=-.24;const o=new Ne(`${e}_glass`,this.scene);o.albedoColor=new q(1,1,1),o.metallic=0,o.roughness=.01,o.alpha=.1,o.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,o.indexOfRefraction=1.5,o.reflectivityColor=new q(1,1,1),o.microSurface=.98,n.material=o,r.material=o;const s=ot.MergeMeshes([n,r],!0,!0,void 0,!1,!0);return s.name=e,s.position=t,s.castShadow=!0,s}createCoupeGlass(e,t){const n=xe.CreateCylinder(`${e}_bowl`,{height:.45,diameterTop:.28,diameterBottom:.27,tessellation:8},this.scene);n.position.y=.15;const r=xe.CreateCylinder(`${e}_stem`,{height:.25,diameter:.03,tessellation:8},this.scene);r.position.y=-.125;const o=xe.CreateCylinder(`${e}_base`,{height:.03,diameterTop:.08,diameterBottom:.12,tessellation:8},this.scene);o.position.y=-.265;const s=new Ne(`${e}_glass`,this.scene);s.albedoColor=new q(1,1,1),s.metallic=0,s.roughness=.015,s.alpha=.09,s.transparencyMode=Ne.PBRMATERIAL_ALPHABLEND,s.indexOfRefraction=1.52,s.reflectivityColor=new q(1,1,1),s.microSurface=.99,n.material=s,r.material=s,o.material=s;const i=ot.MergeMeshes([n,r,o],!0,!0,void 0,!1,!0);return i.name=e,i.position=t,i.castShadow=!0,i}async createBarTools(){const e=this.createCobblerShaker("shaker",new K(-5,1.2,-3));this.barTools.shaker=e,this.interaction.registerInteractable(e,Ut.SHAKER),this.physics.addCylinderBody(e,{mass:.6,restitution:.4,friction:.5}),this.cocktail.initContainer(e,500),console.log(" Created procedural Cobbler shaker");const t=this.createJigger("jigger",new K(5,1.2,-3));this.barTools.jigger=t,this.interaction.registerInteractable(t,Ut.JIGGER),this.physics.addCylinderBody(t,{mass:.2,restitution:.3,friction:.5}),console.log(" Created procedural jigger")}createCobblerShaker(e,t){const n=xe.CreateCylinder(`${e}_body`,{height:.6,diameterTop:.38,diameterBottom:.4,tessellation:8},this.scene),r=xe.CreateCylinder(`${e}_lid`,{height:.12,diameterTop:.36,diameterBottom:.38,tessellation:8},this.scene);r.position.y=.36;const o=xe.CreateCylinder(`${e}_cap`,{height:.08,diameterTop:.15,diameterBottom:.36,tessellation:8},this.scene);o.position.y=.46;const s=xe.CreateSphere(`${e}_knob`,{diameter:.08,segments:8},this.scene);s.position.y=.54,s.scaling.y=.7;const i=new Ne(`${e}_metal`,this.scene);i.albedoColor=new q(.88,.88,.9),i.metallic=1,i.roughness=.15,i.environmentIntensity=1.5,i.reflectivityColor=new q(.95,.95,.97),i.microSurface=.95,i.clearCoat.isEnabled=!0,i.clearCoat.intensity=.3,n.material=i,r.material=i,o.material=i,s.material=i;const l=ot.MergeMeshes([n,r,o,s],!0,!0,void 0,!1,!0);return l.name=e,l.position=t,l.castShadow=!0,l}createJigger(e,t){const n=xe.CreateCylinder(`${e}_large`,{height:.12,diameterTop:.2,diameterBottom:.08,tessellation:8},this.scene);n.position.y=.06;const r=xe.CreateCylinder(`${e}_small`,{height:.08,diameterTop:.15,diameterBottom:.08,tessellation:8},this.scene);r.position.y=-.04;const o=xe.CreateCylinder(`${e}_connector`,{height:.02,diameter:.08,tessellation:8},this.scene),s=new Ne(`${e}_metal`,this.scene);s.albedoColor=new q(.9,.9,.92),s.metallic=1,s.roughness=.18,s.environmentIntensity=1.4,s.reflectivityColor=new q(.95,.95,.97),s.microSurface=.93,n.material=s,r.material=s,o.material=s;const i=ot.MergeMeshes([n,r,o],!0,!0,void 0,!1,!0);return i.name=e,i.position=t,i.castShadow=!0,i}createFurniture(){const e=[new K(0,0,3)],t=new Bt("tableMat",this.scene);t.diffuseColor=new q(.3,.2,.1),t.specularColor=new q(.1,.1,.1),e.forEach((o,s)=>{const i=xe.CreateCylinder(`tableTop_${s}`,{height:.1,diameter:1.2,tessellation:6},this.scene);i.position=new K(o.x,.75,o.z),i.material=t,i.receiveShadows=!0,i.checkCollisions=!0,this.physics.addStaticBoxCollider(i);const l=xe.CreateCylinder(`tableLeg_${s}`,{height:.7,diameter:.1,tessellation:6},this.scene);l.position=new K(o.x,.35,o.z),l.material=t,l.castShadow=!0});const n=[new K(-2,0,-1),new K(2,0,-1)],r=new Bt("stoolMat",this.scene);r.diffuseColor=new q(.2,.15,.1),r.specularColor=new q(.15,.15,.15),n.forEach((o,s)=>{const i=xe.CreateCylinder(`stoolSeat_${s}`,{height:.08,diameter:.4,tessellation:6},this.scene);i.position=new K(o.x,.65,o.z),i.material=r,i.receiveShadows=!0;const l=xe.CreateCylinder(`stoolLeg_${s}`,{height:.6,diameter:.06,tessellation:6},this.scene);l.position=new K(o.x,.3,o.z),l.material=r,l.castShadow=!0}),this.createTestBottleOnTable()}createTestBottleOnTable(){const n=xe.CreateCylinder("testBottle",{height:.25,diameterTop:.1,diameterBottom:.1,tessellation:12},this.scene);n.position=new K(0,.75+.05+.25/2,3);const r=new Ne("testBottleGlass",this.scene);r.metallic=0,r.roughness=.05,r.alpha=.15,r.indexOfRefraction=1.5,r.subSurface.isTranslucencyEnabled=!0,r.subSurface.translucencyIntensity=.8,n.material=r;const o=xe.CreateCylinder("testBottleLiquid",{height:.25*.7,diameter:.05*1.8,tessellation:12},this.scene);o.parent=n,o.position.y=-.25*.15;const s=new Ne("testLiquidMat",this.scene);s.albedoColor=new q(.95,.95,.95),s.metallic=0,s.roughness=.1,s.alpha=.5,s.subSurface.isTranslucencyEnabled=!0,s.subSurface.translucencyIntensity=.9,o.material=s,n.castShadow=!0,this.physics.addCylinderBody(n,{mass:.3,restitution:.3,friction:.6}),this.interaction.registerInteractable(n,"bottle","vodka",void 0),console.log("  (: 0, 0.8, 3)")}getBottles(){return this.bottles}getGlasses(){return this.glasses}getBarTools(){return this.barTools}}class Xa{scene;loadedModels=new Map;constructor(e){this.scene=e}async loadModel(e){try{const t=e.modelPath.split(".").pop()?.toLowerCase();console.log(`Loading ${t?.toUpperCase()} model: ${e.name} from ${e.modelPath}`);const n=await Promise.race([si.ImportMeshAsync("","",e.modelPath,this.scene),new Promise((o,s)=>setTimeout(()=>s(new Error("Model loading timeout")),1e4))]);if(n.meshes.length===0)throw new Error(`No meshes found in ${e.modelPath}`);const r=n.meshes[0];return r.name=e.name,e.position&&(r.position=e.position),e.rotation&&(r.rotation=e.rotation),e.scale?r.scaling=e.scale:r.scaling=new K(1,1,1),n.meshes.forEach(o=>{o instanceof ot&&(o.receiveShadows=!0,o.isPickable=!1,o.checkCollisions=!1)}),r instanceof ot&&(r.isPickable=!1,r.checkCollisions=!1),this.loadedModels.set(e.name,n.meshes),console.log(` Model loaded: ${e.name} (${n.meshes.length} meshes)`),r}catch(t){return console.error(`Failed to load model ${e.name}:`,t),console.warn(`Using fallback mesh for ${e.name}`),this.createFallbackMesh(e.name,e.position)}}async loadFBXModel(e){return this.loadModel(e)}applyTexture(e,t){const n=new qe(t,this.scene);e.forEach(r=>{if(r instanceof ot){const o=new Ne(`${r.name}_mat`,this.scene);o.albedoTexture=n,o.metallic=.2,o.roughness=.3,o.backFaceCulling=!1,r.material=o}})}createFallbackMesh(e,t){console.warn(`Creating fallback mesh for ${e}`);const n=xe.CreateCylinder(e,{height:.8,diameter:.3},this.scene);t&&(n.position=t);const r=new Bt(`${e}_fallback_mat`,this.scene);return r.diffuseColor=new q(.8,.8,.8),n.material=r,n}async loadMultipleModels(e){const t=e.map(n=>this.loadFBXModel(n));return Promise.all(t)}getLoadedModel(e){return this.loadedModels.get(e)}dispose(){this.loadedModels.forEach(e=>{e.forEach(t=>t.dispose())}),this.loadedModels.clear()}}class Qa{scene;npcs=[];modelLoader;constructor(e){this.scene=e,this.modelLoader=new Xa(e),this.createNPCs()}async createNPCs(){await this.addNPC({name:"Gustave",position:new K(8,0,-5),shirtColor:26316,pantsColor:1710618,role:"",gender:"male",useGLBModel:!1,dialogues:[" Gustave YangNCU ","","","",""]}),await this.addNPC({name:"Seaton",position:new K(-8,0,-5),shirtColor:13369446,pantsColor:3355443,role:"",gender:"male",useGLBModel:!1,dialogues:[" Seaton ","12",""," Old Fashioned",""]})}async addNPC(e){let t;if(e.useGLBModel)try{t=await this.modelLoader.loadModel({name:`npc_${e.name}`,modelPath:"/materials/person_0.glb",position:e.position,rotation:e.rotation?new K(0,e.rotation,0):void 0,scale:new K(1,1,1)});const r=this.createNameTag(e.name,e.role);r.parent=t,console.log(` Loaded GLB NPC model: ${e.name}`)}catch(n){console.error(`Failed to load NPC GLB model for ${e.name}, using fallback:`,n),t=this.createGeometricNPC(e)}else t=this.createGeometricNPC(e);t.userData={name:e.name,role:e.role,dialogues:e.dialogues,currentDialogue:0,originalY:e.position.y,baseRotation:e.rotation||0},this.npcs.push(t)}createGeometricNPC(e){const t=new ot(`npc_${e.name}`,this.scene),n=e.gender==="female",r=this.createBody(e.shirtColor,n),o=this.createPants(e.pantsColor,n),s=this.createHead(),i=this.createHair(n),l=this.createArm(!0,n),h=this.createArm(!1,n),u=this.createLeg(!0),c=this.createLeg(!1),d=this.createFace();r.parent=t,o.parent=t,s.parent=t,i.parent=t,l.parent=t,h.parent=t,u.parent=t,c.parent=t,d.parent=t;const p=this.createNameTag(e.name,e.role);return p.parent=t,t.position=e.position,e.rotation!==void 0&&(t.rotation.y=e.rotation),t}createBody(e,t){const n=t?.35:.4,r=xe.CreateCylinder("body",{height:.9,diameterTop:n*2,diameterBottom:(n+.05)*2,tessellation:12},this.scene);r.position.y=1.2;const o=new Bt("bodyMat",this.scene);return o.diffuseColor=q.FromHexString("#"+e.toString(16).padStart(6,"0")),o.specularColor=new q(.1,.1,.1),r.material=o,r.castShadow=!0,r}createPants(e,t){const n=xe.CreateCylinder("pants",{height:1,diameter:.7,tessellation:12},this.scene);n.position.y=.2;const r=new Bt("pantsMat",this.scene);return r.diffuseColor=q.FromHexString("#"+e.toString(16).padStart(6,"0")),r.specularColor=new q(.05,.05,.05),n.material=r,n.castShadow=!0,n}createHead(){const e=xe.CreateSphere("head",{diameter:.7,segments:12},this.scene);e.position.y=2.1;const t=new Bt("headMat",this.scene);return t.diffuseColor=q.FromHexString("#fdbcb4"),t.specularColor=new q(.1,.1,.1),e.material=t,e.castShadow=!0,e}createHair(e){const t=xe.CreateSphere("hair",{diameter:.76,segments:16,slice:e?.4:.35},this.scene);t.position.y=2.1;const n=new Ne("hairMat",this.scene);return n.albedoColor=new q(.2,.15,.1),n.metallic=.05,n.roughness=.7,t.material=n,t.castShadow=!0,t}createArm(e,t){const n=t?.5:.55,r=xe.CreateCylinder(e?"leftArm":"rightArm",{height:.8,diameter:.24,tessellation:12},this.scene);r.position.set(e?-n:n,1.2,0);const o=new Ne("armMat",this.scene);return o.albedoColor=q.FromHexString("#fdbcb4"),o.metallic=0,o.roughness=.9,r.material=o,r.castShadow=!0,r}createLeg(e){const t=xe.CreateCylinder(e?"leftLeg":"rightLeg",{height:1,diameter:.3,tessellation:16},this.scene);t.position.set(e?-.18:.18,-.3,0);const n=new Ne("legMat",this.scene);return n.albedoColor=new q(.1,.1,.1),n.metallic=.1,n.roughness=.8,t.material=n,t.castShadow=!0,t}createFace(){const e=new Pn("face",this.scene);e.position.y=2.1;const t=xe.CreateSphere("leftEye",{diameter:.1,segments:8},this.scene);t.position.set(-.12,.05,.33);const n=new Bt("eyeMat",this.scene);n.diffuseColor=new q(0,0,0),t.material=n,t.parent=e;const r=xe.CreateSphere("rightEye",{diameter:.1,segments:8},this.scene);r.position.set(.12,.05,.33),r.material=n,r.parent=e;const o=xe.CreateTorus("mouth",{diameter:.24,thickness:.02,tessellation:16},this.scene);return o.rotation.x=Math.PI,o.position.set(0,-.1,.32),o.material=n,o.parent=e,e}createNameTag(e,t){const n=new Pn("nameTag",this.scene);n.position.y=2.8;const r=xe.CreatePlane("nameTagPlane",{width:2,height:1},this.scene);r.parent=n,r.billboardMode=ot.BILLBOARDMODE_ALL;const o=new Bt("nameTagMat",this.scene);return o.diffuseColor=new q(.1,.1,.1),o.alpha=.7,o.backFaceCulling=!1,r.material=o,console.log(` NPC${e} (${t}) - Canvas`),n}checkInteractions(e){let n=null,r=1/0;for(const s of this.npcs){const i=K.Distance(e,s.position);i<2.5&&i<r&&(r=i,n=s)}const o=document.getElementById("interaction-hint");if(o)if(n){const s=n.userData;o.textContent=` E  ${s.name} `,o.style.display="block"}else o.style.display="none";return n}interact(e){if(!e)return;const t=e.userData,n=document.getElementById("dialogue-box"),r=document.getElementById("character-name"),o=document.getElementById("dialogue-text");!n||!r||!o||(r.textContent=`${t.name} - ${t.role}`,o.textContent=t.dialogues[t.currentDialogue],n.classList.remove("active"),n.offsetHeight,n.classList.add("active"),t.currentDialogue=(t.currentDialogue+1)%t.dialogues.length,setTimeout(()=>{n.classList.remove("active")},4e3))}update(e){const t=Date.now()*.001;this.npcs.forEach((n,r)=>{const o=n.userData,s=Math.sin(t+r)*.02;n.position.y=o.originalY+s;const i=Math.sin(t*.8+r*2)*.05;n.rotation.y=o.baseRotation+i})}getNPCs(){return this.npcs}getNPCByName(e){return this.npcs.find(t=>t.userData.name===e)}}class Ja{canvas;engine;scene;camera;physicsSystem;interactionSystem;cocktailSystem;playerController;lightingSystem;barEnvironment;npcManager;isPaused=!1;isRecipeMenuOpen=!1;lastInteraction=!1;lastPickup=!1;lastDrop=!1;lastReturn=!1;lastRightMouse=!1;lastRecipeToggle=!1;constructor(){this.canvas=document.getElementById("renderCanvas"),this.engine=new oi(this.canvas,!0,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0}),this.scene=this.createScene(),this.camera=this.scene.activeCamera,this.initialize(),this.engine.runRenderLoop(()=>{this.update(),this.scene.render()}),window.addEventListener("resize",()=>{this.engine.resize()})}createScene(){const e=new er(this.engine);e.clearColor=new Xt(.08,.06,.05,1),e.collisionsEnabled=!0,e.gravity=new K(0,-9.81,0);const t=new ri("camera",new K(0,1.7,-5),e);return t.setTarget(K.Zero()),t.fov=1.2654,e.activeCamera=t,e}async initialize(){try{this.showLoadingScreen(),this.updateLoadingProgress(0,"..."),this.updateLoadingProgress(10,"..."),this.physicsSystem=new Ua(this.scene),this.physicsSystem.initialize(),this.updateLoadingProgress(30," "),this.updateLoadingProgress(40,"..."),this.interactionSystem=new Wa(this.camera,this.scene,this.physicsSystem),this.updateLoadingProgress(50," "),this.updateLoadingProgress(55,"..."),this.cocktailSystem=new qa(this.scene,this.interactionSystem),this.interactionSystem.setCocktailSystem(this.cocktailSystem),this.updateLoadingProgress(60," "),this.updateLoadingProgress(65,"..."),this.playerController=new Ka(this.camera,this.scene,this.canvas),this.updateLoadingProgress(70," "),this.updateLoadingProgress(75,"..."),this.lightingSystem=new ja(this.scene),this.updateLoadingProgress(80," "),this.updateLoadingProgress(85,"..."),this.barEnvironment=new Ya(this.scene,this.physicsSystem,this.interactionSystem,this.cocktailSystem),await this.barEnvironment.createEnvironment(),this.updateLoadingProgress(92," FBX"),this.updateLoadingProgress(95," NPC..."),this.npcManager=new Qa(this.scene),this.updateLoadingProgress(97," NPC "),this.updateLoadingProgress(99," UI..."),this.setupUIControls(),this.updateLoadingProgress(100," "),await new Promise(e=>setTimeout(e,500)),this.hideLoadingScreen(),console.log(" Bar Simulator initialized successfully!")}catch(e){console.error(" Failed to initialize:",e),this.updateLoadingProgress(0," "),alert(`
: `+e)}}update(){const e=this.engine.getDeltaTime()/1e3;if(this.isPaused){this.npcManager?.update(e);return}this.playerController?.update(e),this.interactionSystem?.update(),this.cocktailSystem?.update(e),this.npcManager?.update(e),this.handleInput(),this.updateFPS()}handleInput(){const e=this.playerController.isKeyPressed("KeyE");if(e&&!this.lastPickup){const s=this.interactionSystem.getTargetedObject();s&&s.userData.type==="npc"?this.npcManager.interact():this.interactionSystem.pickupItem()}this.lastPickup=e;const t=this.playerController.isKeyPressed("KeyQ");t&&!this.lastDrop&&this.interactionSystem.dropItem(),this.lastDrop=t;const n=this.playerController.isKeyPressed("KeyR");n&&!this.lastReturn&&this.interactionSystem.returnItem(),this.lastReturn=n;const r=this.scene.pointerX!==0;this.handlePouring(r);const o=this.playerController.isKeyPressed("KeyM");o&&!this.lastRecipeToggle&&this.toggleRecipeMenu(),this.lastRecipeToggle=o}handlePouring(e){const t=this.interactionSystem.getHeldObject();if(!t||!e){this.cocktailSystem.stopPouring();return}const n=this.engine.getDeltaTime()/1e3,r=this.findNearbyContainer();if(r){const o=t.userData.type,s=t.userData.liquorType;o==="bottle"&&s?this.cocktailSystem.pour(t,r,s,n,this.camera):o==="shaker"&&this.cocktailSystem.pourFromShaker(t,r,n)}else t.userData.type==="shaker"&&this.cocktailSystem.shake(t)}findNearbyContainer(){if(!this.interactionSystem.getHeldObject())return null;const t=this.camera.getForwardRay(2.5),n=this.scene.pickWithRay(t);if(n&&n.hit&&n.pickedMesh){const r=n.pickedMesh,o=r.userData?.type;if(o==="glass"||o==="shaker"||o==="mixing_glass")return r}return null}setupUIControls(){document.getElementById("recipe-menu");const e=document.getElementById("close-recipe-menu");e&&e.addEventListener("click",()=>{this.toggleRecipeMenu()}),this.loadRecipes()}loadRecipes(){const e=document.getElementById("recipe-list");if(!e)return;const t=this.cocktailSystem.getCocktailRecipes();e.innerHTML=t.map(n=>`
            <div class="recipe-item">
                <h3>${n.name} <span class="recipe-name-cn">${n.nameChinese}</span></h3>
                <div class="recipe-ingredients">
                    ${n.ingredients.map(r=>`<div> ${r.amount}ml ${r.name}</div>`).join("")}
                </div>
                <div class="recipe-method">
                    <strong></strong>${n.method}
                </div>
                <div class="recipe-glass">
                    <strong></strong>${n.glass}
                </div>
                ${n.garnish?`<div class="recipe-garnish"><strong></strong>${n.garnish}</div>`:""}
            </div>
        `).join("")}toggleRecipeMenu(){const e=document.getElementById("recipe-menu");e&&(this.isRecipeMenuOpen=!this.isRecipeMenuOpen,this.isPaused=this.isRecipeMenuOpen,e.style.display=this.isRecipeMenuOpen?"block":"none")}updateFPS(){const e=document.getElementById("fps");e&&(e.textContent=Math.round(this.engine.getFps()).toString())}showLoadingScreen(){const e=document.getElementById("loading");e&&(e.style.display="flex")}updateLoadingProgress(e,t){const n=document.getElementById("loading-text"),r=document.getElementById("loading-percentage"),o=document.getElementById("loading-progress-bar");n&&(n.textContent=t),r&&(r.textContent=`${e}%`),o&&(o.style.width=`${e}%`),console.log(`[${e}%] ${t}`)}hideLoadingScreen(){const e=document.getElementById("loading");e&&(e.style.display="none")}}window.addEventListener("DOMContentLoaded",()=>{new Ja});
