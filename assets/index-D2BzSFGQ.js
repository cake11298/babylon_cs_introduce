const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pbrMaterialLoadingAdapter-D40ruAWD.js","assets/babylon--_blpBQ1.js","assets/flowGraphGLTFDataProvider-BwqHMMIL.js"])))=>i.map(i=>d[i]);
var Mr=Object.defineProperty;var Pr=(i,e,t)=>e in i?Mr(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var fe=(i,e,t)=>Pr(i,typeof e!="symbol"?e+"":e,t);import{S as Ls,A as ve,V as Q,M as rt,T as ke,Q as it,B as Fn,R as Un,a as Wn,O as wt,L as Me,D as qn,b as jo,c as Ir,E as Br,d as Sr,e as Cn,f as We,g as xn,h as Yo,C as Xt,i as Xo,j as Bt,k as ie,l as Ft,m as un,H as Zs,n as ks,P as Js,o as zt,F as qs,p as Qo,q as xt,r as Zn,s as Nr,G as Jn,t as Or,u as Ie,_ as An,v as Nn,w as Rr,x as Fr,y as Lr,z as Zo,I as kr,J as Ln,K as Vr,N as Dr,U as Gr,W as $r,X as Ot,Y as Hr,Z as zr,$ as Ur,a0 as Wr,a1 as qr,a2 as eo,a3 as Po,a4 as Io,a5 as ct,a6 as Kr,a7 as jr,a8 as Yr,a9 as Xr,aa as Qr,ab as $s,ac as Zr,ad as Jr,ae as ei,af as kn,ag as Kn,ah as ti,ai as ni,aj as In,ak as si,al as Bn,am as Ye,an as Bo,ao as So,ap as Jo,aq as oi,ar as ri,as as ii}from"./babylon--_blpBQ1.js";function ai(i,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const r in n)if(r!=="default"&&!(r in i)){const o=Object.getOwnPropertyDescriptor(n,r);o&&Object.defineProperty(i,r,o.get?o:{enumerable:!0,get:()=>n[r]})}}}return Object.freeze(Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const er="Xposition",tr="Yposition",nr="Zposition",sr="Xrotation",or="Yrotation",rr="Zrotation",li="HIERARCHY",ci="MOTION";class ui{constructor(e){this.loopMode=ve.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=ir(),this.numFrames=0,this.frameRate=0,this.skeleton=e}}function ir(){return{name:"",type:"",offset:new Q,channels:[],children:[],frames:[],parent:null}}function hi(){return{frame:0,position:new Q,rotation:new it}}function di(i){const e=i.offset.x,t=i.offset.y,n=i.offset.z;return rt.Translation(e,t,n)}function pi(i,e){if(i.frames.length===0)return[];const t=[],n=i.channels.some(h=>h===er||h===tr||h===nr),r=i.channels.some(h=>h===sr||h===or||h===rr),o=new ve(`${i.name}_pos`,"position",e.frameRate,ve.ANIMATIONTYPE_VECTOR3,e.loopMode),s=new ve(`${i.name}_rot`,"rotationQuaternion",e.frameRate,ve.ANIMATIONTYPE_QUATERNION,e.loopMode),a=[],l=[];for(let h=0;h<i.frames.length;h++){const u=i.frames[h];n&&u.position&&a.push({frame:u.frame,value:u.position.clone()}),r&&l.push({frame:u.frame,value:u.rotation.clone()})}return a.length>0&&(o.setKeys(a),t.push(o)),l.length>0&&(s.setKeys(l),t.push(s)),t}function ar(i,e,t){const n=di(i),r=new Fn(i.name,t.skeleton,e,n),o=pi(i,t);for(const s of o)s.getKeys()&&s.getKeys().length>0&&r.animations.push(s);for(const s of i.children)ar(s,r,t)}function lr(i,e,t,n){if(t.type==="ENDSITE")return;const r=hi();r.frame=e,r.position=new Q,r.rotation=new it,t.frames.push(r);let o=rt.Identity();for(let s=0;s<t.channels.length;++s){const a=t.channels[s],l=i[n.i++];if(!l)continue;const h=parseFloat(l.trim());if(a.endsWith("position"))switch(a){case er:r.position.x=h;break;case tr:r.position.y=h;break;case nr:r.position.z=h;break}else if(a.endsWith("rotation")){const u=ke.ToRadians(h);let c;switch(a){case sr:c=rt.RotationX(u);break;case or:c=rt.RotationY(u);break;case rr:c=rt.RotationZ(u);break}o=c.multiply(o)}}it.FromRotationMatrixToRef(o,r.rotation);for(const s of t.children)lr(i,e,s,n)}function cr(i,e,t,n){var l,h,u,c;const r=ir();r.parent=t,n.list.push(r);let o=e.trim().split(/\s+/);if(o[0].toUpperCase()==="END"&&o[1].toUpperCase()==="SITE"?(r.type="ENDSITE",r.name="ENDSITE"):(r.name=o[1],r.type=o[0].toUpperCase()),((l=i.shift())==null?void 0:l.trim())!="{")throw new Error("Expected opening { after type & name");const s=(h=i.shift())==null?void 0:h.trim().split(/\s+/);if(!s)throw new Error("Unexpected end of file: missing OFFSET");if(o=s,o[0].toUpperCase()!="OFFSET")throw new Error("Expected OFFSET, but got: "+o[0]);if(o.length!=4)throw new Error("OFFSET: Invalid number of values");const a=new Q(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]));if(isNaN(a.x)||isNaN(a.y)||isNaN(a.z))throw new Error("OFFSET: Invalid values");if(r.offset=a,r.type!="ENDSITE"){if(o=(u=i.shift())==null?void 0:u.trim().split(/\s+/),!o)throw new Error("Unexpected end of file: missing CHANNELS");if(o[0].toUpperCase()!="CHANNELS")throw new Error("Expected CHANNELS definition");const d=parseInt(o[1]);r.channels=o.splice(2,d),r.children=[]}for(;i.length>0;){const d=(c=i.shift())==null?void 0:c.trim();if(d==="}")return r;d&&r.children.push(cr(i,d,r,n))}throw new Error("Unexpected end of file: missing closing brace")}function No(i,e,t,n){const r=i.split(`
`),{loopMode:o}=n;e._blockEntityCollection=!!t;const s=new Ls("","",e);s._parentContainer=t,e._blockEntityCollection=!1;const a=new ui(s);a.loopMode=o;const l=r.shift();if(!l||l.trim().toUpperCase()!==li)throw new Error("HIERARCHY expected");const h=r.shift();if(!h)throw new Error("Unexpected end of file after HIERARCHY");const u=cr(r,h.trim(),null,a),c=r.shift();if(!c||c.trim().toUpperCase()!==ci)throw new Error("MOTION expected");const d=r.shift();if(!d)throw new Error("Unexpected end of file before frame count");const p=d.trim().split(/[\s]+/);if(p.length<2)throw new Error("Invalid frame count line");const f=parseInt(p[1]);if(isNaN(f))throw new Error("Failed to read number of frames.");a.numFrames=f;const g=r.shift();if(!g)throw new Error("Unexpected end of file before frame time");const y=g.trim().split(/[\s]+/);if(y.length<3)throw new Error("Invalid frame time line");const m=parseFloat(y[2]);if(isNaN(m))throw new Error("Failed to read frame time.");if(m<=0)throw new Error("Failed to read frame time. Invalid value "+m);a.frameRate=1/m;for(let _=0;_<f;++_){const b=r.shift();if(!b)continue;const v=b.trim().split(/[\s]+/)||[];lr(v,_,u,{i:0})}return a.root=u,ar(a.root,null,a),a.skeleton.returnToRest(),a.skeleton}const Hs={name:"bvh",extensions:{".bvh":{isBinary:!1}}};class es{constructor(e){this.name=Hs.name,this.extensions=Hs.extensions,this._loadingOptions={...es._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{loopMode:ve.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new es(e[Hs.name])}canDirectLoad(e){return this.isBvhHeader(e)}isBvhHeader(e){return e.split(`
`)[0]=="HIERARCHY"}isNotBvhHeader(e){return!this.isBvhHeader(e)}importMeshAsync(e,t,n){if(typeof n!="string")return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(n))return Promise.reject("BVH loader expects HIERARCHY header.");try{const r=No(n,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[r],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(r){return Promise.reject(r)}}loadAsync(e,t){return typeof t!="string"?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then(()=>{})}loadAssetContainerAsync(e,t){if(typeof t!="string")return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");const n=new Wn(e);try{const r=No(t,e,n,this._loadingOptions);return n.skeletons.push(r),Promise.resolve(n)}catch(r){return Promise.reject(r)}}}Un(new es);function Ks(i,e,t,n){const r={externalResourceFunction:n};return t&&(r.uri=e==="file:"?t:e+t),ArrayBuffer.isView(i)?GLTFValidator.validateBytes(i,r):GLTFValidator.validateString(i,r)}function fi(){const i=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{Ks(t.data,t.rootUrl,t.fileName,n=>new Promise((r,o)=>{const s=i.length;i.push({resolve:r,reject:o}),postMessage({id:"getExternalResource",index:s,uri:n})})).then(n=>{postMessage({id:"validate.resolve",value:n})},n=>{postMessage({id:"validate.reject",reason:n})});break}case"getExternalResource.resolve":{i[t.index].resolve(t.value);break}case"getExternalResource.reject":{i[t.index].reject(t.reason);break}}}}class ur{static ValidateAsync(e,t,n,r){return typeof Worker=="function"?new Promise((o,s)=>{const a=`${Ks}(${fi})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),h=new Worker(l),u=d=>{h.removeEventListener("error",u),h.removeEventListener("message",c),s(d)},c=d=>{const p=d.data;switch(p.id){case"getExternalResource":{r(p.uri).then(f=>{h.postMessage({id:"getExternalResource.resolve",index:p.index,value:f},[f.buffer])},f=>{h.postMessage({id:"getExternalResource.reject",index:p.index,reason:f})});break}case"validate.resolve":{h.removeEventListener("error",u),h.removeEventListener("message",c),o(p.value),h.terminate();break}case"validate.reject":h.removeEventListener("error",u),h.removeEventListener("message",c),s(p.reason),h.terminate()}};if(h.addEventListener("error",u),h.addEventListener("message",c),h.postMessage({id:"init",url:ke.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const d=e.slice();h.postMessage({id:"validate",data:d,rootUrl:t,fileName:n},[d.buffer])}else h.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})}):(this._LoadScriptPromise||(this._LoadScriptPromise=ke.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>Ks(e,t,n,r)))}}ur.Configuration={url:`${ke._DefaultCdnUrl}/gltf_validator.js`};const pn="Z2xURg",jn={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(i){return i.indexOf("asset")!==-1&&i.indexOf("version")!==-1||i.startsWith("data:base64,"+pn)||i.startsWith("data:;base64,"+pn)||i.startsWith("data:application/octet-stream;base64,"+pn)||i.startsWith("data:model/gltf-binary;base64,"+pn)}};function Oo(i,e,t){try{return Promise.resolve(new Uint8Array(i,e,t))}catch(n){return Promise.reject(n)}}function mi(i,e,t){try{if(e<0||e>=i.byteLength)throw new RangeError("Offset is out of range.");if(e+t>i.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(i.buffer,i.byteOffset+e,t))}catch(n){return Promise.reject(n)}}var Gn;(function(i){i[i.AUTO=0]="AUTO",i[i.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(Gn||(Gn={}));var Sn;(function(i){i[i.NONE=0]="NONE",i[i.FIRST=1]="FIRST",i[i.ALL=2]="ALL"})(Sn||(Sn={}));var It;(function(i){i[i.LOADING=0]="LOADING",i[i.READY=1]="READY",i[i.COMPLETE=2]="COMPLETE"})(It||(It={}));class hr{constructor(){this.alwaysComputeBoundingBox=!1,this.alwaysComputeSkeletonRootNode=!1,this.animationStartMode=Sn.FIRST,this.compileMaterials=!1,this.compileShadowGenerators=!1,this.coordinateSystemMode=Gn.AUTO,this.createInstances=!0,this.loadAllMaterials=!1,this.loadMorphTargets=!0,this.loadNodeAnimations=!0,this.loadOnlyMaterials=!1,this.loadSkins=!0,this.skipMaterials=!1,this.targetFps=60,this.transparencyAsCoverage=!1,this.useClipPlane=!1,this.useGltfTextureNames=!1,this.useRangeRequests=!1,this.useSRGBBuffers=!0,this.validate=!1,this.useOpenPBR=!1}}const yi=new hr;class gi extends hr{constructor(){super(...arguments),this.extensionOptions={},this.preprocessUrlAsync=e=>Promise.resolve(e)}copyFrom(e){e&&(this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.capturePerformanceCounters=e.capturePerformanceCounters??this.capturePerformanceCounters,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.createInstances=e.createInstances??this.createInstances,this.customRootNode=e.customRootNode,this.extensionOptions=e.extensionOptions??this.extensionOptions,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.loadSkins=e.loadSkins??this.loadSkins,this.loggingEnabled=e.loggingEnabled??this.loggingEnabled,this.onCameraLoaded=e.onCameraLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onMeshLoaded=e.onMeshLoaded,this.onParsed=e.onParsed,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onValidated=e.onValidated,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.targetFps=e.targetFps??this.targetFps,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.useOpenPBR=e.useOpenPBR??this.useOpenPBR,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.validate=e.validate??this.validate)}}class pt extends gi{constructor(e){super(),this.onParsedObservable=new wt,this.onMeshLoadedObservable=new wt,this.onSkinLoadedObservable=new wt,this.onTextureLoadedObservable=new wt,this.onMaterialLoadedObservable=new wt,this.onCameraLoadedObservable=new wt,this.onCompleteObservable=new wt,this.onErrorObservable=new wt,this.onDisposeObservable=new wt,this.onExtensionLoadedObservable=new wt,this.onValidatedObservable=new wt,this._loader=null,this._state=null,this._requests=new Array,this.name=jn.name,this.extensions=jn.extensions,this.onLoaderStateChangedObservable=new wt,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(Object.assign({...yi},e))}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,n,r,o,s,a,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,n,r,a,l),null;this._progressCallback=o;const h=t.name||ke.GetFilename(t);if(s){if(this.useRangeRequests){this.validate&&Me.Warn("glTF validation is not supported when range requests are enabled");const u={abort:()=>{},onCompleteObservable:new wt},c={readAsync:(d,p)=>new Promise((f,g)=>{this._loadFile(e,t,y=>{f(new Uint8Array(y))},!0,y=>{g(y)},y=>{y.setRequestHeader("Range",`bytes=${d}-${d+p-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new qn(c)).then(d=>{u.onCompleteObservable.notifyObservers(u),r(d)},a?d=>a(void 0,d):void 0),u}return this._loadFile(e,t,u=>{this._validate(e,new Uint8Array(u,0,u.byteLength),n,h),this._unpackBinaryAsync(new qn({readAsync:(c,d)=>Oo(u,c,d),byteLength:u.byteLength})).then(c=>{r(c)},a?c=>a(void 0,c):void 0)},!0,a)}else return this._loadFile(e,t,u=>{try{this._validate(e,u,n,h),r({json:this._parseJson(u)})}catch{a&&a()}},!1,a)}_loadBinary(e,t,n,r,o,s){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n,s),this._unpackBinaryAsync(new qn({readAsync:(a,l)=>mi(t,a,l),byteLength:t.byteLength})).then(a=>{r(a)},o?a=>o(void 0,a):void 0)}importMeshAsync(e,t,n,r,o,s){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${s||""}`),this._loader=this._getLoader(n),this._loader.importMeshAsync(e,t,null,n,r,o,s)))}loadAsync(e,t,n,r,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,n,r,o)))}loadAssetContainerAsync(e,t,n,r,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t);const s=new Wn(e),a=[];this.onMaterialLoadedObservable.add(c=>{a.push(c)});const l=[];this.onTextureLoadedObservable.add(c=>{l.push(c)});const h=[];this.onCameraLoadedObservable.add(c=>{h.push(c)});const u=[];return this.onMeshLoadedObservable.add(c=>{c.morphTargetManager&&u.push(c.morphTargetManager)}),this._loader.importMeshAsync(null,e,s,t,n,r,o).then(c=>(Array.prototype.push.apply(s.geometries,c.geometries),Array.prototype.push.apply(s.meshes,c.meshes),Array.prototype.push.apply(s.particleSystems,c.particleSystems),Array.prototype.push.apply(s.skeletons,c.skeletons),Array.prototype.push.apply(s.animationGroups,c.animationGroups),Array.prototype.push.apply(s.materials,a),Array.prototype.push.apply(s.textures,l),Array.prototype.push.apply(s.lights,c.lights),Array.prototype.push.apply(s.transformNodes,c.transformNodes),Array.prototype.push.apply(s.cameras,h),Array.prototype.push.apply(s.morphTargetManagers,u),s))})}canDirectLoad(e){return jn.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+pn)||t.startsWith(";base64,"+pn)||t.startsWith("application/octet-stream;base64,"+pn)||t.startsWith("model/gltf-binary;base64,"+pn)){const n=jo(t);return this._validate(e,new Uint8Array(n,0,n.byteLength)),this._unpackBinaryAsync(new qn({readAsync:(r,o)=>Oo(n,r,o),byteLength:n.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new pt(e[jn.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(n=>{t(n)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(It[this._state]))}_loadFile(e,t,n,r,o,s){const a=e._loadFile(t,n,l=>{this._onProgress(l,a)},!0,r,o,s);return a.onCompleteObservable.add(()=>{a._lengthComputable=!0,a._total=a._loaded}),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let n=!0,r=0,o=0;for(const s of this._requests){if(s._lengthComputable===void 0||s._loaded===void 0||s._total===void 0)return;n=n&&s._lengthComputable,r+=s._loaded,o+=s._total}this._progressCallback({lengthComputable:n,loaded:r,total:n?o:0})}_validate(e,t,n="",r=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),ur.ValidateAsync(t,n,r,o=>this.preprocessUrlAsync(n+o).then(s=>e._loadFileAsync(s,void 0,!0,!0).then(a=>new Uint8Array(a,0,a.byteLength)))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),ke.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const n=pt._parseVersion(t.version);if(!n)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const s=pt._parseVersion(t.minVersion);if(!s)throw new Error("Invalid minimum version: "+t.minVersion);if(pt._compareVersion(s,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const o={1:pt._CreateGLTF1Loader,2:pt._CreateGLTF2Loader}[n.major];if(!o)throw new Error("Unsupported version: "+t.version);return o(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},n=e.readUint32();if(n!==t.Magic)throw new Ir("Unexpected magic: "+n,Br.GLTFLoaderUnexpectedMagicError);const r=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${r}`);const o=e.readUint32();!this.useRangeRequests&&o!==e.buffer.byteLength&&Me.Warn(`Length in header does not match actual data length: ${o} != ${e.buffer.byteLength}`);let s;switch(r){case 1:{s=this._unpackBinaryV1Async(e,o);break}case 2:{s=this._unpackBinaryV2Async(e,o);break}default:throw new Error("Unsupported version: "+r)}return this._endPerformanceCounter("Unpack Binary"),s})}_unpackBinaryV1Async(e,t){const n={JSON:0},r=e.readUint32(),o=e.readUint32();if(o!==n.JSON)throw new Error(`Unexpected content format: ${o}`);const s=t-e.byteOffset,a={json:this._parseJson(e.readString(r)),bin:null};if(s!==0){const l=e.byteOffset;a.bin={readAsync:(h,u)=>e.buffer.readAsync(l+h,u),byteLength:s}}return Promise.resolve(a)}_unpackBinaryV2Async(e,t){const n={JSON:1313821514,BIN:5130562},r=e.readUint32();if(e.readUint32()!==n.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+r===t?e.loadAsync(r).then(()=>({json:this._parseJson(e.readString(r)),bin:null})):e.loadAsync(r+8).then(()=>{const s={json:this._parseJson(e.readString(r)),bin:null},a=()=>{const l=e.readUint32();switch(e.readUint32()){case n.JSON:throw new Error("Unexpected JSON chunk");case n.BIN:{const u=e.byteOffset;s.bin={readAsync:(c,d)=>e.buffer.readAsync(u+c,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(a):Promise.resolve(s)};return a()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=pt._logSpaces.substring(0,this._logIndentLevel*2);Me.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){ke.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){ke.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}pt.IncrementalLoading=!0;pt.HomogeneousCoordinates=!1;pt._logSpaces="                                ";Un(new pt);var fn;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.FLOAT=5126]="FLOAT"})(fn||(fn={}));var js;(function(i){i[i.FRAGMENT=35632]="FRAGMENT",i[i.VERTEX=35633]="VERTEX"})(js||(js={}));var Tt;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D"})(Tt||(Tt={}));var Vn;(function(i){i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.REPEAT=10497]="REPEAT"})(Vn||(Vn={}));var Wt;(function(i){i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9728]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Wt||(Wt={}));var Ro;(function(i){i[i.ALPHA=6406]="ALPHA",i[i.RGB=6407]="RGB",i[i.RGBA=6408]="RGBA",i[i.LUMINANCE=6409]="LUMINANCE",i[i.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Ro||(Ro={}));var Ys;(function(i){i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Ys||(Ys={}));var et;(function(i){i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(et||(et={}));class lt{static SetMatrix(e,t,n,r,o){let s=null;if(n.semantic==="MODEL"?s=t.getWorldMatrix():n.semantic==="PROJECTION"?s=e.getProjectionMatrix():n.semantic==="VIEW"?s=e.getViewMatrix():n.semantic==="MODELVIEWINVERSETRANSPOSE"?s=rt.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):n.semantic==="MODELVIEW"?s=t.getWorldMatrix().multiply(e.getViewMatrix()):n.semantic==="MODELVIEWPROJECTION"?s=t.getWorldMatrix().multiply(e.getTransformMatrix()):n.semantic==="MODELINVERSE"?s=t.getWorldMatrix().invert():n.semantic==="VIEWINVERSE"?s=e.getViewMatrix().invert():n.semantic==="PROJECTIONINVERSE"?s=e.getProjectionMatrix().invert():n.semantic==="MODELVIEWINVERSE"?s=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():n.semantic==="MODELVIEWPROJECTIONINVERSE"?s=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():n.semantic==="MODELINVERSETRANSPOSE"&&(s=rt.Transpose(t.getWorldMatrix().invert())),s)switch(n.type){case Tt.FLOAT_MAT2:o.setMatrix2x2(r,rt.GetAsMatrix2x2(s));break;case Tt.FLOAT_MAT3:o.setMatrix3x3(r,rt.GetAsMatrix3x3(s));break;case Tt.FLOAT_MAT4:o.setMatrix(r,s);break}}static SetUniform(e,t,n,r){switch(r){case Tt.FLOAT:return e.setFloat(t,n),!0;case Tt.FLOAT_VEC2:return e.setVector2(t,Cn.FromArray(n)),!0;case Tt.FLOAT_VEC3:return e.setVector3(t,Q.FromArray(n)),!0;case Tt.FLOAT_VEC4:return e.setVector4(t,Sr.FromArray(n)),!0;default:return!1}}static GetWrapMode(e){switch(e){case Vn.CLAMP_TO_EDGE:return We.CLAMP_ADDRESSMODE;case Vn.MIRRORED_REPEAT:return We.MIRROR_ADDRESSMODE;case Vn.REPEAT:return We.WRAP_ADDRESSMODE;default:return We.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case Wt.LINEAR:case Wt.LINEAR_MIPMAP_NEAREST:case Wt.LINEAR_MIPMAP_LINEAR:return We.TRILINEAR_SAMPLINGMODE;case Wt.NEAREST:case Wt.NEAREST_MIPMAP_NEAREST:return We.NEAREST_SAMPLINGMODE;default:return We.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,n,r,o){n=t.byteOffset+n;const s=e.loadedBufferViews[t.buffer];if(n+r>s.byteLength)throw new Error("Buffer access is out of range");const a=s.buffer;switch(n+=s.byteOffset,o){case fn.BYTE:return new Int8Array(a,n,r);case fn.UNSIGNED_BYTE:return new Uint8Array(a,n,r);case fn.SHORT:return new Int16Array(a,n,r);case fn.UNSIGNED_SHORT:return new Uint16Array(a,n,r);default:return new Float32Array(a,n,r)}}static GetBufferFromAccessor(e,t){const n=e.bufferViews[t.bufferView],r=t.count*lt.GetByteStrideFromType(t);return lt.GetBufferFromBufferView(e,n,t.byteOffset,r,t.componentType)}static DecodeBufferToText(e){let t="";const n=e.byteLength;for(let r=0;r<n;++r)t+=String.fromCharCode(e[r]);return t}static GetDefaultMaterial(e){if(!lt._DefaultMaterial){xn.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),xn.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};lt._DefaultMaterial=new Yo("GLTFDefaultMaterial",e,t,n),lt._DefaultMaterial.setColor4("u_emission",new Xt(.5,.5,.5,1))}return lt._DefaultMaterial}}lt._DefaultMaterial=null;var mn;(function(i){i[i.IDENTIFIER=1]="IDENTIFIER",i[i.UNKNOWN=2]="UNKNOWN",i[i.END_OF_INPUT=3]="END_OF_INPUT"})(mn||(mn={}));class Fo{constructor(e){this._pos=0,this.currentToken=mn.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return mn.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=mn.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=mn.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const dr=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],pr=["world","view","projection","worldView","worldViewProjection","mBones"],vi=["translation","rotation","scale"],_i=["position","rotationQuaternion","scaling"],bi=(i,e)=>{for(const t in i){const n=i[t];e.buffers[t]=n,e.buffersCount++}},wi=(i,e)=>{for(const t in i){const n=i[t];e.shaders[t]=n,e.shaderscount++}},bt=(i,e,t)=>{for(const n in i){const r=i[n];t[e][n]=r}},xi=i=>{if(i)for(let e=0;e<i.length/2;e++)i[e*2+1]=1-i[e*2+1]},Lo=i=>{if(i.semantic==="NORMAL")return"normal";if(i.semantic==="POSITION")return"position";if(i.semantic==="JOINT")return"matricesIndices";if(i.semantic==="WEIGHT")return"matricesWeights";if(i.semantic==="COLOR")return"color";if(i.semantic&&i.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(i.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},Ai=i=>{for(const e in i.animations){const t=i.animations[e];if(!t.channels||!t.samplers)continue;let n=null;for(let r=0;r<t.channels.length;r++){const o=t.channels[r],s=t.samplers[o.sampler];if(!s)continue;let a=null,l=null;t.parameters?(a=t.parameters[s.input],l=t.parameters[s.output]):(a=s.input,l=s.output);const h=lt.GetBufferFromAccessor(i,i.accessors[a]),u=lt.GetBufferFromAccessor(i,i.accessors[l]),c=o.target.id;let d=i.scene.getNodeById(c);if(d===null&&(d=i.scene.getNodeByName(c)),d===null){ke.Warn("Creating animation named "+e+". But cannot find node named "+c+" to attach to");continue}const p=d instanceof Fn;let f=o.target.path;const g=vi.indexOf(f);g!==-1&&(f=_i[g]);let y=ve.ANIMATIONTYPE_MATRIX;p||(f==="rotationQuaternion"?(y=ve.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new it):y=ve.ANIMATIONTYPE_VECTOR3);let m=null;const _=[];let b=0,v=!1;p&&n&&n.getKeys().length===h.length&&(m=n,v=!0),v||(i.scene._blockEntityCollection=!!i.assetContainer,m=new ve(e,p?"_matrix":f,1,y,ve.ANIMATIONLOOPMODE_CYCLE),i.scene._blockEntityCollection=!1);for(let w=0;w<h.length;w++){let I=null;if(f==="rotationQuaternion"?(I=it.FromArray([u[b],u[b+1],u[b+2],u[b+3]]),b+=4):(I=Q.FromArray([u[b],u[b+1],u[b+2]]),b+=3),p){const V=d;let M=Q.Zero(),B=new it,P=Q.Zero(),T=V.getBaseMatrix();v&&n&&(T=n.getKeys()[w].value),T.decompose(P,B,M),f==="position"?M=I:f==="rotationQuaternion"?B=I:P=I,I=rt.Compose(P,B,M)}v?n&&(n.getKeys()[w].value=I):_.push({frame:h[w],value:I})}!v&&m&&(m.setKeys(_),d.animations.push(m)),n=m,i.scene.stopAnimation(d),i.scene.beginAnimation(d,0,h[h.length-1],!0,1)}}},to=i=>{let e=null;if(i.translation||i.rotation||i.scale){const t=Q.FromArray(i.scale||[1,1,1]),n=it.FromArray(i.rotation||[0,0,0,1]),r=Q.FromArray(i.translation||[0,0,0]);e=rt.Compose(t,n,r)}else e=rt.FromArray(i.matrix);return e},fr=(i,e,t,n)=>{for(let o=0;o<n.bones.length;o++)if(n.bones[o].name===t)return n.bones[o];const r=i.nodes;for(const o in r){const s=r[o];if(!s.jointName)continue;const a=s.children;for(let l=0;l<a.length;l++){const h=i.nodes[a[l]];if(h.jointName&&h.jointName===t){const u=to(s),c=new Fn(s.name||"",n,fr(i,e,s.jointName,n),u);return c.id=o,c}}}return null},Ti=(i,e)=>{for(let t=0;t<i.length;t++){const n=i[t];for(let r=0;r<n.node.children.length;r++)if(n.node.children[r]===e)return n.bone}return null},zs=(i,e)=>{const t=i.nodes;let n=t[e];if(n)return{node:n,id:e};for(const r in t)if(n=t[r],n.jointName===e)return{node:n,id:r};return null},Ci=(i,e)=>{for(let t=0;t<i.jointNames.length;t++)if(i.jointNames[t]===e)return!0;return!1},Ei=(i,e,t,n)=>{for(const r in i.nodes){const o=i.nodes[r],s=r;if(!o.jointName||Ci(t,o.jointName))continue;const a=to(o),l=new Fn(o.name||"",e,null,a);l.id=s,n.push({bone:l,node:o,id:s})}for(let r=0;r<n.length;r++){const o=n[r],s=o.node.children;for(let a=0;a<s.length;a++){let l=null;for(let h=0;h<n.length;h++)if(n[h].id===s[a]){l=n[h];break}l&&(l.bone._parent=o.bone,o.bone.children.push(l.bone))}}},Mi=(i,e,t,n)=>{if(n||(n=new Ls(e.name||"","",i.scene)),!e.babylonSkeleton)return n;const r=[],o=[];Ei(i,n,e,r),n.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=zs(i,e.jointNames[a]);if(!l)continue;const h=l.node;if(!h){ke.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}const u=l.id,c=i.scene.getBoneById(u);if(c){n.bones.push(c);continue}let d=!1,p=null;for(let y=0;y<a;y++){const m=zs(i,e.jointNames[y]);if(!m)continue;const _=m.node;if(!_){ke.Warn("Joint named "+e.jointNames[y]+" does not exist when looking for parent");continue}const b=_.children;if(b){d=!1;for(let v=0;v<b.length;v++)if(b[v]===u){p=fr(i,e,e.jointNames[y],n),d=!0;break}if(d)break}}const f=to(h);!p&&r.length>0&&(p=Ti(r,u),p&&o.indexOf(p)===-1&&o.push(p));const g=new Fn(h.jointName||"",n,p,f);g.id=u}const s=n.bones;n.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=zs(i,e.jointNames[a]);if(l){for(let h=0;h<s.length;h++)if(s[h].id===l.id){n.bones.push(s[h]);break}}}n.prepare();for(let a=0;a<o.length;a++)n.bones.push(o[a]);return n},ko=(i,e,t,n,r)=>{if(r||(i.scene._blockEntityCollection=!!i.assetContainer,r=new xt(e.name||"",i.scene),r._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,r.id=n),!e.babylonNode)return r;const o=[];let s=null;const a=[],l=[],h=[],u=[];for(let p=0;p<t.length;p++){const f=t[p],g=i.meshes[f];if(g)for(let y=0;y<g.primitives.length;y++){const m=new Zn,_=g.primitives[y];_.mode;const b=_.attributes;let v=null,w=null;for(const V in b)if(v=i.accessors[b[V]],w=lt.GetBufferFromAccessor(i,v),V==="NORMAL")m.normals=new Float32Array(w.length),m.normals.set(w);else if(V==="POSITION"){if(pt.HomogeneousCoordinates){m.positions=new Float32Array(w.length-w.length/4);for(let M=0;M<w.length;M+=4)m.positions[M]=w[M],m.positions[M+1]=w[M+1],m.positions[M+2]=w[M+2]}else m.positions=new Float32Array(w.length),m.positions.set(w);l.push(m.positions.length)}else if(V.indexOf("TEXCOORD_")!==-1){const M=Number(V.split("_")[1]),B=Ie.UVKind+(M===0?"":M+1),P=new Float32Array(w.length);P.set(w),xi(P),m.set(P,B)}else V==="JOINT"?(m.matricesIndices=new Float32Array(w.length),m.matricesIndices.set(w)):V==="WEIGHT"?(m.matricesWeights=new Float32Array(w.length),m.matricesWeights.set(w)):V==="COLOR"&&(m.colors=new Float32Array(w.length),m.colors.set(w));if(v=i.accessors[_.indices],v)w=lt.GetBufferFromAccessor(i,v),m.indices=new Int32Array(w.length),m.indices.set(w),u.push(m.indices.length);else{const V=[];for(let M=0;M<m.positions.length/3;M++)V.push(M);m.indices=new Int32Array(V),u.push(m.indices.length)}s?s.merge(m):s=m;const I=i.scene.getMaterialById(_.material);o.push(I===null?lt.GetDefaultMaterial(i.scene):I),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),h.push(h.length===0?0:h[h.length-1]+u[u.length-2])}}let c;i.scene._blockEntityCollection=!!i.assetContainer,o.length>1?(c=new Nr("multimat"+n,i.scene),c.subMaterials=o):c=new Bt("multimat"+n,i.scene),o.length===1&&(c=o[0]),c._parentContainer=i.assetContainer,r.material||(r.material=c),new Jn(n,i.scene,s,!1,r),r.computeWorldMatrix(!0),i.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let p=0;p<t.length;p++){const f=t[p],g=i.meshes[f];if(g)for(let y=0;y<g.primitives.length;y++)g.primitives[y].mode,Or.AddToMesh(d,a[d],l[d],h[d],u[d],r,r,!0),d++}return r},Xs=(i,e,t,n)=>{i.position&&(i.position=e),(i.rotationQuaternion||i.rotation)&&(i.rotationQuaternion=t),i.scaling&&(i.scaling=n)},Pi=(i,e)=>{if(e.matrix){const t=new Q(0,0,0),n=new it,r=new Q(0,0,0);rt.FromArray(e.matrix).decompose(r,n,t),Xs(i,t,n,r)}else e.translation&&e.rotation&&e.scale&&Xs(i,Q.FromArray(e.translation),it.FromArray(e.rotation),Q.FromArray(e.scale));i.computeWorldMatrix(!0)},Ii=(i,e,t)=>{let n=null;if(i.importOnlyMeshes&&(e.skin||e.meshes)&&i.importMeshesNames&&i.importMeshesNames.length>0&&i.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const r=i.skins[e.skin],o=ko(i,e,e.meshes,t,e.babylonNode);o.skeleton=i.scene.getLastSkeletonById(e.skin),o.skeleton===null&&(o.skeleton=Mi(i,r,o,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=o.skeleton)),n=o}}else if(e.meshes)n=ko(i,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!i.importOnlyMeshes){const r=i.lights[e.light];if(r){if(r.type==="ambient"){const o=r[r.type],s=new Zs(e.light,Q.Zero(),i.scene);s.name=e.name||"",o.color&&(s.diffuse=ie.FromArray(o.color)),n=s}else if(r.type==="directional"){const o=r[r.type],s=new ks(e.light,Q.Zero(),i.scene);s.name=e.name||"",o.color&&(s.diffuse=ie.FromArray(o.color)),n=s}else if(r.type==="point"){const o=r[r.type],s=new Js(e.light,Q.Zero(),i.scene);s.name=e.name||"",o.color&&(s.diffuse=ie.FromArray(o.color)),n=s}else if(r.type==="spot"){const o=r[r.type],s=new zt(e.light,Q.Zero(),Q.Zero(),0,0,i.scene);s.name=e.name||"",o.color&&(s.diffuse=ie.FromArray(o.color)),o.fallOfAngle&&(s.angle=o.fallOfAngle),o.fallOffExponent&&(s.exponent=o.fallOffExponent),n=s}}}else if(e.camera&&!e.babylonNode&&!i.importOnlyMeshes){const r=i.cameras[e.camera];if(r){if(i.scene._blockEntityCollection=!!i.assetContainer,r.type==="orthographic"){const o=new qs(e.camera,Q.Zero(),i.scene,!1);o.name=e.name||"",o.mode=Qo.ORTHOGRAPHIC_CAMERA,o.attachControl(),n=o,o._parentContainer=i.assetContainer}else if(r.type==="perspective"){const o=r[r.type],s=new qs(e.camera,Q.Zero(),i.scene,!1);s.name=e.name||"",s.attachControl(),o.aspectRatio||(o.aspectRatio=i.scene.getEngine().getRenderWidth()/i.scene.getEngine().getRenderHeight()),o.znear&&o.zfar&&(s.maxZ=o.zfar,s.minZ=o.znear),n=s,s._parentContainer=i.assetContainer}i.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(n===null){i.scene._blockEntityCollection=!!i.assetContainer;const r=new xt(e.name||"",i.scene);r._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,e.babylonNode=r,n=r}}if(n!==null){if(e.matrix&&n instanceof xt)Pi(n,e);else{const r=e.translation||[0,0,0],o=e.rotation||[0,0,0,1],s=e.scale||[1,1,1];Xs(n,Q.FromArray(r),it.FromArray(o),Q.FromArray(s))}n.updateCache(!0),e.babylonNode=n}return n},$n=(i,e,t,n=!1)=>{const r=i.nodes[e];let o=null;if(i.importOnlyMeshes&&!n&&i.importMeshesNames?i.importMeshesNames.indexOf(r.name||"")!==-1||i.importMeshesNames.length===0?n=!0:n=!1:n=!0,!r.jointName&&n&&(o=Ii(i,r,e),o!==null&&(o.id=e,o.parent=t)),r.children)for(let s=0;s<r.children.length;s++)$n(i,r.children[s],o,n)},Vo=i=>{let e=i.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)$n(i,e.nodes[t],null);else for(const t in i.scenes){e=i.scenes[t];for(let n=0;n<e.nodes.length;n++)$n(i,e.nodes[n],null)}Ai(i);for(let t=0;t<i.scene.skeletons.length;t++){const n=i.scene.skeletons[t];i.scene.beginAnimation(n,0,Number.MAX_VALUE,!0,1)}},Bi=(i,e,t,n,r,o,s)=>{const a=o.values||r.parameters;for(const l in t){const h=t[l],u=h.type;if(u===Tt.FLOAT_MAT2||u===Tt.FLOAT_MAT3||u===Tt.FLOAT_MAT4){if(h.semantic&&!h.source&&!h.node)lt.SetMatrix(e.scene,i,h,l,n.getEffect());else if(h.semantic&&(h.source||h.node)){let c=e.scene.getNodeByName(h.source||h.node||"");if(c===null&&(c=e.scene.getNodeById(h.source||h.node||"")),c===null)continue;lt.SetMatrix(e.scene,c,h,l,n.getEffect())}}else{const c=a[r.uniforms[l]];if(!c)continue;if(u===Tt.SAMPLER_2D){const d=e.textures[o.values?c:h.value].babylonTexture;if(d==null)continue;n.getEffect().setTexture(l,d)}else lt.SetUniform(n.getEffect(),l,c,u)}}s(n)},Si=(i,e,t,n,r)=>{const o=n.values||t.parameters,s=t.uniforms;for(const a in r){const l=r[a],h=l.type;let u=o[s[a]];if(u===void 0&&(u=l.value),!u)continue;const c=d=>p=>{l.value&&d&&(e.setTexture(d,p),delete r[d])};h===Tt.SAMPLER_2D?dt.LoadTextureAsync(i,n.values?u:l.value,c(a),()=>c(null)):l.value&&lt.SetUniform(e,a,n.values?u:l.value,h)&&delete r[a]}},Ni=(i,e,t)=>(n,r)=>{e.dispose(!0),t("Cannot compile program named "+i.name+". Error: "+r+". Default material will be applied")},Oi=(i,e,t,n,r,o)=>s=>{Si(i,e,t,n,r),e.onBind=a=>{Bi(a,i,r,e,t,n,o)}},Do=(i,e,t)=>{for(const n in e.uniforms){const r=e.uniforms[n],o=e.parameters[r];if(i.currentIdentifier===n&&o.semantic&&!o.source&&!o.node){const s=dr.indexOf(o.semantic);if(s!==-1)return delete t[n],pr[s]}}return i.currentIdentifier},Go=i=>{for(const e in i.materials)dt.LoadMaterialAsync(i,e,()=>{},()=>{})};class sn{static CreateRuntime(e,t,n){const r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&bt(e.extensions,"extensions",r),e.extensionsUsed&&bt(e.extensionsUsed,"extensionsUsed",r),e.buffers&&bi(e.buffers,r),e.bufferViews&&bt(e.bufferViews,"bufferViews",r),e.accessors&&bt(e.accessors,"accessors",r),e.meshes&&bt(e.meshes,"meshes",r),e.lights&&bt(e.lights,"lights",r),e.cameras&&bt(e.cameras,"cameras",r),e.nodes&&bt(e.nodes,"nodes",r),e.images&&bt(e.images,"images",r),e.textures&&bt(e.textures,"textures",r),e.shaders&&wi(e.shaders,r),e.programs&&bt(e.programs,"programs",r),e.samplers&&bt(e.samplers,"samplers",r),e.techniques&&bt(e.techniques,"techniques",r),e.materials&&bt(e.materials,"materials",r),e.animations&&bt(e.animations,"animations",r),e.skins&&bt(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,n,r,o){const s=e.buffers[t];ke.IsBase64(s.uri)?setTimeout(()=>n(new Uint8Array(ke.DecodeBase64(s.uri)))):ke.LoadFile(e.rootUrl+s.uri,a=>n(new Uint8Array(a)),o,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,n,r){const o=e.textures[t];if(!o||!o.source){r("");return}if(o.babylonTexture){n(null);return}const s=e.images[o.source];ke.IsBase64(s.uri)?setTimeout(()=>n(new Uint8Array(ke.DecodeBase64(s.uri)))):ke.LoadFile(e.rootUrl+s.uri,a=>n(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,n,r){const o=e.textures[t];if(o.babylonTexture){r(o.babylonTexture);return}const s=e.samplers[o.sampler],a=s.minFilter===Wt.NEAREST_MIPMAP_NEAREST||s.minFilter===Wt.NEAREST_MIPMAP_LINEAR||s.minFilter===Wt.LINEAR_MIPMAP_NEAREST||s.minFilter===Wt.LINEAR_MIPMAP_LINEAR,l=We.BILINEAR_SAMPLINGMODE,h=n==null?new Blob:new Blob([n]),u=URL.createObjectURL(h),c=()=>URL.revokeObjectURL(u),d=new We(u,e.scene,!a,!0,l,c,c);s.wrapS!==void 0&&(d.wrapU=lt.GetWrapMode(s.wrapS)),s.wrapT!==void 0&&(d.wrapV=lt.GetWrapMode(s.wrapT)),d.name=t,o.babylonTexture=d,r(d)}static LoadShaderStringAsync(e,t,n,r){const o=e.shaders[t];if(ke.IsBase64(o.uri)){const s=atob(o.uri.split(",")[1]);n&&n(s)}else ke.LoadFile(e.rootUrl+o.uri,n,void 0,void 0,!1,s=>{s&&r&&r(s.status+" "+s.statusText)})}static LoadMaterialAsync(e,t,n,r){const o=e.materials[t];if(!o.technique){r&&r("No technique found.");return}const s=e.techniques[o.technique];if(!s){e.scene._blockEntityCollection=!!e.assetContainer;const I=new Bt(t,e.scene);I._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,I.diffuseColor=new ie(.5,.5,.5),I.sideOrientation=Ft.CounterClockWiseSideOrientation,n(I);return}const a=e.programs[s.program],l=s.states,h=xn.ShadersStore[a.vertexShader+"VertexShader"],u=xn.ShadersStore[a.fragmentShader+"PixelShader"];let c="",d="";const p=new Fo(h),f=new Fo(u),g={},y=[],m=[],_=[];for(const I in s.uniforms){const V=s.uniforms[I],M=s.parameters[V];if(g[I]=M,M.semantic&&!M.node&&!M.source){const B=dr.indexOf(M.semantic);B!==-1?(y.push(pr[B]),delete g[I]):y.push(I)}else M.type===Tt.SAMPLER_2D?_.push(I):y.push(I)}for(const I in s.attributes){const V=s.attributes[I],M=s.parameters[V];if(M.semantic){const B=Lo(M);B&&m.push(B)}}for(;!p.isEnd()&&p.getNextToken();){if(p.currentToken!==mn.IDENTIFIER){c+=p.currentString;continue}let V=!1;for(const M in s.attributes){const B=s.attributes[M],P=s.parameters[B];if(p.currentIdentifier===M&&P.semantic){c+=Lo(P),V=!0;break}}V||(c+=Do(p,s,g))}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==mn.IDENTIFIER){d+=f.currentString;continue}d+=Do(f,s,g)}const b={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},v={attributes:m,uniforms:y,samplers:_,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};xn.ShadersStore[a.vertexShader+t+"VertexShader"]=c,xn.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;const w=new Yo(t,e.scene,b,v);if(w.onError=Ni(a,w,r),w.onCompiled=Oi(e,w,s,o,g,n),w.sideOrientation=Ft.CounterClockWiseSideOrientation,l&&l.functions){const I=l.functions;I.cullFace&&I.cullFace[0]!==Ys.BACK&&(w.backFaceCulling=!1);const V=I.blendFuncSeparate;V&&(V[0]===et.SRC_ALPHA&&V[1]===et.ONE_MINUS_SRC_ALPHA&&V[2]===et.ONE&&V[3]===et.ONE?w.alphaMode=un.ALPHA_COMBINE:V[0]===et.ONE&&V[1]===et.ONE&&V[2]===et.ZERO&&V[3]===et.ONE?w.alphaMode=un.ALPHA_ONEONE:V[0]===et.SRC_ALPHA&&V[1]===et.ONE&&V[2]===et.ZERO&&V[3]===et.ONE?w.alphaMode=un.ALPHA_ADD:V[0]===et.ZERO&&V[1]===et.ONE_MINUS_SRC_COLOR&&V[2]===et.ONE&&V[3]===et.ONE?w.alphaMode=un.ALPHA_SUBTRACT:V[0]===et.DST_COLOR&&V[1]===et.ZERO&&V[2]===et.ONE&&V[3]===et.ONE?w.alphaMode=un.ALPHA_MULTIPLY:V[0]===et.SRC_ALPHA&&V[1]===et.ONE_MINUS_SRC_COLOR&&V[2]===et.ONE&&V[3]===et.ONE&&(w.alphaMode=un.ALPHA_MAXIMIZED))}}}let On=class Qs{static RegisterExtension(e){if(Qs.Extensions[e.name]){ke.Error('Tool with the same name "'+e.name+'" already exists');return}Qs.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,n,r,o,s,a,l){return t.useRightHandedSystem=!0,dt.LoadRuntimeAsync(t,n,r,h=>{h.assetContainer=o,h.importOnlyMeshes=!0,e===""?h.importMeshesNames=[]:typeof e=="string"?h.importMeshesNames=[e]:e&&!(e instanceof Array)?h.importMeshesNames=[e]:(h.importMeshesNames=[],ke.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(h);const u=[],c=[];for(const d in h.nodes){const p=h.nodes[d];p.babylonNode instanceof Xo&&u.push(p.babylonNode)}for(const d in h.skins){const p=h.skins[d];p.babylonSkeleton instanceof Ls&&c.push(p.babylonSkeleton)}this._loadBuffersAsync(h,()=>{this._loadShadersAsync(h,()=>{Go(h),Vo(h),!pt.IncrementalLoading&&s&&s(u,c)})}),pt.IncrementalLoading&&s&&s(u,c)},l),!0}importMeshAsync(e,t,n,r,o,s){return new Promise((a,l)=>{this._importMeshAsync(e,t,r,o,n,(h,u)=>{a({meshes:h,particleSystems:[],skeletons:u,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},s,h=>{l(new Error(h))})})}_loadAsync(e,t,n,r,o,s){e.useRightHandedSystem=!0,dt.LoadRuntimeAsync(e,t,n,a=>{dt.LoadRuntimeExtensionsAsync(a,()=>{this._createNodes(a),this._loadBuffersAsync(a,()=>{this._loadShadersAsync(a,()=>{Go(a),Vo(a),pt.IncrementalLoading||r()})}),pt.IncrementalLoading&&r()},s)},s)}async loadAsync(e,t,n,r){return await new Promise((o,s)=>{this._loadAsync(e,t,n,()=>{o()},r,a=>{s(new Error(a))})})}_loadShadersAsync(e,t){let n=!1;const r=(o,s)=>{dt.LoadShaderStringAsync(e,o,a=>{a instanceof ArrayBuffer||(e.loadedShaderCount++,a&&(xn.ShadersStore[o+(s.type===js.VERTEX?"VertexShader":"PixelShader")]=a),e.loadedShaderCount===e.shaderscount&&t())},()=>{ke.Error("Error when loading shader program named "+o+" located at "+s.uri)})};for(const o in e.shaders){n=!0;const s=e.shaders[o];s?r.bind(this,o,s)():ke.Error("No shader named: "+o)}n||t()}_loadBuffersAsync(e,t){let n=!1;const r=(o,s)=>{dt.LoadBufferAsync(e,o,a=>{e.loadedBufferCount++,a&&(a.byteLength!=e.buffers[o].byteLength&&ke.Error("Buffer named "+o+" is length "+a.byteLength+". Expected: "+s.byteLength),e.loadedBufferViews[o]=a),e.loadedBufferCount===e.buffersCount&&t()},()=>{ke.Error("Error when loading buffer named "+o+" located at "+s.uri)})};for(const o in e.buffers){n=!0;const s=e.buffers[o];s?r.bind(this,o,s)():ke.Error("No buffer named: "+o)}n||t()}_createNodes(e){let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)$n(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let r=0;r<t.nodes.length;r++)$n(e,t.nodes[r],null)}}};On.Extensions={};class dt{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,n,r,o){return!1}loadRuntimeExtensionsAsync(e,t,n){return!1}loadBufferAsync(e,t,n,r,o){return!1}loadTextureBufferAsync(e,t,n,r){return!1}createTextureAsync(e,t,n,r,o){return!1}loadShaderStringAsync(e,t,n,r){return!1}loadMaterialAsync(e,t,n,r){return!1}static LoadRuntimeAsync(e,t,n,r,o){dt._ApplyExtensions(s=>s.loadRuntimeAsync(e,t,n,r,o),()=>{setTimeout(()=>{r&&r(sn.CreateRuntime(t.json,e,n))})})}static LoadRuntimeExtensionsAsync(e,t,n){dt._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,n),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,n,r,o){dt._ApplyExtensions(s=>s.loadBufferAsync(e,t,n,r,o),()=>{sn.LoadBufferAsync(e,t,n,r,o)})}static LoadTextureAsync(e,t,n,r){dt._LoadTextureBufferAsync(e,t,o=>{o&&dt._CreateTextureAsync(e,t,o,n,r)},r)}static LoadShaderStringAsync(e,t,n,r){dt._ApplyExtensions(o=>o.loadShaderStringAsync(e,t,n,r),()=>{sn.LoadShaderStringAsync(e,t,n,r)})}static LoadMaterialAsync(e,t,n,r){dt._ApplyExtensions(o=>o.loadMaterialAsync(e,t,n,r),()=>{sn.LoadMaterialAsync(e,t,n,r)})}static _LoadTextureBufferAsync(e,t,n,r){dt._ApplyExtensions(o=>o.loadTextureBufferAsync(e,t,n,r),()=>{sn.LoadTextureBufferAsync(e,t,n,r)})}static _CreateTextureAsync(e,t,n,r,o){dt._ApplyExtensions(s=>s.createTextureAsync(e,t,n,r,o),()=>{sn.CreateTextureAsync(e,t,n,r)})}static _ApplyExtensions(e,t){for(const n in On.Extensions){const r=On.Extensions[n];if(e(r))return}t()}}pt._CreateGLTF1Loader=()=>new On;const Ri="binary_glTF";class Fi extends dt{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,n,r){const o=t.json.extensionsUsed;return!o||o.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,r(sn.CreateRuntime(t.json,e,n)),!0)}loadBufferAsync(e,t,n,r){return e.extensionsUsed.indexOf(this.name)===-1||t!==Ri?!1:(this._bin.readAsync(0,this._bin.byteLength).then(n,o=>r(o.message)),!0)}loadTextureBufferAsync(e,t,n){const r=e.textures[t],o=e.images[r.source];if(!o.extensions||!(this.name in o.extensions))return!1;const s=o.extensions[this.name],a=e.bufferViews[s.bufferView],l=lt.GetBufferFromBufferView(e,a,0,a.byteLength,fn.UNSIGNED_BYTE);return n(l),!0}loadShaderStringAsync(e,t,n){const r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;const o=r.extensions[this.name],s=e.bufferViews[o.bufferView],a=lt.GetBufferFromBufferView(e,s,0,s.byteLength,fn.UNSIGNED_BYTE);return setTimeout(()=>{const l=lt.DecodeBufferToText(a);n(l)}),!0}}On.RegisterExtension(new Fi);class Li extends dt{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const n=t.lights;if(n)for(const r in n){const o=n[r];switch(o.type){case"ambient":{const s=new Zs(o.name,new Q(0,1,0),e.scene),a=o.ambient;a&&(s.diffuse=ie.FromArray(a.color||[1,1,1]));break}case"point":{const s=new Js(o.name,new Q(10,10,10),e.scene),a=o.point;a&&(s.diffuse=ie.FromArray(a.color||[1,1,1]));break}case"directional":{const s=new ks(o.name,new Q(0,-1,0),e.scene),a=o.directional;a&&(s.diffuse=ie.FromArray(a.color||[1,1,1]));break}case"spot":{const s=o.spot;if(s){const a=new zt(o.name,new Q(0,10,0),new Q(0,-1,0),s.fallOffAngle||Math.PI,s.fallOffExponent||0,e.scene);a.diffuse=ie.FromArray(s.color||[1,1,1])}break}default:ke.Warn('GLTF Material Common extension: light type "'+o.type+" not supported");break}}return!1}loadMaterialAsync(e,t,n,r){const o=e.materials[t];if(!o||!o.extensions)return!1;const s=o.extensions[this.name];if(!s)return!1;const a=new Bt(t,e.scene);return a.sideOrientation=Ft.CounterClockWiseSideOrientation,s.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=s.doubleSided===void 0?!1:!s.doubleSided,a.alpha=s.values.transparency===void 0?1:s.values.transparency,a.specularPower=s.values.shininess===void 0?0:s.values.shininess,typeof s.values.ambient=="string"?this._loadTexture(e,s.values.ambient,a,"ambientTexture",r):a.ambientColor=ie.FromArray(s.values.ambient||[0,0,0]),typeof s.values.diffuse=="string"?this._loadTexture(e,s.values.diffuse,a,"diffuseTexture",r):a.diffuseColor=ie.FromArray(s.values.diffuse||[0,0,0]),typeof s.values.emission=="string"?this._loadTexture(e,s.values.emission,a,"emissiveTexture",r):a.emissiveColor=ie.FromArray(s.values.emission||[0,0,0]),typeof s.values.specular=="string"?this._loadTexture(e,s.values.specular,a,"specularTexture",r):a.specularColor=ie.FromArray(s.values.specular||[0,0,0]),!0}_loadTexture(e,t,n,r,o){sn.LoadTextureBufferAsync(e,t,s=>{sn.CreateTextureAsync(e,t,s,a=>n[r]=a)},o)}}On.RegisterExtension(new Li);const no=new Map,ki=no;function Re(i,e,t){Ne(i)&&Me.Warn(`Extension with the name '${i}' already exists`),no.set(i,{isGLTFExtension:e,factory:t})}function Ne(i){return no.delete(i)}const Vi=[{regex:new RegExp("^/nodes/\\d+/extensions/")}];class Di{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t=this._gltf,n=this._infoTree,r;if(!e.startsWith("/"))throw new Error("Path must start with a /");const o=e.split("/");if(o.shift(),o[o.length-1].includes(".length")){const l=o[o.length-1].split(".");o.pop(),o.push(...l)}let s=!1;for(const a of o){const l=a==="length";if(l&&!n.__array__)throw new Error(`Path ${e} is invalid`);if(n.__ignoreObjectTree__&&(s=!0),n.__array__&&!l)n=n.__array__;else if(n=n[a],!n)throw new Error(`Path ${e} is invalid`);if(!s)if(t===void 0){if(!Vi.find(u=>u.regex.test(e)))throw new Error(`Path ${e} is invalid`)}else l||(t=t==null?void 0:t[a]);(n.__target__||l)&&(r=t)}return{object:r,info:n}}}const Gi={length:{type:"number",get:i=>i.length,getTarget:i=>i.map(e=>e._babylonTransformNode),getPropertyName:[()=>"length"]},__array__:{__target__:!0,translation:{type:"Vector3",get:i=>{var e;return(e=i._babylonTransformNode)==null?void 0:e.position},set:(i,e)=>{var t;return(t=e._babylonTransformNode)==null?void 0:t.position.copyFrom(i)},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"position"]},rotation:{type:"Quaternion",get:i=>{var e;return(e=i._babylonTransformNode)==null?void 0:e.rotationQuaternion},set:(i,e)=>{var t,n;return(n=(t=e._babylonTransformNode)==null?void 0:t.rotationQuaternion)==null?void 0:n.copyFrom(i)},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"rotationQuaternion"]},scale:{type:"Vector3",get:i=>{var e;return(e=i._babylonTransformNode)==null?void 0:e.scaling},set:(i,e)=>{var t;return(t=e._babylonTransformNode)==null?void 0:t.scaling.copyFrom(i)},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"scaling"]},weights:{length:{type:"number",get:i=>i._numMorphTargets,getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"influence"]},__array__:{__target__:!0,type:"number",get:(i,e)=>{var t,n;return e!==void 0?(n=(t=i._primitiveBabylonMeshes)==null?void 0:t[0].morphTargetManager)==null?void 0:n.getTarget(e).influence:void 0},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"influence"]},type:"number[]",get:(i,e)=>[0],getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"influence"]},matrix:{type:"Matrix",get:i=>{var e,t,n;return rt.Compose((e=i._babylonTransformNode)==null?void 0:e.scaling,(t=i._babylonTransformNode)==null?void 0:t.rotationQuaternion,(n=i._babylonTransformNode)==null?void 0:n.position)},getTarget:i=>i._babylonTransformNode,isReadOnly:!0},globalMatrix:{type:"Matrix",get:i=>{var r,o,s,a,l,h,u;const e=rt.Identity();let t=i.parent;for(;t&&t.parent;)t=t.parent;const n=((r=i._babylonTransformNode)==null?void 0:r.position._isDirty)||((s=(o=i._babylonTransformNode)==null?void 0:o.rotationQuaternion)==null?void 0:s._isDirty)||((a=i._babylonTransformNode)==null?void 0:a.scaling._isDirty);if(t){const c=(l=t._babylonTransformNode)==null?void 0:l.computeWorldMatrix(!0).invert();c&&((u=(h=i._babylonTransformNode)==null?void 0:h.computeWorldMatrix(n))==null||u.multiplyToRef(c,e))}else i._babylonTransformNode&&e.copyFrom(i._babylonTransformNode.computeWorldMatrix(n));return e},getTarget:i=>i._babylonTransformNode,isReadOnly:!0},extensions:{EXT_lights_ies:{multiplier:{type:"number",get:i=>{var e,t;return(t=(e=i._babylonTransformNode)==null?void 0:e.getChildren(n=>n instanceof zt,!0)[0])==null?void 0:t.intensity},getTarget:i=>{var e;return(e=i._babylonTransformNode)==null?void 0:e.getChildren(t=>t instanceof zt,!0)[0]},set:(i,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof zt,!0)[0];t&&(t.intensity=i)}}},color:{type:"Color3",get:i=>{var e,t;return(t=(e=i._babylonTransformNode)==null?void 0:e.getChildren(n=>n instanceof zt,!0)[0])==null?void 0:t.diffuse},getTarget:i=>{var e;return(e=i._babylonTransformNode)==null?void 0:e.getChildren(t=>t instanceof zt,!0)[0]},set:(i,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof zt,!0)[0];t&&(t.diffuse=i)}}}},KHR_node_visibility:{visible:{type:"boolean",get:i=>i._primitiveBabylonMeshes?i._primitiveBabylonMeshes[0].isVisible:!1,getTarget:()=>{},set:(i,e)=>{e._primitiveBabylonMeshes&&e._primitiveBabylonMeshes.forEach(t=>t.isVisible=i)}}}}}},$i={length:{type:"number",get:i=>i.length,getTarget:i=>i.map(e=>e._babylonAnimationGroup),getPropertyName:[()=>"length"]},__array__:{}},Hi={length:{type:"number",get:i=>i.length,getTarget:i=>i.map(e=>{var t;return(t=e.primitives[0]._instanceData)==null?void 0:t.babylonSourceMesh}),getPropertyName:[()=>"length"]},__array__:{}},zi={__array__:{__target__:!0,orthographic:{xmag:{componentsCount:2,type:"Vector2",get:i=>{var e,t;return new Cn(((e=i._babylonCamera)==null?void 0:e.orthoLeft)??0,((t=i._babylonCamera)==null?void 0:t.orthoRight)??0)},set:(i,e)=>{e._babylonCamera&&(e._babylonCamera.orthoLeft=i.x,e._babylonCamera.orthoRight=i.y)},getTarget:i=>i,getPropertyName:[()=>"orthoLeft",()=>"orthoRight"]},ymag:{componentsCount:2,type:"Vector2",get:i=>{var e,t;return new Cn(((e=i._babylonCamera)==null?void 0:e.orthoBottom)??0,((t=i._babylonCamera)==null?void 0:t.orthoTop)??0)},set:(i,e)=>{e._babylonCamera&&(e._babylonCamera.orthoBottom=i.x,e._babylonCamera.orthoTop=i.y)},getTarget:i=>i,getPropertyName:[()=>"orthoBottom",()=>"orthoTop"]},zfar:{type:"number",get:i=>{var e;return(e=i._babylonCamera)==null?void 0:e.maxZ},set:(i,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=i)},getTarget:i=>i,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:i=>{var e;return(e=i._babylonCamera)==null?void 0:e.minZ},set:(i,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=i)},getTarget:i=>i,getPropertyName:[()=>"minZ"]}},perspective:{aspectRatio:{type:"number",get:i=>{var e;return(e=i._babylonCamera)==null?void 0:e.getEngine().getAspectRatio(i._babylonCamera)},getTarget:i=>i,getPropertyName:[()=>"aspectRatio"],isReadOnly:!0},yfov:{type:"number",get:i=>{var e;return(e=i._babylonCamera)==null?void 0:e.fov},set:(i,e)=>{e._babylonCamera&&(e._babylonCamera.fov=i)},getTarget:i=>i,getPropertyName:[()=>"fov"]},zfar:{type:"number",get:i=>{var e;return(e=i._babylonCamera)==null?void 0:e.maxZ},set:(i,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=i)},getTarget:i=>i,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:i=>{var e;return(e=i._babylonCamera)==null?void 0:e.minZ},set:(i,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=i)},getTarget:i=>i,getPropertyName:[()=>"minZ"]}}}},Ui={__array__:{__target__:!0,emissiveFactor:{type:"Color3",get:(i,e,t)=>re(i,e,t).emissiveColor,set:(i,e,t,n)=>re(e,t,n).emissiveColor.copyFrom(i),getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"emissiveColor"]},emissiveTexture:{extensions:{KHR_texture_transform:ht("emissiveTexture")}},normalTexture:{scale:{type:"number",get:(i,e,t)=>{var n;return(n=hn(i,t,"bumpTexture"))==null?void 0:n.level},set:(i,e,t,n)=>{const r=hn(e,n,"bumpTexture");r&&(r.level=i)},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"level"]},extensions:{KHR_texture_transform:ht("bumpTexture")}},occlusionTexture:{strength:{type:"number",get:(i,e,t)=>re(i,e,t).ambientTextureStrength,set:(i,e,t,n)=>{const r=re(e,t,n);r&&(r.ambientTextureStrength=i)},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"ambientTextureStrength"]},extensions:{KHR_texture_transform:ht("ambientTexture")}},pbrMetallicRoughness:{baseColorFactor:{type:"Color4",get:(i,e,t)=>{const n=re(i,e,t);return Xt.FromColor3(n.albedoColor,n.alpha)},set:(i,e,t,n)=>{const r=re(e,t,n);r.albedoColor.set(i.r,i.g,i.b),r.alpha=i.a},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"albedoColor",()=>"alpha"]},baseColorTexture:{extensions:{KHR_texture_transform:ht("albedoTexture")}},metallicFactor:{type:"number",get:(i,e,t)=>re(i,e,t).metallic,set:(i,e,t,n)=>{const r=re(e,t,n);r&&(r.metallic=i)},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"metallic"]},roughnessFactor:{type:"number",get:(i,e,t)=>re(i,e,t).roughness,set:(i,e,t,n)=>{const r=re(e,t,n);r&&(r.roughness=i)},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"roughness"]},metallicRoughnessTexture:{extensions:{KHR_texture_transform:ht("metallicTexture")}}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:{type:"number",get:(i,e,t)=>re(i,e,t).anisotropy.intensity,set:(i,e,t,n)=>{re(e,t,n).anisotropy.intensity=i},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"anisotropy.intensity"]},anisotropyRotation:{type:"number",get:(i,e,t)=>re(i,e,t).anisotropy.angle,set:(i,e,t,n)=>{re(e,t,n).anisotropy.angle=i},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"anisotropy.angle"]},anisotropyTexture:{extensions:{KHR_texture_transform:ht("anisotropy","texture")}}},KHR_materials_clearcoat:{clearcoatFactor:{type:"number",get:(i,e,t)=>re(i,e,t).clearCoat.intensity,set:(i,e,t,n)=>{re(e,t,n).clearCoat.intensity=i},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"clearCoat.intensity"]},clearcoatRoughnessFactor:{type:"number",get:(i,e,t)=>re(i,e,t).clearCoat.roughness,set:(i,e,t,n)=>{re(e,t,n).clearCoat.roughness=i},getTarget:(i,e,t)=>re(i,e,t),getPropertyName:[()=>"clearCoat.roughness"]},clearcoatTexture:{extensions:{KHR_texture_transform:ht("clearCoat","texture")}},clearcoatNormalTexture:{scale:{type:"number",get:(i,e,t)=>{var n;return(n=re(i,e,t).clearCoat.bumpTexture)==null?void 0:n.level},getTarget:re,set:(i,e,t,n)=>re(e,t,n).clearCoat.bumpTexture.level=i},extensions:{KHR_texture_transform:ht("clearCoat","bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:ht("clearCoat","textureRoughness")}}},KHR_materials_dispersion:{dispersion:{type:"number",get:(i,e,t)=>re(i,e,t).subSurface.dispersion,getTarget:re,set:(i,e,t,n)=>re(e,t,n).subSurface.dispersion=i}},KHR_materials_emissive_strength:{emissiveStrength:{type:"number",get:(i,e,t)=>re(i,e,t).emissiveIntensity,getTarget:re,set:(i,e,t,n)=>re(e,t,n).emissiveIntensity=i}},KHR_materials_ior:{ior:{type:"number",get:(i,e,t)=>re(i,e,t).indexOfRefraction,getTarget:re,set:(i,e,t,n)=>re(e,t,n).indexOfRefraction=i}},KHR_materials_iridescence:{iridescenceFactor:{type:"number",get:(i,e,t)=>re(i,e,t).iridescence.intensity,getTarget:re,set:(i,e,t,n)=>re(e,t,n).iridescence.intensity=i},iridescenceIor:{type:"number",get:(i,e,t)=>re(i,e,t).iridescence.indexOfRefraction,getTarget:re,set:(i,e,t,n)=>re(e,t,n).iridescence.indexOfRefraction=i},iridescenceTexture:{extensions:{KHR_texture_transform:ht("iridescence","texture")}},iridescenceThicknessMaximum:{type:"number",get:(i,e,t)=>re(i,e,t).iridescence.maximumThickness,getTarget:re,set:(i,e,t,n)=>re(e,t,n).iridescence.maximumThickness=i},iridescenceThicknessMinimum:{type:"number",get:(i,e,t)=>re(i,e,t).iridescence.minimumThickness,getTarget:re,set:(i,e,t,n)=>re(e,t,n).iridescence.minimumThickness=i},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:ht("iridescence","thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:{type:"Color3",get:(i,e,t)=>re(i,e,t).sheen.color,getTarget:re,set:(i,e,t,n)=>re(e,t,n).sheen.color.copyFrom(i)},sheenColorTexture:{extensions:{KHR_texture_transform:ht("sheen","texture")}},sheenRoughnessFactor:{type:"number",get:(i,e,t)=>re(i,e,t).sheen.intensity,getTarget:re,set:(i,e,t,n)=>re(e,t,n).sheen.intensity=i},sheenRoughnessTexture:{extensions:{KHR_texture_transform:ht("sheen","thicknessTexture")}}},KHR_materials_specular:{specularFactor:{type:"number",get:(i,e,t)=>re(i,e,t).metallicF0Factor,getTarget:re,set:(i,e,t,n)=>re(e,t,n).metallicF0Factor=i,getPropertyName:[()=>"metallicF0Factor"]},specularColorFactor:{type:"Color3",get:(i,e,t)=>re(i,e,t).metallicReflectanceColor,getTarget:re,set:(i,e,t,n)=>re(e,t,n).metallicReflectanceColor.copyFrom(i),getPropertyName:[()=>"metallicReflectanceColor"]},specularTexture:{extensions:{KHR_texture_transform:ht("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:ht("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:{type:"number",get:(i,e,t)=>re(i,e,t).subSurface.refractionIntensity,getTarget:re,set:(i,e,t,n)=>re(e,t,n).subSurface.refractionIntensity=i,getPropertyName:[()=>"subSurface.refractionIntensity"]},transmissionTexture:{extensions:{KHR_texture_transform:ht("subSurface","refractionIntensityTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:{type:"number",get:(i,e,t)=>re(i,e,t).subSurface.translucencyIntensity,getTarget:re,set:(i,e,t,n)=>re(e,t,n).subSurface.translucencyIntensity=i},diffuseTransmissionTexture:{extensions:{KHR_texture_transform:ht("subSurface","translucencyIntensityTexture")}},diffuseTransmissionColorFactor:{type:"Color3",get:(i,e,t)=>re(i,e,t).subSurface.translucencyColor,getTarget:re,set:(i,e,t,n)=>{var r;return i&&((r=re(e,t,n).subSurface.translucencyColor)==null?void 0:r.copyFrom(i))}},diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:ht("subSurface","translucencyColorTexture")}}},KHR_materials_volume:{attenuationColor:{type:"Color3",get:(i,e,t)=>re(i,e,t).subSurface.tintColor,getTarget:re,set:(i,e,t,n)=>re(e,t,n).subSurface.tintColor.copyFrom(i)},attenuationDistance:{type:"number",get:(i,e,t)=>re(i,e,t).subSurface.tintColorAtDistance,getTarget:re,set:(i,e,t,n)=>re(e,t,n).subSurface.tintColorAtDistance=i},thicknessFactor:{type:"number",get:(i,e,t)=>re(i,e,t).subSurface.maximumThickness,getTarget:re,set:(i,e,t,n)=>re(e,t,n).subSurface.maximumThickness=i},thicknessTexture:{extensions:{KHR_texture_transform:ht("subSurface","thicknessTexture")}}}}}},Wi={KHR_lights_punctual:{lights:{length:{type:"number",get:i=>i.length,getTarget:i=>i.map(e=>e._babylonLight),getPropertyName:[i=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.diffuse},set:(i,e)=>{var t;return(t=e._babylonLight)==null?void 0:t.diffuse.copyFrom(i)},getTarget:i=>i._babylonLight,getPropertyName:[i=>"diffuse"]},intensity:{type:"number",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.intensity},set:(i,e)=>e._babylonLight?e._babylonLight.intensity=i:void 0,getTarget:i=>i._babylonLight,getPropertyName:[i=>"intensity"]},range:{type:"number",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.range},set:(i,e)=>e._babylonLight?e._babylonLight.range=i:void 0,getTarget:i=>i._babylonLight,getPropertyName:[i=>"range"]},spot:{innerConeAngle:{type:"number",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.innerAngle},set:(i,e)=>e._babylonLight?e._babylonLight.innerAngle=i:void 0,getTarget:i=>i._babylonLight,getPropertyName:[i=>"innerConeAngle"]},outerConeAngle:{type:"number",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.angle},set:(i,e)=>e._babylonLight?e._babylonLight.angle=i:void 0,getTarget:i=>i._babylonLight,getPropertyName:[i=>"outerConeAngle"]}}}}},EXT_lights_area:{lights:{length:{type:"number",get:i=>i.length,getTarget:i=>i.map(e=>e._babylonLight),getPropertyName:[i=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.diffuse},set:(i,e)=>{var t;return(t=e._babylonLight)==null?void 0:t.diffuse.copyFrom(i)},getTarget:i=>i._babylonLight,getPropertyName:[i=>"diffuse"]},intensity:{type:"number",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.intensity},set:(i,e)=>e._babylonLight?e._babylonLight.intensity=i:void 0,getTarget:i=>i._babylonLight,getPropertyName:[i=>"intensity"]},size:{type:"number",get:i=>{var e;return(e=i._babylonLight)==null?void 0:e.height},set:(i,e)=>e._babylonLight?e._babylonLight.height=i:void 0,getTarget:i=>i._babylonLight,getPropertyName:[i=>"size"]},rect:{aspect:{type:"number",get:i=>{var e,t;return((e=i._babylonLight)==null?void 0:e.width)/((t=i._babylonLight)==null?void 0:t.height)},set:(i,e)=>e._babylonLight?e._babylonLight.width=i*e._babylonLight.height:void 0,getTarget:i=>i._babylonLight,getPropertyName:[i=>"aspect"]}}}}},EXT_lights_ies:{lights:{length:{type:"number",get:i=>i.length,getTarget:i=>i.map(e=>e._babylonLight),getPropertyName:[i=>"length"]}}},EXT_lights_image_based:{lights:{length:{type:"number",get:i=>i.length,getTarget:i=>i.map(e=>e._babylonTexture),getPropertyName:[i=>"length"]},__array__:{__target__:!0,intensity:{type:"number",get:i=>{var e;return(e=i._babylonTexture)==null?void 0:e.level},set:(i,e)=>{e._babylonTexture&&(e._babylonTexture.level=i)},getTarget:i=>i._babylonTexture},rotation:{type:"Quaternion",get:i=>{var e;return i._babylonTexture&&it.FromRotationMatrix((e=i._babylonTexture)==null?void 0:e.getReflectionTextureMatrix())},set:(i,e)=>{var t;e._babylonTexture&&((t=e._babylonTexture.getScene())!=null&&t.useRightHandedSystem||(i=it.Inverse(i)),rt.FromQuaternionToRef(i,e._babylonTexture.getReflectionTextureMatrix()))},getTarget:i=>i._babylonTexture}}}}};function hn(i,e,t,n){const r=re(i);return n?r[t][n]:r[t]}function re(i,e,t){var n,r;return(r=(n=i._data)==null?void 0:n[(t==null?void 0:t.fillMode)??un.MATERIAL_TriangleFillMode])==null?void 0:r.babylonMaterial}function ht(i,e){return{offset:{componentsCount:2,type:"Vector2",get:(t,n,r)=>{const o=hn(t,r,i,e);return new Cn(o==null?void 0:o.uOffset,o==null?void 0:o.vOffset)},getTarget:re,set:(t,n,r,o)=>{const s=hn(n,o,i,e);s.uOffset=t.x,s.vOffset=t.y},getPropertyName:[()=>`${i}${e?"."+e:""}.uOffset`,()=>`${i}${e?"."+e:""}.vOffset`]},rotation:{type:"number",get:(t,n,r)=>{var o;return(o=hn(t,r,i,e))==null?void 0:o.wAng},getTarget:re,set:(t,n,r,o)=>hn(n,o,i,e).wAng=t,getPropertyName:[()=>`${i}${e?"."+e:""}.wAng`]},scale:{componentsCount:2,type:"Vector2",get:(t,n,r)=>{const o=hn(t,r,i,e);return new Cn(o==null?void 0:o.uScale,o==null?void 0:o.vScale)},getTarget:re,set:(t,n,r,o)=>{const s=hn(n,o,i,e);s.uScale=t.x,s.vScale=t.y},getPropertyName:[()=>`${i}${e?"."+e:""}.uScale`,()=>`${i}${e?"."+e:""}.vScale`]}}}const Vs={cameras:zi,nodes:Gi,materials:Ui,extensions:Wi,animations:$i,meshes:Hi};function mr(i){return new Di(i,Vs)}function Yn(i){const e=i.split("/").map(n=>n.replace(/{}/g,"__array__"));let t=Vs;for(const n of e)n&&(t=t[n]);if(t&&t.type&&t.get)return t}function X(i,e){const t=i.split("/").map(r=>r.replace(/{}/g,"__array__"));let n=Vs;for(const r of t)r&&(n=n[r]);n&&n.type&&n.get&&(n.interpolation=e)}function Yt(i,e){const t=i.split("/").map(r=>r.replace(/{}/g,"__array__"));let n=Vs;for(const r of t)if(r){if(!n[r]){if(r==="?"){n.__ignoreObjectTree__=!0;continue}n[r]={},r==="__array__"&&(n[r].__target__=!0)}n=n[r]}Object.assign(n,e)}const qi=new Zo(()=>An(()=>import("./babylon--_blpBQ1.js").then(i=>i.aw),[])),Ki=new Zo(()=>An(()=>Promise.resolve().then(()=>ji),void 0));class pe{static Get(e,t,n){if(!t||n==null||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function yr(i){if(i.min&&i.max){const e=i.min,t=i.max,n=Ot.Vector3[0].copyFromFloats(e[0],e[1],e[2]),r=Ot.Vector3[1].copyFromFloats(t[0],t[1],t[2]);if(i.normalized&&i.componentType!==5126){let o=1;switch(i.componentType){case 5120:o=127;break;case 5121:o=255;break;case 5122:o=32767;break;case 5123:o=65535;break}const s=1/o;n.scaleInPlace(s),r.scaleInPlace(s)}return new Hr(n,r)}return null}class we{static RegisterExtension(e,t){Re(e,!1,t)}static UnregisterExtension(e){return Ne(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._materialAdapterCache=new WeakMap,this._pbrMaterialImpl=null,this._parent=e}_getOrCreateMaterialAdapter(e){let t=this._materialAdapterCache.get(e);if(!t){if(this._pbrMaterialImpl)t=new this._pbrMaterialImpl.adapterClass(e);else throw new Error("Appropriate material adapter class not found");this._materialAdapterCache.set(e,t)}return t}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}async importMeshAsync(e,t,n,r,o,s,a=""){return await Promise.resolve().then(async()=>{this._babylonScene=t,this._assetContainer=n,this._loadData(r);let l=null;if(e){const h={};if(this._gltf.nodes)for(const c of this._gltf.nodes)c.name&&(h[c.name]=c.index);l=(e instanceof Array?e:[e]).map(c=>{const d=h[c];if(d===void 0)throw new Error(`Failed to find node '${c}'`);return d})}return await this._loadAsync(o,a,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}async loadAsync(e,t,n,r,o=""){return this._babylonScene=e,this._loadData(t),await this._loadAsync(n,o,null,()=>{})}async _loadAsync(e,t,n,r){return await Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync(),!this.parent.skipMaterials&&this._pbrMaterialImpl==null&&(this.parent.useOpenPBR||this.isExtensionUsed("KHR_materials_openpbr")?this._pbrMaterialImpl={materialClass:(await An(async()=>{const{OpenPBRMaterial:u}=await import("./babylon--_blpBQ1.js").then(c=>c.ay);return{OpenPBRMaterial:u}},[])).OpenPBRMaterial,adapterClass:(await An(async()=>{const{OpenPBRMaterialLoadingAdapter:u}=await import("./openpbrMaterialLoadingAdapter-DZHxxGuA.js");return{OpenPBRMaterialLoadingAdapter:u}},[])).OpenPBRMaterialLoadingAdapter}:this._pbrMaterialImpl={materialClass:(await An(async()=>{const{PBRMaterial:u}=await import("./babylon--_blpBQ1.js").then(c=>c.ax);return{PBRMaterial:u}},[])).PBRMaterial,adapterClass:(await An(async()=>{const{PBRMaterialLoadingAdapter:u}=await import("./pbrMaterialLoadingAdapter-D40ruAWD.js");return{PBRMaterialLoadingAdapter:u}},__vite__mapDeps([0,1]))).PBRMaterialLoadingAdapter});const o=`${It[It.LOADING]} => ${It[It.READY]}`,s=`${It[It.LOADING]} => ${It[It.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(s),this._parent._setState(It.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(n)a.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const u=pe.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${u.index}`,u))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let u=0;u<this._gltf.materials.length;++u){const c=this._gltf.materials[u],d="/materials/"+u,p=Ft.TriangleFillMode;a.push(this._loadMaterialAsync(d,c,null,p,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync()),await Promise.all(a).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(const u of this._babylonScene.materials){const c=u;c.maxSimultaneousLights!==void 0&&(c.maxSimultaneousLights=Math.max(c.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(It.READY),this._skipStartAnimationStep||this._startAnimations(),r()}).then(u=>(this._parent._endPerformanceCounter(o),ke.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(s),this._parent._setState(It.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},c=>{this._parent.onErrorObservable.notifyObservers(c),this._parent.onErrorObservable.clear(),this.dispose()})}),u))}).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&Me.Warn(`Binary buffer length (${n.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else Me.Warn("Unexpected BIN chunk")}}_setupData(){if(pe.Assign(this._gltf.accessors),pe.Assign(this._gltf.animations),pe.Assign(this._gltf.buffers),pe.Assign(this._gltf.bufferViews),pe.Assign(this._gltf.cameras),pe.Assign(this._gltf.images),pe.Assign(this._gltf.materials),pe.Assign(this._gltf.meshes),pe.Assign(this._gltf.nodes),pe.Assign(this._gltf.samplers),pe.Assign(this._gltf.scenes),pe.Assign(this._gltf.skins),pe.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const n of this._gltf.nodes)if(n.children)for(const r of n.children)e[r]=n.index;const t=this._createRootNode();for(const n of this._gltf.nodes){const r=e[n.index];n.parent=r===void 0?t:this._gltf.nodes[r]}}}async _loadExtensionsAsync(){var t;const e=[];if(ki.forEach((n,r)=>{var o;((o=this.parent.extensionOptions[r])==null?void 0:o.enabled)===!1?n.isGLTFExtension&&this.isExtensionUsed(r)&&Me.Warn(`Extension ${r} is used but has been explicitly disabled.`):(!n.isGLTFExtension||this.isExtensionUsed(r))&&e.push((async()=>{const s=await n.factory(this);return s.name!==r&&Me.Warn(`The name of the glTF loader extension instance does not match the registered name: ${s.name} !== ${r}`),this._parent.onExtensionLoadedObservable.notifyObservers(s),s})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((n,r)=>(n.order||Number.MAX_VALUE)-(r.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(const n of this._gltf.extensionsRequired)if(!this._extensions.some(o=>o.name===n&&o.enabled))throw((t=this.parent.extensionOptions[n])==null?void 0:t.enabled)===!1?new Error(`Required extension ${n} is disabled`):new Error(`Required extension ${n} is not available`)}}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new xt("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Gn.AUTO:{this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],we._LoadTransform(t,this._rootBabylonMesh));break}case Gn.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const n=this._extensionsLoadSceneAsync(e,t);if(n)return n;const r=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const o of t.nodes){const s=pe.Get(`${e}/nodes/${o}`,this._gltf.nodes,o);r.push(this.loadNodeAsync(`/nodes/${s.index}`,s,a=>{a.parent=this._rootBabylonMesh}))}for(const o of this._postSceneLoadActions)o();return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const n of e._primitiveBabylonMeshes)t(n)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,r=>{const o=r.geometry;o&&e.indexOf(o)===-1&&e.push(o)});return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof Xo&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,r=>{e.push(r)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)n._babylonTransformNode&&n._babylonTransformNode.getClassName()==="TransformNode"&&e.push(n._babylonTransformNode),n._babylonTransformNodeForSkin&&e.push(n._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const n of t)n._data&&e.push(n._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const n of t)n._babylonAnimationGroup&&e.push(n._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case Sn.NONE:break;case Sn.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case Sn.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{Me.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,n=()=>{}){const r=this._extensionsLoadNodeAsync(e,t,n);if(r)return r;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const o=new Array;this.logOpen(`${e} ${t.name||""}`);const s=h=>{if(we.AddPointerMetadata(h,e),we._LoadTransform(t,h),t.camera!=null){const u=pe.Get(`${e}/camera`,this._gltf.cameras,t.camera);o.push(this.loadCameraAsync(`/cameras/${u.index}`,u,c=>{c.parent=h,this._babylonScene.useRightHandedSystem||(h.scaling.x=-1)}))}if(t.children)for(const u of t.children){const c=pe.Get(`${e}/children/${u}`,this._gltf.nodes,u);o.push(this.loadNodeAsync(`/nodes/${c.index}`,c,d=>{d.parent=h}))}n(h)},a=t.mesh!=null,l=this._parent.loadSkins&&t.skin!=null;if(!a||l){const h=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u=new Nn(h,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=u:t._babylonTransformNodeForSkin=u,s(u)}if(a)if(l){const h=pe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${h.index}`,t,h,u=>{const c=t._babylonTransformNodeForSkin;u.metadata=Rr(c.metadata,u.metadata||{});const d=pe.Get(`${e}/skin`,this._gltf.skins,t.skin);o.push(this._loadSkinAsync(`/skins/${d.index}`,t,d,p=>{this._forEachPrimitive(t,f=>{f.skeleton=p}),this._postSceneLoadActions.push(()=>{if(d.skeleton!=null){const f=pe.Get(`/skins/${d.index}/skeleton`,this._gltf.nodes,d.skeleton).parent;t.index===f.index?u.parent=c.parent:u.parent=f._babylonTransformNode}else u.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:c,skinnedNode:u})})}))}))}else{const h=pe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${h.index}`,t,h,s))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(t,h=>{const u=h;!u.isAnInstance&&u.geometry&&u.geometry.useBoundingInfoFromGeometry?h._updateBoundingInfo():h.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,n,r){const o=n.primitives;if(!o||!o.length)throw new Error(`${e}: Primitives are missing`);o[0].index==null&&pe.Assign(o);const s=new Array;this.logOpen(`${e} ${n.name||""}`);const a=t.name||`node${t.index}`;if(o.length===1){const l=n.primitives[0];s.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,a,t,n,l,h=>{t._babylonTransformNode=h,t._primitiveBabylonMeshes=[h]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new Nn(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of o)s.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${a}_primitive${l.index}`,t,n,l,h=>{h.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(h)}))}return r(t._babylonTransformNode),this.logClose(),Promise.all(s).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,n,r,o,s){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,n,r,o,s);if(a)return a;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&n.skin==null&&!r.primitives[0].targets;let h,u;if(l&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,h=o._instanceData.babylonSourceMesh.createInstance(t),h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u=o._instanceData.promise;else{const c=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new xt(t,this._babylonScene);if(d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.sideOrientation=this._babylonScene.useRightHandedSystem?Ft.CounterClockWiseSideOrientation:Ft.ClockWiseSideOrientation,this._createMorphTargets(e,n,r,o,d),c.push(this._loadVertexDataAsync(e,o,d).then(async p=>await this._loadMorphTargetsAsync(e,o,d,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(d),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)}))),!this.parent.skipMaterials){const p=we._GetDrawMode(e,o.mode);if(o.material==null){let f=this._defaultBabylonMaterialData[p];f||(f=this._createDefaultMaterial("__GLTFLoader._default",p),this._parent.onMaterialLoadedObservable.notifyObservers(f),this._defaultBabylonMaterialData[p]=f),d.material=f}else{const f=pe.Get(`${e}/material`,this._gltf.materials,o.material);c.push(this._loadMaterialAsync(`/materials/${f.index}`,f,d,p,g=>{d.material=g}))}}u=Promise.all(c),l&&(o._instanceData={babylonSourceMesh:d,promise:u}),h=d}return we.AddPointerMetadata(h,e),this._parent.onMeshLoadedObservable.notifyObservers(h),s(h),this.logClose(),u.then(()=>h)}_loadVertexDataAsync(e,t,n){const r=this._extensionsLoadVertexDataAsync(e,t,n);if(r)return r;const o=t.attributes;if(!o)throw new Error(`${e}: Attributes are missing`);const s=new Array,a=new Jn(n.name,this._babylonScene);if(t.indices==null)n.isUnIndexed=!0;else{const h=pe.Get(`${e}/indices`,this._gltf.accessors,t.indices);s.push(this._loadIndicesAccessorAsync(`/accessors/${h.index}`,h).then(u=>{a.setIndices(u)}))}const l=(h,u,c)=>{if(o[h]==null)return;n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(u)===-1&&n._delayInfo.push(u);const d=pe.Get(`${e}/attributes/${h}`,this._gltf.accessors,o[h]);s.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,u).then(p=>{if(p.getKind()===Ie.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!n.skeleton){const f=yr(d);f&&(a._boundingInfo=f,a.useBoundingInfoFromGeometry=!0)}a.setVerticesBuffer(p,d.count)})),u==Ie.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),c&&c(d)};return l("POSITION",Ie.PositionKind),l("NORMAL",Ie.NormalKind),l("TANGENT",Ie.TangentKind),l("TEXCOORD_0",Ie.UVKind),l("TEXCOORD_1",Ie.UV2Kind),l("TEXCOORD_2",Ie.UV3Kind),l("TEXCOORD_3",Ie.UV4Kind),l("TEXCOORD_4",Ie.UV5Kind),l("TEXCOORD_5",Ie.UV6Kind),l("JOINTS_0",Ie.MatricesIndicesKind),l("WEIGHTS_0",Ie.MatricesWeightsKind),l("JOINTS_1",Ie.MatricesIndicesExtraKind),l("WEIGHTS_1",Ie.MatricesWeightsExtraKind),l("COLOR_0",Ie.ColorKind,h=>{h.type==="VEC4"&&(n.hasVertexAlpha=!0)}),Promise.all(s).then(()=>a)}_createMorphTargets(e,t,n,r,o){if(!r.targets||!this._parent.loadMorphTargets)return;if(t._numMorphTargets==null)t._numMorphTargets=r.targets.length;else if(r.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const s=n.extras?n.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new Fr(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let a=0;a<r.targets.length;a++){const l=t.weights?t.weights[a]:n.weights?n.weights[a]:0,h=s?s[a]:`morphTarget${a}`;o.morphTargetManager.addTarget(new Lr(h,l,o.getScene()))}}_loadMorphTargetsAsync(e,t,n,r){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const o=new Array,s=n.morphTargetManager;for(let a=0;a<s.numTargets;a++){const l=s.getTarget(a);o.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${a}`,r,t.targets[a],l))}return Promise.all(o).then(()=>{s.areUpdatesFrozen=!1})}async _loadMorphTargetVertexDataAsync(e,t,n,r){const o=new Array,s=(a,l,h)=>{if(n[a]==null)return;const u=t.getVertexBuffer(l);if(!u)return;const c=pe.Get(`${e}/${a}`,this._gltf.accessors,n[a]);o.push(this._loadFloatAccessorAsync(`/accessors/${c.index}`,c).then(d=>{h(u,d)}))};return s("POSITION",Ie.PositionKind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(l.length,(u,c)=>{h[c]=l[c]+u}),r.setPositions(h)}),s("NORMAL",Ie.NormalKind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(h.length,(u,c)=>{h[c]=l[c]+u}),r.setNormals(h)}),s("TANGENT",Ie.TangentKind,(a,l)=>{const h=new Float32Array(l.length/3*4);let u=0;a.forEach(l.length/3*4,(c,d)=>{(d+1)%4!==0&&(h[u]=l[u]+c,u++)}),r.setTangents(h)}),s("TEXCOORD_0",Ie.UVKind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(l.length,(u,c)=>{h[c]=l[c]+u}),r.setUVs(h)}),s("TEXCOORD_1",Ie.UV2Kind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(l.length,(u,c)=>{h[c]=l[c]+u}),r.setUV2s(h)}),s("COLOR_0",Ie.ColorKind,(a,l)=>{let h=null;const u=a.getSize();if(u===3){h=new Float32Array(l.length/3*4),a.forEach(l.length,(c,d)=>{const p=Math.floor(d/3),f=d%3;h[4*p+f]=l[3*p+f]+c});for(let c=0;c<l.length/3;++c)h[4*c+3]=1}else if(u===4)h=new Float32Array(l.length),a.forEach(l.length,(c,d)=>{h[d]=l[d]+c});else throw new Error(`${e}: Invalid number of components (${u}) for COLOR_0 attribute`);r.setColors(h)}),await Promise.all(o).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let n=Q.Zero(),r=it.Identity(),o=Q.One();e.matrix?rt.FromArray(e.matrix).decompose(o,r,n):(e.translation&&(n=Q.FromArray(e.translation)),e.rotation&&(r=it.FromArray(e.rotation)),e.scale&&(o=Q.FromArray(e.scale))),t.position=n,t.rotationQuaternion=r,t.scaling=o}_loadSkinAsync(e,t,n,r){if(!this._parent.loadSkins)return Promise.resolve();const o=this._extensionsLoadSkinAsync(e,t,n);if(o)return o;if(n._data)return r(n._data.babylonSkeleton),n._data.promise;const s=`skeleton${n.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new Ls(n.name||s,s,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,n,a);const l=this._loadSkinInverseBindMatricesDataAsync(e,n).then(h=>{this._updateBoneMatrices(a,h)});return n._data={babylonSkeleton:a,promise:l},r(a),l}_loadBones(e,t,n){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const o=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(o)if(t.skeleton===void 0)t.skeleton=o.index;else{const s=(l,h)=>{for(;h.parent;h=h.parent)if(h.parent===l)return!0;return!1},a=pe.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);a!==o&&!s(a,o)&&(Me.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=o.index)}else Me.Warn(`${e}: Failed to find common root`)}const r={};for(const o of t.joints){const s=pe.Get(`${e}/joints/${o}`,this._gltf.nodes,o);this._loadBone(s,t,n,r)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const n={};for(const o of t){const s=[];let a=pe.Get(`${e}/${o}`,this._gltf.nodes,o);for(;a.index!==-1;)s.unshift(a),a=a.parent;n[o]=s}let r=null;for(let o=0;;++o){let s=n[t[0]];if(o>=s.length)return r;const a=s[o];for(let l=1;l<t.length;++l)if(s=n[t[l]],o>=s.length||a!==s[o])return r;r=a}}_loadBone(e,t,n,r){e._isJoint=!0;let o=r[e.index];if(o)return o;let s=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?s=this._loadBone(e.parent,t,n,r):t.skeleton!==void 0&&Me.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return o=new Fn(e.name||`joint${e.index}`,n,s,this._getNodeMatrix(e),null,null,a),r[e.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(e._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const n=pe.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)}_updateBoneMatrices(e,t){for(const n of e.bones){const r=rt.Identity(),o=n._index;t&&o!==-1&&(rt.FromArrayToRef(t,o*16,r),r.invertToRef(r));const s=n.getParent();s&&r.multiplyToRef(s.getAbsoluteInverseBindMatrix(),r),n.updateMatrix(r,!1,!1),n._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?rt.FromArray(e.matrix):rt.Compose(e.scale?Q.FromArray(e.scale):Q.One(),e.rotation?it.FromArray(e.rotation):it.Identity(),e.translation?Q.FromArray(e.translation):Q.Zero())}loadCameraAsync(e,t,n=()=>{}){const r=this._extensionsLoadCameraAsync(e,t,n);if(r)return r;const o=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new qs(t.name||`camera${t.index}`,Q.Zero(),this._babylonScene,!1);switch(s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonCamera=s,s.setTarget(new Q(0,0,-1)),t.type){case"perspective":{const a=t.perspective;if(!a)throw new Error(`${e}: Camera perspective properties are missing`);s.fov=a.yfov,s.minZ=a.znear,s.maxZ=a.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);s.mode=Qo.ORTHOGRAPHIC_CAMERA,s.orthoLeft=-t.orthographic.xmag,s.orthoRight=t.orthographic.xmag,s.orthoBottom=-t.orthographic.ymag,s.orthoTop=t.orthographic.ymag,s.minZ=t.orthographic.znear,s.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return we.AddPointerMetadata(s,e),this._parent.onCameraLoadedObservable.notifyObservers(s),n(s),this.logClose(),Promise.all(o).then(()=>s)}_loadAnimationsAsync(){this._parent._startPerformanceCounter("Load animations");const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let n=0;n<e.length;n++){const r=e[n];t.push(this.loadAnimationAsync(`/animations/${r.index}`,r).then(o=>{o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Load animations")})}loadAnimationAsync(e,t){this._parent._startPerformanceCounter("Load animation");const n=this._extensionsLoadAnimationAsync(e,t);return n||qi.value.then(({AnimationGroup:r})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new r(t.name||`animation${t.index}`,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=o;const s=new Array;pe.Assign(t.channels),pe.Assign(t.samplers);for(const a of t.channels)s.push(this._loadAnimationChannelAsync(`${e}/channels/${a.index}`,e,t,a,(l,h)=>{l.animations=l.animations||[],l.animations.push(h),o.addTargetedAnimation(h,l)}));return this._parent._endPerformanceCounter("Load animation"),Promise.all(s).then(()=>(o.normalize(0),o))})}_loadAnimationChannelAsync(e,t,n,r,o){const s=this._extensionsLoadAnimationChannelAsync(e,t,n,r,o);if(s)return s;if(r.target.node==null)return Promise.resolve();const a=pe.Get(`${e}/target/node`,this._gltf.nodes,r.target.node),l=r.target.path,h=l==="weights";return h&&!a._numMorphTargets||!h&&!a._babylonTransformNode||!this._parent.loadNodeAnimations&&!h&&!a._isJoint?Promise.resolve():Ki.value.then(()=>{var d,p,f,g;let u;switch(l){case"translation":{u=(d=Yn("/nodes/{}/translation"))==null?void 0:d.interpolation;break}case"rotation":{u=(p=Yn("/nodes/{}/rotation"))==null?void 0:p.interpolation;break}case"scale":{u=(f=Yn("/nodes/{}/scale"))==null?void 0:f.interpolation;break}case"weights":{u=(g=Yn("/nodes/{}/weights"))==null?void 0:g.interpolation;break}default:throw new Error(`${e}/target/path: Invalid value (${r.target.path})`)}if(!u)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${r.target.path})`);const c={object:a,info:u};return this._loadAnimationChannelFromTargetInfoAsync(e,t,n,r,c,o)})}_loadAnimationChannelFromTargetInfoAsync(e,t,n,r,o,s){const a=this.parent.targetFps,l=1/a,h=pe.Get(`${e}/sampler`,n.samplers,r.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${r.sampler}`,h).then(u=>{let c=0;const d=o.object,p=o.info;for(const f of p){const g=f.getStride(d),y=u.input,m=u.output,_=new Array(y.length);let b=0;switch(u.interpolation){case"STEP":{for(let v=0;v<y.length;v++){const w=f.getValue(d,m,b,1);b+=g,_[v]={frame:y[v]*a,value:w,interpolation:1}}break}case"CUBICSPLINE":{for(let v=0;v<y.length;v++){const w=f.getValue(d,m,b,l);b+=g;const I=f.getValue(d,m,b,1);b+=g;const V=f.getValue(d,m,b,l);b+=g,_[v]={frame:y[v]*a,inTangent:w,value:I,outTangent:V}}break}case"LINEAR":{for(let v=0;v<y.length;v++){const w=f.getValue(d,m,b,1);b+=g,_[v]={frame:y[v]*a,value:w}}break}}if(b>0){const v=`${n.name||`animation${n.index}`}_channel${r.index}_${c}`,w=f.buildAnimations(d,v,a,_);for(const I of w)c++,s(I.babylonAnimatable,I.babylonAnimation)}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const r=pe.Get(`${e}/input`,this._gltf.accessors,t.input),o=pe.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${r.index}`,r),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([s,a])=>({input:s,interpolation:n,output:a})),t._data}loadBufferAsync(e,t,n,r){const o=this._extensionsLoadBufferAsync(e,t,n,r);if(o)return o;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(s=>{try{return new Uint8Array(s.buffer,s.byteOffset+n,r)}catch(a){throw new Error(`${e}: ${a.message}`)}})}loadBufferViewAsync(e,t){const n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;const r=pe.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${r.index}`,r,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,n){if(t._data)return t._data;const r=we._GetNumComponents(e,t.type),o=r*Ie.GetTypeByteLength(t.componentType),s=r*t.count;if(t.bufferView==null)t._data=Promise.resolve(new n(s));else{const a=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then(l=>{if(t.componentType===5126&&!t.normalized&&(!a.byteStride||a.byteStride===o))return we._GetTypedArray(e,t.componentType,l,t.byteOffset,s);{const h=new n(s);return Ie.ForEach(l,t.byteOffset||0,a.byteStride||o,r,t.componentType,h.length,t.normalized||!1,(u,c)=>{h[c]=u}),h}})}if(t.sparse){const a=t.sparse;t._data=t._data.then(l=>{const h=l,u=pe.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,a.indices.bufferView),c=pe.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,a.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${u.index}`,u),this.loadBufferViewAsync(`/bufferViews/${c.index}`,c)]).then(([d,p])=>{const f=we._GetTypedArray(`${e}/sparse/indices`,a.indices.componentType,d,a.indices.byteOffset,a.count),g=r*a.count;let y;if(t.componentType===5126&&!t.normalized)y=we._GetTypedArray(`${e}/sparse/values`,t.componentType,p,a.values.byteOffset,g);else{const _=we._GetTypedArray(`${e}/sparse/values`,t.componentType,p,a.values.byteOffset,g);y=new n(g),Ie.ForEach(_,0,o,r,t.componentType,y.length,t.normalized||!1,(b,v)=>{y[v]=b})}let m=0;for(let _=0;_<f.length;_++){let b=f[_]*r;for(let v=0;v<r;v++)h[b++]=y[m++]}return h})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const n=we._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,n)}else{const n=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n).then(r=>we._GetTypedArray(e,t.componentType,r,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(n=>new kr(t,n,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,n){var o;if((o=t._babylonVertexBuffer)!=null&&o[n])return t._babylonVertexBuffer[n];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse||t.bufferView==null)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then(s=>new Ie(r,s,n,!1));else{const s=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(s).then(a=>{const l=we._GetNumComponents(e,t.type);return new Ie(r,a,n,!1,void 0,s.byteStride,void 0,t.byteOffset,l,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[n]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,n){const r=new Array,o=this._getOrCreateMaterialAdapter(n);return t&&(t.baseColorFactor?(o.baseColor=ie.FromArray(t.baseColorFactor),o.geometryOpacity=t.baseColorFactor[3]):o.baseColor=ie.White(),o.baseMetalness=t.metallicFactor==null?1:t.metallicFactor,o.specularRoughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&r.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,s=>{s.name=`${n.name} (Base Color)`,o.baseColorTexture=s})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,s=>{s.name=`${n.name} (Metallic Roughness)`,o.baseMetalnessTexture=s,o.specularRoughnessTexture=s})),o.useRoughnessFromMetallicTextureGreen=!0,o.useMetallicFromMetallicTextureBlue=!0)),Promise.all(r).then(()=>{})}_loadMaterialAsync(e,t,n,r,o=()=>{}){const s=this._extensionsLoadMaterialAsync(e,t,n,r,o);if(s)return s;t._data=t._data||{};let a=t._data[r];if(!a){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,r);a={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[r]=a,we.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return n&&(a.babylonMeshes.push(n),n.onDisposeObservable.addOnce(()=>{const l=a.babylonMeshes.indexOf(n);l!==-1&&a.babylonMeshes.splice(l,1)})),o(a.babylonMaterial),a.promise.then(()=>a.babylonMaterial)}_createDefaultMaterial(e,t){if(!this._pbrMaterialImpl)throw new Error("PBR Material class not loaded");this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new this._pbrMaterialImpl.materialClass(e,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE;const r=this._getOrCreateMaterialAdapter(n);return r.transparencyAsAlphaCoverage=this._parent.transparencyAsCoverage,r.baseMetalness=1,r.specularRoughness=1,n}createMaterial(e,t,n){const r=this._extensionsCreateMaterial(e,t,n);if(r)return r;const o=t.name||`material${t.index}`;return this._createDefaultMaterial(o,n)}loadMaterialPropertiesAsync(e,t,n){const r=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(r)return r;const o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,n){const r=new Array,o=this._getOrCreateMaterialAdapter(n);o.emissionColor=t.emissiveFactor?ie.FromArray(t.emissiveFactor):new ie(0,0,0),t.doubleSided&&(o.backFaceCulling=!1,o.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,h=>{var u;h.name=`${n.name} (Normal)`,o.geometryNormalTexture=h,((u=t.normalTexture)==null?void 0:u.scale)!=null&&(h.level=t.normalTexture.scale)})),o.setNormalMapInversions(!this._babylonScene.useRightHandedSystem,this._babylonScene.useRightHandedSystem));let s,a=1,l;return t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,h=>{h.name=`${n.name} (Occlusion)`,s=h})),t.occlusionTexture.strength!=null&&(a=t.occlusionTexture.strength)),t.emissiveTexture&&r.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,h=>{h.name=`${n.name} (Emissive)`,l=h})),Promise.all(r).then(()=>{s&&(o.ambientOcclusionTexture=s,o.ambientOcclusionTextureStrength=a),l&&(o.emissionColorTexture=l)})}loadMaterialAlphaProperties(e,t,n){if(!this._pbrMaterialImpl)throw new Error(`${e}: Material type not supported`);const r=this._getOrCreateMaterialAdapter(n),o=r.baseColorTexture;switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE,n.alpha=1;break}case"MASK":{n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHATEST,r.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,o&&(o.hasAlpha=!0);break}case"BLEND":{n.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHABLEND,o&&(o.hasAlpha=!0,r.useAlphaFromBaseColorTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,n=()=>{}){const r=this._extensionsLoadTextureInfoAsync(e,t,n);if(r)return r;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const o=pe.Get(`${e}/index`,this._gltf.textures,t.index);o._textureInfo=t;const s=this._loadTextureAsync(`/textures/${t.index}`,o,a=>{a.coordinatesIndex=t.texCoord||0,we.AddPointerMetadata(a,e),this._parent.onTextureLoadedObservable.notifyObservers(a),n(a)});return this.logClose(),s}_loadTextureAsync(e,t,n=()=>{}){const r=this._extensionsLoadTextureAsync(e,t,n);if(r)return r;this.logOpen(`${e} ${t.name||""}`);const o=t.sampler==null?we.DefaultSampler:pe.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),s=pe.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,o,s,n,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,n,r=()=>{},o,s){const a=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,h=new Ln;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(d,p)=>{this._disposed||h.reject(new Error(`${e}: ${p&&p.message?p.message:d||"Failed to load texture"}`))},mimeType:n.mimeType??Vr(n.uri??""),loaderOptions:o,useSRGBBuffer:!!s&&this._parent.useSRGBBuffers},c=new We(null,this._babylonScene,u);return c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(h.promise),l.push(this.loadImageAsync(`/images/${n.index}`,n).then(d=>{const p=n.uri||`${this._fileName}#image${n.index}`,f=`data:${this._uniqueRootUrl}${p}`;c.updateURL(f,d);const g=c.getInternalTexture();g&&(g.label=n.name)})),c.wrapU=a.wrapU,c.wrapV=a.wrapV,r(c),this._parent.useGltfTextureNames&&(c.name=n.name||n.uri||`image${n.index}`),Promise.all(l).then(()=>c)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:we._GetTextureSamplingMode(e,t),wrapU:we._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:we._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const n=pe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}this.logClose()}return t._data}loadUriAsync(e,t,n){const r=this._extensionsLoadUriAsync(e,t,n);if(r)return r;if(!we._ValidateUri(n))throw new Error(`${e}: '${n}' is invalid`);if(Dr(n)){const o=new Uint8Array(jo(n));return this.log(`${e}: Decoded ${n.substring(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${e}: Loading ${n}`),this._parent.preprocessUrlAsync(this._rootUrl+n).then(o=>new Promise((s,a)=>{this._parent._loadFile(this._babylonScene,o,l=>{this._disposed||(this.log(`${e}: Loaded ${n} (${l.byteLength} bytes)`),s(new Uint8Array(l)))},!0,l=>{a(new Gr(`${e}: Failed to load '${n}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const n=e._internalMetadata=e._internalMetadata||{},r=n.gltf=n.gltf||{};(r.pointers=r.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return We.CLAMP_ADDRESSMODE;case 33648:return We.MIRROR_ADDRESSMODE;case 10497:return We.WRAP_ADDRESSMODE;default:return Me.Warn(`${e}: Invalid value (${t})`),We.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const n=t.magFilter==null?9729:t.magFilter,r=t.minFilter==null?9987:t.minFilter;if(n===9729)switch(r){case 9728:return We.LINEAR_NEAREST;case 9729:return We.LINEAR_LINEAR;case 9984:return We.LINEAR_NEAREST_MIPNEAREST;case 9985:return We.LINEAR_LINEAR_MIPNEAREST;case 9986:return We.LINEAR_NEAREST_MIPLINEAR;case 9987:return We.LINEAR_LINEAR_MIPLINEAR;default:return Me.Warn(`${e}/minFilter: Invalid value (${r})`),We.LINEAR_LINEAR_MIPLINEAR}else switch(n!==9728&&Me.Warn(`${e}/magFilter: Invalid value (${n})`),r){case 9728:return We.NEAREST_NEAREST;case 9729:return We.NEAREST_LINEAR;case 9984:return We.NEAREST_NEAREST_MIPNEAREST;case 9985:return We.NEAREST_LINEAR_MIPNEAREST;case 9986:return We.NEAREST_NEAREST_MIPLINEAR;case 9987:return We.NEAREST_LINEAR_MIPLINEAR;default:return Me.Warn(`${e}/minFilter: Invalid value (${r})`),We.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return $r(t)}catch(n){throw new Error(`${e}: ${n.message}`)}}static _GetTypedArray(e,t,n,r,o){const s=n.buffer;r=n.byteOffset+(r||0);const a=we._GetTypedArrayConstructor(`${e}/componentType`,t),l=Ie.GetTypeByteLength(t);return r%l!==0?(Me.Warn(`${e}: Copying buffer as byte offset (${r}) is not a multiple of component type byte length (${l})`),new a(s.slice(r,r+o*l),0)):new a(s,r,o)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return ke.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return Ft.PointListDrawMode;case 1:return Ft.LineListDrawMode;case 2:return Ft.LineLoopDrawMode;case 3:return Ft.LineStripDrawMode;case 4:return Ft.TriangleFillMode;case 5:return Ft.TriangleStripDrawMode;case 6:return Ft.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const n in t._data){const r=t._data[n];for(const o of r.babylonMeshes){o.computeWorldMatrix(!0);const s=r.babylonMaterial;e.push(s.forceCompilationAsync(o)),e.push(s.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(e.push(s.forceCompilationAsync(o,{clipPlane:!0})),e.push(s.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const n of t){const r=n.getShadowGenerator();r&&e.push(r.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,n){for(const r of this._extensions)if(r.enabled){const o=`${r.name}.${t}`,s=e;s._activeLoaderExtensionFunctions=s._activeLoaderExtensionFunctions||{};const a=s._activeLoaderExtensionFunctions;if(!a[o]){a[o]=!0;try{const l=n(r);if(l)return l}finally{delete a[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",n=>n.loadSceneAsync&&n.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,n){return this._applyExtensions(t,"loadNode",r=>r.loadNodeAsync&&r.loadNodeAsync(e,t,n))}_extensionsLoadCameraAsync(e,t,n){return this._applyExtensions(t,"loadCamera",r=>r.loadCameraAsync&&r.loadCameraAsync(e,t,n))}_extensionsLoadVertexDataAsync(e,t,n){return this._applyExtensions(t,"loadVertexData",r=>r._loadVertexDataAsync&&r._loadVertexDataAsync(e,t,n))}_extensionsLoadMeshPrimitiveAsync(e,t,n,r,o,s){return this._applyExtensions(o,"loadMeshPrimitive",a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,n,r,o,s))}_extensionsLoadMaterialAsync(e,t,n,r,o){return this._applyExtensions(t,"loadMaterial",s=>s._loadMaterialAsync&&s._loadMaterialAsync(e,t,n,r,o))}_extensionsCreateMaterial(e,t,n){return this._applyExtensions(t,"createMaterial",r=>r.createMaterial&&r.createMaterial(e,t,n))}_extensionsLoadMaterialPropertiesAsync(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",r=>r.loadMaterialPropertiesAsync&&r.loadMaterialPropertiesAsync(e,t,n))}_extensionsLoadTextureInfoAsync(e,t,n){return this._applyExtensions(t,"loadTextureInfo",r=>r.loadTextureInfoAsync&&r.loadTextureInfoAsync(e,t,n))}_extensionsLoadTextureAsync(e,t,n){return this._applyExtensions(t,"loadTexture",r=>r._loadTextureAsync&&r._loadTextureAsync(e,t,n))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",n=>n.loadAnimationAsync&&n.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,n,r,o){return this._applyExtensions(n,"loadAnimationChannel",s=>s._loadAnimationChannelAsync&&s._loadAnimationChannelAsync(e,t,n,r,o))}_extensionsLoadSkinAsync(e,t,n){return this._applyExtensions(n,"loadSkin",r=>r._loadSkinAsync&&r._loadSkinAsync(e,t,n))}_extensionsLoadUriAsync(e,t,n){return this._applyExtensions(t,"loadUri",r=>r._loadUriAsync&&r._loadUriAsync(e,t,n))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",n=>n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,n,r){return this._applyExtensions(t,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(e,t,n,r))}static LoadExtensionAsync(e,t,n,r){if(!t.extensions)return null;const s=t.extensions[n];return s?r(`${e}/extensions/${n}`,s):null}static LoadExtraAsync(e,t,n,r){if(!t.extras)return null;const s=t.extras[n];return s?r(`${e}/extras/${n}`,s):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}we.DefaultSampler={index:-1};pt._CreateGLTF2Loader=i=>new we(i);function so(i,e,t,n){return Q.FromArray(e,t).scaleInPlace(n)}function gr(i,e,t,n){return it.FromArray(e,t).scaleInPlace(n)}function vr(i,e,t,n){const r=new Array(i._numMorphTargets);for(let o=0;o<r.length;o++)r[o]=e[t++]*n;return r}class En{constructor(e,t,n,r){this.type=e,this.name=t,this.getValue=n,this.getStride=r}_buildAnimation(e,t,n){const r=new ve(e,this.name,t,this.type);return r.setKeys(n,!0),r}}class Ds extends En{buildAnimations(e,t,n,r){const o=[];return o.push({babylonAnimatable:e._babylonTransformNode,babylonAnimation:this._buildAnimation(t,n,r)}),o}}class _r extends En{buildAnimations(e,t,n,r){const o=[];if(e._numMorphTargets)for(let s=0;s<e._numMorphTargets;s++){const a=new ve(`${t}_${s}`,this.name,n,this.type);if(a.setKeys(r.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[s]:void 0,value:l.value[s],outTangent:l.outTangent?l.outTangent[s]:void 0,interpolation:l.interpolation})),!0),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const h=l.morphTargetManager.getTarget(s),u=a.clone();h.animations.push(u),o.push({babylonAnimatable:h,babylonAnimation:u})}}}return o}}X("/nodes/{}/translation",[new Ds(ve.ANIMATIONTYPE_VECTOR3,"position",so,()=>3)]);X("/nodes/{}/rotation",[new Ds(ve.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",gr,()=>4)]);X("/nodes/{}/scale",[new Ds(ve.ANIMATIONTYPE_VECTOR3,"scaling",so,()=>3)]);X("/nodes/{}/weights",[new _r(ve.ANIMATIONTYPE_FLOAT,"influence",vr,i=>i._numMorphTargets)]);const ji=Object.freeze(Object.defineProperty({__proto__:null,AnimationPropertyInfo:En,TransformNodeAnimationPropertyInfo:Ds,WeightAnimationPropertyInfo:_r,getQuaternion:gr,getVector3:so,getWeights:vr},Symbol.toStringTag,{value:"Module"})),ts="EXT_lights_image_based";class Yi{constructor(e){this.name=ts,this._loader=e,this.enabled=this._loader.isExtensionUsed(ts)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return we.LoadExtensionAsync(e,t,this.name,async(n,r)=>{this._loader._allMaterialsDirtyRequired=!0;const o=new Array;o.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${n}`);const s=pe.Get(`${n}/light`,this._lights,r.light);return o.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,s).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),await Promise.all(o).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const n=new Array;this._loader.logOpen(`${e}`);const r=new Array(t.specularImages.length);for(let o=0;o<t.specularImages.length;o++){const s=t.specularImages[o];r[o]=new Array(s.length);for(let a=0;a<s.length;a++){const l=`${e}/specularImages/${o}/${a}`;this._loader.logOpen(`${l}`);const h=s[a],u=pe.Get(l,this._loader.gltf.images,h);n.push(this._loader.loadImageAsync(`/images/${h}`,u).then(c=>{r[o][a]=c})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then(async()=>{const o=new zr(this._loader.babylonScene,null,t.specularImageSize);if(o.name=t.name||"environment",t._babylonTexture=o,t.intensity!=null&&(o.level=t.intensity),t.rotation){let h=it.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(h=it.Inverse(h)),rt.FromQuaternionToRef(h,o.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const s=Ur.FromArray(t.irradianceCoefficients);s.scaleInPlace(t.intensity),s.convertIrradianceToLambertianRadiance();const a=Wr.FromHarmonics(s),l=(r.length-1)/Math.log2(t.specularImageSize);return await o.updateRGBDAsync(r,a,l)})}return t._loaded.then(()=>t._babylonTexture)}}Ne(ts);Re(ts,!0,i=>new Yi(i));const ns="EXT_mesh_gpu_instancing";class Xi{constructor(e){this.name=ns,this._loader=e,this.enabled=this._loader.isExtensionUsed(ns)}dispose(){this._loader=null}loadNodeAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{this._loader._disableInstancedMesh++;const s=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,n);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return await s;const a=new Array;let l=0;const h=u=>{if(o.attributes[u]==null){a.push(Promise.resolve(null));return}const c=pe.Get(`${r}/attributes/${u}`,this._loader.gltf.accessors,o.attributes[u]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${c.bufferView}`,c)),l===0)l=c.count;else if(l!==c.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return h("TRANSLATION"),h("ROTATION"),h("SCALE"),h("_COLOR_0"),await s.then(async u=>{const[c,d,p,f]=await Promise.all(a),g=new Float32Array(l*16);Ot.Vector3[0].copyFromFloats(0,0,0),Ot.Quaternion[0].copyFromFloats(0,0,0,1),Ot.Vector3[1].copyFromFloats(1,1,1);for(let y=0;y<l;++y)c&&Q.FromArrayToRef(c,y*3,Ot.Vector3[0]),d&&it.FromArrayToRef(d,y*4,Ot.Quaternion[0]),p&&Q.FromArrayToRef(p,y*3,Ot.Vector3[1]),rt.ComposeToRef(Ot.Vector3[1],Ot.Quaternion[0],Ot.Vector3[0],Ot.Matrix[0]),Ot.Matrix[0].copyToArray(g,y*16);for(const y of t._primitiveBabylonMeshes)y.thinInstanceSetBuffer("matrix",g,16,!0),f&&(f.length===l*3?y.thinInstanceSetBuffer("color",f,3,!0):f.length===l*4?y.thinInstanceSetBuffer("color",f,4,!0):Me.Warn("Unexpected size of _COLOR_0 attribute for mesh "+y.name));return u})})}}Ne(ns);Re(ns,!0,i=>new Xi(i));const ss="EXT_meshopt_compression";class Qi{constructor(e){this.name=ss,this.enabled=e.isExtensionUsed(ss),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return we.LoadExtensionAsync(e,t,this.name,async(n,r)=>{const o=t;if(o._meshOptData)return await o._meshOptData;const s=pe.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return o._meshOptData=this._loader.loadBufferAsync(`/buffers/${s.index}`,s,r.byteOffset||0,r.byteLength).then(async a=>await qr.Default.decodeGltfBufferAsync(a,r.count,r.byteStride,r.mode,r.filter)),await o._meshOptData})}}Ne(ss);Re(ss,!0,i=>new Qi(i));const os="EXT_texture_webp";class Zi{constructor(e){this.name=os,this._loader=e,this.enabled=e.isExtensionUsed(os)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=t.sampler==null?we.DefaultSampler:pe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=pe.Get(`${r}/source`,this._loader.gltf.images,o.source);return await this._loader._createTextureAsync(e,s,a,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}Ne(os);Re(os,!0,i=>new Zi(i));const rs="EXT_texture_avif";class Ji{constructor(e){this.name=rs,this._loader=e,this.enabled=e.isExtensionUsed(rs)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=t.sampler==null?we.DefaultSampler:pe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=pe.Get(`${r}/source`,this._loader.gltf.images,o.source);return await this._loader._createTextureAsync(e,s,a,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}Ne(rs);Re(rs,!0,i=>new Ji(i));const is="EXT_lights_ies";class ea{constructor(e){this.name=is,this._loader=e,this.enabled=this._loader.isExtensionUsed(is)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,pe.Assign(this._lights)}}loadNodeAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{this._loader._allMaterialsDirtyRequired=!0;let s,a;const l=await this._loader.loadNodeAsync(e,t,u=>{a=pe.Get(r,this._lights,o.light);const c=a.name||u.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,s=new zt(c,Q.Zero(),Q.Backward(),0,1,this._loader.babylonScene),s.angle=Math.PI/2,s.innerAngle=0,s._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,a._babylonLight=s,s.falloffType=eo.FALLOFF_GLTF,s.diffuse=o.color?ie.FromArray(o.color):ie.White(),s.intensity=o.multiplier||1,s.range=Number.MAX_VALUE,s.parent=u,this._loader._babylonLights.push(s),we.AddPointerMetadata(s,r),n(u)});let h;if(a.uri)h=await this._loader.loadUriAsync(e,a,a.uri);else{const u=pe.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,a.bufferView);h=await this._loader.loadBufferViewAsync(`/bufferViews/${u.index}`,u)}return s.iesProfileTexture=new We(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,h,!0,void 0,void 0,void 0,void 0,".ies"),l})}}Ne(is);Re(is,!0,i=>new ea(i));const as="KHR_draco_mesh_compression";class ta{constructor(e){this.name=as,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=Po.DefaultAvailable&&this._loader.isExtensionUsed(as)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);const s={},a={},l=(u,c)=>{const d=o.attributes[u];if(d!=null&&(n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(c)===-1&&n._delayInfo.push(c),s[c]=d,this.useNormalizedFlagFromAccessor)){const p=pe.TryGet(this._loader.gltf.accessors,t.attributes[u]);p&&(a[c]=p.normalized||!1)}};l("POSITION",Ie.PositionKind),l("NORMAL",Ie.NormalKind),l("TANGENT",Ie.TangentKind),l("TEXCOORD_0",Ie.UVKind),l("TEXCOORD_1",Ie.UV2Kind),l("TEXCOORD_2",Ie.UV3Kind),l("TEXCOORD_3",Ie.UV4Kind),l("TEXCOORD_4",Ie.UV5Kind),l("TEXCOORD_5",Ie.UV6Kind),l("JOINTS_0",Ie.MatricesIndicesKind),l("WEIGHTS_0",Ie.MatricesWeightsKind),l("COLOR_0",Ie.ColorKind);const h=pe.Get(r,this._loader.gltf.bufferViews,o.bufferView);return h._dracoBabylonGeometry||(h._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${h.index}`,h).then(async u=>{const c=this.dracoDecoder||Po.Default,d=pe.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),p=!this._loader.parent.alwaysComputeBoundingBox&&!n.skeleton&&d?yr(d):null;return await c._decodeMeshToGeometryForGltfAsync(n.name,this._loader.babylonScene,u,s,a,p).catch(f=>{throw new Error(`${e}: ${f.message}`)})})),await h._dracoBabylonGeometry})}}Ne(as);Re(as,!0,i=>new ta(i));const ls="KHR_lights_punctual";class na{constructor(e){this.name=ls,this._loader=e,this.enabled=this._loader.isExtensionUsed(ls)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,pe.Assign(this._lights)}}loadNodeAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(e,t,s=>{let a;const l=pe.Get(r,this._lights,o.light),h=l.name||s.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const u=new ks(h,Q.Backward(),this._loader.babylonScene);u.position.setAll(0),a=u;break}case"point":{a=new Js(h,Q.Zero(),this._loader.babylonScene);break}case"spot":{const u=new zt(h,Q.Zero(),Q.Backward(),0,1,this._loader.babylonScene);u.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,u.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=u;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=eo.FALLOFF_GLTF,a.diffuse=l.color?ie.FromArray(l.color):ie.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=s,this._loader._babylonLights.push(a),we.AddPointerMetadata(a,r),n(s)})))}}Ne(ls);Re(ls,!0,i=>new na(i));const cs="EXT_lights_area";class sa{constructor(e){this.name=cs,this._loader=e,this.enabled=this._loader.isExtensionUsed(cs)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,pe.Assign(this._lights)}}loadNodeAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(e,t,s=>{var d;let a;const l=pe.Get(r,this._lights,o.light),h=l.name||s.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer;const u=l.size!==void 0?l.size:1;switch(l.type){case"rect":{const p=((d=l.rect)==null?void 0:d.aspect)!==void 0?l.rect.aspect*u:u,f=u;a=new Io(h,Q.Zero(),p,f,this._loader.babylonScene);break}case"disk":{const p=Math.sqrt(u*u*.25*Math.PI);a=new Io(h,Q.Zero(),p,p,this._loader.babylonScene);break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid area light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=eo.FALLOFF_GLTF,a.diffuse=l.color?ie.FromArray(l.color):ie.White(),a.intensity=l.intensity==null?1:l.intensity;const c=new Nn(`${h}_orientation`,this._loader.babylonScene);c.rotationQuaternion=it.RotationAxis(Q.Up(),Math.PI),c.parent=s,a.parent=c,this._loader._babylonLights.push(a),we.AddPointerMetadata(a,r),n(s)})))}}Ne(cs);Re(cs,!0,i=>new sa(i));const us="KHR_materials_pbrSpecularGlossiness";class oa{constructor(e){this.name=us,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(us)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),s.push(this._loadSpecularGlossinessPropertiesAsync(r,o,n)),this._loader.loadMaterialAlphaProperties(e,t,n),await Promise.all(s).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,n){if(!(n instanceof ct))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.metallic=null,n.roughness=null,t.diffuseFactor?(n.albedoColor=ie.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=ie.White(),n.reflectivityColor=t.specularFactor?ie.FromArray(t.specularFactor):ie.White(),n.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,o=>{o.name=`${n.name} (Diffuse)`,n.albedoTexture=o})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,o=>{o.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=o,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}}Ne(us);Re(us,!0,i=>new oa(i));const hs="KHR_materials_unlit";class ra{constructor(e){this.name=hs,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(hs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async()=>await this._loadUnlitPropertiesAsync(e,t,n))}_loadUnlitPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array,s=t.pbrMetallicRoughness;return s&&(s.baseColorFactor&&(r.baseColor=ie.FromArray(s.baseColorFactor),r.geometryOpacity=s.baseColorFactor[3]),s.baseColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,s.baseColorTexture,a=>{a.name=`${n.name} (Base Color)`,r.baseColorTexture=a}))),r.isUnlit=!0,t.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then(()=>{})}}Ne(hs);Re(hs,!0,i=>new ra(i));const ds="KHR_materials_clearcoat";class ia{constructor(e){this.name=ds,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ds)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadClearCoatPropertiesAsync(r,o,n)),await Promise.all(s)})}_loadClearCoatPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.configureCoat(),r.coatWeight=t.clearcoatFactor!==void 0?t.clearcoatFactor:0,r.coatRoughness=t.clearcoatRoughnessFactor!==void 0?t.clearcoatRoughnessFactor:0,t.clearcoatTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,s=>{s.name=`${n.name} (ClearCoat)`,r.coatWeightTexture=s})),t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,s=>{s.name=`${n.name} (ClearCoat Roughness)`,r.coatRoughnessTexture=s}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,s=>{var a;s.name=`${n.name} (ClearCoat Normal)`,r.geometryCoatNormalTexture=s,((a=t.clearcoatNormalTexture)==null?void 0:a.scale)!=null&&(r.geometryCoatNormalTextureScale=t.clearcoatNormalTexture.scale)})),r.setNormalMapInversions(!n.getScene().useRightHandedSystem,n.getScene().useRightHandedSystem)),Promise.all(o).then(()=>{})}}Ne(ds);Re(ds,!0,i=>new ia(i));const ps="KHR_materials_coat";class aa{constructor(e){this.name=ps,this.order=191,this.useOpenPBR=!1,this._loader=e,this.enabled=this._loader.isExtensionUsed(ps)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),t.extensions&&t.extensions.KHR_materials_openpbr&&(this.useOpenPBR=!0),s.push(this._loadCoatPropertiesAsync(r,o,n)),await Promise.all(s)})}_loadCoatPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;r.configureCoat(),r.coatWeight=t.coatFactor!==void 0?t.coatFactor:0,r.coatRoughness=t.coatRoughnessFactor!==void 0?t.coatRoughnessFactor:0,t.coatTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/coatTexture`,t.coatTexture,h=>{h.name=`${n.name} (Coat)`,r.coatWeightTexture=h})),t.coatRoughnessTexture&&(t.coatRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/coatRoughnessTexture`,t.coatRoughnessTexture,h=>{h.name=`${n.name} (Coat Roughness)`,r.coatRoughnessTexture=h}))),t.coatNormalTexture&&(t.coatNormalTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/coatNormalTexture`,t.coatNormalTexture,h=>{var u;h.name=`${n.name} (Coat Normal)`,r.geometryCoatNormalTexture=h,((u=t.coatNormalTexture)==null?void 0:u.scale)!=null&&(r.geometryCoatNormalTextureScale=t.coatNormalTexture.scale)})),r.setNormalMapInversions(!n.getScene().useRightHandedSystem,n.getScene().useRightHandedSystem)),r.coatDarkening=t.coatDarkeningFactor!==void 0?t.coatDarkeningFactor:1,r.coatIor=t.coatIor!==void 0?t.coatIor:1.5;const s=ie.White();t.coatColorFactor!==void 0&&s.fromArray(t.coatColorFactor),r.coatColor=s,t.coatColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/coatColorTexture`,t.coatColorTexture,h=>{h.name=`${n.name} (Coat Color)`,r.coatColorTexture=h}));const a=t.coatAnisotropyStrength??0,l=t.coatAnisotropyRotation??0;return r.coatRoughnessAnisotropy=a,r.geometryCoatTangentAngle=l,this.useOpenPBR||r.configureGltfStyleAnisotropy(!0),t.coatAnisotropyTexture&&(t.coatAnisotropyTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/coatAnisotropyTexture`,t.coatAnisotropyTexture,h=>{h.name=`${n.name} (Coat Anisotropy)`,r.geometryCoatTangentTexture=h}))),Promise.all(o).then(()=>{})}}Ne(ps);Re(ps,!0,i=>new aa(i));const fs="KHR_materials_iridescence";class la{constructor(e){this.name=fs,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(fs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadIridescencePropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.thinFilmWeight=t.iridescenceFactor??0,r.thinFilmIor=t.iridescenceIor??t.iridescenceIOR??1.3,r.thinFilmThicknessMinimum=t.iridescenceThicknessMinimum??100,r.thinFilmThicknessMaximum=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,s=>{s.name=`${n.name} (Iridescence)`,r.thinFilmWeightTexture=s})),t.iridescenceThicknessTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,s=>{s.name=`${n.name} (Iridescence Thickness)`,r.thinFilmThicknessTexture=s})),Promise.all(o).then(()=>{})}}Ne(fs);Re(fs,!0,i=>new la(i));const ms="KHR_materials_anisotropy";class ca{constructor(e){this.name=ms,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(ms)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadAnisotropyPropertiesAsync(r,o,n)),await Promise.all(s)})}async _loadAnisotropyPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array,s=t.anisotropyStrength??0,a=t.anisotropyRotation??0;r.specularRoughnessAnisotropy=s,r.geometryTangentAngle=a;const l=t.extensions??{};(!l.EXT_materials_anisotropy_openpbr||!l.EXT_materials_anisotropy_openpbr.openPbrAnisotropyEnabled)&&r.configureGltfStyleAnisotropy(!0),t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,h=>{h.name=`${n.name} (Anisotropy Intensity)`,r.geometryTangentTexture=h}))),await Promise.all(o)}}Ne(ms);Re(ms,!0,i=>new ca(i));const ys="KHR_materials_emissive_strength";class ua{constructor(e){this.name=ys,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(ys)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>(await this._loader.loadMaterialPropertiesAsync(e,t,n),this._loadEmissiveProperties(r,o,n),await Promise.resolve()))}_loadEmissiveProperties(e,t,n){if(t.emissiveStrength!==void 0){const r=this._loader._getOrCreateMaterialAdapter(n);r.emissionLuminance=t.emissiveStrength}}}Ne(ys);Re(ys,!0,i=>new ua(i));const gs="KHR_materials_sheen";class ha{constructor(e){this.name=gs,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(gs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadSheenPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadSheenPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;r.configureFuzz();const s=t.sheenColorFactor!==void 0?ie.FromArray(t.sheenColorFactor):ie.Black(),a=t.sheenRoughnessFactor!==void 0?t.sheenRoughnessFactor:0;return r.fuzzWeight=1,r.fuzzColor=s,r.fuzzRoughness=a,t.sheenColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,l=>{l.name=`${n.name} (Sheen Color)`,r.fuzzColorTexture=l})),t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,l=>{l.name=`${n.name} (Sheen Roughness)`,r.fuzzRoughnessTexture=l}))),Promise.all(o).then(()=>{})}}Ne(gs);Re(gs,!0,i=>new ha(i));const vs="KHR_materials_fuzz";class da{constructor(e){this.name=vs,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(vs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadFuzzPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadFuzzPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.configureFuzz(),r.fuzzWeight=t.fuzzFactor!==void 0?t.fuzzFactor:0,r.fuzzColor=t.fuzzColorFactor!==void 0?ie.FromArray(t.fuzzColorFactor):ie.White(),r.fuzzRoughness=t.fuzzRoughnessFactor!==void 0?t.fuzzRoughnessFactor:.5,t.fuzzTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/fuzzTexture`,t.fuzzTexture,s=>{s.name=`${n.name} (Fuzz)`,r.fuzzWeightTexture=s})),t.fuzzColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/fuzzColorTexture`,t.fuzzColorTexture,s=>{s.name=`${n.name} (Fuzz Color)`,r.fuzzColorTexture=s})),t.fuzzRoughnessTexture&&(t.fuzzRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/fuzzRoughnessTexture`,t.fuzzRoughnessTexture,s=>{s.name=`${n.name} (Fuzz Roughness)`,r.fuzzRoughnessTexture=s}))),Promise.all(o).then(()=>{})}}Ne(vs);Re(vs,!0,i=>new da(i));const _s="KHR_materials_specular";class pa{constructor(e){this.name=_s,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(_s)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadSpecularPropertiesAsync(r,o,n));const a=this._loader._getOrCreateMaterialAdapter(n);return o.extensions&&o.extensions.EXT_materials_specular_edge_color&&o.extensions.EXT_materials_specular_edge_color.specularEdgeColorEnabled&&a.enableSpecularEdgeColor(!0),await Promise.all(s).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.specularWeight=t.specularFactor??1,r.specularColor=t.specularColorFactor!==void 0?ie.FromArray(t.specularColorFactor):new ie(1,1,1),t.specularTexture&&(t.specularTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,s=>{s.name=`${n.name} (Specular)`,r.specularWeightTexture=s}))),t.specularColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,s=>{s.name=`${n.name} (Specular Color)`,r.specularColorTexture=s})),Promise.all(o).then(()=>{})}}Ne(_s);Re(_s,!0,i=>new pa(i));const bs="KHR_materials_ior";class Gs{constructor(e){this.name=bs,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(bs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadIorPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadIorPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=t.ior!==void 0?t.ior:Gs._DEFAULT_IOR;return r.specularIor=o,Promise.resolve()}}Gs._DEFAULT_IOR=1.5;Ne(bs);Re(bs,!0,i=>new Gs(i));const vt="KHR_materials_variants";class Rt{constructor(e){this.name=vt,this._loader=e,this.enabled=this._loader.isExtensionUsed(vt)&&!this._loader.parent.skipMaterials}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return Rt.GetAvailableVariants(e)}static SelectVariant(e,t){const n=this._GetExtensionMetadata(e);if(!n)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${vt} extension`);const r=o=>{const s=n.variants[o];if(s)for(const a of s)a.mesh.material=a.material};if(t instanceof Array)for(const o of t)r(o);else r(t);n.lastSelected=t}selectVariant(e,t){Rt.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${vt} extension`);for(const n of t.original)n.mesh.material=n.material;t.lastSelected=null}reset(e){Rt.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${vt} extension`);return t.lastSelected}getLastSelectedVariant(e){return Rt.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,n;return((n=(t=e==null?void 0:e._internalMetadata)==null?void 0:t.gltf)==null?void 0:n[vt])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}onReady(){var t;const e=this._loader.rootBabylonMesh;if(e){const n=this._loader.parent.extensionOptions[vt];n!=null&&n.defaultVariant&&Rt.SelectVariant(e,n.defaultVariant),(t=n==null?void 0:n.onLoaded)==null||t.call(n,{get variants(){return Rt.GetAvailableVariants(e)},get selectedVariant(){const r=Rt.GetLastSelectedVariant(e);return r?Array.isArray(r)?r[0]:r:Rt.GetAvailableVariants(e)[0]},set selectedVariant(r){Rt.SelectVariant(e,r)}})}}_loadMeshPrimitiveAsync(e,t,n,r,o,s){return we.LoadExtensionAsync(e,o,this.name,async(a,l)=>{const h=new Array;return h.push(this._loader._loadMeshPrimitiveAsync(e,t,n,r,o,u=>{if(s(u),u instanceof xt){const c=we._GetDrawMode(e,o.mode),d=this._loader.rootBabylonMesh,p=d?d._internalMetadata=d._internalMetadata||{}:{},f=p.gltf=p.gltf||{},g=f[vt]=f[vt]||{lastSelected:null,original:[],variants:{}};g.original.push({mesh:u,material:u.material});for(let y=0;y<l.mappings.length;++y){const m=l.mappings[y],_=pe.Get(`${a}/mappings/${y}/material`,this._loader.gltf.materials,m.material);h.push(this._loader._loadMaterialAsync(`#/materials/${m.material}`,_,u,c,b=>{for(let v=0;v<m.variants.length;++v){const w=m.variants[v],I=pe.Get(`/extensions/${vt}/variants/${w}`,this._variants,w);g.variants[I.name]=g.variants[I.name]||[],g.variants[I.name].push({mesh:u,material:b}),u.onClonedObservable.add(V=>{const M=V;let B=null,P=M;do{if(P=P.parent,!P)return;B=Rt._GetExtensionMetadata(P)}while(B===null);if(d&&B===Rt._GetExtensionMetadata(d)){P._internalMetadata={};for(const T in d._internalMetadata)P._internalMetadata[T]=d._internalMetadata[T];P._internalMetadata.gltf=[];for(const T in d._internalMetadata.gltf)P._internalMetadata.gltf[T]=d._internalMetadata.gltf[T];P._internalMetadata.gltf[vt]={lastSelected:null,original:[],variants:{}};for(const T of B.original)P._internalMetadata.gltf[vt].original.push({mesh:T.mesh,material:T.material});for(const T in B.variants)if(Object.prototype.hasOwnProperty.call(B.variants,T)){P._internalMetadata.gltf[vt].variants[T]=[];for(const N of B.variants[T])P._internalMetadata.gltf[vt].variants[T].push({mesh:N.mesh,material:N.material})}B=P._internalMetadata.gltf[vt]}for(const T of B.original)T.mesh===u&&(T.mesh=M);for(const T of B.variants[I.name])T.mesh===u&&(T.mesh=M)})}}))}}})),await Promise.all(h).then(([u])=>u)})}}Ne(vt);Re(vt,!0,i=>new Rt(i));class oo{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:un.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...oo._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new wt,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(o=>this._options[o]!==e[o]).length)return;const n={...this._options,...e},r=this._options;this._options=n,n.renderSize!==r.renderSize||n.renderTargetTextureType!==r.renderTargetTextureType||n.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=n.samples,this._opaqueRenderTarget.lodGenerationScale=n.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=n.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){var t;return!!((t=e==null?void 0:e.subSurface)!=null&&t.isRefractionEnabled)}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),ke.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e);if(this._shouldRenderAsTransmission(e.material)){if(e.material){const o=e.material.subSurface;o&&(o.refractionTexture=this._opaqueRenderTarget)}n!==-1?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)}else t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):n===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return((e=this._opaqueRenderTarget)==null?void 0:e.getInternalTexture())!==null}_setupRenderTargets(){var t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Kr("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=((t=this._options.clearColor)==null?void 0:t.clone())??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.disableImageProcessing=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(n=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?n.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(n.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e});for(const n of this._transparentMeshesCache)this._shouldRenderAsTransmission(n.material)&&(n.material.refractionTexture=this._opaqueRenderTarget)}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const ws="KHR_materials_transmission";class fa{constructor(e){this.name=ws,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(ws),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadTransparentPropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,n,r){var l,h;const o=this._loader._getOrCreateMaterialAdapter(n),s=r.transmissionFactor!==void 0?r.transmissionFactor:0;if(s===0)return Promise.resolve();if(o.configureTransmission(),o.transmissionWeight=s,s>0){const u=n.getScene();u._transmissionHelper?(l=u._transmissionHelper)!=null&&l._isRenderTargetValid()||(h=u._transmissionHelper)==null||h._setupRenderTargets():new oo({},n.getScene())}let a=Promise.resolve(null);return r.transmissionTexture&&(r.transmissionTexture.nonColorData=!0,a=this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,u=>{u.name=`${n.name} (Transmission)`,o.transmissionWeightTexture=u})),a.then(()=>{})}}Ne(ws);Re(ws,!0,i=>new fa(i));const xs="KHR_materials_diffuse_transmission";class ma{constructor(e){this.name=xs,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(xs),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadTranslucentPropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,n,r){const o=this._loader._getOrCreateMaterialAdapter(n);o.configureSubsurface(),o.subsurfaceWeight=r.diffuseTransmissionFactor??0,o.subsurfaceColor=r.diffuseTransmissionColorFactor!==void 0?ie.FromArray(r.diffuseTransmissionColorFactor):ie.White();const s=new Array;return r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(a=>{a.name=`${n.name} (Diffuse Transmission)`,o.subsurfaceWeightTexture=a}))),r.diffuseTransmissionColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(a=>{a.name=`${n.name} (Diffuse Transmission Color)`,o.subsurfaceColorTexture=a})),Promise.all(s).then(()=>{})}}Ne(xs);Re(xs,!0,i=>new ma(i));const As="KHR_materials_volume";class ya{constructor(e){this.name=As,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(As),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadVolumePropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadVolumePropertiesAsync(e,t,n,r){const o=this._loader._getOrCreateMaterialAdapter(n);if(o.transmissionWeight===0&&o.subsurfaceWeight===0||!r.thicknessFactor)return Promise.resolve();o.transmissionDepth=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE,o.transmissionColor=r.attenuationColor!==void 0&&r.attenuationColor.length==3?ie.FromArray(r.attenuationColor):ie.White(),o.volumeThickness=r.thicknessFactor??0;const s=new Array;return r.thicknessTexture&&(r.thicknessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture,a=>{a.name=`${n.name} (Thickness)`,o.volumeThicknessTexture=a}))),Promise.all(s).then(()=>{})}}Ne(As);Re(As,!0,i=>new ya(i));const Ts="KHR_materials_dispersion";class ga{constructor(e){this.name=Ts,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ts)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadDispersionPropertiesAsync(r,t,n,o)),await Promise.all(s).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,n,r){const o=this._loader._getOrCreateMaterialAdapter(n);return o.transmissionWeight>0||!r.dispersion||(o.transmissionDispersionAbbeNumber=20/r.dispersion),Promise.resolve()}}Ne(Ts);Re(Ts,!0,i=>new ga(i));const Cs="KHR_materials_diffuse_roughness";class va{constructor(e){this.name=Cs,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Cs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadDiffuseRoughnessPropertiesAsync(r,o,n)),await Promise.all(s).then(()=>{})})}_loadDiffuseRoughnessPropertiesAsync(e,t,n){const r=this._loader._getOrCreateMaterialAdapter(n),o=new Array;return r.baseDiffuseRoughness=t.diffuseRoughnessFactor??0,t.diffuseRoughnessTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseRoughnessTexture`,t.diffuseRoughnessTexture,s=>{s.name=`${n.name} (Diffuse Roughness)`,r.baseDiffuseRoughnessTexture=s})),Promise.all(o).then(()=>{})}}Ne(Cs);Re(Cs,!0,i=>new va(i));const Es="KHR_mesh_quantization";class _a{constructor(e){this.name=Es,this.enabled=e.isExtensionUsed(Es)}dispose(){}}Ne(Es);Re(Es,!0,i=>new _a(i));const Ms="KHR_texture_basisu";class ba{constructor(e){this.name=Ms,this._loader=e,this.enabled=e.isExtensionUsed(Ms)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=t.sampler==null?we.DefaultSampler:pe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=pe.Get(`${r}/source`,this._loader.gltf.images,o.source);return await this._loader._createTextureAsync(e,s,a,l=>{n(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}Ne(Ms);Re(Ms,!0,i=>new ba(i));const Ps="KHR_texture_transform";class wa{constructor(e){this.name=Ps,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ps)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>await this._loader.loadTextureInfoAsync(e,t,s=>{if(!(s instanceof We))throw new Error(`${r}: Texture type not supported`);o.offset&&(s.uOffset=o.offset[0],s.vOffset=o.offset[1]),s.uRotationCenter=0,s.vRotationCenter=0,o.rotation&&(s.wAng=-o.rotation),o.scale&&(s.uScale=o.scale[0],s.vScale=o.scale[1]),o.texCoord!=null&&(s.coordinatesIndex=o.texCoord),n(s)}))}}Ne(Ps);Re(Ps,!0,i=>new wa(i));const Is="KHR_xmp_json_ld";class xa{constructor(e){this.name=Is,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(Is)}dispose(){this._loader=null}onLoading(){var n,r,o;if(this._loader.rootBabylonMesh===null)return;const e=(n=this._loader.gltf.extensions)==null?void 0:n.KHR_xmp_json_ld,t=(o=(r=this._loader.gltf.asset)==null?void 0:r.extensions)==null?void 0:o.KHR_xmp_json_ld;if(e&&t){const s=+t.packet;e.packets&&s<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[s])}}}Ne(Is);Re(Is,!0,i=>new xa(i));function an(i,e,t,n){return ie.FromArray(e,t).scale(n)}function Aa(i,e,t,n){return e[t+3]*n}function De(i,e,t,n){return e[t]*n}function ro(i,e,t,n){return-e[t]*n}function Bs(i,e,t,n){return e[t+1]*n}function br(i,e,t,n){return e[t]*n*2}function ft(i){return{scale:[new Ue(ve.ANIMATIONTYPE_FLOAT,`${i}.uScale`,De,()=>2),new Ue(ve.ANIMATIONTYPE_FLOAT,`${i}.vScale`,Bs,()=>2)],offset:[new Ue(ve.ANIMATIONTYPE_FLOAT,`${i}.uOffset`,De,()=>2),new Ue(ve.ANIMATIONTYPE_FLOAT,`${i}.vOffset`,Bs,()=>2)],rotation:[new Ue(ve.ANIMATIONTYPE_FLOAT,`${i}.wAng`,ro,()=>1)]}}class rn extends En{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,n,r)}]}}class Ue extends En{buildAnimations(e,t,n,r){const o=[];for(const s in e._data)o.push({babylonAnimatable:e._data[s].babylonMaterial,babylonAnimation:this._buildAnimation(t,n,r)});return o}}class qt extends En{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,n,r)}]}}class Ta extends En{buildAnimations(e,t,n,r){return e._primitiveBabylonMeshes?e._primitiveBabylonMeshes.map(o=>({babylonAnimatable:o,babylonAnimation:this._buildAnimation(t,n,r)})):[]}}X("/cameras/{}/orthographic/xmag",[new rn(ve.ANIMATIONTYPE_FLOAT,"orthoLeft",ro,()=>1),new rn(ve.ANIMATIONTYPE_FLOAT,"orthoRight",Bs,()=>1)]);X("/cameras/{}/orthographic/ymag",[new rn(ve.ANIMATIONTYPE_FLOAT,"orthoBottom",ro,()=>1),new rn(ve.ANIMATIONTYPE_FLOAT,"orthoTop",Bs,()=>1)]);X("/cameras/{}/orthographic/zfar",[new rn(ve.ANIMATIONTYPE_FLOAT,"maxZ",De,()=>1)]);X("/cameras/{}/orthographic/znear",[new rn(ve.ANIMATIONTYPE_FLOAT,"minZ",De,()=>1)]);X("/cameras/{}/perspective/yfov",[new rn(ve.ANIMATIONTYPE_FLOAT,"fov",De,()=>1)]);X("/cameras/{}/perspective/zfar",[new rn(ve.ANIMATIONTYPE_FLOAT,"maxZ",De,()=>1)]);X("/cameras/{}/perspective/znear",[new rn(ve.ANIMATIONTYPE_FLOAT,"minZ",De,()=>1)]);X("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new Ue(ve.ANIMATIONTYPE_COLOR3,"albedoColor",an,()=>4),new Ue(ve.ANIMATIONTYPE_FLOAT,"alpha",Aa,()=>4)]);X("/materials/{}/pbrMetallicRoughness/metallicFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"metallic",De,()=>1)]);X("/materials/{}/pbrMetallicRoughness/metallicFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"roughness",De,()=>1)]);const io=ft("albedoTexture");X("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",io.scale);X("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",io.offset);X("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",io.rotation);const ao=ft("metallicTexture");X("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",ao.scale);X("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",ao.offset);X("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",ao.rotation);X("/materials/{}/emissiveFactor",[new Ue(ve.ANIMATIONTYPE_COLOR3,"emissiveColor",an,()=>3)]);const lo=ft("bumpTexture");X("/materials/{}/normalTexture/scale",[new Ue(ve.ANIMATIONTYPE_FLOAT,"bumpTexture.level",De,()=>1)]);X("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",lo.scale);X("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",lo.offset);X("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",lo.rotation);X("/materials/{}/occlusionTexture/strength",[new Ue(ve.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",De,()=>1)]);const co=ft("ambientTexture");X("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",co.scale);X("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",co.offset);X("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",co.rotation);const uo=ft("emissiveTexture");X("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",uo.scale);X("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",uo.offset);X("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",uo.rotation);X("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new Ue(ve.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new Ue(ve.ANIMATIONTYPE_FLOAT,"anisotropy.angle",De,()=>1)]);const ho=ft("anisotropy.texture");X("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",ho.scale);X("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",ho.offset);X("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",ho.rotation);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",De,()=>1)]);const po=ft("clearCoat.texture");X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",po.scale);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",po.offset);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",po.rotation);const fo=ft("clearCoat.bumpTexture");X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new Ue(ve.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",fo.scale);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",fo.offset);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",fo.rotation);const mo=ft("clearCoat.textureRoughness");X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",mo.scale);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",mo.offset);X("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",mo.rotation);X("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new Ue(ve.ANIMATIONTYPE_FLOAT,"emissiveIntensity",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_ior/ior",[new Ue(ve.ANIMATIONTYPE_FLOAT,"indexOfRefraction",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"iridescence.intensity",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new Ue(ve.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new Ue(ve.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",De,()=>1)]);const yo=ft("iridescence.texture");X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",yo.scale);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",yo.offset);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",yo.rotation);const go=ft("iridescence.thicknessTexture");X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",go.scale);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",go.offset);X("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",go.rotation);X("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new Ue(ve.ANIMATIONTYPE_COLOR3,"sheen.color",an,()=>3)]);X("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"sheen.roughness",De,()=>1)]);const vo=ft("sheen.texture");X("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",vo.scale);X("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",vo.offset);X("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",vo.rotation);const _o=ft("sheen.textureRoughness");X("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",_o.scale);X("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",_o.offset);X("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",_o.rotation);X("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"metallicF0Factor",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new Ue(ve.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",an,()=>3)]);const bo=ft("metallicReflectanceTexture");X("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",bo.scale);X("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",bo.offset);X("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",bo.rotation);const wo=ft("reflectanceTexture");X("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",wo.scale);X("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",wo.offset);X("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",wo.rotation);X("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",De,()=>1)]);const xo=ft("subSurface.refractionIntensityTexture");X("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",xo.scale);X("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",xo.offset);X("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",xo.rotation);X("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new Ue(ve.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",an,()=>3)]);X("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new Ue(ve.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",De,()=>1)]);X("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",De,()=>1)]);const Ao=ft("subSurface.thicknessTexture");X("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",Ao.scale);X("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",Ao.offset);X("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",Ao.rotation);X("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new Ue(ve.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",De,()=>1)]);const To=ft("subSurface.translucencyIntensityTexture");X("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",To.scale);X("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",To.offset);X("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",To.rotation);X("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new Ue(ve.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",an,()=>3)]);const Co=ft("subSurface.translucencyColorTexture");X("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",Co.scale);X("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",Co.offset);X("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",Co.rotation);X("/extensions/KHR_lights_punctual/lights/{}/color",[new qt(ve.ANIMATIONTYPE_COLOR3,"diffuse",an,()=>3)]);X("/extensions/KHR_lights_punctual/lights/{}/intensity",[new qt(ve.ANIMATIONTYPE_FLOAT,"intensity",De,()=>1)]);X("/extensions/KHR_lights_punctual/lights/{}/range",[new qt(ve.ANIMATIONTYPE_FLOAT,"range",De,()=>1)]);X("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new qt(ve.ANIMATIONTYPE_FLOAT,"innerAngle",br,()=>1)]);X("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new qt(ve.ANIMATIONTYPE_FLOAT,"angle",br,()=>1)]);X("/extensions/EXT_lights_area/lights/{}/color",[new qt(ve.ANIMATIONTYPE_COLOR3,"diffuse",an,()=>3)]);X("/extensions/EXT_lights_area/lights/{}/intensity",[new qt(ve.ANIMATIONTYPE_FLOAT,"intensity",De,()=>1)]);X("/extensions/EXT_lights_area/lights/{}/size",[new qt(ve.ANIMATIONTYPE_FLOAT,"radius",De,()=>1)]);X("/extensions/EXT_lights_area/lights/{}/rect/aspect",[new qt(ve.ANIMATIONTYPE_FLOAT,"radius",De,()=>1)]);X("/nodes/{}/extensions/EXT_lights_ies/color",[new qt(ve.ANIMATIONTYPE_COLOR3,"diffuse",an,()=>3)]);X("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new qt(ve.ANIMATIONTYPE_FLOAT,"intensity",De,()=>1)]);X("/nodes/{}/extensions/KHR_node_visibility/visible",[new Ta(ve.ANIMATIONTYPE_FLOAT,"isVisible",De,()=>1)]);const Ss="KHR_animation_pointer";class Ca{constructor(e){this.name=Ss,this._loader=e,this._pathToObjectConverter=mr(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(Ss)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,n,r,o){var h;const s=(h=r.target.extensions)==null?void 0:h.KHR_animation_pointer;if(!s||!this._pathToObjectConverter)return null;r.target.path!=="pointer"&&Me.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&Me.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);const a=`${e}/extensions/${this.name}`,l=s.pointer;if(!l)throw new Error(`${a}: Pointer is missing`);try{const u=this._pathToObjectConverter.convert(l);if(!u.info.interpolation)throw new Error(`${a}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,r,{object:u.object,info:u.info.interpolation},o)}catch{return Me.Warn(`${a}/pointer: Invalid pointer (${l}) skipped`),null}}}Ne(Ss);Re(Ss,!0,i=>new Ca(i));const Ns="MSFT_audio_emitter";class Ea{constructor(e){this.name=Ns,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ns)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,pe.Assign(this._clips),pe.Assign(this._emitters)}}loadSceneAsync(e,t){return we.LoadExtensionAsync(e,t,this.name,async(n,r)=>{const o=new Array;o.push(this._loader.loadSceneAsync(e,t));for(const s of r.emitters){const a=pe.Get(`${n}/emitters`,this._emitters,s);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);o.push(this._loadEmitterAsync(`${n}/emitters/${a.index}`,a))}await Promise.all(o)})}loadNodeAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{const s=new Array,a=await this._loader.loadNodeAsync(r,t,l=>{for(const h of o.emitters){const u=pe.Get(`${r}/emitters`,this._emitters,h);s.push(this._loadEmitterAsync(`${r}/emitters/${u.index}`,u).then(()=>{for(const c of u._babylonSounds)c.attachToMesh(l),(u.innerAngle!=null||u.outerAngle!=null)&&(c.setLocalDirectionToMesh(Q.Forward()),c.setDirectionalCone(2*ke.ToDegrees(u.innerAngle==null?Math.PI:u.innerAngle),2*ke.ToDegrees(u.outerAngle==null?Math.PI:u.outerAngle),0))}))}n(l)});return await Promise.all(s),a})}loadAnimationAsync(e,t){return we.LoadExtensionAsync(e,t,this.name,async(n,r)=>{const o=await this._loader.loadAnimationAsync(e,t),s=new Array;pe.Assign(r.events);for(const a of r.events)s.push(this._loadAnimationEventAsync(`${n}/events/${a.index}`,e,t,a,o));return await Promise.all(s),o})}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{const r=pe.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=n.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const n=new Array,r=t.name||`emitter${t.index}`,o={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){const l=`/extensions/${this.name}/clips`,h=pe.Get(l,this._clips,t.clips[a].clip);n.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,h).then(u=>{const c=t._babylonSounds[a]=new jr(r,u,this._loader.babylonScene,null,o);c.refDistance=t.refDistance||1,c.maxDistance=t.maxDistance||256,c.rolloffFactor=t.rolloffFactor||1,c.distanceModel=t.distanceModel||"exponential"}))}const s=Promise.all(n).then(()=>{const a=t.clips.map(h=>h.weight||1),l=new Yr(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*ke.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*ke.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:s}}return t._babylonData.loaded}_getEventAction(e,t,n,r,o){switch(n){case"play":return s=>{const a=(o||0)+(s-r);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,r,o){if(o.targetedAnimations.length==0)return Promise.resolve();const s=o.targetedAnimations[0],a=r.emitter,l=pe.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{const h=l._babylonData.sound;if(h){const u=new Xr(r.time,this._getEventAction(e,h,r.action,r.time,r.startOffset));s.animation.addEvent(u),o.onAnimationGroupEndObservable.add(()=>{h.stop()}),o.onAnimationGroupPauseObservable.add(()=>{h.pause()})}})}}Ne(Ns);Re(Ns,!0,i=>new Ea(i));const Dn="MSFT_lod";class Ma{constructor(e){var t;this.name=Dn,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new wt,this.onMaterialLODsLoadedObservable=new wt,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=((t=this._loader.parent.extensionOptions[Dn])==null?void 0:t.maxLODsToLoad)??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(Dn)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const n=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),n}loadNodeAsync(e,t,n){return we.LoadExtensionAsync(e,t,this.name,async(r,o)=>{let s;const a=this._getLODs(r,t,this._loader.gltf.nodes,o.ids);this._loader.logOpen(`${r}`);for(let l=0;l<a.length;l++){const h=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Ln);const u=d=>{n(d),d.setEnabled(!1)},c=this._loader.loadNodeAsync(`/nodes/${h.index}`,h,u).then(d=>{if(l!==0){const p=a[l-1];p._babylonTransformNode&&(this._disposeTransformNode(p._babylonTransformNode),delete p._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?s=c:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(c))}return this._loader.logClose(),await s})}_loadMaterialAsync(e,t,n,r,o){return this._nodeIndexLOD?null:we.LoadExtensionAsync(e,t,this.name,async(s,a)=>{let l;const h=this._getLODs(s,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${s}`);for(let u=0;u<h.length;u++){const c=h[u];u!==0&&(this._materialIndexLOD=u);const d=this._loader._loadMaterialAsync(`/materials/${c.index}`,c,n,r,p=>{u===0&&o(p)}).then(p=>{if(u!==0){o(p);const f=h[u-1]._data;f[r]&&(this._disposeMaterials([f[r].babylonMaterial]),delete f[r])}return p});this._materialPromiseLODs[u]=this._materialPromiseLODs[u]||[],u===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[u].push(d))}return this._loader.logClose(),await l})}_loadUriAsync(e,t,n){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new Ln,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(async()=>await this._loader.loadUriAsync(e,t,n))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new Ln,this._materialSignalLODs[r].promise.then(async()=>await this._loader.loadUriAsync(e,t,n))}return null}loadBufferAsync(e,t,n,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const o=async(s,a)=>{const l=n,h=l+r-1;let u=s[a];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,h)):(u={start:l,end:h,loaded:new Ln},s[a]=u),await u.loaded.promise.then(c=>new Uint8Array(c.buffer,c.byteOffset+n-u.start,r))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?o(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?o(this._materialBufferLODs,this._materialIndexLOD):o(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const n=e[t];n&&(this._loader.log(`Loading buffer range [${n.start}-${n.end}]`),this._loader.bin.readAsync(n.start,n.end-n.start+1).then(r=>{n.loaded.resolve(r)},r=>{n.loaded.reject(r)}))}_getLODs(e,t,n,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const o=[];for(let s=r.length-1;s>=0;s--)if(o.push(pe.Get(`${e}/ids/${r[s]}`,n,r[s])),o.length===this.maxLODsToLoad)return o;return o.push(t),o}_disposeTransformNode(e){const t=[],n=e.material;n&&t.push(n);for(const o of e.getChildMeshes())o.material&&t.push(o.material);e.dispose();const r=t.filter(o=>this._loader.babylonScene.meshes.every(s=>s.material!=o));this._disposeMaterials(r)}_disposeMaterials(e){const t={};for(const n of e){for(const r of n.getActiveTextures())t[r.uniqueId]=r;n.dispose()}for(const n in t)for(const r of this._loader.babylonScene.materials)r.hasTexture(t[n])&&delete t[n];for(const n in t)t[n].dispose()}}Ne(Dn);Re(Dn,!0,i=>new Ma(i));const Os="MSFT_minecraftMesh";class Pa{constructor(e){this.name=Os,this._loader=e,this.enabled=this._loader.isExtensionUsed(Os)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtraAsync(e,t,this.name,async(r,o)=>{if(o){if(!this._loader._pbrMaterialImpl)throw new Error(`${r}: Material type not supported`);const s=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,await s}})}}Ne(Os);Re(Os,!0,i=>new Pa(i));const Rs="MSFT_sRGBFactors";class Ia{constructor(e){this.name=Rs,this._loader=e,this.enabled=this._loader.isExtensionUsed(Rs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return we.LoadExtraAsync(e,t,this.name,async(r,o)=>{if(o){const s=this._loader._getOrCreateMaterialAdapter(n),a=this._loader.loadMaterialPropertiesAsync(e,t,n),l=n.getScene().getEngine().useExactSrgbConversions;return s.baseColorTexture||s.baseColor.toLinearSpaceToRef(s.baseColor,l),s.specularColorTexture||s.specularColor.toLinearSpaceToRef(s.specularColor,l),await a}})}}Ne(Rs);Re(Rs,!0,i=>new Ia(i));function $o(i){const[e,t]=i.split(":");return wr({op:e,extension:t})}function wr(i,e=!0){var n;const t=i.extension?(n=Qn[i.extension])==null?void 0:n[i.op]:Ba[i.op];if(!t&&(Me.Warn(`No mapping found for operation ${i.op} and extension ${i.extension||"KHR_interactivity"}`),e)){const r={},o={flows:{}};if(i.inputValueSockets){r.values={};for(const s in i.inputValueSockets)r.values[s]={name:s}}return i.outputValueSockets&&(o.values={},Object.keys(i.outputValueSockets).forEach(s=>{o.values[s]={name:s}})),{blocks:[],inputs:r,outputs:o}}return t}function Eo(i,e,t){Qn[e]||(Qn[e]={}),Qn[e][i]=t}const Qn={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},Ba={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],extraProcessor(i,e,t,n,r){if(e.op!=="event/send"||!i.configuration||Object.keys(i.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const s=i.configuration.event.value[0];if(typeof s!="number")throw new Error("Event id should be a number");const a=n.arrays.events[s],l=r[0];return l.config||(l.config={}),l.config.eventId=a.eventId,l.config.eventData=a.eventData,r}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(i,e){var o;if(!i.configuration)return Me.Error("Receive event should have a configuration object"),{valid:!1,error:"Receive event should have a configuration object"};const t=i.configuration.event;if(!t)return Me.Error("Receive event should have a single configuration object, the event itself"),{valid:!1,error:"Receive event should have a single configuration object, the event itself"};const n=t.value[0];return typeof n!="number"?(Me.Error("Event id should be a number"),{valid:!1,error:"Event id should be a number"}):((o=e.events)==null?void 0:o[n])?{valid:!0}:(Me.Error(`Event with id ${n} not found`),{valid:!1,error:`Event with id ${n} not found`})},extraProcessor(i,e,t,n,r){if(e.op!=="event/receive"||!i.configuration||Object.keys(i.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const s=i.configuration.event.value[0];if(typeof s!="number")throw new Error("Event id should be a number");const a=n.arrays.events[s],l=r[0];return l.config||(l.config={}),l.config.eventId=a.eventId,l.config.eventData=a.eventData,r}},"math/E":ge("FlowGraphEBlock"),"math/Pi":ge("FlowGraphPIBlock"),"math/Inf":ge("FlowGraphInfBlock"),"math/NaN":ge("FlowGraphNaNBlock"),"math/abs":ge("FlowGraphAbsBlock"),"math/sign":ge("FlowGraphSignBlock"),"math/trunc":ge("FlowGraphTruncBlock"),"math/floor":ge("FlowGraphFloorBlock"),"math/ceil":ge("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.roundHalfAwayFromZero=!0,r}},"math/fract":ge("FlowGraphFractBlock"),"math/neg":ge("FlowGraphNegationBlock"),"math/add":ge("FlowGraphAddBlock",["a","b"],!0),"math/sub":ge("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(i,e,t,n,r){var o;(o=r[0]).config||(o.config={}),r[0].config.useMatrixPerComponent=!0,r[0].config.preventIntegerFloatArithmetic=!0;let s=-1;return Object.keys(i.values||{}).find(a=>{var l;return((l=i.values)==null?void 0:l[a].type)!==void 0?(s=i.values[a].type,!0):!1}),s!==-1&&(r[0].config.type=n.arrays.types[s].flowGraphType),r},validation(i){return i.values?xr(i):{valid:!0}}},"math/div":ge("FlowGraphDivideBlock",["a","b"],!0),"math/rem":ge("FlowGraphModuloBlock",["a","b"]),"math/min":ge("FlowGraphMinBlock",["a","b"]),"math/max":ge("FlowGraphMaxBlock",["a","b"]),"math/clamp":ge("FlowGraphClampBlock",["a","b","c"]),"math/saturate":ge("FlowGraphSaturateBlock"),"math/mix":ge("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":ge("FlowGraphEqualityBlock",["a","b"]),"math/lt":ge("FlowGraphLessThanBlock",["a","b"]),"math/le":ge("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":ge("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":ge("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isNaN":ge("FlowGraphIsNaNBlock"),"math/isInf":ge("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":ge("FlowGraphSinBlock"),"math/cos":ge("FlowGraphCosBlock"),"math/tan":ge("FlowGraphTanBlock"),"math/asin":ge("FlowGraphASinBlock"),"math/acos":ge("FlowGraphACosBlock"),"math/atan":ge("FlowGraphATanBlock"),"math/atan2":ge("FlowGraphATan2Block",["a","b"]),"math/sinh":ge("FlowGraphSinhBlock"),"math/cosh":ge("FlowGraphCoshBlock"),"math/tanh":ge("FlowGraphTanhBlock"),"math/asinh":ge("FlowGraphASinhBlock"),"math/acosh":ge("FlowGraphACoshBlock"),"math/atanh":ge("FlowGraphATanhBlock"),"math/exp":ge("FlowGraphExponentialBlock"),"math/log":ge("FlowGraphLogBlock"),"math/log2":ge("FlowGraphLog2Block"),"math/log10":ge("FlowGraphLog10Block"),"math/sqrt":ge("FlowGraphSquareRootBlock"),"math/cbrt":ge("FlowGraphCubeRootBlock"),"math/pow":ge("FlowGraphPowerBlock",["a","b"]),"math/length":ge("FlowGraphLengthBlock"),"math/normalize":ge("FlowGraphNormalizeBlock"),"math/dot":ge("FlowGraphDotBlock",["a","b"]),"math/cross":ge("FlowGraphCrossBlock",["a","b"]),"math/rotate2D":{blocks:["FlowGraphRotate2DBlock"],inputs:{values:{a:{name:"a"},angle:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/rotate3D":{blocks:["FlowGraphRotate3DBlock"],inputs:{values:{a:{name:"a"},rotation:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":ge("FlowGraphTransposeBlock"),"math/determinant":ge("FlowGraphDeterminantBlock"),"math/inverse":ge("FlowGraphInvertMatrixBlock"),"math/matMul":ge("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,o){const s=r[0].dataInputs.find(a=>a.name==="rotationQuaternion");if(!s)throw new Error("Rotation quaternion input not found");return o._connectionValues[s.uniqueId]&&(o._connectionValues[s.uniqueId].type="Quaternion"),r}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/quatConjugate":ge("FlowGraphConjugateBlock",["a"]),"math/quatMul":{blocks:["FlowGraphMultiplyBlock"],inputs:{values:{a:{name:"a",gltfType:"vector4"},b:{name:"b",gltfType:"vector4"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.type="Quaternion",r}},"math/quatAngleBetween":ge("FlowGraphAngleBetweenBlock",["a","b"]),"math/quatFromAxisAngle":{blocks:["FlowGraphQuaternionFromAxisAngleBlock"],inputs:{values:{axis:{name:"a",gltfType:"float3"},angle:{name:"b",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/quatToAxisAngle":ge("FlowGraphAxisAngleFromQuaternionBlock",["a"]),"math/quatFromDirections":ge("FlowGraphQuaternionFromDirectionsBlock",["a","b"]),"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var o;return(o=r[0]).config||(o.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,o){var l;var s;(s=r[0]).config||(s.config={});const a=r[0].dataInputs[0];return r[0].config.valueType=((l=o._connectionValues[a.uniqueId])==null?void 0:l.type)??"FlowGraphInteger",r}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,o){var h,u;var s;(s=r[0]).config||(s.config={});const a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=((h=o._connectionValues[a.uniqueId])==null?void 0:h.type)??((u=o._connectionValues[l.uniqueId])==null?void 0:u.type)??"FlowGraphInteger",r}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,o){var h,u;var s;(s=r[0]).config||(s.config={});const a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=((h=o._connectionValues[a.uniqueId])==null?void 0:h.type)??((u=o._connectionValues[l.uniqueId])==null?void 0:u.type)??"FlowGraphInteger",r}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,o){var h,u;var s;(s=r[0]).config||(s.config={});const a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=((h=o._connectionValues[a.uniqueId])==null?void 0:h.type)??((u=o._connectionValues[l.uniqueId])==null?void 0:u.type)??"FlowGraphInteger",r}},"math/asr":ge("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":ge("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":ge("FlowGraphLeadingZerosBlock"),"math/ctz":ge("FlowGraphTrailingZerosBlock"),"math/popcnt":ge("FlowGraphOneBitsCounterBlock"),"math/rad":ge("FlowGraphDegToRadBlock"),"math/deg":ge("FlowGraphRadToDegBlock"),"type/boolToInt":ge("FlowGraphBooleanToInt"),"type/boolToFloat":ge("FlowGraphBooleanToFloat"),"type/intToBool":ge("FlowGraphIntToBoolean"),"type/intToFloat":ge("FlowGraphIntToFloat"),"type/floatToInt":ge("FlowGraphFloatToInt"),"type/floatToBool":ge("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(i,e,t,n,r){const o=r[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(i.flows||[]).length,o.signalOutputs.forEach((s,a)=>{s.name="out_"+a}),r}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"},default:{name:"default"}}},validation(i){if(i.configuration&&i.configuration.cases){const e=i.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return Me.Warn("Switch cases should be integers. Using empty array instead."),i.configuration.cases.value=[],{valid:!0};const n=new Set(e);i.configuration.cases.value=Array.from(n)}return{valid:!0}},extraProcessor(i,e,t,n,r){if(e.op!=="flow/switch"||!i.flows||Object.keys(i.flows).length===0)throw new Error("Switch should have a single configuration object, the cases array");return r[0].signalOutputs.forEach(s=>{s.name!=="default"&&(s.name="out_"+s.name)}),r}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}},extraProcessor(i,e,t,n,r){const o=r[0];return o.config||(o.config={}),o.config.incrementIndexWhenLoopDone=!0,r}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(i,e,t,n,r){if(e.op!=="flow/multiGate"||!i.flows||Object.keys(i.flows).length===0)throw new Error("MultiGate should have a single configuration object, the number of output flows");const o=r[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(i.flows).length,o.signalOutputs.forEach((s,a)=>{s.name="out_"+a}),r}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{reset:{name:"reset"},"[segment]":{name:"in_$1"}}},validation(i){var e,t;return typeof((t=(e=i.configuration)==null?void 0:e.inputFlows)==null?void 0:t.value[0])!="number"&&(i.configuration=i.configuration||{inputFlows:{value:[0]}},i.configuration.inputFlows.value=[0]),{valid:!0}}},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation(i){var e,t;return(t=(e=i.configuration)==null?void 0:e.variable)!=null&&t.value?{valid:!0}:(Me.Error("Variable get block should have a variable configuration"),{valid:!1,error:"Variable get block should have a variable configuration"})},configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(i,e){return[e.getVariableName(i[0])]}}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(i,e){return[e.getVariableName(i[0])]}}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer(i,e){return[i[0].map(t=>e.getVariableName(t))]}}},extraProcessor(i,e,t,n,r){return r[0].dataInputs.forEach(s=>{s.name=n.getVariableName(+s.name)}),r}},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer(i,e){return[e.getVariableName(i[0])]}},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:i=>i[0]===!0?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(i,e,t,n,r){var c;var o,s;const a=r[0],l=(c=i.configuration)==null?void 0:c.variable.value[0];if(typeof l!="number")throw Me.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");const h=n.arrays.staticVariables[l];typeof a.config.animationType.value>"u"&&(n.arrays.staticVariables,a.config.animationType.value=Qr(h.type));const u=r[4];return u.config||(u.config={}),(o=u.config).variable||(o.variable={}),u.config.variable.value=n.getVariableName(l),(s=r[3]).config||(s.config={}),r}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(i,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),r}},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(i,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),r}},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(i,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"?(o.config||(o.config={}),o.config.outputValue=!0):o.className==="FlowGraphInterpolationBlock"&&(o.config||(o.config={}),Object.keys(i.values||[]).forEach(s=>{var l;const a=(l=i.values)==null?void 0:l[s];if(s==="value"&&a){const h=a.type;h!==void 0&&(o.config.animationType=n.arrays.types[h].flowGraphType)}}))}),r}},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(i,e)=>[i[0]*e._animationTargetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(i,e)=>[i[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(i,e,t,n,r,o,s){const a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=s,r}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(i,e,t,n,r,o,s){const a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=s,r}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(i,e)=>[i[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(i,e,t,n,r,o,s){const a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=s,r}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(i){if(i.configuration&&i.configuration.cases){const e=i.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return Me.Warn("Switch cases should be integers. Using empty array instead."),i.configuration.cases.value=[],{valid:!0};const n=new Set(e);i.configuration.cases.value=Array.from(n)}return{valid:!0}},extraProcessor(i,e,t,n,r){const o=r[0];return o.dataInputs.forEach(s=>{s.name!=="default"&&s.name!=="case"&&(s.name="in_"+s.name)}),o.config||(o.config={}),o.config.treatCasesAsIntegers=!0,r}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}};function ge(i,e=["a"],t){return{blocks:[i],inputs:{values:e.reduce((n,r)=>(n[r]={name:r},n),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(n,r,o,s,a){var l;if(t){(l=a[0]).config||(l.config={}),a[0].config.preventIntegerFloatArithmetic=!0;let h=-1;Object.keys(n.values||{}).find(u=>{var c;return((c=n.values)==null?void 0:c[u].type)!==void 0?(h=n.values[u].type,!0):!1}),h!==-1&&(a[0].config.type=s.arrays.types[h].flowGraphType)}return a},validation(n){return t?xr(n):{valid:!0}}}}function xr(i){if(i.values){const e=Object.keys(i.values).map(n=>i.values[n].type).filter(n=>n!==void 0);if(!e.every(n=>n===e[0]))return{valid:!1,error:"All inputs must be of the same type"}}return{valid:!0}}const Sa={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}};class Na{constructor(e,t,n=60){this._interactivityGraph=e,this._gltf=t,this._animationTargetFps=n,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(const e of this._interactivityGraph.types)this._types.push(Sa[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(const e of this._interactivityGraph.declarations){const t=wr(e);if(!t)throw Me.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(const e of this._interactivityGraph.variables){const t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){const n=this._types[e.type];if(!n)throw Me.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==n.length)throw Me.Error(["Invalid value length for variable",e,n]),new Error("Error parsing variables");const r=e.value||[];if(!r.length)switch(n.flowGraphType){case"boolean":r.push(!1);break;case"FlowGraphInteger":r.push(0);break;case"number":r.push(NaN);break;case"Vector2":r.push(NaN,NaN);break;case"Vector3":r.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":r.fill(NaN,0,4);break;case"Matrix":r.fill(NaN,0,16);break;case"Matrix3D":r.fill(NaN,0,9);break}return n.elementType==="number"&&typeof r[0]=="string"&&(r[0]=parseFloat(r[0])),{type:n.flowGraphType,value:t?t(r,this):r}}_parseEvents(){if(this._interactivityGraph.events)for(const e of this._interactivityGraph.events){const t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(n=>{var a;const r=(a=e.values)==null?void 0:a[n];if(!r)throw Me.Error(["No value found for event key",n]),new Error("Error parsing events");const o=this._types[r.type];if(!o)throw Me.Error(["No type found for event value",r]),new Error("Error parsing events");const s=typeof r.value<"u"?this._parseVariable(r):void 0;return{id:n,type:o.flowGraphType,eventData:!0,value:s}})),this._events.push(t)}}_parseNodes(){var e;if(this._interactivityGraph.nodes)for(const t of this._interactivityGraph.nodes){if(typeof t.declaration!="number")throw Me.Error(["No declaration found for node",t]),new Error("Error parsing nodes");const n=this._mappings[t.declaration];if(!n)throw Me.Error(["No mapping found for node",t]),new Error("Error parsing nodes");if(n.flowGraphMapping.validation){const o=n.flowGraphMapping.validation(t,this._interactivityGraph,this._gltf);if(!o.valid)throw new Error(`Error validating interactivity node ${(e=this._interactivityGraph.declarations)==null?void 0:e[t.declaration].op} - ${o.error}`)}const r=[];for(const o of n.flowGraphMapping.blocks){const s=this._getEmptyBlock(o,n.fullOperationName);this._parseNodeConfiguration(t,s,n.flowGraphMapping,o),r.push(s)}this._nodes.push({blocks:r,fullOperationName:n.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:$s(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,n,r){var s,a;const o=t.config;if(e.configuration){const l=Object.keys(e.configuration);for(const h of l){const u=(s=e.configuration)==null?void 0:s[h];if(!u)throw Me.Error(["No value found for node configuration",h]),new Error("Error parsing node configuration");const c=(a=n.configuration)==null?void 0:a[h];if(c&&c.toBlock?c.toBlock===r:n.blocks.indexOf(r)===0){const p=(c==null?void 0:c.name)||h;(!u||typeof u.value>"u")&&typeof(c==null?void 0:c.defaultValue)<"u"?o[p]={value:c.defaultValue}:u.value.length>=0?o[p]={value:u.value.length===1?u.value[0]:u.value}:Me.Warn(["Invalid value for node configuration",u]),c&&c.dataTransformer&&(o[p].value=c.dataTransformer([o[p].value],this)[0])}}}}_parseNodeConnections(e){var t,n,r,o,s,a,l,h,u,c,d,p,f,g,y,m,_,b,v;for(let w=0;w<this._nodes.length;w++){const I=(t=this._interactivityGraph.nodes)==null?void 0:t[w];if(!I)throw Me.Error(["No node found for interactivity node",this._nodes[w]]),new Error("Error parsing node connections");const V=this._nodes[w],M=this._mappings[I.declaration];if(!M)throw Me.Error(["No mapping found for node",I]),new Error("Error parsing node connections");const B=I.flows||{},P=Object.keys(B).sort();for(const R of P){const $=B[R],z=(r=(n=M.flowGraphMapping.outputs)==null?void 0:n.flows)==null?void 0:r[R],ae=(z==null?void 0:z.name)||R,L=this._createNewSocketConnection(ae,!0);(z&&z.toBlock&&V.blocks.find(W=>W.className===z.toBlock)||V.blocks[0]).signalOutputs.push(L);const j=$.node,G=this._nodes[j];if(!G)throw Me.Error(["No node found for input node id",j]),new Error("Error parsing node connections");const E=$o(G.fullOperationName);if(!E)throw Me.Error(["No mapping found for input node",G]),new Error("Error parsing node connections");let k=(s=(o=E.inputs)==null?void 0:o.flows)==null?void 0:s[$.socket||"in"],C=!1;if(!k)for(const W in(a=E.inputs)==null?void 0:a.flows)W.startsWith("[")&&W.endsWith("]")&&(C=!0,k=(h=(l=E.inputs)==null?void 0:l.flows)==null?void 0:h[W]);const A=k?C?k.name.replace("$1",$.socket||""):k.name:$.socket||"in",x=k&&k.toBlock&&G.blocks.find(W=>W.className===k.toBlock)||G.blocks[0];let F=x.signalInputs.find(W=>W.name===A);F||(F=this._createNewSocketConnection(A),x.signalInputs.push(F)),F.connectedPointIds.push(L.uniqueId),L.connectedPointIds.push(F.uniqueId)}const T=I.values||{},N=Object.keys(T);for(const R of N){const $=T[R];let z=(c=(u=M.flowGraphMapping.inputs)==null?void 0:u.values)==null?void 0:c[R],ae=!1;if(!z)for(const G in(d=M.flowGraphMapping.inputs)==null?void 0:d.values)G.startsWith("[")&&G.endsWith("]")&&(ae=!0,z=(f=(p=M.flowGraphMapping.inputs)==null?void 0:p.values)==null?void 0:f[G]);const L=z?ae?z.name.replace("$1",R):z.name:R,S=this._createNewSocketConnection(L);if((z&&z.toBlock&&V.blocks.find(G=>G.className===z.toBlock)||V.blocks[0]).dataInputs.push(S),$.value!==void 0){const G=this._parseVariable($,z&&z.dataTransformer);e._connectionValues[S.uniqueId]=G}else if(typeof $.node<"u"){const G=$.node,E=$.socket||"value",k=this._nodes[G];if(!k)throw Me.Error(["No node found for output socket reference",$]),new Error("Error parsing node connections");const C=$o(k.fullOperationName);if(!C)throw Me.Error(["No mapping found for output socket reference",$]),new Error("Error parsing node connections");let A=(y=(g=C.outputs)==null?void 0:g.values)==null?void 0:y[E],x=!1;if(!A)for(const O in(m=C.outputs)==null?void 0:m.values)O.startsWith("[")&&O.endsWith("]")&&(x=!0,A=(b=(_=C.outputs)==null?void 0:_.values)==null?void 0:b[O]);const F=A?x?A.name.replace("$1",E):A==null?void 0:A.name:E,W=A&&A.toBlock&&k.blocks.find(O=>O.className===A.toBlock)||k.blocks[0];let U=W.dataOutputs.find(O=>O.name===F);U||(U=this._createNewSocketConnection(F,!0),W.dataOutputs.push(U)),S.connectedPointIds.push(U.uniqueId),U.connectedPointIds.push(S.uniqueId)}else throw Me.Error(["Invalid value for value connection",$]),new Error("Error parsing node connections")}if(M.flowGraphMapping.interBlockConnectors)for(const R of M.flowGraphMapping.interBlockConnectors){const $=R.input,z=R.output,ae=R.isVariable;this._connectFlowGraphNodes($,z,V.blocks[R.inputBlockIndex],V.blocks[R.outputBlockIndex],ae)}if(M.flowGraphMapping.extraProcessor){const R=(v=this._interactivityGraph.declarations)==null?void 0:v[I.declaration];if(!R)throw Me.Error(["No declaration found for extra processor",I]),new Error("Error parsing node connections");V.blocks=M.flowGraphMapping.extraProcessor(I,R,M.flowGraphMapping,this,V.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:$s(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,n,r,o){const s=o?n.dataInputs:n.signalInputs,a=o?r.dataOutputs:r.signalOutputs,l=s.find(u=>u.name===e)||this._createNewSocketConnection(e),h=a.find(u=>u.name===t)||this._createNewSocketConnection(t,!0);s.find(u=>u.name===e)||s.push(l),a.find(u=>u.name===t)||a.push(h),l.connectedPointIds.push(h.uniqueId),h.connectedPointIds.push(l.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){const e={uniqueId:$s(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let n=0;n<this._staticVariables.length;n++){const r=this._staticVariables[n];e._userVariables[this.getVariableName(n)]=r}return{rightHanded:!0,allBlocks:this._nodes.reduce((n,r)=>n.concat(r.blocks),[]),executionContexts:[e]}}}const Hn="KHR_interactivity";class Oa{constructor(e){this._loader=e,this.name=Hn,this.enabled=this._loader.isExtensionUsed(Hn),this._pathConverter=mr(this._loader.gltf),e._skipStartAnimationStep=!0;const t=e.babylonScene;t&&Ra(t)}dispose(){this._loader=null,delete this._pathConverter}async onReady(){var o;if(!this._loader.babylonScene||!this._pathConverter)return;const e=this._loader.babylonScene,t=(o=this._loader.gltf.extensions)==null?void 0:o.KHR_interactivity;if(!t)return;const n=new Zr({scene:e});n.dispatchEventsSynchronously=!1;const r=t.graphs.map(s=>new Na(s,this._loader.gltf,this._loader.parent.targetFps).serializeToFlowGraph());await Promise.all(r.map(async s=>await Jr(s,{coordinator:n,pathConverter:this._pathConverter}))),n.start()}}function Ra(i){Yt("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>{if(!i.activeCamera)return new it(NaN,NaN,NaN,NaN);const e=it.FromRotationMatrix(i.activeCamera.getWorldMatrix()).normalize();return i.useRightHandedSystem||(e.w*=-1,e.x*=-1),e},type:"Quaternion",getTarget:()=>i.activeCamera}),Yt("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>{if(!i.activeCamera)return new Q(NaN,NaN,NaN);const e=i.activeCamera.getWorldMatrix().getTranslation();return i.useRightHandedSystem||(e.x*=-1),e},type:"Vector3",getTarget:()=>i.activeCamera}),Yt("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>{var t;return((t=e._babylonAnimationGroup)==null?void 0:t.isPlaying)??!1},type:"boolean",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.from)??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.to)??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.getCurrentFrame())??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),Yt("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.getCurrentFrame())??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup})}ei(Hn,"FlowGraphGLTFDataProvider",async()=>(await An(async()=>{const{FlowGraphGLTFDataProvider:i}=await import("./flowGraphGLTFDataProvider-BwqHMMIL.js");return{FlowGraphGLTFDataProvider:i}},__vite__mapDeps([2,1]))).FlowGraphGLTFDataProvider);Ne(Hn);Re(Hn,!0,i=>new Oa(i));const Fs="KHR_node_visibility";Yt("/nodes/{}/extensions/KHR_node_visibility/visible",{get:i=>{const e=i._babylonTransformNode;return e&&e.isVisible!==void 0?e.isVisible:!0},set:(i,e)=>{var t,n;(t=e._primitiveBabylonMeshes)==null||t.forEach(r=>{r.inheritVisibility=!0}),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=i),(n=e._primitiveBabylonMeshes)==null||n.forEach(r=>{r.isVisible=i})},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});class Fa{constructor(e){this.name=Fs,this._loader=e,this.enabled=e.isExtensionUsed(Fs)}onReady(){if(!this._loader)return;const e=this._loader.gltf.nodes;if(e)for(const t of e){const n=t._babylonTransformNode;n&&(n.inheritVisibility=!0,t.extensions&&t.extensions.KHR_node_visibility&&t.extensions.KHR_node_visibility.visible===!1&&(n.isVisible=!1))}}dispose(){delete this._loader}}Ne(Fs);Re(Fs,!0,i=>new Fa(i));const zn="KHR_node_selectability";Eo("event/onSelect",zn,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(i){return["pickedMesh_"+i[0]]}}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(i,e,t,n,r,o,s){var u,c,d,p,f,g;const a=r[r.length-1];a.config=a.config||{},a.config.glTF=s;const l=(c=(u=i.configuration)==null?void 0:u.nodeIndex)==null?void 0:c.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const h="pickedMesh_"+l;return r[1].config.variable=h,o._userVariables[h]={className:"Mesh",id:(p=(d=s==null?void 0:s.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:p.id,uniqueId:(g=(f=s==null?void 0:s.nodes)==null?void 0:f[l]._babylonTransformNode)==null?void 0:g.uniqueId},r}});Yt("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:i=>{const e=i._babylonTransformNode;return e&&e.isPickable!==void 0?e.isPickable:!0},set:(i,e)=>{var t;(t=e._primitiveBabylonMeshes)==null||t.forEach(n=>{n.isPickable=i})},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});class La{constructor(e){this.name=zn,this._loader=e,this.enabled=e.isExtensionUsed(zn)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,r,o;(n=t.extensions)!=null&&n.KHR_node_selectability&&((r=t.extensions)==null?void 0:r.KHR_node_selectability.selectable)===!1&&((o=t._babylonTransformNode)==null||o.getChildMeshes().forEach(s=>{s.isPickable=!1}))})}dispose(){this._loader=null}}Ne(zn);Re(zn,!0,i=>new La(i));const Rn="KHR_node_hoverability",Ho="targetMeshPointerOver_";Eo("event/onHoverIn",Rn,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(i){return[Ho+i[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(i,e,t,n,r,o,s){var u,c,d,p,f,g;const a=r[r.length-1];a.config=a.config||{},a.config.glTF=s;const l=(c=(u=i.configuration)==null?void 0:u.nodeIndex)==null?void 0:c.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const h=Ho+l;return r[1].config.variable=h,o._userVariables[h]={className:"Mesh",id:(p=(d=s==null?void 0:s.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:p.id,uniqueId:(g=(f=s==null?void 0:s.nodes)==null?void 0:f[l]._babylonTransformNode)==null?void 0:g.uniqueId},r}});const zo="targetMeshPointerOut_";Eo("event/onHoverOut",Rn,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(i){return[zo+i[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(i,e,t,n,r,o,s){var u,c,d,p,f,g;const a=r[r.length-1];a.config=a.config||{},a.config.glTF=s;const l=(c=(u=i.configuration)==null?void 0:u.nodeIndex)==null?void 0:c.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const h=zo+l;return r[1].config.variable=h,o._userVariables[h]={className:"Mesh",id:(p=(d=s==null?void 0:s.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:p.id,uniqueId:(g=(f=s==null?void 0:s.nodes)==null?void 0:f[l]._babylonTransformNode)==null?void 0:g.uniqueId},r}});Yt("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:i=>{const e=i._babylonTransformNode;return e&&e.pointerOverDisableMeshTesting!==void 0?e.pointerOverDisableMeshTesting:!0},set:(i,e)=>{var t;(t=e._primitiveBabylonMeshes)==null||t.forEach(n=>{n.pointerOverDisableMeshTesting=!i})},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});class ka{constructor(e){this.name=Rn,this._loader=e,this.enabled=e.isExtensionUsed(Rn)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,r,o;(n=t.extensions)!=null&&n.KHR_node_hoverability&&((r=t.extensions)==null?void 0:r.KHR_node_hoverability.hoverable)===!1&&((o=t._babylonTransformNode)==null||o.getChildMeshes().forEach(s=>{s.pointerOverDisableMeshTesting=!0}))})}dispose(){this._loader=null}}Ne(Rn);Re(Rn,!0,i=>new ka(i));const Mo="ExtrasAsMetadata";class Va{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const n=e.metadata=e.metadata||{},r=n.gltf=n.gltf||{};r.extras=t.extras}}constructor(e){this.name=Mo,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,n){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}loadCameraAsync(e,t,n){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}createMaterial(e,t,n){const r=this._loader.createMaterial(e,t,n);return this._assignExtras(r,t),r}}Ne(Mo);Re(Mo,!1,i=>new Va(i));class Ut{constructor(){this.materials=[]}parseMTL(e,t,n,r){if(t instanceof ArrayBuffer)return;const o=t.split(`
`),s=/\s+/;let a,l=null;for(let h=0;h<o.length;h++){const u=o[h].trim();if(u.length===0||u.charAt(0)==="#")continue;const c=u.indexOf(" ");let d=c>=0?u.substring(0,c):u;d=d.toLowerCase();const p=c>=0?u.substring(c+1).trim():"";if(d==="newmtl")l&&this.materials.push(l),e._blockEntityCollection=!!r,l=new Bt(p,e),l._parentContainer=r,e._blockEntityCollection=!1;else if(d==="kd"&&l)a=p.split(s,3).map(parseFloat),l.diffuseColor=ie.FromArray(a);else if(d==="ka"&&l)a=p.split(s,3).map(parseFloat),l.ambientColor=ie.FromArray(a);else if(d==="ks"&&l)a=p.split(s,3).map(parseFloat),l.specularColor=ie.FromArray(a);else if(d==="ke"&&l)a=p.split(s,3).map(parseFloat),l.emissiveColor=ie.FromArray(a);else if(d==="ns"&&l)l.specularPower=parseFloat(p);else if(d==="d"&&l)l.alpha=parseFloat(p);else if(d==="map_ka"&&l)l.ambientTexture=Ut._GetTexture(n,p,e);else if(d==="map_kd"&&l)l.diffuseTexture=Ut._GetTexture(n,p,e);else if(d==="map_ks"&&l)l.specularTexture=Ut._GetTexture(n,p,e);else if(d!=="map_ns")if(d==="map_bump"&&l){const f=p.split(s),g=f.indexOf("-bm");let y=null;g>=0&&(y=f[g+1],f.splice(g,2)),l.bumpTexture=Ut._GetTexture(n,f.join(" "),e),l.bumpTexture&&y!==null&&(l.bumpTexture.level=parseFloat(y))}else d==="map_d"&&l&&(l.opacityTexture=Ut._GetTexture(n,p,e))}l&&this.materials.push(l)}static _GetTexture(e,t,n){if(!t)return null;let r=e;if(e==="file:"){let o=t.lastIndexOf("\\");o===-1&&(o=t.lastIndexOf("/")),o>-1?r+=t.substring(o+1):r+=t}else r+=t;return new We(r,n,!1,Ut.INVERT_TEXTURE_Y)}}Ut.INVERT_TEXTURE_Y=!0;class Le{constructor(e,t,n){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._extColors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new Xt(.5,.5,.5,1),this._hasLineData=!1,this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=n}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});const n=e[t[0]].normals.indexOf(t[1]);return n===-1?-1:e[t[0]].idx[n]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});const n=e[t[0]].normals.indexOf(t[1]);return n!=1&&t[2]===e[t[0]].uv[n]?e[t[0]].idx[n]:-1}_setData(e){e.indiceUvsFromObj??(e.indiceUvsFromObj=-1),e.indiceNormalFromObj??(e.indiceNormalFromObj=-1);let t;this._loadingOptions.optimizeWithUV?t=this._isInArrayUV(this._tuplePosNorm,[e.indicePositionFromObj,e.indiceNormalFromObj,e.indiceUvsFromObj]):t=this._isInArray(this._tuplePosNorm,[e.indicePositionFromObj,e.indiceNormalFromObj]),t===-1?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(e.positionVectorFromOBJ),e.textureVectorFromOBJ!==void 0&&this._wrappedUvsForBabylon.push(e.textureVectorFromOBJ),e.normalsVectorFromOBJ!==void 0&&this._wrappedNormalsForBabylon.push(e.normalsVectorFromOBJ),e.positionColorsFromOBJ!==void 0&&this._wrappedColorsForBabylon.push(e.positionColorsFromOBJ),this._tuplePosNorm[e.indicePositionFromObj].normals.push(e.indiceNormalFromObj),this._tuplePosNorm[e.indicePositionFromObj].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e.indicePositionFromObj].uv.push(e.indiceUvsFromObj)):this._indicesForBabylon.push(t)}_unwrapData(){try{for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x*this._handednessSign,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._wrappedNormalsForBabylon.length&&this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x*this._handednessSign,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._wrappedUvsForBabylon.length&&this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._unwrappedColorsForBabylon.length&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}catch{throw new Error("Unable to unwrap data while parsing OBJ data.")}}_getTriangles(e,t){for(let n=t;n<e.length-1;n++)this._pushTriangle(e,n)}_getColor(e){if(this._loadingOptions.importVertexColors)return this._extColors[e]??this._colors[e]}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=parseInt(this._triangles[n])-1;this._setData({indicePositionFromObj:r,positionVectorFromOBJ:this._positions[r],positionColorsFromOBJ:this._getColor(r)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("/"),o=parseInt(r[0])-1,s=parseInt(r[1])-1;this._setData({indicePositionFromObj:o,indiceUvsFromObj:s,positionVectorFromOBJ:this._positions[o],textureVectorFromOBJ:this._uvs[s],positionColorsFromOBJ:this._getColor(o)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("/"),o=parseInt(r[0])-1,s=parseInt(r[1])-1,a=parseInt(r[2])-1;this._setData({indicePositionFromObj:o,indiceUvsFromObj:s,indiceNormalFromObj:a,positionVectorFromOBJ:this._positions[o],textureVectorFromOBJ:this._uvs[s],normalsVectorFromOBJ:this._normals[a]})}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("//"),o=parseInt(r[0])-1,s=parseInt(r[1])-1;this._setData({indicePositionFromObj:o,indiceNormalFromObj:s,positionVectorFromOBJ:this._positions[o],normalsVectorFromOBJ:this._normals[s],positionColorsFromOBJ:this._getColor(o)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let n=0;n<this._triangles.length;n++){const r=this._triangles[n].split("/"),o=this._positions.length+parseInt(r[0]),s=this._uvs.length+parseInt(r[1]),a=this._normals.length+parseInt(r[2]);this._setData({indicePositionFromObj:o,indiceUvsFromObj:s,indiceNormalFromObj:a,positionVectorFromOBJ:this._positions[o],textureVectorFromOBJ:this._uvs[s],normalsVectorFromOBJ:this._normals[a],positionColorsFromOBJ:this._getColor(o)})}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice()),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon.slice()),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._handledMesh.hasLines=this._hasLineData,this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0,this._hasLineData=!1)}_optimizeNormals(e){const t=e.getVerticesData(Ie.PositionKind),n=e.getVerticesData(Ie.NormalKind),r={};if(!t||!n)return;for(let s=0;s<t.length/3;s++){const a=t[s*3+0],l=t[s*3+1],h=t[s*3+2],u=a+"_"+l+"_"+h;let c=r[u];c||(c=[],r[u]=c),c.push(s)}const o=new Q;for(const s in r){const a=r[s];if(a.length<2)continue;const l=a[0];for(let h=1;h<a.length;++h){const u=a[h];n[l*3+0]+=n[u*3+0],n[l*3+1]+=n[u*3+1],n[l*3+2]+=n[u*3+2]}o.copyFromFloats(n[l*3+0],n[l*3+1],n[l*3+2]),o.normalize();for(let h=0;h<a.length;++h){const u=a[h];n[u*3+0]=o.x,n[u*3+1]=o.y,n[u*3+2]=o.z}}e.setVerticesData(Ie.NormalKind,n)}static _IsLineElement(e){return e.startsWith("l")}static _IsObjectElement(e){return e.startsWith("o")}static _IsGroupElement(e){return e.startsWith("g")}static _GetZbrushMRGB(e,t){if(!e.startsWith("mrgb"))return null;if(e=e.replace("mrgb","").trim(),t)return[];const n=/[a-z0-9]/g,r=e.match(n);if(!r||r.length%8!==0)return[];const o=[];for(let s=0;s<r.length/8;s++){const a=r[s*8+2]+r[s*8+3],l=r[s*8+4]+r[s*8+5],h=r[s*8+6]+r[s*8+7];o.push(new Xt(parseInt(a,16)/255,parseInt(l,16)/255,parseInt(h,16)/255,1))}return o}parse(e,t,n,r,o){var u;t=t.replace(/#MRGB/g,"mrgb"),t=t.replace(/#.*$/gm,"").trim(),this._loadingOptions.useLegacyBehavior?(this._pushTriangle=(c,d)=>this._triangles.push(c[0],c[d],c[d+1]),this._handednessSign=1):n.useRightHandedSystem?(this._pushTriangle=(c,d)=>this._triangles.push(c[0],c[d+1],c[d]),this._handednessSign=1):(this._pushTriangle=(c,d)=>this._triangles.push(c[0],c[d],c[d+1]),this._handednessSign=-1);const s=t.split(`
`),a=[];let l=[];a.push(l);for(let c=0;c<s.length;c++){const d=s[c].trim().replace(/\s\s/g," ");if(!(d.length===0||d.charAt(0)==="#"))if((Le._IsGroupElement(d)||Le._IsObjectElement(d))&&(l=[],a.push(l)),Le._IsLineElement(d)){const p=d.split(" ");for(let f=1;f<p.length-1;f++)l.push(`l ${p[f]} ${p[f+1]}`)}else l.push(d)}const h=a.flat();for(let c=0;c<h.length;c++){const d=h[c].trim().replace(/\s\s/g," ");let p;if(!(d.length===0||d.charAt(0)==="#"))if(Le.VertexPattern.test(d)){if(p=d.match(/[^ ]+/g),this._positions.push(new Q(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]))),this._loadingOptions.importVertexColors)if(p.length>=7){const f=parseFloat(p[4]),g=parseFloat(p[5]),y=parseFloat(p[6]);this._colors.push(new Xt(f>1?f/255:f,g>1?g/255:g,y>1?y/255:y,p.length===7||p[7]===void 0?1:parseFloat(p[7])))}else this._colors.push(this._grayColor)}else if((p=Le.NormalPattern.exec(d))!==null)this._normals.push(new Q(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])));else if((p=Le.UVPattern.exec(d))!==null)this._uvs.push(new Cn(parseFloat(p[1])*this._loadingOptions.UVScaling.x,parseFloat(p[2])*this._loadingOptions.UVScaling.y));else if((p=Le.FacePattern3.exec(d))!==null)this._setDataForCurrentFaceWithPattern3(p[1].trim().split(" "),1);else if((p=Le.FacePattern4.exec(d))!==null)this._setDataForCurrentFaceWithPattern4(p[1].trim().split(" "),1);else if((p=Le.FacePattern5.exec(d))!==null)this._setDataForCurrentFaceWithPattern5(p[1].trim().split(" "),1);else if((p=Le.FacePattern2.exec(d))!==null)this._setDataForCurrentFaceWithPattern2(p[1].trim().split(" "),1);else if((p=Le.FacePattern1.exec(d))!==null)this._setDataForCurrentFaceWithPattern1(p[1].trim().split(" "),1);else if((p=Le.LinePattern1.exec(d))!==null)this._setDataForCurrentFaceWithPattern1(p[1].trim().split(" "),0),this._hasLineData=!0;else if((p=Le.LinePattern2.exec(d))!==null)this._setDataForCurrentFaceWithPattern2(p[1].trim().split(" "),0),this._hasLineData=!0;else if(p=Le._GetZbrushMRGB(d,!this._loadingOptions.importVertexColors))for(const f of p)this._extColors.push(f);else if((p=Le.LinePattern3.exec(d))!==null)this._setDataForCurrentFaceWithPattern3(p[1].trim().split(" "),0),this._hasLineData=!0;else if(Le.GroupDescriptor.test(d)||Le.ObjectDescriptor.test(d)){const f={name:d.substring(2).trim(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:Le.ObjectDescriptor.test(d)};this._addPreviousObjMesh(),this._meshesFromObj.push(f),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(Le.UseMtlDescriptor.test(d)){if(this._materialNameFromObj=d.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const f={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:!1};this._increment++,this._meshesFromObj.push(f),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else Le.MtlLibGroupDescriptor.test(d)?o(d.substring(7).trim()):Le.SmoothDescriptor.test(d)||Me.Log("Unhandled expression at line : "+d)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon),this._handledMesh.hasLines=this._hasLineData),!this._hasMeshes){let c=null;if(this._indicesForBabylon.length)this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData();else{for(const d of this._positions)this._unwrappedPositionsForBabylon.push(d.x,d.y,d.z);if(this._normals.length)for(const d of this._normals)this._unwrappedNormalsForBabylon.push(d.x,d.y,d.z);if(this._uvs.length)for(const d of this._uvs)this._unwrappedUVForBabylon.push(d.x,d.y);if(this._extColors.length)for(const d of this._extColors)this._unwrappedColorsForBabylon.push(d.r,d.g,d.b,d.a);else if(this._colors.length)for(const d of this._colors)this._unwrappedColorsForBabylon.push(d.r,d.g,d.b,d.a);this._materialNameFromObj||(c=new Bt(Jn.RandomId(),n),c.pointsCloud=!0,this._materialNameFromObj=c.name,this._normals.length||(c.disableLighting=!0,c.emissiveColor=ie.White()))}this._meshesFromObj.push({name:Jn.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:c,isObject:!0,hasLines:this._hasLineData})}for(let c=0;c<this._meshesFromObj.length;c++){if(e&&this._meshesFromObj[c].name){if(e instanceof Array){if(e.indexOf(this._meshesFromObj[c].name)===-1)continue}else if(this._meshesFromObj[c].name!==e)continue}this._handledMesh=this._meshesFromObj[c],n._blockEntityCollection=!!r;const d=new xt(this._meshesFromObj[c].name,n);if(d._parentContainer=r,n._blockEntityCollection=!1,this._handledMesh._babylonMesh=d,!this._handledMesh.isObject){for(let f=c-1;f>=0;--f)if(this._meshesFromObj[f].isObject&&this._meshesFromObj[f]._babylonMesh){d.parent=this._meshesFromObj[f]._babylonMesh;break}}if(this._materialToUse.push(this._meshesFromObj[c].materialName),this._handledMesh.hasLines&&(d._internalMetadata??(d._internalMetadata={}),d._internalMetadata._isLine=!0),((u=this._handledMesh.positions)==null?void 0:u.length)===0){this._babylonMeshesArray.push(d);continue}const p=new Zn;if(p.indices=this._handledMesh.indices,p.positions=this._handledMesh.positions,this._loadingOptions.computeNormals||!this._handledMesh.normals){const f=new Array;Zn.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,f),p.normals=f}else p.normals=this._handledMesh.normals;this._handledMesh.uvs&&(p.uvs=this._handledMesh.uvs),this._handledMesh.colors&&(p.colors=this._handledMesh.colors),p.applyToMesh(d),this._loadingOptions.invertY&&(d.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(d),this._babylonMeshesArray.push(d),this._handledMesh.directMaterial&&(d.material=this._handledMesh.directMaterial)}}}Le.ObjectDescriptor=/^o/;Le.GroupDescriptor=/^g/;Le.MtlLibGroupDescriptor=/^mtllib /;Le.UseMtlDescriptor=/^usemtl /;Le.SmoothDescriptor=/^s /;Le.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/;Le.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;Le.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;Le.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/;Le.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;Le.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;Le.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/;Le.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/;Le.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/;Le.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;Le.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;const Us={name:"obj",extensions:".obj"};class ot{static get INVERT_TEXTURE_Y(){return Ut.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){Ut.INVERT_TEXTURE_Y=e}constructor(e){this.name=Us.name,this.extensions=Us.extensions,this._assetContainer=null,this._loadingOptions={...ot._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{computeNormals:ot.COMPUTE_NORMALS,optimizeNormals:ot.OPTIMIZE_NORMALS,importVertexColors:ot.IMPORT_VERTEX_COLORS,invertY:ot.INVERT_Y,invertTextureY:ot.INVERT_TEXTURE_Y,UVScaling:ot.UV_SCALING,materialLoadingFailsSilently:ot.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:ot.OPTIMIZE_WITH_UV,skipMaterials:ot.SKIP_MATERIALS,useLegacyBehavior:ot.USE_LEGACY_BEHAVIOR}}_loadMTL(e,t,n,r){const o=t+e;ke.LoadFile(o,n,void 0,void 0,!1,(s,a)=>{r(o,a)})}createPlugin(e){return new ot(e[Us.name])}canDirectLoad(){return!1}importMeshAsync(e,t,n,r){return this._parseSolidAsync(e,t,n,r).then(o=>({meshes:o,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}loadAsync(e,t,n){return this.importMeshAsync(null,e,t,n).then(()=>{})}loadAssetContainerAsync(e,t,n){const r=new Wn(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,n).then(o=>(o.meshes.forEach(s=>r.meshes.push(s)),o.meshes.forEach(s=>{const a=s.material;a&&r.materials.indexOf(a)==-1&&(r.materials.push(a),a.getActiveTextures().forEach(h=>{r.textures.indexOf(h)==-1&&r.textures.push(h)}))}),this._assetContainer=null,r)).catch(o=>{throw this._assetContainer=null,o})}_parseSolidAsync(e,t,n,r){let o="";const s=new Ut,a=[],l=[];n=n.replace(/#.*$/gm,"").trim(),new Le(a,l,this._loadingOptions).parse(e,n,t,this._assetContainer,c=>{o=c});const u=[];return o!==""&&!this._loadingOptions.skipMaterials&&u.push(new Promise((c,d)=>{this._loadMTL(o,r,p=>{try{s.parseMTL(t,p,r,this._assetContainer);for(let f=0;f<s.materials.length;f++){let g=0;const y=[];let m;for(;(m=a.indexOf(s.materials[f].name,g))>-1;)y.push(m),g=m+1;if(m===-1&&y.length===0)s.materials[f].dispose();else for(let _=0;_<y.length;_++){const b=l[y[_]],v=s.materials[f];b.material=v,b.getTotalIndices()||(v.pointsCloud=!0)}}c()}catch(f){ke.Warn(`Error processing MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?c():d(f)}},(p,f)=>{ke.Warn(`Error downloading MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?c():d(f)})})),Promise.all(u).then(()=>{const c=d=>{var p;return!!(((p=d._internalMetadata)==null?void 0:p._isLine)??!1)};return l.forEach(d=>{if(c(d)){let p=d.material??new Bt(d.name+"_line",t);p.getBindedMeshes().filter(g=>!c(g)).length>0&&(p=p.clone(p.name+"_line")??p),p.wireframe=!0,d.material=p,d._internalMetadata&&(d._internalMetadata._isLine=void 0)}}),l})}}ot.OPTIMIZE_WITH_UV=!0;ot.INVERT_Y=!1;ot.IMPORT_VERTEX_COLORS=!1;ot.COMPUTE_NORMALS=!1;ot.OPTIMIZE_NORMALS=!1;ot.UV_SCALING=new Cn(1,1);ot.SKIP_MATERIALS=!1;ot.MATERIAL_LOADING_FAILS_SILENTLY=!0;ot.USE_LEGACY_BEHAVIOR=!1;Un(new ot);const Uo={name:"stl",extensions:{".stl":{isBinary:!0}}};class Tn{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name=Uo.name,this.extensions=Uo.extensions}importMesh(e,t,n,r,o){let s;if(typeof n!="string"){if(this._isBinary(n)){const a=new xt("stlmesh",t);return this._parseBinary(a,n),o&&o.push(a),!0}n=new TextDecoder().decode(new Uint8Array(n))}for(;s=this.solidPattern.exec(n);){let a=s[1];const l=s[3];if(l&&a!=l)return ke.Error("Error in STL, solid name != endsolid name"),!1;if(e&&a){if(e instanceof Array){if(!e.indexOf(a))continue}else if(a!==e)continue}a=a||"stlmesh";const h=new xt(a,t);this._parseASCII(h,s[2]),o&&o.push(h)}return!0}load(e,t,n){return this.importMesh(null,e,t,n,null)}loadAssetContainer(e,t,n){const r=new Wn(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,n,r.meshes),e._blockEntityCollection=!1,r}_isBinary(e){const t=new DataView(e);if(t.byteLength<=80)return!1;const n=32/8*3+32/8*3*3+16/8,r=t.getUint32(80,!0);if(80+32/8+r*n===t.byteLength)return!0;const o=[115,111,108,105,100];for(let s=0;s<5;s++)if(t.getUint8(s)!==o[s])return!0;return!1}_parseBinary(e,t){const n=new DataView(t),r=n.getUint32(80,!0),o=84,s=12*4+2;let a=0;const l=new Float32Array(r*3*3),h=new Float32Array(r*3*3),u=new Uint32Array(r*3);let c=0;for(let d=0;d<r;d++){const p=o+d*s,f=n.getFloat32(p,!0),g=n.getFloat32(p+4,!0),y=n.getFloat32(p+8,!0);for(let m=1;m<=3;m++){const _=p+m*12;l[a]=n.getFloat32(_,!0),h[a]=f,Tn.DO_NOT_ALTER_FILE_COORDINATES?(l[a+1]=n.getFloat32(_+4,!0),l[a+2]=n.getFloat32(_+8,!0),h[a+1]=g,h[a+2]=y):(l[a+2]=n.getFloat32(_+4,!0),l[a+1]=n.getFloat32(_+8,!0),h[a+2]=g,h[a+1]=y),a+=3}Tn.DO_NOT_ALTER_FILE_COORDINATES?(u[c]=c,u[c+1]=c+2,u[c+2]=c+1,c+=3):(u[c]=c++,u[c]=c++,u[c]=c++)}e.setVerticesData(Ie.PositionKind,l),e.setVerticesData(Ie.NormalKind,h),e.setIndices(u),e.computeWorldMatrix(!0)}_parseASCII(e,t){const n=[],r=[],o=[];let s=0,a;for(;a=this.facetsPattern.exec(t);){const l=a[1],h=this.normalPattern.exec(l);if(this.normalPattern.lastIndex=0,!h)continue;const u=[Number(h[1]),Number(h[5]),Number(h[3])];let c;for(;c=this.vertexPattern.exec(l);)Tn.DO_NOT_ALTER_FILE_COORDINATES?(n.push(Number(c[1]),Number(c[3]),Number(c[5])),r.push(u[0],u[2],u[1])):(n.push(Number(c[1]),Number(c[5]),Number(c[3])),r.push(u[0],u[1],u[2]));Tn.DO_NOT_ALTER_FILE_COORDINATES?(o.push(s,s+2,s+1),s+=3):o.push(s++,s++,s++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(Ie.PositionKind,n),e.setVerticesData(Ie.NormalKind,r),e.setIndices(o),e.computeWorldMatrix(!0)}}Tn.DO_NOT_ALTER_FILE_COORDINATES=!1;Un(new Tn);const Ws={name:"splat",extensions:{".splat":{isBinary:!0},".ply":{isBinary:!0},".spz":{isBinary:!0},".json":{isBinary:!1},".sog":{isBinary:!0}}};function Da(i,e,t){const n=new Uint8Array(i),r=new Uint32Array(i.slice(0,12)),o=r[2],s=n[12],a=n[13],l=n[14],h=n[15],u=r[1];if(h||r[0]!=1347635022||u!=2&&u!=3)return new Promise(B=>{B({mode:3,data:d,hasVertexColors:!1})});const c=3*4+3*4+4+4,d=new ArrayBuffer(c*o),p=1/(1<<a),f=new Int32Array(1),g=new Uint8Array(f.buffer),y=function(B,P){return g[0]=B[P+0],g[1]=B[P+1],g[2]=B[P+2],g[3]=B[P+2]&128?255:0,f[0]*p};let m=16;const _=new Float32Array(d),b=new Float32Array(d),v=new Uint8ClampedArray(d),w=new Uint8ClampedArray(d);let I=1,V=0;t.flipY||(I=-1,V=255);for(let B=0;B<o;B++)_[B*8+0]=y(n,m+0),_[B*8+1]=I*y(n,m+3),_[B*8+2]=I*y(n,m+6),m+=9;const M=.282;for(let B=0;B<o;B++){for(let P=0;P<3;P++){const N=(n[m+o+B*3+P]-127.5)/(.15*255);v[B*32+24+P]=kn.Clamp((.5+M*N)*255,0,255)}v[B*32+24+3]=n[m+B]}m+=o*4;for(let B=0;B<o;B++)b[B*8+3+0]=Math.exp(n[m+0]/16-10),b[B*8+3+1]=Math.exp(n[m+1]/16-10),b[B*8+3+2]=Math.exp(n[m+2]/16-10),m+=3;if(u>=3){const B=Math.SQRT1_2;for(let P=0;P<o;P++){const T=[n[m+0],n[m+1],n[m+2],n[m+3]],N=T[0]+(T[1]<<8)+(T[2]<<16)+(T[3]<<24),R=511,$=[],z=N>>>30;let ae=N,L=0;for(let G=3;G>=0;--G)if(G!==z){const E=ae&R,k=ae>>>9&1;ae=ae>>>10,$[G]=B*(E/R),k===1&&($[G]=-$[G]),L+=$[G]*$[G]}const S=1-L;$[z]=Math.sqrt(Math.max(S,0)),$[1]*=I,$[2]*=I;const j=[3,0,1,2];for(let G=0;G<4;G++)w[P*32+28+G]=Math.round(127.5+$[j[G]]*127.5);m+=4}}else for(let B=0;B<o;B++){const P=n[m+0],T=n[m+1]*I+V,N=n[m+2]*I+V,R=P/127.5-1,$=T/127.5-1,z=N/127.5-1;w[B*32+28+1]=P,w[B*32+28+2]=T,w[B*32+28+3]=N;const ae=1-(R*R+$*$+z*z);w[B*32+28+0]=127.5+Math.sqrt(ae<0?0:ae)*127.5,m+=3}if(s){const P=((s+1)*(s+1)-1)*3,T=Math.ceil(P/16);let N=m;const R=[],z=e.getEngine().getCaps().maxTextureSize,ae=Math.ceil(o/z);for(let L=0;L<T;L++){const S=new Uint8Array(ae*z*4*4);R.push(S)}for(let L=0;L<o;L++)for(let S=0;S<P;S++){const j=n[N++],G=Math.floor(S/16),E=R[G],k=S%16,C=L*16;E[k+C]=j}return new Promise(L=>{L({mode:0,data:d,hasVertexColors:!1,sh:R,trainedWithAntialiasing:!!l})})}return new Promise(B=>{B({mode:0,data:d,hasVertexColors:!1,trainedWithAntialiasing:!!l})})}const Wo=.28209479177387814;async function qo(i,e,t){return await new Promise((r,o)=>{const s=t.createCanvasImage();if(!s)throw new Error("Failed to create ImageBitmap");s.onload=()=>{try{const l=t.createCanvas(s.width,s.height);if(!l)throw new Error("Failed to create canvas");const h=l.getContext("2d");if(!h)throw new Error("Failed to get 2D context");h.drawImage(s,0,0);const u=h.getImageData(0,0,l.width,l.height);r({bits:new Uint8Array(u.data.buffer),width:u.width})}catch(l){o(`Error loading image ${s.src} with exception: ${l}`)}},s.onerror=l=>{o(`Error loading image ${s.src} with exception: ${l}`)},s.crossOrigin="anonymous";let a;if(typeof i=="string"){if(!e)throw new Error("filename is required when using a URL");s.src=i+e}else{const l=new Blob([i],{type:"image/webp"});a=URL.createObjectURL(l),s.src=a}})}async function Ga(i,e,t){const n=i.count?i.count:i.means.shape[0],r=3*4+3*4+4+4,o=new ArrayBuffer(r*n),s=new Float32Array(o),a=new Float32Array(o),l=new Uint8ClampedArray(o),h=new Uint8ClampedArray(o),u=m=>Math.sign(m)*(Math.exp(Math.abs(m))-1),c=e[0].bits,d=e[1].bits;if(!Array.isArray(i.means.mins)||!Array.isArray(i.means.maxs))throw new Error("Missing arrays in SOG data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=i.means.mins[b],w=i.means.maxs[b],I=d[_+b],V=c[_+b],M=I<<8|V,B=kn.Lerp(v,w,M/65535);s[m*8+b]=u(B)}}const p=e[2].bits;if(i.version===2){if(!i.scales.codebook)throw new Error("Missing codebook in SOG version 2 scales data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=i.scales.codebook[p[_+b]],w=Math.exp(v);a[m*8+3+b]=w}}}else{if(!Array.isArray(i.scales.mins)||!Array.isArray(i.scales.maxs))throw new Error("Missing arrays in SOG scales data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=p[_+b],w=kn.Lerp(i.scales.mins[b],i.scales.maxs[b],v/255),I=Math.exp(w);a[m*8+3+b]=I}}}const f=e[4].bits;if(i.version===2){if(!i.sh0.codebook)throw new Error("Missing codebook in SOG version 2 sh0 data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<3;b++){const v=.5+i.sh0.codebook[f[_+b]]*Wo;l[m*32+24+b]=Math.max(0,Math.min(255,Math.round(255*v)))}l[m*32+24+3]=f[_+3]}}else{if(!Array.isArray(i.sh0.mins)||!Array.isArray(i.sh0.maxs))throw new Error("Missing arrays in SOG sh0 data.");for(let m=0;m<n;m++){const _=m*4;for(let b=0;b<4;b++){const v=i.sh0.mins[b],w=i.sh0.maxs[b],I=f[_+b],V=kn.Lerp(v,w,I/255);let M;b<3?M=.5+V*Wo:M=1/(1+Math.exp(-V)),l[m*32+24+b]=Math.max(0,Math.min(255,Math.round(255*M)))}}}const g=m=>(m/255-.5)*2/Math.SQRT2,y=e[3].bits;for(let m=0;m<n;m++){const _=y[m*4+0],b=y[m*4+1],v=y[m*4+2],w=y[m*4+3],I=g(_),V=g(b),M=g(v),B=w-252,P=I*I+V*V+M*M,T=Math.sqrt(Math.max(0,1-P));let N;switch(B){case 0:N=[T,I,V,M];break;case 1:N=[I,T,V,M];break;case 2:N=[I,V,T,M];break;case 3:N=[I,V,M,T];break;default:throw new Error("Invalid quaternion mode")}h[m*32+28+0]=N[0]*127.5+127.5,h[m*32+28+1]=N[1]*127.5+127.5,h[m*32+28+2]=N[2]*127.5+127.5,h[m*32+28+3]=N[3]*127.5+127.5}if(i.shN){const m=[0,3,8,15],_=i.shN.bands?m[i.shN.bands]:i.shN.shape[1]/3,b=e[5].bits,v=e[6].bits,w=e[5].width,I=_*3,V=Math.ceil(I/16),M=[],P=t.getEngine().getCaps().maxTextureSize,T=Math.ceil(n/P);for(let N=0;N<V;N++){const R=new Uint8Array(T*P*4*4);M.push(R)}if(i.version===2){if(!i.shN.codebook)throw new Error("Missing codebook in SOG version 2 shN data.");for(let N=0;N<n;N++){const R=v[N*4+0]+(v[N*4+1]<<8),$=R%64*_,z=Math.floor(R/64);for(let ae=0;ae<_;ae++)for(let L=0;L<3;L++){const S=ae*3+L,j=Math.floor(S/16),G=M[j],E=S%16,k=N*16,C=i.shN.codebook[b[($+ae)*4+L+z*w*4]]*127.5+127.5;G[E+k]=Math.max(0,Math.min(255,C))}}}else for(let N=0;N<n;N++){const R=v[N*4+0]+(v[N*4+1]<<8),$=R%64*_,z=Math.floor(R/64),ae=i.shN.mins,L=i.shN.maxs;for(let S=0;S<3;S++)for(let j=0;j<_/3;j++){const G=j*3+S,E=Math.floor(G/16),k=M[E],C=G%16,A=N*16,x=kn.Lerp(ae,L,b[($+j)*4+S+z*w*4]/255)*127.5+127.5;k[C+A]=Math.max(0,Math.min(255,x))}}return await new Promise(N=>{N({mode:0,data:o,hasVertexColors:!1,sh:M})})}return await new Promise(m=>{m({mode:0,data:o,hasVertexColors:!1})})}async function Ko(i,e,t){let n,r;if(i instanceof Map){r=i;const a=r.get("meta.json");if(!a)throw new Error("meta.json not found in files Map");n=JSON.parse(new TextDecoder().decode(a))}else n=i;const o=[...n.means.files,...n.scales.files,...n.quats.files,...n.sh0.files];n.shN&&o.push(...n.shN.files);const s=await Promise.all(o.map(async a=>{if(r&&r.has(a)){const l=r.get(a);return await qo(l,a,t.getEngine())}else return await qo(e,a,t.getEngine())}));return await Ga(n,s,t)}class dn{constructor(e=dn._DefaultLoadingOptions){this.name=Ws.name,this._assetContainer=null,this.extensions=Ws.extensions,this._loadingOptions=e}createPlugin(e){return new dn(e[Ws.name])}async importMeshAsync(e,t,n,r,o,s){return await this._parseAsync(e,t,n,r).then(a=>({meshes:a,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}static _BuildPointCloud(e,t){if(!t.byteLength)return!1;const n=new Uint8Array(t),r=new Float32Array(t),o=3*4+3*4+4+4,s=n.length/o,a=function(l,h){const u=r[8*h+0],c=r[8*h+1],d=r[8*h+2];l.position=new Q(u,c,d);const p=n[o*h+24+0]/255,f=n[o*h+24+1]/255,g=n[o*h+24+2]/255;l.color=new Xt(p,f,g,1)};return e.addPoints(s,a),!0}static _BuildMesh(e,t){const n=new xt("PLYMesh",e),r=new Uint8Array(t.data),o=new Float32Array(t.data),s=3*4+3*4+4+4,a=r.length/s,l=[],h=new Zn;for(let u=0;u<a;u++){const c=o[8*u+0],d=o[8*u+1],p=o[8*u+2];l.push(c,d,p)}if(t.hasVertexColors){const u=new Float32Array(a*4);for(let c=0;c<a;c++){const d=r[s*c+24+0]/255,p=r[s*c+24+1]/255,f=r[s*c+24+2]/255;u[c*4+0]=d,u[c*4+1]=p,u[c*4+2]=f,u[c*4+3]=1}h.colors=u}return h.positions=l,h.indices=t.faces,h.applyToMesh(n),n}async _unzipWithFFlateAsync(e){let t=this._loadingOptions.fflate;t||(typeof window.fflate>"u"&&await ke.LoadScriptAsync(this._loadingOptions.deflateURL??"https://unpkg.com/fflate/umd/index.js"),t=window.fflate);const{unzipSync:n}=t,r=n(e),o=new Map;for(const[s,a]of Object.entries(r))o.set(s,a);return o}_parseAsync(e,t,n,r){const o=[],s=c=>{t._blockEntityCollection=!!this._assetContainer;const d=new Kn("GaussianSplatting",null,t,this._loadingOptions.keepInRam);d._parentContainer=this._assetContainer,d.viewDirectionFactor.set(1,-1,1),o.push(d),d.updateData(c.data,c.sh),t._blockEntityCollection=!1};if(typeof n=="string"){const c=JSON.parse(n);if(c&&c.means&&c.scales&&c.quats&&c.sh0)return new Promise(d=>{Ko(c,r,t).then(p=>{s(p),d(o)}).catch(()=>{throw new Error("Failed to parse SOG data.")})})}const a=n instanceof ArrayBuffer?new Uint8Array(n):n;if(a[0]===80&&a[1]===75)return new Promise(c=>{this._unzipWithFFlateAsync(a).then(d=>{Ko(d,r,t).then(p=>{s(p),c(o)}).catch(()=>{throw new Error("Failed to parse SOG zip data.")})})});const l=new ReadableStream({start(c){c.enqueue(new Uint8Array(n)),c.close()}}),h=new DecompressionStream("gzip"),u=l.pipeThrough(h);return new Promise(c=>{new Response(u).arrayBuffer().then(d=>{Da(d,t,this._loadingOptions).then(p=>{t._blockEntityCollection=!!this._assetContainer;const f=new Kn("GaussianSplatting",null,t,this._loadingOptions.keepInRam);if(p.trainedWithAntialiasing){const g=f.material;g.kernelSize=.1,g.compensation=!0}f._parentContainer=this._assetContainer,o.push(f),f.updateData(p.data,p.sh),t._blockEntityCollection=!1,c(o)})}).catch(()=>{dn._ConvertPLYToSplat(n).then(async d=>{switch(t._blockEntityCollection=!!this._assetContainer,d.mode){case 0:{const p=new Kn("GaussianSplatting",null,t,this._loadingOptions.keepInRam);p._parentContainer=this._assetContainer,o.push(p),p.updateData(d.data,d.sh),(d.compressed||!d.rawSplat)&&p.viewDirectionFactor.set(-1,-1,1)}break;case 1:{const p=new ti("PointCloud",1,t);dn._BuildPointCloud(p,d.data)?await p.buildMeshAsync().then(f=>{o.push(f)}):p.dispose()}break;case 2:if(d.faces)o.push(dn._BuildMesh(t,d));else throw new Error("PLY mesh doesn't contain face informations.");break;default:throw new Error("Unsupported Splat mode")}t._blockEntityCollection=!1,c(o)})})})}loadAssetContainerAsync(e,t,n){const r=new Wn(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,n).then(o=>{for(const s of o.meshes)r.meshes.push(s);return this._assetContainer=null,r}).catch(o=>{throw this._assetContainer=null,o})}loadAsync(e,t,n){return this.importMeshAsync(null,e,t,n).then(()=>{})}static _ConvertPLYToSplat(e){const t=new Uint8Array(e),n=new TextDecoder().decode(t.slice(0,1024*10)),r=`end_header
`,o=n.indexOf(r);if(o<0||!n)return new Promise(v=>{v({mode:0,data:e,rawSplat:!0})});const s=parseInt(/element vertex (\d+)\n/.exec(n)[1]),a=/element face (\d+)\n/.exec(n);let l=0;a&&(l=parseInt(a[1]));const h=/element chunk (\d+)\n/.exec(n);let u=0;h&&(u=parseInt(h[1]));let c=0,d=0;const p={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let f;(function(v){v[v.Vertex=0]="Vertex",v[v.Chunk=1]="Chunk",v[v.SH=2]="SH"})(f||(f={}));let g=1;const y=[],m=n.slice(0,o).split(`
`);for(const v of m)if(v.startsWith("property ")){const[,w,I]=v.split(" ");g==1?d+=p[w]:g==0?(y.push({name:I,type:w,offset:c}),c+=p[w]):g==2&&y.push({name:I,type:w,offset:c}),p[w]||Me.Warn(`Unsupported property type: ${w}.`)}else if(v.startsWith("element ")){const[,w]=v.split(" ");w=="chunk"?g=1:w=="vertex"?g=0:w=="sh"&&(g=2)}const _=c,b=d;return Kn.ConvertPLYWithSHToSplatAsync(e).then(async v=>{const w=new DataView(e,o+r.length);let I=b*u+_*s;const V=[];if(l)for(let $=0;$<l;$++){const z=w.getUint8(I);if(z==3){I+=1;for(let ae=0;ae<z;ae++){const L=w.getUint32(I+(2-ae)*4,!0);V.push(L)}I+=12}}if(u)return await new Promise($=>{$({mode:0,data:v.buffer,sh:v.sh,faces:V,hasVertexColors:!1,compressed:!0,rawSplat:!1})});let M=0,B=0;const P=["x","y","z","scale_0","scale_1","scale_2","opacity","rot_0","rot_1","rot_2","rot_3"],T=["red","green","blue","f_dc_0","f_dc_1","f_dc_2"];for(let $=0;$<y.length;$++){const z=y[$];P.includes(z.name)&&M++,T.includes(z.name)&&B++}const N=M==P.length&&B==3,R=l?2:N?0:1;return await new Promise($=>{$({mode:R,data:v.buffer,sh:v.sh,faces:V,hasVertexColors:!!B,compressed:!1,rawSplat:!1})})})}}dn._DefaultLoadingOptions={keepInRam:!1,flipY:!1};Un(new dn);function $a(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function Xn(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ar={exports:{}};(function(i,e){(function(t){i.exports=t()})(function(){return function t(n,r,o){function s(h,u){if(!r[h]){if(!n[h]){var c=typeof Xn=="function"&&Xn;if(!u&&c)return c(h,!0);if(a)return a(h,!0);throw new Error("Cannot find module '"+h+"'")}var d=r[h]={exports:{}};n[h][0].call(d.exports,function(p){var f=n[h][1][p];return s(f||p)},d,d.exports,t,n,r,o)}return r[h].exports}for(var a=typeof Xn=="function"&&Xn,l=0;l<o.length;l++)s(o[l]);return s}({1:[function(t,n,r){n.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,n,r){n.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,n,r){var o=t("../math/Vec3");t("../utils/Utils"),n.exports=s;function s(h){h=h||{},this.lowerBound=new o,h.lowerBound&&this.lowerBound.copy(h.lowerBound),this.upperBound=new o,h.upperBound&&this.upperBound.copy(h.upperBound)}var a=new o;s.prototype.setFromPoints=function(h,u,c,d){var p=this.lowerBound,f=this.upperBound,g=c;p.copy(h[0]),g&&g.vmult(p,p),f.copy(p);for(var y=1;y<h.length;y++){var m=h[y];g&&(g.vmult(m,a),m=a),m.x>f.x&&(f.x=m.x),m.x<p.x&&(p.x=m.x),m.y>f.y&&(f.y=m.y),m.y<p.y&&(p.y=m.y),m.z>f.z&&(f.z=m.z),m.z<p.z&&(p.z=m.z)}return u&&(u.vadd(p,p),u.vadd(f,f)),d&&(p.x-=d,p.y-=d,p.z-=d,f.x+=d,f.y+=d,f.z+=d),this},s.prototype.copy=function(h){return this.lowerBound.copy(h.lowerBound),this.upperBound.copy(h.upperBound),this},s.prototype.clone=function(){return new s().copy(this)},s.prototype.extend=function(h){var u=h.lowerBound.x;this.lowerBound.x>u&&(this.lowerBound.x=u);var c=h.upperBound.x;this.upperBound.x<c&&(this.upperBound.x=c);var u=h.lowerBound.y;this.lowerBound.y>u&&(this.lowerBound.y=u);var c=h.upperBound.y;this.upperBound.y<c&&(this.upperBound.y=c);var u=h.lowerBound.z;this.lowerBound.z>u&&(this.lowerBound.z=u);var c=h.upperBound.z;this.upperBound.z<c&&(this.upperBound.z=c)},s.prototype.overlaps=function(h){var u=this.lowerBound,c=this.upperBound,d=h.lowerBound,p=h.upperBound;return(d.x<=c.x&&c.x<=p.x||u.x<=p.x&&p.x<=c.x)&&(d.y<=c.y&&c.y<=p.y||u.y<=p.y&&p.y<=c.y)&&(d.z<=c.z&&c.z<=p.z||u.z<=p.z&&p.z<=c.z)},s.prototype.contains=function(h){var u=this.lowerBound,c=this.upperBound,d=h.lowerBound,p=h.upperBound;return u.x<=d.x&&c.x>=p.x&&u.y<=d.y&&c.y>=p.y&&u.z<=d.z&&c.z>=p.z},s.prototype.getCorners=function(h,u,c,d,p,f,g,y){var m=this.lowerBound,_=this.upperBound;h.copy(m),u.set(_.x,m.y,m.z),c.set(_.x,_.y,m.z),d.set(m.x,_.y,_.z),p.set(_.x,m.y,m.z),f.set(m.x,_.y,m.z),g.set(m.x,m.y,_.z),y.copy(_)};var l=[new o,new o,new o,new o,new o,new o,new o,new o];s.prototype.toLocalFrame=function(h,u){var c=l,d=c[0],p=c[1],f=c[2],g=c[3],y=c[4],m=c[5],_=c[6],b=c[7];this.getCorners(d,p,f,g,y,m,_,b);for(var v=0;v!==8;v++){var w=c[v];h.pointToLocal(w,w)}return u.setFromPoints(c)},s.prototype.toWorldFrame=function(h,u){var c=l,d=c[0],p=c[1],f=c[2],g=c[3],y=c[4],m=c[5],_=c[6],b=c[7];this.getCorners(d,p,f,g,y,m,_,b);for(var v=0;v!==8;v++){var w=c[v];h.pointToWorld(w,w)}return u.setFromPoints(c)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,n,r){n.exports=o;function o(){this.matrix=[]}o.prototype.get=function(s,a){if(s=s.index,a=a.index,a>s){var l=a;a=s,s=l}return this.matrix[(s*(s+1)>>1)+a-1]},o.prototype.set=function(s,a,l){if(s=s.index,a=a.index,a>s){var h=a;a=s,s=h}this.matrix[(s*(s+1)>>1)+a-1]=l?1:0},o.prototype.reset=function(){for(var s=0,a=this.matrix.length;s!==a;s++)this.matrix[s]=0},o.prototype.setNumObjects=function(s){this.matrix.length=s*(s-1)>>1}},{}],5:[function(t,n,r){var o=t("../objects/Body"),s=t("../math/Vec3"),a=t("../math/Quaternion");t("../shapes/Shape"),t("../shapes/Plane"),n.exports=l;function l(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}l.prototype.collisionPairs=function(g,y,m){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var h=o.STATIC|o.KINEMATIC;l.prototype.needBroadphaseCollision=function(g,y){return!(!(g.collisionFilterGroup&y.collisionFilterMask)||!(y.collisionFilterGroup&g.collisionFilterMask)||(g.type&h||g.sleepState===o.SLEEPING)&&(y.type&h||y.sleepState===o.SLEEPING))},l.prototype.intersectionTest=function(g,y,m,_){this.useBoundingBoxes?this.doBoundingBoxBroadphase(g,y,m,_):this.doBoundingSphereBroadphase(g,y,m,_)};var u=new s;new s,new a,new s,l.prototype.doBoundingSphereBroadphase=function(g,y,m,_){var b=u;y.position.vsub(g.position,b);var v=Math.pow(g.boundingRadius+y.boundingRadius,2),w=b.norm2();w<v&&(m.push(g),_.push(y))},l.prototype.doBoundingBoxBroadphase=function(g,y,m,_){g.aabbNeedsUpdate&&g.computeAABB(),y.aabbNeedsUpdate&&y.computeAABB(),g.aabb.overlaps(y.aabb)&&(m.push(g),_.push(y))};var c={keys:[]},d=[],p=[];l.prototype.makePairsUnique=function(g,y){for(var m=c,_=d,b=p,v=g.length,w=0;w!==v;w++)_[w]=g[w],b[w]=y[w];g.length=0,y.length=0;for(var w=0;w!==v;w++){var I=_[w].id,V=b[w].id,M=I<V?I+","+V:V+","+I;m[M]=w,m.keys.push(M)}for(var w=0;w!==m.keys.length;w++){var M=m.keys.pop(),B=m[M];g.push(_[B]),y.push(b[B]),delete m[M]}},l.prototype.setWorld=function(g){};var f=new s;l.boundingSphereCheck=function(g,y){var m=f;return g.position.vsub(y.position,m),Math.pow(g.shape.boundingSphereRadius+y.shape.boundingSphereRadius,2)>m.norm2()},l.prototype.aabbQuery=function(g,y,m){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,n,r){n.exports=l;var o=t("./Broadphase"),s=t("../math/Vec3"),a=t("../shapes/Shape");function l(u,c,d,p,f){o.apply(this),this.nx=d||10,this.ny=p||10,this.nz=f||10,this.aabbMin=u||new s(100,100,100),this.aabbMax=c||new s(-100,-100,-100);var g=this.nx*this.ny*this.nz;if(g<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=g,this.binLengths.length=g;for(var y=0;y<g;y++)this.bins[y]=[],this.binLengths[y]=0}l.prototype=new o,l.prototype.constructor=l;var h=new s;new s,l.prototype.collisionPairs=function(u,c,d){var p=u.numObjects(),f=u.bodies,W=this.aabbMax,F=this.aabbMin,g=this.nx,y=this.ny,m=this.nz,_=y*m,b=m,v=1,w=W.x,I=W.y,V=W.z,M=F.x,B=F.y,P=F.z,T=g/(w-M),N=y/(I-B),R=m/(V-P),$=(w-M)/g,z=(I-B)/y,ae=(V-P)/m,L=Math.sqrt($*$+z*z+ae*ae)*.5,S=a.types,j=S.SPHERE,G=S.PLANE;S.BOX,S.COMPOUND,S.CONVEXPOLYHEDRON;for(var E=this.bins,k=this.binLengths,C=this.bins.length,A=0;A!==C;A++)k[A]=0;var x=Math.ceil,F=Math.min,W=Math.max;function U(Qt,ln,Zt,Lt,kt,yn,cn){var Kt=(Qt-M)*T|0,$t=(ln-B)*N|0,St=(Zt-P)*R|0,jt=x((Lt-M)*T),Ht=x((kt-B)*N),At=x((yn-P)*R);Kt<0?Kt=0:Kt>=g&&(Kt=g-1),$t<0?$t=0:$t>=y&&($t=y-1),St<0?St=0:St>=m&&(St=m-1),jt<0?jt=0:jt>=g&&(jt=g-1),Ht<0?Ht=0:Ht>=y&&(Ht=y-1),At<0?At=0:At>=m&&(At=m-1),Kt*=_,$t*=b,St*=v,jt*=_,Ht*=b,At*=v;for(var gn=Kt;gn<=jt;gn+=_)for(var vn=$t;vn<=Ht;vn+=b)for(var _n=St;_n<=At;_n+=v){var Mn=gn+vn+_n;E[Mn][k[Mn]++]=cn}}for(var A=0;A!==p;A++){var O=f[A],K=O.shape;switch(K.type){case j:var ee=O.position.x,Ae=O.position.y,_e=O.position.z,ye=K.radius;U(ee-ye,Ae-ye,_e-ye,ee+ye,Ae+ye,_e+ye,O);break;case G:K.worldNormalNeedsUpdate&&K.computeWorldNormal(O.quaternion);var Y=K.worldNormal,ne=M+$*.5-O.position.x,Ge=B+z*.5-O.position.y,Ee=P+ae*.5-O.position.z,Qe=h;Qe.set(ne,Ge,Ee);for(var xe=0,qe=0;xe!==g;xe++,qe+=_,Qe.y=Ge,Qe.x+=$)for(var Xe=0,Ke=0;Xe!==y;Xe++,Ke+=b,Qe.z=Ee,Qe.y+=z)for(var Je=0,$e=0;Je!==m;Je++,$e+=v,Qe.z+=ae)if(Qe.dot(Y)<L){var tt=qe+Ke+$e;E[tt][k[tt]++]=O}break;default:O.aabbNeedsUpdate&&O.computeAABB(),U(O.aabb.lowerBound.x,O.aabb.lowerBound.y,O.aabb.lowerBound.z,O.aabb.upperBound.x,O.aabb.upperBound.y,O.aabb.upperBound.z,O);break}}for(var A=0;A!==C;A++){var He=k[A];if(He>1)for(var ut=E[A],xe=0;xe!==He;xe++)for(var O=ut[xe],Xe=0;Xe!==xe;Xe++){var Ct=ut[Xe];this.needBroadphaseCollision(O,Ct)&&this.intersectionTest(O,Ct,c,d)}}this.makePairsUnique(c,d)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,n,r){n.exports=a;var o=t("./Broadphase"),s=t("./AABB");function a(){o.apply(this)}a.prototype=new o,a.prototype.constructor=a,a.prototype.collisionPairs=function(l,h,u){var c=l.bodies,d=c.length,p,f,g,y;for(p=0;p!==d;p++)for(f=0;f!==p;f++)g=c[p],y=c[f],this.needBroadphaseCollision(g,y)&&this.intersectionTest(g,y,h,u)},new s,a.prototype.aabbQuery=function(l,h,u){u=u||[];for(var c=0;c<l.bodies.length;c++){var d=l.bodies[c];d.aabbNeedsUpdate&&d.computeAABB(),d.aabb.overlaps(h)&&u.push(d)}return u}},{"./AABB":3,"./Broadphase":5}],8:[function(t,n,r){n.exports=o;function o(){this.matrix={}}o.prototype.get=function(s,a){if(s=s.id,a=a.id,a>s){var l=a;a=s,s=l}return s+"-"+a in this.matrix},o.prototype.set=function(s,a,l){if(s=s.id,a=a.id,a>s){var h=a;a=s,s=h}l?this.matrix[s+"-"+a]=!0:delete this.matrix[s+"-"+a]},o.prototype.reset=function(){this.matrix={}},o.prototype.setNumObjects=function(s){}},{}],9:[function(t,n,r){n.exports=c;var o=t("../math/Vec3"),s=t("../math/Quaternion"),a=t("../math/Transform");t("../shapes/ConvexPolyhedron"),t("../shapes/Box");var l=t("../collision/RaycastResult"),h=t("../shapes/Shape"),u=t("../collision/AABB");function c(C,A){this.from=C?C.clone():new o,this.to=A?A.clone():new o,this._direction=new o,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new l,this.hasHit=!1,this.callback=function(x){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var d=new u,p=[];c.prototype.intersectWorld=function(C,A){return this.mode=A.mode||c.ANY,this.result=A.result||new l,this.skipBackfaces=!!A.skipBackfaces,this.collisionFilterMask=typeof A.collisionFilterMask<"u"?A.collisionFilterMask:-1,this.collisionFilterGroup=typeof A.collisionFilterGroup<"u"?A.collisionFilterGroup:-1,A.from&&this.from.copy(A.from),A.to&&this.to.copy(A.to),this.callback=A.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(d),p.length=0,C.broadphase.aabbQuery(C,d,p),this.intersectBodies(p),this.hasHit};var f=new o,g=new o;c.pointInTriangle=y;function y(C,A,x,F){F.vsub(A,G),x.vsub(A,f),C.vsub(A,g);var W=G.dot(G),U=G.dot(f),O=G.dot(g),K=f.dot(f),ee=f.dot(g),Ae,_e;return(Ae=K*O-U*ee)>=0&&(_e=W*ee-U*O)>=0&&Ae+_e<W*K-U*U}var m=new o,_=new s;c.prototype.intersectBody=function(C,A){A&&(this.result=A,this._updateDirection());var x=this.checkCollisionResponse;if(!(x&&!C.collisionResponse)&&!(!(this.collisionFilterGroup&C.collisionFilterMask)||!(C.collisionFilterGroup&this.collisionFilterMask)))for(var F=m,W=_,U=0,O=C.shapes.length;U<O;U++){var K=C.shapes[U];if(!(x&&!K.collisionResponse)&&(C.quaternion.mult(C.shapeOrientations[U],W),C.quaternion.vmult(C.shapeOffsets[U],F),F.vadd(C.position,F),this.intersectShape(K,W,F,C),this.result._shouldStop))break}},c.prototype.intersectBodies=function(C,A){A&&(this.result=A,this._updateDirection());for(var x=0,F=C.length;!this.result._shouldStop&&x<F;x++)this.intersectBody(C[x])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(C,A,x,F){var W=this.from,U=k(W,this._direction,x);if(!(U>C.boundingSphereRadius)){var O=this[C.type];O&&O.call(this,C,A,x,F)}},new o,new o;var b=new o,v=new o,w=new o,I=new o;new o,new l,c.prototype.intersectBox=function(C,A,x,F){return this.intersectConvex(C.convexPolyhedronRepresentation,A,x,F)},c.prototype[h.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(C,A,x,F){var W=this.from,U=this.to,O=this._direction,K=new o(0,0,1);A.vmult(K,K);var ee=new o;W.vsub(x,ee);var Ae=ee.dot(K);U.vsub(x,ee);var _e=ee.dot(K);if(!(Ae*_e>0)&&!(W.distanceTo(U)<Ae)){var ye=K.dot(O);if(!(Math.abs(ye)<this.precision)){var Y=new o,ne=new o,Ge=new o;W.vsub(x,Y);var Ee=-K.dot(Y)/ye;O.scale(Ee,ne),W.vadd(ne,Ge),this.reportIntersection(K,Ge,C,F,-1)}}},c.prototype[h.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(C){var A=this.to,x=this.from;C.lowerBound.x=Math.min(A.x,x.x),C.lowerBound.y=Math.min(A.y,x.y),C.lowerBound.z=Math.min(A.z,x.z),C.upperBound.x=Math.max(A.x,x.x),C.upperBound.y=Math.max(A.y,x.y),C.upperBound.z=Math.max(A.z,x.z)};var V={faceList:[0]};c.prototype.intersectHeightfield=function(C,A,x,F){C.data,C.elementSize;var W=new o,U=new c(this.from,this.to);a.pointToLocalFrame(x,A,U.from,U.from),a.pointToLocalFrame(x,A,U.to,U.to);var O=[],K=null,ee=null,Ae=null,_e=null,ye=C.getIndexOfPosition(U.from.x,U.from.y,O,!1);if(ye&&(K=O[0],ee=O[1],Ae=O[0],_e=O[1]),ye=C.getIndexOfPosition(U.to.x,U.to.y,O,!1),ye&&((K===null||O[0]<K)&&(K=O[0]),(Ae===null||O[0]>Ae)&&(Ae=O[0]),(ee===null||O[1]<ee)&&(ee=O[1]),(_e===null||O[1]>_e)&&(_e=O[1])),K!==null){var Y=[];C.getRectMinMax(K,ee,Ae,_e,Y),Y[0],Y[1];for(var ne=K;ne<=Ae;ne++)for(var Ge=ee;Ge<=_e;Ge++){if(this.result._shouldStop||(C.getConvexTrianglePillar(ne,Ge,!1),a.pointToWorldFrame(x,A,C.pillarOffset,W),this.intersectConvex(C.pillarConvex,A,W,F,V),this.result._shouldStop))return;C.getConvexTrianglePillar(ne,Ge,!0),a.pointToWorldFrame(x,A,C.pillarOffset,W),this.intersectConvex(C.pillarConvex,A,W,F,V)}}},c.prototype[h.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var M=new o,B=new o;c.prototype.intersectSphere=function(C,A,x,F){var W=this.from,U=this.to,O=C.radius,K=Math.pow(U.x-W.x,2)+Math.pow(U.y-W.y,2)+Math.pow(U.z-W.z,2),ee=2*((U.x-W.x)*(W.x-x.x)+(U.y-W.y)*(W.y-x.y)+(U.z-W.z)*(W.z-x.z)),Ae=Math.pow(W.x-x.x,2)+Math.pow(W.y-x.y,2)+Math.pow(W.z-x.z,2)-Math.pow(O,2),_e=Math.pow(ee,2)-4*K*Ae,ye=M,Y=B;if(!(_e<0))if(_e===0)W.lerp(U,_e,ye),ye.vsub(x,Y),Y.normalize(),this.reportIntersection(Y,ye,C,F,-1);else{var ne=(-ee-Math.sqrt(_e))/(2*K),Ge=(-ee+Math.sqrt(_e))/(2*K);if(ne>=0&&ne<=1&&(W.lerp(U,ne,ye),ye.vsub(x,Y),Y.normalize(),this.reportIntersection(Y,ye,C,F,-1)),this.result._shouldStop)return;Ge>=0&&Ge<=1&&(W.lerp(U,Ge,ye),ye.vsub(x,Y),Y.normalize(),this.reportIntersection(Y,ye,C,F,-1))}},c.prototype[h.types.SPHERE]=c.prototype.intersectSphere;var P=new o;new o,new o;var T=new o;c.prototype.intersectConvex=function(A,x,F,W,U){for(var O=P,K=T,ee=U&&U.faceList||null,Ae=A.faces,_e=A.vertices,ye=A.faceNormals,Y=this._direction,ne=this.from,Ge=this.to,Ee=ne.distanceTo(Ge),Qe=ee?ee.length:Ae.length,xe=this.result,qe=0;!xe._shouldStop&&qe<Qe;qe++){var Xe=ee?ee[qe]:qe,Ke=Ae[Xe],Je=ye[Xe],$e=x,tt=F;K.copy(_e[Ke[0]]),$e.vmult(K,K),K.vadd(tt,K),K.vsub(ne,K),$e.vmult(Je,O);var He=Y.dot(O);if(!(Math.abs(He)<this.precision)){var ut=O.dot(K)/He;if(!(ut<0)){Y.mult(ut,b),b.vadd(ne,b),v.copy(_e[Ke[0]]),$e.vmult(v,v),tt.vadd(v,v);for(var Ct=1;!xe._shouldStop&&Ct<Ke.length-1;Ct++){w.copy(_e[Ke[Ct]]),I.copy(_e[Ke[Ct+1]]),$e.vmult(w,w),$e.vmult(I,I),tt.vadd(w,w),tt.vadd(I,I);var Qt=b.distanceTo(ne);!(y(b,v,w,I)||y(b,w,v,I))||Qt>Ee||this.reportIntersection(O,b,A,W,Xe)}}}}},c.prototype[h.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var N=new o,R=new o,$=new o,z=new o,ae=new o,L=new o;new u;var S=[],j=new a;c.prototype.intersectTrimesh=function(A,x,F,W,U){var O=N,K=S,ee=j,Ae=T,_e=R,ye=$,Y=z,ne=L,Ge=ae;U&&U.faceList;var Ee=A.indices;A.vertices,A.faceNormals;var Qe=this.from,xe=this.to,qe=this._direction;ee.position.copy(F),ee.quaternion.copy(x),a.vectorToLocalFrame(F,x,qe,_e),a.pointToLocalFrame(F,x,Qe,ye),a.pointToLocalFrame(F,x,xe,Y);var Xe=ye.distanceSquared(Y);A.tree.rayQuery(this,ee,K);for(var Ke=0,Je=K.length;!this.result._shouldStop&&Ke!==Je;Ke++){var $e=K[Ke];A.getNormal($e,O),A.getVertex(Ee[$e*3],v),v.vsub(ye,Ae);var tt=_e.dot(O),He=O.dot(Ae)/tt;if(!(He<0)){_e.scale(He,b),b.vadd(ye,b),A.getVertex(Ee[$e*3+1],w),A.getVertex(Ee[$e*3+2],I);var ut=b.distanceSquared(ye);!(y(b,w,v,I)||y(b,v,w,I))||ut>Xe||(a.vectorToWorldFrame(x,O,Ge),a.pointToWorldFrame(F,x,b,ne),this.reportIntersection(Ge,ne,A,W,$e))}}K.length=0},c.prototype[h.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(C,A,x,F,W){var U=this.from,O=this.to,K=U.distanceTo(A),ee=this.result;if(!(this.skipBackfaces&&C.dot(this._direction)>0))switch(ee.hitFaceIndex=typeof W<"u"?W:-1,this.mode){case c.ALL:this.hasHit=!0,ee.set(U,O,C,A,x,F,K),ee.hasHit=!0,this.callback(ee);break;case c.CLOSEST:(K<ee.distance||!ee.hasHit)&&(this.hasHit=!0,ee.hasHit=!0,ee.set(U,O,C,A,x,F,K));break;case c.ANY:this.hasHit=!0,ee.hasHit=!0,ee.set(U,O,C,A,x,F,K),ee._shouldStop=!0;break}};var G=new o,E=new o;function k(C,A,x){x.vsub(C,G);var F=G.dot(A);A.mult(F,E),E.vadd(C,E);var W=x.distanceTo(E);return W}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,n,r){var o=t("../math/Vec3");n.exports=s;function s(){this.rayFromWorld=new o,this.rayToWorld=new o,this.hitNormalWorld=new o,this.hitPointWorld=new o,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}s.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},s.prototype.abort=function(){this._shouldStop=!0},s.prototype.set=function(a,l,h,u,c,d,p){this.rayFromWorld.copy(a),this.rayToWorld.copy(l),this.hitNormalWorld.copy(h),this.hitPointWorld.copy(u),this.shape=c,this.body=d,this.distance=p}},{"../math/Vec3":30}],11:[function(t,n,r){t("../shapes/Shape");var o=t("../collision/Broadphase");n.exports=s;function s(a){o.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var l=this.axisList;this._addBodyHandler=function(h){l.push(h.body)},this._removeBodyHandler=function(h){var u=l.indexOf(h.body);u!==-1&&l.splice(u,1)},a&&this.setWorld(a)}s.prototype=new o,s.prototype.setWorld=function(a){this.axisList.length=0;for(var l=0;l<a.bodies.length;l++)this.axisList.push(a.bodies[l]);a.removeEventListener("addBody",this._addBodyHandler),a.removeEventListener("removeBody",this._removeBodyHandler),a.addEventListener("addBody",this._addBodyHandler),a.addEventListener("removeBody",this._removeBodyHandler),this.world=a,this.dirty=!0},s.insertionSortX=function(a){for(var l=1,h=a.length;l<h;l++){for(var u=a[l],c=l-1;c>=0&&!(a[c].aabb.lowerBound.x<=u.aabb.lowerBound.x);c--)a[c+1]=a[c];a[c+1]=u}return a},s.insertionSortY=function(a){for(var l=1,h=a.length;l<h;l++){for(var u=a[l],c=l-1;c>=0&&!(a[c].aabb.lowerBound.y<=u.aabb.lowerBound.y);c--)a[c+1]=a[c];a[c+1]=u}return a},s.insertionSortZ=function(a){for(var l=1,h=a.length;l<h;l++){for(var u=a[l],c=l-1;c>=0&&!(a[c].aabb.lowerBound.z<=u.aabb.lowerBound.z);c--)a[c+1]=a[c];a[c+1]=u}return a},s.prototype.collisionPairs=function(a,l,h){var u=this.axisList,c=u.length,d=this.axisIndex,p,f;for(this.dirty&&(this.sortList(),this.dirty=!1),p=0;p!==c;p++){var g=u[p];for(f=p+1;f<c;f++){var y=u[f];if(this.needBroadphaseCollision(g,y)){if(!s.checkBounds(g,y,d))break;this.intersectionTest(g,y,l,h)}}}},s.prototype.sortList=function(){for(var a=this.axisList,l=this.axisIndex,h=a.length,u=0;u!==h;u++){var c=a[u];c.aabbNeedsUpdate&&c.computeAABB()}l===0?s.insertionSortX(a):l===1?s.insertionSortY(a):l===2&&s.insertionSortZ(a)},s.checkBounds=function(a,l,h){var u,c;h===0?(u=a.position.x,c=l.position.x):h===1?(u=a.position.y,c=l.position.y):h===2&&(u=a.position.z,c=l.position.z);var d=a.boundingRadius,p=l.boundingRadius,f=u+d,g=c-p;return g<f},s.prototype.autoDetectAxis=function(){for(var a=0,l=0,h=0,u=0,c=0,d=0,p=this.axisList,f=p.length,g=1/f,y=0;y!==f;y++){var m=p[y],_=m.position.x;a+=_,l+=_*_;var b=m.position.y;h+=b,u+=b*b;var v=m.position.z;c+=v,d+=v*v}var w=l-a*a*g,I=u-h*h*g,V=d-c*c*g;w>I?w>V?this.axisIndex=0:this.axisIndex=2:I>V?this.axisIndex=1:this.axisIndex=2},s.prototype.aabbQuery=function(a,l,h){h=h||[],this.dirty&&(this.sortList(),this.dirty=!1);var u=this.axisIndex,c="x";u===1&&(c="y"),u===2&&(c="z");var d=this.axisList;l.lowerBound[c],l.upperBound[c];for(var p=0;p<d.length;p++){var f=d[p];f.aabbNeedsUpdate&&f.computeAABB(),f.aabb.overlaps(l)&&h.push(f)}return h}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,n,r){n.exports=h,t("./Constraint");var o=t("./PointToPointConstraint"),s=t("../equations/ConeEquation"),a=t("../equations/RotationalEquation");t("../equations/ContactEquation");var l=t("../math/Vec3");function h(u,c,d){d=d||{};var p=typeof d.maxForce<"u"?d.maxForce:1e6,f=d.pivotA?d.pivotA.clone():new l,g=d.pivotB?d.pivotB.clone():new l;this.axisA=d.axisA?d.axisA.clone():new l,this.axisB=d.axisB?d.axisB.clone():new l,o.call(this,u,f,c,g,p),this.collideConnected=!!d.collideConnected,this.angle=typeof d.angle<"u"?d.angle:0;var y=this.coneEquation=new s(u,c,d),m=this.twistEquation=new a(u,c,d);this.twistAngle=typeof d.twistAngle<"u"?d.twistAngle:0,y.maxForce=0,y.minForce=-p,m.maxForce=0,m.minForce=-p,this.equations.push(y,m)}h.prototype=new o,h.constructor=h,new l,new l,h.prototype.update=function(){var u=this.bodyA,c=this.bodyB,d=this.coneEquation,p=this.twistEquation;o.prototype.update.call(this),u.vectorToWorldFrame(this.axisA,d.axisA),c.vectorToWorldFrame(this.axisB,d.axisB),this.axisA.tangents(p.axisA,p.axisA),u.vectorToWorldFrame(p.axisA,p.axisA),this.axisB.tangents(p.axisB,p.axisB),c.vectorToWorldFrame(p.axisB,p.axisB),d.angle=this.angle,p.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,n,r){n.exports=s;var o=t("../utils/Utils");function s(a,l,h){h=o.defaults(h,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=a,this.bodyB=l,this.id=s.idCounter++,this.collideConnected=h.collideConnected,h.wakeUpBodies&&(a&&a.wakeUp(),l&&l.wakeUp())}s.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},s.prototype.enable=function(){for(var a=this.equations,l=0;l<a.length;l++)a[l].enabled=!0},s.prototype.disable=function(){for(var a=this.equations,l=0;l<a.length;l++)a[l].enabled=!1},s.idCounter=0},{"../utils/Utils":53}],14:[function(t,n,r){n.exports=a;var o=t("./Constraint"),s=t("../equations/ContactEquation");function a(l,h,u,c){o.call(this,l,h),typeof u>"u"&&(u=l.position.distanceTo(h.position)),typeof c>"u"&&(c=1e6),this.distance=u;var d=this.distanceEquation=new s(l,h);this.equations.push(d),d.minForce=-c,d.maxForce=c}a.prototype=new o,a.prototype.update=function(){var l=this.bodyA,h=this.bodyB,u=this.distanceEquation,c=this.distance*.5,d=u.ni;h.position.vsub(l.position,d),d.normalize(),d.mult(c,u.ri),d.mult(-c,u.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,n,r){n.exports=h,t("./Constraint");var o=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation"),a=t("../equations/RotationalMotorEquation");t("../equations/ContactEquation");var l=t("../math/Vec3");function h(d,p,f){f=f||{};var g=typeof f.maxForce<"u"?f.maxForce:1e6,y=f.pivotA?f.pivotA.clone():new l,m=f.pivotB?f.pivotB.clone():new l;o.call(this,d,y,p,m,g);var _=this.axisA=f.axisA?f.axisA.clone():new l(1,0,0);_.normalize();var b=this.axisB=f.axisB?f.axisB.clone():new l(1,0,0);b.normalize();var v=this.rotationalEquation1=new s(d,p,f),w=this.rotationalEquation2=new s(d,p,f),I=this.motorEquation=new a(d,p,g);I.enabled=!1,this.equations.push(v,w,I)}h.prototype=new o,h.constructor=h,h.prototype.enableMotor=function(){this.motorEquation.enabled=!0},h.prototype.disableMotor=function(){this.motorEquation.enabled=!1},h.prototype.setMotorSpeed=function(d){this.motorEquation.targetVelocity=d},h.prototype.setMotorMaxForce=function(d){this.motorEquation.maxForce=d,this.motorEquation.minForce=-d};var u=new l,c=new l;h.prototype.update=function(){var d=this.bodyA,p=this.bodyB,f=this.motorEquation,g=this.rotationalEquation1,y=this.rotationalEquation2,m=u,_=c,b=this.axisA,v=this.axisB;o.prototype.update.call(this),d.quaternion.vmult(b,m),p.quaternion.vmult(v,_),m.tangents(g.axisA,y.axisA),g.axisB.copy(_),y.axisB.copy(_),this.motorEquation.enabled&&(d.quaternion.vmult(this.axisA,f.axisA),p.quaternion.vmult(this.axisB,f.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,n,r){n.exports=l,t("./Constraint");var o=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation");t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation");var a=t("../math/Vec3");function l(h,u,c){c=c||{};var d=typeof c.maxForce<"u"?c.maxForce:1e6,p=new a,f=new a,g=new a;h.position.vadd(u.position,g),g.scale(.5,g),u.pointToLocalFrame(g,f),h.pointToLocalFrame(g,p),o.call(this,h,p,u,f,d);var y=this.rotationalEquation1=new s(h,u,c),m=this.rotationalEquation2=new s(h,u,c),_=this.rotationalEquation3=new s(h,u,c);this.equations.push(y,m,_)}l.prototype=new o,l.constructor=l,new a,new a,l.prototype.update=function(){var h=this.bodyA,u=this.bodyB;this.motorEquation;var c=this.rotationalEquation1,d=this.rotationalEquation2,p=this.rotationalEquation3;o.prototype.update.call(this),h.vectorToWorldFrame(a.UNIT_X,c.axisA),u.vectorToWorldFrame(a.UNIT_Y,c.axisB),h.vectorToWorldFrame(a.UNIT_Y,d.axisA),u.vectorToWorldFrame(a.UNIT_Z,d.axisB),h.vectorToWorldFrame(a.UNIT_Z,p.axisA),u.vectorToWorldFrame(a.UNIT_X,p.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,n,r){n.exports=l;var o=t("./Constraint"),s=t("../equations/ContactEquation"),a=t("../math/Vec3");function l(h,u,c,d,p){o.call(this,h,c),p=typeof p<"u"?p:1e6,this.pivotA=u?u.clone():new a,this.pivotB=d?d.clone():new a;var f=this.equationX=new s(h,c),g=this.equationY=new s(h,c),y=this.equationZ=new s(h,c);this.equations.push(f,g,y),f.minForce=g.minForce=y.minForce=-p,f.maxForce=g.maxForce=y.maxForce=p,f.ni.set(1,0,0),g.ni.set(0,1,0),y.ni.set(0,0,1)}l.prototype=new o,l.prototype.update=function(){var h=this.bodyA,u=this.bodyB,c=this.equationX,d=this.equationY,p=this.equationZ;h.quaternion.vmult(this.pivotA,c.ri),u.quaternion.vmult(this.pivotB,c.rj),d.ri.copy(c.ri),d.rj.copy(c.rj),p.ri.copy(c.ri),p.rj.copy(c.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,n,r){n.exports=a;var o=t("../math/Vec3");t("../math/Mat3");var s=t("./Equation");function a(u,c,d){d=d||{};var p=typeof d.maxForce<"u"?d.maxForce:1e6;s.call(this,u,c,-p,p),this.axisA=d.axisA?d.axisA.clone():new o(1,0,0),this.axisB=d.axisB?d.axisB.clone():new o(0,1,0),this.angle=typeof d.angle<"u"?d.angle:0}a.prototype=new s,a.prototype.constructor=a;var l=new o,h=new o;a.prototype.computeB=function(u){var c=this.a,d=this.b,p=this.axisA,f=this.axisB,g=l,y=h,m=this.jacobianElementA,_=this.jacobianElementB;p.cross(f,g),f.cross(p,y),m.rotational.copy(y),_.rotational.copy(g);var b=Math.cos(this.angle)-p.dot(f),v=this.computeGW(),w=this.computeGiMf(),I=-b*c-v*d-u*w;return I}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,n,r){n.exports=a;var o=t("./Equation"),s=t("../math/Vec3");t("../math/Mat3");function a(y,m,_){_=typeof _<"u"?_:1e6,o.call(this,y,m,0,_),this.restitution=0,this.ri=new s,this.rj=new s,this.ni=new s}a.prototype=new o,a.prototype.constructor=a;var l=new s,h=new s,u=new s;a.prototype.computeB=function(y){var m=this.a,_=this.b,b=this.bi,v=this.bj,w=this.ri,I=this.rj,V=l,M=h,B=b.velocity,P=b.angularVelocity;b.force,b.torque;var T=v.velocity,N=v.angularVelocity;v.force,v.torque;var R=u,$=this.jacobianElementA,z=this.jacobianElementB,ae=this.ni;w.cross(ae,V),I.cross(ae,M),ae.negate($.spatial),V.negate($.rotational),z.spatial.copy(ae),z.rotational.copy(M),R.copy(v.position),R.vadd(I,R),R.vsub(b.position,R),R.vsub(w,R);var L=ae.dot(R),S=this.restitution+1,j=S*T.dot(ae)-S*B.dot(ae)+N.dot(M)-P.dot(V),G=this.computeGiMf(),E=-L*m-j*_-y*G;return E};var c=new s,d=new s,p=new s,f=new s,g=new s;a.prototype.getImpactVelocityAlongNormal=function(){var y=c,m=d,_=p,b=f,v=g;return this.bi.position.vadd(this.ri,_),this.bj.position.vadd(this.rj,b),this.bi.getVelocityAtWorldPoint(_,y),this.bj.getVelocityAtWorldPoint(b,m),y.vsub(m,v),this.ni.dot(v)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,n,r){n.exports=a;var o=t("../math/JacobianElement"),s=t("../math/Vec3");function a(g,y,m,_){this.id=a.id++,this.minForce=typeof m>"u"?-1e6:m,this.maxForce=typeof _>"u"?1e6:_,this.bi=g,this.bj=y,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new o,this.jacobianElementB=new o,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}a.prototype.constructor=a,a.id=0,a.prototype.setSpookParams=function(g,y,m){var _=y,b=g,v=m;this.a=4/(v*(1+4*_)),this.b=4*_/(1+4*_),this.eps=4/(v*v*b*(1+4*_))},a.prototype.computeB=function(g,y,m){var _=this.computeGW(),b=this.computeGq(),v=this.computeGiMf();return-b*g-_*y-v*m},a.prototype.computeGq=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.position,v=_.position;return g.spatial.dot(b)+y.spatial.dot(v)};var l=new s;a.prototype.computeGW=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.velocity,v=_.velocity,w=m.angularVelocity||l,I=_.angularVelocity||l;return g.multiplyVectors(b,w)+y.multiplyVectors(v,I)},a.prototype.computeGWlambda=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.vlambda,v=_.vlambda,w=m.wlambda||l,I=_.wlambda||l;return g.multiplyVectors(b,w)+y.multiplyVectors(v,I)};var h=new s,u=new s,c=new s,d=new s;a.prototype.computeGiMf=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.force,v=m.torque,w=_.force,I=_.torque,V=m.invMassSolve,M=_.invMassSolve;return m.invInertiaWorldSolve?m.invInertiaWorldSolve.vmult(v,c):c.set(0,0,0),_.invInertiaWorldSolve?_.invInertiaWorldSolve.vmult(I,d):d.set(0,0,0),b.mult(V,h),w.mult(M,u),g.multiplyVectors(h,c)+y.multiplyVectors(u,d)};var p=new s;a.prototype.computeGiMGt=function(){var g=this.jacobianElementA,y=this.jacobianElementB,m=this.bi,_=this.bj,b=m.invMassSolve,v=_.invMassSolve,w=m.invInertiaWorldSolve,I=_.invInertiaWorldSolve,V=b+v;return w&&(w.vmult(g.rotational,p),V+=p.dot(g.rotational)),I&&(I.vmult(y.rotational,p),V+=p.dot(y.rotational)),V};var f=new s;new s,new s,new s,new s,new s,a.prototype.addToWlambda=function(g){var y=this.jacobianElementA,m=this.jacobianElementB,_=this.bi,b=this.bj,v=f;y.spatial.mult(_.invMassSolve*g,v),_.vlambda.vadd(v,_.vlambda),m.spatial.mult(b.invMassSolve*g,v),b.vlambda.vadd(v,b.vlambda),_.invInertiaWorldSolve&&(_.invInertiaWorldSolve.vmult(y.rotational,v),v.mult(g,v),_.wlambda.vadd(v,_.wlambda)),b.invInertiaWorldSolve&&(b.invInertiaWorldSolve.vmult(m.rotational,v),v.mult(g,v),b.wlambda.vadd(v,b.wlambda))},a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,n,r){n.exports=a;var o=t("./Equation"),s=t("../math/Vec3");t("../math/Mat3");function a(u,c,d){o.call(this,u,c,-d,d),this.ri=new s,this.rj=new s,this.t=new s}a.prototype=new o,a.prototype.constructor=a;var l=new s,h=new s;a.prototype.computeB=function(u){this.a;var c=this.b;this.bi,this.bj;var d=this.ri,p=this.rj,f=l,g=h,y=this.t;d.cross(y,f),p.cross(y,g);var m=this.jacobianElementA,_=this.jacobianElementB;y.negate(m.spatial),f.negate(m.rotational),_.spatial.copy(y),_.rotational.copy(g);var b=this.computeGW(),v=this.computeGiMf(),w=-b*c-u*v;return w}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,n,r){n.exports=a;var o=t("../math/Vec3");t("../math/Mat3");var s=t("./Equation");function a(u,c,d){d=d||{};var p=typeof d.maxForce<"u"?d.maxForce:1e6;s.call(this,u,c,-p,p),this.axisA=d.axisA?d.axisA.clone():new o(1,0,0),this.axisB=d.axisB?d.axisB.clone():new o(0,1,0),this.maxAngle=Math.PI/2}a.prototype=new s,a.prototype.constructor=a;var l=new o,h=new o;a.prototype.computeB=function(u){var c=this.a,d=this.b,p=this.axisA,f=this.axisB,g=l,y=h,m=this.jacobianElementA,_=this.jacobianElementB;p.cross(f,g),f.cross(p,y),m.rotational.copy(y),_.rotational.copy(g);var b=Math.cos(this.maxAngle)-p.dot(f),v=this.computeGW(),w=this.computeGiMf(),I=-b*c-v*d-u*w;return I}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,n,r){n.exports=a;var o=t("../math/Vec3");t("../math/Mat3");var s=t("./Equation");function a(l,h,u){u=typeof u<"u"?u:1e6,s.call(this,l,h,-u,u),this.axisA=new o,this.axisB=new o,this.targetVelocity=0}a.prototype=new s,a.prototype.constructor=a,a.prototype.computeB=function(l){this.a;var h=this.b;this.bi,this.bj;var u=this.axisA,c=this.axisB,d=this.jacobianElementA,p=this.jacobianElementB;d.rotational.copy(u),c.negate(p.rotational);var f=this.computeGW()-this.targetVelocity,g=this.computeGiMf(),y=-f*h-l*g;return y}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,n,r){var o=t("../utils/Utils");n.exports=s;function s(a,l,h){h=o.defaults(h,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=s.idCounter++,this.materials=[a,l],this.friction=h.friction,this.restitution=h.restitution,this.contactEquationStiffness=h.contactEquationStiffness,this.contactEquationRelaxation=h.contactEquationRelaxation,this.frictionEquationStiffness=h.frictionEquationStiffness,this.frictionEquationRelaxation=h.frictionEquationRelaxation}s.idCounter=0},{"../utils/Utils":53}],25:[function(t,n,r){n.exports=o;function o(s){var a="";s=s||{},typeof s=="string"?(a=s,s={}):typeof s=="object"&&(a=""),this.name=a,this.id=o.idCounter++,this.friction=typeof s.friction<"u"?s.friction:-1,this.restitution=typeof s.restitution<"u"?s.restitution:-1}o.idCounter=0},{}],26:[function(t,n,r){n.exports=s;var o=t("./Vec3");function s(){this.spatial=new o,this.rotational=new o}s.prototype.multiplyElement=function(a){return a.spatial.dot(this.spatial)+a.rotational.dot(this.rotational)},s.prototype.multiplyVectors=function(a,l){return a.dot(this.spatial)+l.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,n,r){n.exports=s;var o=t("./Vec3");function s(a){a?this.elements=a:this.elements=[0,0,0,0,0,0,0,0,0]}s.prototype.identity=function(){var a=this.elements;a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1},s.prototype.setZero=function(){var a=this.elements;a[0]=0,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=0,a[6]=0,a[7]=0,a[8]=0},s.prototype.setTrace=function(a){var l=this.elements;l[0]=a.x,l[4]=a.y,l[8]=a.z},s.prototype.getTrace=function(l){var l=l||new o,h=this.elements;l.x=h[0],l.y=h[4],l.z=h[8]},s.prototype.vmult=function(a,l){l=l||new o;var h=this.elements,u=a.x,c=a.y,d=a.z;return l.x=h[0]*u+h[1]*c+h[2]*d,l.y=h[3]*u+h[4]*c+h[5]*d,l.z=h[6]*u+h[7]*c+h[8]*d,l},s.prototype.smult=function(a){for(var l=0;l<this.elements.length;l++)this.elements[l]*=a},s.prototype.mmult=function(a,l){for(var h=l||new s,u=0;u<3;u++)for(var c=0;c<3;c++){for(var d=0,p=0;p<3;p++)d+=a.elements[u+p*3]*this.elements[p+c*3];h.elements[u+c*3]=d}return h},s.prototype.scale=function(a,l){l=l||new s;for(var h=this.elements,u=l.elements,c=0;c!==3;c++)u[3*c+0]=a.x*h[3*c+0],u[3*c+1]=a.y*h[3*c+1],u[3*c+2]=a.z*h[3*c+2];return l},s.prototype.solve=function(a,l){l=l||new o;for(var h=3,u=4,c=[],d=0;d<h*u;d++)c.push(0);var d,p;for(d=0;d<3;d++)for(p=0;p<3;p++)c[d+u*p]=this.elements[d+3*p];c[3+4*0]=a.x,c[3+4*1]=a.y,c[3+4*2]=a.z;var f=3,g=f,y,m=4,_;do{if(d=g-f,c[d+u*d]===0){for(p=d+1;p<g;p++)if(c[d+u*p]!==0){y=m;do _=m-y,c[_+u*d]+=c[_+u*p];while(--y);break}}if(c[d+u*d]!==0)for(p=d+1;p<g;p++){var b=c[d+u*p]/c[d+u*d];y=m;do _=m-y,c[_+u*p]=_<=d?0:c[_+u*p]-c[_+u*d]*b;while(--y)}}while(--f);if(l.z=c[2*u+3]/c[2*u+2],l.y=(c[1*u+3]-c[1*u+2]*l.z)/c[1*u+1],l.x=(c[0*u+3]-c[0*u+2]*l.z-c[0*u+1]*l.y)/c[0*u+0],isNaN(l.x)||isNaN(l.y)||isNaN(l.z)||l.x===1/0||l.y===1/0||l.z===1/0)throw"Could not solve equation! Got x=["+l.toString()+"], b=["+a.toString()+"], A=["+this.toString()+"]";return l},s.prototype.e=function(a,l,h){if(h===void 0)return this.elements[l+3*a];this.elements[l+3*a]=h},s.prototype.copy=function(a){for(var l=0;l<a.elements.length;l++)this.elements[l]=a.elements[l];return this},s.prototype.toString=function(){for(var a="",l=",",h=0;h<9;h++)a+=this.elements[h]+l;return a},s.prototype.reverse=function(a){a=a||new s;for(var l=3,h=6,u=[],c=0;c<l*h;c++)u.push(0);var c,d;for(c=0;c<3;c++)for(d=0;d<3;d++)u[c+h*d]=this.elements[c+3*d];u[3+6*0]=1,u[3+6*1]=0,u[3+6*2]=0,u[4+6*0]=0,u[4+6*1]=1,u[4+6*2]=0,u[5+6*0]=0,u[5+6*1]=0,u[5+6*2]=1;var p=3,f=p,g,y=h,m;do{if(c=f-p,u[c+h*c]===0){for(d=c+1;d<f;d++)if(u[c+h*d]!==0){g=y;do m=y-g,u[m+h*c]+=u[m+h*d];while(--g);break}}if(u[c+h*c]!==0)for(d=c+1;d<f;d++){var _=u[c+h*d]/u[c+h*c];g=y;do m=y-g,u[m+h*d]=m<=c?0:u[m+h*d]-u[m+h*c]*_;while(--g)}}while(--p);c=2;do{d=c-1;do{var _=u[c+h*d]/u[c+h*c];g=h;do m=h-g,u[m+h*d]=u[m+h*d]-u[m+h*c]*_;while(--g)}while(d--)}while(--c);c=2;do{var _=1/u[c+h*c];g=h;do m=h-g,u[m+h*c]=u[m+h*c]*_;while(--g)}while(c--);c=2;do{d=2;do{if(m=u[l+d+h*c],isNaN(m)||m===1/0)throw"Could not reverse! A=["+this.toString()+"]";a.e(c,d,m)}while(d--)}while(c--);return a},s.prototype.setRotationFromQuaternion=function(a){var l=a.x,h=a.y,u=a.z,c=a.w,d=l+l,p=h+h,f=u+u,g=l*d,y=l*p,m=l*f,_=h*p,b=h*f,v=u*f,w=c*d,I=c*p,V=c*f,M=this.elements;return M[3*0+0]=1-(_+v),M[3*0+1]=y-V,M[3*0+2]=m+I,M[3*1+0]=y+V,M[3*1+1]=1-(g+v),M[3*1+2]=b-w,M[3*2+0]=m-I,M[3*2+1]=b+w,M[3*2+2]=1-(g+_),this},s.prototype.transpose=function(a){a=a||new s;for(var l=a.elements,h=this.elements,u=0;u!==3;u++)for(var c=0;c!==3;c++)l[3*u+c]=h[3*c+u];return a}},{"./Vec3":30}],28:[function(t,n,r){n.exports=s;var o=t("./Vec3");function s(d,p,f,g){this.x=d!==void 0?d:0,this.y=p!==void 0?p:0,this.z=f!==void 0?f:0,this.w=g!==void 0?g:1}s.prototype.set=function(d,p,f,g){this.x=d,this.y=p,this.z=f,this.w=g},s.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},s.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},s.prototype.setFromAxisAngle=function(d,p){var f=Math.sin(p*.5);this.x=d.x*f,this.y=d.y*f,this.z=d.z*f,this.w=Math.cos(p*.5)},s.prototype.toAxisAngle=function(d){d=d||new o,this.normalize();var p=2*Math.acos(this.w),f=Math.sqrt(1-this.w*this.w);return f<.001?(d.x=this.x,d.y=this.y,d.z=this.z):(d.x=this.x/f,d.y=this.y/f,d.z=this.z/f),[d,p]};var a=new o,l=new o;s.prototype.setFromVectors=function(d,p){if(d.isAntiparallelTo(p)){var f=a,g=l;d.tangents(f,g),this.setFromAxisAngle(f,Math.PI)}else{var y=d.cross(p);this.x=y.x,this.y=y.y,this.z=y.z,this.w=Math.sqrt(Math.pow(d.norm(),2)*Math.pow(p.norm(),2))+d.dot(p),this.normalize()}};var h=new o,u=new o,c=new o;s.prototype.mult=function(d,p){p=p||new s;var f=this.w,g=h,y=u,m=c;return g.set(this.x,this.y,this.z),y.set(d.x,d.y,d.z),p.w=f*d.w-g.dot(y),g.cross(y,m),p.x=f*y.x+d.w*g.x+m.x,p.y=f*y.y+d.w*g.y+m.y,p.z=f*y.z+d.w*g.z+m.z,p},s.prototype.inverse=function(d){var p=this.x,f=this.y,g=this.z,y=this.w;d=d||new s,this.conjugate(d);var m=1/(p*p+f*f+g*g+y*y);return d.x*=m,d.y*=m,d.z*=m,d.w*=m,d},s.prototype.conjugate=function(d){return d=d||new s,d.x=-this.x,d.y=-this.y,d.z=-this.z,d.w=this.w,d},s.prototype.normalize=function(){var d=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);d===0?(this.x=0,this.y=0,this.z=0,this.w=0):(d=1/d,this.x*=d,this.y*=d,this.z*=d,this.w*=d)},s.prototype.normalizeFast=function(){var d=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;d===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=d,this.y*=d,this.z*=d,this.w*=d)},s.prototype.vmult=function(d,p){p=p||new o;var f=d.x,g=d.y,y=d.z,m=this.x,_=this.y,b=this.z,v=this.w,w=v*f+_*y-b*g,I=v*g+b*f-m*y,V=v*y+m*g-_*f,M=-m*f-_*g-b*y;return p.x=w*v+M*-m+I*-b-V*-_,p.y=I*v+M*-_+V*-m-w*-b,p.z=V*v+M*-b+w*-_-I*-m,p},s.prototype.copy=function(d){return this.x=d.x,this.y=d.y,this.z=d.z,this.w=d.w,this},s.prototype.toEuler=function(d,p){p=p||"YZX";var f,g,y,m=this.x,_=this.y,b=this.z,v=this.w;switch(p){case"YZX":var w=m*_+b*v;if(w>.499&&(f=2*Math.atan2(m,v),g=Math.PI/2,y=0),w<-.499&&(f=-2*Math.atan2(m,v),g=-Math.PI/2,y=0),isNaN(f)){var I=m*m,V=_*_,M=b*b;f=Math.atan2(2*_*v-2*m*b,1-2*V-2*M),g=Math.asin(2*w),y=Math.atan2(2*m*v-2*_*b,1-2*I-2*M)}break;default:throw new Error("Euler order "+p+" not supported yet.")}d.y=f,d.z=g,d.x=y},s.prototype.setFromEuler=function(d,p,f,g){g=g||"XYZ";var y=Math.cos(d/2),m=Math.cos(p/2),_=Math.cos(f/2),b=Math.sin(d/2),v=Math.sin(p/2),w=Math.sin(f/2);return g==="XYZ"?(this.x=b*m*_+y*v*w,this.y=y*v*_-b*m*w,this.z=y*m*w+b*v*_,this.w=y*m*_-b*v*w):g==="YXZ"?(this.x=b*m*_+y*v*w,this.y=y*v*_-b*m*w,this.z=y*m*w-b*v*_,this.w=y*m*_+b*v*w):g==="ZXY"?(this.x=b*m*_-y*v*w,this.y=y*v*_+b*m*w,this.z=y*m*w+b*v*_,this.w=y*m*_-b*v*w):g==="ZYX"?(this.x=b*m*_-y*v*w,this.y=y*v*_+b*m*w,this.z=y*m*w-b*v*_,this.w=y*m*_+b*v*w):g==="YZX"?(this.x=b*m*_+y*v*w,this.y=y*v*_+b*m*w,this.z=y*m*w-b*v*_,this.w=y*m*_-b*v*w):g==="XZY"&&(this.x=b*m*_-y*v*w,this.y=y*v*_-b*m*w,this.z=y*m*w+b*v*_,this.w=y*m*_+b*v*w),this},s.prototype.clone=function(){return new s(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,n,r){var o=t("./Vec3"),s=t("./Quaternion");n.exports=a;function a(h){h=h||{},this.position=new o,h.position&&this.position.copy(h.position),this.quaternion=new s,h.quaternion&&this.quaternion.copy(h.quaternion)}var l=new s;a.pointToLocalFrame=function(h,u,c,p){var p=p||new o;return c.vsub(h,p),u.conjugate(l),l.vmult(p,p),p},a.prototype.pointToLocal=function(h,u){return a.pointToLocalFrame(this.position,this.quaternion,h,u)},a.pointToWorldFrame=function(h,u,c,p){var p=p||new o;return u.vmult(c,p),p.vadd(h,p),p},a.prototype.pointToWorld=function(h,u){return a.pointToWorldFrame(this.position,this.quaternion,h,u)},a.prototype.vectorToWorldFrame=function(h,c){var c=c||new o;return this.quaternion.vmult(h,c),c},a.vectorToWorldFrame=function(h,u,c){return h.vmult(u,c),c},a.vectorToLocalFrame=function(h,u,c,p){var p=p||new o;return u.w*=-1,u.vmult(c,p),u.w*=-1,p}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,n,r){n.exports=s;var o=t("./Mat3");function s(u,c,d){this.x=u||0,this.y=c||0,this.z=d||0}s.ZERO=new s(0,0,0),s.UNIT_X=new s(1,0,0),s.UNIT_Y=new s(0,1,0),s.UNIT_Z=new s(0,0,1),s.prototype.cross=function(u,c){var d=u.x,p=u.y,f=u.z,g=this.x,y=this.y,m=this.z;return c=c||new s,c.x=y*f-m*p,c.y=m*d-g*f,c.z=g*p-y*d,c},s.prototype.set=function(u,c,d){return this.x=u,this.y=c,this.z=d,this},s.prototype.setZero=function(){this.x=this.y=this.z=0},s.prototype.vadd=function(u,c){if(c)c.x=u.x+this.x,c.y=u.y+this.y,c.z=u.z+this.z;else return new s(this.x+u.x,this.y+u.y,this.z+u.z)},s.prototype.vsub=function(u,c){if(c)c.x=this.x-u.x,c.y=this.y-u.y,c.z=this.z-u.z;else return new s(this.x-u.x,this.y-u.y,this.z-u.z)},s.prototype.crossmat=function(){return new o([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},s.prototype.normalize=function(){var u=this.x,c=this.y,d=this.z,p=Math.sqrt(u*u+c*c+d*d);if(p>0){var f=1/p;this.x*=f,this.y*=f,this.z*=f}else this.x=0,this.y=0,this.z=0;return p},s.prototype.unit=function(u){u=u||new s;var c=this.x,d=this.y,p=this.z,f=Math.sqrt(c*c+d*d+p*p);return f>0?(f=1/f,u.x=c*f,u.y=d*f,u.z=p*f):(u.x=1,u.y=0,u.z=0),u},s.prototype.norm=function(){var u=this.x,c=this.y,d=this.z;return Math.sqrt(u*u+c*c+d*d)},s.prototype.length=s.prototype.norm,s.prototype.norm2=function(){return this.dot(this)},s.prototype.lengthSquared=s.prototype.norm2,s.prototype.distanceTo=function(u){var c=this.x,d=this.y,p=this.z,f=u.x,g=u.y,y=u.z;return Math.sqrt((f-c)*(f-c)+(g-d)*(g-d)+(y-p)*(y-p))},s.prototype.distanceSquared=function(u){var c=this.x,d=this.y,p=this.z,f=u.x,g=u.y,y=u.z;return(f-c)*(f-c)+(g-d)*(g-d)+(y-p)*(y-p)},s.prototype.mult=function(u,c){c=c||new s;var d=this.x,p=this.y,f=this.z;return c.x=u*d,c.y=u*p,c.z=u*f,c},s.prototype.scale=s.prototype.mult,s.prototype.dot=function(u){return this.x*u.x+this.y*u.y+this.z*u.z},s.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},s.prototype.negate=function(u){return u=u||new s,u.x=-this.x,u.y=-this.y,u.z=-this.z,u};var a=new s,l=new s;s.prototype.tangents=function(u,c){var d=this.norm();if(d>0){var p=a,f=1/d;p.set(this.x*f,this.y*f,this.z*f);var g=l;Math.abs(p.x)<.9?(g.set(1,0,0),p.cross(g,u)):(g.set(0,1,0),p.cross(g,u)),p.cross(u,c)}else u.set(1,0,0),c.set(0,1,0)},s.prototype.toString=function(){return this.x+","+this.y+","+this.z},s.prototype.toArray=function(){return[this.x,this.y,this.z]},s.prototype.copy=function(u){return this.x=u.x,this.y=u.y,this.z=u.z,this},s.prototype.lerp=function(u,c,d){var p=this.x,f=this.y,g=this.z;d.x=p+(u.x-p)*c,d.y=f+(u.y-f)*c,d.z=g+(u.z-g)*c},s.prototype.almostEquals=function(u,c){return c===void 0&&(c=1e-6),!(Math.abs(this.x-u.x)>c||Math.abs(this.y-u.y)>c||Math.abs(this.z-u.z)>c)},s.prototype.almostZero=function(u){return u===void 0&&(u=1e-6),!(Math.abs(this.x)>u||Math.abs(this.y)>u||Math.abs(this.z)>u)};var h=new s;s.prototype.isAntiparallelTo=function(u,c){return this.negate(h),h.almostEquals(u,c)},s.prototype.clone=function(){return new s(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,n,r){n.exports=c;var o=t("../utils/EventTarget");t("../shapes/Shape");var s=t("../math/Vec3"),a=t("../math/Mat3"),l=t("../math/Quaternion");t("../material/Material");var h=t("../collision/AABB"),u=t("../shapes/Box");function c(T){T=T||{},o.apply(this),this.id=c.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup=typeof T.collisionFilterGroup=="number"?T.collisionFilterGroup:1,this.collisionFilterMask=typeof T.collisionFilterMask=="number"?T.collisionFilterMask:1,this.collisionResponse=!0,this.position=new s,T.position&&this.position.copy(T.position),this.previousPosition=new s,this.initPosition=new s,this.velocity=new s,T.velocity&&this.velocity.copy(T.velocity),this.initVelocity=new s,this.force=new s;var N=typeof T.mass=="number"?T.mass:0;this.mass=N,this.invMass=N>0?1/N:0,this.material=T.material||null,this.linearDamping=typeof T.linearDamping=="number"?T.linearDamping:.01,this.type=N<=0?c.STATIC:c.DYNAMIC,typeof T.type==typeof c.STATIC&&(this.type=T.type),this.allowSleep=typeof T.allowSleep<"u"?T.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof T.sleepSpeedLimit<"u"?T.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof T.sleepTimeLimit<"u"?T.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new l,T.quaternion&&this.quaternion.copy(T.quaternion),this.initQuaternion=new l,this.angularVelocity=new s,T.angularVelocity&&this.angularVelocity.copy(T.angularVelocity),this.initAngularVelocity=new s,this.interpolatedPosition=new s,this.interpolatedQuaternion=new l,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new a,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new a,this.fixedRotation=typeof T.fixedRotation<"u"?T.fixedRotation:!1,this.angularDamping=typeof T.angularDamping<"u"?T.angularDamping:.01,this.aabb=new h,this.aabbNeedsUpdate=!0,this.wlambda=new s,T.shape&&this.addShape(T.shape),this.updateMassProperties()}c.prototype=new o,c.prototype.constructor=c,c.DYNAMIC=1,c.STATIC=2,c.KINEMATIC=4,c.AWAKE=0,c.SLEEPY=1,c.SLEEPING=2,c.idCounter=0,c.prototype.wakeUp=function(){var T=this.sleepState;this.sleepState=0,T===c.SLEEPING&&this.dispatchEvent({type:"wakeup"})},c.prototype.sleep=function(){this.sleepState=c.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},c.sleepyEvent={type:"sleepy"},c.sleepEvent={type:"sleep"},c.prototype.sleepTick=function(T){if(this.allowSleep){var N=this.sleepState,R=this.velocity.norm2()+this.angularVelocity.norm2(),$=Math.pow(this.sleepSpeedLimit,2);N===c.AWAKE&&R<$?(this.sleepState=c.SLEEPY,this.timeLastSleepy=T,this.dispatchEvent(c.sleepyEvent)):N===c.SLEEPY&&R>$?this.wakeUp():N===c.SLEEPY&&T-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(c.sleepEvent))}},c.prototype.updateSolveMassProperties=function(){this.sleepState===c.SLEEPING||this.type===c.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},c.prototype.pointToLocalFrame=function(T,R){var R=R||new s;return T.vsub(this.position,R),this.quaternion.conjugate().vmult(R,R),R},c.prototype.vectorToLocalFrame=function(T,R){var R=R||new s;return this.quaternion.conjugate().vmult(T,R),R},c.prototype.pointToWorldFrame=function(T,R){var R=R||new s;return this.quaternion.vmult(T,R),R.vadd(this.position,R),R},c.prototype.vectorToWorldFrame=function(T,R){var R=R||new s;return this.quaternion.vmult(T,R),R};var d=new s,p=new l;c.prototype.addShape=function(T,N,R){var $=new s,z=new l;return N&&$.copy(N),R&&z.copy(R),this.shapes.push(T),this.shapeOffsets.push($),this.shapeOrientations.push(z),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},c.prototype.updateBoundingRadius=function(){for(var T=this.shapes,N=this.shapeOffsets,R=T.length,$=0,z=0;z!==R;z++){var ae=T[z];ae.updateBoundingSphereRadius();var L=N[z].norm(),S=ae.boundingSphereRadius;L+S>$&&($=L+S)}this.boundingRadius=$};var f=new h;c.prototype.computeAABB=function(){for(var T=this.shapes,N=this.shapeOffsets,R=this.shapeOrientations,$=T.length,z=d,ae=p,L=this.quaternion,S=this.aabb,j=f,G=0;G!==$;G++){var E=T[G];R[G].mult(L,ae),ae.vmult(N[G],z),z.vadd(this.position,z),E.calculateWorldAABB(z,ae,j.lowerBound,j.upperBound),G===0?S.copy(j):S.extend(j)}this.aabbNeedsUpdate=!1};var g=new a,y=new a;new a,c.prototype.updateInertiaWorld=function(T){var N=this.invInertia;if(!(N.x===N.y&&N.y===N.z&&!T)){var R=g,$=y;R.setRotationFromQuaternion(this.quaternion),R.transpose($),R.scale(N,R),R.mmult($,this.invInertiaWorld)}};var m=new s,_=new s;c.prototype.applyForce=function(T,N){if(this.type===c.DYNAMIC){var R=m;N.vsub(this.position,R);var $=_;R.cross(T,$),this.force.vadd(T,this.force),this.torque.vadd($,this.torque)}};var b=new s,v=new s;c.prototype.applyLocalForce=function(T,N){if(this.type===c.DYNAMIC){var R=b,$=v;this.vectorToWorldFrame(T,R),this.pointToWorldFrame(N,$),this.applyForce(R,$)}};var w=new s,I=new s,V=new s;c.prototype.applyImpulse=function(T,N){if(this.type===c.DYNAMIC){var R=w;N.vsub(this.position,R);var $=I;$.copy(T),$.mult(this.invMass,$),this.velocity.vadd($,this.velocity);var z=V;R.cross(T,z),this.invInertiaWorld.vmult(z,z),this.angularVelocity.vadd(z,this.angularVelocity)}};var M=new s,B=new s;c.prototype.applyLocalImpulse=function(T,N){if(this.type===c.DYNAMIC){var R=M,$=B;this.vectorToWorldFrame(T,R),this.pointToWorldFrame(N,$),this.applyImpulse(R,$)}};var P=new s;c.prototype.updateMassProperties=function(){var T=P;this.invMass=this.mass>0?1/this.mass:0;var N=this.inertia,R=this.fixedRotation;this.computeAABB(),T.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),u.calculateInertia(T,this.mass,N),this.invInertia.set(N.x>0&&!R?1/N.x:0,N.y>0&&!R?1/N.y:0,N.z>0&&!R?1/N.z:0),this.updateInertiaWorld(!0)},c.prototype.getVelocityAtWorldPoint=function(T,N){var R=new s;return T.vsub(this.position,R),this.angularVelocity.cross(R,N),this.velocity.vadd(N,N),N}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,n,r){t("./Body");var o=t("../math/Vec3"),s=t("../math/Quaternion");t("../collision/RaycastResult");var a=t("../collision/Ray"),l=t("../objects/WheelInfo");n.exports=h;function h(L){this.chassisBody=L.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof L.indexRightAxis<"u"?L.indexRightAxis:1,this.indexForwardAxis=typeof L.indexForwardAxis<"u"?L.indexForwardAxis:0,this.indexUpAxis=typeof L.indexUpAxis<"u"?L.indexUpAxis:2}new o,new o,new o;var u=new o,c=new o,d=new o;new a,h.prototype.addWheel=function(L){L=L||{};var S=new l(L),j=this.wheelInfos.length;return this.wheelInfos.push(S),j},h.prototype.setSteeringValue=function(L,S){var j=this.wheelInfos[S];j.steering=L},new o,h.prototype.applyEngineForce=function(L,S){this.wheelInfos[S].engineForce=L},h.prototype.setBrake=function(L,S){this.wheelInfos[S].brake=L},h.prototype.addToWorld=function(L){this.constraints,L.add(this.chassisBody);var S=this;this.preStepCallback=function(){S.updateVehicle(L.dt)},L.addEventListener("preStep",this.preStepCallback),this.world=L},h.prototype.getVehicleAxisWorld=function(L,S){S.set(L===0?1:0,L===1?1:0,L===2?1:0),this.chassisBody.vectorToWorldFrame(S,S)},h.prototype.updateVehicle=function(L){for(var S=this.wheelInfos,j=S.length,G=this.chassisBody,E=0;E<j;E++)this.updateWheelTransform(E);this.currentVehicleSpeedKmHour=3.6*G.velocity.norm();var k=new o;this.getVehicleAxisWorld(this.indexForwardAxis,k),k.dot(G.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var E=0;E<j;E++)this.castRay(S[E]);this.updateSuspension(L);for(var C=new o,A=new o,E=0;E<j;E++){var x=S[E],F=x.suspensionForce;F>x.maxSuspensionForce&&(F=x.maxSuspensionForce),x.raycastResult.hitNormalWorld.scale(F*L,C),x.raycastResult.hitPointWorld.vsub(G.position,A),G.applyImpulse(C,x.raycastResult.hitPointWorld)}this.updateFriction(L);var W=new o,U=new o,O=new o;for(E=0;E<j;E++){var x=S[E];G.getVelocityAtWorldPoint(x.chassisConnectionPointWorld,O);var K=1;switch(this.indexUpAxis){case 1:K=-1;break}if(x.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,U);var ee=U.dot(x.raycastResult.hitNormalWorld);x.raycastResult.hitNormalWorld.scale(ee,W),U.vsub(W,U);var Ae=U.dot(O);x.deltaRotation=K*Ae*L/x.radius}(x.sliding||!x.isInContact)&&x.engineForce!==0&&x.useCustomSlidingRotationalSpeed&&(x.deltaRotation=(x.engineForce>0?1:-1)*x.customSlidingRotationalSpeed*L),Math.abs(x.brake)>Math.abs(x.engineForce)&&(x.deltaRotation=0),x.rotation+=x.deltaRotation,x.deltaRotation*=.99}},h.prototype.updateSuspension=function(L){for(var S=this.chassisBody,j=S.mass,G=this.wheelInfos,E=G.length,k=0;k<E;k++){var C=G[k];if(C.isInContact){var A,x=C.suspensionRestLength,F=C.suspensionLength,W=x-F;A=C.suspensionStiffness*W*C.clippedInvContactDotSuspension;var U=C.suspensionRelativeVelocity,O;U<0?O=C.dampingCompression:O=C.dampingRelaxation,A-=O*U,C.suspensionForce=A*j,C.suspensionForce<0&&(C.suspensionForce=0)}else C.suspensionForce=0}},h.prototype.removeFromWorld=function(L){this.constraints,L.remove(this.chassisBody),L.removeEventListener("preStep",this.preStepCallback),this.world=null};var p=new o,f=new o;h.prototype.castRay=function(L){var S=p,j=f;this.updateWheelTransformWorld(L);var G=this.chassisBody,E=-1,k=L.suspensionRestLength+L.radius;L.directionWorld.scale(k,S);var C=L.chassisConnectionPointWorld;C.vadd(S,j);var A=L.raycastResult;A.reset();var x=G.collisionResponse;G.collisionResponse=!1,this.world.rayTest(C,j,A),G.collisionResponse=x;var F=A.body;if(L.raycastResult.groundObject=0,F){E=A.distance,L.raycastResult.hitNormalWorld=A.hitNormalWorld,L.isInContact=!0;var W=A.distance;L.suspensionLength=W-L.radius;var U=L.suspensionRestLength-L.maxSuspensionTravel,O=L.suspensionRestLength+L.maxSuspensionTravel;L.suspensionLength<U&&(L.suspensionLength=U),L.suspensionLength>O&&(L.suspensionLength=O,L.raycastResult.reset());var K=L.raycastResult.hitNormalWorld.dot(L.directionWorld),ee=new o;G.getVelocityAtWorldPoint(L.raycastResult.hitPointWorld,ee);var Ae=L.raycastResult.hitNormalWorld.dot(ee);if(K>=-.1)L.suspensionRelativeVelocity=0,L.clippedInvContactDotSuspension=1/.1;else{var _e=-1/K;L.suspensionRelativeVelocity=Ae*_e,L.clippedInvContactDotSuspension=_e}}else L.suspensionLength=L.suspensionRestLength+0*L.maxSuspensionTravel,L.suspensionRelativeVelocity=0,L.directionWorld.scale(-1,L.raycastResult.hitNormalWorld),L.clippedInvContactDotSuspension=1;return E},h.prototype.updateWheelTransformWorld=function(L){L.isInContact=!1;var S=this.chassisBody;S.pointToWorldFrame(L.chassisConnectionPointLocal,L.chassisConnectionPointWorld),S.vectorToWorldFrame(L.directionLocal,L.directionWorld),S.vectorToWorldFrame(L.axleLocal,L.axleWorld)},h.prototype.updateWheelTransform=function(L){var S=u,j=c,G=d,E=this.wheelInfos[L];this.updateWheelTransformWorld(E),E.directionLocal.scale(-1,S),j.copy(E.axleLocal),S.cross(j,G),G.normalize(),j.normalize();var k=E.steering,C=new s;C.setFromAxisAngle(S,k);var A=new s;A.setFromAxisAngle(j,E.rotation);var x=E.worldTransform.quaternion;this.chassisBody.quaternion.mult(C,x),x.mult(A,x),x.normalize();var F=E.worldTransform.position;F.copy(E.directionWorld),F.scale(E.suspensionLength,F),F.vadd(E.chassisConnectionPointWorld,F)};var g=[new o(1,0,0),new o(0,1,0),new o(0,0,1)];h.prototype.getWheelTransformWorld=function(L){return this.wheelInfos[L].worldTransform};var y=new o,m=[],_=[],b=1;h.prototype.updateFriction=function(L){for(var S=y,j=this.wheelInfos,G=j.length,E=this.chassisBody,k=_,C=m,A=0;A<G;A++){var x=j[A],F=x.raycastResult.body;x.sideImpulse=0,x.forwardImpulse=0,k[A]||(k[A]=new o),C[A]||(C[A]=new o)}for(var A=0;A<G;A++){var x=j[A],F=x.raycastResult.body;if(F){var W=C[A],U=this.getWheelTransformWorld(A);U.vectorToWorldFrame(g[this.indexRightAxis],W);var O=x.raycastResult.hitNormalWorld,K=W.dot(O);O.scale(K,S),W.vsub(S,W),W.normalize(),O.cross(W,k[A]),k[A].normalize(),x.sideImpulse=ae(E,x.raycastResult.hitPointWorld,F,x.raycastResult.hitPointWorld,W),x.sideImpulse*=b}}var ee=1,Ae=.5;this.sliding=!1;for(var A=0;A<G;A++){var x=j[A],F=x.raycastResult.body,_e=0;if(x.slipInfo=1,F){var ye=0,Y=x.brake?x.brake:ye;_e=V(E,F,x.raycastResult.hitPointWorld,k[A],Y),_e+=x.engineForce*L;var ne=Y/_e;x.slipInfo*=ne}if(x.forwardImpulse=0,x.skidInfo=1,F){x.skidInfo=1;var Ge=x.suspensionForce*L*x.frictionSlip,Ee=Ge,Qe=Ge*Ee;x.forwardImpulse=_e;var xe=x.forwardImpulse*Ae,qe=x.sideImpulse*ee,Xe=xe*xe+qe*qe;if(x.sliding=!1,Xe>Qe){this.sliding=!0,x.sliding=!0;var ne=Ge/Math.sqrt(Xe);x.skidInfo*=ne}}}if(this.sliding)for(var A=0;A<G;A++){var x=j[A];x.sideImpulse!==0&&x.skidInfo<1&&(x.forwardImpulse*=x.skidInfo,x.sideImpulse*=x.skidInfo)}for(var A=0;A<G;A++){var x=j[A],Ke=new o;if(Ke.copy(x.raycastResult.hitPointWorld),x.forwardImpulse!==0){var Je=new o;k[A].scale(x.forwardImpulse,Je),E.applyImpulse(Je,Ke)}if(x.sideImpulse!==0){var F=x.raycastResult.body,$e=new o;$e.copy(x.raycastResult.hitPointWorld);var tt=new o;C[A].scale(x.sideImpulse,tt),E.pointToLocalFrame(Ke,Ke),Ke["xyz"[this.indexUpAxis]]*=x.rollInfluence,E.pointToWorldFrame(Ke,Ke),E.applyImpulse(tt,Ke),tt.scale(-1,tt),F.applyImpulse(tt,$e)}}};var v=new o,w=new o,I=new o;function V(L,S,j,G,E){var k=0,C=j,A=v,x=w,F=I;L.getVelocityAtWorldPoint(C,A),S.getVelocityAtWorldPoint(C,x),A.vsub(x,F);var W=G.dot(F),U=N(L,j,G),O=N(S,j,G),K=1,ee=K/(U+O);return k=-W*ee,E<k&&(k=E),k<-E&&(k=-E),k}var M=new o,B=new o,P=new o,T=new o;function N(L,S,j){var G=M,E=B,k=P,C=T;return S.vsub(L.position,G),G.cross(j,E),L.invInertiaWorld.vmult(E,C),C.cross(G,k),L.invMass+j.dot(k)}var R=new o,$=new o,z=new o;function ae(L,S,j,G,E,O){var C=E.norm2();if(C>1.1)return 0;var A=R,x=$,F=z;L.getVelocityAtWorldPoint(S,A),j.getVelocityAtWorldPoint(G,x),A.vsub(x,F);var W=E.dot(F),U=1/(L.invMass+j.invMass),O=-.2*W*U;return O}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,n,r){var o=t("./Body"),s=t("../shapes/Sphere"),a=t("../shapes/Box"),l=t("../math/Vec3"),h=t("../constraints/HingeConstraint");n.exports=u;function u(p){if(this.wheelBodies=[],this.coordinateSystem=typeof p.coordinateSystem>"u"?new l(1,2,3):p.coordinateSystem.clone(),this.chassisBody=p.chassisBody,!this.chassisBody){var f=new a(new l(5,2,.5));this.chassisBody=new o(1,f)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}u.prototype.addWheel=function(p){p=p||{};var f=p.body;f||(f=new o(1,new s(1.2))),this.wheelBodies.push(f),this.wheelForces.push(0),new l;var g=typeof p.position<"u"?p.position.clone():new l,y=new l;this.chassisBody.pointToWorldFrame(g,y),f.position.set(y.x,y.y,y.z);var m=typeof p.axis<"u"?p.axis.clone():new l(0,1,0);this.wheelAxes.push(m);var _=new h(this.chassisBody,f,{pivotA:g,axisA:m,pivotB:l.ZERO,axisB:m,collideConnected:!1});return this.constraints.push(_),this.wheelBodies.length-1},u.prototype.setSteeringValue=function(p,f){var g=this.wheelAxes[f],y=Math.cos(p),m=Math.sin(p),_=g.x,b=g.y;this.constraints[f].axisA.set(y*_-m*b,m*_+y*b,0)},u.prototype.setMotorSpeed=function(p,f){var g=this.constraints[f];g.enableMotor(),g.motorTargetVelocity=p},u.prototype.disableMotor=function(p){var f=this.constraints[p];f.disableMotor()};var c=new l;u.prototype.setWheelForce=function(p,f){this.wheelForces[f]=p},u.prototype.applyWheelForce=function(p,f){var g=this.wheelAxes[f],y=this.wheelBodies[f],m=y.torque;g.scale(p,c),y.vectorToWorldFrame(c,c),m.vadd(c,m)},u.prototype.addToWorld=function(p){for(var f=this.constraints,g=this.wheelBodies.concat([this.chassisBody]),y=0;y<g.length;y++)p.add(g[y]);for(var y=0;y<f.length;y++)p.addConstraint(f[y]);p.addEventListener("preStep",this._update.bind(this))},u.prototype._update=function(){for(var p=this.wheelForces,f=0;f<p.length;f++)this.applyWheelForce(p[f],f)},u.prototype.removeFromWorld=function(p){for(var f=this.constraints,g=this.wheelBodies.concat([this.chassisBody]),y=0;y<g.length;y++)p.remove(g[y]);for(var y=0;y<f.length;y++)p.removeConstraint(f[y])};var d=new l;u.prototype.getWheelSpeed=function(p){var f=this.wheelAxes[p],g=this.wheelBodies[p],y=g.angularVelocity;return this.chassisBody.vectorToWorldFrame(f,d),y.dot(d)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,n,r){n.exports=s,t("../shapes/Shape");var o=t("../math/Vec3");t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material");function s(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}s.prototype.add=function(f){this.particles.push(f),this.neighbors.length<this.particles.length&&this.neighbors.push([])},s.prototype.remove=function(f){var g=this.particles.indexOf(f);g!==-1&&(this.particles.splice(g,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var a=new o;s.prototype.getNeighbors=function(f,g){for(var y=this.particles.length,m=f.id,_=this.smoothingRadius*this.smoothingRadius,b=a,v=0;v!==y;v++){var w=this.particles[v];w.position.vsub(f.position,b),m!==w.id&&b.norm2()<_&&g.push(w)}};var l=new o,h=new o,u=new o,c=new o,d=new o,p=new o;s.prototype.update=function(){for(var f=this.particles.length,g=l,y=this.speedOfSound,m=this.eps,_=0;_!==f;_++){var b=this.particles[_],v=this.neighbors[_];v.length=0,this.getNeighbors(b,v),v.push(this.particles[_]);for(var w=v.length,I=0,V=0;V!==w;V++){b.position.vsub(v[V].position,g);var M=g.norm(),B=this.w(M);I+=v[V].mass*B}this.densities[_]=I,this.pressures[_]=y*y*(this.densities[_]-this.density)}for(var P=h,T=u,N=c,R=d,$=p,_=0;_!==f;_++){var z=this.particles[_];P.set(0,0,0),T.set(0,0,0);for(var ae,L,v=this.neighbors[_],w=v.length,V=0;V!==w;V++){var S=v[V];z.position.vsub(S.position,R);var j=R.norm();ae=-S.mass*(this.pressures[_]/(this.densities[_]*this.densities[_]+m)+this.pressures[V]/(this.densities[V]*this.densities[V]+m)),this.gradw(R,N),N.mult(ae,N),P.vadd(N,P),S.velocity.vsub(z.velocity,$),$.mult(1/(1e-4+this.densities[_]*this.densities[V])*this.viscosity*S.mass,$),L=this.nablaw(j),$.mult(L,$),T.vadd($,T)}T.mult(z.mass,T),P.mult(z.mass,P),z.force.vadd(T,z.force),z.force.vadd(P,z.force)}},s.prototype.w=function(f){var g=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(g,9))*Math.pow(g*g-f*f,3)},s.prototype.gradw=function(f,g){var y=f.norm(),m=this.smoothingRadius;f.mult(945/(32*Math.PI*Math.pow(m,9))*Math.pow(m*m-y*y,2),g)},s.prototype.nablaw=function(f){var g=this.smoothingRadius,y=945/(32*Math.PI*Math.pow(g,9))*(g*g-f*f)*(7*f*f-3*g*g);return y}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,n,r){var o=t("../math/Vec3");n.exports=s;function s(_,b,v){v=v||{},this.restLength=typeof v.restLength=="number"?v.restLength:1,this.stiffness=v.stiffness||100,this.damping=v.damping||1,this.bodyA=_,this.bodyB=b,this.localAnchorA=new o,this.localAnchorB=new o,v.localAnchorA&&this.localAnchorA.copy(v.localAnchorA),v.localAnchorB&&this.localAnchorB.copy(v.localAnchorB),v.worldAnchorA&&this.setWorldAnchorA(v.worldAnchorA),v.worldAnchorB&&this.setWorldAnchorB(v.worldAnchorB)}s.prototype.setWorldAnchorA=function(_){this.bodyA.pointToLocalFrame(_,this.localAnchorA)},s.prototype.setWorldAnchorB=function(_){this.bodyB.pointToLocalFrame(_,this.localAnchorB)},s.prototype.getWorldAnchorA=function(_){this.bodyA.pointToWorldFrame(this.localAnchorA,_)},s.prototype.getWorldAnchorB=function(_){this.bodyB.pointToWorldFrame(this.localAnchorB,_)};var a=new o,l=new o,h=new o,u=new o,c=new o,d=new o,p=new o,f=new o,g=new o,y=new o,m=new o;s.prototype.applyForce=function(){var _=this.stiffness,b=this.damping,v=this.restLength,w=this.bodyA,I=this.bodyB,V=a,M=l,B=h,P=u,T=m,N=c,R=d,$=p,z=f,ae=g,L=y;this.getWorldAnchorA(N),this.getWorldAnchorB(R),N.vsub(w.position,$),R.vsub(I.position,z),R.vsub(N,V);var S=V.norm();M.copy(V),M.normalize(),I.velocity.vsub(w.velocity,B),I.angularVelocity.cross(z,T),B.vadd(T,B),w.angularVelocity.cross($,T),B.vsub(T,B),M.mult(-_*(S-v)-b*B.dot(M),P),w.force.vsub(P,w.force),I.force.vadd(P,I.force),$.cross(P,ae),z.cross(P,L),w.torque.vsub(ae,w.torque),I.torque.vadd(L,I.torque)}},{"../math/Vec3":30}],36:[function(t,n,r){var o=t("../math/Vec3"),s=t("../math/Transform"),a=t("../collision/RaycastResult"),l=t("../utils/Utils");n.exports=h;function h(d){d=l.defaults(d,{chassisConnectionPointLocal:new o,chassisConnectionPointWorld:new o,directionLocal:new o,directionWorld:new o,axleLocal:new o,axleWorld:new o,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=d.maxSuspensionTravel,this.customSlidingRotationalSpeed=d.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=d.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=d.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=d.chassisConnectionPointWorld.clone(),this.directionLocal=d.directionLocal.clone(),this.directionWorld=d.directionWorld.clone(),this.axleLocal=d.axleLocal.clone(),this.axleWorld=d.axleWorld.clone(),this.suspensionRestLength=d.suspensionRestLength,this.suspensionMaxLength=d.suspensionMaxLength,this.radius=d.radius,this.suspensionStiffness=d.suspensionStiffness,this.dampingCompression=d.dampingCompression,this.dampingRelaxation=d.dampingRelaxation,this.frictionSlip=d.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=d.rollInfluence,this.maxSuspensionForce=d.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=d.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new s,this.isInContact=!1}var c=new o,u=new o,c=new o;h.prototype.updateWheel=function(d){var p=this.raycastResult;if(this.isInContact){var f=p.hitNormalWorld.dot(p.directionWorld);p.hitPointWorld.vsub(d.position,u),d.getVelocityAtWorldPoint(u,c);var g=p.hitNormalWorld.dot(c);if(f>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var y=-1/f;this.suspensionRelativeVelocity=g*y,this.clippedInvContactDotSuspension=y}}else p.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,p.directionWorld.scale(-1,p.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,n,r){n.exports=l;var o=t("./Shape"),s=t("../math/Vec3"),a=t("./ConvexPolyhedron");function l(c){o.call(this),this.type=o.types.BOX,this.halfExtents=c,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}l.prototype=new o,l.prototype.constructor=l,l.prototype.updateConvexPolyhedronRepresentation=function(){var c=this.halfExtents.x,d=this.halfExtents.y,p=this.halfExtents.z,f=s,g=[new f(-c,-d,-p),new f(c,-d,-p),new f(c,d,-p),new f(-c,d,-p),new f(-c,-d,p),new f(c,-d,p),new f(c,d,p),new f(-c,d,p)],y=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new f(0,0,1),new f(0,1,0),new f(1,0,0);var m=new a(g,y);this.convexPolyhedronRepresentation=m,m.material=this.material},l.prototype.calculateLocalInertia=function(c,d){return d=d||new s,l.calculateInertia(this.halfExtents,c,d),d},l.calculateInertia=function(c,d,p){var f=c;p.x=1/12*d*(2*f.y*2*f.y+2*f.z*2*f.z),p.y=1/12*d*(2*f.x*2*f.x+2*f.z*2*f.z),p.z=1/12*d*(2*f.y*2*f.y+2*f.x*2*f.x)},l.prototype.getSideNormals=function(c,d){var p=c,f=this.halfExtents;if(p[0].set(f.x,0,0),p[1].set(0,f.y,0),p[2].set(0,0,f.z),p[3].set(-f.x,0,0),p[4].set(0,-f.y,0),p[5].set(0,0,-f.z),d!==void 0)for(var g=0;g!==p.length;g++)d.vmult(p[g],p[g]);return p},l.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},l.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var h=new s;new s,l.prototype.forEachWorldCorner=function(c,d,p){for(var f=this.halfExtents,g=[[f.x,f.y,f.z],[-f.x,f.y,f.z],[-f.x,-f.y,f.z],[-f.x,-f.y,-f.z],[f.x,-f.y,-f.z],[f.x,f.y,-f.z],[-f.x,f.y,-f.z],[f.x,-f.y,f.z]],y=0;y<g.length;y++)h.set(g[y][0],g[y][1],g[y][2]),d.vmult(h,h),c.vadd(h,h),p(h.x,h.y,h.z)};var u=[new s,new s,new s,new s,new s,new s,new s,new s];l.prototype.calculateWorldAABB=function(c,d,p,f){var g=this.halfExtents;u[0].set(g.x,g.y,g.z),u[1].set(-g.x,g.y,g.z),u[2].set(-g.x,-g.y,g.z),u[3].set(-g.x,-g.y,-g.z),u[4].set(g.x,-g.y,-g.z),u[5].set(g.x,g.y,-g.z),u[6].set(-g.x,g.y,-g.z),u[7].set(g.x,-g.y,g.z);var y=u[0];d.vmult(y,y),c.vadd(y,y),f.copy(y),p.copy(y);for(var m=1;m<8;m++){var y=u[m];d.vmult(y,y),c.vadd(y,y);var _=y.x,b=y.y,v=y.z;_>f.x&&(f.x=_),b>f.y&&(f.y=b),v>f.z&&(f.z=v),_<p.x&&(p.x=_),b<p.y&&(p.y=b),v<p.z&&(p.z=v)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,n,r){n.exports=l;var o=t("./Shape"),s=t("../math/Vec3");t("../math/Quaternion");var a=t("../math/Transform");function l(E,k,C){o.call(this),this.type=o.types.CONVEXPOLYHEDRON,this.vertices=E||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=k||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=C?C.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}l.prototype=new o,l.prototype.constructor=l;var h=new s;l.prototype.computeEdges=function(){var E=this.faces,k=this.vertices;k.length;var C=this.uniqueEdges;C.length=0;for(var A=h,x=0;x!==E.length;x++)for(var F=E[x],W=F.length,U=0;U!==W;U++){var O=(U+1)%W;k[F[U]].vsub(k[F[O]],A),A.normalize();for(var K=!1,ee=0;ee!==C.length;ee++)if(C[ee].almostEquals(A)||C[ee].almostEquals(A)){K=!0;break}K||C.push(A.clone())}},l.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var E=0;E<this.faces.length;E++){for(var k=0;k<this.faces[E].length;k++)if(!this.vertices[this.faces[E][k]])throw new Error("Vertex "+this.faces[E][k]+" not found!");var C=this.faceNormals[E]||new s;this.getFaceNormal(E,C),C.negate(C),this.faceNormals[E]=C;var A=this.vertices[this.faces[E][0]];if(C.dot(A)<0){console.error(".faceNormals["+E+"] = Vec3("+C.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var k=0;k<this.faces[E].length;k++)console.warn(".vertices["+this.faces[E][k]+"] = Vec3("+this.vertices[this.faces[E][k]].toString()+")")}}};var u=new s,c=new s;l.computeNormal=function(E,k,C,A){k.vsub(E,c),C.vsub(k,u),u.cross(c,A),A.isZero()||A.normalize()},l.prototype.getFaceNormal=function(E,k){var C=this.faces[E],A=this.vertices[C[0]],x=this.vertices[C[1]],F=this.vertices[C[2]];return l.computeNormal(A,x,F,k)};var d=new s;l.prototype.clipAgainstHull=function(E,k,C,A,x,F,W,U,O){for(var K=d,ee=-1,Ae=-Number.MAX_VALUE,_e=0;_e<C.faces.length;_e++){K.copy(C.faceNormals[_e]),x.vmult(K,K);var ye=K.dot(F);ye>Ae&&(Ae=ye,ee=_e)}for(var Y=[],ne=C.faces[ee],Ge=ne.length,Ee=0;Ee<Ge;Ee++){var Qe=C.vertices[ne[Ee]],xe=new s;xe.copy(Qe),x.vmult(xe,xe),A.vadd(xe,xe),Y.push(xe)}ee>=0&&this.clipFaceAgainstHull(F,E,k,Y,W,U,O)};var p=new s,f=new s,g=new s,y=new s,m=new s,_=new s;l.prototype.findSeparatingAxis=function(E,k,C,A,x,F,W,U){var O=p,K=f,ee=g,Ae=y,_e=m,ye=_,Y=Number.MAX_VALUE,ne=this;if(ne.uniqueAxes)for(var Ee=0;Ee!==ne.uniqueAxes.length;Ee++){C.vmult(ne.uniqueAxes[Ee],O);var xe=ne.testSepAxis(O,E,k,C,A,x);if(xe===!1)return!1;xe<Y&&(Y=xe,F.copy(O))}else for(var Ge=W?W.length:ne.faces.length,Ee=0;Ee<Ge;Ee++){var Qe=W?W[Ee]:Ee;O.copy(ne.faceNormals[Qe]),C.vmult(O,O);var xe=ne.testSepAxis(O,E,k,C,A,x);if(xe===!1)return!1;xe<Y&&(Y=xe,F.copy(O))}if(E.uniqueAxes)for(var Ee=0;Ee!==E.uniqueAxes.length;Ee++){x.vmult(E.uniqueAxes[Ee],K);var xe=ne.testSepAxis(K,E,k,C,A,x);if(xe===!1)return!1;xe<Y&&(Y=xe,F.copy(K))}else for(var qe=U?U.length:E.faces.length,Ee=0;Ee<qe;Ee++){var Qe=U?U[Ee]:Ee;K.copy(E.faceNormals[Qe]),x.vmult(K,K);var xe=ne.testSepAxis(K,E,k,C,A,x);if(xe===!1)return!1;xe<Y&&(Y=xe,F.copy(K))}for(var Xe=0;Xe!==ne.uniqueEdges.length;Xe++){C.vmult(ne.uniqueEdges[Xe],Ae);for(var Ke=0;Ke!==E.uniqueEdges.length;Ke++)if(x.vmult(E.uniqueEdges[Ke],_e),Ae.cross(_e,ye),!ye.almostZero()){ye.normalize();var Je=ne.testSepAxis(ye,E,k,C,A,x);if(Je===!1)return!1;Je<Y&&(Y=Je,F.copy(ye))}}return A.vsub(k,ee),ee.dot(F)>0&&F.negate(F),!0};var b=[],v=[];l.prototype.testSepAxis=function(E,k,C,A,x,F){var W=this;l.project(W,E,C,A,b),l.project(k,E,x,F,v);var U=b[0],O=b[1],K=v[0],ee=v[1];if(U<ee||K<O)return!1;var Ae=U-ee,_e=K-O,ye=Ae<_e?Ae:_e;return ye};var w=new s,I=new s;l.prototype.calculateLocalInertia=function(E,k){this.computeLocalAABB(w,I);var C=I.x-w.x,A=I.y-w.y,x=I.z-w.z;k.x=1/12*E*(2*A*2*A+2*x*2*x),k.y=1/12*E*(2*C*2*C+2*x*2*x),k.z=1/12*E*(2*A*2*A+2*C*2*C)},l.prototype.getPlaneConstantOfFace=function(E){var k=this.faces[E],C=this.faceNormals[E],A=this.vertices[k[0]],x=-C.dot(A);return x};var V=new s,M=new s,B=new s,P=new s,T=new s,N=new s,R=new s,$=new s;l.prototype.clipFaceAgainstHull=function(E,k,C,A,x,F,W){for(var U=V,O=M,K=B,ee=P,Ae=T,_e=N,ye=R,Y=$,ne=this,Ge=[],Ee=A,Qe=Ge,xe=-1,qe=Number.MAX_VALUE,Xe=0;Xe<ne.faces.length;Xe++){U.copy(ne.faceNormals[Xe]),C.vmult(U,U);var Ke=U.dot(E);Ke<qe&&(qe=Ke,xe=Xe)}if(!(xe<0)){var Je=ne.faces[xe];Je.connectedFaces=[];for(var $e=0;$e<ne.faces.length;$e++)for(var tt=0;tt<ne.faces[$e].length;tt++)Je.indexOf(ne.faces[$e][tt])!==-1&&$e!==xe&&Je.connectedFaces.indexOf($e)===-1&&Je.connectedFaces.push($e);Ee.length;for(var He=Je.length,ut=0;ut<He;ut++){var Ct=ne.vertices[Je[ut]],Qt=ne.vertices[Je[(ut+1)%He]];Ct.vsub(Qt,O),K.copy(O),C.vmult(K,K),k.vadd(K,K),ee.copy(this.faceNormals[xe]),C.vmult(ee,ee),k.vadd(ee,ee),K.cross(ee,Ae),Ae.negate(Ae),_e.copy(Ct),C.vmult(_e,_e),k.vadd(_e,_e),-_e.dot(Ae);var Lt;{var ln=Je.connectedFaces[ut];ye.copy(this.faceNormals[ln]);var Zt=this.getPlaneConstantOfFace(ln);Y.copy(ye),C.vmult(Y,Y);var Lt=Zt-Y.dot(k)}for(this.clipFaceAgainstPlane(Ee,Qe,Y,Lt);Ee.length;)Ee.shift();for(;Qe.length;)Ee.push(Qe.shift())}ye.copy(this.faceNormals[xe]);var Zt=this.getPlaneConstantOfFace(xe);Y.copy(ye),C.vmult(Y,Y);for(var Lt=Zt-Y.dot(k),$e=0;$e<Ee.length;$e++){var kt=Y.dot(Ee[$e])+Lt;if(kt<=x&&(console.log("clamped: depth="+kt+" to minDist="+(x+"")),kt=x),kt<=F){var yn=Ee[$e];if(kt<=0){var cn={point:yn,normal:Y,depth:kt};W.push(cn)}}}}},l.prototype.clipFaceAgainstPlane=function(E,k,C,A){var x,F,W=E.length;if(W<2)return k;var U=E[E.length-1],O=E[0];x=C.dot(U)+A;for(var K=0;K<W;K++){if(O=E[K],F=C.dot(O)+A,x<0)if(F<0){var ee=new s;ee.copy(O),k.push(ee)}else{var ee=new s;U.lerp(O,x/(x-F),ee),k.push(ee)}else if(F<0){var ee=new s;U.lerp(O,x/(x-F),ee),k.push(ee),k.push(O)}U=O,x=F}return k},l.prototype.computeWorldVertices=function(E,k){for(var C=this.vertices.length;this.worldVertices.length<C;)this.worldVertices.push(new s);for(var A=this.vertices,x=this.worldVertices,F=0;F!==C;F++)k.vmult(A[F],x[F]),E.vadd(x[F],x[F]);this.worldVerticesNeedsUpdate=!1},new s,l.prototype.computeLocalAABB=function(E,k){var C=this.vertices.length,A=this.vertices;E.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),k.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var x=0;x<C;x++){var F=A[x];F.x<E.x?E.x=F.x:F.x>k.x&&(k.x=F.x),F.y<E.y?E.y=F.y:F.y>k.y&&(k.y=F.y),F.z<E.z?E.z=F.z:F.z>k.z&&(k.z=F.z)}},l.prototype.computeWorldFaceNormals=function(E){for(var k=this.faceNormals.length;this.worldFaceNormals.length<k;)this.worldFaceNormals.push(new s);for(var C=this.faceNormals,A=this.worldFaceNormals,x=0;x!==k;x++)E.vmult(C[x],A[x]);this.worldFaceNormalsNeedsUpdate=!1},l.prototype.updateBoundingSphereRadius=function(){for(var E=0,k=this.vertices,C=0,A=k.length;C!==A;C++){var x=k[C].norm2();x>E&&(E=x)}this.boundingSphereRadius=Math.sqrt(E)};var z=new s;l.prototype.calculateWorldAABB=function(E,k,C,A){for(var x=this.vertices.length,F=this.vertices,W,U,O,K,ee,Ae,_e=0;_e<x;_e++){z.copy(F[_e]),k.vmult(z,z),E.vadd(z,z);var ye=z;ye.x<W||W===void 0?W=ye.x:(ye.x>K||K===void 0)&&(K=ye.x),ye.y<U||U===void 0?U=ye.y:(ye.y>ee||ee===void 0)&&(ee=ye.y),ye.z<O||O===void 0?O=ye.z:(ye.z>Ae||Ae===void 0)&&(Ae=ye.z)}C.set(W,U,O),A.set(K,ee,Ae)},l.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},l.prototype.getAveragePointLocal=function(E){E=E||new s;for(var k=this.vertices.length,C=this.vertices,A=0;A<k;A++)E.vadd(C[A],E);return E.mult(1/k,E),E},l.prototype.transformAllPoints=function(E,k){var C=this.vertices.length,A=this.vertices;if(k){for(var x=0;x<C;x++){var F=A[x];k.vmult(F,F)}for(var x=0;x<this.faceNormals.length;x++){var F=this.faceNormals[x];k.vmult(F,F)}}if(E)for(var x=0;x<C;x++){var F=A[x];F.vadd(E,F)}};var ae=new s,L=new s,S=new s;l.prototype.pointIsInside=function(E){var k=this.vertices.length,C=this.vertices,A=this.faces,x=this.faceNormals,F=null,W=this.faces.length,U=ae;this.getAveragePointLocal(U);for(var O=0;O<W;O++){this.faces[O].length;var k=x[O],K=C[A[O][0]],ee=L;E.vsub(K,ee);var Ae=k.dot(ee),_e=S;U.vsub(K,_e);var ye=k.dot(_e);if(Ae<0&&ye>0||Ae>0&&ye<0)return!1}return F?1:-1},new s;var j=new s,G=new s;l.project=function(E,k,C,A,x){var F=E.vertices.length,W=j,U=0,O=0,K=G,ee=E.vertices;K.setZero(),a.vectorToLocalFrame(C,A,k,W),a.pointToLocalFrame(C,A,K,K);var Ae=K.dot(W);O=U=ee[0].dot(W);for(var _e=1;_e<F;_e++){var ye=ee[_e].dot(W);ye>U&&(U=ye),ye<O&&(O=ye)}if(O-=Ae,U-=Ae,O>U){var Y=O;O=U,U=Y}x[0]=U,x[1]=O}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,n,r){n.exports=l;var o=t("./Shape"),s=t("../math/Vec3");t("../math/Quaternion");var a=t("./ConvexPolyhedron");function l(h,u,c,d){var p=d,f=[],g=[],y=[],m=[],_=[],b=Math.cos,v=Math.sin;f.push(new s(u*b(0),u*v(0),-c*.5)),m.push(0),f.push(new s(h*b(0),h*v(0),c*.5)),_.push(1);for(var w=0;w<p;w++){var I=2*Math.PI/p*(w+1),V=2*Math.PI/p*(w+.5);w<p-1?(f.push(new s(u*b(I),u*v(I),-c*.5)),m.push(2*w+2),f.push(new s(h*b(I),h*v(I),c*.5)),_.push(2*w+3),y.push([2*w+2,2*w+3,2*w+1,2*w])):y.push([0,1,2*w+1,2*w]),(p%2===1||w<p/2)&&g.push(new s(b(V),v(V),0))}y.push(_),g.push(new s(0,0,1));for(var M=[],w=0;w<m.length;w++)M.push(m[m.length-w-1]);y.push(M),this.type=o.types.CONVEXPOLYHEDRON,a.call(this,f,y,g)}l.prototype=new a},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,n,r){var o=t("./Shape"),s=t("./ConvexPolyhedron"),a=t("../math/Vec3"),l=t("../utils/Utils");n.exports=h;function h(u,c){c=l.defaults(c,{maxValue:null,minValue:null,elementSize:1}),this.data=u,this.maxValue=c.maxValue,this.minValue=c.minValue,this.elementSize=c.elementSize,c.minValue===null&&this.updateMinValue(),c.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,o.call(this),this.pillarConvex=new s,this.pillarOffset=new a,this.type=o.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}h.prototype=new o,h.prototype.update=function(){this._cachedPillars={}},h.prototype.updateMinValue=function(){for(var u=this.data,c=u[0][0],d=0;d!==u.length;d++)for(var p=0;p!==u[d].length;p++){var f=u[d][p];f<c&&(c=f)}this.minValue=c},h.prototype.updateMaxValue=function(){for(var u=this.data,c=u[0][0],d=0;d!==u.length;d++)for(var p=0;p!==u[d].length;p++){var f=u[d][p];f>c&&(c=f)}this.maxValue=c},h.prototype.setHeightValueAtIndex=function(u,c,d){var p=this.data;p[u][c]=d,this.clearCachedConvexTrianglePillar(u,c,!1),u>0&&(this.clearCachedConvexTrianglePillar(u-1,c,!0),this.clearCachedConvexTrianglePillar(u-1,c,!1)),c>0&&(this.clearCachedConvexTrianglePillar(u,c-1,!0),this.clearCachedConvexTrianglePillar(u,c-1,!1)),c>0&&u>0&&this.clearCachedConvexTrianglePillar(u-1,c-1,!0)},h.prototype.getRectMinMax=function(u,c,d,p,f){f=f||[];for(var g=this.data,y=this.minValue,m=u;m<=d;m++)for(var _=c;_<=p;_++){var b=g[m][_];b>y&&(y=b)}f[0]=this.minValue,f[1]=y},h.prototype.getIndexOfPosition=function(u,c,d,p){var f=this.elementSize,g=this.data,y=Math.floor(u/f),m=Math.floor(c/f);return d[0]=y,d[1]=m,p&&(y<0&&(y=0),m<0&&(m=0),y>=g.length-1&&(y=g.length-1),m>=g[0].length-1&&(m=g[0].length-1)),!(y<0||m<0||y>=g.length-1||m>=g[0].length-1)},h.prototype.getHeightAt=function(u,c,d){var p=[];this.getIndexOfPosition(u,c,p,d);var f=[];return this.getRectMinMax(p[0],p[1]+1,p[0],p[1]+1,f),(f[0]+f[1])/2},h.prototype.getCacheConvexTrianglePillarKey=function(u,c,d){return u+"_"+c+"_"+(d?1:0)},h.prototype.getCachedConvexTrianglePillar=function(u,c,d){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(u,c,d)]},h.prototype.setCachedConvexTrianglePillar=function(u,c,d,p,f){this._cachedPillars[this.getCacheConvexTrianglePillarKey(u,c,d)]={convex:p,offset:f}},h.prototype.clearCachedConvexTrianglePillar=function(u,c,d){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(u,c,d)]},h.prototype.getConvexTrianglePillar=function(u,c,d){var p=this.pillarConvex,f=this.pillarOffset;if(this.cacheEnabled){var g=this.getCachedConvexTrianglePillar(u,c,d);if(g){this.pillarConvex=g.convex,this.pillarOffset=g.offset;return}p=new s,f=new a,this.pillarConvex=p,this.pillarOffset=f}var g=this.data,y=this.elementSize,m=p.faces;p.vertices.length=6;for(var _=0;_<6;_++)p.vertices[_]||(p.vertices[_]=new a);m.length=5;for(var _=0;_<5;_++)m[_]||(m[_]=[]);var b=p.vertices,v=(Math.min(g[u][c],g[u+1][c],g[u][c+1],g[u+1][c+1])-this.minValue)/2+this.minValue;d?(f.set((u+.75)*y,(c+.75)*y,v),b[0].set(.25*y,.25*y,g[u+1][c+1]-v),b[1].set(-.75*y,.25*y,g[u][c+1]-v),b[2].set(.25*y,-.75*y,g[u+1][c]-v),b[3].set(.25*y,.25*y,-v-1),b[4].set(-.75*y,.25*y,-v-1),b[5].set(.25*y,-.75*y,-v-1),m[0][0]=0,m[0][1]=1,m[0][2]=2,m[1][0]=5,m[1][1]=4,m[1][2]=3,m[2][0]=2,m[2][1]=5,m[2][2]=3,m[2][3]=0,m[3][0]=3,m[3][1]=4,m[3][2]=1,m[3][3]=0,m[4][0]=1,m[4][1]=4,m[4][2]=5,m[4][3]=2):(f.set((u+.25)*y,(c+.25)*y,v),b[0].set(-.25*y,-.25*y,g[u][c]-v),b[1].set(.75*y,-.25*y,g[u+1][c]-v),b[2].set(-.25*y,.75*y,g[u][c+1]-v),b[3].set(-.25*y,-.25*y,-v-1),b[4].set(.75*y,-.25*y,-v-1),b[5].set(-.25*y,.75*y,-v-1),m[0][0]=0,m[0][1]=1,m[0][2]=2,m[1][0]=5,m[1][1]=4,m[1][2]=3,m[2][0]=0,m[2][1]=2,m[2][2]=5,m[2][3]=3,m[3][0]=1,m[3][1]=0,m[3][2]=3,m[3][3]=4,m[4][0]=4,m[4][1]=5,m[4][2]=2,m[4][3]=1),p.computeNormals(),p.computeEdges(),p.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(u,c,d,p,f)},h.prototype.calculateLocalInertia=function(u,c){return c=c||new a,c.set(0,0,0),c},h.prototype.volume=function(){return Number.MAX_VALUE},h.prototype.calculateWorldAABB=function(u,c,d,p){d.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),p.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},h.prototype.updateBoundingSphereRadius=function(){var u=this.data,c=this.elementSize;this.boundingSphereRadius=new a(u.length*c,u[0].length*c,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,n,r){n.exports=a;var o=t("./Shape"),s=t("../math/Vec3");function a(){o.call(this),this.type=o.types.PARTICLE}a.prototype=new o,a.prototype.constructor=a,a.prototype.calculateLocalInertia=function(l,h){return h=h||new s,h.set(0,0,0),h},a.prototype.volume=function(){return 0},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},a.prototype.calculateWorldAABB=function(l,h,u,c){u.copy(l),c.copy(l)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,n,r){n.exports=a;var o=t("./Shape"),s=t("../math/Vec3");function a(){o.call(this),this.type=o.types.PLANE,this.worldNormal=new s,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}a.prototype=new o,a.prototype.constructor=a,a.prototype.computeWorldNormal=function(h){var u=this.worldNormal;u.set(0,0,1),h.vmult(u,u),this.worldNormalNeedsUpdate=!1},a.prototype.calculateLocalInertia=function(h,u){return u=u||new s,u},a.prototype.volume=function(){return Number.MAX_VALUE};var l=new s;a.prototype.calculateWorldAABB=function(h,u,c,d){l.set(0,0,1),u.vmult(l,l);var p=Number.MAX_VALUE;c.set(-p,-p,-p),d.set(p,p,p),l.x===1&&(d.x=h.x),l.y===1&&(d.y=h.y),l.z===1&&(d.z=h.z),l.x===-1&&(c.x=h.x),l.y===-1&&(c.y=h.y),l.z===-1&&(c.z=h.z)},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,n,r){n.exports=o;var o=t("./Shape");t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material");function o(){this.id=o.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}o.prototype.constructor=o,o.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},o.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},o.prototype.calculateLocalInertia=function(s,a){throw"calculateLocalInertia() not implemented for shape type "+this.type},o.idCounter=0,o.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,n,r){n.exports=a;var o=t("./Shape"),s=t("../math/Vec3");function a(l){if(o.call(this),this.radius=l!==void 0?Number(l):1,this.type=o.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}a.prototype=new o,a.prototype.constructor=a,a.prototype.calculateLocalInertia=function(l,h){h=h||new s;var u=2*l*this.radius*this.radius/5;return h.x=u,h.y=u,h.z=u,h},a.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},a.prototype.calculateWorldAABB=function(l,h,u,c){for(var d=this.radius,p=["x","y","z"],f=0;f<p.length;f++){var g=p[f];u[g]=l[g]-d,c[g]=l[g]+d}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,n,r){n.exports=u;var o=t("./Shape"),s=t("../math/Vec3");t("../math/Quaternion");var a=t("../math/Transform"),l=t("../collision/AABB"),h=t("../utils/Octree");function u(M,B){o.call(this),this.type=o.types.TRIMESH,this.vertices=new Float32Array(M),this.indices=new Int16Array(B),this.normals=new Float32Array(B.length),this.aabb=new l,this.edges=null,this.scale=new s(1,1,1),this.tree=new h,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}u.prototype=new o,u.prototype.constructor=u;var c=new s;u.prototype.updateTree=function(){var M=this.tree;M.reset(),M.aabb.copy(this.aabb);var B=this.scale;M.aabb.lowerBound.x*=1/B.x,M.aabb.lowerBound.y*=1/B.y,M.aabb.lowerBound.z*=1/B.z,M.aabb.upperBound.x*=1/B.x,M.aabb.upperBound.y*=1/B.y,M.aabb.upperBound.z*=1/B.z;for(var P=new l,T=new s,N=new s,R=new s,$=[T,N,R],z=0;z<this.indices.length/3;z++){var ae=z*3;this._getUnscaledVertex(this.indices[ae],T),this._getUnscaledVertex(this.indices[ae+1],N),this._getUnscaledVertex(this.indices[ae+2],R),P.setFromPoints($),M.insert(P,z)}M.removeEmptyNodes()};var d=new l;u.prototype.getTrianglesInAABB=function(M,B){d.copy(M);var P=this.scale,T=P.x,N=P.y,R=P.z,$=d.lowerBound,z=d.upperBound;return $.x/=T,$.y/=N,$.z/=R,z.x/=T,z.y/=N,z.z/=R,this.tree.aabbQuery(d,B)},u.prototype.setScale=function(M){var B=this.scale.x===this.scale.y===this.scale.z,P=M.x===M.y===M.z;B&&P||this.updateNormals(),this.scale.copy(M),this.updateAABB(),this.updateBoundingSphereRadius()},u.prototype.updateNormals=function(){for(var M=c,B=this.normals,P=0;P<this.indices.length/3;P++){var T=P*3,N=this.indices[T],R=this.indices[T+1],$=this.indices[T+2];this.getVertex(N,m),this.getVertex(R,_),this.getVertex($,b),u.computeNormal(_,m,b,M),B[T]=M.x,B[T+1]=M.y,B[T+2]=M.z}},u.prototype.updateEdges=function(){for(var M={},B=function(ae,L){var S=N<R?N+"_"+R:R+"_"+N;M[S]=!0},P=0;P<this.indices.length/3;P++){var T=P*3,N=this.indices[T],R=this.indices[T+1];this.indices[T+2],B(),B(),B()}var $=Object.keys(M);this.edges=new Int16Array($.length*2);for(var P=0;P<$.length;P++){var z=$[P].split("_");this.edges[2*P]=parseInt(z[0],10),this.edges[2*P+1]=parseInt(z[1],10)}},u.prototype.getEdgeVertex=function(M,B,P){var T=this.edges[M*2+(B?1:0)];this.getVertex(T,P)};var p=new s,f=new s;u.prototype.getEdgeVector=function(M,B){var P=p,T=f;this.getEdgeVertex(M,0,P),this.getEdgeVertex(M,1,T),T.vsub(P,B)};var g=new s,y=new s;u.computeNormal=function(M,B,P,T){B.vsub(M,y),P.vsub(B,g),g.cross(y,T),T.isZero()||T.normalize()};var m=new s,_=new s,b=new s;u.prototype.getVertex=function(M,B){var P=this.scale;return this._getUnscaledVertex(M,B),B.x*=P.x,B.y*=P.y,B.z*=P.z,B},u.prototype._getUnscaledVertex=function(M,B){var P=M*3,T=this.vertices;return B.set(T[P],T[P+1],T[P+2])},u.prototype.getWorldVertex=function(M,B,P,T){return this.getVertex(M,T),a.pointToWorldFrame(B,P,T,T),T},u.prototype.getTriangleVertices=function(M,B,P,T){var N=M*3;this.getVertex(this.indices[N],B),this.getVertex(this.indices[N+1],P),this.getVertex(this.indices[N+2],T)},u.prototype.getNormal=function(M,B){var P=M*3;return B.set(this.normals[P],this.normals[P+1],this.normals[P+2])};var v=new l;u.prototype.calculateLocalInertia=function(M,B){this.computeLocalAABB(v);var P=v.upperBound.x-v.lowerBound.x,T=v.upperBound.y-v.lowerBound.y,N=v.upperBound.z-v.lowerBound.z;return B.set(1/12*M*(2*T*2*T+2*N*2*N),1/12*M*(2*P*2*P+2*N*2*N),1/12*M*(2*T*2*T+2*P*2*P))};var w=new s;u.prototype.computeLocalAABB=function(M){var B=M.lowerBound,P=M.upperBound,T=this.vertices.length;this.vertices;var N=w;this.getVertex(0,N),B.copy(N),P.copy(N);for(var R=0;R!==T;R++)this.getVertex(R,N),N.x<B.x?B.x=N.x:N.x>P.x&&(P.x=N.x),N.y<B.y?B.y=N.y:N.y>P.y&&(P.y=N.y),N.z<B.z?B.z=N.z:N.z>P.z&&(P.z=N.z)},u.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},u.prototype.updateBoundingSphereRadius=function(){for(var M=0,B=this.vertices,P=new s,T=0,N=B.length/3;T!==N;T++){this.getVertex(T,P);var R=P.norm2();R>M&&(M=R)}this.boundingSphereRadius=Math.sqrt(M)},new s;var I=new a,V=new l;u.prototype.calculateWorldAABB=function(M,B,P,T){var N=I,R=V;N.position=M,N.quaternion=B,this.aabb.toWorldFrame(N,R),P.copy(R.lowerBound),T.copy(R.upperBound)},u.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},u.createTorus=function(M,B,P,T,N){M=M||1,B=B||.5,P=P||8,T=T||6,N=N||Math.PI*2;for(var R=[],$=[],z=0;z<=P;z++)for(var ae=0;ae<=T;ae++){var L=ae/T*N,S=z/P*Math.PI*2,j=(M+B*Math.cos(S))*Math.cos(L),G=(M+B*Math.cos(S))*Math.sin(L),E=B*Math.sin(S);R.push(j,G,E)}for(var z=1;z<=P;z++)for(var ae=1;ae<=T;ae++){var k=(T+1)*z+ae-1,C=(T+1)*(z-1)+ae-1,A=(T+1)*(z-1)+ae,x=(T+1)*z+ae;$.push(k,C,x),$.push(C,A,x)}return new u(R,$)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,n,r){n.exports=s,t("../math/Vec3"),t("../math/Quaternion");var o=t("./Solver");function s(){o.call(this),this.iterations=10,this.tolerance=1e-7}s.prototype=new o;var a=[],l=[],h=[];s.prototype.solve=function(u,c){var d=0,p=this.iterations,f=this.tolerance*this.tolerance,g=this.equations,y=g.length,m=c.bodies,_=m.length,b=u,v,w,I,V,M,B;if(y!==0)for(var P=0;P!==_;P++)m[P].updateSolveMassProperties();var T=l,N=h,R=a;T.length=y,N.length=y,R.length=y;for(var P=0;P!==y;P++){var $=g[P];R[P]=0,N[P]=$.computeB(b),T[P]=1/$.computeC()}if(y!==0){for(var P=0;P!==_;P++){var z=m[P],ae=z.vlambda,L=z.wlambda;ae.set(0,0,0),L&&L.set(0,0,0)}for(d=0;d!==p;d++){V=0;for(var S=0;S!==y;S++){var $=g[S];v=N[S],w=T[S],B=R[S],M=$.computeGWlambda(),I=w*(v-M-$.eps*B),B+I<$.minForce?I=$.minForce-B:B+I>$.maxForce&&(I=$.maxForce-B),R[S]+=I,V+=I>0?I:-I,$.addToWlambda(I)}if(V*V<f)break}for(var P=0;P!==_;P++){var z=m[P],j=z.velocity,G=z.angularVelocity;j.vadd(z.vlambda,j),G&&G.vadd(z.wlambda,G)}}return d}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,n,r){n.exports=o;function o(){this.equations=[]}o.prototype.solve=function(s,a){return 0},o.prototype.addEquation=function(s){s.enabled&&this.equations.push(s)},o.prototype.removeEquation=function(s){var a=this.equations,l=a.indexOf(s);l!==-1&&a.splice(l,1)},o.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,n,r){n.exports=a,t("../math/Vec3"),t("../math/Quaternion");var o=t("./Solver"),s=t("../objects/Body");function a(m){for(o.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=m,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new o;var l=[],h=[],u={bodies:[]},c=s.STATIC;function d(m){for(var _=m.length,b=0;b!==_;b++){var v=m[b];if(!v.visited&&!(v.body.type&c))return v}return!1}var p=[];function f(m,_,b,v){for(p.push(m),m.visited=!0,_(m,b,v);p.length;)for(var w=p.pop(),I;I=d(w.children);)I.visited=!0,_(I,b,v),p.push(I)}function g(m,_,b){_.push(m.body);for(var v=m.eqs.length,w=0;w!==v;w++){var I=m.eqs[w];b.indexOf(I)===-1&&b.push(I)}}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},a.prototype.solve=function(m,_){for(var b=l,v=this.nodePool,w=_.bodies,I=this.equations,V=I.length,M=w.length,B=this.subsolver;v.length<M;)v.push(this.createNode());b.length=M;for(var P=0;P<M;P++)b[P]=v[P];for(var P=0;P!==M;P++){var T=b[P];T.body=w[P],T.children.length=0,T.eqs.length=0,T.visited=!1}for(var N=0;N!==V;N++){var R=I[N],P=w.indexOf(R.bi),$=w.indexOf(R.bj),z=b[P],ae=b[$];z.children.push(ae),z.eqs.push(R),ae.children.push(z),ae.eqs.push(R)}var L,S=0,j=h;B.tolerance=this.tolerance,B.iterations=this.iterations;for(var G=u;L=d(b);){j.length=0,G.bodies.length=0,f(L,g,G.bodies,j);var E=j.length;j=j.sort(y);for(var P=0;P!==E;P++)B.addEquation(j[P]);B.solve(m,G),B.removeAllEquations(),S++}return S};function y(m,_){return _.id-m.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,n,r){var o=function(){};n.exports=o,o.prototype={constructor:o,addEventListener:function(s,a){this._listeners===void 0&&(this._listeners={});var l=this._listeners;return l[s]===void 0&&(l[s]=[]),l[s].indexOf(a)===-1&&l[s].push(a),this},hasEventListener:function(s,a){if(this._listeners===void 0)return!1;var l=this._listeners;return l[s]!==void 0&&l[s].indexOf(a)!==-1},removeEventListener:function(s,a){if(this._listeners===void 0)return this;var l=this._listeners;if(l[s]===void 0)return this;var h=l[s].indexOf(a);return h!==-1&&l[s].splice(h,1),this},dispatchEvent:function(s){if(this._listeners===void 0)return this;var a=this._listeners,l=a[s.type];if(l!==void 0){s.target=this;for(var h=0,u=l.length;h<u;h++)l[h].call(this,s)}return this}}},{}],50:[function(t,n,r){var o=t("../collision/AABB"),s=t("../math/Vec3");n.exports=l;function a(c){c=c||{},this.root=c.root||null,this.aabb=c.aabb?c.aabb.clone():new o,this.data=[],this.children=[]}function l(c,d){d=d||{},d.root=null,d.aabb=c,a.call(this,d),this.maxDepth=typeof d.maxDepth<"u"?d.maxDepth:8}l.prototype=new a,a.prototype.reset=function(c,d){this.children.length=this.data.length=0},a.prototype.insert=function(c,d,p){var f=this.data;if(p=p||0,!this.aabb.contains(c))return!1;var g=this.children;if(p<(this.maxDepth||this.root.maxDepth)){var y=!1;g.length||(this.subdivide(),y=!0);for(var m=0;m!==8;m++)if(g[m].insert(c,d,p+1))return!0;y&&(g.length=0)}return f.push(d),!0};var h=new s;a.prototype.subdivide=function(){var c=this.aabb,d=c.lowerBound,p=c.upperBound,f=this.children;f.push(new a({aabb:new o({lowerBound:new s(0,0,0)})}),new a({aabb:new o({lowerBound:new s(1,0,0)})}),new a({aabb:new o({lowerBound:new s(1,1,0)})}),new a({aabb:new o({lowerBound:new s(1,1,1)})}),new a({aabb:new o({lowerBound:new s(0,1,1)})}),new a({aabb:new o({lowerBound:new s(0,0,1)})}),new a({aabb:new o({lowerBound:new s(1,0,1)})}),new a({aabb:new o({lowerBound:new s(0,1,0)})})),p.vsub(d,h),h.scale(.5,h);for(var g=this.root||this,y=0;y!==8;y++){var m=f[y];m.root=g;var _=m.aabb.lowerBound;_.x*=h.x,_.y*=h.y,_.z*=h.z,_.vadd(d,_),_.vadd(h,m.aabb.upperBound)}},a.prototype.aabbQuery=function(c,d){this.data,this.children;for(var p=[this];p.length;){var f=p.pop();f.aabb.overlaps(c)&&Array.prototype.push.apply(d,f.data),Array.prototype.push.apply(p,f.children)}return d};var u=new o;a.prototype.rayQuery=function(c,d,p){return c.getAABB(u),u.toLocalFrame(d,u),this.aabbQuery(u,p),p},a.prototype.removeEmptyNodes=function(){for(var c=[this];c.length;){for(var d=c.pop(),p=d.children.length-1;p>=0;p--)d.children[p].data.length||d.children.splice(p,1);Array.prototype.push.apply(c,d.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,n,r){n.exports=o;function o(){this.objects=[],this.type=Object}o.prototype.release=function(){for(var s=arguments.length,a=0;a!==s;a++)this.objects.push(arguments[a])},o.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},o.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,n,r){n.exports=o;function o(){this.data={keys:[]}}o.prototype.get=function(s,a){if(s>a){var l=a;a=s,s=l}return this.data[s+"-"+a]},o.prototype.set=function(s,a,l){if(s>a){var h=a;a=s,s=h}var u=s+"-"+a;this.get(s,a)||this.data.keys.push(u),this.data[u]=l},o.prototype.reset=function(){for(var s=this.data,a=s.keys;a.length>0;){var l=a.pop();delete s[l]}}},{}],53:[function(t,n,r){function o(){}n.exports=o,o.defaults=function(s,a){s=s||{};for(var l in a)l in s||(s[l]=a[l]);return s}},{}],54:[function(t,n,r){n.exports=a;var o=t("../math/Vec3"),s=t("./Pool");function a(){s.call(this),this.type=o}a.prototype=new s,a.prototype.constructObject=function(){return new o}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,n,r){n.exports=f;var o=t("../collision/AABB"),s=t("../shapes/Shape"),a=t("../collision/Ray"),l=t("../math/Vec3"),h=t("../math/Transform");t("../shapes/ConvexPolyhedron");var u=t("../math/Quaternion");t("../solver/Solver");var c=t("../utils/Vec3Pool"),d=t("../equations/ContactEquation"),p=t("../equations/FrictionEquation");function f(H){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=H,this.currentContactMaterial=null,this.enableFrictionReduction=!1}f.prototype.createContactEquation=function(H,q,Z,J,Pe,me){var oe;this.contactPointPool.length?(oe=this.contactPointPool.pop(),oe.bi=H,oe.bj=q):oe=new d(H,q),oe.enabled=H.collisionResponse&&q.collisionResponse&&Z.collisionResponse&&J.collisionResponse;var he=this.currentContactMaterial;oe.restitution=he.restitution,oe.setSpookParams(he.contactEquationStiffness,he.contactEquationRelaxation,this.world.dt);var D=Z.material||H.material,le=J.material||q.material;return D&&le&&D.restitution>=0&&le.restitution>=0&&(oe.restitution=D.restitution*le.restitution),oe.si=Pe||Z,oe.sj=me||J,oe},f.prototype.createFrictionEquationsFromContact=function(H,q){var Z=H.bi,J=H.bj,Pe=H.si,me=H.sj,oe=this.world,he=this.currentContactMaterial,D=he.friction,le=Pe.material||Z.material,de=me.material||J.material;if(le&&de&&le.friction>=0&&de.friction>=0&&(D=le.friction*de.friction),D>0){var be=D*oe.gravity.length(),ce=Z.invMass+J.invMass;ce>0&&(ce=1/ce);var se=this.frictionEquationPool,ue=se.length?se.pop():new p(Z,J,be*ce),Te=se.length?se.pop():new p(Z,J,be*ce);return ue.bi=Te.bi=Z,ue.bj=Te.bj=J,ue.minForce=Te.minForce=-be*ce,ue.maxForce=Te.maxForce=be*ce,ue.ri.copy(H.ri),ue.rj.copy(H.rj),Te.ri.copy(H.ri),Te.rj.copy(H.rj),H.ni.tangents(ue.t,Te.t),ue.setSpookParams(he.frictionEquationStiffness,he.frictionEquationRelaxation,oe.dt),Te.setSpookParams(he.frictionEquationStiffness,he.frictionEquationRelaxation,oe.dt),ue.enabled=Te.enabled=H.enabled,q.push(ue,Te),!0}return!1};var g=new l,y=new l,m=new l;f.prototype.createFrictionFromAverage=function(H){var q=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(q,this.frictionResult)||H===1)){var Z=this.frictionResult[this.frictionResult.length-2],J=this.frictionResult[this.frictionResult.length-1];g.setZero(),y.setZero(),m.setZero();var Pe=q.bi;q.bj;for(var me=0;me!==H;me++)q=this.result[this.result.length-1-me],q.bodyA!==Pe?(g.vadd(q.ni,g),y.vadd(q.ri,y),m.vadd(q.rj,m)):(g.vsub(q.ni,g),y.vadd(q.rj,y),m.vadd(q.ri,m));var oe=1/H;y.scale(oe,Z.ri),m.scale(oe,Z.rj),J.ri.copy(Z.ri),J.rj.copy(Z.rj),g.normalize(),g.tangents(Z.t,J.t)}};var _=new l,b=new l,v=new u,w=new u;f.prototype.getContacts=function(H,q,Z,J,Pe,me,oe){this.contactPointPool=Pe,this.frictionEquationPool=oe,this.result=J,this.frictionResult=me;for(var he=v,D=w,le=_,de=b,be=0,ce=H.length;be!==ce;be++){var se=H[be],ue=q[be],Te=null;se.material&&ue.material&&(Te=Z.getContactMaterial(se.material,ue.material)||null);for(var Se=0;Se<se.shapes.length;Se++){se.quaternion.mult(se.shapeOrientations[Se],he),se.quaternion.vmult(se.shapeOffsets[Se],le),le.vadd(se.position,le);for(var te=se.shapes[Se],Oe=0;Oe<ue.shapes.length;Oe++){ue.quaternion.mult(ue.shapeOrientations[Oe],D),ue.quaternion.vmult(ue.shapeOffsets[Oe],de),de.vadd(ue.position,de);var Fe=ue.shapes[Oe];if(!(le.distanceTo(de)>te.boundingSphereRadius+Fe.boundingSphereRadius)){var at=null;te.material&&Fe.material&&(at=Z.getContactMaterial(te.material,Fe.material)||null),this.currentContactMaterial=at||Te||Z.defaultContactMaterial;var Ve=this[te.type|Fe.type];Ve&&(te.type<Fe.type?Ve.call(this,te,Fe,le,de,he,D,se,ue,te,Fe):Ve.call(this,Fe,te,de,le,D,he,ue,se,te,Fe))}}}}},f.prototype[s.types.BOX|s.types.BOX]=f.prototype.boxBox=function(H,q,Z,J,Pe,me,oe,he){H.convexPolyhedronRepresentation.material=H.material,q.convexPolyhedronRepresentation.material=q.material,H.convexPolyhedronRepresentation.collisionResponse=H.collisionResponse,q.convexPolyhedronRepresentation.collisionResponse=q.collisionResponse,this.convexConvex(H.convexPolyhedronRepresentation,q.convexPolyhedronRepresentation,Z,J,Pe,me,oe,he,H,q)},f.prototype[s.types.BOX|s.types.CONVEXPOLYHEDRON]=f.prototype.boxConvex=function(H,q,Z,J,Pe,me,oe,he){H.convexPolyhedronRepresentation.material=H.material,H.convexPolyhedronRepresentation.collisionResponse=H.collisionResponse,this.convexConvex(H.convexPolyhedronRepresentation,q,Z,J,Pe,me,oe,he,H,q)},f.prototype[s.types.BOX|s.types.PARTICLE]=f.prototype.boxParticle=function(H,q,Z,J,Pe,me,oe,he){H.convexPolyhedronRepresentation.material=H.material,H.convexPolyhedronRepresentation.collisionResponse=H.collisionResponse,this.convexParticle(H.convexPolyhedronRepresentation,q,Z,J,Pe,me,oe,he,H,q)},f.prototype[s.types.SPHERE]=f.prototype.sphereSphere=function(H,q,Z,J,Pe,me,oe,he){var D=this.createContactEquation(oe,he,H,q);J.vsub(Z,D.ni),D.ni.normalize(),D.ri.copy(D.ni),D.rj.copy(D.ni),D.ri.mult(H.radius,D.ri),D.rj.mult(-q.radius,D.rj),D.ri.vadd(Z,D.ri),D.ri.vsub(oe.position,D.ri),D.rj.vadd(J,D.rj),D.rj.vsub(he.position,D.rj),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult)};var I=new l,V=new l,M=new l;f.prototype[s.types.PLANE|s.types.TRIMESH]=f.prototype.planeTrimesh=function(H,q,Z,J,Pe,me,oe,he){var D=new l,le=I;le.set(0,0,1),Pe.vmult(le,le);for(var de=0;de<q.vertices.length/3;de++){q.getVertex(de,D);var be=new l;be.copy(D),h.pointToWorldFrame(J,me,be,D);var ce=V;D.vsub(Z,ce);var se=le.dot(ce);if(se<=0){var ue=this.createContactEquation(oe,he,H,q);ue.ni.copy(le);var Te=M;le.scale(ce.dot(le),Te),D.vsub(Te,Te),ue.ri.copy(Te),ue.ri.vsub(oe.position,ue.ri),ue.rj.copy(D),ue.rj.vsub(he.position,ue.rj),this.result.push(ue),this.createFrictionEquationsFromContact(ue,this.frictionResult)}}};var B=new l,P=new l;new l;var T=new l,N=new l,R=new l,$=new l,z=new l,ae=new l,L=new l,S=new l,j=new l,G=new l,E=new l,k=new o,C=[];f.prototype[s.types.SPHERE|s.types.TRIMESH]=f.prototype.sphereTrimesh=function(H,q,Z,J,Pe,me,oe,he){var D=R,le=$,de=z,be=ae,ce=L,se=S,ue=k,Te=N,Se=P,te=C;h.pointToLocalFrame(J,me,Z,ce);var Oe=H.radius;ue.lowerBound.set(ce.x-Oe,ce.y-Oe,ce.z-Oe),ue.upperBound.set(ce.x+Oe,ce.y+Oe,ce.z+Oe),q.getTrianglesInAABB(ue,te);for(var Fe=T,at=H.radius*H.radius,Ve=0;Ve<te.length;Ve++)for(var ze=0;ze<3;ze++)if(q.getVertex(q.indices[te[Ve]*3+ze],Fe),Fe.vsub(ce,Se),Se.norm2()<=at){Te.copy(Fe),h.pointToWorldFrame(J,me,Te,Fe),Fe.vsub(Z,Se);var Ce=this.createContactEquation(oe,he,H,q);Ce.ni.copy(Se),Ce.ni.normalize(),Ce.ri.copy(Ce.ni),Ce.ri.scale(H.radius,Ce.ri),Ce.ri.vadd(Z,Ce.ri),Ce.ri.vsub(oe.position,Ce.ri),Ce.rj.copy(Fe),Ce.rj.vsub(he.position,Ce.rj),this.result.push(Ce),this.createFrictionEquationsFromContact(Ce,this.frictionResult)}for(var Ve=0;Ve<te.length;Ve++)for(var ze=0;ze<3;ze++){q.getVertex(q.indices[te[Ve]*3+ze],D),q.getVertex(q.indices[te[Ve]*3+(ze+1)%3],le),le.vsub(D,de),ce.vsub(le,se);var Vt=se.dot(de);ce.vsub(D,se);var Dt=se.dot(de);if(Dt>0&&Vt<0){ce.vsub(D,se),be.copy(de),be.normalize(),Dt=se.dot(be),be.scale(Dt,se),se.vadd(D,se);var Et=se.distanceTo(ce);if(Et<H.radius){var Ce=this.createContactEquation(oe,he,H,q);se.vsub(ce,Ce.ni),Ce.ni.normalize(),Ce.ni.scale(H.radius,Ce.ri),h.pointToWorldFrame(J,me,se,se),se.vsub(he.position,Ce.rj),h.vectorToWorldFrame(me,Ce.ni,Ce.ni),h.vectorToWorldFrame(me,Ce.ri,Ce.ri),this.result.push(Ce),this.createFrictionEquationsFromContact(Ce,this.frictionResult)}}}for(var Jt=j,Mt=G,Ze=E,en=B,Ve=0,nt=te.length;Ve!==nt;Ve++){q.getTriangleVertices(te[Ve],Jt,Mt,Ze),q.getNormal(te[Ve],en),ce.vsub(Jt,se);var Et=se.dot(en);if(en.scale(Et,se),ce.vsub(se,se),Et=se.distanceTo(ce),a.pointInTriangle(se,Jt,Mt,Ze)&&Et<H.radius){var Ce=this.createContactEquation(oe,he,H,q);se.vsub(ce,Ce.ni),Ce.ni.normalize(),Ce.ni.scale(H.radius,Ce.ri),h.pointToWorldFrame(J,me,se,se),se.vsub(he.position,Ce.rj),h.vectorToWorldFrame(me,Ce.ni,Ce.ni),h.vectorToWorldFrame(me,Ce.ri,Ce.ri),this.result.push(Ce),this.createFrictionEquationsFromContact(Ce,this.frictionResult)}}te.length=0};var A=new l,x=new l;f.prototype[s.types.SPHERE|s.types.PLANE]=f.prototype.spherePlane=function(H,q,Z,J,Pe,me,oe,he){var D=this.createContactEquation(oe,he,H,q);if(D.ni.set(0,0,1),me.vmult(D.ni,D.ni),D.ni.negate(D.ni),D.ni.normalize(),D.ni.mult(H.radius,D.ri),Z.vsub(J,A),D.ni.mult(D.ni.dot(A),x),A.vsub(x,D.rj),-A.dot(D.ni)<=H.radius){var le=D.ri,de=D.rj;le.vadd(Z,le),le.vsub(oe.position,le),de.vadd(J,de),de.vsub(he.position,de),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult)}};var F=new l,W=new l,U=new l;function O(H,q,Z){for(var J=null,Pe=H.length,me=0;me!==Pe;me++){var oe=H[me],he=F;H[(me+1)%Pe].vsub(oe,he);var D=W;he.cross(q,D);var le=U;Z.vsub(oe,le);var de=D.dot(le);if(J===null||de>0&&J===!0||de<=0&&J===!1){J===null&&(J=de>0);continue}else return!1}return!0}var K=new l,ee=new l,Ae=new l,_e=new l,ye=[new l,new l,new l,new l,new l,new l],Y=new l,ne=new l,Ge=new l,Ee=new l;f.prototype[s.types.SPHERE|s.types.BOX]=f.prototype.sphereBox=function(H,q,Z,J,Pe,me,oe,he){var D=this.v3pool,le=ye;Z.vsub(J,K),q.getSideNormals(le,me);for(var de=H.radius,be=!1,ce=ne,se=Ge,ue=Ee,Te=null,Se=0,te=0,Oe=0,Fe=null,at=0,Ve=le.length;at!==Ve&&be===!1;at++){var ze=ee;ze.copy(le[at]);var Ce=ze.norm();ze.normalize();var Vt=K.dot(ze);if(Vt<Ce+de&&Vt>0){var Dt=Ae,Et=_e;Dt.copy(le[(at+1)%3]),Et.copy(le[(at+2)%3]);var Jt=Dt.norm(),Mt=Et.norm();Dt.normalize(),Et.normalize();var Ze=K.dot(Dt),en=K.dot(Et);if(Ze<Jt&&Ze>-Jt&&en<Mt&&en>-Mt){var yt=Math.abs(Vt-Ce-de);(Fe===null||yt<Fe)&&(Fe=yt,te=Ze,Oe=en,Te=Ce,ce.copy(ze),se.copy(Dt),ue.copy(Et),Se++)}}}if(Se){be=!0;var Be=this.createContactEquation(oe,he,H,q);ce.mult(-de,Be.ri),Be.ni.copy(ce),Be.ni.negate(Be.ni),ce.mult(Te,ce),se.mult(te,se),ce.vadd(se,ce),ue.mult(Oe,ue),ce.vadd(ue,Be.rj),Be.ri.vadd(Z,Be.ri),Be.ri.vsub(oe.position,Be.ri),Be.rj.vadd(J,Be.rj),Be.rj.vsub(he.position,Be.rj),this.result.push(Be),this.createFrictionEquationsFromContact(Be,this.frictionResult)}for(var nt=D.get(),tn=Y,Pt=0;Pt!==2&&!be;Pt++)for(var _t=0;_t!==2&&!be;_t++)for(var gt=0;gt!==2&&!be;gt++)if(nt.set(0,0,0),Pt?nt.vadd(le[0],nt):nt.vsub(le[0],nt),_t?nt.vadd(le[1],nt):nt.vsub(le[1],nt),gt?nt.vadd(le[2],nt):nt.vsub(le[2],nt),J.vadd(nt,tn),tn.vsub(Z,tn),tn.norm2()<de*de){be=!0;var Be=this.createContactEquation(oe,he,H,q);Be.ri.copy(tn),Be.ri.normalize(),Be.ni.copy(Be.ri),Be.ri.mult(de,Be.ri),Be.rj.copy(nt),Be.ri.vadd(Z,Be.ri),Be.ri.vsub(oe.position,Be.ri),Be.rj.vadd(J,Be.rj),Be.rj.vsub(he.position,Be.rj),this.result.push(Be),this.createFrictionEquationsFromContact(Be,this.frictionResult)}D.release(nt),nt=null;for(var Gt=D.get(),nn=D.get(),Be=D.get(),Nt=D.get(),yt=D.get(),bn=le.length,Pt=0;Pt!==bn&&!be;Pt++)for(var _t=0;_t!==bn&&!be;_t++)if(Pt%3!==_t%3){le[_t].cross(le[Pt],Gt),Gt.normalize(),le[Pt].vadd(le[_t],nn),Be.copy(Z),Be.vsub(nn,Be),Be.vsub(J,Be);var wn=Be.dot(Gt);Gt.mult(wn,Nt);for(var gt=0;gt===Pt%3||gt===_t%3;)gt++;yt.copy(Z),yt.vsub(Nt,yt),yt.vsub(nn,yt),yt.vsub(J,yt);var Cr=Math.abs(wn),Er=yt.norm();if(Cr<le[gt].norm()&&Er<de){be=!0;var st=this.createContactEquation(oe,he,H,q);nn.vadd(Nt,st.rj),st.rj.copy(st.rj),yt.negate(st.ni),st.ni.normalize(),st.ri.copy(st.rj),st.ri.vadd(J,st.ri),st.ri.vsub(Z,st.ri),st.ri.normalize(),st.ri.mult(de,st.ri),st.ri.vadd(Z,st.ri),st.ri.vsub(oe.position,st.ri),st.rj.vadd(J,st.rj),st.rj.vsub(he.position,st.rj),this.result.push(st),this.createFrictionEquationsFromContact(st,this.frictionResult)}}D.release(Gt,nn,Be,Nt,yt)};var Qe=new l,xe=new l,qe=new l,Xe=new l,Ke=new l,Je=new l,$e=new l,tt=new l,He=new l,ut=new l;f.prototype[s.types.SPHERE|s.types.CONVEXPOLYHEDRON]=f.prototype.sphereConvex=function(H,q,Z,J,Pe,me,oe,he){var D=this.v3pool;Z.vsub(J,Qe);for(var le=q.faceNormals,de=q.faces,be=q.vertices,ce=H.radius,se=0;se!==be.length;se++){var ue=be[se],Te=Ke;me.vmult(ue,Te),J.vadd(Te,Te);var Se=Xe;if(Te.vsub(Z,Se),Se.norm2()<ce*ce){Oe=!0;var te=this.createContactEquation(oe,he,H,q);te.ri.copy(Se),te.ri.normalize(),te.ni.copy(te.ri),te.ri.mult(ce,te.ri),Te.vsub(J,te.rj),te.ri.vadd(Z,te.ri),te.ri.vsub(oe.position,te.ri),te.rj.vadd(J,te.rj),te.rj.vsub(he.position,te.rj),this.result.push(te),this.createFrictionEquationsFromContact(te,this.frictionResult);return}}for(var Oe=!1,se=0,Fe=de.length;se!==Fe&&Oe===!1;se++){var at=le[se],Ve=de[se],ze=Je;me.vmult(at,ze);var Ce=$e;me.vmult(be[Ve[0]],Ce),Ce.vadd(J,Ce);var Vt=tt;ze.mult(-ce,Vt),Z.vadd(Vt,Vt);var Dt=He;Vt.vsub(Ce,Dt);var Et=Dt.dot(ze),Jt=ut;if(Z.vsub(Ce,Jt),Et<0&&Jt.dot(ze)>0){for(var Mt=[],Ze=0,en=Ve.length;Ze!==en;Ze++){var nt=D.get();me.vmult(be[Ve[Ze]],nt),J.vadd(nt,nt),Mt.push(nt)}if(O(Mt,ze,Z)){Oe=!0;var te=this.createContactEquation(oe,he,H,q);ze.mult(-ce,te.ri),ze.negate(te.ni);var tn=D.get();ze.mult(-Et,tn);var Pt=D.get();ze.mult(-ce,Pt),Z.vsub(J,te.rj),te.rj.vadd(Pt,te.rj),te.rj.vadd(tn,te.rj),te.rj.vadd(J,te.rj),te.rj.vsub(he.position,te.rj),te.ri.vadd(Z,te.ri),te.ri.vsub(oe.position,te.ri),D.release(tn),D.release(Pt),this.result.push(te),this.createFrictionEquationsFromContact(te,this.frictionResult);for(var Ze=0,_t=Mt.length;Ze!==_t;Ze++)D.release(Mt[Ze]);return}else for(var Ze=0;Ze!==Ve.length;Ze++){var gt=D.get(),Gt=D.get();me.vmult(be[Ve[(Ze+1)%Ve.length]],gt),me.vmult(be[Ve[(Ze+2)%Ve.length]],Gt),J.vadd(gt,gt),J.vadd(Gt,Gt);var nn=xe;Gt.vsub(gt,nn);var Be=qe;nn.unit(Be);var Nt=D.get(),yt=D.get();Z.vsub(gt,yt);var bn=yt.dot(Be);Be.mult(bn,Nt),Nt.vadd(gt,Nt);var wn=D.get();if(Nt.vsub(Z,wn),bn>0&&bn*bn<nn.norm2()&&wn.norm2()<ce*ce){var te=this.createContactEquation(oe,he,H,q);Nt.vsub(J,te.rj),Nt.vsub(Z,te.ni),te.ni.normalize(),te.ni.mult(ce,te.ri),te.rj.vadd(J,te.rj),te.rj.vsub(he.position,te.rj),te.ri.vadd(Z,te.ri),te.ri.vsub(oe.position,te.ri),this.result.push(te),this.createFrictionEquationsFromContact(te,this.frictionResult);for(var Ze=0,_t=Mt.length;Ze!==_t;Ze++)D.release(Mt[Ze]);D.release(gt),D.release(Gt),D.release(Nt),D.release(wn),D.release(yt);return}D.release(gt),D.release(Gt),D.release(Nt),D.release(wn),D.release(yt)}for(var Ze=0,_t=Mt.length;Ze!==_t;Ze++)D.release(Mt[Ze])}}},new l,new l,f.prototype[s.types.PLANE|s.types.BOX]=f.prototype.planeBox=function(H,q,Z,J,Pe,me,oe,he){q.convexPolyhedronRepresentation.material=q.material,q.convexPolyhedronRepresentation.collisionResponse=q.collisionResponse,this.planeConvex(H,q.convexPolyhedronRepresentation,Z,J,Pe,me,oe,he)};var Ct=new l,Qt=new l,ln=new l,Zt=new l;f.prototype[s.types.PLANE|s.types.CONVEXPOLYHEDRON]=f.prototype.planeConvex=function(H,q,Z,J,Pe,me,oe,he){var D=Ct,le=Qt;le.set(0,0,1),Pe.vmult(le,le);for(var de=0,be=ln,ce=0;ce!==q.vertices.length;ce++){D.copy(q.vertices[ce]),me.vmult(D,D),J.vadd(D,D),D.vsub(Z,be);var se=le.dot(be);if(se<=0){var ue=this.createContactEquation(oe,he,H,q),Te=Zt;le.mult(le.dot(be),Te),D.vsub(Te,Te),Te.vsub(Z,ue.ri),ue.ni.copy(le),D.vsub(J,ue.rj),ue.ri.vadd(Z,ue.ri),ue.ri.vsub(oe.position,ue.ri),ue.rj.vadd(J,ue.rj),ue.rj.vsub(he.position,ue.rj),this.result.push(ue),de++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(ue,this.frictionResult)}}this.enableFrictionReduction&&de&&this.createFrictionFromAverage(de)};var Lt=new l,kt=new l;f.prototype[s.types.CONVEXPOLYHEDRON]=f.prototype.convexConvex=function(H,q,Z,J,Pe,me,oe,he,D,le,de,be){var ce=Lt;if(!(Z.distanceTo(J)>H.boundingSphereRadius+q.boundingSphereRadius)&&H.findSeparatingAxis(q,Z,Pe,J,me,ce,de,be)){var se=[],ue=kt;H.clipAgainstHull(Z,Pe,q,J,me,ce,-100,100,se);for(var Te=0,Se=0;Se!==se.length;Se++){var te=this.createContactEquation(oe,he,H,q,D,le),Oe=te.ri,Fe=te.rj;ce.negate(te.ni),se[Se].normal.negate(ue),ue.mult(se[Se].depth,ue),se[Se].point.vadd(ue,Oe),Fe.copy(se[Se].point),Oe.vsub(Z,Oe),Fe.vsub(J,Fe),Oe.vadd(Z,Oe),Oe.vsub(oe.position,Oe),Fe.vadd(J,Fe),Fe.vsub(he.position,Fe),this.result.push(te),Te++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(te,this.frictionResult)}this.enableFrictionReduction&&Te&&this.createFrictionFromAverage(Te)}};var yn=new l,cn=new l,Kt=new l;f.prototype[s.types.PLANE|s.types.PARTICLE]=f.prototype.planeParticle=function(H,q,Z,J,Pe,me,oe,he){var D=yn;D.set(0,0,1),oe.quaternion.vmult(D,D);var le=cn;J.vsub(oe.position,le);var de=D.dot(le);if(de<=0){var be=this.createContactEquation(he,oe,q,H);be.ni.copy(D),be.ni.negate(be.ni),be.ri.set(0,0,0);var ce=Kt;D.mult(D.dot(J),ce),J.vsub(ce,ce),be.rj.copy(ce),this.result.push(be),this.createFrictionEquationsFromContact(be,this.frictionResult)}};var $t=new l;f.prototype[s.types.PARTICLE|s.types.SPHERE]=f.prototype.sphereParticle=function(H,q,Z,J,Pe,me,oe,he){var D=$t;D.set(0,0,1),J.vsub(Z,D);var le=D.norm2();if(le<=H.radius*H.radius){var de=this.createContactEquation(he,oe,q,H);D.normalize(),de.rj.copy(D),de.rj.mult(H.radius,de.rj),de.ni.copy(D),de.ni.negate(de.ni),de.ri.set(0,0,0),this.result.push(de),this.createFrictionEquationsFromContact(de,this.frictionResult)}};var St=new u,jt=new l;new l;var Ht=new l,At=new l,gn=new l;f.prototype[s.types.PARTICLE|s.types.CONVEXPOLYHEDRON]=f.prototype.convexParticle=function(H,q,Z,J,Pe,me,oe,he){var D=-1,le=Ht,de=gn,be=null,ce=jt;if(ce.copy(J),ce.vsub(Z,ce),Pe.conjugate(St),St.vmult(ce,ce),H.pointIsInside(ce)){H.worldVerticesNeedsUpdate&&H.computeWorldVertices(Z,Pe),H.worldFaceNormalsNeedsUpdate&&H.computeWorldFaceNormals(Pe);for(var se=0,ue=H.faces.length;se!==ue;se++){var Te=[H.worldVertices[H.faces[se][0]]],Se=H.worldFaceNormals[se];J.vsub(Te[0],At);var te=-Se.dot(At);(be===null||Math.abs(te)<Math.abs(be))&&(be=te,D=se,le.copy(Se))}if(D!==-1){var Oe=this.createContactEquation(he,oe,q,H);le.mult(be,de),de.vadd(J,de),de.vsub(Z,de),Oe.rj.copy(de),le.negate(Oe.ni),Oe.ri.set(0,0,0);var Fe=Oe.ri,at=Oe.rj;Fe.vadd(J,Fe),Fe.vsub(he.position,Fe),at.vadd(Z,at),at.vsub(oe.position,at),this.result.push(Oe),this.createFrictionEquationsFromContact(Oe,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},f.prototype[s.types.BOX|s.types.HEIGHTFIELD]=f.prototype.boxHeightfield=function(H,q,Z,J,Pe,me,oe,he){H.convexPolyhedronRepresentation.material=H.material,H.convexPolyhedronRepresentation.collisionResponse=H.collisionResponse,this.convexHeightfield(H.convexPolyhedronRepresentation,q,Z,J,Pe,me,oe,he)};var vn=new l,_n=new l,Mn=[0];f.prototype[s.types.CONVEXPOLYHEDRON|s.types.HEIGHTFIELD]=f.prototype.convexHeightfield=function(H,q,Z,J,Pe,me,oe,he){var D=q.data,le=q.elementSize,de=H.boundingSphereRadius,be=_n,ce=Mn,se=vn;h.pointToLocalFrame(J,me,Z,se);var ue=Math.floor((se.x-de)/le)-1,Te=Math.ceil((se.x+de)/le)+1,Se=Math.floor((se.y-de)/le)-1,te=Math.ceil((se.y+de)/le)+1;if(!(Te<0||te<0||ue>D.length||Se>D[0].length)){ue<0&&(ue=0),Te<0&&(Te=0),Se<0&&(Se=0),te<0&&(te=0),ue>=D.length&&(ue=D.length-1),Te>=D.length&&(Te=D.length-1),te>=D[0].length&&(te=D[0].length-1),Se>=D[0].length&&(Se=D[0].length-1);var Oe=[];q.getRectMinMax(ue,Se,Te,te,Oe);var Fe=Oe[0],at=Oe[1];if(!(se.z-de>at||se.z+de<Fe))for(var Ve=ue;Ve<Te;Ve++)for(var ze=Se;ze<te;ze++)q.getConvexTrianglePillar(Ve,ze,!1),h.pointToWorldFrame(J,me,q.pillarOffset,be),Z.distanceTo(be)<q.pillarConvex.boundingSphereRadius+H.boundingSphereRadius&&this.convexConvex(H,q.pillarConvex,Z,be,Pe,me,oe,he,null,null,ce,null),q.getConvexTrianglePillar(Ve,ze,!0),h.pointToWorldFrame(J,me,q.pillarOffset,be),Z.distanceTo(be)<q.pillarConvex.boundingSphereRadius+H.boundingSphereRadius&&this.convexConvex(H,q.pillarConvex,Z,be,Pe,me,oe,he,null,null,ce,null)}};var Pn=new l,mt=new l;f.prototype[s.types.SPHERE|s.types.HEIGHTFIELD]=f.prototype.sphereHeightfield=function(H,q,Z,J,Pe,me,oe,he){var D=q.data,le=H.radius,de=q.elementSize,be=mt,ce=Pn;h.pointToLocalFrame(J,me,Z,ce);var se=Math.floor((ce.x-le)/de)-1,ue=Math.ceil((ce.x+le)/de)+1,Te=Math.floor((ce.y-le)/de)-1,Se=Math.ceil((ce.y+le)/de)+1;if(!(ue<0||Se<0||se>D.length||Se>D[0].length)){se<0&&(se=0),ue<0&&(ue=0),Te<0&&(Te=0),Se<0&&(Se=0),se>=D.length&&(se=D.length-1),ue>=D.length&&(ue=D.length-1),Se>=D[0].length&&(Se=D[0].length-1),Te>=D[0].length&&(Te=D[0].length-1);var te=[];q.getRectMinMax(se,Te,ue,Se,te);var Oe=te[0],Fe=te[1];if(!(ce.z-le>Fe||ce.z+le<Oe))for(var at=this.result,Ve=se;Ve<ue;Ve++)for(var ze=Te;ze<Se;ze++){var Ce=at.length;q.getConvexTrianglePillar(Ve,ze,!1),h.pointToWorldFrame(J,me,q.pillarOffset,be),Z.distanceTo(be)<q.pillarConvex.boundingSphereRadius+H.boundingSphereRadius&&this.sphereConvex(H,q.pillarConvex,Z,be,Pe,me,oe,he),q.getConvexTrianglePillar(Ve,ze,!0),h.pointToWorldFrame(J,me,q.pillarOffset,be),Z.distanceTo(be)<q.pillarConvex.boundingSphereRadius+H.boundingSphereRadius&&this.sphereConvex(H,q.pillarConvex,Z,be,Pe,me,oe,he);var Vt=at.length-Ce;if(Vt>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,n,r){n.exports=v;var o=t("../shapes/Shape"),s=t("../math/Vec3"),a=t("../math/Quaternion"),l=t("../solver/GSSolver");t("../utils/Vec3Pool"),t("../equations/ContactEquation"),t("../equations/FrictionEquation");var h=t("./Narrowphase"),u=t("../utils/EventTarget"),c=t("../collision/ArrayCollisionMatrix"),d=t("../material/Material"),p=t("../material/ContactMaterial"),f=t("../objects/Body"),g=t("../utils/TupleDictionary"),y=t("../collision/RaycastResult"),m=t("../collision/AABB"),_=t("../collision/Ray"),b=t("../collision/NaiveBroadphase");function v(){u.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new s,this.broadphase=new b,this.bodies=[],this.solver=new l,this.constraints=[],this.narrowphase=new h(this),this.collisionMatrix=new c,this.collisionMatrixPrevious=new c,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new g,this.defaultMaterial=new d("default"),this.defaultContactMaterial=new p(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}v.prototype=new u,new m;var w=new _;if(v.prototype.getContactMaterial=function(S,j){return this.contactMaterialTable.get(S.id,j.id)},v.prototype.numObjects=function(){return this.bodies.length},v.prototype.collisionMatrixTick=function(){var S=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=S,this.collisionMatrix.reset()},v.prototype.add=v.prototype.addBody=function(S){this.bodies.indexOf(S)===-1&&(S.index=this.bodies.length,this.bodies.push(S),S.world=this,S.initPosition.copy(S.position),S.initVelocity.copy(S.velocity),S.timeLastSleepy=this.time,S instanceof f&&(S.initAngularVelocity.copy(S.angularVelocity),S.initQuaternion.copy(S.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=S,this.dispatchEvent(this.addBodyEvent))},v.prototype.addConstraint=function(S){this.constraints.push(S)},v.prototype.removeConstraint=function(S){var j=this.constraints.indexOf(S);j!==-1&&this.constraints.splice(j,1)},v.prototype.rayTest=function(S,j,G){G instanceof y?this.raycastClosest(S,j,{skipBackfaces:!0},G):this.raycastAll(S,j,{skipBackfaces:!0},G)},v.prototype.raycastAll=function(S,j,G,E){return G.mode=_.ALL,G.from=S,G.to=j,G.callback=E,w.intersectWorld(this,G)},v.prototype.raycastAny=function(S,j,G,E){return G.mode=_.ANY,G.from=S,G.to=j,G.result=E,w.intersectWorld(this,G)},v.prototype.raycastClosest=function(S,j,G,E){return G.mode=_.CLOSEST,G.from=S,G.to=j,G.result=E,w.intersectWorld(this,G)},v.prototype.remove=function(S){S.world=null;var j=this.bodies.length-1,G=this.bodies,E=G.indexOf(S);if(E!==-1){G.splice(E,1);for(var k=0;k!==G.length;k++)G[k].index=k;this.collisionMatrix.setNumObjects(j),this.removeBodyEvent.body=S,this.dispatchEvent(this.removeBodyEvent)}},v.prototype.removeBody=v.prototype.remove,v.prototype.addMaterial=function(S){this.materials.push(S)},v.prototype.addContactMaterial=function(S){this.contactmaterials.push(S),this.contactMaterialTable.set(S.materials[0].id,S.materials[1].id,S)},typeof performance>"u"&&(performance={}),!performance.now){var I=Date.now();performance.timing&&performance.timing.navigationStart&&(I=performance.timing.navigationStart),performance.now=function(){return Date.now()-I}}var V=new s;v.prototype.step=function(S,j,G){if(G=G||10,j=j||0,j===0)this.internalStep(S),this.time+=S;else{var E=Math.floor((this.time+j)/S)-Math.floor(this.time/S);E=Math.min(E,G);for(var k=performance.now(),C=0;C!==E&&(this.internalStep(S),!(performance.now()-k>S*1e3));C++);this.time+=j;for(var A=this.time%S,x=A/S,F=V,W=this.bodies,U=0;U!==W.length;U++){var O=W[U];O.type!==f.STATIC&&O.sleepState!==f.SLEEPING?(O.position.vsub(O.previousPosition,F),F.scale(x,F),O.position.vadd(F,O.interpolatedPosition)):(O.interpolatedPosition.copy(O.position),O.interpolatedQuaternion.copy(O.quaternion))}}};var M={type:"postStep"},B={type:"preStep"},P={type:"collide",body:null,contact:null},T=[],N=[],R=[],$=[];new s,new s,new s,new s,new s,new s,new s,new s,new s,new a;var z=new a,ae=new a,L=new s;v.prototype.internalStep=function(S){this.dt=S;var j=this.contacts,G=R,E=$,k=this.numObjects(),C=this.bodies,A=this.solver,x=this.gravity,F=this.doProfiling,W=this.profile,U=f.DYNAMIC,O,K=this.constraints,ee=N;x.norm();var Ae=x.x,_e=x.y,ye=x.z,Y=0;for(F&&(O=performance.now()),Y=0;Y!==k;Y++){var ne=C[Y];if(ne.type&U){var Ge=ne.force,Ee=ne.mass;Ge.x+=Ee*Ae,Ge.y+=Ee*_e,Ge.z+=Ee*ye}}for(var Y=0,Qe=this.subsystems.length;Y!==Qe;Y++)this.subsystems[Y].update();F&&(O=performance.now()),G.length=0,E.length=0,this.broadphase.collisionPairs(this,G,E),F&&(W.broadphase=performance.now()-O);var Lt=K.length;for(Y=0;Y!==Lt;Y++){var xe=K[Y];if(!xe.collideConnected)for(var qe=G.length-1;qe>=0;qe-=1)(xe.bodyA===G[qe]&&xe.bodyB===E[qe]||xe.bodyB===G[qe]&&xe.bodyA===E[qe])&&(G.splice(qe,1),E.splice(qe,1))}this.collisionMatrixTick(),F&&(O=performance.now());var Xe=T,Ke=j.length;for(Y=0;Y!==Ke;Y++)Xe.push(j[Y]);j.length=0;var Je=this.frictionEquations.length;for(Y=0;Y!==Je;Y++)ee.push(this.frictionEquations[Y]);this.frictionEquations.length=0,this.narrowphase.getContacts(G,E,this,j,Xe,this.frictionEquations,ee),F&&(W.narrowphase=performance.now()-O),F&&(O=performance.now());for(var Y=0;Y<this.frictionEquations.length;Y++)A.addEquation(this.frictionEquations[Y]);for(var $e=j.length,tt=0;tt!==$e;tt++){var xe=j[tt],ne=xe.bi,He=xe.bj;xe.si,xe.sj;var ut;if(ne.material&&He.material?ut=this.getContactMaterial(ne.material,He.material)||this.defaultContactMaterial:ut=this.defaultContactMaterial,ut.friction,ne.material&&He.material&&(ne.material.friction>=0&&He.material.friction>=0&&ne.material.friction*He.material.friction,ne.material.restitution>=0&&He.material.restitution>=0&&(xe.restitution=ne.material.restitution*He.material.restitution)),A.addEquation(xe),ne.allowSleep&&ne.type===f.DYNAMIC&&ne.sleepState===f.SLEEPING&&He.sleepState===f.AWAKE&&He.type!==f.STATIC){var Ct=He.velocity.norm2()+He.angularVelocity.norm2(),Qt=Math.pow(He.sleepSpeedLimit,2);Ct>=Qt*2&&(ne._wakeUpAfterNarrowphase=!0)}if(He.allowSleep&&He.type===f.DYNAMIC&&He.sleepState===f.SLEEPING&&ne.sleepState===f.AWAKE&&ne.type!==f.STATIC){var ln=ne.velocity.norm2()+ne.angularVelocity.norm2(),Zt=Math.pow(ne.sleepSpeedLimit,2);ln>=Zt*2&&(He._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(ne,He,!0),this.collisionMatrixPrevious.get(ne,He)||(P.body=He,P.contact=xe,ne.dispatchEvent(P),P.body=ne,He.dispatchEvent(P))}for(F&&(W.makeContactConstraints=performance.now()-O,O=performance.now()),Y=0;Y!==k;Y++){var ne=C[Y];ne._wakeUpAfterNarrowphase&&(ne.wakeUp(),ne._wakeUpAfterNarrowphase=!1)}var Lt=K.length;for(Y=0;Y!==Lt;Y++){var xe=K[Y];xe.update();for(var qe=0,kt=xe.equations.length;qe!==kt;qe++){var yn=xe.equations[qe];A.addEquation(yn)}}A.solve(S,this),F&&(W.solve=performance.now()-O),A.removeAllEquations();var cn=Math.pow;for(Y=0;Y!==k;Y++){var ne=C[Y];if(ne.type&U){var Kt=cn(1-ne.linearDamping,S),$t=ne.velocity;$t.mult(Kt,$t);var St=ne.angularVelocity;if(St){var jt=cn(1-ne.angularDamping,S);St.mult(jt,St)}}}for(this.dispatchEvent(B),Y=0;Y!==k;Y++){var ne=C[Y];ne.preStep&&ne.preStep.call(ne)}F&&(O=performance.now());var Ht=z,At=ae,gn=this.stepnumber,vn=f.DYNAMIC|f.KINEMATIC,_n=gn%(this.quatNormalizeSkip+1)===0,Mn=this.quatNormalizeFast,Pn=S*.5;for(o.types.PLANE,o.types.CONVEXPOLYHEDRON,Y=0;Y!==k;Y++){var mt=C[Y],H=mt.force,q=mt.torque;if(mt.type&vn&&mt.sleepState!==f.SLEEPING){var Z=mt.velocity,J=mt.angularVelocity,Pe=mt.position,me=mt.quaternion,oe=mt.invMass,he=mt.invInertiaWorld;Z.x+=H.x*oe*S,Z.y+=H.y*oe*S,Z.z+=H.z*oe*S,mt.angularVelocity&&(he.vmult(q,L),L.mult(S,L),L.vadd(J,J)),Pe.x+=Z.x*S,Pe.y+=Z.y*S,Pe.z+=Z.z*S,mt.angularVelocity&&(Ht.set(J.x,J.y,J.z,0),Ht.mult(me,At),me.x+=Pn*At.x,me.y+=Pn*At.y,me.z+=Pn*At.z,me.w+=Pn*At.w,_n&&(Mn?me.normalizeFast():me.normalize())),mt.aabb&&(mt.aabbNeedsUpdate=!0),mt.updateInertiaWorld&&mt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,F&&(W.integrate=performance.now()-O),this.time+=S,this.stepnumber+=1,this.dispatchEvent(M),Y=0;Y!==k;Y++){var ne=C[Y],D=ne.postStep;D&&D.call(ne)}if(this.allowSleep)for(Y=0;Y!==k;Y++)C[Y].sleepTick(this.time)},v.prototype.clearForces=function(){for(var S=this.bodies,j=S.length,G=0;G!==j;G++){var E=S[G];E.force,E.torque,E.force.set(0,0,0),E.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(Ar);var Tr=Ar.exports;const Ha=$a(Tr),za=ai({__proto__:null,default:Ha},[Tr]);class Ua{constructor(e){fe(this,"scene");fe(this,"gravity");fe(this,"physicsImpostors");this.scene=e,this.gravity=new Q(0,-9.81,0),this.physicsImpostors=new Map}initialize(){try{console.log(" Cannon.js ...");const e=new ni(!0,10,za);this.scene.enablePhysics(this.gravity,e),console.log(" Physics system initialized with Cannon.js (instant load)")}catch(e){throw console.error("Failed to initialize Cannon.js physics engine:",e),new Error("No physics engine available")}}addBoxBody(e,t){const n=new In(e,In.BoxImpostor,{mass:t.mass,restitution:t.restitution??.3,friction:t.friction??.5},this.scene);return this.physicsImpostors.set(e,n),n}addCylinderBody(e,t){const n=new In(e,In.CylinderImpostor,{mass:t.mass,restitution:t.restitution??.3,friction:t.friction??.5},this.scene);return this.physicsImpostors.set(e,n),n}addSphereBody(e,t){const n=new In(e,In.SphereImpostor,{mass:t.mass,restitution:t.restitution??.3,friction:t.friction??.5},this.scene);return this.physicsImpostors.set(e,n),n}addStaticBoxCollider(e){return this.addBoxBody(e,{mass:0})}removeBody(e){const t=this.physicsImpostors.get(e);t&&(t.dispose(),this.physicsImpostors.delete(e))}setVelocity(e,t){const n=this.physicsImpostors.get(e);n&&n.setLinearVelocity(t)}getVelocity(e){const t=this.physicsImpostors.get(e);return t?t.getLinearVelocity():null}setPhysicsEnabled(e,t){const n=this.physicsImpostors.get(e);n&&n.physicsBody&&(t?n.physicsBody.mass=n.getParam("mass")||1:n.physicsBody.mass=0,n.physicsBody.updateMassProperties())}dispose(){this.physicsImpostors.forEach(e=>e.dispose()),this.physicsImpostors.clear()}}var on=(i=>(i.BOTTLE="bottle",i.GLASS="glass",i.SHAKER="shaker",i.JIGGER="jigger",i.MIXING_GLASS="mixing_glass",i.NPC="npc",i.GUITAR="guitar",i))(on||{}),je=(i=>(i.BASE_SPIRIT="base_spirit",i.LIQUEUR="liqueur",i.JUICE="juice",i.MIXER="mixer",i.SYRUP="syrup",i.BITTERS="bitters",i))(je||{});class Wa{constructor(e,t,n){fe(this,"camera");fe(this,"scene");fe(this,"physics");fe(this,"cocktailSystem",null);fe(this,"interactableObjects",[]);fe(this,"targetedObject",null);fe(this,"heldObject",null);fe(this,"holdOffset");fe(this,"holdParent");fe(this,"highlightLayer");fe(this,"INTERACTION_DISTANCE",3);this.camera=e,this.scene=t,this.physics=n,this.holdParent=new Nn("holdParent",t),this.holdParent.parent=e,this.holdOffset=new Q(.4,-.5,1.2),this.highlightLayer=new si("highlight",t),this.highlightLayer.blurHorizontalSize=1,this.highlightLayer.blurVerticalSize=1}setCocktailSystem(e){this.cocktailSystem=e}registerInteractable(e,t,n,r){const o=e;o.userData={interactable:!0,type:t,liquorType:n,capacity:r,originalPosition:e.position.clone()},this.interactableObjects.push(o)}update(){this.updateTargeting(),this.updateHeldObject()}updateTargeting(){if(this.targetedObject&&this.targetedObject!==this.heldObject&&this.highlightLayer.removeMesh(this.targetedObject),this.targetedObject=null,this.heldObject)return;const e=this.camera.getForwardRay(this.INTERACTION_DISTANCE),t=this.scene.pickWithRay(e,n=>this.interactableObjects.includes(n));t&&t.hit&&t.pickedMesh?(this.targetedObject=t.pickedMesh,this.highlightLayer.addMesh(this.targetedObject,ie.Yellow()),this.updateInteractionHint()):this.hideInteractionHint()}updateHeldObject(){var r;if(!this.heldObject)return;const e=this.camera.getDirection(Bn.Z),t=this.camera.getDirection(Bn.X),n=this.camera.getDirection(Bn.Y);this.heldObject.position=this.camera.position.add(e.scale(this.holdOffset.z)).add(t.scale(this.holdOffset.x)).add(n.scale(this.holdOffset.y)),this.heldObject.rotationQuaternion=this.camera.absoluteRotation.clone(),(r=this.heldObject.metadata)!=null&&r.originalScaling||(this.heldObject.metadata=this.heldObject.metadata||{},this.heldObject.metadata.originalScaling=this.heldObject.scaling.clone())}pickupItem(){return!this.targetedObject||this.heldObject?!1:(this.heldObject=this.targetedObject,this.highlightLayer.removeMesh(this.heldObject),this.physics.setPhysicsEnabled(this.heldObject,!1),console.log(`Picked up: ${this.heldObject.userData.type}`),!0)}dropItem(){var r;if(!this.heldObject)return!1;const e=this.heldObject;(r=e.metadata)!=null&&r.originalScaling&&(e.scaling=e.metadata.originalScaling);const t=this.camera.position.add(this.camera.getDirection(Bn.Z).scale(1.5)).add(this.camera.getDirection(Bn.Y).scale(-.5));e.position=t,this.physics.setPhysicsEnabled(e,!0);const n=this.camera.getDirection(Bn.Z).scale(2);return this.physics.setVelocity(e,n),this.heldObject=null,console.log(`Dropped: ${e.userData.type}`),!0}returnItem(){var n;if(!this.heldObject)return!1;const e=this.heldObject,t=e.userData.originalPosition;return(n=e.metadata)!=null&&n.originalScaling&&(e.scaling=e.metadata.originalScaling),t&&(e.position=t.clone()),this.physics.setPhysicsEnabled(e,!0),this.physics.setVelocity(e,Q.Zero()),this.heldObject=null,console.log(`Returned: ${e.userData.type}`),!0}getHeldObject(){return this.heldObject}getTargetedObject(){return this.targetedObject}updateInteractionHint(){if(!this.targetedObject)return;const e=document.getElementById("interaction-hint");if(e){const t=this.targetedObject.userData.type;let n=" E ";if(t===on.NPC)n=" E ";else if(t===on.GUITAR)n=" E ";else if(this.cocktailSystem&&this.targetedObject.userData.liquorType){const r=this.cocktailSystem.getLiquorData(this.targetedObject.userData.liquorType);r&&(n=`${r.displayName} -  E `)}e.textContent=n,e.style.display="block"}}hideInteractionHint(){const e=document.getElementById("interaction-hint");e&&(e.style.display="none")}dispose(){this.highlightLayer.dispose(),this.holdParent.dispose()}}class qa{constructor(e){fe(this,"scene");fe(this,"containerContents");fe(this,"isPouringActive");fe(this,"pouringStartTime");fe(this,"currentPouringBottle");fe(this,"originalBottleRotation");fe(this,"currentPouringAmount");fe(this,"pourProgressHideTimer");fe(this,"isDrinking");fe(this,"drinkingStartTime");fe(this,"currentDrinkingGlass");fe(this,"originalGlassPosition");fe(this,"lastDrinkInfo");fe(this,"isShakingActive");fe(this,"shakeIntensity");fe(this,"shakeTime");fe(this,"particleSystems");fe(this,"liquorDatabase");fe(this,"pourProgressUI");fe(this,"pourRate");this.scene=e,this.containerContents=new Map,this.isPouringActive=!1,this.pouringStartTime=0,this.currentPouringBottle=null,this.originalBottleRotation=null,this.currentPouringAmount=0,this.pourProgressHideTimer=null,this.isDrinking=!1,this.drinkingStartTime=0,this.currentDrinkingGlass=null,this.originalGlassPosition=null,this.lastDrinkInfo=null,this.isShakingActive=!1,this.shakeIntensity=0,this.shakeTime=0,this.particleSystems=new Map,this.liquorDatabase=this.initLiquorDatabase(),this.pourProgressUI={panel:document.getElementById("pour-progress-panel"),containerVolumeBar:document.getElementById("container-volume-bar"),containerVolumeText:document.getElementById("container-volume-text"),pourRateBar:document.getElementById("pour-rate-bar"),pourRateText:document.getElementById("pour-rate-text")},this.pourRate=30}initLiquorDatabase(){const e=new Map;return e.set("vodka",{name:"",displayName:"Vodka",color:15790320,alcoholContent:40,category:je.BASE_SPIRIT}),e.set("gin",{name:"",displayName:"Gin",color:15267064,alcoholContent:40,category:je.BASE_SPIRIT}),e.set("rum",{name:"",displayName:"Rum",color:13935988,alcoholContent:40,category:je.BASE_SPIRIT}),e.set("whiskey",{name:"",displayName:"Whiskey",color:12088115,alcoholContent:40,category:je.BASE_SPIRIT}),e.set("tequila",{name:"",displayName:"Tequila",color:16113331,alcoholContent:40,category:je.BASE_SPIRIT}),e.set("brandy",{name:"",displayName:"Brandy",color:9127187,alcoholContent:40,category:je.BASE_SPIRIT}),e.set("lemon_juice",{name:"",displayName:"Lemon Juice",color:16774223,alcoholContent:0,category:je.MIXER}),e.set("lime_juice",{name:"",displayName:"Lime Juice",color:3329330,alcoholContent:0,category:je.MIXER}),e.set("simple_syrup",{name:"",displayName:"Simple Syrup",color:16770229,alcoholContent:0,category:je.SYRUP}),e.set("grenadine",{name:"",displayName:"Grenadine",color:16711680,alcoholContent:0,category:je.SYRUP}),e.set("angostura_bitters",{name:"",displayName:"Angostura Bitters",color:9109504,alcoholContent:44.7,category:je.BITTERS}),e.set("orange_juice",{name:"",displayName:"Orange Juice",color:16753920,alcoholContent:0,category:je.JUICE}),e.set("pineapple_juice",{name:"",displayName:"Pineapple Juice",color:16771899,alcoholContent:0,category:je.JUICE}),e.set("cranberry_juice",{name:"",displayName:"Cranberry Juice",color:14423100,alcoholContent:0,category:je.JUICE}),e.set("tomato_juice",{name:"",displayName:"Tomato Juice",color:16737095,alcoholContent:0,category:je.JUICE}),e.set("grapefruit_juice",{name:"",displayName:"Grapefruit Juice",color:16738740,alcoholContent:0,category:je.JUICE}),e.set("soda_water",{name:"",displayName:"Soda Water",color:14745599,alcoholContent:0,category:je.MIXER}),e.set("tonic_water",{name:"",displayName:"Tonic Water",color:15794175,alcoholContent:0,category:je.MIXER}),e.set("cola",{name:"",displayName:"Cola",color:4073251,alcoholContent:0,category:je.MIXER}),e.set("liqueur",{name:"",displayName:"Liqueur",color:16739229,alcoholContent:20,category:je.LIQUEUR}),e.set("vermouth_dry",{name:"",displayName:"Dry Vermouth",color:15263952,alcoholContent:18,category:je.LIQUEUR}),e.set("vermouth_sweet",{name:"",displayName:"Sweet Vermouth",color:9127187,alcoholContent:18,category:je.LIQUEUR}),e.set("campari",{name:"",displayName:"Campari",color:14423100,alcoholContent:25,category:je.LIQUEUR}),e.set("triple_sec",{name:"",displayName:"Triple Sec",color:16753920,alcoholContent:40,category:je.LIQUEUR}),e.set("coconut_cream",{name:"",displayName:"Coconut Cream",color:16775920,alcoholContent:0,category:je.MIXER}),e.set("coffee_liqueur",{name:"",displayName:"Coffee Liqueur",color:4073251,alcoholContent:20,category:je.LIQUEUR}),e.set("amaretto",{name:"",displayName:"Amaretto",color:13789470,alcoholContent:28,category:je.LIQUEUR}),e.set("baileys",{name:"",displayName:"Baileys",color:13808780,alcoholContent:17,category:je.LIQUEUR}),e.set("blue_curacao",{name:"",displayName:"Blue Curaao",color:255,alcoholContent:21,category:je.LIQUEUR}),e.set("peach_schnapps",{name:"",displayName:"Peach Schnapps",color:16767673,alcoholContent:20,category:je.LIQUEUR}),e}initContainer(e,t=300){this.containerContents.set(e,{ingredients:[],color:16777215,volume:0,maxVolume:t,liquidMesh:null}),this.createLiquidVisual(e)}createLiquidVisual(e){const t=this.containerContents.get(e);if(!t)return;const n=Ye.CreateCylinder(`liquid_${e.name}`,{diameterTop:.3,diameterBottom:.28,height:.01,tessellation:32},this.scene),r=new ct(`liquidMat_${e.name}`,this.scene);r.albedoColor=ie.FromHexString("#ffffff"),r.metallic=.1,r.roughness=.3,r.alpha=.8,r.transparencyMode=ct.PBRMATERIAL_ALPHABLEND,n.material=r,n.parent=e,n.position=new Q(0,.08,0),n.isVisible=!1,t.liquidMesh=n}updateLiquidVisual(e){const t=this.containerContents.get(e);if(!t||!t.liquidMesh)return;const n=t.volume/t.maxVolume;if(n>0){t.liquidMesh.isVisible=!0;const r=.55,o=Math.max(.01,Math.min(r*n,r)),s=.14,a=.12+n*.02,l=Ye.CreateCylinder(`liquid_${e.name}`,{diameterTop:a*2,diameterBottom:s*2,height:o,tessellation:32},this.scene);l.material=t.liquidMesh.material,l.parent=e,l.position=new Q(0,.08+o/2,0),t.liquidMesh.dispose(),t.liquidMesh=l;const h=t.liquidMesh.material;h&&(h.albedoColor=ie.FromHexString("#"+t.color.toString(16).padStart(6,"0")))}else t.liquidMesh.isVisible=!1}pour(e,t,n,r,o){const s=this.containerContents.get(t);if(!s)return;if(s.volume>=s.maxVolume){console.log("");return}if(o){if(Q.Distance(e.getAbsolutePosition(),t.getAbsolutePosition())>1.5)return;const u=o.getForwardRay().direction,c=t.getAbsolutePosition().subtract(o.globalPosition).normalize();if(Q.Dot(u,c)<.85)return}const a=this.pourRate*r,l=this.liquorDatabase.get(n);if(l){const h=s.ingredients.find(u=>u.type===n);if(h?h.amount+=a:s.ingredients.push({type:n,name:l.name,displayName:l.displayName||l.name,amount:a,color:l.color}),s.volume+=a,this.updateMixedColor(t),this.updateLiquidVisual(t),this.updatePourProgressUI(t,a),this.isPouringActive||(this.createPourParticles(e,t),this.isPouringActive=!0,this.currentPouringBottle=e,this.originalBottleRotation=e.rotation.clone(),this.currentPouringAmount=0,this.pourProgressHideTimer&&(clearTimeout(this.pourProgressHideTimer),this.pourProgressHideTimer=null)),this.currentPouringAmount+=a,this.currentPouringBottle){const u=Math.PI/3,c=this.currentPouringBottle.rotation.z,d=3*r;this.currentPouringBottle.rotation.z+=(u-c)*d}}}stopPouring(){this.currentPouringBottle&&this.originalBottleRotation&&this.currentPouringBottle.rotation.copyFrom(this.originalBottleRotation),this.isPouringActive=!1,this.currentPouringBottle=null,this.originalBottleRotation=null,this.removePourParticles(),this.pourProgressUI.panel&&(this.pourProgressHideTimer&&clearTimeout(this.pourProgressHideTimer),this.pourProgressHideTimer=setTimeout(()=>{this.pourProgressUI.panel&&(this.pourProgressUI.panel.style.display="none"),this.currentPouringAmount=0},5e3))}pourFromShaker(e,t,n){const r=this.containerContents.get(e),o=this.containerContents.get(t);if(!r||!o||r.volume<=0||o.volume>=o.maxVolume)return;const s=Math.min(this.pourRate*n,r.volume,o.maxVolume-o.volume);if(r.ingredients.forEach(a=>{const l=s/r.volume,h=a.amount*l;a.amount-=h;const u=o.ingredients.find(c=>c.type===a.type);u?u.amount+=h:o.ingredients.push({type:a.type,name:a.name,displayName:a.displayName,amount:h,color:a.color})}),r.volume-=s,o.volume+=s,r.ingredients=r.ingredients.filter(a=>a.amount>.01),this.updateMixedColor(e),this.updateMixedColor(t),this.updateLiquidVisual(e),this.updateLiquidVisual(t),this.updatePourProgressUI(t,s),this.isPouringActive||(this.createPourParticles(e,t),this.isPouringActive=!0,this.currentPouringBottle=e,this.originalBottleRotation=e.rotation.clone(),this.currentPouringAmount=0,this.pourProgressHideTimer&&(clearTimeout(this.pourProgressHideTimer),this.pourProgressHideTimer=null)),this.currentPouringAmount+=s,this.currentPouringBottle){const a=Math.PI/3,l=this.currentPouringBottle.rotation.z,h=3*n;this.currentPouringBottle.rotation.z+=(a-l)*h}}updatePourProgressUI(e,t){if(!this.pourProgressUI.panel)return;const n=this.containerContents.get(e);if(!n)return;this.pourProgressUI.panel.style.display="block";const r=n.volume/n.maxVolume*100;this.pourProgressUI.containerVolumeBar&&(this.pourProgressUI.containerVolumeBar.style.width=`${Math.min(r,100)}%`),this.pourProgressUI.containerVolumeText&&(this.pourProgressUI.containerVolumeText.textContent=`${Math.round(n.volume)}/${n.maxVolume}ml`);const o=this.currentPouringAmount/n.maxVolume*100;this.pourProgressUI.pourRateBar&&(this.pourProgressUI.pourRateBar.style.width=`${Math.min(o,100)}%`),this.pourProgressUI.pourRateText&&(this.pourProgressUI.pourRateText.textContent=`${Math.round(this.currentPouringAmount)}ml`)}createPourParticles(e,t){const n=new Bo("pourParticles",2e3,this.scene);n.particleTexture=new We("https://www.babylonjs.com/assets/Flare.png",this.scene);const r=e.getAbsolutePosition().clone();r.y-=.3,n.emitter=r,n.minEmitBox=new Q(-.05,0,-.05),n.maxEmitBox=new Q(.05,0,.05),n.color1=new Xt(.7,.8,1,.8),n.color2=new Xt(.5,.6,.9,.6),n.colorDead=new Xt(.3,.4,.7,0),n.minSize=.03,n.maxSize=.06,n.minLifeTime=.3,n.maxLifeTime=.6,n.emitRate=500;const s=t.getAbsolutePosition().subtract(r).normalize();n.direction1=s.add(new Q(-.1,-.2,-.1)),n.direction2=s.add(new Q(.1,-.2,.1)),n.minEmitPower=2,n.maxEmitPower=3,n.updateSpeed=.01,n.gravity=new Q(0,-9.8,0),n.blendMode=Bo.BLENDMODE_STANDARD,n.start(),this.particleSystems.set("pour",n)}removePourParticles(){const e=this.particleSystems.get("pour");e&&(e.stop(),e.dispose(),this.particleSystems.delete("pour"))}shake(e,t){const n=this.containerContents.get(e);if(!n||n.volume===0){console.log("Shaker ");return}this.isShakingActive=!0,this.shakeTime+=t,this.shakeIntensity=Math.sin(this.shakeTime*20)*.05,e.rotation.z=this.shakeIntensity,e.rotation.x=Math.sin(this.shakeTime*15)*.03,this.shakeTime>2&&this.enhanceMixing(e)}stopShaking(e){this.isShakingActive=!1,this.shakeTime=0,e.rotation.z=0,e.rotation.x=0}enhanceMixing(e){this.containerContents.get(e)&&(this.updateMixedColor(e),this.updateLiquidVisual(e))}updateMixedColor(e){const t=this.containerContents.get(e);if(!t||t.ingredients.length===0)return;let n=0,r=0,o=0,s=0;if(t.ingredients.forEach(a=>{const l=ie.FromHexString("#"+a.color.toString(16).padStart(6,"0")),h=a.amount;n+=l.r*h,r+=l.g*h,o+=l.b*h,s+=h}),s>0){n/=s,r/=s,o/=s;const a=new ie(n,r,o);t.color=parseInt(a.toHexString().substring(1),16)}}drink(e,t=!0){const n=this.containerContents.get(e);if(!n||n.volume===0)return console.log(""),null;if(t&&!this.isDrinking)return this.isDrinking=!0,this.drinkingStartTime=Date.now(),this.currentDrinkingGlass=e,this.originalGlassPosition=e.position.clone(),null;const r={volume:n.volume,ingredients:[...n.ingredients],color:n.color,name:this.identifyCocktail(n)};return n.ingredients=[],n.volume=0,n.color=16777215,this.updateLiquidVisual(e),console.log(` ${r.name}`),r}getLastDrinkInfo(){const e=this.lastDrinkInfo;return this.lastDrinkInfo=null,e}updateDrinkingAnimation(){if(!this.isDrinking||!this.currentDrinkingGlass)return;const e=(Date.now()-this.drinkingStartTime)/1e3;if(e<1){const t=e;this.originalGlassPosition&&(this.currentDrinkingGlass.position.y=this.originalGlassPosition.y+.2*t,this.currentDrinkingGlass.rotation.x=-Math.PI/6*t)}else{this.originalGlassPosition&&this.currentDrinkingGlass.position.copyFrom(this.originalGlassPosition),this.currentDrinkingGlass.rotation.x=0;const t=this.containerContents.get(this.currentDrinkingGlass);if(t&&t.volume>0){const n={volume:t.volume,ingredients:[...t.ingredients],color:t.color,name:this.identifyCocktail(t)};t.ingredients=[],t.volume=0,t.color=16777215,this.updateLiquidVisual(this.currentDrinkingGlass),this.lastDrinkInfo=n}this.isDrinking=!1,this.currentDrinkingGlass=null}}identifyCocktail(e){const t=e.ingredients,n=t.map(o=>o.type),r=o=>{const s=t.find(a=>a.type===o);return s?s.amount:0};if(n.includes("gin")&&n.includes("vermouth_dry")){const o=r("gin"),s=r("vermouth_dry"),a=o/s,l=n.some(d=>["vodka","rum","whiskey","tequila","brandy","campari"].includes(d)),h=n.some(d=>["orange_juice","cranberry_juice","pineapple_juice","tomato_juice","grapefruit_juice"].includes(d)),u=["lemon_juice","lime_juice","simple_syrup"],c=n.filter(d=>d!=="gin"&&d!=="vermouth_dry").every(d=>u.includes(d));if(!l&&!h&&c&&a>=2&&a<=3)return" (Martini)"}if(n.includes("vodka")&&n.includes("vermouth_dry")){const o=r("vodka"),s=r("vermouth_dry"),a=o/s;if(!n.some(h=>["gin","rum","whiskey","tequila","brandy","campari"].includes(h))&&a>=2&&a<=3)return" (Vodka Martini)"}if(n.includes("gin")&&n.includes("campari")&&n.includes("vermouth_sweet")){const o=r("gin"),s=r("campari"),a=r("vermouth_sweet"),l=(o+s+a)/3;if(Math.abs(o-l)/l<.3&&Math.abs(s-l)/l<.3&&Math.abs(a-l)/l<.3)return" (Negroni)"}return n.includes("tequila")&&n.includes("triple_sec")&&n.includes("lime_juice")?" (Margarita)":n.includes("rum")&&n.includes("lime_juice")&&n.includes("simple_syrup")?" (Daiquiri)":n.includes("rum")&&n.includes("pineapple_juice")&&n.includes("coconut_cream")?" (Pia Colada)":n.includes("vodka")&&n.includes("triple_sec")&&n.includes("cranberry_juice")&&n.includes("lime_juice")?" (Cosmopolitan)":n.includes("rum")&&n.includes("lime_juice")&&n.includes("simple_syrup")?" (Mojito)":n.includes("whiskey")&&n.includes("vermouth_sweet")?" (Manhattan)":n.includes("whiskey")&&n.includes("lemon_juice")&&n.includes("simple_syrup")?" (Whiskey Sour)":n.includes("vodka")&&n.includes("tomato_juice")?" (Bloody Mary)":n.includes("vodka")&&n.includes("orange_juice")&&n.length===2?" (Screwdriver)":n.includes("tequila")&&n.includes("orange_juice")&&n.includes("grenadine")?" (Tequila Sunrise)":n.includes("rum")&&n.includes("triple_sec")&&n.includes("lime_juice")?" (Mai Tai)":n.includes("vodka")&&n.includes("rum")&&n.includes("gin")&&n.includes("tequila")&&n.includes("triple_sec")?" (Long Island Iced Tea)":n.includes("vodka")&&n.length===1?"":n.includes("gin")&&n.length===1?"":n.includes("rum")&&n.includes("liqueur")?"":n.includes("vodka")&&n.includes("liqueur")?"":n.length>2?"":n.length===2?"":""}emptyContainer(e){const t=this.containerContents.get(e);t&&(t.ingredients=[],t.volume=0,t.color=16777215,this.updateLiquidVisual(e))}getContainerInfo(e){return this.containerContents.get(e)||null}isEmpty(e){const t=this.containerContents.get(e);return!t||t.volume===0}isFull(e){const t=this.containerContents.get(e);return t!==void 0&&t.volume>=t.maxVolume}calculateAlcoholContent(e){if(!e||e.volume===0)return 0;let t=0;return e.ingredients.forEach(r=>{const o=this.liquorDatabase.get(r.type);o&&o.alcoholContent&&(t+=r.amount*(o.alcoholContent/100))}),t/e.volume*100}showContainerInfo(e){const t=this.containerContents.get(e),n=document.getElementById("container-info");if(!(!t||!n))if(t.volume>0){const r=t.ingredients.map(a=>{const l=this.liquorDatabase.get(a.type);return`
                    <div class="ingredient-item">
                        <span class="ingredient-name">${l?l.name:a.name}</span>
                        <span class="ingredient-amount">${Math.round(a.amount)} ml</span>
                    </div>
                `}).join(""),o=this.calculateAlcoholContent(t),s=this.identifyCocktail(t);n.innerHTML=`
                <h3>${s}</h3>
                <div class="ingredient-list">
                    ${r}
                </div>
                <div class="volume-info">
                    : ${Math.round(t.volume)} / ${t.maxVolume} ml<br>
                    : ${o.toFixed(1)}%
                </div>
            `,n.classList.add("visible")}else n.classList.remove("visible")}hideContainerInfo(){const e=document.getElementById("container-info");e&&e.classList.remove("visible")}update(e){this.updateDrinkingAnimation()}getLiquorDatabase(){return this.liquorDatabase}getCocktailRecipes(){return[{name:"Martini ",ingredients:[{amount:"60ml",name:" Gin"},{amount:"10ml",name:" Dry Vermouth"}],method:"Stir"},{name:"Vodka Martini ",ingredients:[{amount:"60ml",name:" Vodka"},{amount:"10ml",name:" Dry Vermouth"}],method:"Stir"},{name:"Negroni ",ingredients:[{amount:"30ml",name:" Gin"},{amount:"30ml",name:" Campari"},{amount:"30ml",name:" Sweet Vermouth"}],method:"Build"},{name:"Margarita ",ingredients:[{amount:"50ml",name:" Tequila"},{amount:"20ml",name:" Triple Sec"},{amount:"15ml",name:" Lime Juice"}],method:"Shake"},{name:"Daiquiri ",ingredients:[{amount:"60ml",name:" Rum"},{amount:"20ml",name:" Lime Juice"},{amount:"10ml",name:" Simple Syrup"}],method:"Shake"},{name:"Cosmopolitan ",ingredients:[{amount:"40ml",name:" Vodka"},{amount:"15ml",name:" Triple Sec"},{amount:"15ml",name:" Lime Juice"},{amount:"30ml",name:" Cranberry Juice"}],method:"Shake"},{name:"Mojito ",ingredients:[{amount:"45ml",name:" Rum"},{amount:"20ml",name:" Lime Juice"},{amount:"20ml",name:" Simple Syrup"},{amount:"",name:" Soda Water"}],method:"Muddle"},{name:"Pia Colada ",ingredients:[{amount:"50ml",name:" Rum"},{amount:"30ml",name:" Coconut Cream"},{amount:"50ml",name:" Pineapple Juice"}],method:"Blend"},{name:"Whiskey Sour ",ingredients:[{amount:"50ml",name:" Whiskey"},{amount:"25ml",name:" Lemon Juice"},{amount:"15ml",name:" Simple Syrup"}],method:"Shake"},{name:"Manhattan ",ingredients:[{amount:"50ml",name:" Whiskey"},{amount:"20ml",name:" Sweet Vermouth"},{amount:"2",name:" Angostura Bitters"}],method:"Stir"},{name:"Long Island Iced Tea ",ingredients:[{amount:"15ml",name:" Vodka"},{amount:"15ml",name:" Rum"},{amount:"15ml",name:" Gin"},{amount:"15ml",name:" Tequila"},{amount:"15ml",name:" Triple Sec"},{amount:"25ml",name:" Lemon Juice"},{amount:"30ml",name:" Simple Syrup"},{amount:"",name:" Cola"}],method:"Shake"},{name:"Bloody Mary ",ingredients:[{amount:"45ml",name:" Vodka"},{amount:"90ml",name:" Tomato Juice"},{amount:"15ml",name:" Lemon Juice"},{amount:"",name:" Angostura Bitters"}],method:"Roll"},{name:"Tequila Sunrise ",ingredients:[{amount:"45ml",name:" Tequila"},{amount:"90ml",name:" Orange Juice"},{amount:"15ml",name:" Grenadine"}],method:"Build"},{name:"Screwdriver ",ingredients:[{amount:"50ml",name:" Vodka"},{amount:"100ml",name:" Orange Juice"}],method:"Build"},{name:"Mai Tai ",ingredients:[{amount:"40ml",name:" Rum"},{amount:"20ml",name:" Triple Sec"},{amount:"15ml",name:" Lime Juice"},{amount:"10ml",name:" Simple Syrup"}],method:"Shake"}]}}class Ka{constructor(e,t,n){fe(this,"camera");fe(this,"scene");fe(this,"canvas");fe(this,"MOVE_SPEED",.15);fe(this,"SPRINT_SPEED",.3);fe(this,"MOUSE_SENSITIVITY",.08);fe(this,"keys");fe(this,"isPointerLocked",!1);this.camera=e,this.scene=t,this.canvas=n,this.keys=new Map,this.setupControls(),this.setupPointerLock()}setupControls(){window.addEventListener("keydown",e=>{this.keys.set(e.code,!0)}),window.addEventListener("keyup",e=>{this.keys.set(e.code,!1)}),this.camera.keysUp=[87],this.camera.keysDown=[83],this.camera.keysLeft=[65],this.camera.keysRight=[68],this.camera.speed=this.MOVE_SPEED,this.camera.angularSensibility=1e3/this.MOUSE_SENSITIVITY,this.camera.checkCollisions=!0,this.camera.applyGravity=!0,this.camera.ellipsoid=new Q(.5,1,.5),this.camera.upperBetaLimit=Math.PI/2+.1,this.camera.lowerBetaLimit=-Math.PI/2-.1}setupPointerLock(){this.canvas.addEventListener("click",()=>{this.isPointerLocked||this.canvas.requestPointerLock()}),document.addEventListener("pointerlockchange",()=>{this.isPointerLocked=document.pointerLockElement===this.canvas,this.isPointerLocked?this.camera.attachControl(this.canvas,!0):this.camera.detachControl()})}update(e){const t=this.keys.get("ShiftLeft")||this.keys.get("ShiftRight");this.camera.speed=t?this.SPRINT_SPEED:this.MOVE_SPEED,this.keys.get("Space")}getCamera(){return this.camera}setPosition(e){this.camera.position=e}isKeyPressed(e){return this.keys.get(e)===!0}dispose(){this.camera.detachControl()}}class ja{constructor(e){fe(this,"scene");fe(this,"shadowGenerator",null);this.scene=e,this.setupLights(),this.setupPostProcessing()}setupLights(){const e=new ks("mainLight",new Q(-1,-2,-1),this.scene);e.position=new Q(20,40,20),e.intensity=.5,e.diffuse=new ie(.9,.7,.5),e.specular=new ie(.8,.6,.4),this.shadowGenerator=new So(1024,e),this.shadowGenerator.usePercentageCloserFiltering=!0,this.shadowGenerator.filteringQuality=So.QUALITY_HIGH,this.shadowGenerator.bias=.001;const t=new Zs("hemiLight",new Q(0,1,0),this.scene);t.intensity=.3,t.diffuse=new ie(.7,.5,.4),t.groundColor=new ie(.3,.2,.15),t.specular=new ie(.3,.25,.2);const n=new zt("barSpotlight",new Q(0,4,-3),new Q(0,-1,0),Math.PI/3,2,this.scene);n.intensity=1.2,n.diffuse=new ie(1,.8,.5),n.specular=new ie(.8,.7,.5),console.log(" ")}setupPostProcessing(){this.scene.fogMode=Jo.FOGMODE_NONE,console.log(" FXAA")}addShadowCaster(e){this.shadowGenerator&&this.shadowGenerator.addShadowCaster(e)}getShadowGenerator(){return this.shadowGenerator}dispose(){this.shadowGenerator&&this.shadowGenerator.dispose()}}class Ya{constructor(e){fe(this,"scene");fe(this,"loadedModels",new Map);this.scene=e}async loadFBXModel(e){try{console.log(`Loading FBX model: ${e.name} from ${e.modelPath}`);const t=await Promise.race([oi.ImportMeshAsync("","",e.modelPath,this.scene),new Promise((r,o)=>setTimeout(()=>o(new Error("Model loading timeout")),5e3))]);if(t.meshes.length===0)throw new Error(`No meshes found in ${e.modelPath}`);const n=t.meshes[0];return n.name=e.name,e.position&&(n.position=e.position),e.rotation&&(n.rotation=e.rotation),e.scale?n.scaling=e.scale:n.scaling=new Q(.01,.01,.01),e.texturePath&&this.applyTexture(t.meshes,e.texturePath),t.meshes.forEach(r=>{r instanceof xt&&(r.receiveShadows=!0,r.isPickable=!1)}),n instanceof xt&&(n.isPickable=!0),this.loadedModels.set(e.name,t.meshes),console.log(` Model loaded: ${e.name} (${t.meshes.length} meshes)`),n}catch(t){return console.error(`Failed to load FBX model ${e.name}:`,t),console.warn(`Using fallback mesh for ${e.name}`),this.createFallbackMesh(e.name,e.position)}}applyTexture(e,t){const n=new We(t,this.scene);e.forEach(r=>{if(r instanceof xt){const o=new ct(`${r.name}_mat`,this.scene);o.albedoTexture=n,o.metallic=.2,o.roughness=.3,o.backFaceCulling=!1,r.material=o}})}createFallbackMesh(e,t){console.warn(`Creating fallback mesh for ${e}`);const n=Ye.CreateCylinder(e,{height:.8,diameter:.3},this.scene);t&&(n.position=t);const r=new Bt(`${e}_fallback_mat`,this.scene);return r.diffuseColor=new ie(.8,.8,.8),n.material=r,n}async loadMultipleModels(e){const t=e.map(n=>this.loadFBXModel(n));return Promise.all(t)}getLoadedModel(e){return this.loadedModels.get(e)}dispose(){this.loadedModels.forEach(e=>{e.forEach(t=>t.dispose())}),this.loadedModels.clear()}}class Xa{constructor(e,t,n,r){fe(this,"scene");fe(this,"physics");fe(this,"interaction");fe(this,"cocktail");fe(this,"modelLoader");fe(this,"bottles",[]);fe(this,"glasses",[]);fe(this,"barTools",{});this.scene=e,this.physics=t,this.interaction=n,this.cocktail=r,this.modelLoader=new Ya(e)}async createEnvironment(){this.createFloorAndWalls(),this.createBarCounter(),this.createLiquorShelf(),await this.createBarBottles(),this.createGlasses(),await this.createBarTools(),this.createFurniture()}createFloorAndWalls(){const e=Ye.CreateGround("floor",{width:30,height:30},this.scene),t=new ct("floorMat",this.scene);t.albedoColor=new ie(.2,.15,.1),t.metallic=0,t.roughness=.6,t.environmentIntensity=.8,t.reflectivityColor=new ie(.15,.12,.1),t.microSurface=.7,e.material=t,e.receiveShadows=!0,e.checkCollisions=!0,this.physics.addStaticBoxCollider(e);const n=Ye.CreateBox("backWall",{width:30,height:5,depth:.3},this.scene);n.position=new Q(0,2.5,-10);const r=new ct("wallMat",this.scene);r.albedoColor=new ie(.25,.2,.18),r.metallic=0,r.roughness=.95,r.environmentIntensity=.3,r.microSurface=.6,n.material=r,n.receiveShadows=!0,n.checkCollisions=!0,this.physics.addStaticBoxCollider(n);const o=Ye.CreateBox("leftWall",{width:.3,height:5,depth:20},this.scene);o.position=new Q(-15,2.5,0),o.material=r,o.receiveShadows=!0,o.checkCollisions=!0,this.physics.addStaticBoxCollider(o);const s=Ye.CreateBox("rightWall",{width:.3,height:5,depth:20},this.scene);s.position=new Q(15,2.5,0),s.material=r,s.receiveShadows=!0,s.checkCollisions=!0,this.physics.addStaticBoxCollider(s);const a=Ye.CreateBox("ceiling",{width:30,height:.3,depth:30},this.scene);a.position=new Q(0,5,0);const l=new ct("ceilingMat",this.scene);l.albedoColor=new ie(.25,.22,.2),l.metallic=0,l.roughness=.95,a.material=l,a.receiveShadows=!0,a.checkCollisions=!0,this.physics.addStaticBoxCollider(a)}createBarCounter(){const e=Ye.CreateBox("barCounter",{width:12,height:.15,depth:2},this.scene);e.position=new Q(0,1.05,-3);const t=new ct("counterMat",this.scene);t.albedoColor=new ie(.18,.12,.08),t.metallic=0,t.roughness=.25,t.environmentIntensity=1,t.reflectivityColor=new ie(.3,.25,.2),t.microSurface=.85,t.clearCoat.isEnabled=!0,t.clearCoat.intensity=.5,e.material=t,e.receiveShadows=!0,e.checkCollisions=!0,this.physics.addStaticBoxCollider(e);const n=Ye.CreateBox("barBase",{width:12,height:1,depth:2},this.scene);n.position=new Q(0,.5,-3);const r=new ct("baseMat",this.scene);r.albedoColor=new ie(.12,.08,.05),r.metallic=0,r.roughness=.8,r.environmentIntensity=.5,n.material=r,n.receiveShadows=!0,n.checkCollisions=!0,this.physics.addStaticBoxCollider(n)}createLiquorShelf(){const e=[1.5,2.5,3.5],t=new ct("shelfMat",this.scene);t.albedoColor=new ie(.25,.2,.15),t.metallic=.2,t.roughness=.6,e.forEach((o,s)=>{const a=Ye.CreateBox(`shelf_${s}`,{width:10,height:.1,depth:.8},this.scene);a.position=new Q(0,o,-8),a.material=t,a.receiveShadows=!0,a.checkCollisions=!0,this.physics.addStaticBoxCollider(a)});const n=Ye.CreateBox("shelfBack",{width:10,height:3,depth:.1},this.scene);n.position=new Q(0,2.5,-8.5);const r=new ct("panelMat",this.scene);r.albedoColor=new ie(.3,.25,.2),r.metallic=.1,r.roughness=.8,n.material=r,n.receiveShadows=!0}async createBarBottles(){const e=[{name:"bottle_makers_mark",modelPath:"/materials/Bottle_of_Maker_s_Mar_1208132858_texture.fbx",texturePath:"/materials/Bottle_of_Maker_s_Mar_1208132858_texture.png",position:new Q(-2,2,-8),liquorType:"whiskey"},{name:"bottle_gin",modelPath:"/materials/Gin_Bottle_Image_1208132907_texture.fbx",texturePath:"/materials/Gin_Bottle_Image_1208132907_texture.png",position:new Q(0,2,-8),liquorType:"gin"},{name:"bottle_makers_mark_2",modelPath:"/materials/Bottle_of_Maker_s_Mar_1208132858_texture.fbx",texturePath:"/materials/Bottle_of_Maker_s_Mar_1208132858_texture.png",position:new Q(2,2,-8),liquorType:"whiskey"}];for(const t of e)try{const n=await this.modelLoader.loadFBXModel({name:t.name,modelPath:t.modelPath,texturePath:t.texturePath,position:t.position,scale:new Q(.01,.01,.01)});this.bottles.push(n),this.interaction.registerInteractable(n,on.BOTTLE,t.liquorType),this.physics.addCylinderBody(n,{mass:.5,restitution:.3,friction:.6}),console.log(` Loaded FBX bottle: ${t.name}`)}catch(n){console.error(`Failed to load bottle ${t.name}, using fallback`,n);const r=this.createBottle(t.name,t.position,new ie(.7,.4,.2));this.bottles.push(r),this.interaction.registerInteractable(r,on.BOTTLE,t.liquorType),this.physics.addCylinderBody(r,{mass:.5,restitution:.3,friction:.6})}}createBottle(e,t,n){const r=Ye.CreateCylinder(`${e}_body`,{height:.8,diameter:.3,tessellation:16},this.scene),o=Ye.CreateCylinder(`${e}_neck`,{height:.15,diameterTop:.08,diameterBottom:.15,tessellation:16},this.scene);o.position.y=.475;const s=xt.MergeMeshes([r,o],!0,!0,void 0,!1,!0);s.name=e,s.position=t;const a=new ct(`${e}_mat`,this.scene);return a.albedoColor=n,a.metallic=.1,a.roughness=.2,a.alpha=.7,a.transparencyMode=ct.PBRMATERIAL_ALPHABLEND,s.material=a,s.castShadow=!0,s}createGlasses(){[new Q(-2,1.2,-3),new Q(2,1.2,-3)].forEach((t,n)=>{const r=Ye.CreateCylinder(`glass_${n}`,{height:.6,diameterTop:.3,diameterBottom:.26,tessellation:24},this.scene);r.position=t;const o=new ct(`glassMat_${n}`,this.scene);o.albedoColor=new ie(1,1,1),o.metallic=0,o.roughness=.1,o.alpha=.3,o.transparencyMode=ct.PBRMATERIAL_ALPHABLEND,r.material=o,r.castShadow=!0,this.glasses.push(r),this.interaction.registerInteractable(r,on.GLASS),this.physics.addCylinderBody(r,{mass:.3,restitution:.2,friction:.5}),this.cocktail.initContainer(r,300)})}async createBarTools(){try{const n=await this.modelLoader.loadFBXModel({name:"shaker",modelPath:"/materials/Stainless_Steel_Cockt_1208132913_texture.fbx",texturePath:"/materials/Stainless_Steel_Cockt_1208132913_texture.png",position:new Q(-5,1.2,-3),scale:new Q(.01,.01,.01)});this.barTools.shaker=n,this.interaction.registerInteractable(n,on.SHAKER),this.physics.addCylinderBody(n,{mass:.6,restitution:.4,friction:.5}),this.cocktail.initContainer(n,500),console.log(" Loaded FBX shaker model")}catch(n){console.error("Failed to load shaker FBX, using fallback",n);const r=Ye.CreateCylinder("shaker",{height:.65,diameterTop:.4,diameterBottom:.44,tessellation:24},this.scene);r.position=new Q(-5,1.2,-3);const o=new ct("shakerMat",this.scene);o.albedoColor=new ie(.8,.8,.85),o.metallic=.9,o.roughness=.3,r.material=o,r.castShadow=!0,this.barTools.shaker=r,this.interaction.registerInteractable(r,on.SHAKER),this.physics.addCylinderBody(r,{mass:.6,restitution:.4,friction:.5}),this.cocktail.initContainer(r,500)}const e=Ye.CreateCylinder("jigger",{height:.18,diameterTop:.18,diameterBottom:.26,tessellation:16},this.scene);e.position=new Q(5,1.2,-3);const t=new ct("jiggerMat",this.scene);t.albedoColor=new ie(.85,.85,.9),t.metallic=.85,t.roughness=.4,e.material=t,e.castShadow=!0,this.barTools.jigger=e,this.interaction.registerInteractable(e,on.JIGGER),this.physics.addCylinderBody(e,{mass:.2,restitution:.3,friction:.5})}createFurniture(){const e=[new Q(0,0,3)],t=new Bt("tableMat",this.scene);t.diffuseColor=new ie(.3,.2,.1),t.specularColor=new ie(.1,.1,.1),e.forEach((o,s)=>{const a=Ye.CreateCylinder(`tableTop_${s}`,{height:.1,diameter:1.2,tessellation:12},this.scene);a.position=new Q(o.x,.75,o.z),a.material=t,a.receiveShadows=!0,a.checkCollisions=!0,this.physics.addStaticBoxCollider(a);const l=Ye.CreateCylinder(`tableLeg_${s}`,{height:.7,diameter:.1,tessellation:8},this.scene);l.position=new Q(o.x,.35,o.z),l.material=t,l.castShadow=!0});const n=[new Q(-2,0,-1),new Q(2,0,-1)],r=new Bt("stoolMat",this.scene);r.diffuseColor=new ie(.2,.15,.1),r.specularColor=new ie(.15,.15,.15),n.forEach((o,s)=>{const a=Ye.CreateCylinder(`stoolSeat_${s}`,{height:.08,diameter:.4,tessellation:12},this.scene);a.position=new Q(o.x,.65,o.z),a.material=r,a.receiveShadows=!0;const l=Ye.CreateCylinder(`stoolLeg_${s}`,{height:.6,diameter:.06,tessellation:8},this.scene);l.position=new Q(o.x,.3,o.z),l.material=r,l.castShadow=!0})}getBottles(){return this.bottles}getGlasses(){return this.glasses}getBarTools(){return this.barTools}}class Qa{constructor(e){fe(this,"scene");fe(this,"npcs",[]);this.scene=e,this.createNPCs()}createNPCs(){this.addNPC({name:"Gustave",position:new Q(8,0,-5),shirtColor:26316,pantsColor:1710618,role:"",gender:"male",dialogues:[" Gustave YangNCU ","","","",""]}),this.addNPC({name:"Seaton",position:new Q(-8,0,-5),shirtColor:13369446,pantsColor:3355443,role:"",gender:"male",dialogues:[" Seaton ","12",""," Old Fashioned",""]})}addNPC(e){const t=new xt(`npc_${e.name}`,this.scene),n=e.gender==="female",r=this.createBody(e.shirtColor,n),o=this.createPants(e.pantsColor,n),s=this.createHead(),a=this.createHair(n),l=this.createArm(!0,n),h=this.createArm(!1,n),u=this.createLeg(!0),c=this.createLeg(!1),d=this.createFace();r.parent=t,o.parent=t,s.parent=t,a.parent=t,l.parent=t,h.parent=t,u.parent=t,c.parent=t,d.parent=t;const p=this.createNameTag(e.name,e.role);p.parent=t,t.position=e.position,e.rotation!==void 0&&(t.rotation.y=e.rotation),t.userData={name:e.name,role:e.role,dialogues:e.dialogues,currentDialogue:0,originalY:e.position.y,baseRotation:e.rotation||0},this.npcs.push(t)}createBody(e,t){const n=t?.35:.4,r=Ye.CreateCylinder("body",{height:.9,diameterTop:n*2,diameterBottom:(n+.05)*2,tessellation:12},this.scene);r.position.y=1.2;const o=new Bt("bodyMat",this.scene);return o.diffuseColor=ie.FromHexString("#"+e.toString(16).padStart(6,"0")),o.specularColor=new ie(.1,.1,.1),r.material=o,r.castShadow=!0,r}createPants(e,t){const n=Ye.CreateCylinder("pants",{height:1,diameter:.7,tessellation:12},this.scene);n.position.y=.2;const r=new Bt("pantsMat",this.scene);return r.diffuseColor=ie.FromHexString("#"+e.toString(16).padStart(6,"0")),r.specularColor=new ie(.05,.05,.05),n.material=r,n.castShadow=!0,n}createHead(){const e=Ye.CreateSphere("head",{diameter:.7,segments:12},this.scene);e.position.y=2.1;const t=new Bt("headMat",this.scene);return t.diffuseColor=ie.FromHexString("#fdbcb4"),t.specularColor=new ie(.1,.1,.1),e.material=t,e.castShadow=!0,e}createHair(e){const t=Ye.CreateSphere("hair",{diameter:.76,segments:16,slice:e?.4:.35},this.scene);t.position.y=2.1;const n=new ct("hairMat",this.scene);return n.albedoColor=new ie(.2,.15,.1),n.metallic=.05,n.roughness=.7,t.material=n,t.castShadow=!0,t}createArm(e,t){const n=t?.5:.55,r=Ye.CreateCylinder(e?"leftArm":"rightArm",{height:.8,diameter:.24,tessellation:12},this.scene);r.position.set(e?-n:n,1.2,0);const o=new ct("armMat",this.scene);return o.albedoColor=ie.FromHexString("#fdbcb4"),o.metallic=0,o.roughness=.9,r.material=o,r.castShadow=!0,r}createLeg(e){const t=Ye.CreateCylinder(e?"leftLeg":"rightLeg",{height:1,diameter:.3,tessellation:16},this.scene);t.position.set(e?-.18:.18,-.3,0);const n=new ct("legMat",this.scene);return n.albedoColor=new ie(.1,.1,.1),n.metallic=.1,n.roughness=.8,t.material=n,t.castShadow=!0,t}createFace(){const e=new Nn("face",this.scene);e.position.y=2.1;const t=Ye.CreateSphere("leftEye",{diameter:.1,segments:8},this.scene);t.position.set(-.12,.05,.33);const n=new Bt("eyeMat",this.scene);n.diffuseColor=new ie(0,0,0),t.material=n,t.parent=e;const r=Ye.CreateSphere("rightEye",{diameter:.1,segments:8},this.scene);r.position.set(.12,.05,.33),r.material=n,r.parent=e;const o=Ye.CreateTorus("mouth",{diameter:.24,thickness:.02,tessellation:16},this.scene);return o.rotation.x=Math.PI,o.position.set(0,-.1,.32),o.material=n,o.parent=e,e}createNameTag(e,t){const n=new Nn("nameTag",this.scene);n.position.y=2.8;const r=Ye.CreatePlane("nameTagPlane",{width:2,height:1},this.scene);r.parent=n,r.billboardMode=xt.BILLBOARDMODE_ALL;const o=new Bt("nameTagMat",this.scene);return o.diffuseColor=new ie(.1,.1,.1),o.alpha=.7,o.backFaceCulling=!1,r.material=o,console.log(` NPC${e} (${t}) - Canvas`),n}checkInteractions(e){let n=null,r=1/0;for(const s of this.npcs){const a=Q.Distance(e,s.position);a<2.5&&a<r&&(r=a,n=s)}const o=document.getElementById("interaction-hint");if(o)if(n){const s=n.userData;o.textContent=` E  ${s.name} `,o.style.display="block"}else o.style.display="none";return n}interact(e){if(!e)return;const t=e.userData,n=document.getElementById("dialogue-box"),r=document.getElementById("character-name"),o=document.getElementById("dialogue-text");!n||!r||!o||(r.textContent=`${t.name} - ${t.role}`,o.textContent=t.dialogues[t.currentDialogue],n.classList.remove("active"),n.offsetHeight,n.classList.add("active"),t.currentDialogue=(t.currentDialogue+1)%t.dialogues.length,setTimeout(()=>{n.classList.remove("active")},4e3))}update(e){const t=Date.now()*.001;this.npcs.forEach((n,r)=>{const o=n.userData,s=Math.sin(t+r)*.02;n.position.y=o.originalY+s;const a=Math.sin(t*.8+r*2)*.05;n.rotation.y=o.baseRotation+a})}getNPCs(){return this.npcs}getNPCByName(e){return this.npcs.find(t=>t.userData.name===e)}}class Za{constructor(){fe(this,"canvas");fe(this,"engine");fe(this,"scene");fe(this,"camera");fe(this,"physicsSystem");fe(this,"interactionSystem");fe(this,"cocktailSystem");fe(this,"playerController");fe(this,"lightingSystem");fe(this,"barEnvironment");fe(this,"npcManager");fe(this,"isPaused",!1);fe(this,"isRecipeMenuOpen",!1);fe(this,"lastInteraction",!1);fe(this,"lastPickup",!1);fe(this,"lastDrop",!1);fe(this,"lastReturn",!1);fe(this,"lastRightMouse",!1);fe(this,"lastRecipeToggle",!1);this.canvas=document.getElementById("renderCanvas"),this.engine=new ri(this.canvas,!0,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0}),this.scene=this.createScene(),this.camera=this.scene.activeCamera,this.initialize(),this.engine.runRenderLoop(()=>{this.update(),this.scene.render()}),window.addEventListener("resize",()=>{this.engine.resize()})}createScene(){const e=new Jo(this.engine);e.clearColor=new Xt(.08,.06,.05,1),e.collisionsEnabled=!0,e.gravity=new Q(0,-9.81,0);const t=new ii("camera",new Q(0,1.7,-5),e);return t.setTarget(Q.Zero()),t.fov=1.48,e.activeCamera=t,e}async initialize(){try{this.showLoadingScreen(),this.updateLoadingProgress(0,"..."),this.updateLoadingProgress(10,"..."),this.physicsSystem=new Ua(this.scene),this.physicsSystem.initialize(),this.updateLoadingProgress(30," "),this.updateLoadingProgress(40,"..."),this.interactionSystem=new Wa(this.camera,this.scene,this.physicsSystem),this.updateLoadingProgress(50," "),this.updateLoadingProgress(55,"..."),this.cocktailSystem=new qa(this.scene,this.interactionSystem),this.interactionSystem.setCocktailSystem(this.cocktailSystem),this.updateLoadingProgress(60," "),this.updateLoadingProgress(65,"..."),this.playerController=new Ka(this.camera,this.scene,this.canvas),this.updateLoadingProgress(70," "),this.updateLoadingProgress(75,"..."),this.lightingSystem=new ja(this.scene),this.updateLoadingProgress(80," "),this.updateLoadingProgress(85,"..."),this.barEnvironment=new Xa(this.scene,this.physicsSystem,this.interactionSystem,this.cocktailSystem),await this.barEnvironment.createEnvironment(),this.updateLoadingProgress(92," FBX"),this.updateLoadingProgress(95," NPC..."),this.npcManager=new Qa(this.scene),this.updateLoadingProgress(97," NPC "),this.updateLoadingProgress(99," UI..."),this.setupUIControls(),this.updateLoadingProgress(100," "),await new Promise(e=>setTimeout(e,500)),this.hideLoadingScreen(),console.log(" Bar Simulator initialized successfully!")}catch(e){console.error(" Failed to initialize:",e),this.updateLoadingProgress(0," "),alert(`
: `+e)}}update(){var t,n,r,o,s;const e=this.engine.getDeltaTime()/1e3;if(this.isPaused){(t=this.npcManager)==null||t.update(e);return}(n=this.playerController)==null||n.update(e),(r=this.interactionSystem)==null||r.update(),(o=this.cocktailSystem)==null||o.update(e),(s=this.npcManager)==null||s.update(e),this.handleInput(),this.updateFPS()}handleInput(){const e=this.playerController.isKeyPressed("KeyE");e&&!this.lastPickup&&this.interactionSystem.pickupItem(),this.lastPickup=e;const t=this.playerController.isKeyPressed("KeyQ");t&&!this.lastDrop&&this.interactionSystem.dropItem(),this.lastDrop=t;const n=this.playerController.isKeyPressed("KeyR");n&&!this.lastReturn&&this.interactionSystem.returnItem(),this.lastReturn=n;const r=this.scene.pointerX!==0;this.handlePouring(r);const o=this.playerController.isKeyPressed("KeyM");o&&!this.lastRecipeToggle&&this.toggleRecipeMenu(),this.lastRecipeToggle=o}handlePouring(e){const t=this.interactionSystem.getHeldObject();if(!t||!e){this.cocktailSystem.stopPouring();return}const n=this.findNearbyContainer();n?this.cocktailSystem.pour(t,n):t.userData.type==="shaker"&&this.cocktailSystem.shake(t)}findNearbyContainer(){var r;if(!this.interactionSystem.getHeldObject())return null;const t=this.camera.getForwardRay(2.5),n=this.scene.pickWithRay(t);if(n&&n.hit&&n.pickedMesh){const o=n.pickedMesh,s=(r=o.userData)==null?void 0:r.type;if(s==="glass"||s==="shaker"||s==="mixing_glass")return o}return null}setupUIControls(){document.getElementById("recipe-menu");const e=document.getElementById("close-recipe-menu");e&&e.addEventListener("click",()=>{this.toggleRecipeMenu()}),this.loadRecipes()}loadRecipes(){const e=document.getElementById("recipe-list");if(!e)return;const t=this.cocktailSystem.getCocktailRecipes();e.innerHTML=t.map(n=>`
            <div class="recipe-item">
                <h3>${n.name} <span class="recipe-name-cn">${n.nameChinese}</span></h3>
                <div class="recipe-ingredients">
                    ${n.ingredients.map(r=>`<div> ${r.amount}ml ${r.name}</div>`).join("")}
                </div>
                <div class="recipe-method">
                    <strong></strong>${n.method}
                </div>
                <div class="recipe-glass">
                    <strong></strong>${n.glass}
                </div>
                ${n.garnish?`<div class="recipe-garnish"><strong></strong>${n.garnish}</div>`:""}
            </div>
        `).join("")}toggleRecipeMenu(){const e=document.getElementById("recipe-menu");e&&(this.isRecipeMenuOpen=!this.isRecipeMenuOpen,this.isPaused=this.isRecipeMenuOpen,e.style.display=this.isRecipeMenuOpen?"block":"none")}updateFPS(){const e=document.getElementById("fps");e&&(e.textContent=Math.round(this.engine.getFps()).toString())}showLoadingScreen(){const e=document.getElementById("loading");e&&(e.style.display="flex")}updateLoadingProgress(e,t){const n=document.getElementById("loading-text"),r=document.getElementById("loading-percentage"),o=document.getElementById("loading-progress-bar");n&&(n.textContent=t),r&&(r.textContent=`${e}%`),o&&(o.style.width=`${e}%`),console.log(`[${e}%] ${t}`)}hideLoadingScreen(){const e=document.getElementById("loading");e&&(e.style.display="none")}}window.addEventListener("DOMContentLoaded",()=>{new Za});
